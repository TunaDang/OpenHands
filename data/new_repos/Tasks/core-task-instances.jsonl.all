{"repo": "home-assistant/core", "pull_number": 133717, "instance_id": "home-assistant__core-133717", "issue_numbers": ["133598"], "base_commit": "11efec49dbdcbd572002dfe9e2c5f37893fca0d4", "patch": "diff --git a/homeassistant/components/twinkly/__init__.py b/homeassistant/components/twinkly/__init__.py\nindex 00e40d604c017e..cd76a79e1d77f4 100644\n--- a/homeassistant/components/twinkly/__init__.py\n+++ b/homeassistant/components/twinkly/__init__.py\n@@ -1,6 +1,7 @@\n \"\"\"The twinkly component.\"\"\"\n \n from dataclasses import dataclass\n+import logging\n from typing import Any\n \n from aiohttp import ClientError\n@@ -10,12 +11,15 @@\n from homeassistant.const import CONF_HOST, Platform\n from homeassistant.core import HomeAssistant\n from homeassistant.exceptions import ConfigEntryNotReady\n+from homeassistant.helpers import device_registry as dr, entity_registry as er\n from homeassistant.helpers.aiohttp_client import async_get_clientsession\n \n-from .const import ATTR_VERSION\n+from .const import ATTR_VERSION, DOMAIN\n \n PLATFORMS = [Platform.LIGHT]\n \n+_LOGGER = logging.getLogger(__name__)\n+\n \n @dataclass\n class TwinklyData:\n@@ -56,3 +60,39 @@ async def async_unload_entry(hass: HomeAssistant, entry: TwinklyConfigEntry) ->\n     \"\"\"Remove a twinkly entry.\"\"\"\n \n     return await hass.config_entries.async_unload_platforms(entry, PLATFORMS)\n+\n+\n+async def async_migrate_entry(hass: HomeAssistant, entry: TwinklyConfigEntry) -> bool:\n+    \"\"\"Migrate old entry.\"\"\"\n+    if entry.minor_version == 1:\n+        client = Twinkly(entry.data[CONF_HOST], async_get_clientsession(hass))\n+        try:\n+            device_info = await client.get_details()\n+        except (TimeoutError, ClientError) as exception:\n+            _LOGGER.error(\"Error while migrating: %s\", exception)\n+            return False\n+        identifier = entry.unique_id\n+        assert identifier is not None\n+        entity_registry = er.async_get(hass)\n+        entity_id = entity_registry.async_get_entity_id(\"light\", DOMAIN, identifier)\n+        if entity_id:\n+            entity_entry = entity_registry.async_get(entity_id)\n+            assert entity_entry is not None\n+            entity_registry.async_update_entity(\n+                entity_entry.entity_id, new_unique_id=device_info[\"mac\"]\n+            )\n+        device_registry = dr.async_get(hass)\n+        device_entry = device_registry.async_get_device(\n+            identifiers={(DOMAIN, identifier)}\n+        )\n+        if device_entry:\n+            device_registry.async_update_device(\n+                device_entry.id, new_identifiers={(DOMAIN, device_info[\"mac\"])}\n+            )\n+        hass.config_entries.async_update_entry(\n+            entry,\n+            unique_id=device_info[\"mac\"],\n+            minor_version=2,\n+        )\n+\n+    return True\ndiff --git a/homeassistant/components/twinkly/config_flow.py b/homeassistant/components/twinkly/config_flow.py\nindex 837bd9ccb6a1a8..4dec8809f07271 100644\n--- a/homeassistant/components/twinkly/config_flow.py\n+++ b/homeassistant/components/twinkly/config_flow.py\n@@ -23,6 +23,7 @@ class TwinklyConfigFlow(ConfigFlow, domain=DOMAIN):\n     \"\"\"Handle twinkly config flow.\"\"\"\n \n     VERSION = 1\n+    MINOR_VERSION = 2\n \n     def __init__(self) -> None:\n         \"\"\"Initialize the config flow.\"\"\"\n@@ -46,7 +47,7 @@ async def async_step_user(\n                 errors[CONF_HOST] = \"cannot_connect\"\n             else:\n                 await self.async_set_unique_id(\n-                    device_info[DEV_ID], raise_on_progress=False\n+                    device_info[\"mac\"], raise_on_progress=False\n                 )\n                 self._abort_if_unique_id_configured()\n \n@@ -64,7 +65,7 @@ async def async_step_dhcp(\n         device_info = await Twinkly(\n             discovery_info.ip, async_get_clientsession(self.hass)\n         ).get_details()\n-        await self.async_set_unique_id(device_info[DEV_ID])\n+        await self.async_set_unique_id(device_info[\"mac\"])\n         self._abort_if_unique_id_configured(updates={CONF_HOST: discovery_info.ip})\n \n         self._discovered_device = (device_info, discovery_info.ip)\ndiff --git a/homeassistant/components/twinkly/light.py b/homeassistant/components/twinkly/light.py\nindex d05da7bab15c81..7de07db3b308d3 100644\n--- a/homeassistant/components/twinkly/light.py\n+++ b/homeassistant/components/twinkly/light.py\n@@ -60,8 +60,8 @@ def __init__(\n         entry: TwinklyConfigEntry,\n     ) -> None:\n         \"\"\"Initialize a TwinklyLight entity.\"\"\"\n-        self._attr_unique_id: str = entry.data[CONF_ID]\n         device_info = entry.runtime_data.device_info\n+        self._attr_unique_id: str = device_info[\"mac\"]\n         self._conf = entry\n \n         if device_info.get(DEV_LED_PROFILE) == DEV_PROFILE_RGBW:\n@@ -98,7 +98,7 @@ def __init__(\n     def device_info(self) -> DeviceInfo | None:\n         \"\"\"Get device specific attributes.\"\"\"\n         return DeviceInfo(\n-            identifiers={(DOMAIN, self._attr_unique_id)},\n+            identifiers={(DOMAIN, self._mac)},\n             connections={(CONNECTION_NETWORK_MAC, self._mac)},\n             manufacturer=\"LEDWORKS\",\n             model=self._model,\n", "test_patch": "diff --git a/tests/components/twinkly/snapshots/test_diagnostics.ambr b/tests/components/twinkly/snapshots/test_diagnostics.ambr\nindex 4d25e222501870..abd923dcb833da 100644\n--- a/tests/components/twinkly/snapshots/test_diagnostics.ambr\n+++ b/tests/components/twinkly/snapshots/test_diagnostics.ambr\n@@ -32,14 +32,14 @@\n       }),\n       'domain': 'twinkly',\n       'entry_id': '4c8fccf5-e08a-4173-92d5-49bf479252a2',\n-      'minor_version': 1,\n+      'minor_version': 2,\n       'options': dict({\n       }),\n       'pref_disable_new_entities': False,\n       'pref_disable_polling': False,\n       'source': 'user',\n       'title': 'Twinkly',\n-      'unique_id': '4c8fccf5-e08a-4173-92d5-49bf479252a2',\n+      'unique_id': 'aa:bb:cc:dd:ee:ff',\n       'version': 1,\n     }),\n     'sw_version': '2.8.10',\ndiff --git a/tests/components/twinkly/test_init.py b/tests/components/twinkly/test_init.py\nindex 6642807ac3f582..60ebe65b445192 100644\n--- a/tests/components/twinkly/test_init.py\n+++ b/tests/components/twinkly/test_init.py\n@@ -1,14 +1,16 @@\n-\"\"\"Tests of the initialization of the twinly integration.\"\"\"\n+\"\"\"Tests of the initialization of the twinkly integration.\"\"\"\n \n from unittest.mock import patch\n from uuid import uuid4\n \n-from homeassistant.components.twinkly.const import DOMAIN as TWINKLY_DOMAIN\n+from homeassistant.components.light import DOMAIN as LIGHT_DOMAIN\n+from homeassistant.components.twinkly.const import DOMAIN\n from homeassistant.config_entries import ConfigEntryState\n from homeassistant.const import CONF_HOST, CONF_ID, CONF_MODEL, CONF_NAME\n from homeassistant.core import HomeAssistant\n+from homeassistant.helpers import device_registry as dr, entity_registry as er\n \n-from . import TEST_HOST, TEST_MODEL, TEST_NAME_ORIGINAL, ClientMock\n+from . import TEST_HOST, TEST_MAC, TEST_MODEL, TEST_NAME_ORIGINAL, ClientMock\n \n from tests.common import MockConfigEntry\n \n@@ -19,7 +21,7 @@ async def test_load_unload_entry(hass: HomeAssistant) -> None:\n \n     device_id = str(uuid4())\n     config_entry = MockConfigEntry(\n-        domain=TWINKLY_DOMAIN,\n+        domain=DOMAIN,\n         data={\n             CONF_HOST: TEST_HOST,\n             CONF_ID: device_id,\n@@ -27,6 +29,8 @@ async def test_load_unload_entry(hass: HomeAssistant) -> None:\n             CONF_MODEL: TEST_MODEL,\n         },\n         entry_id=device_id,\n+        unique_id=TEST_MAC,\n+        minor_version=2,\n     )\n \n     config_entry.add_to_hass(hass)\n@@ -47,13 +51,15 @@ async def test_config_entry_not_ready(hass: HomeAssistant) -> None:\n     client.is_offline = True\n \n     config_entry = MockConfigEntry(\n-        domain=TWINKLY_DOMAIN,\n+        domain=DOMAIN,\n         data={\n             CONF_HOST: TEST_HOST,\n             CONF_ID: id,\n             CONF_NAME: TEST_NAME_ORIGINAL,\n             CONF_MODEL: TEST_MODEL,\n         },\n+        minor_version=2,\n+        unique_id=TEST_MAC,\n     )\n \n     config_entry.add_to_hass(hass)\n@@ -62,3 +68,45 @@ async def test_config_entry_not_ready(hass: HomeAssistant) -> None:\n         await hass.config_entries.async_setup(config_entry.entry_id)\n \n     assert config_entry.state is ConfigEntryState.SETUP_RETRY\n+\n+\n+async def test_mac_migration(\n+    hass: HomeAssistant,\n+    entity_registry: er.EntityRegistry,\n+    device_registry: dr.DeviceRegistry,\n+) -> None:\n+    \"\"\"Validate that the unique_id is migrated to the MAC address.\"\"\"\n+    client = ClientMock()\n+\n+    config_entry = MockConfigEntry(\n+        domain=DOMAIN,\n+        minor_version=1,\n+        unique_id=\"unique_id\",\n+        data={\n+            CONF_HOST: TEST_HOST,\n+            CONF_ID: id,\n+            CONF_NAME: TEST_NAME_ORIGINAL,\n+            CONF_MODEL: TEST_MODEL,\n+        },\n+    )\n+    config_entry.add_to_hass(hass)\n+    entity_entry = entity_registry.async_get_or_create(\n+        LIGHT_DOMAIN,\n+        DOMAIN,\n+        config_entry.unique_id,\n+    )\n+    device_registry.async_get_or_create(\n+        config_entry_id=config_entry.entry_id,\n+        identifiers={(DOMAIN, config_entry.unique_id)},\n+    )\n+\n+    with patch(\"homeassistant.components.twinkly.Twinkly\", return_value=client):\n+        await hass.config_entries.async_setup(config_entry.entry_id)\n+\n+    assert config_entry.state is ConfigEntryState.LOADED\n+\n+    assert entity_registry.async_get(entity_entry.entity_id).unique_id == TEST_MAC\n+    assert device_registry.async_get_device(\n+        identifiers={(DOMAIN, config_entry.unique_id)}\n+    ).identifiers == {(DOMAIN, TEST_MAC)}\n+    assert config_entry.unique_id == TEST_MAC\ndiff --git a/tests/components/twinkly/test_light.py b/tests/components/twinkly/test_light.py\nindex 7a55dbec14aab8..26df83aebe0014 100644\n--- a/tests/components/twinkly/test_light.py\n+++ b/tests/components/twinkly/test_light.py\n@@ -15,7 +15,7 @@\n from homeassistant.helpers.device_registry import DeviceEntry\n from homeassistant.helpers.entity_registry import RegistryEntry\n \n-from . import TEST_MODEL, TEST_NAME, TEST_NAME_ORIGINAL, ClientMock\n+from . import TEST_MAC, TEST_MODEL, TEST_NAME, TEST_NAME_ORIGINAL, ClientMock\n \n from tests.common import MockConfigEntry, async_fire_time_changed\n \n@@ -301,7 +301,7 @@ async def test_update_name(\n     async_fire_time_changed(hass)\n     await hass.async_block_till_done()\n \n-    dev_entry = device_registry.async_get_device({(TWINKLY_DOMAIN, client.id)})\n+    dev_entry = device_registry.async_get_device({(TWINKLY_DOMAIN, TEST_MAC)})\n \n     assert dev_entry.name == \"new_device_name\"\n     assert config_entry.data[CONF_NAME] == \"new_device_name\"\n@@ -310,10 +310,9 @@ async def test_update_name(\n async def test_unload(hass: HomeAssistant) -> None:\n     \"\"\"Validate that entities can be unloaded from the UI.\"\"\"\n \n-    _, _, client, _ = await _create_entries(hass)\n-    entry_id = client.id\n+    _, _, _, entry = await _create_entries(hass)\n \n-    assert await hass.config_entries.async_unload(entry_id)\n+    assert await hass.config_entries.async_unload(entry.entry_id)\n \n \n async def _create_entries(\n@@ -330,18 +329,19 @@ async def _create_entries(\n                 CONF_NAME: TEST_NAME_ORIGINAL,\n                 CONF_MODEL: TEST_MODEL,\n             },\n-            entry_id=client.id,\n+            unique_id=TEST_MAC,\n+            minor_version=2,\n         )\n         config_entry.add_to_hass(hass)\n-        assert await hass.config_entries.async_setup(client.id)\n+        assert await hass.config_entries.async_setup(config_entry.entry_id)\n         await hass.async_block_till_done()\n \n     device_registry = dr.async_get(hass)\n     entity_registry = er.async_get(hass)\n \n-    entity_id = entity_registry.async_get_entity_id(\"light\", TWINKLY_DOMAIN, client.id)\n+    entity_id = entity_registry.async_get_entity_id(\"light\", TWINKLY_DOMAIN, TEST_MAC)\n     entity_entry = entity_registry.async_get(entity_id)\n-    device = device_registry.async_get_device(identifiers={(TWINKLY_DOMAIN, client.id)})\n+    device = device_registry.async_get_device(identifiers={(TWINKLY_DOMAIN, TEST_MAC)})\n \n     assert entity_entry is not None\n     assert device is not None\n", "problem_statement": "Twinkly Integration - erroneous Already_configured error\n### The problem\n\nI have two strings of lights.  Both are Series 1, both have firmware of 2.3.5.  One is on 10.0.10.183   and the other on 10.0.10.184.\r\n\r\nWhen I add 183 it adds normally and everything works.\r\nWhen I try and add 184 I get an already_configured message, despite this string not yet being configured.\r\nIf I remove 183 and then add 184 it adds, however I then get the already_configured error when attempting to add 183\r\n\r\nI have quite few twinkly lights 3 icicle, 1 600 led, 1 flex all series 2 and all added perfectly.   \r\n\r\nI suspect that fewer people have series one lights so this may not have been visible.  I have them and am capable of carrying out any debugging steps that may help.\n\n### What version of Home Assistant Core has the issue?\n\ncore 2024.12.4\n\n### What was the last working version of Home Assistant Core?\n\n_No response_\n\n### What type of installation are you running?\n\nHome Assistant OS\n\n### Integration causing the issue\n\ntwinkly \n\n### Link to integration documentation on our website\n\n_No response_\n\n### Diagnostics information\n\n[home-assistant_twinkly_2024-12-19T17-35-07.368Z.log](https://github.com/user-attachments/files/18201430/home-assistant_twinkly_2024-12-19T17-35-07.368Z.log)\r\n\r\n[config_entry-twinkly-01JFB8EF9CFDZQ15V982ZV535H - tree1-183.json](https://github.com/user-attachments/files/18201470/config_entry-twinkly-01JFB8EF9CFDZQ15V982ZV535H.-.tree1-183.json)\r\n\r\n[config_entry-twinkly-01JFG064PQ4PARQC20PE5BY7TY-tree2-184.json](https://github.com/user-attachments/files/18201480/config_entry-twinkly-01JFG064PQ4PARQC20PE5BY7TY-tree2-184.json)\r\n\r\nNote:  I removed Tree1 then added Tree2 with its address to get the second tree file so you can compare .  Following link may help with that.  Apart from the fact that there are some spec differences I could not see anything that might clash.\r\n\r\nhttps://www.textcompare.org/yaml/?id=67645be3dd54018d5d4e2ae9\r\n\n\n### Example YAML snippet\n\n```yaml\nNothing Yaml for this.\n```\n\n\n### Anything in the logs that might be useful for us?\n\n_No response_\n\n### Additional information\n\nAt one point I did have a look at the source code from github.  I found a line that suggested that already_configured was the response when a try catch block failed.  It may be that the error is something other than it being already configured, something that series 1 lights cause when whatever was in the try block was executed.\n", "hints_text": "\nHey there @dr1rrb, @robbie1221, @olen, mind taking a look at this issue as it has been labeled with an integration (`twinkly`) you are listed as a [code owner](https://github.com/home-assistant/core/blob/dev/CODEOWNERS#L1580) for? Thanks!\n\n<details>\n<summary>Code owner commands</summary>\n\n\nCode owners of `twinkly` can trigger bot actions by commenting:\n\n- `@home-assistant close` Closes the issue.\n- `@home-assistant rename Awesome new title` Renames the issue.\n- `@home-assistant reopen` Reopen the issue.\n- `@home-assistant unassign twinkly` Removes the current integration label and assignees on the issue, add the integration domain after the command.\n- `@home-assistant add-label needs-more-information` Add a label (needs-more-information, problem in dependency, problem in custom component) to the issue.\n- `@home-assistant remove-label needs-more-information` Remove a label (needs-more-information, problem in dependency, problem in custom component) on the issue.\n\n</details>\n\n\n<sub><sup>(message by CodeOwnersMention)</sup></sub>\n\n---\n\n[twinkly documentation](https://www.home-assistant.io/integrations/twinkly)\n[twinkly source](https://github.com/home-assistant/core/tree/dev/homeassistant/components/twinkly)\n<sub><sup>(message by IssueLinks)</sup></sub>\n@Olen any reason why we pick the UUID over the mac?\nNo special reason from my part.  I guess the uuid seemed quite unique, and was easily available in the library. (Honestly, i have not looked at the code for a long time)\nLet me also cc @jschlyter ", "created_at": "2024-12-21T11:58:21Z"}
{"repo": "home-assistant/core", "pull_number": 133699, "instance_id": "home-assistant__core-133699", "issue_numbers": ["126084"], "base_commit": "861d9b334160c865255c43d77787ccfaac43f5cd", "patch": "diff --git a/homeassistant/components/recorder/models/database.py b/homeassistant/components/recorder/models/database.py\nindex 94c5a7cc02724c..b86fd299793acc 100644\n--- a/homeassistant/components/recorder/models/database.py\n+++ b/homeassistant/components/recorder/models/database.py\n@@ -32,4 +32,8 @@ class DatabaseOptimizer:\n     #\n     # https://jira.mariadb.org/browse/MDEV-25020\n     #\n+    # PostgreSQL does not support a skip/loose index scan so its\n+    # also slow for large distinct queries:\n+    # https://wiki.postgresql.org/wiki/Loose_indexscan\n+    # https://github.com/home-assistant/core/issues/126084\n     slow_range_in_select: bool\ndiff --git a/homeassistant/components/recorder/purge.py b/homeassistant/components/recorder/purge.py\nindex 11f5accc9782c0..881952c390d007 100644\n--- a/homeassistant/components/recorder/purge.py\n+++ b/homeassistant/components/recorder/purge.py\n@@ -346,6 +346,10 @@ def _select_unused_attributes_ids(\n         # We now break the query into groups of 100 and use a lambda_stmt to ensure\n         # that the query is only cached once.\n         #\n+        # PostgreSQL also suffers from the same issue as older MariaDB with the distinct query\n+        # when the database gets large because it doesn't support skip/loose index scan.\n+        # https://wiki.postgresql.org/wiki/Loose_indexscan\n+        # https://github.com/home-assistant/core/issues/126084\n         groups = [iter(attributes_ids)] * 100\n         for attr_ids in zip_longest(*groups, fillvalue=None):\n             seen_ids |= {\ndiff --git a/homeassistant/components/recorder/queries.py b/homeassistant/components/recorder/queries.py\nindex 8ca7bef2691154..319be1b894e83e 100644\n--- a/homeassistant/components/recorder/queries.py\n+++ b/homeassistant/components/recorder/queries.py\n@@ -78,7 +78,7 @@ def find_states_metadata_ids(entity_ids: Iterable[str]) -> StatementLambdaElemen\n \n def _state_attrs_exist(attr: int | None) -> Select:\n     \"\"\"Check if a state attributes id exists in the states table.\"\"\"\n-    return select(func.min(States.attributes_id)).where(States.attributes_id == attr)\n+    return select(States.attributes_id).where(States.attributes_id == attr).limit(1)\n \n \n def attributes_ids_exist_in_states_with_fast_in_distinct(\n@@ -315,7 +315,7 @@ def data_ids_exist_in_events_with_fast_in_distinct(\n \n def _event_data_id_exist(data_id: int | None) -> Select:\n     \"\"\"Check if a event data id exists in the events table.\"\"\"\n-    return select(func.min(Events.data_id)).where(Events.data_id == data_id)\n+    return select(Events.data_id).where(Events.data_id == data_id).limit(1)\n \n \n def data_ids_exist_in_events(\ndiff --git a/homeassistant/components/recorder/util.py b/homeassistant/components/recorder/util.py\nindex ba4c5194689e58..4cf24eb79c549f 100644\n--- a/homeassistant/components/recorder/util.py\n+++ b/homeassistant/components/recorder/util.py\n@@ -600,6 +600,12 @@ def setup_connection_for_dialect(\n         execute_on_connection(dbapi_connection, \"SET time_zone = '+00:00'\")\n     elif dialect_name == SupportedDialect.POSTGRESQL:\n         max_bind_vars = DEFAULT_MAX_BIND_VARS\n+        # PostgreSQL does not support a skip/loose index scan so its\n+        # also slow for large distinct queries:\n+        # https://wiki.postgresql.org/wiki/Loose_indexscan\n+        # https://github.com/home-assistant/core/issues/126084\n+        # so we set slow_range_in_select to True\n+        slow_range_in_select = True\n         if first_connection:\n             # server_version_num was added in 2006\n             result = query_on_connection(dbapi_connection, \"SHOW server_version\")\n", "test_patch": "diff --git a/tests/components/recorder/test_util.py b/tests/components/recorder/test_util.py\nindex 99bd5083489b75..aeeeba1865aaed 100644\n--- a/tests/components/recorder/test_util.py\n+++ b/tests/components/recorder/test_util.py\n@@ -502,7 +502,7 @@ def _make_cursor_mock(*_):\n \n     assert \"minimum supported version\" not in caplog.text\n     assert database_engine is not None\n-    assert database_engine.optimizer.slow_range_in_select is False\n+    assert database_engine.optimizer.slow_range_in_select is True\n \n \n @pytest.mark.parametrize(\n", "problem_statement": "Purge causes recorder to stop writing to the DB.\n### The problem\r\n\r\nSince the last database migration with a focus on POSTGRESQL, I see almost every day that the recorder stops recording data. Restarting HA brings the recording back, but the data in between is lost.\r\nThe symptoms are the same as in issue #117263, but the background is different in my opinion.\r\nI'm using a POSTGRESQL-database on an other machine. Access to the database itself is therefore easier for me to handle. \r\n\r\nAccording to the SQLALCHEMY debug log, the daily database cleanup begins with a SELECT on the \"states\" table (blocked to 4000 records), followed by an UPDATE of the \"old_state_id\", again followed by a DELETE.\r\nThis sequence repeats itself in the example (see LOG) 20 times in about 30 seconds.\r\nThis is followed by a \"SELECT DISTINCT states.attributes_id FROM states WHERE states.attributes_id IN (.....)\" THIS statement is useless in my opinion because the \"attributes_id\" listed in the IN part of the statement is already \"unique\", so the result of the \"SELECT DISTINCT\" corresponds to the values \u200b\u200bsought in the query.\r\nThe FULL index scan resulting from the SELECT places a massive load on the database without any apparent purpose and leads to a blockage of the recording.\r\nAs expected, aborting the SELECT statement on the server side leads to a ROLLBACK of the entire PURGE. However, the data buffered in the meantime is cleanly written to the database and a restart of HA is NOT necessary. The database-purge itself is NOT done. If the SELECT DISTINCT is not canceled after a couple of hours memory-consumption on HA is raising and the only method to get a functioning system is a reboot of the complete HA-system; of course also with a ROLLBACK because of the lost connection........\r\n\r\n{EDIT] 2024/19/09\r\nAfter further searching and many hours later, I found the check for \"database_engine.optimizer.slow_range_in_select\" in the \"purge.py\" source... and the comment about MariaDB's poor optimizer....\r\nI thought \"it can't get any worse\" so I looked for the place where it is set.... That led to \"util.py\"... There I added (in my case in line 601) the statement \"slow_range_in_select = True\" and started a PURGE.\r\nI THINK the purge takes longer, but it works!\r\n\r\n\r\n### What version of Home Assistant Core has the issue?\r\n\r\ncore-2024.9.1\r\n\r\n### What was the last working version of Home Assistant Core?\r\n\r\n_No response_\r\n\r\n### What type of installation are you running?\r\n\r\nHome Assistant OS\r\n\r\n### Integration causing the issue\r\n\r\nrecorder\r\n\r\n### Link to integration documentation on our website\r\n\r\n[Recorder](https://www.home-assistant.io/integrations/recorder/)\r\n\r\n### Diagnostics information\r\n\r\n[home-assistant.log](https://github.com/user-attachments/files/17017471/home-assistant.log)\r\n\r\n\r\n### Example YAML snippet\r\n\r\n_No response_\r\n\r\n### Anything in the logs that might be useful for us?\r\n\r\n_No response_\r\n\r\n### Additional information\r\n\r\nEXPLAIN of a SHORT form of the \"SELECT DISTINCT\"-statement:\r\n\r\nUnique  (cost=0.57..3452037.82 rows=2198 width=8)                                                                                                                     ->  Index Only Scan using ix_states_attributes_id on states  (cost=0.57..3448204.77 rows=1533221 width=8)                                                                 Index Cond: (attributes_id = ANY ('{4734983,21,4816918,23,4751383,9245058,22,24,9378572,9378573,9378574,4800548,9378578,9378579,58,64,4735040,66,67,68,7787168,7822000,6619208,74,7822001,76,77,4767820,9378583,7822002,9378584,83,85,86,92,7787169,94,6619235,9378589,9378590,112,114,115,9378591,7787170,4735095,6783100,4735104,4866181,4735114,7864475,7864476,7864477,6783139,9378604,9378606,9378607,6799568,4899078,9339143,4822851,4771823,7536906,4800789,4735253,4735266,4768038,8257853,9355597,4817229,7995733,7995734,7995735,7639693,345,349,350,4850055,8028605,8028606,8028607,7520730,9378664,7553530,4735485,7979522,7979523,7979524,9378671,9378678,9378679,4804398,3981877,9378680,4735544,9378681,9378682,9378685,6701714,7717528,7717529,7717530,8045216,4754547,9241256,4850348,4768434,9378705,6636221,7848643,9375452,7717573,7717574,7717575,4866756,9378709,773397}'::bigint[]))                                                                                                     \r\nJIT:                                                                                                                                                                  Functions: 2                                                                                                                                                        Options: Inlining true, Optimization true, Expressions true, Deforming true\n", "hints_text": "\nHey there @home-assistant/core, mind taking a look at this issue as it has been labeled with an integration (`recorder`) you are listed as a [code owner](https://github.com/home-assistant/core/blob/dev/CODEOWNERS#L1201) for? Thanks!\n\n<details>\n<summary>Code owner commands</summary>\n\n\nCode owners of `recorder` can trigger bot actions by commenting:\n\n- `@home-assistant close` Closes the issue.\n- `@home-assistant rename Awesome new title` Renames the issue.\n- `@home-assistant reopen` Reopen the issue.\n- `@home-assistant unassign recorder` Removes the current integration label and assignees on the issue, add the integration domain after the command.\n- `@home-assistant add-label needs-more-information` Add a label (needs-more-information, problem in dependency, problem in custom component) to the issue.\n- `@home-assistant remove-label needs-more-information` Remove a label (needs-more-information, problem in dependency, problem in custom component) on the issue.\n\n</details>\n\n\n<sub><sup>(message by CodeOwnersMention)</sup></sub>\n\n---\n\n[recorder documentation](https://www.home-assistant.io/integrations/recorder)\n[recorder source](https://github.com/home-assistant/core/tree/dev/homeassistant/components/recorder)\n<sub><sup>(message by IssueLinks)</sup></sub>\nI didn't really see it written, but is it the same when the recorder hangs during autopurge after some 4AM ?\n> I didn't really see it written, but is it the same when the recorder hangs during autopurge after some 4AM ?\r\n\r\nAs **I** understand the \"4am hang\", YES. But since I have POSTGRES running on another machine and there are some \"midnight jobs\" there, the HA purge starts at 00:12... (also because that counts as such FOR ME). \r\nAROUND 3.5 - 4 hours after starting, there is a sharp increase in memory requirements on HA and shortly afterwards the \"recorder hang\"... \r\nAFTER this point, only a restart of the HA system has ever helped to get a recording again. On the SQL server, the load AVG rises to 5-7 during this period...\r\nThe \"SQL server\" is a RASPI-4B with 8GB. It plays a small NAS, DNS for the LAN, the SQL server and little bit system-playground for me...... But it handles it VERY well. Load AVG is usually <= 0.5....\r\n\r\nBest regards,\r\n  Peter\nThe select distinct optimizes poorly with PostgreSQL because it doesn't support loose/skip index scans https://wiki.postgresql.org/wiki/Loose_indexscan\n```\r\nselect \r\n  attributes_id \r\nfrom \r\n  states \r\nwhere \r\n  attributes_id in (\r\n    1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, \r\n    15, 16, 17, 18, 19, 23, 25, 26, 27, 28, \r\n    29, 30, 31, 32, 33, 34, 35, 36, 37, 40, \r\n    41, 42, 43, 44, 45, 47, 48, 49, 50, 51, \r\n    52, 53, 54, 55, 56, 57, 58, 59, 60, 61, \r\n    62\r\n  ) \r\ngroup by \r\n  attributes_id;\r\n\r\n```\r\n\r\nThat might be a bit faster\ndoesn't really help\r\n```\r\n# explain select \r\n  attributes_id \r\nfrom \r\n  states \r\nwhere \r\n  attributes_id in (\r\n    1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, \r\n    15, 16, 17, 18, 19, 23, 25, 26, 27, 28, \r\n    29, 30, 31, 32, 33, 34, 35, 36, 37, 40, \r\n    41, 42, 43, 44, 45, 47, 48, 49, 50, 51, \r\n    52, 53, 54, 55, 56, 57, 58, 59, 60, 61, \r\n    62\r\n  ) \r\ngroup by \r\n  attributes_id;\r\n                                                                                                      QUERY PLAN                                                                                                       \r\n-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------\r\n Group  (cost=0.57..33703.02 rows=2616 width=8)\r\n   Group Key: attributes_id\r\n   ->  Index Only Scan using ix_states_attributes_id on states  (cost=0.57..30253.55 rows=1379788 width=8)\r\n         Index Cond: (attributes_id = ANY ('{1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,23,25,26,27,28,29,30,31,32,33,34,35,36,37,40,41,42,43,44,45,47,48,49,50,51,52,53,54,55,56,57,58,59,60,61,62}'::bigint[]))\r\n(4 rows)\r\n\r\n# explain SELECT \r\n  DISTINCT states.attributes_id \r\nFROM \r\n  states \r\nWHERE \r\n  states.attributes_id IN (\r\n    1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, \r\n    15, 16, 17, 18, 19, 23, 25, 26, 27, 28, \r\n    29, 30, 31, 32, 33, 34, 35, 36, 37, 40, \r\n    41, 42, 43, 44, 45, 46, 47, 48, 49, 50, \r\n    51, 52, 53, 54, 55, 56, 57, 58, 59, 60, \r\n    61, 62\r\n  );\r\n;\r\n                                                                                                        QUERY PLAN                                                                                                        \r\n--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------\r\n Unique  (cost=0.57..34314.72 rows=2616 width=8)\r\n   ->  Index Only Scan using ix_states_attributes_id on states  (cost=0.57..30802.53 rows=1404875 width=8)\r\n         Index Cond: (attributes_id = ANY ('{1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,23,25,26,27,28,29,30,31,32,33,34,35,36,37,40,41,42,43,44,45,46,47,48,49,50,51,52,53,54,55,56,57,58,59,60,61,62}'::bigint[]))\r\n(3 rows)\r\n\r\n```\n```\r\n# explain SELECT \r\n  inner_state_attributes.attributes_id AS attributes_id \r\nFROM \r\n  state_attributes \r\n  JOIN LATERAL (\r\n    SELECT \r\n      states.attributes_id as attributes_id \r\n    FROM \r\n      states \r\n    WHERE \r\n      states.attributes_id = state_attributes.attributes_id \r\n    LIMIT \r\n      1\r\n  ) AS inner_state_attributes ON true\r\nWHERE \r\n  state_attributes.attributes_id IN (\r\n    1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, \r\n    15, 16, 17, 18, 19, 23, 25, 26, 27, 28, \r\n    29, 30, 31, 32, 33, 34, 35, 36, 37, 40, \r\n    41, 42, 43, 44, 45, 46, 47, 48, 49, 50, \r\n    51, 52, 53, 54, 55, 56, 57, 58, 59, 60, \r\n    61, 62\r\n  );\r\n                                                                                                        QUERY PLAN                                                                                                        \r\n--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------\r\n Nested Loop  (cost=1.01..287.75 rows=56 width=8)\r\n   ->  Index Only Scan using state_attributes_pkey on state_attributes  (cost=0.43..253.34 rows=56 width=8)\r\n         Index Cond: (attributes_id = ANY ('{1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,23,25,26,27,28,29,30,31,32,33,34,35,36,37,40,41,42,43,44,45,46,47,48,49,50,51,52,53,54,55,56,57,58,59,60,61,62}'::bigint[]))\r\n   ->  Limit  (cost=0.57..0.59 rows=1 width=8)\r\n         ->  Index Only Scan using ix_states_attributes_id on states  (cost=0.57..2964.22 rows=135045 width=8)\r\n               Index Cond: (attributes_id = state_attributes.attributes_id)\r\n(6 rows)\r\n```\r\n\r\nIf we re-write it as a lateral join its almost an order of magnitude faster\nIt probably makes more sense to set `slow_range_in_select` for PostgreSQL because it will be nearly as fast and we don't have to support another code branch", "created_at": "2024-12-21T04:39:34Z"}
{"repo": "home-assistant/core", "pull_number": 133697, "instance_id": "home-assistant__core-133697", "issue_numbers": ["132985"], "base_commit": "861d9b334160c865255c43d77787ccfaac43f5cd", "patch": "diff --git a/homeassistant/components/mqtt/client.py b/homeassistant/components/mqtt/client.py\nindex 73c6b80cb140bb..6500c9f91c9ba4 100644\n--- a/homeassistant/components/mqtt/client.py\n+++ b/homeassistant/components/mqtt/client.py\n@@ -695,12 +695,15 @@ def _async_cancel_reconnect(self) -> None:\n \n     async def _reconnect_loop(self) -> None:\n         \"\"\"Reconnect to the MQTT server.\"\"\"\n+        # pylint: disable-next=import-outside-toplevel\n+        import paho.mqtt.client as mqtt\n+\n         while True:\n             if not self.connected:\n                 try:\n                     async with self._connection_lock, self._async_connect_in_executor():\n                         await self.hass.async_add_executor_job(self._mqttc.reconnect)\n-                except OSError as err:\n+                except (OSError, mqtt.WebsocketConnectionError) as err:\n                     _LOGGER.debug(\n                         \"Error re-connecting to MQTT server due to exception: %s\", err\n                     )\n", "test_patch": "diff --git a/tests/components/mqtt/test_client.py b/tests/components/mqtt/test_client.py\nindex 1878045a9b9296..1daad0e39148ca 100644\n--- a/tests/components/mqtt/test_client.py\n+++ b/tests/components/mqtt/test_client.py\n@@ -1888,10 +1888,18 @@ async def test_mqtt_subscribes_and_unsubscribes_in_chunks(\n     assert len(mqtt_client_mock.unsubscribe.mock_calls[1][1][0]) == 2\n \n \n+@pytest.mark.parametrize(\n+    \"exception\",\n+    [\n+        OSError,\n+        paho_mqtt.WebsocketConnectionError,\n+    ],\n+)\n async def test_auto_reconnect(\n     hass: HomeAssistant,\n     setup_with_birth_msg_client_mock: MqttMockPahoClient,\n     caplog: pytest.LogCaptureFixture,\n+    exception: Exception,\n ) -> None:\n     \"\"\"Test reconnection is automatically done.\"\"\"\n     mqtt_client_mock = setup_with_birth_msg_client_mock\n@@ -1902,7 +1910,7 @@ async def test_auto_reconnect(\n     mqtt_client_mock.on_disconnect(None, None, 0)\n     await hass.async_block_till_done()\n \n-    mqtt_client_mock.reconnect.side_effect = OSError(\"foo\")\n+    mqtt_client_mock.reconnect.side_effect = exception(\"foo\")\n     async_fire_time_changed(\n         hass, utcnow() + timedelta(seconds=RECONNECT_INTERVAL_SECONDS)\n     )\n", "problem_statement": "MQTT Client Loses Connection and Does Not Attempt Reconnect Without Restarting HA\n### The problem\r\n\r\nSetting up a connection to a local Mosquitto MQTT broker via wss works just fine. The Home Assistant MQTT client connects, receives, and publishes messages as expected.\r\n\r\nIf I restart my Mosquitto service for any reason, Home Assistant logs that it lost the connection. It does not attempt to reconnect to the broker until I restart Home Assistant. Other clients using the same endpoint reconnect without issue immediately once the broker is back online.\r\n\r\n### What version of Home Assistant Core has the issue?\r\n\r\ncore-2024.12.0\r\n\r\n### What was the last working version of Home Assistant Core?\r\n\r\n_No response_\r\n\r\n### What type of installation are you running?\r\n\r\nHome Assistant Container\r\n\r\n### Integration causing the issue\r\n\r\nMQTT\r\n\r\n### Link to integration documentation on our website\r\n\r\nhttps://www.home-assistant.io/integrations/mqtt/\r\n\r\n### Diagnostics information\r\n\r\n_No response_\r\n\r\n### Example YAML snippet\r\n\r\n_No response_\r\n\r\n### Anything in the logs that might be useful for us?\r\n\r\n```txt\r\n2024-12-11T21:02:31.528977372-06:00 stderr F 2024-12-11 21:02:31.520 DEBUG (MainThread) [homeassistant.components.mqtt.models] Rendering incoming payload '[{\"amp\":null,\"att\":{\"ref\":0}},{\"amp\":null,\"att\":{\"ref\":0}},{\"amp\":null,\"att\":{\"ref\":0}},{\"amp\":null,\"att\":{\"ref\":0}},{\"amp\":null,\"att\":{\"ref\":0}},{\"amp\":null,\"att\":{\"ref\":0}},{\"amp\":null,\"att\":{\"ref\":0}},{\"amp\":null,\"att\":{\"ref\":0}}]' with variables {'entity_id': 'select.energy_monitor_mqtt_select_4', 'name': 'MQTT Select', 'this': <template TemplateStateFromEntityId(select.energy_monitor_mqtt_select_4)>} and Template<template=({{ (value_json[3].att.ref | string) + ' Amp' }}) renders=60>\r\n2024-12-11T21:02:34.555509706-06:00 stderr F 2024-12-11 21:02:34.553 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: connection closed 34\r\n2024-12-11T21:02:34.563350289-06:00 stderr F 2024-12-11 21:02:34.558 DEBUG (MainThread) [homeassistant.components.mqtt.client] Disconnected from MQTT server mosquitto.mydomain.com:443 (7)\r\n```\r\n\r\n\r\n### Additional information\r\n\r\nThe included log output shows 3 consecutive logs from the mqtt client in debug logging mode. The first line just represents a healthy event being received. The next 2 represent the moment when the broker was restarted.\r\nOver the course of minutes or hours, nothing else from the mqtt client is logged.\r\n\r\nA snippet from the HQ diagnostics concerning MQTT:\r\n```json\r\n{\r\n   \"mqtt_config\": {\r\n      \"birth_message\": {\r\n        \"payload\": \"online\",\r\n        \"qos\": 0,\r\n        \"retain\": false,\r\n        \"topic\": \"homeassistant/status\"\r\n      },\r\n      \"broker\": \"mosquitto.mydomain.com\",\r\n      \"certificate\": \"auto\",\r\n      \"discovery\": true,\r\n      \"discovery_prefix\": \"homeassistant\",\r\n      \"keepalive\": 30,\r\n      \"password\": \"**REDACTED**\",\r\n      \"port\": 443,\r\n      \"protocol\": \"3.1.1\",\r\n      \"tls_insecure\": false,\r\n      \"transport\": \"websockets\",\r\n      \"username\": \"**REDACTED**\",\r\n      \"will_message\": {\r\n        \"payload\": \"offline\",\r\n        \"qos\": 0,\r\n        \"retain\": false,\r\n        \"topic\": \"homeassistant/status\"\r\n      },\r\n      \"ws_headers\": {},\r\n      \"ws_path\": \"/\"\r\n    }\r\n}\r\n```\r\n\r\nThe Mosquitto broker sits behind an Nginx reverse proxy that manages a Let's Encrypt wildcard domain cert for my personal domain. I have PiHole routing local DNS requests for the `mosquitto.mydomain.com` domain to the Nginx reverse proxies listening on two different static IP addresses. Connecting to either IP on port 443 will get through to the single backend Mosquitto service.\r\n\r\nMQTT explorer and various devices connected to the broker through the exact same endpoint work fine and reconnect immediately once the broker is back online. Home Assistant seems to be the only client that does not recover.\r\n\r\nRestarting via the UI or restarting the HA Docker container both work to get the mqtt client working again. Re-saving the MQTT configuration via the UI does not. Using the MQTT configure UI to publish a test message fails and logs an error about how the client isn't connected.\n", "hints_text": "\nHey there @emontnemery, @jbouwh, @bdraco, mind taking a look at this issue as it has been labeled with an integration (`mqtt`) you are listed as a [code owner](https://github.com/home-assistant/core/blob/dev/CODEOWNERS#L956) for? Thanks!\n\n<details>\n<summary>Code owner commands</summary>\n\n\nCode owners of `mqtt` can trigger bot actions by commenting:\n\n- `@home-assistant close` Closes the issue.\n- `@home-assistant rename Awesome new title` Renames the issue.\n- `@home-assistant reopen` Reopen the issue.\n- `@home-assistant unassign mqtt` Removes the current integration label and assignees on the issue, add the integration domain after the command.\n- `@home-assistant add-label needs-more-information` Add a label (needs-more-information, problem in dependency, problem in custom component) to the issue.\n- `@home-assistant remove-label needs-more-information` Remove a label (needs-more-information, problem in dependency, problem in custom component) on the issue.\n\n</details>\n\n\n<sub><sup>(message by CodeOwnersMention)</sup></sub>\n\n---\n\n[mqtt documentation](https://www.home-assistant.io/integrations/mqtt)\n[mqtt source](https://github.com/home-assistant/core/tree/dev/homeassistant/components/mqtt)\n<sub><sup>(message by IssueLinks)</sup></sub>\nHi, is there anything other in HA Core the logs. Also check for custom integrations. Please turn on matt debug logging on Home Assistant.\nDebug logging was already enabled. I just now disabled the couple of custom integrations and restarted HA. After waiting a few minutes I restarted the broker. HA immediately lost connection and did not attempt to reconnect.\r\n\r\nHere are all of the logs from HA since startup including an error at the end after the disconnect where I attempted to send a message via the UI configure:\r\n\r\n<details>\r\n\r\n<summary>HA Logs</summary>\r\n\r\n```\r\n2024-12-12T20:41:14.246111079-06:00 stderr F s6-rc: info: service s6rc-oneshot-runner: starting\r\n2024-12-12T20:41:14.252208223-06:00 stderr F s6-rc: info: service s6rc-oneshot-runner successfully started\r\n2024-12-12T20:41:14.252426790-06:00 stderr F s6-rc: info: service fix-attrs: starting\r\n2024-12-12T20:41:14.260816940-06:00 stderr F s6-rc: info: service fix-attrs successfully started\r\n2024-12-12T20:41:14.260978963-06:00 stderr F s6-rc: info: service legacy-cont-init: starting\r\n2024-12-12T20:41:14.268809626-06:00 stderr F s6-rc: info: service legacy-cont-init successfully started\r\n2024-12-12T20:41:14.268993724-06:00 stderr F s6-rc: info: service legacy-services: starting\r\n2024-12-12T20:41:14.279034406-06:00 stderr P services-up: info: copying legacy longrun home-assistant\r\n2024-12-12T20:41:14.280839625-06:00 stderr F  (no readiness notification)\r\n2024-12-12T20:41:14.346529496-06:00 stderr F s6-rc: info: service legacy-services successfully started\r\n2024-12-12T20:41:37.024941763-06:00 stderr F 2024-12-12 20:41:37.020 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: connection opened 33\r\n2024-12-12T20:41:37.025974861-06:00 stderr F 2024-12-12 20:41:37.020 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: Starting client misc loop\r\n2024-12-12T20:41:37.026403601-06:00 stderr F 2024-12-12 20:41:37.020 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 33\r\n2024-12-12T20:41:37.026927311-06:00 stderr F 2024-12-12 20:41:37.025 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 33\r\n2024-12-12T20:41:37.028433518-06:00 stderr F 2024-12-12 20:41:37.027 DEBUG (MainThread) [homeassistant.components.mqtt.client] Connected to MQTT server mosquitto.mydomain.com:443 (0)\r\n2024-12-12T20:41:37.530956328-06:00 stderr F 2024-12-12 20:41:37.529 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 33\r\n2024-12-12T20:41:37.531540925-06:00 stderr F 2024-12-12 20:41:37.529 DEBUG (MainThread) [homeassistant.components.mqtt.client] Subscribing with mid: 1 to topics with qos: [('homeassistant/alarm_control_panel/+/config', 0)]\r\n2024-12-12T20:41:37.531776111-06:00 stderr F 2024-12-12 20:41:37.530 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 33\r\n2024-12-12T20:41:37.532706002-06:00 stderr F 2024-12-12 20:41:37.532 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 33\r\n2024-12-12T20:41:37.533502302-06:00 stderr F 2024-12-12 20:41:37.532 DEBUG (MainThread) [homeassistant.components.mqtt.client] Subscribing with mid: 2 to topics with qos: [('homeassistant/binary_sensor/+/config', 0)]\r\n2024-12-12T20:41:37.534231876-06:00 stderr F 2024-12-12 20:41:37.533 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 33\r\n2024-12-12T20:41:37.534950645-06:00 stderr F 2024-12-12 20:41:37.534 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 33\r\n2024-12-12T20:41:37.535447258-06:00 stderr F 2024-12-12 20:41:37.535 DEBUG (MainThread) [homeassistant.components.mqtt.client] Subscribing with mid: 3 to topics with qos: [('homeassistant/button/+/config', 0)]\r\n2024-12-12T20:41:37.535836396-06:00 stderr F 2024-12-12 20:41:37.535 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 33\r\n2024-12-12T20:41:37.536870853-06:00 stderr F 2024-12-12 20:41:37.536 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 33\r\n2024-12-12T20:41:37.537111465-06:00 stderr F 2024-12-12 20:41:37.536 DEBUG (MainThread) [homeassistant.components.mqtt.client] Subscribing with mid: 4 to topics with qos: [('homeassistant/camera/+/config', 0)]\r\n2024-12-12T20:41:37.537574045-06:00 stderr F 2024-12-12 20:41:37.537 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 33\r\n2024-12-12T20:41:37.538091722-06:00 stderr F 2024-12-12 20:41:37.537 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 33\r\n2024-12-12T20:41:37.538686570-06:00 stderr F 2024-12-12 20:41:37.538 DEBUG (MainThread) [homeassistant.components.mqtt.client] Subscribing with mid: 5 to topics with qos: [('homeassistant/climate/+/config', 0)]\r\n2024-12-12T20:41:37.539133607-06:00 stderr F 2024-12-12 20:41:37.538 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 33\r\n2024-12-12T20:41:37.540025980-06:00 stderr F 2024-12-12 20:41:37.539 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 33\r\n2024-12-12T20:41:37.540278454-06:00 stderr F 2024-12-12 20:41:37.539 DEBUG (MainThread) [homeassistant.components.mqtt.client] Subscribing with mid: 6 to topics with qos: [('homeassistant/cover/+/config', 0)]\r\n2024-12-12T20:41:37.541433600-06:00 stderr F 2024-12-12 20:41:37.540 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 33\r\n2024-12-12T20:41:37.541871825-06:00 stderr F 2024-12-12 20:41:37.540 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 33\r\n2024-12-12T20:41:37.542228182-06:00 stderr F 2024-12-12 20:41:37.540 DEBUG (MainThread) [homeassistant.components.mqtt.client] Subscribing with mid: 7 to topics with qos: [('homeassistant/device_automation/+/config', 0)]\r\n2024-12-12T20:41:37.542472441-06:00 stderr F 2024-12-12 20:41:37.541 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 33\r\n2024-12-12T20:41:37.543451910-06:00 stderr F 2024-12-12 20:41:37.542 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 33\r\n2024-12-12T20:41:37.543724879-06:00 stderr F 2024-12-12 20:41:37.543 DEBUG (MainThread) [homeassistant.components.mqtt.client] Subscribing with mid: 8 to topics with qos: [('homeassistant/device_tracker/+/config', 0)]\r\n2024-12-12T20:41:37.544245173-06:00 stderr F 2024-12-12 20:41:37.543 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 33\r\n2024-12-12T20:41:37.545090547-06:00 stderr F 2024-12-12 20:41:37.544 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 33\r\n2024-12-12T20:41:37.545345214-06:00 stderr F 2024-12-12 20:41:37.544 DEBUG (MainThread) [homeassistant.components.mqtt.client] Subscribing with mid: 9 to topics with qos: [('homeassistant/event/+/config', 0)]\r\n2024-12-12T20:41:37.545837317-06:00 stderr F 2024-12-12 20:41:37.545 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 33\r\n2024-12-12T20:41:37.546790293-06:00 stderr F 2024-12-12 20:41:37.546 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 33\r\n2024-12-12T20:41:37.547042182-06:00 stderr F 2024-12-12 20:41:37.546 DEBUG (MainThread) [homeassistant.components.mqtt.client] Subscribing with mid: 10 to topics with qos: [('homeassistant/fan/+/config', 0)]\r\n2024-12-12T20:41:37.547490594-06:00 stderr F 2024-12-12 20:41:37.547 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 33\r\n2024-12-12T20:41:37.548402560-06:00 stderr F 2024-12-12 20:41:37.547 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 33\r\n2024-12-12T20:41:37.548659556-06:00 stderr F 2024-12-12 20:41:37.547 DEBUG (MainThread) [homeassistant.components.mqtt.client] Subscribing with mid: 11 to topics with qos: [('homeassistant/humidifier/+/config', 0)]\r\n2024-12-12T20:41:37.549079945-06:00 stderr F 2024-12-12 20:41:37.548 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 33\r\n2024-12-12T20:41:37.550003273-06:00 stderr F 2024-12-12 20:41:37.549 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 33\r\n2024-12-12T20:41:37.550315929-06:00 stderr F 2024-12-12 20:41:37.549 DEBUG (MainThread) [homeassistant.components.mqtt.client] Subscribing with mid: 12 to topics with qos: [('homeassistant/image/+/config', 0)]\r\n2024-12-12T20:41:37.550747036-06:00 stderr F 2024-12-12 20:41:37.550 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 33\r\n2024-12-12T20:41:37.551584630-06:00 stderr F 2024-12-12 20:41:37.551 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 33\r\n2024-12-12T20:41:37.551824867-06:00 stderr F 2024-12-12 20:41:37.551 DEBUG (MainThread) [homeassistant.components.mqtt.client] Subscribing with mid: 13 to topics with qos: [('homeassistant/lawn_mower/+/config', 0)]\r\n2024-12-12T20:41:37.552273020-06:00 stderr F 2024-12-12 20:41:37.551 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 33\r\n2024-12-12T20:41:37.553111489-06:00 stderr F 2024-12-12 20:41:37.552 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 33\r\n2024-12-12T20:41:37.553349986-06:00 stderr F 2024-12-12 20:41:37.552 DEBUG (MainThread) [homeassistant.components.mqtt.client] Subscribing with mid: 14 to topics with qos: [('homeassistant/light/+/config', 0)]\r\n2024-12-12T20:41:37.553848525-06:00 stderr F 2024-12-12 20:41:37.553 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 33\r\n2024-12-12T20:41:37.554480973-06:00 stderr F 2024-12-12 20:41:37.554 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 33\r\n2024-12-12T20:41:37.555027835-06:00 stderr F 2024-12-12 20:41:37.554 DEBUG (MainThread) [homeassistant.components.mqtt.client] Subscribing with mid: 15 to topics with qos: [('homeassistant/lock/+/config', 0)]\r\n2024-12-12T20:41:37.555492164-06:00 stderr F 2024-12-12 20:41:37.555 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 33\r\n2024-12-12T20:41:37.556414519-06:00 stderr F 2024-12-12 20:41:37.555 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 33\r\n2024-12-12T20:41:37.556683925-06:00 stderr F 2024-12-12 20:41:37.555 DEBUG (MainThread) [homeassistant.components.mqtt.client] Subscribing with mid: 16 to topics with qos: [('homeassistant/notify/+/config', 0)]\r\n2024-12-12T20:41:37.557686382-06:00 stderr F 2024-12-12 20:41:37.556 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 33\r\n2024-12-12T20:41:37.557955668-06:00 stderr F 2024-12-12 20:41:37.557 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 33\r\n2024-12-12T20:41:37.558433476-06:00 stderr F 2024-12-12 20:41:37.557 DEBUG (MainThread) [homeassistant.components.mqtt.client] Subscribing with mid: 17 to topics with qos: [('homeassistant/number/+/config', 0)]\r\n2024-12-12T20:41:37.558944917-06:00 stderr F 2024-12-12 20:41:37.558 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 33\r\n2024-12-12T20:41:37.559797094-06:00 stderr F 2024-12-12 20:41:37.559 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 33\r\n2024-12-12T20:41:37.560050008-06:00 stderr F 2024-12-12 20:41:37.559 DEBUG (MainThread) [homeassistant.components.mqtt.client] Subscribing with mid: 18 to topics with qos: [('homeassistant/scene/+/config', 0)]\r\n2024-12-12T20:41:37.560537835-06:00 stderr F 2024-12-12 20:41:37.560 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 33\r\n2024-12-12T20:41:37.561515540-06:00 stderr F 2024-12-12 20:41:37.560 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 33\r\n2024-12-12T20:41:37.561777562-06:00 stderr F 2024-12-12 20:41:37.561 DEBUG (MainThread) [homeassistant.components.mqtt.client] Subscribing with mid: 19 to topics with qos: [('homeassistant/siren/+/config', 0)]\r\n2024-12-12T20:41:37.562441352-06:00 stderr F 2024-12-12 20:41:37.561 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 33\r\n2024-12-12T20:41:37.563006488-06:00 stderr F 2024-12-12 20:41:37.562 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 33\r\n2024-12-12T20:41:37.563434044-06:00 stderr F 2024-12-12 20:41:37.563 DEBUG (MainThread) [homeassistant.components.mqtt.client] Subscribing with mid: 20 to topics with qos: [('homeassistant/select/+/config', 0)]\r\n2024-12-12T20:41:37.564027407-06:00 stderr F 2024-12-12 20:41:37.563 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 33\r\n2024-12-12T20:41:37.565190851-06:00 stderr F 2024-12-12 20:41:37.564 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 33\r\n2024-12-12T20:41:37.565452419-06:00 stderr F 2024-12-12 20:41:37.564 DEBUG (MainThread) [homeassistant.components.mqtt.client] Subscribing with mid: 21 to topics with qos: [('homeassistant/sensor/+/config', 0)]\r\n2024-12-12T20:41:37.566691059-06:00 stderr F 2024-12-12 20:41:37.565 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 33\r\n2024-12-12T20:41:37.566902131-06:00 stderr F 2024-12-12 20:41:37.566 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 33\r\n2024-12-12T20:41:37.567130323-06:00 stderr F 2024-12-12 20:41:37.566 DEBUG (MainThread) [homeassistant.components.mqtt.client] Subscribing with mid: 22 to topics with qos: [('homeassistant/switch/+/config', 0)]\r\n2024-12-12T20:41:37.567547051-06:00 stderr F 2024-12-12 20:41:37.567 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 33\r\n2024-12-12T20:41:37.568619487-06:00 stderr F 2024-12-12 20:41:37.567 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 33\r\n2024-12-12T20:41:37.568775653-06:00 stderr F 2024-12-12 20:41:37.568 DEBUG (MainThread) [homeassistant.components.mqtt.client] Subscribing with mid: 23 to topics with qos: [('homeassistant/tag/+/config', 0)]\r\n2024-12-12T20:41:37.569520211-06:00 stderr F 2024-12-12 20:41:37.568 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 33\r\n2024-12-12T20:41:37.570595041-06:00 stderr F 2024-12-12 20:41:37.569 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 33\r\n2024-12-12T20:41:37.570890300-06:00 stderr F 2024-12-12 20:41:37.570 DEBUG (MainThread) [homeassistant.components.mqtt.client] Subscribing with mid: 24 to topics with qos: [('homeassistant/text/+/config', 0)]\r\n2024-12-12T20:41:37.571541811-06:00 stderr F 2024-12-12 20:41:37.570 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 33\r\n2024-12-12T20:41:37.572310058-06:00 stderr F 2024-12-12 20:41:37.571 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 33\r\n2024-12-12T20:41:37.573128253-06:00 stderr F 2024-12-12 20:41:37.572 DEBUG (MainThread) [homeassistant.components.mqtt.client] Subscribing with mid: 25 to topics with qos: [('homeassistant/update/+/config', 0)]\r\n2024-12-12T20:41:37.573400834-06:00 stderr F 2024-12-12 20:41:37.572 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 33\r\n2024-12-12T20:41:37.574714991-06:00 stderr F 2024-12-12 20:41:37.573 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 33\r\n2024-12-12T20:41:37.574991293-06:00 stderr F 2024-12-12 20:41:37.574 DEBUG (MainThread) [homeassistant.components.mqtt.client] Subscribing with mid: 26 to topics with qos: [('homeassistant/vacuum/+/config', 0)]\r\n2024-12-12T20:41:37.575602111-06:00 stderr F 2024-12-12 20:41:37.575 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 33\r\n2024-12-12T20:41:37.576771297-06:00 stderr F 2024-12-12 20:41:37.576 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 33\r\n2024-12-12T20:41:37.577063387-06:00 stderr F 2024-12-12 20:41:37.576 DEBUG (MainThread) [homeassistant.components.mqtt.client] Subscribing with mid: 27 to topics with qos: [('homeassistant/valve/+/config', 0)]\r\n2024-12-12T20:41:37.577632973-06:00 stderr F 2024-12-12 20:41:37.577 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 33\r\n2024-12-12T20:41:37.578617311-06:00 stderr F 2024-12-12 20:41:37.577 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 33\r\n2024-12-12T20:41:37.578896484-06:00 stderr F 2024-12-12 20:41:37.578 DEBUG (MainThread) [homeassistant.components.mqtt.client] Subscribing with mid: 28 to topics with qos: [('homeassistant/water_heater/+/config', 0)]\r\n2024-12-12T20:41:37.579470598-06:00 stderr F 2024-12-12 20:41:37.579 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 33\r\n2024-12-12T20:41:37.580266222-06:00 stderr F 2024-12-12 20:41:37.579 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 33\r\n2024-12-12T20:41:37.580900274-06:00 stderr F 2024-12-12 20:41:37.580 DEBUG (MainThread) [homeassistant.components.mqtt.client] Subscribing with mid: 29 to topics with qos: [('homeassistant/alarm_control_panel/+/+/config', 0)]\r\n2024-12-12T20:41:37.581535469-06:00 stderr F 2024-12-12 20:41:37.580 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 33\r\n2024-12-12T20:41:37.583227661-06:00 stderr F 2024-12-12 20:41:37.582 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 33\r\n2024-12-12T20:41:37.583428379-06:00 stderr F 2024-12-12 20:41:37.582 DEBUG (MainThread) [homeassistant.components.mqtt.client] Subscribing with mid: 30 to topics with qos: [('homeassistant/binary_sensor/+/+/config', 0)]\r\n2024-12-12T20:41:37.584057676-06:00 stderr F 2024-12-12 20:41:37.583 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 33\r\n2024-12-12T20:41:37.585101958-06:00 stderr F 2024-12-12 20:41:37.584 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 33\r\n2024-12-12T20:41:37.585365584-06:00 stderr F 2024-12-12 20:41:37.584 DEBUG (MainThread) [homeassistant.components.mqtt.client] Subscribing with mid: 31 to topics with qos: [('homeassistant/button/+/+/config', 0)]\r\n2024-12-12T20:41:37.585862101-06:00 stderr F 2024-12-12 20:41:37.585 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 33\r\n2024-12-12T20:41:37.586735304-06:00 stderr F 2024-12-12 20:41:37.586 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 33\r\n2024-12-12T20:41:37.587009009-06:00 stderr F 2024-12-12 20:41:37.586 DEBUG (MainThread) [homeassistant.components.mqtt.client] Subscribing with mid: 32 to topics with qos: [('homeassistant/camera/+/+/config', 0)]\r\n2024-12-12T20:41:37.587580974-06:00 stderr F 2024-12-12 20:41:37.587 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 33\r\n2024-12-12T20:41:37.588324163-06:00 stderr F 2024-12-12 20:41:37.587 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 33\r\n2024-12-12T20:41:37.588599642-06:00 stderr F 2024-12-12 20:41:37.587 DEBUG (MainThread) [homeassistant.components.mqtt.client] Subscribing with mid: 33 to topics with qos: [('homeassistant/climate/+/+/config', 0)]\r\n2024-12-12T20:41:37.589237112-06:00 stderr F 2024-12-12 20:41:37.588 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 33\r\n2024-12-12T20:41:37.590468345-06:00 stderr F 2024-12-12 20:41:37.589 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 33\r\n2024-12-12T20:41:37.590705431-06:00 stderr F 2024-12-12 20:41:37.589 DEBUG (MainThread) [homeassistant.components.mqtt.client] Subscribing with mid: 34 to topics with qos: [('homeassistant/cover/+/+/config', 0)]\r\n2024-12-12T20:41:37.591187294-06:00 stderr F 2024-12-12 20:41:37.590 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 33\r\n2024-12-12T20:41:37.592046945-06:00 stderr F 2024-12-12 20:41:37.591 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 33\r\n2024-12-12T20:41:37.592280404-06:00 stderr F 2024-12-12 20:41:37.591 DEBUG (MainThread) [homeassistant.components.mqtt.client] Subscribing with mid: 35 to topics with qos: [('homeassistant/device_automation/+/+/config', 0)]\r\n2024-12-12T20:41:37.592795817-06:00 stderr F 2024-12-12 20:41:37.592 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 33\r\n2024-12-12T20:41:37.593827057-06:00 stderr F 2024-12-12 20:41:37.593 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 33\r\n2024-12-12T20:41:37.594063197-06:00 stderr F 2024-12-12 20:41:37.593 DEBUG (MainThread) [homeassistant.components.mqtt.client] Subscribing with mid: 36 to topics with qos: [('homeassistant/device_tracker/+/+/config', 0)]\r\n2024-12-12T20:41:37.594614256-06:00 stderr F 2024-12-12 20:41:37.594 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 33\r\n2024-12-12T20:41:37.595433318-06:00 stderr F 2024-12-12 20:41:37.594 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 33\r\n2024-12-12T20:41:37.595767454-06:00 stderr F 2024-12-12 20:41:37.594 DEBUG (MainThread) [homeassistant.components.mqtt.client] Subscribing with mid: 37 to topics with qos: [('homeassistant/event/+/+/config', 0)]\r\n2024-12-12T20:41:37.596257057-06:00 stderr F 2024-12-12 20:41:37.595 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 33\r\n2024-12-12T20:41:37.596964648-06:00 stderr F 2024-12-12 20:41:37.596 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 33\r\n2024-12-12T20:41:37.597176603-06:00 stderr F 2024-12-12 20:41:37.596 DEBUG (MainThread) [homeassistant.components.mqtt.client] Subscribing with mid: 38 to topics with qos: [('homeassistant/fan/+/+/config', 0)]\r\n2024-12-12T20:41:37.597696855-06:00 stderr F 2024-12-12 20:41:37.597 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 33\r\n2024-12-12T20:41:37.598782217-06:00 stderr F 2024-12-12 20:41:37.598 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 33\r\n2024-12-12T20:41:37.599016349-06:00 stderr F 2024-12-12 20:41:37.598 DEBUG (MainThread) [homeassistant.components.mqtt.client] Subscribing with mid: 39 to topics with qos: [('homeassistant/humidifier/+/+/config', 0)]\r\n2024-12-12T20:41:37.600077089-06:00 stderr F 2024-12-12 20:41:37.599 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 33\r\n2024-12-12T20:41:37.600340081-06:00 stderr F 2024-12-12 20:41:37.599 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 33\r\n2024-12-12T20:41:37.600502358-06:00 stderr F 2024-12-12 20:41:37.599 DEBUG (MainThread) [homeassistant.components.mqtt.client] Subscribing with mid: 40 to topics with qos: [('homeassistant/image/+/+/config', 0)]\r\n2024-12-12T20:41:37.601062704-06:00 stderr F 2024-12-12 20:41:37.600 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 33\r\n2024-12-12T20:41:37.601954426-06:00 stderr F 2024-12-12 20:41:37.601 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 33\r\n2024-12-12T20:41:37.602226283-06:00 stderr F 2024-12-12 20:41:37.601 DEBUG (MainThread) [homeassistant.components.mqtt.client] Subscribing with mid: 41 to topics with qos: [('homeassistant/lawn_mower/+/+/config', 0)]\r\n2024-12-12T20:41:37.605922207-06:00 stderr F 2024-12-12 20:41:37.603 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 33\r\n2024-12-12T20:41:37.610106571-06:00 stderr F 2024-12-12 20:41:37.606 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 33\r\n2024-12-12T20:41:37.610106571-06:00 stderr F 2024-12-12 20:41:37.607 DEBUG (MainThread) [homeassistant.components.mqtt.client] Subscribing with mid: 42 to topics with qos: [('homeassistant/light/+/+/config', 0)]\r\n2024-12-12T20:41:37.610106571-06:00 stderr F 2024-12-12 20:41:37.607 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 33\r\n2024-12-12T20:41:37.610106571-06:00 stderr F 2024-12-12 20:41:37.608 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 33\r\n2024-12-12T20:41:37.610106571-06:00 stderr F 2024-12-12 20:41:37.608 DEBUG (MainThread) [homeassistant.components.mqtt.client] Subscribing with mid: 43 to topics with qos: [('homeassistant/lock/+/+/config', 0)]\r\n2024-12-12T20:41:37.610173237-06:00 stderr F 2024-12-12 20:41:37.609 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 33\r\n2024-12-12T20:41:37.611093756-06:00 stderr F 2024-12-12 20:41:37.610 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 33\r\n2024-12-12T20:41:37.611961870-06:00 stderr F 2024-12-12 20:41:37.611 DEBUG (MainThread) [homeassistant.components.mqtt.client] Subscribing with mid: 44 to topics with qos: [('homeassistant/notify/+/+/config', 0)]\r\n2024-12-12T20:41:37.612337996-06:00 stderr F 2024-12-12 20:41:37.611 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 33\r\n2024-12-12T20:41:37.613655968-06:00 stderr F 2024-12-12 20:41:37.612 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 33\r\n2024-12-12T20:41:37.614326679-06:00 stderr F 2024-12-12 20:41:37.613 DEBUG (MainThread) [homeassistant.components.mqtt.client] Subscribing with mid: 45 to topics with qos: [('homeassistant/number/+/+/config', 0)]\r\n2024-12-12T20:41:37.614642346-06:00 stderr F 2024-12-12 20:41:37.613 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 33\r\n2024-12-12T20:41:37.615618851-06:00 stderr F 2024-12-12 20:41:37.614 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 33\r\n2024-12-12T20:41:37.615896674-06:00 stderr F 2024-12-12 20:41:37.615 DEBUG (MainThread) [homeassistant.components.mqtt.client] Subscribing with mid: 46 to topics with qos: [('homeassistant/scene/+/+/config', 0)]\r\n2024-12-12T20:41:37.617268499-06:00 stderr F 2024-12-12 20:41:37.616 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 33\r\n2024-12-12T20:41:37.617495814-06:00 stderr F 2024-12-12 20:41:37.616 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 33\r\n2024-12-12T20:41:37.617813721-06:00 stderr F 2024-12-12 20:41:37.616 DEBUG (MainThread) [homeassistant.components.mqtt.client] Subscribing with mid: 47 to topics with qos: [('homeassistant/siren/+/+/config', 0)]\r\n2024-12-12T20:41:37.618448017-06:00 stderr F 2024-12-12 20:41:37.617 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 33\r\n2024-12-12T20:41:37.619316750-06:00 stderr F 2024-12-12 20:41:37.618 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 33\r\n2024-12-12T20:41:37.619718252-06:00 stderr F 2024-12-12 20:41:37.618 DEBUG (MainThread) [homeassistant.components.mqtt.client] Subscribing with mid: 48 to topics with qos: [('homeassistant/select/+/+/config', 0)]\r\n2024-12-12T20:41:37.620122968-06:00 stderr F 2024-12-12 20:41:37.619 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 33\r\n2024-12-12T20:41:37.620918506-06:00 stderr F 2024-12-12 20:41:37.620 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 33\r\n2024-12-12T20:41:37.621312490-06:00 stderr F 2024-12-12 20:41:37.620 DEBUG (MainThread) [homeassistant.components.mqtt.client] Subscribing with mid: 49 to topics with qos: [('homeassistant/sensor/+/+/config', 0)]\r\n2024-12-12T20:41:37.621873973-06:00 stderr F 2024-12-12 20:41:37.621 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 33\r\n2024-12-12T20:41:37.622805741-06:00 stderr F 2024-12-12 20:41:37.622 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 33\r\n2024-12-12T20:41:37.623034785-06:00 stderr F 2024-12-12 20:41:37.622 DEBUG (MainThread) [homeassistant.components.mqtt.client] Subscribing with mid: 50 to topics with qos: [('homeassistant/switch/+/+/config', 0)]\r\n2024-12-12T20:41:37.623532439-06:00 stderr F 2024-12-12 20:41:37.623 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 33\r\n2024-12-12T20:41:37.624109750-06:00 stderr F 2024-12-12 20:41:37.623 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 33\r\n2024-12-12T20:41:37.624539436-06:00 stderr F 2024-12-12 20:41:37.624 DEBUG (MainThread) [homeassistant.components.mqtt.client] Subscribing with mid: 51 to topics with qos: [('homeassistant/tag/+/+/config', 0)]\r\n2024-12-12T20:41:37.625046369-06:00 stderr F 2024-12-12 20:41:37.624 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 33\r\n2024-12-12T20:41:37.626219804-06:00 stderr F 2024-12-12 20:41:37.625 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 33\r\n2024-12-12T20:41:37.626656211-06:00 stderr F 2024-12-12 20:41:37.625 DEBUG (MainThread) [homeassistant.components.mqtt.client] Subscribing with mid: 52 to topics with qos: [('homeassistant/text/+/+/config', 0)]\r\n2024-12-12T20:41:37.627722360-06:00 stderr F 2024-12-12 20:41:37.626 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 33\r\n2024-12-12T20:41:37.627975327-06:00 stderr F 2024-12-12 20:41:37.627 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 33\r\n2024-12-12T20:41:37.628218626-06:00 stderr F 2024-12-12 20:41:37.627 DEBUG (MainThread) [homeassistant.components.mqtt.client] Subscribing with mid: 53 to topics with qos: [('homeassistant/update/+/+/config', 0)]\r\n2024-12-12T20:41:37.628765674-06:00 stderr F 2024-12-12 20:41:37.628 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 33\r\n2024-12-12T20:41:37.629988552-06:00 stderr F 2024-12-12 20:41:37.629 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 33\r\n2024-12-12T20:41:37.630286428-06:00 stderr F 2024-12-12 20:41:37.629 DEBUG (MainThread) [homeassistant.components.mqtt.client] Subscribing with mid: 54 to topics with qos: [('homeassistant/vacuum/+/+/config', 0)]\r\n2024-12-12T20:41:37.630823782-06:00 stderr F 2024-12-12 20:41:37.630 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 33\r\n2024-12-12T20:41:37.631628823-06:00 stderr F 2024-12-12 20:41:37.631 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 33\r\n2024-12-12T20:41:37.632015581-06:00 stderr F 2024-12-12 20:41:37.631 DEBUG (MainThread) [homeassistant.components.mqtt.client] Subscribing with mid: 55 to topics with qos: [('homeassistant/valve/+/+/config', 0)]\r\n2024-12-12T20:41:37.632559749-06:00 stderr F 2024-12-12 20:41:37.632 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 33\r\n2024-12-12T20:41:37.633190443-06:00 stderr F 2024-12-12 20:41:37.632 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 33\r\n2024-12-12T20:41:37.633746224-06:00 stderr F 2024-12-12 20:41:37.633 DEBUG (MainThread) [homeassistant.components.mqtt.client] Subscribing with mid: 56 to topics with qos: [('homeassistant/water_heater/+/+/config', 0)]\r\n2024-12-12T20:41:37.634339904-06:00 stderr F 2024-12-12 20:41:37.633 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 33\r\n2024-12-12T20:41:37.635381181-06:00 stderr F 2024-12-12 20:41:37.634 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 33\r\n2024-12-12T20:41:37.635616626-06:00 stderr F 2024-12-12 20:41:37.634 DEBUG (MainThread) [homeassistant.components.mqtt.client] Subscribing with mid: 57 to topics with qos: [('homeassistant/device/+/config', 0)]\r\n2024-12-12T20:41:37.636102460-06:00 stderr F 2024-12-12 20:41:37.635 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 33\r\n2024-12-12T20:41:37.636997441-06:00 stderr F 2024-12-12 20:41:37.636 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 33\r\n2024-12-12T20:41:37.637244704-06:00 stderr F 2024-12-12 20:41:37.636 DEBUG (MainThread) [homeassistant.components.mqtt.client] Subscribing with mid: 58 to topics with qos: [('homeassistant/device/+/+/config', 0)]\r\n2024-12-12T20:41:37.638284408-06:00 stderr F 2024-12-12 20:41:37.637 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 33\r\n2024-12-12T20:41:37.638974244-06:00 stderr F 2024-12-12 20:41:37.638 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 33\r\n2024-12-12T20:41:37.639518216-06:00 stderr F 2024-12-12 20:41:37.639 DEBUG (MainThread) [homeassistant.components.mqtt.client] Subscribing with mid: 59 to topics with qos: [('drop_connect/discovery/#', 0)]\r\n2024-12-12T20:41:37.640093338-06:00 stderr F 2024-12-12 20:41:37.639 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 33\r\n2024-12-12T20:41:37.640842670-06:00 stderr F 2024-12-12 20:41:37.640 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 33\r\n2024-12-12T20:41:37.641237668-06:00 stderr F 2024-12-12 20:41:37.640 DEBUG (MainThread) [homeassistant.components.mqtt.client] Subscribing with mid: 60 to topics with qos: [('dsmr/#', 0)]\r\n2024-12-12T20:41:37.641775439-06:00 stderr F 2024-12-12 20:41:37.641 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 33\r\n2024-12-12T20:41:37.642943662-06:00 stderr F 2024-12-12 20:41:37.642 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 33\r\n2024-12-12T20:41:37.643159801-06:00 stderr F 2024-12-12 20:41:37.642 DEBUG (MainThread) [homeassistant.components.mqtt.client] Subscribing with mid: 61 to topics with qos: [('esphome/discover/#', 0)]\r\n2024-12-12T20:41:37.643609208-06:00 stderr F 2024-12-12 20:41:37.643 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 33\r\n2024-12-12T20:41:37.644406417-06:00 stderr F 2024-12-12 20:41:37.643 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 33\r\n2024-12-12T20:41:37.644653300-06:00 stderr F 2024-12-12 20:41:37.644 DEBUG (MainThread) [homeassistant.components.mqtt.client] Subscribing with mid: 62 to topics with qos: [('fully/deviceInfo/+', 0)]\r\n2024-12-12T20:41:37.645215560-06:00 stderr F 2024-12-12 20:41:37.644 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 33\r\n2024-12-12T20:41:37.646724238-06:00 stderr F 2024-12-12 20:41:37.645 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 33\r\n2024-12-12T20:41:37.646976438-06:00 stderr F 2024-12-12 20:41:37.645 DEBUG (MainThread) [homeassistant.components.mqtt.client] Subscribing with mid: 63 to topics with qos: [('tasmota/discovery/#', 0)]\r\n2024-12-12T20:41:37.647523325-06:00 stderr F 2024-12-12 20:41:37.647 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 33\r\n2024-12-12T20:41:43.045746738-06:00 stderr F 2024-12-12 20:41:43.044 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 33\r\n2024-12-12T20:41:43.047892247-06:00 stderr F 2024-12-12 20:41:43.044 DEBUG (MainThread) [homeassistant.components.mqtt.client] Transmitting message on homeassistant/status: 'online', mid: 64, qos: 0\r\n2024-12-12T20:41:43.048191795-06:00 stderr F 2024-12-12 20:41:43.046 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 33\r\n2024-12-12T20:41:43.049005036-06:00 stderr F 2024-12-12 20:41:43.046 INFO (MainThread) [homeassistant.components.mqtt.client] MQTT client initialized, birth message sent\r\n2024-12-12T20:42:07.231247586-06:00 stderr F 2024-12-12 20:42:07.230 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 33\r\n2024-12-12T20:42:07.232576096-06:00 stderr F 2024-12-12 20:42:07.231 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 33\r\n2024-12-12T20:42:37.295438936-06:00 stderr F 2024-12-12 20:42:37.294 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 33\r\n2024-12-12T20:42:37.297241342-06:00 stderr F 2024-12-12 20:42:37.295 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 33\r\n2024-12-12T20:42:54.358887780-06:00 stderr F 2024-12-12 20:42:54.357 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: connection closed 33\r\n2024-12-12T20:42:54.359392611-06:00 stderr F 2024-12-12 20:42:54.359 DEBUG (MainThread) [homeassistant.components.mqtt.client] Disconnected from MQTT server mosquitto.mydomain.com:443 (7)\r\n2024-12-12T20:44:01.895801964-06:00 stderr F 2024-12-12 20:44:01.893 DEBUG (MainThread) [homeassistant.components.mqtt.client] Transmitting message on homeassistant/switch/1/power: 'OFF', mid: 65, qos: 0\r\n2024-12-12T20:44:01.902817117-06:00 stderr F 2024-12-12 20:44:01.893 ERROR (MainThread) [homeassistant.components.websocket_api.http.connection] [140635271788096] Unexpected exception\r\n2024-12-12T20:44:01.902817117-06:00 stderr F Traceback (most recent call last):\r\n2024-12-12T20:44:01.902817117-06:00 stderr F   File \"/usr/src/homeassistant/homeassistant/components/websocket_api/commands.py\", line 245, in handle_call_service\r\n2024-12-12T20:44:01.902817117-06:00 stderr F     response = await hass.services.async_call(\r\n2024-12-12T20:44:01.902817117-06:00 stderr F                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n2024-12-12T20:44:01.902817117-06:00 stderr F     ...<7 lines>...\r\n2024-12-12T20:44:01.902817117-06:00 stderr F     )\r\n2024-12-12T20:44:01.902817117-06:00 stderr F     ^\r\n2024-12-12T20:44:01.902817117-06:00 stderr F   File \"/usr/src/homeassistant/homeassistant/core.py\", line 2802, in async_call\r\n2024-12-12T20:44:01.902817117-06:00 stderr F     response_data = await coro\r\n2024-12-12T20:44:01.902817117-06:00 stderr F                     ^^^^^^^^^^\r\n2024-12-12T20:44:01.902817117-06:00 stderr F   File \"/usr/src/homeassistant/homeassistant/core.py\", line 2845, in _execute_service\r\n2024-12-12T20:44:01.902817117-06:00 stderr F     return await target(service_call)\r\n2024-12-12T20:44:01.902817117-06:00 stderr F            ^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n2024-12-12T20:44:01.902817117-06:00 stderr F   File \"/usr/src/homeassistant/homeassistant/components/mqtt/__init__.py\", line 316, in async_publish_service\r\n2024-12-12T20:44:01.902817117-06:00 stderr F     await mqtt_data.client.async_publish(msg_topic, payload, qos, retain)\r\n2024-12-12T20:44:01.902817117-06:00 stderr F   File \"/usr/src/homeassistant/homeassistant/components/mqtt/client.py\", line 646, in async_publish\r\n2024-12-12T20:44:01.902817117-06:00 stderr F     await self._async_wait_for_mid_or_raise(msg_info.mid, msg_info.rc)\r\n2024-12-12T20:44:01.902817117-06:00 stderr F   File \"/usr/src/homeassistant/homeassistant/components/mqtt/client.py\", line 1215, in _async_wait_for_mid_or_raise\r\n2024-12-12T20:44:01.902817117-06:00 stderr F     raise HomeAssistantError(\r\n2024-12-12T20:44:01.902817117-06:00 stderr F         f\"Error talking to MQTT: {mqtt.error_string(result_code)}\"\r\n2024-12-12T20:44:01.902817117-06:00 stderr F     )\r\n2024-12-12T20:44:01.902817117-06:00 stderr F homeassistant.exceptions.HomeAssistantError: Error talking to MQTT: The client is not currently connected.\r\n```\r\n\r\n</details>\nRight. It might be some custom integrations do block the event loop. The connection to the MQTT broker can be easiliy disturbed.\r\nIf you see messages in the logs, notifying the event loop is blocked, please notify the maintainers, or in case of a Home Assistant core integration blocking the event loop, open an issue to report this.\r\n\r\nI could not reproduce the issues you were seeing. I also restarted the broker while connected over WebSockets, but the connection recovered normally.\nIt is likely you have other issues that avoid a reconnection to take place.\nI\u2019ve tested restarting non gracefully killing the broker scenarios and it all recovered before.  We are going to need either an `strace` or some manual code mods to instrument the reconnect code to add more debug logging\nYou might get another hint as to what is going on by enabling asyncio debug.\n\nhttps://community.home-assistant.io/t/2024-5-tracking-down-instability-issues-caused-by-integrations/724441/1\nSince my whole setup is just a bunch of Docker containers, I decided to create a new instance of Home Assistance and do nothing with it but add the MQTT integration to test with.\r\n\r\nWhen I execute my same steps against a simple Docker container that has no persistence, no volumes / mounts, the default untouched configuration, default integrations only - but with MQTT added, I get the same results. The main difference with my test container is that I'm running it in bridge mode vs host since I don't need mdns discovery for any of this.\r\n\r\nStarting from a fresh, default Home Assistant Docker container:\r\n1. Swap my account to advanced mode to setup web socket mode in MQTT.\r\n2. Add the MQTT integration (the same config as posted above).\r\n3. Send a test message to a test topic via the config UI - success!\r\n4. Restart my Mosquitto broker service - connection is immediately lost from HA.\r\n5. Wait for for the broker to start back up. Watch other clients reconnect. HA does not.\r\n6. Attempt to send a test message to a test topic again - fails with \"Error talking to MQTT: The client is not currently connected\" error.\r\n\r\nIf I exec into the container and turn on debug logging for MQTT in the configuration.yaml, and then restart HA from the UI, the HA MQTT client connects and I see all of the usual debug logs of a healthy connection. Running my test again gets the same results, but now with the debug log output.\r\n\r\nI don't see anything different in the logs from what I last posted:\r\n<details>\r\n<summary>MQTT Debug Logs</summary>\r\n\r\n```\r\n2024-12-13T20:58:59.200150971-06:00 stderr F 2024-12-13 20:58:59.184 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: connection opened 22\r\n2024-12-13T20:58:59.203032280-06:00 stderr F 2024-12-13 20:58:59.185 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: Starting client misc loop\r\n2024-12-13T20:58:59.203899924-06:00 stderr F 2024-12-13 20:58:59.185 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 22\r\n2024-12-13T20:58:59.204115780-06:00 stderr F 2024-12-13 20:58:59.203 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 22\r\n2024-12-13T20:58:59.208098530-06:00 stderr F 2024-12-13 20:58:59.206 DEBUG (MainThread) [homeassistant.components.mqtt.client] Connected to MQTT server mosquitto.mydomain.com:443 (0)\r\n2024-12-13T20:58:59.711127145-06:00 stderr F 2024-12-13 20:58:59.709 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 22\r\n2024-12-13T20:58:59.711437186-06:00 stderr F 2024-12-13 20:58:59.710 DEBUG (MainThread) [homeassistant.components.mqtt.client] Subscribing with mid: 1 to topics with qos: [('homeassistant/alarm_control_panel/+/config', 0)]\r\n2024-12-13T20:58:59.712288694-06:00 stderr F 2024-12-13 20:58:59.711 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 22\r\n2024-12-13T20:58:59.714700681-06:00 stderr F 2024-12-13 20:58:59.713 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 22\r\n2024-12-13T20:58:59.714896281-06:00 stderr F 2024-12-13 20:58:59.713 DEBUG (MainThread) [homeassistant.components.mqtt.client] Subscribing with mid: 2 to topics with qos: [('homeassistant/binary_sensor/+/config', 0)]\r\n2024-12-13T20:58:59.715137281-06:00 stderr F 2024-12-13 20:58:59.713 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 22\r\n2024-12-13T20:58:59.716015646-06:00 stderr F 2024-12-13 20:58:59.715 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 22\r\n2024-12-13T20:58:59.716423828-06:00 stderr F 2024-12-13 20:58:59.716 DEBUG (MainThread) [homeassistant.components.mqtt.client] Subscribing with mid: 3 to topics with qos: [('homeassistant/button/+/config', 0)]\r\n2024-12-13T20:58:59.718003599-06:00 stderr F 2024-12-13 20:58:59.717 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 22\r\n2024-12-13T20:58:59.721468150-06:00 stderr F 2024-12-13 20:58:59.721 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 22\r\n2024-12-13T20:58:59.721966963-06:00 stderr F 2024-12-13 20:58:59.721 DEBUG (MainThread) [homeassistant.components.mqtt.client] Subscribing with mid: 4 to topics with qos: [('homeassistant/camera/+/config', 0)]\r\n2024-12-13T20:58:59.728226256-06:00 stderr F 2024-12-13 20:58:59.727 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 22\r\n2024-12-13T20:58:59.734744997-06:00 stderr F 2024-12-13 20:58:59.733 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 22\r\n2024-12-13T20:58:59.734999529-06:00 stderr F 2024-12-13 20:58:59.733 DEBUG (MainThread) [homeassistant.components.mqtt.client] Subscribing with mid: 5 to topics with qos: [('homeassistant/climate/+/config', 0)]\r\n2024-12-13T20:58:59.740782036-06:00 stderr F 2024-12-13 20:58:59.740 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 22\r\n2024-12-13T20:58:59.743159606-06:00 stderr F 2024-12-13 20:58:59.742 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 22\r\n2024-12-13T20:58:59.743392011-06:00 stderr F 2024-12-13 20:58:59.742 DEBUG (MainThread) [homeassistant.components.mqtt.client] Subscribing with mid: 6 to topics with qos: [('homeassistant/cover/+/config', 0)]\r\n2024-12-13T20:58:59.744134645-06:00 stderr F 2024-12-13 20:58:59.743 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 22\r\n2024-12-13T20:58:59.755919374-06:00 stderr F 2024-12-13 20:58:59.755 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 22\r\n2024-12-13T20:58:59.761741992-06:00 stderr F 2024-12-13 20:58:59.755 DEBUG (MainThread) [homeassistant.components.mqtt.client] Subscribing with mid: 7 to topics with qos: [('homeassistant/device_automation/+/config', 0)]\r\n2024-12-13T20:58:59.766660905-06:00 stderr F 2024-12-13 20:58:59.760 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 22\r\n2024-12-13T20:58:59.766941121-06:00 stderr F 2024-12-13 20:58:59.765 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 22\r\n2024-12-13T20:58:59.767222080-06:00 stderr F 2024-12-13 20:58:59.765 DEBUG (MainThread) [homeassistant.components.mqtt.client] Subscribing with mid: 8 to topics with qos: [('homeassistant/device_tracker/+/config', 0)]\r\n2024-12-13T20:58:59.767568759-06:00 stderr F 2024-12-13 20:58:59.766 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 22\r\n2024-12-13T20:58:59.768849209-06:00 stderr F 2024-12-13 20:58:59.768 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 22\r\n2024-12-13T20:58:59.770587516-06:00 stderr F 2024-12-13 20:58:59.768 DEBUG (MainThread) [homeassistant.components.mqtt.client] Subscribing with mid: 9 to topics with qos: [('homeassistant/event/+/config', 0)]\r\n2024-12-13T20:58:59.770843895-06:00 stderr F 2024-12-13 20:58:59.769 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 22\r\n2024-12-13T20:58:59.772213656-06:00 stderr F 2024-12-13 20:58:59.771 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 22\r\n2024-12-13T20:58:59.772455888-06:00 stderr F 2024-12-13 20:58:59.771 DEBUG (MainThread) [homeassistant.components.mqtt.client] Subscribing with mid: 10 to topics with qos: [('homeassistant/fan/+/config', 0)]\r\n2024-12-13T20:58:59.774400589-06:00 stderr F 2024-12-13 20:58:59.773 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 22\r\n2024-12-13T20:58:59.783111872-06:00 stderr F 2024-12-13 20:58:59.778 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 22\r\n2024-12-13T20:58:59.783419887-06:00 stderr F 2024-12-13 20:58:59.778 DEBUG (MainThread) [homeassistant.components.mqtt.client] Subscribing with mid: 11 to topics with qos: [('homeassistant/humidifier/+/config', 0)]\r\n2024-12-13T20:58:59.783694671-06:00 stderr F 2024-12-13 20:58:59.779 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 22\r\n2024-12-13T20:58:59.783888763-06:00 stderr F 2024-12-13 20:58:59.782 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 22\r\n2024-12-13T20:58:59.784124352-06:00 stderr F 2024-12-13 20:58:59.782 DEBUG (MainThread) [homeassistant.components.mqtt.client] Subscribing with mid: 12 to topics with qos: [('homeassistant/image/+/config', 0)]\r\n2024-12-13T20:58:59.784877421-06:00 stderr F 2024-12-13 20:58:59.784 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 22\r\n2024-12-13T20:58:59.787347227-06:00 stderr F 2024-12-13 20:58:59.786 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 22\r\n2024-12-13T20:58:59.787582941-06:00 stderr F 2024-12-13 20:58:59.786 DEBUG (MainThread) [homeassistant.components.mqtt.client] Subscribing with mid: 13 to topics with qos: [('homeassistant/lawn_mower/+/config', 0)]\r\n2024-12-13T20:58:59.788763901-06:00 stderr F 2024-12-13 20:58:59.787 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 22\r\n2024-12-13T20:58:59.798953841-06:00 stderr F 2024-12-13 20:58:59.789 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 22\r\n2024-12-13T20:58:59.799307245-06:00 stderr F 2024-12-13 20:58:59.790 DEBUG (MainThread) [homeassistant.components.mqtt.client] Subscribing with mid: 14 to topics with qos: [('homeassistant/light/+/config', 0)]\r\n2024-12-13T20:58:59.799609045-06:00 stderr F 2024-12-13 20:58:59.796 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 22\r\n2024-12-13T20:58:59.807687188-06:00 stderr F 2024-12-13 20:58:59.801 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 22\r\n2024-12-13T20:58:59.807977296-06:00 stderr F 2024-12-13 20:58:59.801 DEBUG (MainThread) [homeassistant.components.mqtt.client] Subscribing with mid: 15 to topics with qos: [('homeassistant/lock/+/config', 0)]\r\n2024-12-13T20:58:59.816432209-06:00 stderr F 2024-12-13 20:58:59.815 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 22\r\n2024-12-13T20:58:59.816733601-06:00 stderr F 2024-12-13 20:58:59.815 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 22\r\n2024-12-13T20:58:59.830278492-06:00 stderr F 2024-12-13 20:58:59.815 DEBUG (MainThread) [homeassistant.components.mqtt.client] Subscribing with mid: 16 to topics with qos: [('homeassistant/notify/+/config', 0)]\r\n2024-12-13T20:58:59.830539902-06:00 stderr F 2024-12-13 20:58:59.822 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 22\r\n2024-12-13T20:58:59.846849466-06:00 stderr F 2024-12-13 20:58:59.836 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 22\r\n2024-12-13T20:58:59.847087177-06:00 stderr F 2024-12-13 20:58:59.836 DEBUG (MainThread) [homeassistant.components.mqtt.client] Subscribing with mid: 17 to topics with qos: [('homeassistant/number/+/config', 0)]\r\n2024-12-13T20:58:59.851715325-06:00 stderr F 2024-12-13 20:58:59.850 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 22\r\n2024-12-13T20:58:59.853269491-06:00 stderr F 2024-12-13 20:58:59.852 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 22\r\n2024-12-13T20:58:59.854355723-06:00 stderr F 2024-12-13 20:58:59.852 DEBUG (MainThread) [homeassistant.components.mqtt.client] Subscribing with mid: 18 to topics with qos: [('homeassistant/scene/+/config', 0)]\r\n2024-12-13T20:58:59.855696990-06:00 stderr F 2024-12-13 20:58:59.853 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 22\r\n2024-12-13T20:58:59.856873237-06:00 stderr F 2024-12-13 20:58:59.856 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 22\r\n2024-12-13T20:58:59.857048669-06:00 stderr F 2024-12-13 20:58:59.856 DEBUG (MainThread) [homeassistant.components.mqtt.client] Subscribing with mid: 19 to topics with qos: [('homeassistant/siren/+/config', 0)]\r\n2024-12-13T20:58:59.857545061-06:00 stderr F 2024-12-13 20:58:59.857 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 22\r\n2024-12-13T20:58:59.860217166-06:00 stderr F 2024-12-13 20:58:59.859 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 22\r\n2024-12-13T20:58:59.860407816-06:00 stderr F 2024-12-13 20:58:59.859 DEBUG (MainThread) [homeassistant.components.mqtt.client] Subscribing with mid: 20 to topics with qos: [('homeassistant/select/+/config', 0)]\r\n2024-12-13T20:58:59.860630658-06:00 stderr F 2024-12-13 20:58:59.859 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 22\r\n2024-12-13T20:58:59.863789422-06:00 stderr F 2024-12-13 20:58:59.862 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 22\r\n2024-12-13T20:58:59.872036201-06:00 stderr F 2024-12-13 20:58:59.862 DEBUG (MainThread) [homeassistant.components.mqtt.client] Subscribing with mid: 21 to topics with qos: [('homeassistant/sensor/+/config', 0)]\r\n2024-12-13T20:58:59.872335930-06:00 stderr F 2024-12-13 20:58:59.863 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 22\r\n2024-12-13T20:58:59.873162052-06:00 stderr F 2024-12-13 20:58:59.872 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 22\r\n2024-12-13T20:58:59.873454190-06:00 stderr F 2024-12-13 20:58:59.872 DEBUG (MainThread) [homeassistant.components.mqtt.client] Subscribing with mid: 22 to topics with qos: [('homeassistant/switch/+/config', 0)]\r\n2024-12-13T20:58:59.881010324-06:00 stderr F 2024-12-13 20:58:59.880 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 22\r\n2024-12-13T20:58:59.895503958-06:00 stderr F 2024-12-13 20:58:59.893 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 22\r\n2024-12-13T20:58:59.896951670-06:00 stderr F 2024-12-13 20:58:59.893 DEBUG (MainThread) [homeassistant.components.mqtt.client] Subscribing with mid: 23 to topics with qos: [('homeassistant/tag/+/config', 0)]\r\n2024-12-13T20:58:59.897295519-06:00 stderr F 2024-12-13 20:58:59.894 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 22\r\n2024-12-13T20:58:59.903831154-06:00 stderr F 2024-12-13 20:58:59.903 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 22\r\n2024-12-13T20:58:59.904078795-06:00 stderr F 2024-12-13 20:58:59.903 DEBUG (MainThread) [homeassistant.components.mqtt.client] Subscribing with mid: 24 to topics with qos: [('homeassistant/text/+/config', 0)]\r\n2024-12-13T20:58:59.910352364-06:00 stderr F 2024-12-13 20:58:59.904 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 22\r\n2024-12-13T20:58:59.913458907-06:00 stderr F 2024-12-13 20:58:59.912 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 22\r\n2024-12-13T20:58:59.914262643-06:00 stderr F 2024-12-13 20:58:59.913 DEBUG (MainThread) [homeassistant.components.mqtt.client] Subscribing with mid: 25 to topics with qos: [('homeassistant/update/+/config', 0)]\r\n2024-12-13T20:58:59.920567341-06:00 stderr F 2024-12-13 20:58:59.914 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 22\r\n2024-12-13T20:58:59.938989672-06:00 stderr F 2024-12-13 20:58:59.934 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 22\r\n2024-12-13T20:58:59.939226136-06:00 stderr F 2024-12-13 20:58:59.934 DEBUG (MainThread) [homeassistant.components.mqtt.client] Subscribing with mid: 26 to topics with qos: [('homeassistant/vacuum/+/config', 0)]\r\n2024-12-13T20:58:59.939880895-06:00 stderr F 2024-12-13 20:58:59.939 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 22\r\n2024-12-13T20:58:59.941063588-06:00 stderr F 2024-12-13 20:58:59.940 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 22\r\n2024-12-13T20:58:59.941694007-06:00 stderr F 2024-12-13 20:58:59.941 DEBUG (MainThread) [homeassistant.components.mqtt.client] Subscribing with mid: 27 to topics with qos: [('homeassistant/valve/+/config', 0)]\r\n2024-12-13T20:58:59.942143678-06:00 stderr F 2024-12-13 20:58:59.941 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 22\r\n2024-12-13T20:58:59.944264100-06:00 stderr F 2024-12-13 20:58:59.943 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 22\r\n2024-12-13T20:58:59.945041855-06:00 stderr F 2024-12-13 20:58:59.944 DEBUG (MainThread) [homeassistant.components.mqtt.client] Subscribing with mid: 28 to topics with qos: [('homeassistant/water_heater/+/config', 0)]\r\n2024-12-13T20:58:59.948512778-06:00 stderr F 2024-12-13 20:58:59.948 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 22\r\n2024-12-13T20:58:59.952783429-06:00 stderr F 2024-12-13 20:58:59.952 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 22\r\n2024-12-13T20:58:59.953322810-06:00 stderr F 2024-12-13 20:58:59.952 DEBUG (MainThread) [homeassistant.components.mqtt.client] Subscribing with mid: 29 to topics with qos: [('homeassistant/alarm_control_panel/+/+/config', 0)]\r\n2024-12-13T20:58:59.959166307-06:00 stderr F 2024-12-13 20:58:59.953 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 22\r\n2024-12-13T20:58:59.968038100-06:00 stderr F 2024-12-13 20:58:59.967 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 22\r\n2024-12-13T20:58:59.968267702-06:00 stderr F 2024-12-13 20:58:59.967 DEBUG (MainThread) [homeassistant.components.mqtt.client] Subscribing with mid: 30 to topics with qos: [('homeassistant/binary_sensor/+/+/config', 0)]\r\n2024-12-13T20:58:59.968892197-06:00 stderr F 2024-12-13 20:58:59.968 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 22\r\n2024-12-13T20:58:59.973087606-06:00 stderr F 2024-12-13 20:58:59.972 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 22\r\n2024-12-13T20:58:59.973725481-06:00 stderr F 2024-12-13 20:58:59.973 DEBUG (MainThread) [homeassistant.components.mqtt.client] Subscribing with mid: 31 to topics with qos: [('homeassistant/button/+/+/config', 0)]\r\n2024-12-13T20:58:59.974260229-06:00 stderr F 2024-12-13 20:58:59.973 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 22\r\n2024-12-13T20:58:59.977205501-06:00 stderr F 2024-12-13 20:58:59.976 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 22\r\n2024-12-13T20:58:59.977604815-06:00 stderr F 2024-12-13 20:58:59.977 DEBUG (MainThread) [homeassistant.components.mqtt.client] Subscribing with mid: 32 to topics with qos: [('homeassistant/camera/+/+/config', 0)]\r\n2024-12-13T20:59:00.005067443-06:00 stderr F 2024-12-13 20:59:00.004 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 22\r\n2024-12-13T20:59:00.007743154-06:00 stderr F 2024-12-13 20:59:00.006 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 22\r\n2024-12-13T20:59:00.007955473-06:00 stderr F 2024-12-13 20:59:00.007 DEBUG (MainThread) [homeassistant.components.mqtt.client] Subscribing with mid: 33 to topics with qos: [('homeassistant/climate/+/+/config', 0)]\r\n2024-12-13T20:59:00.012578466-06:00 stderr F 2024-12-13 20:59:00.012 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 22\r\n2024-12-13T20:59:00.040430233-06:00 stderr F 2024-12-13 20:59:00.026 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 22\r\n2024-12-13T20:59:00.040729569-06:00 stderr F 2024-12-13 20:59:00.026 DEBUG (MainThread) [homeassistant.components.mqtt.client] Subscribing with mid: 34 to topics with qos: [('homeassistant/cover/+/+/config', 0)]\r\n2024-12-13T20:59:00.047012523-06:00 stderr F 2024-12-13 20:59:00.046 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 22\r\n2024-12-13T20:59:00.079044046-06:00 stderr F 2024-12-13 20:59:00.072 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 22\r\n2024-12-13T20:59:00.079267939-06:00 stderr F 2024-12-13 20:59:00.072 DEBUG (MainThread) [homeassistant.components.mqtt.client] Subscribing with mid: 35 to topics with qos: [('homeassistant/device_automation/+/+/config', 0)]\r\n2024-12-13T20:59:00.082471722-06:00 stderr F 2024-12-13 20:59:00.079 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 22\r\n2024-12-13T20:59:00.085562055-06:00 stderr F 2024-12-13 20:59:00.082 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 22\r\n2024-12-13T20:59:00.085809401-06:00 stderr F 2024-12-13 20:59:00.083 DEBUG (MainThread) [homeassistant.components.mqtt.client] Subscribing with mid: 36 to topics with qos: [('homeassistant/device_tracker/+/+/config', 0)]\r\n2024-12-13T20:59:00.086324626-06:00 stderr F 2024-12-13 20:59:00.085 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 22\r\n2024-12-13T20:59:00.089177609-06:00 stderr F 2024-12-13 20:59:00.088 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 22\r\n2024-12-13T20:59:00.089508594-06:00 stderr F 2024-12-13 20:59:00.088 DEBUG (MainThread) [homeassistant.components.mqtt.client] Subscribing with mid: 37 to topics with qos: [('homeassistant/event/+/+/config', 0)]\r\n2024-12-13T20:59:00.090934426-06:00 stderr F 2024-12-13 20:59:00.090 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 22\r\n2024-12-13T20:59:00.093687848-06:00 stderr F 2024-12-13 20:59:00.093 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 22\r\n2024-12-13T20:59:00.093949309-06:00 stderr F 2024-12-13 20:59:00.093 DEBUG (MainThread) [homeassistant.components.mqtt.client] Subscribing with mid: 38 to topics with qos: [('homeassistant/fan/+/+/config', 0)]\r\n2024-12-13T20:59:00.094509439-06:00 stderr F 2024-12-13 20:59:00.094 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 22\r\n2024-12-13T20:59:00.096690449-06:00 stderr F 2024-12-13 20:59:00.096 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 22\r\n2024-12-13T20:59:00.096936835-06:00 stderr F 2024-12-13 20:59:00.096 DEBUG (MainThread) [homeassistant.components.mqtt.client] Subscribing with mid: 39 to topics with qos: [('homeassistant/humidifier/+/+/config', 0)]\r\n2024-12-13T20:59:00.097707602-06:00 stderr F 2024-12-13 20:59:00.097 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 22\r\n2024-12-13T20:59:00.099443966-06:00 stderr F 2024-12-13 20:59:00.098 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 22\r\n2024-12-13T20:59:00.100673870-06:00 stderr F 2024-12-13 20:59:00.098 DEBUG (MainThread) [homeassistant.components.mqtt.client] Subscribing with mid: 40 to topics with qos: [('homeassistant/image/+/+/config', 0)]\r\n2024-12-13T20:59:00.100950510-06:00 stderr F 2024-12-13 20:59:00.099 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 22\r\n2024-12-13T20:59:00.103142084-06:00 stderr F 2024-12-13 20:59:00.101 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 22\r\n2024-12-13T20:59:00.103709876-06:00 stderr F 2024-12-13 20:59:00.101 DEBUG (MainThread) [homeassistant.components.mqtt.client] Subscribing with mid: 41 to topics with qos: [('homeassistant/lawn_mower/+/+/config', 0)]\r\n2024-12-13T20:59:00.103980166-06:00 stderr F 2024-12-13 20:59:00.102 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 22\r\n2024-12-13T20:59:00.109024712-06:00 stderr F 2024-12-13 20:59:00.104 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 22\r\n2024-12-13T20:59:00.109024712-06:00 stderr F 2024-12-13 20:59:00.104 DEBUG (MainThread) [homeassistant.components.mqtt.client] Subscribing with mid: 42 to topics with qos: [('homeassistant/light/+/+/config', 0)]\r\n2024-12-13T20:59:00.109024712-06:00 stderr F 2024-12-13 20:59:00.105 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 22\r\n2024-12-13T20:59:00.109587248-06:00 stderr F 2024-12-13 20:59:00.108 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 22\r\n2024-12-13T20:59:00.109838087-06:00 stderr F 2024-12-13 20:59:00.108 DEBUG (MainThread) [homeassistant.components.mqtt.client] Subscribing with mid: 43 to topics with qos: [('homeassistant/lock/+/+/config', 0)]\r\n2024-12-13T20:59:00.110098462-06:00 stderr F 2024-12-13 20:59:00.109 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 22\r\n2024-12-13T20:59:00.111962271-06:00 stderr F 2024-12-13 20:59:00.111 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 22\r\n2024-12-13T20:59:00.112273819-06:00 stderr F 2024-12-13 20:59:00.111 DEBUG (MainThread) [homeassistant.components.mqtt.client] Subscribing with mid: 44 to topics with qos: [('homeassistant/notify/+/+/config', 0)]\r\n2024-12-13T20:59:00.113036801-06:00 stderr F 2024-12-13 20:59:00.112 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 22\r\n2024-12-13T20:59:00.126770773-06:00 stderr F 2024-12-13 20:59:00.125 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 22\r\n2024-12-13T20:59:00.127031946-06:00 stderr F 2024-12-13 20:59:00.126 DEBUG (MainThread) [homeassistant.components.mqtt.client] Subscribing with mid: 45 to topics with qos: [('homeassistant/number/+/+/config', 0)]\r\n2024-12-13T20:59:00.127874771-06:00 stderr F 2024-12-13 20:59:00.127 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 22\r\n2024-12-13T20:59:00.130656913-06:00 stderr F 2024-12-13 20:59:00.129 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 22\r\n2024-12-13T20:59:00.130922721-06:00 stderr F 2024-12-13 20:59:00.130 DEBUG (MainThread) [homeassistant.components.mqtt.client] Subscribing with mid: 46 to topics with qos: [('homeassistant/scene/+/+/config', 0)]\r\n2024-12-13T20:59:00.131567575-06:00 stderr F 2024-12-13 20:59:00.131 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 22\r\n2024-12-13T20:59:00.135162404-06:00 stderr F 2024-12-13 20:59:00.134 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 22\r\n2024-12-13T20:59:00.136378826-06:00 stderr F 2024-12-13 20:59:00.135 DEBUG (MainThread) [homeassistant.components.mqtt.client] Subscribing with mid: 47 to topics with qos: [('homeassistant/siren/+/+/config', 0)]\r\n2024-12-13T20:59:00.136991416-06:00 stderr F 2024-12-13 20:59:00.136 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 22\r\n2024-12-13T20:59:00.139499876-06:00 stderr F 2024-12-13 20:59:00.138 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 22\r\n2024-12-13T20:59:00.139775042-06:00 stderr F 2024-12-13 20:59:00.138 DEBUG (MainThread) [homeassistant.components.mqtt.client] Subscribing with mid: 48 to topics with qos: [('homeassistant/select/+/+/config', 0)]\r\n2024-12-13T20:59:00.143630402-06:00 stderr F 2024-12-13 20:59:00.141 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 22\r\n2024-12-13T20:59:00.143914827-06:00 stderr F 2024-12-13 20:59:00.142 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 22\r\n2024-12-13T20:59:00.144366407-06:00 stderr F 2024-12-13 20:59:00.142 DEBUG (MainThread) [homeassistant.components.mqtt.client] Subscribing with mid: 49 to topics with qos: [('homeassistant/sensor/+/+/config', 0)]\r\n2024-12-13T20:59:00.144420729-06:00 stderr F 2024-12-13 20:59:00.142 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 22\r\n2024-12-13T20:59:00.146333782-06:00 stderr F 2024-12-13 20:59:00.145 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 22\r\n2024-12-13T20:59:00.147306140-06:00 stderr F 2024-12-13 20:59:00.145 DEBUG (MainThread) [homeassistant.components.mqtt.client] Subscribing with mid: 50 to topics with qos: [('homeassistant/switch/+/+/config', 0)]\r\n2024-12-13T20:59:00.147620987-06:00 stderr F 2024-12-13 20:59:00.146 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 22\r\n2024-12-13T20:59:00.150065989-06:00 stderr F 2024-12-13 20:59:00.149 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 22\r\n2024-12-13T20:59:00.150594661-06:00 stderr F 2024-12-13 20:59:00.149 DEBUG (MainThread) [homeassistant.components.mqtt.client] Subscribing with mid: 51 to topics with qos: [('homeassistant/tag/+/+/config', 0)]\r\n2024-12-13T20:59:00.151332312-06:00 stderr F 2024-12-13 20:59:00.150 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 22\r\n2024-12-13T20:59:00.158886493-06:00 stderr F 2024-12-13 20:59:00.156 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 22\r\n2024-12-13T20:59:00.159213257-06:00 stderr F 2024-12-13 20:59:00.156 DEBUG (MainThread) [homeassistant.components.mqtt.client] Subscribing with mid: 52 to topics with qos: [('homeassistant/text/+/+/config', 0)]\r\n2024-12-13T20:59:00.160820370-06:00 stderr F 2024-12-13 20:59:00.159 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 22\r\n2024-12-13T20:59:00.163215221-06:00 stderr F 2024-12-13 20:59:00.162 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 22\r\n2024-12-13T20:59:00.163541492-06:00 stderr F 2024-12-13 20:59:00.162 DEBUG (MainThread) [homeassistant.components.mqtt.client] Subscribing with mid: 53 to topics with qos: [('homeassistant/update/+/+/config', 0)]\r\n2024-12-13T20:59:00.164536070-06:00 stderr F 2024-12-13 20:59:00.163 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 22\r\n2024-12-13T20:59:00.166599904-06:00 stderr F 2024-12-13 20:59:00.165 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 22\r\n2024-12-13T20:59:00.167742690-06:00 stderr F 2024-12-13 20:59:00.165 DEBUG (MainThread) [homeassistant.components.mqtt.client] Subscribing with mid: 54 to topics with qos: [('homeassistant/vacuum/+/+/config', 0)]\r\n2024-12-13T20:59:00.168785735-06:00 stderr F 2024-12-13 20:59:00.168 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 22\r\n2024-12-13T20:59:00.170519702-06:00 stderr F 2024-12-13 20:59:00.169 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 22\r\n2024-12-13T20:59:00.170822087-06:00 stderr F 2024-12-13 20:59:00.169 DEBUG (MainThread) [homeassistant.components.mqtt.client] Subscribing with mid: 55 to topics with qos: [('homeassistant/valve/+/+/config', 0)]\r\n2024-12-13T20:59:00.171244915-06:00 stderr F 2024-12-13 20:59:00.170 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 22\r\n2024-12-13T20:59:00.175154507-06:00 stderr F 2024-12-13 20:59:00.174 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 22\r\n2024-12-13T20:59:00.175433046-06:00 stderr F 2024-12-13 20:59:00.174 DEBUG (MainThread) [homeassistant.components.mqtt.client] Subscribing with mid: 56 to topics with qos: [('homeassistant/water_heater/+/+/config', 0)]\r\n2024-12-13T20:59:00.175879426-06:00 stderr F 2024-12-13 20:59:00.175 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 22\r\n2024-12-13T20:59:00.178987679-06:00 stderr F 2024-12-13 20:59:00.178 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 22\r\n2024-12-13T20:59:00.179648902-06:00 stderr F 2024-12-13 20:59:00.178 DEBUG (MainThread) [homeassistant.components.mqtt.client] Subscribing with mid: 57 to topics with qos: [('homeassistant/device/+/config', 0)]\r\n2024-12-13T20:59:00.179955411-06:00 stderr F 2024-12-13 20:59:00.179 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 22\r\n2024-12-13T20:59:00.185276708-06:00 stderr F 2024-12-13 20:59:00.184 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 22\r\n2024-12-13T20:59:00.185688706-06:00 stderr F 2024-12-13 20:59:00.184 DEBUG (MainThread) [homeassistant.components.mqtt.client] Subscribing with mid: 58 to topics with qos: [('homeassistant/device/+/+/config', 0)]\r\n2024-12-13T20:59:00.189432281-06:00 stderr F 2024-12-13 20:59:00.186 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 22\r\n2024-12-13T20:59:00.190901863-06:00 stderr F 2024-12-13 20:59:00.187 ERROR (SyncWorker_1) [aiodhcpwatcher] Cannot watch for dhcp packets: [Errno 1] Operation not permitted\r\n2024-12-13T20:59:00.192818905-06:00 stderr F 2024-12-13 20:59:00.191 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 22\r\n2024-12-13T20:59:00.193053468-06:00 stderr F 2024-12-13 20:59:00.191 DEBUG (MainThread) [homeassistant.components.mqtt.client] Subscribing with mid: 59 to topics with qos: [('drop_connect/discovery/#', 0)]\r\n2024-12-13T20:59:00.196103425-06:00 stderr F 2024-12-13 20:59:00.194 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 22\r\n2024-12-13T20:59:00.202546569-06:00 stderr F 2024-12-13 20:59:00.201 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 22\r\n2024-12-13T20:59:00.202887537-06:00 stderr F 2024-12-13 20:59:00.201 DEBUG (MainThread) [homeassistant.components.mqtt.client] Subscribing with mid: 60 to topics with qos: [('dsmr/#', 0)]\r\n2024-12-13T20:59:00.207476946-06:00 stderr F 2024-12-13 20:59:00.206 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 22\r\n2024-12-13T20:59:00.210002789-06:00 stderr F 2024-12-13 20:59:00.208 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 22\r\n2024-12-13T20:59:00.210301744-06:00 stderr F 2024-12-13 20:59:00.208 DEBUG (MainThread) [homeassistant.components.mqtt.client] Subscribing with mid: 61 to topics with qos: [('esphome/discover/#', 0)]\r\n2024-12-13T20:59:00.210967104-06:00 stderr F 2024-12-13 20:59:00.209 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 22\r\n2024-12-13T20:59:00.212297038-06:00 stderr F 2024-12-13 20:59:00.211 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 22\r\n2024-12-13T20:59:00.212572212-06:00 stderr F 2024-12-13 20:59:00.211 DEBUG (MainThread) [homeassistant.components.mqtt.client] Subscribing with mid: 62 to topics with qos: [('fully/deviceInfo/+', 0)]\r\n2024-12-13T20:59:00.213260220-06:00 stderr F 2024-12-13 20:59:00.212 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 22\r\n2024-12-13T20:59:00.217233977-06:00 stderr F 2024-12-13 20:59:00.216 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 22\r\n2024-12-13T20:59:00.219410746-06:00 stderr F 2024-12-13 20:59:00.218 DEBUG (MainThread) [homeassistant.components.mqtt.client] Subscribing with mid: 63 to topics with qos: [('tasmota/discovery/#', 0)]\r\n2024-12-13T20:59:00.221050886-06:00 stderr F 2024-12-13 20:59:00.219 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 22\r\n2024-12-13T20:59:05.221184517-06:00 stderr F 2024-12-13 20:59:05.220 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 22\r\n2024-12-13T20:59:05.221475342-06:00 stderr F 2024-12-13 20:59:05.220 DEBUG (MainThread) [homeassistant.components.mqtt.client] Transmitting message on homeassistant/status: 'online', mid: 64, qos: 0\r\n2024-12-13T20:59:05.222088887-06:00 stderr F 2024-12-13 20:59:05.221 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 22\r\n2024-12-13T20:59:05.222740798-06:00 stderr F 2024-12-13 20:59:05.222 INFO (MainThread) [homeassistant.components.mqtt.client] MQTT client initialized, birth message sent\r\n2024-12-13T20:59:18.603167289-06:00 stderr F 2024-12-13 20:59:18.601 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 22\r\n2024-12-13T20:59:18.605734418-06:00 stderr F 2024-12-13 20:59:18.602 DEBUG (MainThread) [homeassistant.components.mqtt.client] Transmitting message on homeassistant/switch/1/power: 'OFF', mid: 65, qos: 0\r\n2024-12-13T20:59:18.606009345-06:00 stderr F 2024-12-13 20:59:18.603 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 22\r\n2024-12-13T20:59:27.979391384-06:00 stderr F 2024-12-13 20:59:27.977 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: connection closed 22\r\n2024-12-13T20:59:27.980029244-06:00 stderr F 2024-12-13 20:59:27.979 DEBUG (MainThread) [homeassistant.components.mqtt.client] Disconnected from MQTT server mosquitto.mydomain.com:443 (7)\r\n```\r\n\r\n</details>\r\n\r\nI only have fragments of time to troubleshoot at the moment. I'll try the same test this weekend some time with debug logging on for everything to see if that turns up anything.\r\n\nDid you test without the proxy service in between?\r\nDo you see the same if Mosquito is installed as an addon?\r\nDid you test without a TLS layer ( without SSL)?\r\n\nFound this link:\r\nhttps://stackoverflow.com/questions/71379937/configure-nginx-reverse-proxy-for-mqtt\r\n\r\nMaybe it is of any help?\nIf I skip Nginx and go right to the broker directly, I don't see the same issue. The MQTT client in HA attempts to reconnect every few seconds and eventually succeeds once the broker is ready.\r\n\r\nSo I just need to determine why the HA client doesn't attempt to reconnect when Nginx is involved even though other clients do. There must be something different among the various clients or their connections via the proxy. I'll dig into that some more.\nFor what it's worth, I tweaked the `_reconnect_loop` method in the client.py file to this:\r\n\r\n```python\r\nasync def _reconnect_loop(self) -> None:\r\n    \"\"\"Reconnect to the MQTT server.\"\"\"\r\n    _LOGGER.debug(\"Started _reconnect_loop\")\r\n    while True:\r\n        _LOGGER.debug(\"Connected status: %s\", self.connected)\r\n        if not self.connected:\r\n            try:\r\n                _LOGGER.debug(\"Entering connection lock\")\r\n                async with self._connection_lock, self._async_connect_in_executor():\r\n                    _LOGGER.debug(\"Adding reconnect executor job\")\r\n                    await self.hass.async_add_executor_job(self._mqttc.reconnect)\r\n            except OSError as err:\r\n                _LOGGER.debug(\r\n                    \"Error re-connecting to MQTT server due to exception: %s\", err\r\n                )\r\n\r\n        _LOGGER.debug(\"Entering sleep\")\r\n        await asyncio.sleep(RECONNECT_INTERVAL_SECONDS)\r\n        _LOGGER.debug(\"Exited sleep\")\r\n```\r\n\r\nBasically just adding debug statements on every line.\r\nIf I point at my proxy and run my test again, logs look like this:\r\n\r\n```\r\n2024-12-14T20:33:43.127498847-06:00 stderr F 2024-12-14 20:33:43.126 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: connection closed 25\r\n2024-12-14T20:33:43.128743687-06:00 stderr F 2024-12-14 20:33:43.126 DEBUG (MainThread) [homeassistant.components.mqtt.client] Started _reconnect_loop\r\n2024-12-14T20:33:43.128969237-06:00 stderr F 2024-12-14 20:33:43.126 DEBUG (MainThread) [homeassistant.components.mqtt.client] Connected status: True\r\n2024-12-14T20:33:43.129227593-06:00 stderr F 2024-12-14 20:33:43.126 DEBUG (MainThread) [homeassistant.components.mqtt.client] Entering sleep\r\n2024-12-14T20:33:43.129469099-06:00 stderr F 2024-12-14 20:33:43.127 DEBUG (MainThread) [homeassistant.components.mqtt.client] Disconnected from MQTT server mosquitto.mydomain.com:443 (7)\r\n2024-12-14T20:33:53.128922332-06:00 stderr F 2024-12-14 20:33:53.127 DEBUG (MainThread) [homeassistant.components.mqtt.client] Exited sleep\r\n2024-12-14T20:33:53.129726676-06:00 stderr F 2024-12-14 20:33:53.128 DEBUG (MainThread) [homeassistant.components.mqtt.client] Connected status: False\r\n2024-12-14T20:33:53.129960993-06:00 stderr F 2024-12-14 20:33:53.128 DEBUG (MainThread) [homeassistant.components.mqtt.client] Entering connection lock\r\n2024-12-14T20:33:53.130156956-06:00 stderr F 2024-12-14 20:33:53.128 DEBUG (MainThread) [homeassistant.components.mqtt.client] Adding reconnect executor job\r\n```\r\n\r\nI get nothing after that last log line. No errors. Just nothing.\r\n\r\nIn the test where I connect without the proxy, I get a few \"Error re-connecting to MQTT server due to exception:\" errors logged from that `except` branch until the broker is back online, and then finally connection made logs.\r\n\r\nAnyways, I'll keep trying stuff. I didn't find anything noteworthy while re-looking at Nginx configurations around websockets. Most things you find out there on Nginx websocket proxying is just getting clients to connect to upstreams, which isn't relevant since my clients are connecting fine and keeping healthy connections.\r\n\nMore oddities for me.\r\n\r\nIf I alter the code now to this instead:\r\n```python\r\n    def _testing(self) -> None:\r\n        _LOGGER.debug(\"Entered reconnect\")\r\n        time.sleep(15) # Only works if I put in a delay that prevents the attempt to reconnect until the broker is back online.\r\n        self._mqttc.reconnect()\r\n        _LOGGER.debug(\"Exited reconnect\")\r\n\r\n    async def _reconnect_loop(self) -> None:\r\n        \"\"\"Reconnect to the MQTT server.\"\"\"\r\n        _LOGGER.debug(\"Started _reconnect_loop\")\r\n        while True:\r\n            _LOGGER.debug(\"Connected status: %s\", self.connected)\r\n            if not self.connected:\r\n                try:\r\n                    _LOGGER.debug(\"Entering connection lock\")\r\n                    async with self._connection_lock, self._async_connect_in_executor():\r\n                        _LOGGER.debug(\"Adding reconnect executor job\")\r\n                        await self.hass.async_add_executor_job(self._testing)\r\n                except OSError as err:\r\n                    _LOGGER.debug(\r\n                        \"Error re-connecting to MQTT server due to exception: %s\", err\r\n                    )\r\n\r\n            _LOGGER.debug(\"Entering sleep\")\r\n            await asyncio.sleep(RECONNECT_INTERVAL_SECONDS)\r\n            _LOGGER.debug(\"Exited sleep\")\r\n```\r\n\r\nThis `sleep` delay until the broker is back online works! The client reconnects.\r\n\r\nWithout the delay, I see the log \"Entered reconnect\" and then nothing. It seems like something inside the paho mqtt client is locking up within the reconnect method.\r\nThough I'm still not sure how Nginx impacts that.\nFrom what I can see in Nginx access logs, the HA mqtt client does attempt to reconnect when the `self._mqttc.reconnect()` method is hit.\r\n\r\nNginx immediately returns with a 502 status code and a generic HTML message. I'm wondering if the paho client isn't handling this correctly? If I set it up to connect to the broker directly, it would just get a connection refused error instead of the served up 502 error that Nginx serves out.\r\n\r\nI'm trying to play around with serving difference responses in Nginx while the broker is down, but I haven't landed on anything that works yet. Even hanging up the connection when the mqtt client attempts to reconnect isn't working.\nIf you'd like to test without NGINX websockets you can also use:\r\nhttps://test.mosquitto.org/\r\n\nThanks, but I've mentioned a few times already about testing against my broker without Nginx, which is a helpful comparison.\r\n\r\nI ended up grabbing a simplified example of using paho's client directly in a test python script to recreate what was going on.\r\nThe `reconnect()` is raising the exception: `paho.mqtt.client.WebsocketConnectionError: WebSocket handshake error` while the broker is offline.\r\n\r\nIf I change the HA integration client to catch any exception type in addition to the OSError it is already catching, it all starts working again. HA reconnects just fine.\r\nSo it seems like the exception that is being raised just isn't being caught and is causing the reconnect loop to die.\r\n\r\nFor example, my working `_reconnect_loop` method looks like this now:\r\n```python\r\nasync def _reconnect_loop(self) -> None:\r\n        \"\"\"Reconnect to the MQTT server.\"\"\"\r\n        while True:\r\n            if not self.connected:\r\n                try:\r\n                    async with self._connection_lock, self._async_connect_in_executor():\r\n                        await self.hass.async_add_executor_job(self._mqttc.reconnect)\r\n                except OSError as err:\r\n                    _LOGGER.debug(\r\n                        \"Error re-connecting to MQTT server due to exception: %s\", err\r\n                    )\r\n                except Exception as err: # This catch all fixes it.\r\n                    _LOGGER.debug(\r\n                        \"Error re-connecting to MQTT server due to exception: %s\", err\r\n                    )\r\n\r\n            await asyncio.sleep(RECONNECT_INTERVAL_SECONDS)\r\n```\r\n\r\nI see the debug log: `Error re-connecting to MQTT server due to exception: WebSocket handshake error` and eventually a bunch of connected messages once the broker is back.\r\n\r\nFor some reason I can't get it to work right if I catch `mqtt.WebsocketConnectionError` instead of `Exception`.\r\n\nYou could try to print the error in the catch all except \nI'll try that later.\r\nWhy is just the `OSError` caught when any uncaught error causes the reconnect loop to die? Why not just have a single catch block with the `Exception` type?\n> I'll try that later. Why is just the `OSError` caught when any uncaught error causes the reconnect loop to die? Why not just have a single catch block with the `Exception` type?\r\n\r\nMay be we will add that later. But it is a principle not allow a broad except by design.\nWe don't want broad exception catches as they hide bugs https://pylint.readthedocs.io/en/latest/user_guide/messages/warning/broad-exception-caught.html\r\n\r\nloop_forever is documented to `Raises OSError/WebsocketConnectionError on first connection failures unless retry_first_connection=True`\r\n\r\nSo adding an exception catch for `WebsocketConnectionError` should be sufficient\r\n\r\n\r\n\nI don't disagree in general, I'm just thinking of the lessor evil in terms of recovering in critical systems that don't benefit from any high level reset watchdogs.\r\n\r\nAnyways, I'll try to determine why the catch on that specific exception type wasn't hitting when I tested last night when I get some more time later. I'm not that native to python, so there is a lot of stumbling around.\r\n\r\nI'm satisfied with the approach of just catching what is documented to raise since that should address my issue.\n@bdraco, I'm still struggling with your commit. I think the `mqtt` import is missing from the function and giving me some trouble.\r\n\r\nIf I add a generic catch and then try to type check the exception, I get a log like:\r\n```\r\nname 'mqtt' is not defined\r\n```\r\n\r\nThanks for the support on this!\r\n\nmqtt is a late import. Check a few lines up \nAh, there is my confusion. I took your line change and dropped it into the _reconnect_loop function instead of where you put it in the async_connect function.\r\n\r\nDo you mind putting in the _reconnect_loop logic too since the self._mqttc.reconnect is raising that error type too?\n> Ah, there is my confusion. I took your line change and dropped it into the _reconnect_loop function instead of where you put it in the async_connect function.\n> \n> \n> \n> Do you mind putting in the _reconnect_loop logic too since the self._mqttc.reconnect is raising that error type too?\n\n\nI agree we should do it there as well. I'll try to work up something later today.", "created_at": "2024-12-21T01:46:24Z"}
{"repo": "home-assistant/core", "pull_number": 133680, "instance_id": "home-assistant__core-133680", "issue_numbers": ["133677"], "base_commit": "c780933fa06db399c4b8ecfa22359cb44af9c2e9", "patch": "diff --git a/homeassistant/components/roborock/manifest.json b/homeassistant/components/roborock/manifest.json\nindex 69d867aa164c94..bb89ecedbe3630 100644\n--- a/homeassistant/components/roborock/manifest.json\n+++ b/homeassistant/components/roborock/manifest.json\n@@ -7,7 +7,7 @@\n   \"iot_class\": \"local_polling\",\n   \"loggers\": [\"roborock\"],\n   \"requirements\": [\n-    \"python-roborock==2.8.1\",\n+    \"python-roborock==2.8.4\",\n     \"vacuum-map-parser-roborock==0.1.2\"\n   ]\n }\ndiff --git a/requirements_all.txt b/requirements_all.txt\nindex 62bc052860562c..a1eb0cc18e8949 100644\n--- a/requirements_all.txt\n+++ b/requirements_all.txt\n@@ -2415,7 +2415,7 @@ python-rabbitair==0.0.8\n python-ripple-api==0.0.3\n \n # homeassistant.components.roborock\n-python-roborock==2.8.1\n+python-roborock==2.8.4\n \n # homeassistant.components.smarttub\n python-smarttub==0.0.38\n", "test_patch": "diff --git a/requirements_test_all.txt b/requirements_test_all.txt\nindex d4917df83b7088..12dc227bd4f0ea 100644\n--- a/requirements_test_all.txt\n+++ b/requirements_test_all.txt\n@@ -1945,7 +1945,7 @@ python-picnic-api==1.1.0\n python-rabbitair==0.0.8\n \n # homeassistant.components.roborock\n-python-roborock==2.8.1\n+python-roborock==2.8.4\n \n # homeassistant.components.smarttub\n python-smarttub==0.0.38\n", "problem_statement": "Roborock integration not initializing\n### The problem\n\nI've tried to setup the Roborock integration. Received auth code via email. Integration is failing, saying to retry in a loop\n\n### What version of Home Assistant Core has the issue?\n\ncore-2024.12.5\n\n### What was the last working version of Home Assistant Core?\n\ncore-2024.12.3\n\n### What type of installation are you running?\n\nHome Assistant OS\n\n### Integration causing the issue\n\nRoborock\n\n### Link to integration documentation on our website\n\nhttps://www.home-assistant.io/integrations/roborock/\n\n### Diagnostics information\n\n```\r\nLogger: roborock.containers\r\nSource: /usr/local/lib/python3.13/site-packages/roborock/containers.py:131\r\nFirst occurred: 10:06:38 AM (9 occurrences)\r\nLast logged: 10:09:54 AM\r\n\r\n<enum 'RoborockMopModeCode'> has no members; specify `names=()` if you meant to create a new, empty, enum\r\nTraceback (most recent call last):\r\n  File \"/usr/local/lib/python3.13/site-packages/roborock/containers.py\", line 124, in convert_to_class_obj\r\n    converted_value = class_type(value)\r\n  File \"/usr/local/lib/python3.13/enum.py\", line 726, in __call__\r\n    raise TypeError(\r\n            f\"{cls} has no members; specify `names=()` if you meant to create a new, empty, enum\"\r\n            )\r\nTypeError: <enum 'RoborockMopModeCode'> has no members; specify `names=()` if you meant to create a new, empty, enum\r\n```\r\n\r\n--------------------------------------------------------------------------------------------------------\r\n\r\n```\r\nLogger: homeassistant.components.roborock.coordinator\r\nSource: helpers/update_coordinator.py:379\r\nintegration: Roborock (documentation, issues)\r\nFirst occurred: 10:06:38 AM (9 occurrences)\r\nLast logged: 10:09:54 AM\r\n\r\nUnexpected error fetching roborock data\r\nTraceback (most recent call last):\r\n  File \"/usr/src/homeassistant/homeassistant/helpers/update_coordinator.py\", line 379, in _async_refresh\r\n    self.data = await self._async_update_data()\r\n                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/src/homeassistant/homeassistant/components/roborock/coordinator.py\", line 110, in _async_update_data\r\n    await self._update_device_prop()\r\n  File \"/usr/src/homeassistant/homeassistant/components/roborock/coordinator.py\", line 99, in _update_device_prop\r\n    device_prop = await self.api.get_prop()\r\n                  ^^^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/local/lib/python3.13/site-packages/roborock/version_1_apis/roborock_client_v1.py\", line 271, in get_prop\r\n    status, clean_summary, consumable = await asyncio.gather(\r\n                                        ^^^^^^^^^^^^^^^^^^^^^\r\n    ...<5 lines>...\r\n    )  # type: Status, CleanSummary, Consumable # type: ignore\r\n    ^\r\n  File \"/usr/local/lib/python3.13/site-packages/roborock/version_1_apis/roborock_client_v1.py\", line 172, in get_status\r\n    data = self._status_type.from_dict(await self.cache[CacheableAttribute.status].async_value())\r\n  File \"/usr/local/lib/python3.13/site-packages/roborock/containers.py\", line 169, in from_dict\r\n    return cls(**data)\r\n  File \"<string>\", line 62, in __init__\r\n  File \"/usr/local/lib/python3.13/site-packages/roborock/containers.py\", line 539, in __post_init__\r\n    self.mop_mode_name = self.mop_mode.name\r\n                         ^^^^^^^^^^^^^^^^^^\r\nAttributeError: 'int' object has no attribute 'name'\r\n```\r\n\r\n\r\n--------------------------------------------------------------------------------------------------------\r\n\r\n```\r\nLogger: homeassistant.components.roborock\r\nSource: components/roborock/__init__.py:219\r\nintegration: Roborock (documentation, issues)\r\nFirst occurred: 10:06:39 AM (9 occurrences)\r\nLast logged: 10:09:54 AM\r\n\r\nNot setting up Roborock Qrevo Master because the coordinator failed to get data for the first time using the offline client Please create an issue with the following error included: 'int' object has no attribute 'name'\r\n```\n\n### Example YAML snippet\n\n_No response_\n\n### Anything in the logs that might be useful for us?\n\n_No response_\n\n### Additional information\n\n_No response_\n", "hints_text": "\nHey there @lash-l, mind taking a look at this issue as it has been labeled with an integration (`roborock`) you are listed as a [code owner](https://github.com/home-assistant/core/blob/dev/CODEOWNERS#L1261) for? Thanks!\n\n<details>\n<summary>Code owner commands</summary>\n\n\nCode owners of `roborock` can trigger bot actions by commenting:\n\n- `@home-assistant close` Closes the issue.\n- `@home-assistant rename Awesome new title` Renames the issue.\n- `@home-assistant reopen` Reopen the issue.\n- `@home-assistant unassign roborock` Removes the current integration label and assignees on the issue, add the integration domain after the command.\n- `@home-assistant add-label needs-more-information` Add a label (needs-more-information, problem in dependency, problem in custom component) to the issue.\n- `@home-assistant remove-label needs-more-information` Remove a label (needs-more-information, problem in dependency, problem in custom component) on the issue.\n\n</details>\n\n\n<sub><sup>(message by CodeOwnersMention)</sup></sub>\n\n---\n\n[roborock documentation](https://www.home-assistant.io/integrations/roborock)\n[roborock source](https://github.com/home-assistant/core/tree/dev/homeassistant/components/roborock)\n<sub><sup>(message by IssueLinks)</sup></sub>", "created_at": "2024-12-20T18:32:55Z"}
{"repo": "home-assistant/core", "pull_number": 133657, "instance_id": "home-assistant__core-133657", "issue_numbers": ["133362", "133362"], "base_commit": "870dc4dbeabe55a86d8d73d8e9184f55cdf3bfac", "patch": "diff --git a/homeassistant/components/overkiz/climate/atlantic_electrical_towel_dryer.py b/homeassistant/components/overkiz/climate/atlantic_electrical_towel_dryer.py\nindex 92bd6ceae8281..0b5ba3ffcc7af 100644\n--- a/homeassistant/components/overkiz/climate/atlantic_electrical_towel_dryer.py\n+++ b/homeassistant/components/overkiz/climate/atlantic_electrical_towel_dryer.py\n@@ -84,12 +84,15 @@ async def async_set_hvac_mode(self, hvac_mode: HVACMode) -> None:\n         )\n \n     @property\n-    def target_temperature(self) -> None:\n-        \"\"\"Return the temperature.\"\"\"\n-        if self.hvac_mode == HVACMode.AUTO:\n-            self.executor.select_state(OverkizState.IO_EFFECTIVE_TEMPERATURE_SETPOINT)\n-        else:\n-            self.executor.select_state(OverkizState.CORE_TARGET_TEMPERATURE)\n+    def target_temperature(self) -> float | None:\n+        \"\"\"Return the target temperature.\"\"\"\n+        state = (\n+            OverkizState.IO_EFFECTIVE_TEMPERATURE_SETPOINT\n+            if self.hvac_mode == HVACMode.AUTO\n+            else OverkizState.CORE_TARGET_TEMPERATURE\n+        )\n+\n+        return cast(float, self.executor.select_state(state))\n \n     @property\n     def current_temperature(self) -> float | None:\n", "test_patch": "", "problem_statement": "Can't change temperature for AtlanticElectricalTowelDryer in Overkiz\n### The problem\n\nI can't choose the temperature and the changing mode of my towel dryer\n\n### What version of Home Assistant Core has the issue?\n\ncore-2024.12.3\n\n### What was the last working version of Home Assistant Core?\n\n_No response_\n\n### What type of installation are you running?\n\nHome Assistant Container\n\n### Integration causing the issue\n\noverkiz\n\n### Link to integration documentation on our website\n\nhttps://www.home-assistant.io/integrations/overkiz\n\n### Diagnostics information\n\n[config_entry-overkiz-f7f0ed75e92ce17d4aa61f4ff4e7e604.json](https://github.com/user-attachments/files/18150617/config_entry-overkiz-f7f0ed75e92ce17d4aa61f4ff4e7e604.json)\r\n\n\n### Example YAML snippet\n\n_No response_\n\n### Anything in the logs that might be useful for us?\n\n_No response_\n\n### Additional information\n\n_No response_\nCan't change temperature for AtlanticElectricalTowelDryer in Overkiz\n### The problem\n\nI can't choose the temperature and the changing mode of my towel dryer\n\n### What version of Home Assistant Core has the issue?\n\ncore-2024.12.3\n\n### What was the last working version of Home Assistant Core?\n\n_No response_\n\n### What type of installation are you running?\n\nHome Assistant Container\n\n### Integration causing the issue\n\noverkiz\n\n### Link to integration documentation on our website\n\nhttps://www.home-assistant.io/integrations/overkiz\n\n### Diagnostics information\n\n[config_entry-overkiz-f7f0ed75e92ce17d4aa61f4ff4e7e604.json](https://github.com/user-attachments/files/18150617/config_entry-overkiz-f7f0ed75e92ce17d4aa61f4ff4e7e604.json)\r\n\n\n### Example YAML snippet\n\n_No response_\n\n### Anything in the logs that might be useful for us?\n\n_No response_\n\n### Additional information\n\n_No response_\n", "hints_text": "\nHey there @imicknl, @vlebourl, @tetienne, @nyrodev, @tronix117, @alexfp14, mind taking a look at this issue as it has been labeled with an integration (`overkiz`) you are listed as a [code owner](https://github.com/home-assistant/core/blob/dev/CODEOWNERS#L1106) for? Thanks!\n\n<details>\n<summary>Code owner commands</summary>\n\n\nCode owners of `overkiz` can trigger bot actions by commenting:\n\n- `@home-assistant close` Closes the issue.\n- `@home-assistant rename Awesome new title` Renames the issue.\n- `@home-assistant reopen` Reopen the issue.\n- `@home-assistant unassign overkiz` Removes the current integration label and assignees on the issue, add the integration domain after the command.\n- `@home-assistant add-label needs-more-information` Add a label (needs-more-information, problem in dependency, problem in custom component) to the issue.\n- `@home-assistant remove-label needs-more-information` Remove a label (needs-more-information, problem in dependency, problem in custom component) on the issue.\n\n</details>\n\n\n<sub><sup>(message by CodeOwnersMention)</sup></sub>\n\n---\n\n[overkiz documentation](https://www.home-assistant.io/integrations/overkiz)\n[overkiz source](https://github.com/home-assistant/core/tree/dev/homeassistant/components/overkiz)\n<sub><sup>(message by IssueLinks)</sup></sub>\nDo you have any error in the log? Most likely this is related to a known issue like https://github.com/home-assistant/core/issues/105621 (or some others).\n2 or 3 years ago, you made me a patch to fix it. But since the migration to HA-CORE, the fix has not come back. We can talk again on Discord if you need\n@luciol21 let's do! \ud83d\udc4d\ud83c\udffb\nHow can I reach you on discord?\n`_imick`\n\nHey there @imicknl, @vlebourl, @tetienne, @nyrodev, @tronix117, @alexfp14, mind taking a look at this issue as it has been labeled with an integration (`overkiz`) you are listed as a [code owner](https://github.com/home-assistant/core/blob/dev/CODEOWNERS#L1106) for? Thanks!\n\n<details>\n<summary>Code owner commands</summary>\n\n\nCode owners of `overkiz` can trigger bot actions by commenting:\n\n- `@home-assistant close` Closes the issue.\n- `@home-assistant rename Awesome new title` Renames the issue.\n- `@home-assistant reopen` Reopen the issue.\n- `@home-assistant unassign overkiz` Removes the current integration label and assignees on the issue, add the integration domain after the command.\n- `@home-assistant add-label needs-more-information` Add a label (needs-more-information, problem in dependency, problem in custom component) to the issue.\n- `@home-assistant remove-label needs-more-information` Remove a label (needs-more-information, problem in dependency, problem in custom component) on the issue.\n\n</details>\n\n\n<sub><sup>(message by CodeOwnersMention)</sup></sub>\n\n---\n\n[overkiz documentation](https://www.home-assistant.io/integrations/overkiz)\n[overkiz source](https://github.com/home-assistant/core/tree/dev/homeassistant/components/overkiz)\n<sub><sup>(message by IssueLinks)</sup></sub>\nDo you have any error in the log? Most likely this is related to a known issue like https://github.com/home-assistant/core/issues/105621 (or some others).\n2 or 3 years ago, you made me a patch to fix it. But since the migration to HA-CORE, the fix has not come back. We can talk again on Discord if you need\n@luciol21 let's do! \ud83d\udc4d\ud83c\udffb\nHow can I reach you on discord?\n`_imick`", "created_at": "2024-12-20T14:01:15Z"}
{"repo": "home-assistant/core", "pull_number": 133636, "instance_id": "home-assistant__core-133636", "issue_numbers": ["132985"], "base_commit": "a5eb816dcfaadb86e539b549643ebabf1c4c625a", "patch": "diff --git a/homeassistant/components/fjaraskupan/light.py b/homeassistant/components/fjaraskupan/light.py\nindex b33904c805d3d4..f0083591d4dd04 100644\n--- a/homeassistant/components/fjaraskupan/light.py\n+++ b/homeassistant/components/fjaraskupan/light.py\n@@ -4,8 +4,6 @@\n \n from typing import Any\n \n-from fjaraskupan import COMMAND_LIGHT_ON_OFF\n-\n from homeassistant.components.light import ATTR_BRIGHTNESS, ColorMode, LightEntity\n from homeassistant.config_entries import ConfigEntry\n from homeassistant.core import HomeAssistant\n@@ -62,7 +60,6 @@ async def async_turn_off(self, **kwargs: Any) -> None:\n         if self.is_on:\n             async with self.coordinator.async_connect_and_update() as device:\n                 await device.send_dim(0)\n-                await device.send_command(COMMAND_LIGHT_ON_OFF)\n \n     @property\n     def is_on(self) -> bool:\ndiff --git a/homeassistant/components/fjaraskupan/manifest.json b/homeassistant/components/fjaraskupan/manifest.json\nindex 91c74b68e01c54..2fd49aac5eef12 100644\n--- a/homeassistant/components/fjaraskupan/manifest.json\n+++ b/homeassistant/components/fjaraskupan/manifest.json\n@@ -14,5 +14,5 @@\n   \"documentation\": \"https://www.home-assistant.io/integrations/fjaraskupan\",\n   \"iot_class\": \"local_polling\",\n   \"loggers\": [\"bleak\", \"fjaraskupan\"],\n-  \"requirements\": [\"fjaraskupan==2.3.0\"]\n+  \"requirements\": [\"fjaraskupan==2.3.2\"]\n }\ndiff --git a/homeassistant/components/freebox/manifest.json b/homeassistant/components/freebox/manifest.json\nindex ad7da1703b805c..46422cee1055b7 100644\n--- a/homeassistant/components/freebox/manifest.json\n+++ b/homeassistant/components/freebox/manifest.json\n@@ -7,6 +7,6 @@\n   \"documentation\": \"https://www.home-assistant.io/integrations/freebox\",\n   \"iot_class\": \"local_polling\",\n   \"loggers\": [\"freebox_api\"],\n-  \"requirements\": [\"freebox-api==1.1.0\"],\n+  \"requirements\": [\"freebox-api==1.2.1\"],\n   \"zeroconf\": [\"_fbx-api._tcp.local.\"]\n }\ndiff --git a/homeassistant/components/gardena_bluetooth/manifest.json b/homeassistant/components/gardena_bluetooth/manifest.json\nindex da5c08c38c5e77..28bba1015f5d1d 100644\n--- a/homeassistant/components/gardena_bluetooth/manifest.json\n+++ b/homeassistant/components/gardena_bluetooth/manifest.json\n@@ -14,5 +14,5 @@\n   \"documentation\": \"https://www.home-assistant.io/integrations/gardena_bluetooth\",\n   \"iot_class\": \"local_polling\",\n   \"loggers\": [\"bleak\", \"bleak_esphome\", \"gardena_bluetooth\"],\n-  \"requirements\": [\"gardena-bluetooth==1.4.4\"]\n+  \"requirements\": [\"gardena-bluetooth==1.5.0\"]\n }\ndiff --git a/homeassistant/components/integration/sensor.py b/homeassistant/components/integration/sensor.py\nindex a053e5cea5cea0..27aa74d0785cdd 100644\n--- a/homeassistant/components/integration/sensor.py\n+++ b/homeassistant/components/integration/sensor.py\n@@ -576,7 +576,7 @@ def _schedule_max_sub_interval_exceeded_if_state_is_numeric(\n         if (\n             self._max_sub_interval is not None\n             and source_state is not None\n-            and (source_state_dec := _decimal_state(source_state.state))\n+            and (source_state_dec := _decimal_state(source_state.state)) is not None\n         ):\n \n             @callback\ndiff --git a/homeassistant/components/mqtt/client.py b/homeassistant/components/mqtt/client.py\nindex ee6f02912b27e2..0dcd7b2014bd5b 100644\n--- a/homeassistant/components/mqtt/client.py\n+++ b/homeassistant/components/mqtt/client.py\n@@ -661,7 +661,7 @@ async def async_connect(self, client_available: asyncio.Future[bool]) -> None:\n                     self.conf.get(CONF_PORT, DEFAULT_PORT),\n                     self.conf.get(CONF_KEEPALIVE, DEFAULT_KEEPALIVE),\n                 )\n-        except OSError as err:\n+        except (OSError, mqtt.WebsocketConnectionError) as err:\n             _LOGGER.error(\"Failed to connect to MQTT server due to exception: %s\", err)\n             self._async_connection_result(False)\n         finally:\ndiff --git a/homeassistant/components/music_assistant/media_player.py b/homeassistant/components/music_assistant/media_player.py\nindex fdf3a0c0c48dce..2345643868c0f1 100644\n--- a/homeassistant/components/music_assistant/media_player.py\n+++ b/homeassistant/components/music_assistant/media_player.py\n@@ -566,17 +566,13 @@ def _update_media_attributes(\n             # shuffle and repeat are not (yet) supported for external sources\n             self._attr_shuffle = None\n             self._attr_repeat = None\n-            if TYPE_CHECKING:\n-                assert player.elapsed_time is not None\n-            self._attr_media_position = int(player.elapsed_time)\n+            self._attr_media_position = int(player.elapsed_time or 0)\n             self._attr_media_position_updated_at = (\n                 utc_from_timestamp(player.elapsed_time_last_updated)\n                 if player.elapsed_time_last_updated\n                 else None\n             )\n-            if TYPE_CHECKING:\n-                assert player.elapsed_time is not None\n-            self._prev_time = player.elapsed_time\n+            self._prev_time = player.elapsed_time or 0\n             return\n \n         if queue is None:\ndiff --git a/homeassistant/components/nice_go/const.py b/homeassistant/components/nice_go/const.py\nindex a6635368f7babf..c02bcb3c2349fa 100644\n--- a/homeassistant/components/nice_go/const.py\n+++ b/homeassistant/components/nice_go/const.py\n@@ -15,8 +15,8 @@\n REFRESH_TOKEN_EXPIRY_TIME = timedelta(days=30)\n \n SUPPORTED_DEVICE_TYPES = {\n-    Platform.LIGHT: [\"WallStation\"],\n-    Platform.SWITCH: [\"WallStation\"],\n+    Platform.LIGHT: [\"WallStation\", \"WallStation_ESP32\"],\n+    Platform.SWITCH: [\"WallStation\", \"WallStation_ESP32\"],\n }\n KNOWN_UNSUPPORTED_DEVICE_TYPES = {\n     Platform.LIGHT: [\"Mms100\"],\ndiff --git a/homeassistant/components/nice_go/coordinator.py b/homeassistant/components/nice_go/coordinator.py\nindex 29c0d8233fe325..07b20bbbf1062b 100644\n--- a/homeassistant/components/nice_go/coordinator.py\n+++ b/homeassistant/components/nice_go/coordinator.py\n@@ -239,7 +239,6 @@ async def on_data(self, data: dict[str, Any]) -> None:\n             ].type,  # Device type is not sent in device state update, and it can't change, so we just reuse the existing one\n             BarrierState(\n                 deviceId=raw_data[\"deviceId\"],\n-                desired=json.loads(raw_data[\"desired\"]),\n                 reported=json.loads(raw_data[\"reported\"]),\n                 connectionState=ConnectionState(\n                     connected=raw_data[\"connectionState\"][\"connected\"],\ndiff --git a/homeassistant/components/nice_go/cover.py b/homeassistant/components/nice_go/cover.py\nindex a823e93180411a..6360e398b96cc7 100644\n--- a/homeassistant/components/nice_go/cover.py\n+++ b/homeassistant/components/nice_go/cover.py\n@@ -21,6 +21,7 @@\n DEVICE_CLASSES = {\n     \"WallStation\": CoverDeviceClass.GARAGE,\n     \"Mms100\": CoverDeviceClass.GATE,\n+    \"WallStation_ESP32\": CoverDeviceClass.GARAGE,\n }\n PARALLEL_UPDATES = 1\n \ndiff --git a/homeassistant/components/nice_go/manifest.json b/homeassistant/components/nice_go/manifest.json\nindex 817d7ef9bc9d43..1af23ec4d9bf1e 100644\n--- a/homeassistant/components/nice_go/manifest.json\n+++ b/homeassistant/components/nice_go/manifest.json\n@@ -7,5 +7,5 @@\n   \"integration_type\": \"hub\",\n   \"iot_class\": \"cloud_push\",\n   \"loggers\": [\"nice_go\"],\n-  \"requirements\": [\"nice-go==0.3.10\"]\n+  \"requirements\": [\"nice-go==1.0.0\"]\n }\ndiff --git a/homeassistant/components/overkiz/config_flow.py b/homeassistant/components/overkiz/config_flow.py\nindex 471a13d0de2e6d..3829fb3160ddd6 100644\n--- a/homeassistant/components/overkiz/config_flow.py\n+++ b/homeassistant/components/overkiz/config_flow.py\n@@ -76,7 +76,7 @@ async def async_validate_input(self, user_input: dict[str, Any]) -> dict[str, An\n             for gateway in gateways:\n                 if is_overkiz_gateway(gateway.id):\n                     gateway_id = gateway.id\n-                    await self.async_set_unique_id(gateway_id)\n+                    await self.async_set_unique_id(gateway_id, raise_on_progress=False)\n \n         return user_input\n \ndiff --git a/homeassistant/components/overkiz/manifest.json b/homeassistant/components/overkiz/manifest.json\nindex 8c750aec6bd9e8..9ab901d500501a 100644\n--- a/homeassistant/components/overkiz/manifest.json\n+++ b/homeassistant/components/overkiz/manifest.json\n@@ -20,7 +20,7 @@\n   \"integration_type\": \"hub\",\n   \"iot_class\": \"local_polling\",\n   \"loggers\": [\"boto3\", \"botocore\", \"pyhumps\", \"pyoverkiz\", \"s3transfer\"],\n-  \"requirements\": [\"pyoverkiz==1.15.0\"],\n+  \"requirements\": [\"pyoverkiz==1.15.3\"],\n   \"zeroconf\": [\n     {\n       \"type\": \"_kizbox._tcp.local.\",\ndiff --git a/homeassistant/components/roborock/manifest.json b/homeassistant/components/roborock/manifest.json\nindex c305e4710fcead..69d867aa164c94 100644\n--- a/homeassistant/components/roborock/manifest.json\n+++ b/homeassistant/components/roborock/manifest.json\n@@ -7,7 +7,7 @@\n   \"iot_class\": \"local_polling\",\n   \"loggers\": [\"roborock\"],\n   \"requirements\": [\n-    \"python-roborock==2.7.2\",\n+    \"python-roborock==2.8.1\",\n     \"vacuum-map-parser-roborock==0.1.2\"\n   ]\n }\ndiff --git a/homeassistant/components/screenlogic/__init__.py b/homeassistant/components/screenlogic/__init__.py\nindex 6f58e9b3666999..972837f7d75c37 100644\n--- a/homeassistant/components/screenlogic/__init__.py\n+++ b/homeassistant/components/screenlogic/__init__.py\n@@ -4,6 +4,7 @@\n from typing import Any\n \n from screenlogicpy import ScreenLogicError, ScreenLogicGateway\n+from screenlogicpy.const.common import ScreenLogicConnectionError\n from screenlogicpy.const.data import SHARED_VALUES\n \n from homeassistant.config_entries import ConfigEntry\n@@ -64,7 +65,7 @@ async def async_setup_entry(hass: HomeAssistant, entry: ScreenLogicConfigEntry)\n     try:\n         await gateway.async_connect(**connect_info)\n         await gateway.async_update()\n-    except ScreenLogicError as ex:\n+    except (ScreenLogicConnectionError, ScreenLogicError) as ex:\n         raise ConfigEntryNotReady(ex.msg) from ex\n \n     coordinator = ScreenlogicDataUpdateCoordinator(\ndiff --git a/homeassistant/components/twinkly/config_flow.py b/homeassistant/components/twinkly/config_flow.py\nindex 68c455dc619007..837bd9ccb6a1a8 100644\n--- a/homeassistant/components/twinkly/config_flow.py\n+++ b/homeassistant/components/twinkly/config_flow.py\n@@ -45,7 +45,9 @@ async def async_step_user(\n             except (TimeoutError, ClientError):\n                 errors[CONF_HOST] = \"cannot_connect\"\n             else:\n-                await self.async_set_unique_id(device_info[DEV_ID])\n+                await self.async_set_unique_id(\n+                    device_info[DEV_ID], raise_on_progress=False\n+                )\n                 self._abort_if_unique_id_configured()\n \n                 return self._create_entry_from_device(device_info, host)\ndiff --git a/homeassistant/const.py b/homeassistant/const.py\nindex 21f805bae72f7a..417fa94e048473 100644\n--- a/homeassistant/const.py\n+++ b/homeassistant/const.py\n@@ -25,7 +25,7 @@\n APPLICATION_NAME: Final = \"HomeAssistant\"\n MAJOR_VERSION: Final = 2024\n MINOR_VERSION: Final = 12\n-PATCH_VERSION: Final = \"4\"\n+PATCH_VERSION: Final = \"5\"\n __short_version__: Final = f\"{MAJOR_VERSION}.{MINOR_VERSION}\"\n __version__: Final = f\"{__short_version__}.{PATCH_VERSION}\"\n REQUIRED_PYTHON_VER: Final[tuple[int, int, int]] = (3, 12, 0)\ndiff --git a/homeassistant/package_constraints.txt b/homeassistant/package_constraints.txt\nindex 5d7df8a2ff545e..4906e4798126d3 100644\n--- a/homeassistant/package_constraints.txt\n+++ b/homeassistant/package_constraints.txt\n@@ -5,7 +5,7 @@ aiodiscover==2.1.0\n aiodns==3.2.0\n aiohasupervisor==0.2.1\n aiohttp-fast-zlib==0.2.0\n-aiohttp==3.11.10\n+aiohttp==3.11.11\n aiohttp_cors==0.7.0\n aiozoneinfo==0.2.1\n astral==2.2\ndiff --git a/pyproject.toml b/pyproject.toml\nindex 6b640bce4d02a5..58a1e8c1659c60 100644\n--- a/pyproject.toml\n+++ b/pyproject.toml\n@@ -4,7 +4,7 @@ build-backend = \"setuptools.build_meta\"\n \n [project]\n name        = \"homeassistant\"\n-version     = \"2024.12.4\"\n+version     = \"2024.12.5\"\n license     = {text = \"Apache-2.0\"}\n description = \"Open-source home automation platform running on Python 3.\"\n readme      = \"README.rst\"\n@@ -29,7 +29,7 @@ dependencies    = [\n     # change behavior based on presence of supervisor. Deprecated with #127228\n     # Lib can be removed with 2025.11\n     \"aiohasupervisor==0.2.1\",\n-    \"aiohttp==3.11.10\",\n+    \"aiohttp==3.11.11\",\n     \"aiohttp_cors==0.7.0\",\n     \"aiohttp-fast-zlib==0.2.0\",\n     \"aiozoneinfo==0.2.1\",\ndiff --git a/requirements.txt b/requirements.txt\nindex ad3cff221f7808..8e3e8c06882b84 100644\n--- a/requirements.txt\n+++ b/requirements.txt\n@@ -5,7 +5,7 @@\n # Home Assistant Core\n aiodns==3.2.0\n aiohasupervisor==0.2.1\n-aiohttp==3.11.10\n+aiohttp==3.11.11\n aiohttp_cors==0.7.0\n aiohttp-fast-zlib==0.2.0\n aiozoneinfo==0.2.1\ndiff --git a/requirements_all.txt b/requirements_all.txt\nindex 2858c92d182820..6f824059923cc1 100644\n--- a/requirements_all.txt\n+++ b/requirements_all.txt\n@@ -912,7 +912,7 @@ fivem-api==0.1.2\n fixerio==1.0.0a0\n \n # homeassistant.components.fjaraskupan\n-fjaraskupan==2.3.0\n+fjaraskupan==2.3.2\n \n # homeassistant.components.flexit_bacnet\n flexit_bacnet==2.2.1\n@@ -937,7 +937,7 @@ forecast-solar==4.0.0\n fortiosapi==1.0.5\n \n # homeassistant.components.freebox\n-freebox-api==1.1.0\n+freebox-api==1.2.1\n \n # homeassistant.components.free_mobile\n freesms==0.2.0\n@@ -953,7 +953,7 @@ fyta_cli==0.7.0\n gTTS==2.2.4\n \n # homeassistant.components.gardena_bluetooth\n-gardena-bluetooth==1.4.4\n+gardena-bluetooth==1.5.0\n \n # homeassistant.components.google_assistant_sdk\n gassist-text==0.0.11\n@@ -1460,7 +1460,7 @@ nextdns==4.0.0\n nibe==2.13.0\n \n # homeassistant.components.nice_go\n-nice-go==0.3.10\n+nice-go==1.0.0\n \n # homeassistant.components.niko_home_control\n niko-home-control==0.2.1\n@@ -2149,7 +2149,7 @@ pyotgw==2.2.2\n pyotp==2.8.0\n \n # homeassistant.components.overkiz\n-pyoverkiz==1.15.0\n+pyoverkiz==1.15.3\n \n # homeassistant.components.onewire\n pyownet==0.10.0.post1\n@@ -2402,7 +2402,7 @@ python-rabbitair==0.0.8\n python-ripple-api==0.0.3\n \n # homeassistant.components.roborock\n-python-roborock==2.7.2\n+python-roborock==2.8.1\n \n # homeassistant.components.smarttub\n python-smarttub==0.0.38\n", "test_patch": "diff --git a/requirements_test_all.txt b/requirements_test_all.txt\nindex f8565afc4b6c0d..e82e13e934a3af 100644\n--- a/requirements_test_all.txt\n+++ b/requirements_test_all.txt\n@@ -771,7 +771,7 @@ fitbit==0.3.1\n fivem-api==0.1.2\n \n # homeassistant.components.fjaraskupan\n-fjaraskupan==2.3.0\n+fjaraskupan==2.3.2\n \n # homeassistant.components.flexit_bacnet\n flexit_bacnet==2.2.1\n@@ -793,7 +793,7 @@ foobot_async==1.0.0\n forecast-solar==4.0.0\n \n # homeassistant.components.freebox\n-freebox-api==1.1.0\n+freebox-api==1.2.1\n \n # homeassistant.components.fritz\n # homeassistant.components.fritzbox_callmonitor\n@@ -806,7 +806,7 @@ fyta_cli==0.7.0\n gTTS==2.2.4\n \n # homeassistant.components.gardena_bluetooth\n-gardena-bluetooth==1.4.4\n+gardena-bluetooth==1.5.0\n \n # homeassistant.components.google_assistant_sdk\n gassist-text==0.0.11\n@@ -1220,7 +1220,7 @@ nextdns==4.0.0\n nibe==2.13.0\n \n # homeassistant.components.nice_go\n-nice-go==0.3.10\n+nice-go==1.0.0\n \n # homeassistant.components.nfandroidtv\n notifications-android-tv==0.1.5\n@@ -1736,7 +1736,7 @@ pyotgw==2.2.2\n pyotp==2.8.0\n \n # homeassistant.components.overkiz\n-pyoverkiz==1.15.0\n+pyoverkiz==1.15.3\n \n # homeassistant.components.onewire\n pyownet==0.10.0.post1\n@@ -1923,7 +1923,7 @@ python-picnic-api==1.1.0\n python-rabbitair==0.0.8\n \n # homeassistant.components.roborock\n-python-roborock==2.7.2\n+python-roborock==2.8.1\n \n # homeassistant.components.smarttub\n python-smarttub==0.0.38\ndiff --git a/tests/components/integration/test_sensor.py b/tests/components/integration/test_sensor.py\nindex 974c8bb8691bed..07390cd9571f47 100644\n--- a/tests/components/integration/test_sensor.py\n+++ b/tests/components/integration/test_sensor.py\n@@ -843,6 +843,39 @@ async def test_on_valid_source_expect_update_on_time(\n         assert float(state.state) < 1.8\n \n \n+async def test_on_0_source_expect_0_and_update_when_source_gets_positive(\n+    hass: HomeAssistant,\n+) -> None:\n+    \"\"\"Test whether time based integration updates the integral on a valid zero source.\"\"\"\n+    start_time = dt_util.utcnow()\n+\n+    with freeze_time(start_time) as freezer:\n+        await _setup_integral_sensor(hass, max_sub_interval=DEFAULT_MAX_SUB_INTERVAL)\n+        await _update_source_sensor(hass, 0)\n+        await hass.async_block_till_done()\n+\n+        # wait one minute and one second\n+        freezer.tick(61)\n+        async_fire_time_changed(hass, dt_util.now())\n+        await hass.async_block_till_done()\n+\n+        state = hass.states.get(\"sensor.integration\")\n+\n+        assert condition.async_numeric_state(hass, state) is True\n+        assert float(state.state) == 0  # integral is 0 after integration of 0\n+\n+        # wait one second and update state\n+        freezer.tick(1)\n+        async_fire_time_changed(hass, dt_util.now())\n+        await _update_source_sensor(hass, 100)\n+        await hass.async_block_till_done()\n+\n+        state = hass.states.get(\"sensor.integration\")\n+\n+        # approx 100*1/3600 (right method after 1 second since last integration)\n+        assert 0.027 < float(state.state) < 0.029\n+\n+\n async def test_on_unvailable_source_expect_no_update_on_time(\n     hass: HomeAssistant,\n ) -> None:\ndiff --git a/tests/components/mqtt/test_client.py b/tests/components/mqtt/test_client.py\nindex 4bfcde752ae6bd..1878045a9b9296 100644\n--- a/tests/components/mqtt/test_client.py\n+++ b/tests/components/mqtt/test_client.py\n@@ -1403,8 +1403,15 @@ def _mock_ack(topic: str, qos: int = 0) -> tuple[int, int]:\n         assert not mock_debouncer.is_set()\n \n \n+@pytest.mark.parametrize(\n+    \"exception\",\n+    [\n+        OSError(\"Connection error\"),\n+        paho_mqtt.WebsocketConnectionError(\"Connection error\"),\n+    ],\n+)\n async def test_setup_raises_config_entry_not_ready_if_no_connect_broker(\n-    hass: HomeAssistant, caplog: pytest.LogCaptureFixture\n+    hass: HomeAssistant, caplog: pytest.LogCaptureFixture, exception: Exception\n ) -> None:\n     \"\"\"Test for setup failure if connection to broker is missing.\"\"\"\n     entry = MockConfigEntry(domain=mqtt.DOMAIN, data={mqtt.CONF_BROKER: \"test-broker\"})\n@@ -1413,7 +1420,7 @@ async def test_setup_raises_config_entry_not_ready_if_no_connect_broker(\n     with patch(\n         \"homeassistant.components.mqtt.async_client.AsyncMQTTClient\"\n     ) as mock_client:\n-        mock_client().connect = MagicMock(side_effect=OSError(\"Connection error\"))\n+        mock_client().connect = MagicMock(side_effect=exception)\n         assert await hass.config_entries.async_setup(entry.entry_id)\n         await hass.async_block_till_done()\n         assert \"Failed to connect to MQTT server due to exception:\" in caplog.text\ndiff --git a/tests/components/music_assistant/fixtures/players.json b/tests/components/music_assistant/fixtures/players.json\nindex 2d8b88d0e8e223..8a08a55dc45dc8 100644\n--- a/tests/components/music_assistant/fixtures/players.json\n+++ b/tests/components/music_assistant/fixtures/players.json\n@@ -20,7 +20,7 @@\n         \"power\",\n         \"enqueue\"\n       ],\n-      \"elapsed_time\": 0,\n+      \"elapsed_time\": null,\n       \"elapsed_time_last_updated\": 0,\n       \"state\": \"idle\",\n       \"volume_level\": 20,\ndiff --git a/tests/components/nice_go/fixtures/get_all_barriers.json b/tests/components/nice_go/fixtures/get_all_barriers.json\nindex 84799e0dd32f33..5a7607612c19ba 100644\n--- a/tests/components/nice_go/fixtures/get_all_barriers.json\n+++ b/tests/components/nice_go/fixtures/get_all_barriers.json\n@@ -11,7 +11,6 @@\n     ],\n     \"state\": {\n       \"deviceId\": \"1\",\n-      \"desired\": { \"key\": \"value\" },\n       \"reported\": {\n         \"displayName\": \"Test Garage 1\",\n         \"autoDisabled\": false,\n@@ -42,7 +41,6 @@\n     ],\n     \"state\": {\n       \"deviceId\": \"2\",\n-      \"desired\": { \"key\": \"value\" },\n       \"reported\": {\n         \"displayName\": \"Test Garage 2\",\n         \"autoDisabled\": false,\n@@ -73,7 +71,6 @@\n     ],\n     \"state\": {\n       \"deviceId\": \"3\",\n-      \"desired\": { \"key\": \"value\" },\n       \"reported\": {\n         \"displayName\": \"Test Garage 3\",\n         \"autoDisabled\": false,\n@@ -101,7 +98,6 @@\n     ],\n     \"state\": {\n       \"deviceId\": \"4\",\n-      \"desired\": { \"key\": \"value\" },\n       \"reported\": {\n         \"displayName\": \"Test Garage 4\",\n         \"autoDisabled\": false,\ndiff --git a/tests/components/nice_go/test_init.py b/tests/components/nice_go/test_init.py\nindex 4eb3851516e455..051c6623b23962 100644\n--- a/tests/components/nice_go/test_init.py\n+++ b/tests/components/nice_go/test_init.py\n@@ -81,7 +81,6 @@ async def test_firmware_update_required(\n                     \"displayName\": \"test-display-name\",\n                     \"migrationStatus\": \"NOT_STARTED\",\n                 },\n-                desired=None,\n                 connectionState=None,\n                 version=None,\n                 timestamp=None,\ndiff --git a/tests/components/screenlogic/test_init.py b/tests/components/screenlogic/test_init.py\nindex 6416c93f7790e1..f21a1118b4fac9 100644\n--- a/tests/components/screenlogic/test_init.py\n+++ b/tests/components/screenlogic/test_init.py\n@@ -4,12 +4,14 @@\n from unittest.mock import DEFAULT, patch\n \n import pytest\n-from screenlogicpy import ScreenLogicGateway\n+from screenlogicpy import ScreenLogicError, ScreenLogicGateway\n+from screenlogicpy.const.common import ScreenLogicConnectionError\n \n from homeassistant.components.binary_sensor import DOMAIN as BINARY_SENSOR_DOMAIN\n from homeassistant.components.number import DOMAIN as NUMBER_DOMAIN\n from homeassistant.components.screenlogic import DOMAIN\n from homeassistant.components.sensor import DOMAIN as SENSOR_DOMAIN\n+from homeassistant.config_entries import ConfigEntryState\n from homeassistant.core import HomeAssistant\n from homeassistant.helpers import device_registry as dr, entity_registry as er\n from homeassistant.util import slugify\n@@ -284,3 +286,35 @@ def stub_connect(*args, **kwargs):\n \n         for entity_id in tested_entity_ids:\n             assert hass.states.get(entity_id) is not None\n+\n+\n+@pytest.mark.parametrize(\n+    \"exception\",\n+    [ScreenLogicConnectionError, ScreenLogicError],\n+)\n+async def test_retry_on_connect_exception(\n+    hass: HomeAssistant, mock_config_entry: MockConfigEntry, exception: Exception\n+) -> None:\n+    \"\"\"Test setup retries on expected exceptions.\"\"\"\n+\n+    def stub_connect(*args, **kwargs):\n+        raise exception\n+\n+    mock_config_entry.add_to_hass(hass)\n+\n+    with (\n+        patch(\n+            GATEWAY_DISCOVERY_IMPORT_PATH,\n+            return_value={},\n+        ),\n+        patch.multiple(\n+            ScreenLogicGateway,\n+            async_connect=stub_connect,\n+            is_connected=False,\n+            _async_connected_request=DEFAULT,\n+        ),\n+    ):\n+        assert not await hass.config_entries.async_setup(mock_config_entry.entry_id)\n+        await hass.async_block_till_done()\n+\n+    assert mock_config_entry.state is ConfigEntryState.SETUP_RETRY\ndiff --git a/tests/components/twinkly/test_config_flow.py b/tests/components/twinkly/test_config_flow.py\nindex 9b9aeafd082f1c..8d8e955291e0b6 100644\n--- a/tests/components/twinkly/test_config_flow.py\n+++ b/tests/components/twinkly/test_config_flow.py\n@@ -5,6 +5,7 @@\n from homeassistant import config_entries\n from homeassistant.components import dhcp\n from homeassistant.components.twinkly.const import DOMAIN as TWINKLY_DOMAIN\n+from homeassistant.config_entries import SOURCE_USER\n from homeassistant.const import CONF_HOST, CONF_ID, CONF_MODEL, CONF_NAME\n from homeassistant.core import HomeAssistant\n from homeassistant.data_entry_flow import FlowResultType\n@@ -157,3 +158,39 @@ async def test_dhcp_already_exists(hass: HomeAssistant) -> None:\n \n     assert result[\"type\"] is FlowResultType.ABORT\n     assert result[\"reason\"] == \"already_configured\"\n+\n+\n+async def test_user_flow_works_discovery(hass: HomeAssistant) -> None:\n+    \"\"\"Test user flow can continue after discovery happened.\"\"\"\n+    client = ClientMock()\n+    with (\n+        patch(\n+            \"homeassistant.components.twinkly.config_flow.Twinkly\", return_value=client\n+        ),\n+        patch(\"homeassistant.components.twinkly.async_setup_entry\", return_value=True),\n+    ):\n+        await hass.config_entries.flow.async_init(\n+            TWINKLY_DOMAIN,\n+            context={\"source\": config_entries.SOURCE_DHCP},\n+            data=dhcp.DhcpServiceInfo(\n+                hostname=\"Twinkly_XYZ\",\n+                ip=\"1.2.3.4\",\n+                macaddress=\"aabbccddeeff\",\n+            ),\n+        )\n+        result = await hass.config_entries.flow.async_init(\n+            TWINKLY_DOMAIN,\n+            context={\"source\": SOURCE_USER},\n+        )\n+        assert len(hass.config_entries.flow.async_progress(TWINKLY_DOMAIN)) == 2\n+        assert result[\"type\"] is FlowResultType.FORM\n+        assert result[\"step_id\"] == \"user\"\n+\n+        result = await hass.config_entries.flow.async_configure(\n+            result[\"flow_id\"],\n+            {CONF_HOST: \"10.0.0.131\"},\n+        )\n+        assert result[\"type\"] is FlowResultType.CREATE_ENTRY\n+\n+        # Verify the discovery flow was aborted\n+        assert not hass.config_entries.flow.async_progress(TWINKLY_DOMAIN)\n", "problem_statement": "MQTT Client Loses Connection and Does Not Attempt Reconnect Without Restarting HA\n### The problem\r\n\r\nSetting up a connection to a local Mosquitto MQTT broker via wss works just fine. The Home Assistant MQTT client connects, receives, and publishes messages as expected.\r\n\r\nIf I restart my Mosquitto service for any reason, Home Assistant logs that it lost the connection. It does not attempt to reconnect to the broker until I restart Home Assistant. Other clients using the same endpoint reconnect without issue immediately once the broker is back online.\r\n\r\n### What version of Home Assistant Core has the issue?\r\n\r\ncore-2024.12.0\r\n\r\n### What was the last working version of Home Assistant Core?\r\n\r\n_No response_\r\n\r\n### What type of installation are you running?\r\n\r\nHome Assistant Container\r\n\r\n### Integration causing the issue\r\n\r\nMQTT\r\n\r\n### Link to integration documentation on our website\r\n\r\nhttps://www.home-assistant.io/integrations/mqtt/\r\n\r\n### Diagnostics information\r\n\r\n_No response_\r\n\r\n### Example YAML snippet\r\n\r\n_No response_\r\n\r\n### Anything in the logs that might be useful for us?\r\n\r\n```txt\r\n2024-12-11T21:02:31.528977372-06:00 stderr F 2024-12-11 21:02:31.520 DEBUG (MainThread) [homeassistant.components.mqtt.models] Rendering incoming payload '[{\"amp\":null,\"att\":{\"ref\":0}},{\"amp\":null,\"att\":{\"ref\":0}},{\"amp\":null,\"att\":{\"ref\":0}},{\"amp\":null,\"att\":{\"ref\":0}},{\"amp\":null,\"att\":{\"ref\":0}},{\"amp\":null,\"att\":{\"ref\":0}},{\"amp\":null,\"att\":{\"ref\":0}},{\"amp\":null,\"att\":{\"ref\":0}}]' with variables {'entity_id': 'select.energy_monitor_mqtt_select_4', 'name': 'MQTT Select', 'this': <template TemplateStateFromEntityId(select.energy_monitor_mqtt_select_4)>} and Template<template=({{ (value_json[3].att.ref | string) + ' Amp' }}) renders=60>\r\n2024-12-11T21:02:34.555509706-06:00 stderr F 2024-12-11 21:02:34.553 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: connection closed 34\r\n2024-12-11T21:02:34.563350289-06:00 stderr F 2024-12-11 21:02:34.558 DEBUG (MainThread) [homeassistant.components.mqtt.client] Disconnected from MQTT server mosquitto.mydomain.com:443 (7)\r\n```\r\n\r\n\r\n### Additional information\r\n\r\nThe included log output shows 3 consecutive logs from the mqtt client in debug logging mode. The first line just represents a healthy event being received. The next 2 represent the moment when the broker was restarted.\r\nOver the course of minutes or hours, nothing else from the mqtt client is logged.\r\n\r\nA snippet from the HQ diagnostics concerning MQTT:\r\n```json\r\n{\r\n   \"mqtt_config\": {\r\n      \"birth_message\": {\r\n        \"payload\": \"online\",\r\n        \"qos\": 0,\r\n        \"retain\": false,\r\n        \"topic\": \"homeassistant/status\"\r\n      },\r\n      \"broker\": \"mosquitto.mydomain.com\",\r\n      \"certificate\": \"auto\",\r\n      \"discovery\": true,\r\n      \"discovery_prefix\": \"homeassistant\",\r\n      \"keepalive\": 30,\r\n      \"password\": \"**REDACTED**\",\r\n      \"port\": 443,\r\n      \"protocol\": \"3.1.1\",\r\n      \"tls_insecure\": false,\r\n      \"transport\": \"websockets\",\r\n      \"username\": \"**REDACTED**\",\r\n      \"will_message\": {\r\n        \"payload\": \"offline\",\r\n        \"qos\": 0,\r\n        \"retain\": false,\r\n        \"topic\": \"homeassistant/status\"\r\n      },\r\n      \"ws_headers\": {},\r\n      \"ws_path\": \"/\"\r\n    }\r\n}\r\n```\r\n\r\nThe Mosquitto broker sits behind an Nginx reverse proxy that manages a Let's Encrypt wildcard domain cert for my personal domain. I have PiHole routing local DNS requests for the `mosquitto.mydomain.com` domain to the Nginx reverse proxies listening on two different static IP addresses. Connecting to either IP on port 443 will get through to the single backend Mosquitto service.\r\n\r\nMQTT explorer and various devices connected to the broker through the exact same endpoint work fine and reconnect immediately once the broker is back online. Home Assistant seems to be the only client that does not recover.\r\n\r\nRestarting via the UI or restarting the HA Docker container both work to get the mqtt client working again. Re-saving the MQTT configuration via the UI does not. Using the MQTT configure UI to publish a test message fails and logs an error about how the client isn't connected.\n", "hints_text": "\nHey there @emontnemery, @jbouwh, @bdraco, mind taking a look at this issue as it has been labeled with an integration (`mqtt`) you are listed as a [code owner](https://github.com/home-assistant/core/blob/dev/CODEOWNERS#L956) for? Thanks!\n\n<details>\n<summary>Code owner commands</summary>\n\n\nCode owners of `mqtt` can trigger bot actions by commenting:\n\n- `@home-assistant close` Closes the issue.\n- `@home-assistant rename Awesome new title` Renames the issue.\n- `@home-assistant reopen` Reopen the issue.\n- `@home-assistant unassign mqtt` Removes the current integration label and assignees on the issue, add the integration domain after the command.\n- `@home-assistant add-label needs-more-information` Add a label (needs-more-information, problem in dependency, problem in custom component) to the issue.\n- `@home-assistant remove-label needs-more-information` Remove a label (needs-more-information, problem in dependency, problem in custom component) on the issue.\n\n</details>\n\n\n<sub><sup>(message by CodeOwnersMention)</sup></sub>\n\n---\n\n[mqtt documentation](https://www.home-assistant.io/integrations/mqtt)\n[mqtt source](https://github.com/home-assistant/core/tree/dev/homeassistant/components/mqtt)\n<sub><sup>(message by IssueLinks)</sup></sub>\nHi, is there anything other in HA Core the logs. Also check for custom integrations. Please turn on matt debug logging on Home Assistant.\nDebug logging was already enabled. I just now disabled the couple of custom integrations and restarted HA. After waiting a few minutes I restarted the broker. HA immediately lost connection and did not attempt to reconnect.\r\n\r\nHere are all of the logs from HA since startup including an error at the end after the disconnect where I attempted to send a message via the UI configure:\r\n\r\n<details>\r\n\r\n<summary>HA Logs</summary>\r\n\r\n```\r\n2024-12-12T20:41:14.246111079-06:00 stderr F s6-rc: info: service s6rc-oneshot-runner: starting\r\n2024-12-12T20:41:14.252208223-06:00 stderr F s6-rc: info: service s6rc-oneshot-runner successfully started\r\n2024-12-12T20:41:14.252426790-06:00 stderr F s6-rc: info: service fix-attrs: starting\r\n2024-12-12T20:41:14.260816940-06:00 stderr F s6-rc: info: service fix-attrs successfully started\r\n2024-12-12T20:41:14.260978963-06:00 stderr F s6-rc: info: service legacy-cont-init: starting\r\n2024-12-12T20:41:14.268809626-06:00 stderr F s6-rc: info: service legacy-cont-init successfully started\r\n2024-12-12T20:41:14.268993724-06:00 stderr F s6-rc: info: service legacy-services: starting\r\n2024-12-12T20:41:14.279034406-06:00 stderr P services-up: info: copying legacy longrun home-assistant\r\n2024-12-12T20:41:14.280839625-06:00 stderr F  (no readiness notification)\r\n2024-12-12T20:41:14.346529496-06:00 stderr F s6-rc: info: service legacy-services successfully started\r\n2024-12-12T20:41:37.024941763-06:00 stderr F 2024-12-12 20:41:37.020 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: connection opened 33\r\n2024-12-12T20:41:37.025974861-06:00 stderr F 2024-12-12 20:41:37.020 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: Starting client misc loop\r\n2024-12-12T20:41:37.026403601-06:00 stderr F 2024-12-12 20:41:37.020 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 33\r\n2024-12-12T20:41:37.026927311-06:00 stderr F 2024-12-12 20:41:37.025 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 33\r\n2024-12-12T20:41:37.028433518-06:00 stderr F 2024-12-12 20:41:37.027 DEBUG (MainThread) [homeassistant.components.mqtt.client] Connected to MQTT server mosquitto.mydomain.com:443 (0)\r\n2024-12-12T20:41:37.530956328-06:00 stderr F 2024-12-12 20:41:37.529 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 33\r\n2024-12-12T20:41:37.531540925-06:00 stderr F 2024-12-12 20:41:37.529 DEBUG (MainThread) [homeassistant.components.mqtt.client] Subscribing with mid: 1 to topics with qos: [('homeassistant/alarm_control_panel/+/config', 0)]\r\n2024-12-12T20:41:37.531776111-06:00 stderr F 2024-12-12 20:41:37.530 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 33\r\n2024-12-12T20:41:37.532706002-06:00 stderr F 2024-12-12 20:41:37.532 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 33\r\n2024-12-12T20:41:37.533502302-06:00 stderr F 2024-12-12 20:41:37.532 DEBUG (MainThread) [homeassistant.components.mqtt.client] Subscribing with mid: 2 to topics with qos: [('homeassistant/binary_sensor/+/config', 0)]\r\n2024-12-12T20:41:37.534231876-06:00 stderr F 2024-12-12 20:41:37.533 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 33\r\n2024-12-12T20:41:37.534950645-06:00 stderr F 2024-12-12 20:41:37.534 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 33\r\n2024-12-12T20:41:37.535447258-06:00 stderr F 2024-12-12 20:41:37.535 DEBUG (MainThread) [homeassistant.components.mqtt.client] Subscribing with mid: 3 to topics with qos: [('homeassistant/button/+/config', 0)]\r\n2024-12-12T20:41:37.535836396-06:00 stderr F 2024-12-12 20:41:37.535 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 33\r\n2024-12-12T20:41:37.536870853-06:00 stderr F 2024-12-12 20:41:37.536 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 33\r\n2024-12-12T20:41:37.537111465-06:00 stderr F 2024-12-12 20:41:37.536 DEBUG (MainThread) [homeassistant.components.mqtt.client] Subscribing with mid: 4 to topics with qos: [('homeassistant/camera/+/config', 0)]\r\n2024-12-12T20:41:37.537574045-06:00 stderr F 2024-12-12 20:41:37.537 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 33\r\n2024-12-12T20:41:37.538091722-06:00 stderr F 2024-12-12 20:41:37.537 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 33\r\n2024-12-12T20:41:37.538686570-06:00 stderr F 2024-12-12 20:41:37.538 DEBUG (MainThread) [homeassistant.components.mqtt.client] Subscribing with mid: 5 to topics with qos: [('homeassistant/climate/+/config', 0)]\r\n2024-12-12T20:41:37.539133607-06:00 stderr F 2024-12-12 20:41:37.538 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 33\r\n2024-12-12T20:41:37.540025980-06:00 stderr F 2024-12-12 20:41:37.539 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 33\r\n2024-12-12T20:41:37.540278454-06:00 stderr F 2024-12-12 20:41:37.539 DEBUG (MainThread) [homeassistant.components.mqtt.client] Subscribing with mid: 6 to topics with qos: [('homeassistant/cover/+/config', 0)]\r\n2024-12-12T20:41:37.541433600-06:00 stderr F 2024-12-12 20:41:37.540 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 33\r\n2024-12-12T20:41:37.541871825-06:00 stderr F 2024-12-12 20:41:37.540 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 33\r\n2024-12-12T20:41:37.542228182-06:00 stderr F 2024-12-12 20:41:37.540 DEBUG (MainThread) [homeassistant.components.mqtt.client] Subscribing with mid: 7 to topics with qos: [('homeassistant/device_automation/+/config', 0)]\r\n2024-12-12T20:41:37.542472441-06:00 stderr F 2024-12-12 20:41:37.541 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 33\r\n2024-12-12T20:41:37.543451910-06:00 stderr F 2024-12-12 20:41:37.542 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 33\r\n2024-12-12T20:41:37.543724879-06:00 stderr F 2024-12-12 20:41:37.543 DEBUG (MainThread) [homeassistant.components.mqtt.client] Subscribing with mid: 8 to topics with qos: [('homeassistant/device_tracker/+/config', 0)]\r\n2024-12-12T20:41:37.544245173-06:00 stderr F 2024-12-12 20:41:37.543 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 33\r\n2024-12-12T20:41:37.545090547-06:00 stderr F 2024-12-12 20:41:37.544 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 33\r\n2024-12-12T20:41:37.545345214-06:00 stderr F 2024-12-12 20:41:37.544 DEBUG (MainThread) [homeassistant.components.mqtt.client] Subscribing with mid: 9 to topics with qos: [('homeassistant/event/+/config', 0)]\r\n2024-12-12T20:41:37.545837317-06:00 stderr F 2024-12-12 20:41:37.545 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 33\r\n2024-12-12T20:41:37.546790293-06:00 stderr F 2024-12-12 20:41:37.546 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 33\r\n2024-12-12T20:41:37.547042182-06:00 stderr F 2024-12-12 20:41:37.546 DEBUG (MainThread) [homeassistant.components.mqtt.client] Subscribing with mid: 10 to topics with qos: [('homeassistant/fan/+/config', 0)]\r\n2024-12-12T20:41:37.547490594-06:00 stderr F 2024-12-12 20:41:37.547 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 33\r\n2024-12-12T20:41:37.548402560-06:00 stderr F 2024-12-12 20:41:37.547 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 33\r\n2024-12-12T20:41:37.548659556-06:00 stderr F 2024-12-12 20:41:37.547 DEBUG (MainThread) [homeassistant.components.mqtt.client] Subscribing with mid: 11 to topics with qos: [('homeassistant/humidifier/+/config', 0)]\r\n2024-12-12T20:41:37.549079945-06:00 stderr F 2024-12-12 20:41:37.548 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 33\r\n2024-12-12T20:41:37.550003273-06:00 stderr F 2024-12-12 20:41:37.549 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 33\r\n2024-12-12T20:41:37.550315929-06:00 stderr F 2024-12-12 20:41:37.549 DEBUG (MainThread) [homeassistant.components.mqtt.client] Subscribing with mid: 12 to topics with qos: [('homeassistant/image/+/config', 0)]\r\n2024-12-12T20:41:37.550747036-06:00 stderr F 2024-12-12 20:41:37.550 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 33\r\n2024-12-12T20:41:37.551584630-06:00 stderr F 2024-12-12 20:41:37.551 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 33\r\n2024-12-12T20:41:37.551824867-06:00 stderr F 2024-12-12 20:41:37.551 DEBUG (MainThread) [homeassistant.components.mqtt.client] Subscribing with mid: 13 to topics with qos: [('homeassistant/lawn_mower/+/config', 0)]\r\n2024-12-12T20:41:37.552273020-06:00 stderr F 2024-12-12 20:41:37.551 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 33\r\n2024-12-12T20:41:37.553111489-06:00 stderr F 2024-12-12 20:41:37.552 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 33\r\n2024-12-12T20:41:37.553349986-06:00 stderr F 2024-12-12 20:41:37.552 DEBUG (MainThread) [homeassistant.components.mqtt.client] Subscribing with mid: 14 to topics with qos: [('homeassistant/light/+/config', 0)]\r\n2024-12-12T20:41:37.553848525-06:00 stderr F 2024-12-12 20:41:37.553 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 33\r\n2024-12-12T20:41:37.554480973-06:00 stderr F 2024-12-12 20:41:37.554 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 33\r\n2024-12-12T20:41:37.555027835-06:00 stderr F 2024-12-12 20:41:37.554 DEBUG (MainThread) [homeassistant.components.mqtt.client] Subscribing with mid: 15 to topics with qos: [('homeassistant/lock/+/config', 0)]\r\n2024-12-12T20:41:37.555492164-06:00 stderr F 2024-12-12 20:41:37.555 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 33\r\n2024-12-12T20:41:37.556414519-06:00 stderr F 2024-12-12 20:41:37.555 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 33\r\n2024-12-12T20:41:37.556683925-06:00 stderr F 2024-12-12 20:41:37.555 DEBUG (MainThread) [homeassistant.components.mqtt.client] Subscribing with mid: 16 to topics with qos: [('homeassistant/notify/+/config', 0)]\r\n2024-12-12T20:41:37.557686382-06:00 stderr F 2024-12-12 20:41:37.556 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 33\r\n2024-12-12T20:41:37.557955668-06:00 stderr F 2024-12-12 20:41:37.557 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 33\r\n2024-12-12T20:41:37.558433476-06:00 stderr F 2024-12-12 20:41:37.557 DEBUG (MainThread) [homeassistant.components.mqtt.client] Subscribing with mid: 17 to topics with qos: [('homeassistant/number/+/config', 0)]\r\n2024-12-12T20:41:37.558944917-06:00 stderr F 2024-12-12 20:41:37.558 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 33\r\n2024-12-12T20:41:37.559797094-06:00 stderr F 2024-12-12 20:41:37.559 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 33\r\n2024-12-12T20:41:37.560050008-06:00 stderr F 2024-12-12 20:41:37.559 DEBUG (MainThread) [homeassistant.components.mqtt.client] Subscribing with mid: 18 to topics with qos: [('homeassistant/scene/+/config', 0)]\r\n2024-12-12T20:41:37.560537835-06:00 stderr F 2024-12-12 20:41:37.560 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 33\r\n2024-12-12T20:41:37.561515540-06:00 stderr F 2024-12-12 20:41:37.560 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 33\r\n2024-12-12T20:41:37.561777562-06:00 stderr F 2024-12-12 20:41:37.561 DEBUG (MainThread) [homeassistant.components.mqtt.client] Subscribing with mid: 19 to topics with qos: [('homeassistant/siren/+/config', 0)]\r\n2024-12-12T20:41:37.562441352-06:00 stderr F 2024-12-12 20:41:37.561 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 33\r\n2024-12-12T20:41:37.563006488-06:00 stderr F 2024-12-12 20:41:37.562 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 33\r\n2024-12-12T20:41:37.563434044-06:00 stderr F 2024-12-12 20:41:37.563 DEBUG (MainThread) [homeassistant.components.mqtt.client] Subscribing with mid: 20 to topics with qos: [('homeassistant/select/+/config', 0)]\r\n2024-12-12T20:41:37.564027407-06:00 stderr F 2024-12-12 20:41:37.563 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 33\r\n2024-12-12T20:41:37.565190851-06:00 stderr F 2024-12-12 20:41:37.564 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 33\r\n2024-12-12T20:41:37.565452419-06:00 stderr F 2024-12-12 20:41:37.564 DEBUG (MainThread) [homeassistant.components.mqtt.client] Subscribing with mid: 21 to topics with qos: [('homeassistant/sensor/+/config', 0)]\r\n2024-12-12T20:41:37.566691059-06:00 stderr F 2024-12-12 20:41:37.565 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 33\r\n2024-12-12T20:41:37.566902131-06:00 stderr F 2024-12-12 20:41:37.566 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 33\r\n2024-12-12T20:41:37.567130323-06:00 stderr F 2024-12-12 20:41:37.566 DEBUG (MainThread) [homeassistant.components.mqtt.client] Subscribing with mid: 22 to topics with qos: [('homeassistant/switch/+/config', 0)]\r\n2024-12-12T20:41:37.567547051-06:00 stderr F 2024-12-12 20:41:37.567 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 33\r\n2024-12-12T20:41:37.568619487-06:00 stderr F 2024-12-12 20:41:37.567 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 33\r\n2024-12-12T20:41:37.568775653-06:00 stderr F 2024-12-12 20:41:37.568 DEBUG (MainThread) [homeassistant.components.mqtt.client] Subscribing with mid: 23 to topics with qos: [('homeassistant/tag/+/config', 0)]\r\n2024-12-12T20:41:37.569520211-06:00 stderr F 2024-12-12 20:41:37.568 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 33\r\n2024-12-12T20:41:37.570595041-06:00 stderr F 2024-12-12 20:41:37.569 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 33\r\n2024-12-12T20:41:37.570890300-06:00 stderr F 2024-12-12 20:41:37.570 DEBUG (MainThread) [homeassistant.components.mqtt.client] Subscribing with mid: 24 to topics with qos: [('homeassistant/text/+/config', 0)]\r\n2024-12-12T20:41:37.571541811-06:00 stderr F 2024-12-12 20:41:37.570 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 33\r\n2024-12-12T20:41:37.572310058-06:00 stderr F 2024-12-12 20:41:37.571 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 33\r\n2024-12-12T20:41:37.573128253-06:00 stderr F 2024-12-12 20:41:37.572 DEBUG (MainThread) [homeassistant.components.mqtt.client] Subscribing with mid: 25 to topics with qos: [('homeassistant/update/+/config', 0)]\r\n2024-12-12T20:41:37.573400834-06:00 stderr F 2024-12-12 20:41:37.572 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 33\r\n2024-12-12T20:41:37.574714991-06:00 stderr F 2024-12-12 20:41:37.573 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 33\r\n2024-12-12T20:41:37.574991293-06:00 stderr F 2024-12-12 20:41:37.574 DEBUG (MainThread) [homeassistant.components.mqtt.client] Subscribing with mid: 26 to topics with qos: [('homeassistant/vacuum/+/config', 0)]\r\n2024-12-12T20:41:37.575602111-06:00 stderr F 2024-12-12 20:41:37.575 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 33\r\n2024-12-12T20:41:37.576771297-06:00 stderr F 2024-12-12 20:41:37.576 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 33\r\n2024-12-12T20:41:37.577063387-06:00 stderr F 2024-12-12 20:41:37.576 DEBUG (MainThread) [homeassistant.components.mqtt.client] Subscribing with mid: 27 to topics with qos: [('homeassistant/valve/+/config', 0)]\r\n2024-12-12T20:41:37.577632973-06:00 stderr F 2024-12-12 20:41:37.577 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 33\r\n2024-12-12T20:41:37.578617311-06:00 stderr F 2024-12-12 20:41:37.577 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 33\r\n2024-12-12T20:41:37.578896484-06:00 stderr F 2024-12-12 20:41:37.578 DEBUG (MainThread) [homeassistant.components.mqtt.client] Subscribing with mid: 28 to topics with qos: [('homeassistant/water_heater/+/config', 0)]\r\n2024-12-12T20:41:37.579470598-06:00 stderr F 2024-12-12 20:41:37.579 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 33\r\n2024-12-12T20:41:37.580266222-06:00 stderr F 2024-12-12 20:41:37.579 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 33\r\n2024-12-12T20:41:37.580900274-06:00 stderr F 2024-12-12 20:41:37.580 DEBUG (MainThread) [homeassistant.components.mqtt.client] Subscribing with mid: 29 to topics with qos: [('homeassistant/alarm_control_panel/+/+/config', 0)]\r\n2024-12-12T20:41:37.581535469-06:00 stderr F 2024-12-12 20:41:37.580 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 33\r\n2024-12-12T20:41:37.583227661-06:00 stderr F 2024-12-12 20:41:37.582 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 33\r\n2024-12-12T20:41:37.583428379-06:00 stderr F 2024-12-12 20:41:37.582 DEBUG (MainThread) [homeassistant.components.mqtt.client] Subscribing with mid: 30 to topics with qos: [('homeassistant/binary_sensor/+/+/config', 0)]\r\n2024-12-12T20:41:37.584057676-06:00 stderr F 2024-12-12 20:41:37.583 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 33\r\n2024-12-12T20:41:37.585101958-06:00 stderr F 2024-12-12 20:41:37.584 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 33\r\n2024-12-12T20:41:37.585365584-06:00 stderr F 2024-12-12 20:41:37.584 DEBUG (MainThread) [homeassistant.components.mqtt.client] Subscribing with mid: 31 to topics with qos: [('homeassistant/button/+/+/config', 0)]\r\n2024-12-12T20:41:37.585862101-06:00 stderr F 2024-12-12 20:41:37.585 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 33\r\n2024-12-12T20:41:37.586735304-06:00 stderr F 2024-12-12 20:41:37.586 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 33\r\n2024-12-12T20:41:37.587009009-06:00 stderr F 2024-12-12 20:41:37.586 DEBUG (MainThread) [homeassistant.components.mqtt.client] Subscribing with mid: 32 to topics with qos: [('homeassistant/camera/+/+/config', 0)]\r\n2024-12-12T20:41:37.587580974-06:00 stderr F 2024-12-12 20:41:37.587 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 33\r\n2024-12-12T20:41:37.588324163-06:00 stderr F 2024-12-12 20:41:37.587 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 33\r\n2024-12-12T20:41:37.588599642-06:00 stderr F 2024-12-12 20:41:37.587 DEBUG (MainThread) [homeassistant.components.mqtt.client] Subscribing with mid: 33 to topics with qos: [('homeassistant/climate/+/+/config', 0)]\r\n2024-12-12T20:41:37.589237112-06:00 stderr F 2024-12-12 20:41:37.588 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 33\r\n2024-12-12T20:41:37.590468345-06:00 stderr F 2024-12-12 20:41:37.589 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 33\r\n2024-12-12T20:41:37.590705431-06:00 stderr F 2024-12-12 20:41:37.589 DEBUG (MainThread) [homeassistant.components.mqtt.client] Subscribing with mid: 34 to topics with qos: [('homeassistant/cover/+/+/config', 0)]\r\n2024-12-12T20:41:37.591187294-06:00 stderr F 2024-12-12 20:41:37.590 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 33\r\n2024-12-12T20:41:37.592046945-06:00 stderr F 2024-12-12 20:41:37.591 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 33\r\n2024-12-12T20:41:37.592280404-06:00 stderr F 2024-12-12 20:41:37.591 DEBUG (MainThread) [homeassistant.components.mqtt.client] Subscribing with mid: 35 to topics with qos: [('homeassistant/device_automation/+/+/config', 0)]\r\n2024-12-12T20:41:37.592795817-06:00 stderr F 2024-12-12 20:41:37.592 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 33\r\n2024-12-12T20:41:37.593827057-06:00 stderr F 2024-12-12 20:41:37.593 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 33\r\n2024-12-12T20:41:37.594063197-06:00 stderr F 2024-12-12 20:41:37.593 DEBUG (MainThread) [homeassistant.components.mqtt.client] Subscribing with mid: 36 to topics with qos: [('homeassistant/device_tracker/+/+/config', 0)]\r\n2024-12-12T20:41:37.594614256-06:00 stderr F 2024-12-12 20:41:37.594 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 33\r\n2024-12-12T20:41:37.595433318-06:00 stderr F 2024-12-12 20:41:37.594 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 33\r\n2024-12-12T20:41:37.595767454-06:00 stderr F 2024-12-12 20:41:37.594 DEBUG (MainThread) [homeassistant.components.mqtt.client] Subscribing with mid: 37 to topics with qos: [('homeassistant/event/+/+/config', 0)]\r\n2024-12-12T20:41:37.596257057-06:00 stderr F 2024-12-12 20:41:37.595 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 33\r\n2024-12-12T20:41:37.596964648-06:00 stderr F 2024-12-12 20:41:37.596 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 33\r\n2024-12-12T20:41:37.597176603-06:00 stderr F 2024-12-12 20:41:37.596 DEBUG (MainThread) [homeassistant.components.mqtt.client] Subscribing with mid: 38 to topics with qos: [('homeassistant/fan/+/+/config', 0)]\r\n2024-12-12T20:41:37.597696855-06:00 stderr F 2024-12-12 20:41:37.597 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 33\r\n2024-12-12T20:41:37.598782217-06:00 stderr F 2024-12-12 20:41:37.598 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 33\r\n2024-12-12T20:41:37.599016349-06:00 stderr F 2024-12-12 20:41:37.598 DEBUG (MainThread) [homeassistant.components.mqtt.client] Subscribing with mid: 39 to topics with qos: [('homeassistant/humidifier/+/+/config', 0)]\r\n2024-12-12T20:41:37.600077089-06:00 stderr F 2024-12-12 20:41:37.599 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 33\r\n2024-12-12T20:41:37.600340081-06:00 stderr F 2024-12-12 20:41:37.599 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 33\r\n2024-12-12T20:41:37.600502358-06:00 stderr F 2024-12-12 20:41:37.599 DEBUG (MainThread) [homeassistant.components.mqtt.client] Subscribing with mid: 40 to topics with qos: [('homeassistant/image/+/+/config', 0)]\r\n2024-12-12T20:41:37.601062704-06:00 stderr F 2024-12-12 20:41:37.600 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 33\r\n2024-12-12T20:41:37.601954426-06:00 stderr F 2024-12-12 20:41:37.601 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 33\r\n2024-12-12T20:41:37.602226283-06:00 stderr F 2024-12-12 20:41:37.601 DEBUG (MainThread) [homeassistant.components.mqtt.client] Subscribing with mid: 41 to topics with qos: [('homeassistant/lawn_mower/+/+/config', 0)]\r\n2024-12-12T20:41:37.605922207-06:00 stderr F 2024-12-12 20:41:37.603 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 33\r\n2024-12-12T20:41:37.610106571-06:00 stderr F 2024-12-12 20:41:37.606 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 33\r\n2024-12-12T20:41:37.610106571-06:00 stderr F 2024-12-12 20:41:37.607 DEBUG (MainThread) [homeassistant.components.mqtt.client] Subscribing with mid: 42 to topics with qos: [('homeassistant/light/+/+/config', 0)]\r\n2024-12-12T20:41:37.610106571-06:00 stderr F 2024-12-12 20:41:37.607 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 33\r\n2024-12-12T20:41:37.610106571-06:00 stderr F 2024-12-12 20:41:37.608 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 33\r\n2024-12-12T20:41:37.610106571-06:00 stderr F 2024-12-12 20:41:37.608 DEBUG (MainThread) [homeassistant.components.mqtt.client] Subscribing with mid: 43 to topics with qos: [('homeassistant/lock/+/+/config', 0)]\r\n2024-12-12T20:41:37.610173237-06:00 stderr F 2024-12-12 20:41:37.609 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 33\r\n2024-12-12T20:41:37.611093756-06:00 stderr F 2024-12-12 20:41:37.610 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 33\r\n2024-12-12T20:41:37.611961870-06:00 stderr F 2024-12-12 20:41:37.611 DEBUG (MainThread) [homeassistant.components.mqtt.client] Subscribing with mid: 44 to topics with qos: [('homeassistant/notify/+/+/config', 0)]\r\n2024-12-12T20:41:37.612337996-06:00 stderr F 2024-12-12 20:41:37.611 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 33\r\n2024-12-12T20:41:37.613655968-06:00 stderr F 2024-12-12 20:41:37.612 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 33\r\n2024-12-12T20:41:37.614326679-06:00 stderr F 2024-12-12 20:41:37.613 DEBUG (MainThread) [homeassistant.components.mqtt.client] Subscribing with mid: 45 to topics with qos: [('homeassistant/number/+/+/config', 0)]\r\n2024-12-12T20:41:37.614642346-06:00 stderr F 2024-12-12 20:41:37.613 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 33\r\n2024-12-12T20:41:37.615618851-06:00 stderr F 2024-12-12 20:41:37.614 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 33\r\n2024-12-12T20:41:37.615896674-06:00 stderr F 2024-12-12 20:41:37.615 DEBUG (MainThread) [homeassistant.components.mqtt.client] Subscribing with mid: 46 to topics with qos: [('homeassistant/scene/+/+/config', 0)]\r\n2024-12-12T20:41:37.617268499-06:00 stderr F 2024-12-12 20:41:37.616 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 33\r\n2024-12-12T20:41:37.617495814-06:00 stderr F 2024-12-12 20:41:37.616 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 33\r\n2024-12-12T20:41:37.617813721-06:00 stderr F 2024-12-12 20:41:37.616 DEBUG (MainThread) [homeassistant.components.mqtt.client] Subscribing with mid: 47 to topics with qos: [('homeassistant/siren/+/+/config', 0)]\r\n2024-12-12T20:41:37.618448017-06:00 stderr F 2024-12-12 20:41:37.617 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 33\r\n2024-12-12T20:41:37.619316750-06:00 stderr F 2024-12-12 20:41:37.618 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 33\r\n2024-12-12T20:41:37.619718252-06:00 stderr F 2024-12-12 20:41:37.618 DEBUG (MainThread) [homeassistant.components.mqtt.client] Subscribing with mid: 48 to topics with qos: [('homeassistant/select/+/+/config', 0)]\r\n2024-12-12T20:41:37.620122968-06:00 stderr F 2024-12-12 20:41:37.619 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 33\r\n2024-12-12T20:41:37.620918506-06:00 stderr F 2024-12-12 20:41:37.620 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 33\r\n2024-12-12T20:41:37.621312490-06:00 stderr F 2024-12-12 20:41:37.620 DEBUG (MainThread) [homeassistant.components.mqtt.client] Subscribing with mid: 49 to topics with qos: [('homeassistant/sensor/+/+/config', 0)]\r\n2024-12-12T20:41:37.621873973-06:00 stderr F 2024-12-12 20:41:37.621 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 33\r\n2024-12-12T20:41:37.622805741-06:00 stderr F 2024-12-12 20:41:37.622 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 33\r\n2024-12-12T20:41:37.623034785-06:00 stderr F 2024-12-12 20:41:37.622 DEBUG (MainThread) [homeassistant.components.mqtt.client] Subscribing with mid: 50 to topics with qos: [('homeassistant/switch/+/+/config', 0)]\r\n2024-12-12T20:41:37.623532439-06:00 stderr F 2024-12-12 20:41:37.623 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 33\r\n2024-12-12T20:41:37.624109750-06:00 stderr F 2024-12-12 20:41:37.623 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 33\r\n2024-12-12T20:41:37.624539436-06:00 stderr F 2024-12-12 20:41:37.624 DEBUG (MainThread) [homeassistant.components.mqtt.client] Subscribing with mid: 51 to topics with qos: [('homeassistant/tag/+/+/config', 0)]\r\n2024-12-12T20:41:37.625046369-06:00 stderr F 2024-12-12 20:41:37.624 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 33\r\n2024-12-12T20:41:37.626219804-06:00 stderr F 2024-12-12 20:41:37.625 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 33\r\n2024-12-12T20:41:37.626656211-06:00 stderr F 2024-12-12 20:41:37.625 DEBUG (MainThread) [homeassistant.components.mqtt.client] Subscribing with mid: 52 to topics with qos: [('homeassistant/text/+/+/config', 0)]\r\n2024-12-12T20:41:37.627722360-06:00 stderr F 2024-12-12 20:41:37.626 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 33\r\n2024-12-12T20:41:37.627975327-06:00 stderr F 2024-12-12 20:41:37.627 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 33\r\n2024-12-12T20:41:37.628218626-06:00 stderr F 2024-12-12 20:41:37.627 DEBUG (MainThread) [homeassistant.components.mqtt.client] Subscribing with mid: 53 to topics with qos: [('homeassistant/update/+/+/config', 0)]\r\n2024-12-12T20:41:37.628765674-06:00 stderr F 2024-12-12 20:41:37.628 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 33\r\n2024-12-12T20:41:37.629988552-06:00 stderr F 2024-12-12 20:41:37.629 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 33\r\n2024-12-12T20:41:37.630286428-06:00 stderr F 2024-12-12 20:41:37.629 DEBUG (MainThread) [homeassistant.components.mqtt.client] Subscribing with mid: 54 to topics with qos: [('homeassistant/vacuum/+/+/config', 0)]\r\n2024-12-12T20:41:37.630823782-06:00 stderr F 2024-12-12 20:41:37.630 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 33\r\n2024-12-12T20:41:37.631628823-06:00 stderr F 2024-12-12 20:41:37.631 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 33\r\n2024-12-12T20:41:37.632015581-06:00 stderr F 2024-12-12 20:41:37.631 DEBUG (MainThread) [homeassistant.components.mqtt.client] Subscribing with mid: 55 to topics with qos: [('homeassistant/valve/+/+/config', 0)]\r\n2024-12-12T20:41:37.632559749-06:00 stderr F 2024-12-12 20:41:37.632 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 33\r\n2024-12-12T20:41:37.633190443-06:00 stderr F 2024-12-12 20:41:37.632 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 33\r\n2024-12-12T20:41:37.633746224-06:00 stderr F 2024-12-12 20:41:37.633 DEBUG (MainThread) [homeassistant.components.mqtt.client] Subscribing with mid: 56 to topics with qos: [('homeassistant/water_heater/+/+/config', 0)]\r\n2024-12-12T20:41:37.634339904-06:00 stderr F 2024-12-12 20:41:37.633 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 33\r\n2024-12-12T20:41:37.635381181-06:00 stderr F 2024-12-12 20:41:37.634 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 33\r\n2024-12-12T20:41:37.635616626-06:00 stderr F 2024-12-12 20:41:37.634 DEBUG (MainThread) [homeassistant.components.mqtt.client] Subscribing with mid: 57 to topics with qos: [('homeassistant/device/+/config', 0)]\r\n2024-12-12T20:41:37.636102460-06:00 stderr F 2024-12-12 20:41:37.635 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 33\r\n2024-12-12T20:41:37.636997441-06:00 stderr F 2024-12-12 20:41:37.636 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 33\r\n2024-12-12T20:41:37.637244704-06:00 stderr F 2024-12-12 20:41:37.636 DEBUG (MainThread) [homeassistant.components.mqtt.client] Subscribing with mid: 58 to topics with qos: [('homeassistant/device/+/+/config', 0)]\r\n2024-12-12T20:41:37.638284408-06:00 stderr F 2024-12-12 20:41:37.637 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 33\r\n2024-12-12T20:41:37.638974244-06:00 stderr F 2024-12-12 20:41:37.638 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 33\r\n2024-12-12T20:41:37.639518216-06:00 stderr F 2024-12-12 20:41:37.639 DEBUG (MainThread) [homeassistant.components.mqtt.client] Subscribing with mid: 59 to topics with qos: [('drop_connect/discovery/#', 0)]\r\n2024-12-12T20:41:37.640093338-06:00 stderr F 2024-12-12 20:41:37.639 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 33\r\n2024-12-12T20:41:37.640842670-06:00 stderr F 2024-12-12 20:41:37.640 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 33\r\n2024-12-12T20:41:37.641237668-06:00 stderr F 2024-12-12 20:41:37.640 DEBUG (MainThread) [homeassistant.components.mqtt.client] Subscribing with mid: 60 to topics with qos: [('dsmr/#', 0)]\r\n2024-12-12T20:41:37.641775439-06:00 stderr F 2024-12-12 20:41:37.641 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 33\r\n2024-12-12T20:41:37.642943662-06:00 stderr F 2024-12-12 20:41:37.642 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 33\r\n2024-12-12T20:41:37.643159801-06:00 stderr F 2024-12-12 20:41:37.642 DEBUG (MainThread) [homeassistant.components.mqtt.client] Subscribing with mid: 61 to topics with qos: [('esphome/discover/#', 0)]\r\n2024-12-12T20:41:37.643609208-06:00 stderr F 2024-12-12 20:41:37.643 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 33\r\n2024-12-12T20:41:37.644406417-06:00 stderr F 2024-12-12 20:41:37.643 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 33\r\n2024-12-12T20:41:37.644653300-06:00 stderr F 2024-12-12 20:41:37.644 DEBUG (MainThread) [homeassistant.components.mqtt.client] Subscribing with mid: 62 to topics with qos: [('fully/deviceInfo/+', 0)]\r\n2024-12-12T20:41:37.645215560-06:00 stderr F 2024-12-12 20:41:37.644 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 33\r\n2024-12-12T20:41:37.646724238-06:00 stderr F 2024-12-12 20:41:37.645 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 33\r\n2024-12-12T20:41:37.646976438-06:00 stderr F 2024-12-12 20:41:37.645 DEBUG (MainThread) [homeassistant.components.mqtt.client] Subscribing with mid: 63 to topics with qos: [('tasmota/discovery/#', 0)]\r\n2024-12-12T20:41:37.647523325-06:00 stderr F 2024-12-12 20:41:37.647 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 33\r\n2024-12-12T20:41:43.045746738-06:00 stderr F 2024-12-12 20:41:43.044 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 33\r\n2024-12-12T20:41:43.047892247-06:00 stderr F 2024-12-12 20:41:43.044 DEBUG (MainThread) [homeassistant.components.mqtt.client] Transmitting message on homeassistant/status: 'online', mid: 64, qos: 0\r\n2024-12-12T20:41:43.048191795-06:00 stderr F 2024-12-12 20:41:43.046 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 33\r\n2024-12-12T20:41:43.049005036-06:00 stderr F 2024-12-12 20:41:43.046 INFO (MainThread) [homeassistant.components.mqtt.client] MQTT client initialized, birth message sent\r\n2024-12-12T20:42:07.231247586-06:00 stderr F 2024-12-12 20:42:07.230 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 33\r\n2024-12-12T20:42:07.232576096-06:00 stderr F 2024-12-12 20:42:07.231 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 33\r\n2024-12-12T20:42:37.295438936-06:00 stderr F 2024-12-12 20:42:37.294 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 33\r\n2024-12-12T20:42:37.297241342-06:00 stderr F 2024-12-12 20:42:37.295 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 33\r\n2024-12-12T20:42:54.358887780-06:00 stderr F 2024-12-12 20:42:54.357 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: connection closed 33\r\n2024-12-12T20:42:54.359392611-06:00 stderr F 2024-12-12 20:42:54.359 DEBUG (MainThread) [homeassistant.components.mqtt.client] Disconnected from MQTT server mosquitto.mydomain.com:443 (7)\r\n2024-12-12T20:44:01.895801964-06:00 stderr F 2024-12-12 20:44:01.893 DEBUG (MainThread) [homeassistant.components.mqtt.client] Transmitting message on homeassistant/switch/1/power: 'OFF', mid: 65, qos: 0\r\n2024-12-12T20:44:01.902817117-06:00 stderr F 2024-12-12 20:44:01.893 ERROR (MainThread) [homeassistant.components.websocket_api.http.connection] [140635271788096] Unexpected exception\r\n2024-12-12T20:44:01.902817117-06:00 stderr F Traceback (most recent call last):\r\n2024-12-12T20:44:01.902817117-06:00 stderr F   File \"/usr/src/homeassistant/homeassistant/components/websocket_api/commands.py\", line 245, in handle_call_service\r\n2024-12-12T20:44:01.902817117-06:00 stderr F     response = await hass.services.async_call(\r\n2024-12-12T20:44:01.902817117-06:00 stderr F                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n2024-12-12T20:44:01.902817117-06:00 stderr F     ...<7 lines>...\r\n2024-12-12T20:44:01.902817117-06:00 stderr F     )\r\n2024-12-12T20:44:01.902817117-06:00 stderr F     ^\r\n2024-12-12T20:44:01.902817117-06:00 stderr F   File \"/usr/src/homeassistant/homeassistant/core.py\", line 2802, in async_call\r\n2024-12-12T20:44:01.902817117-06:00 stderr F     response_data = await coro\r\n2024-12-12T20:44:01.902817117-06:00 stderr F                     ^^^^^^^^^^\r\n2024-12-12T20:44:01.902817117-06:00 stderr F   File \"/usr/src/homeassistant/homeassistant/core.py\", line 2845, in _execute_service\r\n2024-12-12T20:44:01.902817117-06:00 stderr F     return await target(service_call)\r\n2024-12-12T20:44:01.902817117-06:00 stderr F            ^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n2024-12-12T20:44:01.902817117-06:00 stderr F   File \"/usr/src/homeassistant/homeassistant/components/mqtt/__init__.py\", line 316, in async_publish_service\r\n2024-12-12T20:44:01.902817117-06:00 stderr F     await mqtt_data.client.async_publish(msg_topic, payload, qos, retain)\r\n2024-12-12T20:44:01.902817117-06:00 stderr F   File \"/usr/src/homeassistant/homeassistant/components/mqtt/client.py\", line 646, in async_publish\r\n2024-12-12T20:44:01.902817117-06:00 stderr F     await self._async_wait_for_mid_or_raise(msg_info.mid, msg_info.rc)\r\n2024-12-12T20:44:01.902817117-06:00 stderr F   File \"/usr/src/homeassistant/homeassistant/components/mqtt/client.py\", line 1215, in _async_wait_for_mid_or_raise\r\n2024-12-12T20:44:01.902817117-06:00 stderr F     raise HomeAssistantError(\r\n2024-12-12T20:44:01.902817117-06:00 stderr F         f\"Error talking to MQTT: {mqtt.error_string(result_code)}\"\r\n2024-12-12T20:44:01.902817117-06:00 stderr F     )\r\n2024-12-12T20:44:01.902817117-06:00 stderr F homeassistant.exceptions.HomeAssistantError: Error talking to MQTT: The client is not currently connected.\r\n```\r\n\r\n</details>\nRight. It might be some custom integrations do block the event loop. The connection to the MQTT broker can be easiliy disturbed.\r\nIf you see messages in the logs, notifying the event loop is blocked, please notify the maintainers, or in case of a Home Assistant core integration blocking the event loop, open an issue to report this.\r\n\r\nI could not reproduce the issues you were seeing. I also restarted the broker while connected over WebSockets, but the connection recovered normally.\nIt is likely you have other issues that avoid a reconnection to take place.\nI\u2019ve tested restarting non gracefully killing the broker scenarios and it all recovered before.  We are going to need either an `strace` or some manual code mods to instrument the reconnect code to add more debug logging\nYou might get another hint as to what is going on by enabling asyncio debug.\n\nhttps://community.home-assistant.io/t/2024-5-tracking-down-instability-issues-caused-by-integrations/724441/1\nSince my whole setup is just a bunch of Docker containers, I decided to create a new instance of Home Assistance and do nothing with it but add the MQTT integration to test with.\r\n\r\nWhen I execute my same steps against a simple Docker container that has no persistence, no volumes / mounts, the default untouched configuration, default integrations only - but with MQTT added, I get the same results. The main difference with my test container is that I'm running it in bridge mode vs host since I don't need mdns discovery for any of this.\r\n\r\nStarting from a fresh, default Home Assistant Docker container:\r\n1. Swap my account to advanced mode to setup web socket mode in MQTT.\r\n2. Add the MQTT integration (the same config as posted above).\r\n3. Send a test message to a test topic via the config UI - success!\r\n4. Restart my Mosquitto broker service - connection is immediately lost from HA.\r\n5. Wait for for the broker to start back up. Watch other clients reconnect. HA does not.\r\n6. Attempt to send a test message to a test topic again - fails with \"Error talking to MQTT: The client is not currently connected\" error.\r\n\r\nIf I exec into the container and turn on debug logging for MQTT in the configuration.yaml, and then restart HA from the UI, the HA MQTT client connects and I see all of the usual debug logs of a healthy connection. Running my test again gets the same results, but now with the debug log output.\r\n\r\nI don't see anything different in the logs from what I last posted:\r\n<details>\r\n<summary>MQTT Debug Logs</summary>\r\n\r\n```\r\n2024-12-13T20:58:59.200150971-06:00 stderr F 2024-12-13 20:58:59.184 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: connection opened 22\r\n2024-12-13T20:58:59.203032280-06:00 stderr F 2024-12-13 20:58:59.185 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: Starting client misc loop\r\n2024-12-13T20:58:59.203899924-06:00 stderr F 2024-12-13 20:58:59.185 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 22\r\n2024-12-13T20:58:59.204115780-06:00 stderr F 2024-12-13 20:58:59.203 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 22\r\n2024-12-13T20:58:59.208098530-06:00 stderr F 2024-12-13 20:58:59.206 DEBUG (MainThread) [homeassistant.components.mqtt.client] Connected to MQTT server mosquitto.mydomain.com:443 (0)\r\n2024-12-13T20:58:59.711127145-06:00 stderr F 2024-12-13 20:58:59.709 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 22\r\n2024-12-13T20:58:59.711437186-06:00 stderr F 2024-12-13 20:58:59.710 DEBUG (MainThread) [homeassistant.components.mqtt.client] Subscribing with mid: 1 to topics with qos: [('homeassistant/alarm_control_panel/+/config', 0)]\r\n2024-12-13T20:58:59.712288694-06:00 stderr F 2024-12-13 20:58:59.711 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 22\r\n2024-12-13T20:58:59.714700681-06:00 stderr F 2024-12-13 20:58:59.713 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 22\r\n2024-12-13T20:58:59.714896281-06:00 stderr F 2024-12-13 20:58:59.713 DEBUG (MainThread) [homeassistant.components.mqtt.client] Subscribing with mid: 2 to topics with qos: [('homeassistant/binary_sensor/+/config', 0)]\r\n2024-12-13T20:58:59.715137281-06:00 stderr F 2024-12-13 20:58:59.713 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 22\r\n2024-12-13T20:58:59.716015646-06:00 stderr F 2024-12-13 20:58:59.715 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 22\r\n2024-12-13T20:58:59.716423828-06:00 stderr F 2024-12-13 20:58:59.716 DEBUG (MainThread) [homeassistant.components.mqtt.client] Subscribing with mid: 3 to topics with qos: [('homeassistant/button/+/config', 0)]\r\n2024-12-13T20:58:59.718003599-06:00 stderr F 2024-12-13 20:58:59.717 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 22\r\n2024-12-13T20:58:59.721468150-06:00 stderr F 2024-12-13 20:58:59.721 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 22\r\n2024-12-13T20:58:59.721966963-06:00 stderr F 2024-12-13 20:58:59.721 DEBUG (MainThread) [homeassistant.components.mqtt.client] Subscribing with mid: 4 to topics with qos: [('homeassistant/camera/+/config', 0)]\r\n2024-12-13T20:58:59.728226256-06:00 stderr F 2024-12-13 20:58:59.727 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 22\r\n2024-12-13T20:58:59.734744997-06:00 stderr F 2024-12-13 20:58:59.733 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 22\r\n2024-12-13T20:58:59.734999529-06:00 stderr F 2024-12-13 20:58:59.733 DEBUG (MainThread) [homeassistant.components.mqtt.client] Subscribing with mid: 5 to topics with qos: [('homeassistant/climate/+/config', 0)]\r\n2024-12-13T20:58:59.740782036-06:00 stderr F 2024-12-13 20:58:59.740 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 22\r\n2024-12-13T20:58:59.743159606-06:00 stderr F 2024-12-13 20:58:59.742 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 22\r\n2024-12-13T20:58:59.743392011-06:00 stderr F 2024-12-13 20:58:59.742 DEBUG (MainThread) [homeassistant.components.mqtt.client] Subscribing with mid: 6 to topics with qos: [('homeassistant/cover/+/config', 0)]\r\n2024-12-13T20:58:59.744134645-06:00 stderr F 2024-12-13 20:58:59.743 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 22\r\n2024-12-13T20:58:59.755919374-06:00 stderr F 2024-12-13 20:58:59.755 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 22\r\n2024-12-13T20:58:59.761741992-06:00 stderr F 2024-12-13 20:58:59.755 DEBUG (MainThread) [homeassistant.components.mqtt.client] Subscribing with mid: 7 to topics with qos: [('homeassistant/device_automation/+/config', 0)]\r\n2024-12-13T20:58:59.766660905-06:00 stderr F 2024-12-13 20:58:59.760 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 22\r\n2024-12-13T20:58:59.766941121-06:00 stderr F 2024-12-13 20:58:59.765 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 22\r\n2024-12-13T20:58:59.767222080-06:00 stderr F 2024-12-13 20:58:59.765 DEBUG (MainThread) [homeassistant.components.mqtt.client] Subscribing with mid: 8 to topics with qos: [('homeassistant/device_tracker/+/config', 0)]\r\n2024-12-13T20:58:59.767568759-06:00 stderr F 2024-12-13 20:58:59.766 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 22\r\n2024-12-13T20:58:59.768849209-06:00 stderr F 2024-12-13 20:58:59.768 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 22\r\n2024-12-13T20:58:59.770587516-06:00 stderr F 2024-12-13 20:58:59.768 DEBUG (MainThread) [homeassistant.components.mqtt.client] Subscribing with mid: 9 to topics with qos: [('homeassistant/event/+/config', 0)]\r\n2024-12-13T20:58:59.770843895-06:00 stderr F 2024-12-13 20:58:59.769 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 22\r\n2024-12-13T20:58:59.772213656-06:00 stderr F 2024-12-13 20:58:59.771 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 22\r\n2024-12-13T20:58:59.772455888-06:00 stderr F 2024-12-13 20:58:59.771 DEBUG (MainThread) [homeassistant.components.mqtt.client] Subscribing with mid: 10 to topics with qos: [('homeassistant/fan/+/config', 0)]\r\n2024-12-13T20:58:59.774400589-06:00 stderr F 2024-12-13 20:58:59.773 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 22\r\n2024-12-13T20:58:59.783111872-06:00 stderr F 2024-12-13 20:58:59.778 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 22\r\n2024-12-13T20:58:59.783419887-06:00 stderr F 2024-12-13 20:58:59.778 DEBUG (MainThread) [homeassistant.components.mqtt.client] Subscribing with mid: 11 to topics with qos: [('homeassistant/humidifier/+/config', 0)]\r\n2024-12-13T20:58:59.783694671-06:00 stderr F 2024-12-13 20:58:59.779 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 22\r\n2024-12-13T20:58:59.783888763-06:00 stderr F 2024-12-13 20:58:59.782 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 22\r\n2024-12-13T20:58:59.784124352-06:00 stderr F 2024-12-13 20:58:59.782 DEBUG (MainThread) [homeassistant.components.mqtt.client] Subscribing with mid: 12 to topics with qos: [('homeassistant/image/+/config', 0)]\r\n2024-12-13T20:58:59.784877421-06:00 stderr F 2024-12-13 20:58:59.784 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 22\r\n2024-12-13T20:58:59.787347227-06:00 stderr F 2024-12-13 20:58:59.786 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 22\r\n2024-12-13T20:58:59.787582941-06:00 stderr F 2024-12-13 20:58:59.786 DEBUG (MainThread) [homeassistant.components.mqtt.client] Subscribing with mid: 13 to topics with qos: [('homeassistant/lawn_mower/+/config', 0)]\r\n2024-12-13T20:58:59.788763901-06:00 stderr F 2024-12-13 20:58:59.787 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 22\r\n2024-12-13T20:58:59.798953841-06:00 stderr F 2024-12-13 20:58:59.789 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 22\r\n2024-12-13T20:58:59.799307245-06:00 stderr F 2024-12-13 20:58:59.790 DEBUG (MainThread) [homeassistant.components.mqtt.client] Subscribing with mid: 14 to topics with qos: [('homeassistant/light/+/config', 0)]\r\n2024-12-13T20:58:59.799609045-06:00 stderr F 2024-12-13 20:58:59.796 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 22\r\n2024-12-13T20:58:59.807687188-06:00 stderr F 2024-12-13 20:58:59.801 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 22\r\n2024-12-13T20:58:59.807977296-06:00 stderr F 2024-12-13 20:58:59.801 DEBUG (MainThread) [homeassistant.components.mqtt.client] Subscribing with mid: 15 to topics with qos: [('homeassistant/lock/+/config', 0)]\r\n2024-12-13T20:58:59.816432209-06:00 stderr F 2024-12-13 20:58:59.815 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 22\r\n2024-12-13T20:58:59.816733601-06:00 stderr F 2024-12-13 20:58:59.815 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 22\r\n2024-12-13T20:58:59.830278492-06:00 stderr F 2024-12-13 20:58:59.815 DEBUG (MainThread) [homeassistant.components.mqtt.client] Subscribing with mid: 16 to topics with qos: [('homeassistant/notify/+/config', 0)]\r\n2024-12-13T20:58:59.830539902-06:00 stderr F 2024-12-13 20:58:59.822 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 22\r\n2024-12-13T20:58:59.846849466-06:00 stderr F 2024-12-13 20:58:59.836 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 22\r\n2024-12-13T20:58:59.847087177-06:00 stderr F 2024-12-13 20:58:59.836 DEBUG (MainThread) [homeassistant.components.mqtt.client] Subscribing with mid: 17 to topics with qos: [('homeassistant/number/+/config', 0)]\r\n2024-12-13T20:58:59.851715325-06:00 stderr F 2024-12-13 20:58:59.850 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 22\r\n2024-12-13T20:58:59.853269491-06:00 stderr F 2024-12-13 20:58:59.852 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 22\r\n2024-12-13T20:58:59.854355723-06:00 stderr F 2024-12-13 20:58:59.852 DEBUG (MainThread) [homeassistant.components.mqtt.client] Subscribing with mid: 18 to topics with qos: [('homeassistant/scene/+/config', 0)]\r\n2024-12-13T20:58:59.855696990-06:00 stderr F 2024-12-13 20:58:59.853 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 22\r\n2024-12-13T20:58:59.856873237-06:00 stderr F 2024-12-13 20:58:59.856 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 22\r\n2024-12-13T20:58:59.857048669-06:00 stderr F 2024-12-13 20:58:59.856 DEBUG (MainThread) [homeassistant.components.mqtt.client] Subscribing with mid: 19 to topics with qos: [('homeassistant/siren/+/config', 0)]\r\n2024-12-13T20:58:59.857545061-06:00 stderr F 2024-12-13 20:58:59.857 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 22\r\n2024-12-13T20:58:59.860217166-06:00 stderr F 2024-12-13 20:58:59.859 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 22\r\n2024-12-13T20:58:59.860407816-06:00 stderr F 2024-12-13 20:58:59.859 DEBUG (MainThread) [homeassistant.components.mqtt.client] Subscribing with mid: 20 to topics with qos: [('homeassistant/select/+/config', 0)]\r\n2024-12-13T20:58:59.860630658-06:00 stderr F 2024-12-13 20:58:59.859 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 22\r\n2024-12-13T20:58:59.863789422-06:00 stderr F 2024-12-13 20:58:59.862 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 22\r\n2024-12-13T20:58:59.872036201-06:00 stderr F 2024-12-13 20:58:59.862 DEBUG (MainThread) [homeassistant.components.mqtt.client] Subscribing with mid: 21 to topics with qos: [('homeassistant/sensor/+/config', 0)]\r\n2024-12-13T20:58:59.872335930-06:00 stderr F 2024-12-13 20:58:59.863 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 22\r\n2024-12-13T20:58:59.873162052-06:00 stderr F 2024-12-13 20:58:59.872 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 22\r\n2024-12-13T20:58:59.873454190-06:00 stderr F 2024-12-13 20:58:59.872 DEBUG (MainThread) [homeassistant.components.mqtt.client] Subscribing with mid: 22 to topics with qos: [('homeassistant/switch/+/config', 0)]\r\n2024-12-13T20:58:59.881010324-06:00 stderr F 2024-12-13 20:58:59.880 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 22\r\n2024-12-13T20:58:59.895503958-06:00 stderr F 2024-12-13 20:58:59.893 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 22\r\n2024-12-13T20:58:59.896951670-06:00 stderr F 2024-12-13 20:58:59.893 DEBUG (MainThread) [homeassistant.components.mqtt.client] Subscribing with mid: 23 to topics with qos: [('homeassistant/tag/+/config', 0)]\r\n2024-12-13T20:58:59.897295519-06:00 stderr F 2024-12-13 20:58:59.894 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 22\r\n2024-12-13T20:58:59.903831154-06:00 stderr F 2024-12-13 20:58:59.903 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 22\r\n2024-12-13T20:58:59.904078795-06:00 stderr F 2024-12-13 20:58:59.903 DEBUG (MainThread) [homeassistant.components.mqtt.client] Subscribing with mid: 24 to topics with qos: [('homeassistant/text/+/config', 0)]\r\n2024-12-13T20:58:59.910352364-06:00 stderr F 2024-12-13 20:58:59.904 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 22\r\n2024-12-13T20:58:59.913458907-06:00 stderr F 2024-12-13 20:58:59.912 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 22\r\n2024-12-13T20:58:59.914262643-06:00 stderr F 2024-12-13 20:58:59.913 DEBUG (MainThread) [homeassistant.components.mqtt.client] Subscribing with mid: 25 to topics with qos: [('homeassistant/update/+/config', 0)]\r\n2024-12-13T20:58:59.920567341-06:00 stderr F 2024-12-13 20:58:59.914 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 22\r\n2024-12-13T20:58:59.938989672-06:00 stderr F 2024-12-13 20:58:59.934 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 22\r\n2024-12-13T20:58:59.939226136-06:00 stderr F 2024-12-13 20:58:59.934 DEBUG (MainThread) [homeassistant.components.mqtt.client] Subscribing with mid: 26 to topics with qos: [('homeassistant/vacuum/+/config', 0)]\r\n2024-12-13T20:58:59.939880895-06:00 stderr F 2024-12-13 20:58:59.939 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 22\r\n2024-12-13T20:58:59.941063588-06:00 stderr F 2024-12-13 20:58:59.940 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 22\r\n2024-12-13T20:58:59.941694007-06:00 stderr F 2024-12-13 20:58:59.941 DEBUG (MainThread) [homeassistant.components.mqtt.client] Subscribing with mid: 27 to topics with qos: [('homeassistant/valve/+/config', 0)]\r\n2024-12-13T20:58:59.942143678-06:00 stderr F 2024-12-13 20:58:59.941 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 22\r\n2024-12-13T20:58:59.944264100-06:00 stderr F 2024-12-13 20:58:59.943 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 22\r\n2024-12-13T20:58:59.945041855-06:00 stderr F 2024-12-13 20:58:59.944 DEBUG (MainThread) [homeassistant.components.mqtt.client] Subscribing with mid: 28 to topics with qos: [('homeassistant/water_heater/+/config', 0)]\r\n2024-12-13T20:58:59.948512778-06:00 stderr F 2024-12-13 20:58:59.948 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 22\r\n2024-12-13T20:58:59.952783429-06:00 stderr F 2024-12-13 20:58:59.952 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 22\r\n2024-12-13T20:58:59.953322810-06:00 stderr F 2024-12-13 20:58:59.952 DEBUG (MainThread) [homeassistant.components.mqtt.client] Subscribing with mid: 29 to topics with qos: [('homeassistant/alarm_control_panel/+/+/config', 0)]\r\n2024-12-13T20:58:59.959166307-06:00 stderr F 2024-12-13 20:58:59.953 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 22\r\n2024-12-13T20:58:59.968038100-06:00 stderr F 2024-12-13 20:58:59.967 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 22\r\n2024-12-13T20:58:59.968267702-06:00 stderr F 2024-12-13 20:58:59.967 DEBUG (MainThread) [homeassistant.components.mqtt.client] Subscribing with mid: 30 to topics with qos: [('homeassistant/binary_sensor/+/+/config', 0)]\r\n2024-12-13T20:58:59.968892197-06:00 stderr F 2024-12-13 20:58:59.968 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 22\r\n2024-12-13T20:58:59.973087606-06:00 stderr F 2024-12-13 20:58:59.972 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 22\r\n2024-12-13T20:58:59.973725481-06:00 stderr F 2024-12-13 20:58:59.973 DEBUG (MainThread) [homeassistant.components.mqtt.client] Subscribing with mid: 31 to topics with qos: [('homeassistant/button/+/+/config', 0)]\r\n2024-12-13T20:58:59.974260229-06:00 stderr F 2024-12-13 20:58:59.973 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 22\r\n2024-12-13T20:58:59.977205501-06:00 stderr F 2024-12-13 20:58:59.976 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 22\r\n2024-12-13T20:58:59.977604815-06:00 stderr F 2024-12-13 20:58:59.977 DEBUG (MainThread) [homeassistant.components.mqtt.client] Subscribing with mid: 32 to topics with qos: [('homeassistant/camera/+/+/config', 0)]\r\n2024-12-13T20:59:00.005067443-06:00 stderr F 2024-12-13 20:59:00.004 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 22\r\n2024-12-13T20:59:00.007743154-06:00 stderr F 2024-12-13 20:59:00.006 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 22\r\n2024-12-13T20:59:00.007955473-06:00 stderr F 2024-12-13 20:59:00.007 DEBUG (MainThread) [homeassistant.components.mqtt.client] Subscribing with mid: 33 to topics with qos: [('homeassistant/climate/+/+/config', 0)]\r\n2024-12-13T20:59:00.012578466-06:00 stderr F 2024-12-13 20:59:00.012 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 22\r\n2024-12-13T20:59:00.040430233-06:00 stderr F 2024-12-13 20:59:00.026 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 22\r\n2024-12-13T20:59:00.040729569-06:00 stderr F 2024-12-13 20:59:00.026 DEBUG (MainThread) [homeassistant.components.mqtt.client] Subscribing with mid: 34 to topics with qos: [('homeassistant/cover/+/+/config', 0)]\r\n2024-12-13T20:59:00.047012523-06:00 stderr F 2024-12-13 20:59:00.046 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 22\r\n2024-12-13T20:59:00.079044046-06:00 stderr F 2024-12-13 20:59:00.072 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 22\r\n2024-12-13T20:59:00.079267939-06:00 stderr F 2024-12-13 20:59:00.072 DEBUG (MainThread) [homeassistant.components.mqtt.client] Subscribing with mid: 35 to topics with qos: [('homeassistant/device_automation/+/+/config', 0)]\r\n2024-12-13T20:59:00.082471722-06:00 stderr F 2024-12-13 20:59:00.079 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 22\r\n2024-12-13T20:59:00.085562055-06:00 stderr F 2024-12-13 20:59:00.082 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 22\r\n2024-12-13T20:59:00.085809401-06:00 stderr F 2024-12-13 20:59:00.083 DEBUG (MainThread) [homeassistant.components.mqtt.client] Subscribing with mid: 36 to topics with qos: [('homeassistant/device_tracker/+/+/config', 0)]\r\n2024-12-13T20:59:00.086324626-06:00 stderr F 2024-12-13 20:59:00.085 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 22\r\n2024-12-13T20:59:00.089177609-06:00 stderr F 2024-12-13 20:59:00.088 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 22\r\n2024-12-13T20:59:00.089508594-06:00 stderr F 2024-12-13 20:59:00.088 DEBUG (MainThread) [homeassistant.components.mqtt.client] Subscribing with mid: 37 to topics with qos: [('homeassistant/event/+/+/config', 0)]\r\n2024-12-13T20:59:00.090934426-06:00 stderr F 2024-12-13 20:59:00.090 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 22\r\n2024-12-13T20:59:00.093687848-06:00 stderr F 2024-12-13 20:59:00.093 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 22\r\n2024-12-13T20:59:00.093949309-06:00 stderr F 2024-12-13 20:59:00.093 DEBUG (MainThread) [homeassistant.components.mqtt.client] Subscribing with mid: 38 to topics with qos: [('homeassistant/fan/+/+/config', 0)]\r\n2024-12-13T20:59:00.094509439-06:00 stderr F 2024-12-13 20:59:00.094 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 22\r\n2024-12-13T20:59:00.096690449-06:00 stderr F 2024-12-13 20:59:00.096 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 22\r\n2024-12-13T20:59:00.096936835-06:00 stderr F 2024-12-13 20:59:00.096 DEBUG (MainThread) [homeassistant.components.mqtt.client] Subscribing with mid: 39 to topics with qos: [('homeassistant/humidifier/+/+/config', 0)]\r\n2024-12-13T20:59:00.097707602-06:00 stderr F 2024-12-13 20:59:00.097 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 22\r\n2024-12-13T20:59:00.099443966-06:00 stderr F 2024-12-13 20:59:00.098 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 22\r\n2024-12-13T20:59:00.100673870-06:00 stderr F 2024-12-13 20:59:00.098 DEBUG (MainThread) [homeassistant.components.mqtt.client] Subscribing with mid: 40 to topics with qos: [('homeassistant/image/+/+/config', 0)]\r\n2024-12-13T20:59:00.100950510-06:00 stderr F 2024-12-13 20:59:00.099 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 22\r\n2024-12-13T20:59:00.103142084-06:00 stderr F 2024-12-13 20:59:00.101 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 22\r\n2024-12-13T20:59:00.103709876-06:00 stderr F 2024-12-13 20:59:00.101 DEBUG (MainThread) [homeassistant.components.mqtt.client] Subscribing with mid: 41 to topics with qos: [('homeassistant/lawn_mower/+/+/config', 0)]\r\n2024-12-13T20:59:00.103980166-06:00 stderr F 2024-12-13 20:59:00.102 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 22\r\n2024-12-13T20:59:00.109024712-06:00 stderr F 2024-12-13 20:59:00.104 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 22\r\n2024-12-13T20:59:00.109024712-06:00 stderr F 2024-12-13 20:59:00.104 DEBUG (MainThread) [homeassistant.components.mqtt.client] Subscribing with mid: 42 to topics with qos: [('homeassistant/light/+/+/config', 0)]\r\n2024-12-13T20:59:00.109024712-06:00 stderr F 2024-12-13 20:59:00.105 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 22\r\n2024-12-13T20:59:00.109587248-06:00 stderr F 2024-12-13 20:59:00.108 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 22\r\n2024-12-13T20:59:00.109838087-06:00 stderr F 2024-12-13 20:59:00.108 DEBUG (MainThread) [homeassistant.components.mqtt.client] Subscribing with mid: 43 to topics with qos: [('homeassistant/lock/+/+/config', 0)]\r\n2024-12-13T20:59:00.110098462-06:00 stderr F 2024-12-13 20:59:00.109 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 22\r\n2024-12-13T20:59:00.111962271-06:00 stderr F 2024-12-13 20:59:00.111 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 22\r\n2024-12-13T20:59:00.112273819-06:00 stderr F 2024-12-13 20:59:00.111 DEBUG (MainThread) [homeassistant.components.mqtt.client] Subscribing with mid: 44 to topics with qos: [('homeassistant/notify/+/+/config', 0)]\r\n2024-12-13T20:59:00.113036801-06:00 stderr F 2024-12-13 20:59:00.112 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 22\r\n2024-12-13T20:59:00.126770773-06:00 stderr F 2024-12-13 20:59:00.125 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 22\r\n2024-12-13T20:59:00.127031946-06:00 stderr F 2024-12-13 20:59:00.126 DEBUG (MainThread) [homeassistant.components.mqtt.client] Subscribing with mid: 45 to topics with qos: [('homeassistant/number/+/+/config', 0)]\r\n2024-12-13T20:59:00.127874771-06:00 stderr F 2024-12-13 20:59:00.127 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 22\r\n2024-12-13T20:59:00.130656913-06:00 stderr F 2024-12-13 20:59:00.129 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 22\r\n2024-12-13T20:59:00.130922721-06:00 stderr F 2024-12-13 20:59:00.130 DEBUG (MainThread) [homeassistant.components.mqtt.client] Subscribing with mid: 46 to topics with qos: [('homeassistant/scene/+/+/config', 0)]\r\n2024-12-13T20:59:00.131567575-06:00 stderr F 2024-12-13 20:59:00.131 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 22\r\n2024-12-13T20:59:00.135162404-06:00 stderr F 2024-12-13 20:59:00.134 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 22\r\n2024-12-13T20:59:00.136378826-06:00 stderr F 2024-12-13 20:59:00.135 DEBUG (MainThread) [homeassistant.components.mqtt.client] Subscribing with mid: 47 to topics with qos: [('homeassistant/siren/+/+/config', 0)]\r\n2024-12-13T20:59:00.136991416-06:00 stderr F 2024-12-13 20:59:00.136 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 22\r\n2024-12-13T20:59:00.139499876-06:00 stderr F 2024-12-13 20:59:00.138 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 22\r\n2024-12-13T20:59:00.139775042-06:00 stderr F 2024-12-13 20:59:00.138 DEBUG (MainThread) [homeassistant.components.mqtt.client] Subscribing with mid: 48 to topics with qos: [('homeassistant/select/+/+/config', 0)]\r\n2024-12-13T20:59:00.143630402-06:00 stderr F 2024-12-13 20:59:00.141 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 22\r\n2024-12-13T20:59:00.143914827-06:00 stderr F 2024-12-13 20:59:00.142 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 22\r\n2024-12-13T20:59:00.144366407-06:00 stderr F 2024-12-13 20:59:00.142 DEBUG (MainThread) [homeassistant.components.mqtt.client] Subscribing with mid: 49 to topics with qos: [('homeassistant/sensor/+/+/config', 0)]\r\n2024-12-13T20:59:00.144420729-06:00 stderr F 2024-12-13 20:59:00.142 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 22\r\n2024-12-13T20:59:00.146333782-06:00 stderr F 2024-12-13 20:59:00.145 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 22\r\n2024-12-13T20:59:00.147306140-06:00 stderr F 2024-12-13 20:59:00.145 DEBUG (MainThread) [homeassistant.components.mqtt.client] Subscribing with mid: 50 to topics with qos: [('homeassistant/switch/+/+/config', 0)]\r\n2024-12-13T20:59:00.147620987-06:00 stderr F 2024-12-13 20:59:00.146 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 22\r\n2024-12-13T20:59:00.150065989-06:00 stderr F 2024-12-13 20:59:00.149 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 22\r\n2024-12-13T20:59:00.150594661-06:00 stderr F 2024-12-13 20:59:00.149 DEBUG (MainThread) [homeassistant.components.mqtt.client] Subscribing with mid: 51 to topics with qos: [('homeassistant/tag/+/+/config', 0)]\r\n2024-12-13T20:59:00.151332312-06:00 stderr F 2024-12-13 20:59:00.150 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 22\r\n2024-12-13T20:59:00.158886493-06:00 stderr F 2024-12-13 20:59:00.156 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 22\r\n2024-12-13T20:59:00.159213257-06:00 stderr F 2024-12-13 20:59:00.156 DEBUG (MainThread) [homeassistant.components.mqtt.client] Subscribing with mid: 52 to topics with qos: [('homeassistant/text/+/+/config', 0)]\r\n2024-12-13T20:59:00.160820370-06:00 stderr F 2024-12-13 20:59:00.159 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 22\r\n2024-12-13T20:59:00.163215221-06:00 stderr F 2024-12-13 20:59:00.162 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 22\r\n2024-12-13T20:59:00.163541492-06:00 stderr F 2024-12-13 20:59:00.162 DEBUG (MainThread) [homeassistant.components.mqtt.client] Subscribing with mid: 53 to topics with qos: [('homeassistant/update/+/+/config', 0)]\r\n2024-12-13T20:59:00.164536070-06:00 stderr F 2024-12-13 20:59:00.163 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 22\r\n2024-12-13T20:59:00.166599904-06:00 stderr F 2024-12-13 20:59:00.165 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 22\r\n2024-12-13T20:59:00.167742690-06:00 stderr F 2024-12-13 20:59:00.165 DEBUG (MainThread) [homeassistant.components.mqtt.client] Subscribing with mid: 54 to topics with qos: [('homeassistant/vacuum/+/+/config', 0)]\r\n2024-12-13T20:59:00.168785735-06:00 stderr F 2024-12-13 20:59:00.168 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 22\r\n2024-12-13T20:59:00.170519702-06:00 stderr F 2024-12-13 20:59:00.169 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 22\r\n2024-12-13T20:59:00.170822087-06:00 stderr F 2024-12-13 20:59:00.169 DEBUG (MainThread) [homeassistant.components.mqtt.client] Subscribing with mid: 55 to topics with qos: [('homeassistant/valve/+/+/config', 0)]\r\n2024-12-13T20:59:00.171244915-06:00 stderr F 2024-12-13 20:59:00.170 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 22\r\n2024-12-13T20:59:00.175154507-06:00 stderr F 2024-12-13 20:59:00.174 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 22\r\n2024-12-13T20:59:00.175433046-06:00 stderr F 2024-12-13 20:59:00.174 DEBUG (MainThread) [homeassistant.components.mqtt.client] Subscribing with mid: 56 to topics with qos: [('homeassistant/water_heater/+/+/config', 0)]\r\n2024-12-13T20:59:00.175879426-06:00 stderr F 2024-12-13 20:59:00.175 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 22\r\n2024-12-13T20:59:00.178987679-06:00 stderr F 2024-12-13 20:59:00.178 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 22\r\n2024-12-13T20:59:00.179648902-06:00 stderr F 2024-12-13 20:59:00.178 DEBUG (MainThread) [homeassistant.components.mqtt.client] Subscribing with mid: 57 to topics with qos: [('homeassistant/device/+/config', 0)]\r\n2024-12-13T20:59:00.179955411-06:00 stderr F 2024-12-13 20:59:00.179 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 22\r\n2024-12-13T20:59:00.185276708-06:00 stderr F 2024-12-13 20:59:00.184 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 22\r\n2024-12-13T20:59:00.185688706-06:00 stderr F 2024-12-13 20:59:00.184 DEBUG (MainThread) [homeassistant.components.mqtt.client] Subscribing with mid: 58 to topics with qos: [('homeassistant/device/+/+/config', 0)]\r\n2024-12-13T20:59:00.189432281-06:00 stderr F 2024-12-13 20:59:00.186 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 22\r\n2024-12-13T20:59:00.190901863-06:00 stderr F 2024-12-13 20:59:00.187 ERROR (SyncWorker_1) [aiodhcpwatcher] Cannot watch for dhcp packets: [Errno 1] Operation not permitted\r\n2024-12-13T20:59:00.192818905-06:00 stderr F 2024-12-13 20:59:00.191 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 22\r\n2024-12-13T20:59:00.193053468-06:00 stderr F 2024-12-13 20:59:00.191 DEBUG (MainThread) [homeassistant.components.mqtt.client] Subscribing with mid: 59 to topics with qos: [('drop_connect/discovery/#', 0)]\r\n2024-12-13T20:59:00.196103425-06:00 stderr F 2024-12-13 20:59:00.194 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 22\r\n2024-12-13T20:59:00.202546569-06:00 stderr F 2024-12-13 20:59:00.201 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 22\r\n2024-12-13T20:59:00.202887537-06:00 stderr F 2024-12-13 20:59:00.201 DEBUG (MainThread) [homeassistant.components.mqtt.client] Subscribing with mid: 60 to topics with qos: [('dsmr/#', 0)]\r\n2024-12-13T20:59:00.207476946-06:00 stderr F 2024-12-13 20:59:00.206 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 22\r\n2024-12-13T20:59:00.210002789-06:00 stderr F 2024-12-13 20:59:00.208 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 22\r\n2024-12-13T20:59:00.210301744-06:00 stderr F 2024-12-13 20:59:00.208 DEBUG (MainThread) [homeassistant.components.mqtt.client] Subscribing with mid: 61 to topics with qos: [('esphome/discover/#', 0)]\r\n2024-12-13T20:59:00.210967104-06:00 stderr F 2024-12-13 20:59:00.209 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 22\r\n2024-12-13T20:59:00.212297038-06:00 stderr F 2024-12-13 20:59:00.211 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 22\r\n2024-12-13T20:59:00.212572212-06:00 stderr F 2024-12-13 20:59:00.211 DEBUG (MainThread) [homeassistant.components.mqtt.client] Subscribing with mid: 62 to topics with qos: [('fully/deviceInfo/+', 0)]\r\n2024-12-13T20:59:00.213260220-06:00 stderr F 2024-12-13 20:59:00.212 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 22\r\n2024-12-13T20:59:00.217233977-06:00 stderr F 2024-12-13 20:59:00.216 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 22\r\n2024-12-13T20:59:00.219410746-06:00 stderr F 2024-12-13 20:59:00.218 DEBUG (MainThread) [homeassistant.components.mqtt.client] Subscribing with mid: 63 to topics with qos: [('tasmota/discovery/#', 0)]\r\n2024-12-13T20:59:00.221050886-06:00 stderr F 2024-12-13 20:59:00.219 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 22\r\n2024-12-13T20:59:05.221184517-06:00 stderr F 2024-12-13 20:59:05.220 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 22\r\n2024-12-13T20:59:05.221475342-06:00 stderr F 2024-12-13 20:59:05.220 DEBUG (MainThread) [homeassistant.components.mqtt.client] Transmitting message on homeassistant/status: 'online', mid: 64, qos: 0\r\n2024-12-13T20:59:05.222088887-06:00 stderr F 2024-12-13 20:59:05.221 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 22\r\n2024-12-13T20:59:05.222740798-06:00 stderr F 2024-12-13 20:59:05.222 INFO (MainThread) [homeassistant.components.mqtt.client] MQTT client initialized, birth message sent\r\n2024-12-13T20:59:18.603167289-06:00 stderr F 2024-12-13 20:59:18.601 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 22\r\n2024-12-13T20:59:18.605734418-06:00 stderr F 2024-12-13 20:59:18.602 DEBUG (MainThread) [homeassistant.components.mqtt.client] Transmitting message on homeassistant/switch/1/power: 'OFF', mid: 65, qos: 0\r\n2024-12-13T20:59:18.606009345-06:00 stderr F 2024-12-13 20:59:18.603 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 22\r\n2024-12-13T20:59:27.979391384-06:00 stderr F 2024-12-13 20:59:27.977 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: connection closed 22\r\n2024-12-13T20:59:27.980029244-06:00 stderr F 2024-12-13 20:59:27.979 DEBUG (MainThread) [homeassistant.components.mqtt.client] Disconnected from MQTT server mosquitto.mydomain.com:443 (7)\r\n```\r\n\r\n</details>\r\n\r\nI only have fragments of time to troubleshoot at the moment. I'll try the same test this weekend some time with debug logging on for everything to see if that turns up anything.\r\n", "created_at": "2024-12-20T09:53:21Z"}
{"repo": "home-assistant/core", "pull_number": 133610, "instance_id": "home-assistant__core-133610", "issue_numbers": ["132985"], "base_commit": "b261c7f18ab7fad9ab7deb49e33440f2906305c5", "patch": "diff --git a/homeassistant/components/mqtt/client.py b/homeassistant/components/mqtt/client.py\nindex 0091d2370a4f3..73c6b80cb140b 100644\n--- a/homeassistant/components/mqtt/client.py\n+++ b/homeassistant/components/mqtt/client.py\n@@ -661,7 +661,7 @@ async def async_connect(self, client_available: asyncio.Future[bool]) -> None:\n                     self.conf.get(CONF_PORT, DEFAULT_PORT),\n                     self.conf.get(CONF_KEEPALIVE, DEFAULT_KEEPALIVE),\n                 )\n-        except OSError as err:\n+        except (OSError, mqtt.WebsocketConnectionError) as err:\n             _LOGGER.error(\"Failed to connect to MQTT server due to exception: %s\", err)\n             self._async_connection_result(False)\n         finally:\n", "test_patch": "diff --git a/tests/components/mqtt/test_client.py b/tests/components/mqtt/test_client.py\nindex 4bfcde752ae6b..1878045a9b929 100644\n--- a/tests/components/mqtt/test_client.py\n+++ b/tests/components/mqtt/test_client.py\n@@ -1403,8 +1403,15 @@ def _mock_ack(topic: str, qos: int = 0) -> tuple[int, int]:\n         assert not mock_debouncer.is_set()\n \n \n+@pytest.mark.parametrize(\n+    \"exception\",\n+    [\n+        OSError(\"Connection error\"),\n+        paho_mqtt.WebsocketConnectionError(\"Connection error\"),\n+    ],\n+)\n async def test_setup_raises_config_entry_not_ready_if_no_connect_broker(\n-    hass: HomeAssistant, caplog: pytest.LogCaptureFixture\n+    hass: HomeAssistant, caplog: pytest.LogCaptureFixture, exception: Exception\n ) -> None:\n     \"\"\"Test for setup failure if connection to broker is missing.\"\"\"\n     entry = MockConfigEntry(domain=mqtt.DOMAIN, data={mqtt.CONF_BROKER: \"test-broker\"})\n@@ -1413,7 +1420,7 @@ async def test_setup_raises_config_entry_not_ready_if_no_connect_broker(\n     with patch(\n         \"homeassistant.components.mqtt.async_client.AsyncMQTTClient\"\n     ) as mock_client:\n-        mock_client().connect = MagicMock(side_effect=OSError(\"Connection error\"))\n+        mock_client().connect = MagicMock(side_effect=exception)\n         assert await hass.config_entries.async_setup(entry.entry_id)\n         await hass.async_block_till_done()\n         assert \"Failed to connect to MQTT server due to exception:\" in caplog.text\n", "problem_statement": "MQTT Client Loses Connection and Does Not Attempt Reconnect Without Restarting HA\n### The problem\r\n\r\nSetting up a connection to a local Mosquitto MQTT broker via wss works just fine. The Home Assistant MQTT client connects, receives, and publishes messages as expected.\r\n\r\nIf I restart my Mosquitto service for any reason, Home Assistant logs that it lost the connection. It does not attempt to reconnect to the broker until I restart Home Assistant. Other clients using the same endpoint reconnect without issue immediately once the broker is back online.\r\n\r\n### What version of Home Assistant Core has the issue?\r\n\r\ncore-2024.12.0\r\n\r\n### What was the last working version of Home Assistant Core?\r\n\r\n_No response_\r\n\r\n### What type of installation are you running?\r\n\r\nHome Assistant Container\r\n\r\n### Integration causing the issue\r\n\r\nMQTT\r\n\r\n### Link to integration documentation on our website\r\n\r\nhttps://www.home-assistant.io/integrations/mqtt/\r\n\r\n### Diagnostics information\r\n\r\n_No response_\r\n\r\n### Example YAML snippet\r\n\r\n_No response_\r\n\r\n### Anything in the logs that might be useful for us?\r\n\r\n```txt\r\n2024-12-11T21:02:31.528977372-06:00 stderr F 2024-12-11 21:02:31.520 DEBUG (MainThread) [homeassistant.components.mqtt.models] Rendering incoming payload '[{\"amp\":null,\"att\":{\"ref\":0}},{\"amp\":null,\"att\":{\"ref\":0}},{\"amp\":null,\"att\":{\"ref\":0}},{\"amp\":null,\"att\":{\"ref\":0}},{\"amp\":null,\"att\":{\"ref\":0}},{\"amp\":null,\"att\":{\"ref\":0}},{\"amp\":null,\"att\":{\"ref\":0}},{\"amp\":null,\"att\":{\"ref\":0}}]' with variables {'entity_id': 'select.energy_monitor_mqtt_select_4', 'name': 'MQTT Select', 'this': <template TemplateStateFromEntityId(select.energy_monitor_mqtt_select_4)>} and Template<template=({{ (value_json[3].att.ref | string) + ' Amp' }}) renders=60>\r\n2024-12-11T21:02:34.555509706-06:00 stderr F 2024-12-11 21:02:34.553 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: connection closed 34\r\n2024-12-11T21:02:34.563350289-06:00 stderr F 2024-12-11 21:02:34.558 DEBUG (MainThread) [homeassistant.components.mqtt.client] Disconnected from MQTT server mosquitto.mydomain.com:443 (7)\r\n```\r\n\r\n\r\n### Additional information\r\n\r\nThe included log output shows 3 consecutive logs from the mqtt client in debug logging mode. The first line just represents a healthy event being received. The next 2 represent the moment when the broker was restarted.\r\nOver the course of minutes or hours, nothing else from the mqtt client is logged.\r\n\r\nA snippet from the HQ diagnostics concerning MQTT:\r\n```json\r\n{\r\n   \"mqtt_config\": {\r\n      \"birth_message\": {\r\n        \"payload\": \"online\",\r\n        \"qos\": 0,\r\n        \"retain\": false,\r\n        \"topic\": \"homeassistant/status\"\r\n      },\r\n      \"broker\": \"mosquitto.mydomain.com\",\r\n      \"certificate\": \"auto\",\r\n      \"discovery\": true,\r\n      \"discovery_prefix\": \"homeassistant\",\r\n      \"keepalive\": 30,\r\n      \"password\": \"**REDACTED**\",\r\n      \"port\": 443,\r\n      \"protocol\": \"3.1.1\",\r\n      \"tls_insecure\": false,\r\n      \"transport\": \"websockets\",\r\n      \"username\": \"**REDACTED**\",\r\n      \"will_message\": {\r\n        \"payload\": \"offline\",\r\n        \"qos\": 0,\r\n        \"retain\": false,\r\n        \"topic\": \"homeassistant/status\"\r\n      },\r\n      \"ws_headers\": {},\r\n      \"ws_path\": \"/\"\r\n    }\r\n}\r\n```\r\n\r\nThe Mosquitto broker sits behind an Nginx reverse proxy that manages a Let's Encrypt wildcard domain cert for my personal domain. I have PiHole routing local DNS requests for the `mosquitto.mydomain.com` domain to the Nginx reverse proxies listening on two different static IP addresses. Connecting to either IP on port 443 will get through to the single backend Mosquitto service.\r\n\r\nMQTT explorer and various devices connected to the broker through the exact same endpoint work fine and reconnect immediately once the broker is back online. Home Assistant seems to be the only client that does not recover.\r\n\r\nRestarting via the UI or restarting the HA Docker container both work to get the mqtt client working again. Re-saving the MQTT configuration via the UI does not. Using the MQTT configure UI to publish a test message fails and logs an error about how the client isn't connected.\n", "hints_text": "\nHey there @emontnemery, @jbouwh, @bdraco, mind taking a look at this issue as it has been labeled with an integration (`mqtt`) you are listed as a [code owner](https://github.com/home-assistant/core/blob/dev/CODEOWNERS#L956) for? Thanks!\n\n<details>\n<summary>Code owner commands</summary>\n\n\nCode owners of `mqtt` can trigger bot actions by commenting:\n\n- `@home-assistant close` Closes the issue.\n- `@home-assistant rename Awesome new title` Renames the issue.\n- `@home-assistant reopen` Reopen the issue.\n- `@home-assistant unassign mqtt` Removes the current integration label and assignees on the issue, add the integration domain after the command.\n- `@home-assistant add-label needs-more-information` Add a label (needs-more-information, problem in dependency, problem in custom component) to the issue.\n- `@home-assistant remove-label needs-more-information` Remove a label (needs-more-information, problem in dependency, problem in custom component) on the issue.\n\n</details>\n\n\n<sub><sup>(message by CodeOwnersMention)</sup></sub>\n\n---\n\n[mqtt documentation](https://www.home-assistant.io/integrations/mqtt)\n[mqtt source](https://github.com/home-assistant/core/tree/dev/homeassistant/components/mqtt)\n<sub><sup>(message by IssueLinks)</sup></sub>\nHi, is there anything other in HA Core the logs. Also check for custom integrations. Please turn on matt debug logging on Home Assistant.\nDebug logging was already enabled. I just now disabled the couple of custom integrations and restarted HA. After waiting a few minutes I restarted the broker. HA immediately lost connection and did not attempt to reconnect.\r\n\r\nHere are all of the logs from HA since startup including an error at the end after the disconnect where I attempted to send a message via the UI configure:\r\n\r\n<details>\r\n\r\n<summary>HA Logs</summary>\r\n\r\n```\r\n2024-12-12T20:41:14.246111079-06:00 stderr F s6-rc: info: service s6rc-oneshot-runner: starting\r\n2024-12-12T20:41:14.252208223-06:00 stderr F s6-rc: info: service s6rc-oneshot-runner successfully started\r\n2024-12-12T20:41:14.252426790-06:00 stderr F s6-rc: info: service fix-attrs: starting\r\n2024-12-12T20:41:14.260816940-06:00 stderr F s6-rc: info: service fix-attrs successfully started\r\n2024-12-12T20:41:14.260978963-06:00 stderr F s6-rc: info: service legacy-cont-init: starting\r\n2024-12-12T20:41:14.268809626-06:00 stderr F s6-rc: info: service legacy-cont-init successfully started\r\n2024-12-12T20:41:14.268993724-06:00 stderr F s6-rc: info: service legacy-services: starting\r\n2024-12-12T20:41:14.279034406-06:00 stderr P services-up: info: copying legacy longrun home-assistant\r\n2024-12-12T20:41:14.280839625-06:00 stderr F  (no readiness notification)\r\n2024-12-12T20:41:14.346529496-06:00 stderr F s6-rc: info: service legacy-services successfully started\r\n2024-12-12T20:41:37.024941763-06:00 stderr F 2024-12-12 20:41:37.020 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: connection opened 33\r\n2024-12-12T20:41:37.025974861-06:00 stderr F 2024-12-12 20:41:37.020 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: Starting client misc loop\r\n2024-12-12T20:41:37.026403601-06:00 stderr F 2024-12-12 20:41:37.020 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 33\r\n2024-12-12T20:41:37.026927311-06:00 stderr F 2024-12-12 20:41:37.025 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 33\r\n2024-12-12T20:41:37.028433518-06:00 stderr F 2024-12-12 20:41:37.027 DEBUG (MainThread) [homeassistant.components.mqtt.client] Connected to MQTT server mosquitto.mydomain.com:443 (0)\r\n2024-12-12T20:41:37.530956328-06:00 stderr F 2024-12-12 20:41:37.529 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 33\r\n2024-12-12T20:41:37.531540925-06:00 stderr F 2024-12-12 20:41:37.529 DEBUG (MainThread) [homeassistant.components.mqtt.client] Subscribing with mid: 1 to topics with qos: [('homeassistant/alarm_control_panel/+/config', 0)]\r\n2024-12-12T20:41:37.531776111-06:00 stderr F 2024-12-12 20:41:37.530 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 33\r\n2024-12-12T20:41:37.532706002-06:00 stderr F 2024-12-12 20:41:37.532 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 33\r\n2024-12-12T20:41:37.533502302-06:00 stderr F 2024-12-12 20:41:37.532 DEBUG (MainThread) [homeassistant.components.mqtt.client] Subscribing with mid: 2 to topics with qos: [('homeassistant/binary_sensor/+/config', 0)]\r\n2024-12-12T20:41:37.534231876-06:00 stderr F 2024-12-12 20:41:37.533 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 33\r\n2024-12-12T20:41:37.534950645-06:00 stderr F 2024-12-12 20:41:37.534 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 33\r\n2024-12-12T20:41:37.535447258-06:00 stderr F 2024-12-12 20:41:37.535 DEBUG (MainThread) [homeassistant.components.mqtt.client] Subscribing with mid: 3 to topics with qos: [('homeassistant/button/+/config', 0)]\r\n2024-12-12T20:41:37.535836396-06:00 stderr F 2024-12-12 20:41:37.535 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 33\r\n2024-12-12T20:41:37.536870853-06:00 stderr F 2024-12-12 20:41:37.536 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 33\r\n2024-12-12T20:41:37.537111465-06:00 stderr F 2024-12-12 20:41:37.536 DEBUG (MainThread) [homeassistant.components.mqtt.client] Subscribing with mid: 4 to topics with qos: [('homeassistant/camera/+/config', 0)]\r\n2024-12-12T20:41:37.537574045-06:00 stderr F 2024-12-12 20:41:37.537 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 33\r\n2024-12-12T20:41:37.538091722-06:00 stderr F 2024-12-12 20:41:37.537 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 33\r\n2024-12-12T20:41:37.538686570-06:00 stderr F 2024-12-12 20:41:37.538 DEBUG (MainThread) [homeassistant.components.mqtt.client] Subscribing with mid: 5 to topics with qos: [('homeassistant/climate/+/config', 0)]\r\n2024-12-12T20:41:37.539133607-06:00 stderr F 2024-12-12 20:41:37.538 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 33\r\n2024-12-12T20:41:37.540025980-06:00 stderr F 2024-12-12 20:41:37.539 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 33\r\n2024-12-12T20:41:37.540278454-06:00 stderr F 2024-12-12 20:41:37.539 DEBUG (MainThread) [homeassistant.components.mqtt.client] Subscribing with mid: 6 to topics with qos: [('homeassistant/cover/+/config', 0)]\r\n2024-12-12T20:41:37.541433600-06:00 stderr F 2024-12-12 20:41:37.540 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 33\r\n2024-12-12T20:41:37.541871825-06:00 stderr F 2024-12-12 20:41:37.540 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 33\r\n2024-12-12T20:41:37.542228182-06:00 stderr F 2024-12-12 20:41:37.540 DEBUG (MainThread) [homeassistant.components.mqtt.client] Subscribing with mid: 7 to topics with qos: [('homeassistant/device_automation/+/config', 0)]\r\n2024-12-12T20:41:37.542472441-06:00 stderr F 2024-12-12 20:41:37.541 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 33\r\n2024-12-12T20:41:37.543451910-06:00 stderr F 2024-12-12 20:41:37.542 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 33\r\n2024-12-12T20:41:37.543724879-06:00 stderr F 2024-12-12 20:41:37.543 DEBUG (MainThread) [homeassistant.components.mqtt.client] Subscribing with mid: 8 to topics with qos: [('homeassistant/device_tracker/+/config', 0)]\r\n2024-12-12T20:41:37.544245173-06:00 stderr F 2024-12-12 20:41:37.543 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 33\r\n2024-12-12T20:41:37.545090547-06:00 stderr F 2024-12-12 20:41:37.544 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 33\r\n2024-12-12T20:41:37.545345214-06:00 stderr F 2024-12-12 20:41:37.544 DEBUG (MainThread) [homeassistant.components.mqtt.client] Subscribing with mid: 9 to topics with qos: [('homeassistant/event/+/config', 0)]\r\n2024-12-12T20:41:37.545837317-06:00 stderr F 2024-12-12 20:41:37.545 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 33\r\n2024-12-12T20:41:37.546790293-06:00 stderr F 2024-12-12 20:41:37.546 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 33\r\n2024-12-12T20:41:37.547042182-06:00 stderr F 2024-12-12 20:41:37.546 DEBUG (MainThread) [homeassistant.components.mqtt.client] Subscribing with mid: 10 to topics with qos: [('homeassistant/fan/+/config', 0)]\r\n2024-12-12T20:41:37.547490594-06:00 stderr F 2024-12-12 20:41:37.547 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 33\r\n2024-12-12T20:41:37.548402560-06:00 stderr F 2024-12-12 20:41:37.547 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 33\r\n2024-12-12T20:41:37.548659556-06:00 stderr F 2024-12-12 20:41:37.547 DEBUG (MainThread) [homeassistant.components.mqtt.client] Subscribing with mid: 11 to topics with qos: [('homeassistant/humidifier/+/config', 0)]\r\n2024-12-12T20:41:37.549079945-06:00 stderr F 2024-12-12 20:41:37.548 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 33\r\n2024-12-12T20:41:37.550003273-06:00 stderr F 2024-12-12 20:41:37.549 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 33\r\n2024-12-12T20:41:37.550315929-06:00 stderr F 2024-12-12 20:41:37.549 DEBUG (MainThread) [homeassistant.components.mqtt.client] Subscribing with mid: 12 to topics with qos: [('homeassistant/image/+/config', 0)]\r\n2024-12-12T20:41:37.550747036-06:00 stderr F 2024-12-12 20:41:37.550 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 33\r\n2024-12-12T20:41:37.551584630-06:00 stderr F 2024-12-12 20:41:37.551 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 33\r\n2024-12-12T20:41:37.551824867-06:00 stderr F 2024-12-12 20:41:37.551 DEBUG (MainThread) [homeassistant.components.mqtt.client] Subscribing with mid: 13 to topics with qos: [('homeassistant/lawn_mower/+/config', 0)]\r\n2024-12-12T20:41:37.552273020-06:00 stderr F 2024-12-12 20:41:37.551 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 33\r\n2024-12-12T20:41:37.553111489-06:00 stderr F 2024-12-12 20:41:37.552 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 33\r\n2024-12-12T20:41:37.553349986-06:00 stderr F 2024-12-12 20:41:37.552 DEBUG (MainThread) [homeassistant.components.mqtt.client] Subscribing with mid: 14 to topics with qos: [('homeassistant/light/+/config', 0)]\r\n2024-12-12T20:41:37.553848525-06:00 stderr F 2024-12-12 20:41:37.553 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 33\r\n2024-12-12T20:41:37.554480973-06:00 stderr F 2024-12-12 20:41:37.554 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 33\r\n2024-12-12T20:41:37.555027835-06:00 stderr F 2024-12-12 20:41:37.554 DEBUG (MainThread) [homeassistant.components.mqtt.client] Subscribing with mid: 15 to topics with qos: [('homeassistant/lock/+/config', 0)]\r\n2024-12-12T20:41:37.555492164-06:00 stderr F 2024-12-12 20:41:37.555 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 33\r\n2024-12-12T20:41:37.556414519-06:00 stderr F 2024-12-12 20:41:37.555 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 33\r\n2024-12-12T20:41:37.556683925-06:00 stderr F 2024-12-12 20:41:37.555 DEBUG (MainThread) [homeassistant.components.mqtt.client] Subscribing with mid: 16 to topics with qos: [('homeassistant/notify/+/config', 0)]\r\n2024-12-12T20:41:37.557686382-06:00 stderr F 2024-12-12 20:41:37.556 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 33\r\n2024-12-12T20:41:37.557955668-06:00 stderr F 2024-12-12 20:41:37.557 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 33\r\n2024-12-12T20:41:37.558433476-06:00 stderr F 2024-12-12 20:41:37.557 DEBUG (MainThread) [homeassistant.components.mqtt.client] Subscribing with mid: 17 to topics with qos: [('homeassistant/number/+/config', 0)]\r\n2024-12-12T20:41:37.558944917-06:00 stderr F 2024-12-12 20:41:37.558 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 33\r\n2024-12-12T20:41:37.559797094-06:00 stderr F 2024-12-12 20:41:37.559 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 33\r\n2024-12-12T20:41:37.560050008-06:00 stderr F 2024-12-12 20:41:37.559 DEBUG (MainThread) [homeassistant.components.mqtt.client] Subscribing with mid: 18 to topics with qos: [('homeassistant/scene/+/config', 0)]\r\n2024-12-12T20:41:37.560537835-06:00 stderr F 2024-12-12 20:41:37.560 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 33\r\n2024-12-12T20:41:37.561515540-06:00 stderr F 2024-12-12 20:41:37.560 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 33\r\n2024-12-12T20:41:37.561777562-06:00 stderr F 2024-12-12 20:41:37.561 DEBUG (MainThread) [homeassistant.components.mqtt.client] Subscribing with mid: 19 to topics with qos: [('homeassistant/siren/+/config', 0)]\r\n2024-12-12T20:41:37.562441352-06:00 stderr F 2024-12-12 20:41:37.561 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 33\r\n2024-12-12T20:41:37.563006488-06:00 stderr F 2024-12-12 20:41:37.562 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 33\r\n2024-12-12T20:41:37.563434044-06:00 stderr F 2024-12-12 20:41:37.563 DEBUG (MainThread) [homeassistant.components.mqtt.client] Subscribing with mid: 20 to topics with qos: [('homeassistant/select/+/config', 0)]\r\n2024-12-12T20:41:37.564027407-06:00 stderr F 2024-12-12 20:41:37.563 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 33\r\n2024-12-12T20:41:37.565190851-06:00 stderr F 2024-12-12 20:41:37.564 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 33\r\n2024-12-12T20:41:37.565452419-06:00 stderr F 2024-12-12 20:41:37.564 DEBUG (MainThread) [homeassistant.components.mqtt.client] Subscribing with mid: 21 to topics with qos: [('homeassistant/sensor/+/config', 0)]\r\n2024-12-12T20:41:37.566691059-06:00 stderr F 2024-12-12 20:41:37.565 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 33\r\n2024-12-12T20:41:37.566902131-06:00 stderr F 2024-12-12 20:41:37.566 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 33\r\n2024-12-12T20:41:37.567130323-06:00 stderr F 2024-12-12 20:41:37.566 DEBUG (MainThread) [homeassistant.components.mqtt.client] Subscribing with mid: 22 to topics with qos: [('homeassistant/switch/+/config', 0)]\r\n2024-12-12T20:41:37.567547051-06:00 stderr F 2024-12-12 20:41:37.567 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 33\r\n2024-12-12T20:41:37.568619487-06:00 stderr F 2024-12-12 20:41:37.567 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 33\r\n2024-12-12T20:41:37.568775653-06:00 stderr F 2024-12-12 20:41:37.568 DEBUG (MainThread) [homeassistant.components.mqtt.client] Subscribing with mid: 23 to topics with qos: [('homeassistant/tag/+/config', 0)]\r\n2024-12-12T20:41:37.569520211-06:00 stderr F 2024-12-12 20:41:37.568 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 33\r\n2024-12-12T20:41:37.570595041-06:00 stderr F 2024-12-12 20:41:37.569 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 33\r\n2024-12-12T20:41:37.570890300-06:00 stderr F 2024-12-12 20:41:37.570 DEBUG (MainThread) [homeassistant.components.mqtt.client] Subscribing with mid: 24 to topics with qos: [('homeassistant/text/+/config', 0)]\r\n2024-12-12T20:41:37.571541811-06:00 stderr F 2024-12-12 20:41:37.570 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 33\r\n2024-12-12T20:41:37.572310058-06:00 stderr F 2024-12-12 20:41:37.571 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 33\r\n2024-12-12T20:41:37.573128253-06:00 stderr F 2024-12-12 20:41:37.572 DEBUG (MainThread) [homeassistant.components.mqtt.client] Subscribing with mid: 25 to topics with qos: [('homeassistant/update/+/config', 0)]\r\n2024-12-12T20:41:37.573400834-06:00 stderr F 2024-12-12 20:41:37.572 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 33\r\n2024-12-12T20:41:37.574714991-06:00 stderr F 2024-12-12 20:41:37.573 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 33\r\n2024-12-12T20:41:37.574991293-06:00 stderr F 2024-12-12 20:41:37.574 DEBUG (MainThread) [homeassistant.components.mqtt.client] Subscribing with mid: 26 to topics with qos: [('homeassistant/vacuum/+/config', 0)]\r\n2024-12-12T20:41:37.575602111-06:00 stderr F 2024-12-12 20:41:37.575 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 33\r\n2024-12-12T20:41:37.576771297-06:00 stderr F 2024-12-12 20:41:37.576 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 33\r\n2024-12-12T20:41:37.577063387-06:00 stderr F 2024-12-12 20:41:37.576 DEBUG (MainThread) [homeassistant.components.mqtt.client] Subscribing with mid: 27 to topics with qos: [('homeassistant/valve/+/config', 0)]\r\n2024-12-12T20:41:37.577632973-06:00 stderr F 2024-12-12 20:41:37.577 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 33\r\n2024-12-12T20:41:37.578617311-06:00 stderr F 2024-12-12 20:41:37.577 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 33\r\n2024-12-12T20:41:37.578896484-06:00 stderr F 2024-12-12 20:41:37.578 DEBUG (MainThread) [homeassistant.components.mqtt.client] Subscribing with mid: 28 to topics with qos: [('homeassistant/water_heater/+/config', 0)]\r\n2024-12-12T20:41:37.579470598-06:00 stderr F 2024-12-12 20:41:37.579 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 33\r\n2024-12-12T20:41:37.580266222-06:00 stderr F 2024-12-12 20:41:37.579 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 33\r\n2024-12-12T20:41:37.580900274-06:00 stderr F 2024-12-12 20:41:37.580 DEBUG (MainThread) [homeassistant.components.mqtt.client] Subscribing with mid: 29 to topics with qos: [('homeassistant/alarm_control_panel/+/+/config', 0)]\r\n2024-12-12T20:41:37.581535469-06:00 stderr F 2024-12-12 20:41:37.580 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 33\r\n2024-12-12T20:41:37.583227661-06:00 stderr F 2024-12-12 20:41:37.582 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 33\r\n2024-12-12T20:41:37.583428379-06:00 stderr F 2024-12-12 20:41:37.582 DEBUG (MainThread) [homeassistant.components.mqtt.client] Subscribing with mid: 30 to topics with qos: [('homeassistant/binary_sensor/+/+/config', 0)]\r\n2024-12-12T20:41:37.584057676-06:00 stderr F 2024-12-12 20:41:37.583 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 33\r\n2024-12-12T20:41:37.585101958-06:00 stderr F 2024-12-12 20:41:37.584 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 33\r\n2024-12-12T20:41:37.585365584-06:00 stderr F 2024-12-12 20:41:37.584 DEBUG (MainThread) [homeassistant.components.mqtt.client] Subscribing with mid: 31 to topics with qos: [('homeassistant/button/+/+/config', 0)]\r\n2024-12-12T20:41:37.585862101-06:00 stderr F 2024-12-12 20:41:37.585 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 33\r\n2024-12-12T20:41:37.586735304-06:00 stderr F 2024-12-12 20:41:37.586 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 33\r\n2024-12-12T20:41:37.587009009-06:00 stderr F 2024-12-12 20:41:37.586 DEBUG (MainThread) [homeassistant.components.mqtt.client] Subscribing with mid: 32 to topics with qos: [('homeassistant/camera/+/+/config', 0)]\r\n2024-12-12T20:41:37.587580974-06:00 stderr F 2024-12-12 20:41:37.587 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 33\r\n2024-12-12T20:41:37.588324163-06:00 stderr F 2024-12-12 20:41:37.587 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 33\r\n2024-12-12T20:41:37.588599642-06:00 stderr F 2024-12-12 20:41:37.587 DEBUG (MainThread) [homeassistant.components.mqtt.client] Subscribing with mid: 33 to topics with qos: [('homeassistant/climate/+/+/config', 0)]\r\n2024-12-12T20:41:37.589237112-06:00 stderr F 2024-12-12 20:41:37.588 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 33\r\n2024-12-12T20:41:37.590468345-06:00 stderr F 2024-12-12 20:41:37.589 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 33\r\n2024-12-12T20:41:37.590705431-06:00 stderr F 2024-12-12 20:41:37.589 DEBUG (MainThread) [homeassistant.components.mqtt.client] Subscribing with mid: 34 to topics with qos: [('homeassistant/cover/+/+/config', 0)]\r\n2024-12-12T20:41:37.591187294-06:00 stderr F 2024-12-12 20:41:37.590 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 33\r\n2024-12-12T20:41:37.592046945-06:00 stderr F 2024-12-12 20:41:37.591 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 33\r\n2024-12-12T20:41:37.592280404-06:00 stderr F 2024-12-12 20:41:37.591 DEBUG (MainThread) [homeassistant.components.mqtt.client] Subscribing with mid: 35 to topics with qos: [('homeassistant/device_automation/+/+/config', 0)]\r\n2024-12-12T20:41:37.592795817-06:00 stderr F 2024-12-12 20:41:37.592 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 33\r\n2024-12-12T20:41:37.593827057-06:00 stderr F 2024-12-12 20:41:37.593 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 33\r\n2024-12-12T20:41:37.594063197-06:00 stderr F 2024-12-12 20:41:37.593 DEBUG (MainThread) [homeassistant.components.mqtt.client] Subscribing with mid: 36 to topics with qos: [('homeassistant/device_tracker/+/+/config', 0)]\r\n2024-12-12T20:41:37.594614256-06:00 stderr F 2024-12-12 20:41:37.594 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 33\r\n2024-12-12T20:41:37.595433318-06:00 stderr F 2024-12-12 20:41:37.594 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 33\r\n2024-12-12T20:41:37.595767454-06:00 stderr F 2024-12-12 20:41:37.594 DEBUG (MainThread) [homeassistant.components.mqtt.client] Subscribing with mid: 37 to topics with qos: [('homeassistant/event/+/+/config', 0)]\r\n2024-12-12T20:41:37.596257057-06:00 stderr F 2024-12-12 20:41:37.595 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 33\r\n2024-12-12T20:41:37.596964648-06:00 stderr F 2024-12-12 20:41:37.596 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 33\r\n2024-12-12T20:41:37.597176603-06:00 stderr F 2024-12-12 20:41:37.596 DEBUG (MainThread) [homeassistant.components.mqtt.client] Subscribing with mid: 38 to topics with qos: [('homeassistant/fan/+/+/config', 0)]\r\n2024-12-12T20:41:37.597696855-06:00 stderr F 2024-12-12 20:41:37.597 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 33\r\n2024-12-12T20:41:37.598782217-06:00 stderr F 2024-12-12 20:41:37.598 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 33\r\n2024-12-12T20:41:37.599016349-06:00 stderr F 2024-12-12 20:41:37.598 DEBUG (MainThread) [homeassistant.components.mqtt.client] Subscribing with mid: 39 to topics with qos: [('homeassistant/humidifier/+/+/config', 0)]\r\n2024-12-12T20:41:37.600077089-06:00 stderr F 2024-12-12 20:41:37.599 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 33\r\n2024-12-12T20:41:37.600340081-06:00 stderr F 2024-12-12 20:41:37.599 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 33\r\n2024-12-12T20:41:37.600502358-06:00 stderr F 2024-12-12 20:41:37.599 DEBUG (MainThread) [homeassistant.components.mqtt.client] Subscribing with mid: 40 to topics with qos: [('homeassistant/image/+/+/config', 0)]\r\n2024-12-12T20:41:37.601062704-06:00 stderr F 2024-12-12 20:41:37.600 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 33\r\n2024-12-12T20:41:37.601954426-06:00 stderr F 2024-12-12 20:41:37.601 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 33\r\n2024-12-12T20:41:37.602226283-06:00 stderr F 2024-12-12 20:41:37.601 DEBUG (MainThread) [homeassistant.components.mqtt.client] Subscribing with mid: 41 to topics with qos: [('homeassistant/lawn_mower/+/+/config', 0)]\r\n2024-12-12T20:41:37.605922207-06:00 stderr F 2024-12-12 20:41:37.603 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 33\r\n2024-12-12T20:41:37.610106571-06:00 stderr F 2024-12-12 20:41:37.606 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 33\r\n2024-12-12T20:41:37.610106571-06:00 stderr F 2024-12-12 20:41:37.607 DEBUG (MainThread) [homeassistant.components.mqtt.client] Subscribing with mid: 42 to topics with qos: [('homeassistant/light/+/+/config', 0)]\r\n2024-12-12T20:41:37.610106571-06:00 stderr F 2024-12-12 20:41:37.607 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 33\r\n2024-12-12T20:41:37.610106571-06:00 stderr F 2024-12-12 20:41:37.608 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 33\r\n2024-12-12T20:41:37.610106571-06:00 stderr F 2024-12-12 20:41:37.608 DEBUG (MainThread) [homeassistant.components.mqtt.client] Subscribing with mid: 43 to topics with qos: [('homeassistant/lock/+/+/config', 0)]\r\n2024-12-12T20:41:37.610173237-06:00 stderr F 2024-12-12 20:41:37.609 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 33\r\n2024-12-12T20:41:37.611093756-06:00 stderr F 2024-12-12 20:41:37.610 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 33\r\n2024-12-12T20:41:37.611961870-06:00 stderr F 2024-12-12 20:41:37.611 DEBUG (MainThread) [homeassistant.components.mqtt.client] Subscribing with mid: 44 to topics with qos: [('homeassistant/notify/+/+/config', 0)]\r\n2024-12-12T20:41:37.612337996-06:00 stderr F 2024-12-12 20:41:37.611 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 33\r\n2024-12-12T20:41:37.613655968-06:00 stderr F 2024-12-12 20:41:37.612 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 33\r\n2024-12-12T20:41:37.614326679-06:00 stderr F 2024-12-12 20:41:37.613 DEBUG (MainThread) [homeassistant.components.mqtt.client] Subscribing with mid: 45 to topics with qos: [('homeassistant/number/+/+/config', 0)]\r\n2024-12-12T20:41:37.614642346-06:00 stderr F 2024-12-12 20:41:37.613 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 33\r\n2024-12-12T20:41:37.615618851-06:00 stderr F 2024-12-12 20:41:37.614 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 33\r\n2024-12-12T20:41:37.615896674-06:00 stderr F 2024-12-12 20:41:37.615 DEBUG (MainThread) [homeassistant.components.mqtt.client] Subscribing with mid: 46 to topics with qos: [('homeassistant/scene/+/+/config', 0)]\r\n2024-12-12T20:41:37.617268499-06:00 stderr F 2024-12-12 20:41:37.616 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 33\r\n2024-12-12T20:41:37.617495814-06:00 stderr F 2024-12-12 20:41:37.616 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 33\r\n2024-12-12T20:41:37.617813721-06:00 stderr F 2024-12-12 20:41:37.616 DEBUG (MainThread) [homeassistant.components.mqtt.client] Subscribing with mid: 47 to topics with qos: [('homeassistant/siren/+/+/config', 0)]\r\n2024-12-12T20:41:37.618448017-06:00 stderr F 2024-12-12 20:41:37.617 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 33\r\n2024-12-12T20:41:37.619316750-06:00 stderr F 2024-12-12 20:41:37.618 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 33\r\n2024-12-12T20:41:37.619718252-06:00 stderr F 2024-12-12 20:41:37.618 DEBUG (MainThread) [homeassistant.components.mqtt.client] Subscribing with mid: 48 to topics with qos: [('homeassistant/select/+/+/config', 0)]\r\n2024-12-12T20:41:37.620122968-06:00 stderr F 2024-12-12 20:41:37.619 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 33\r\n2024-12-12T20:41:37.620918506-06:00 stderr F 2024-12-12 20:41:37.620 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 33\r\n2024-12-12T20:41:37.621312490-06:00 stderr F 2024-12-12 20:41:37.620 DEBUG (MainThread) [homeassistant.components.mqtt.client] Subscribing with mid: 49 to topics with qos: [('homeassistant/sensor/+/+/config', 0)]\r\n2024-12-12T20:41:37.621873973-06:00 stderr F 2024-12-12 20:41:37.621 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 33\r\n2024-12-12T20:41:37.622805741-06:00 stderr F 2024-12-12 20:41:37.622 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 33\r\n2024-12-12T20:41:37.623034785-06:00 stderr F 2024-12-12 20:41:37.622 DEBUG (MainThread) [homeassistant.components.mqtt.client] Subscribing with mid: 50 to topics with qos: [('homeassistant/switch/+/+/config', 0)]\r\n2024-12-12T20:41:37.623532439-06:00 stderr F 2024-12-12 20:41:37.623 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 33\r\n2024-12-12T20:41:37.624109750-06:00 stderr F 2024-12-12 20:41:37.623 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 33\r\n2024-12-12T20:41:37.624539436-06:00 stderr F 2024-12-12 20:41:37.624 DEBUG (MainThread) [homeassistant.components.mqtt.client] Subscribing with mid: 51 to topics with qos: [('homeassistant/tag/+/+/config', 0)]\r\n2024-12-12T20:41:37.625046369-06:00 stderr F 2024-12-12 20:41:37.624 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 33\r\n2024-12-12T20:41:37.626219804-06:00 stderr F 2024-12-12 20:41:37.625 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 33\r\n2024-12-12T20:41:37.626656211-06:00 stderr F 2024-12-12 20:41:37.625 DEBUG (MainThread) [homeassistant.components.mqtt.client] Subscribing with mid: 52 to topics with qos: [('homeassistant/text/+/+/config', 0)]\r\n2024-12-12T20:41:37.627722360-06:00 stderr F 2024-12-12 20:41:37.626 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 33\r\n2024-12-12T20:41:37.627975327-06:00 stderr F 2024-12-12 20:41:37.627 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 33\r\n2024-12-12T20:41:37.628218626-06:00 stderr F 2024-12-12 20:41:37.627 DEBUG (MainThread) [homeassistant.components.mqtt.client] Subscribing with mid: 53 to topics with qos: [('homeassistant/update/+/+/config', 0)]\r\n2024-12-12T20:41:37.628765674-06:00 stderr F 2024-12-12 20:41:37.628 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 33\r\n2024-12-12T20:41:37.629988552-06:00 stderr F 2024-12-12 20:41:37.629 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 33\r\n2024-12-12T20:41:37.630286428-06:00 stderr F 2024-12-12 20:41:37.629 DEBUG (MainThread) [homeassistant.components.mqtt.client] Subscribing with mid: 54 to topics with qos: [('homeassistant/vacuum/+/+/config', 0)]\r\n2024-12-12T20:41:37.630823782-06:00 stderr F 2024-12-12 20:41:37.630 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 33\r\n2024-12-12T20:41:37.631628823-06:00 stderr F 2024-12-12 20:41:37.631 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 33\r\n2024-12-12T20:41:37.632015581-06:00 stderr F 2024-12-12 20:41:37.631 DEBUG (MainThread) [homeassistant.components.mqtt.client] Subscribing with mid: 55 to topics with qos: [('homeassistant/valve/+/+/config', 0)]\r\n2024-12-12T20:41:37.632559749-06:00 stderr F 2024-12-12 20:41:37.632 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 33\r\n2024-12-12T20:41:37.633190443-06:00 stderr F 2024-12-12 20:41:37.632 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 33\r\n2024-12-12T20:41:37.633746224-06:00 stderr F 2024-12-12 20:41:37.633 DEBUG (MainThread) [homeassistant.components.mqtt.client] Subscribing with mid: 56 to topics with qos: [('homeassistant/water_heater/+/+/config', 0)]\r\n2024-12-12T20:41:37.634339904-06:00 stderr F 2024-12-12 20:41:37.633 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 33\r\n2024-12-12T20:41:37.635381181-06:00 stderr F 2024-12-12 20:41:37.634 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 33\r\n2024-12-12T20:41:37.635616626-06:00 stderr F 2024-12-12 20:41:37.634 DEBUG (MainThread) [homeassistant.components.mqtt.client] Subscribing with mid: 57 to topics with qos: [('homeassistant/device/+/config', 0)]\r\n2024-12-12T20:41:37.636102460-06:00 stderr F 2024-12-12 20:41:37.635 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 33\r\n2024-12-12T20:41:37.636997441-06:00 stderr F 2024-12-12 20:41:37.636 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 33\r\n2024-12-12T20:41:37.637244704-06:00 stderr F 2024-12-12 20:41:37.636 DEBUG (MainThread) [homeassistant.components.mqtt.client] Subscribing with mid: 58 to topics with qos: [('homeassistant/device/+/+/config', 0)]\r\n2024-12-12T20:41:37.638284408-06:00 stderr F 2024-12-12 20:41:37.637 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 33\r\n2024-12-12T20:41:37.638974244-06:00 stderr F 2024-12-12 20:41:37.638 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 33\r\n2024-12-12T20:41:37.639518216-06:00 stderr F 2024-12-12 20:41:37.639 DEBUG (MainThread) [homeassistant.components.mqtt.client] Subscribing with mid: 59 to topics with qos: [('drop_connect/discovery/#', 0)]\r\n2024-12-12T20:41:37.640093338-06:00 stderr F 2024-12-12 20:41:37.639 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 33\r\n2024-12-12T20:41:37.640842670-06:00 stderr F 2024-12-12 20:41:37.640 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 33\r\n2024-12-12T20:41:37.641237668-06:00 stderr F 2024-12-12 20:41:37.640 DEBUG (MainThread) [homeassistant.components.mqtt.client] Subscribing with mid: 60 to topics with qos: [('dsmr/#', 0)]\r\n2024-12-12T20:41:37.641775439-06:00 stderr F 2024-12-12 20:41:37.641 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 33\r\n2024-12-12T20:41:37.642943662-06:00 stderr F 2024-12-12 20:41:37.642 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 33\r\n2024-12-12T20:41:37.643159801-06:00 stderr F 2024-12-12 20:41:37.642 DEBUG (MainThread) [homeassistant.components.mqtt.client] Subscribing with mid: 61 to topics with qos: [('esphome/discover/#', 0)]\r\n2024-12-12T20:41:37.643609208-06:00 stderr F 2024-12-12 20:41:37.643 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 33\r\n2024-12-12T20:41:37.644406417-06:00 stderr F 2024-12-12 20:41:37.643 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 33\r\n2024-12-12T20:41:37.644653300-06:00 stderr F 2024-12-12 20:41:37.644 DEBUG (MainThread) [homeassistant.components.mqtt.client] Subscribing with mid: 62 to topics with qos: [('fully/deviceInfo/+', 0)]\r\n2024-12-12T20:41:37.645215560-06:00 stderr F 2024-12-12 20:41:37.644 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 33\r\n2024-12-12T20:41:37.646724238-06:00 stderr F 2024-12-12 20:41:37.645 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 33\r\n2024-12-12T20:41:37.646976438-06:00 stderr F 2024-12-12 20:41:37.645 DEBUG (MainThread) [homeassistant.components.mqtt.client] Subscribing with mid: 63 to topics with qos: [('tasmota/discovery/#', 0)]\r\n2024-12-12T20:41:37.647523325-06:00 stderr F 2024-12-12 20:41:37.647 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 33\r\n2024-12-12T20:41:43.045746738-06:00 stderr F 2024-12-12 20:41:43.044 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 33\r\n2024-12-12T20:41:43.047892247-06:00 stderr F 2024-12-12 20:41:43.044 DEBUG (MainThread) [homeassistant.components.mqtt.client] Transmitting message on homeassistant/status: 'online', mid: 64, qos: 0\r\n2024-12-12T20:41:43.048191795-06:00 stderr F 2024-12-12 20:41:43.046 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 33\r\n2024-12-12T20:41:43.049005036-06:00 stderr F 2024-12-12 20:41:43.046 INFO (MainThread) [homeassistant.components.mqtt.client] MQTT client initialized, birth message sent\r\n2024-12-12T20:42:07.231247586-06:00 stderr F 2024-12-12 20:42:07.230 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 33\r\n2024-12-12T20:42:07.232576096-06:00 stderr F 2024-12-12 20:42:07.231 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 33\r\n2024-12-12T20:42:37.295438936-06:00 stderr F 2024-12-12 20:42:37.294 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 33\r\n2024-12-12T20:42:37.297241342-06:00 stderr F 2024-12-12 20:42:37.295 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 33\r\n2024-12-12T20:42:54.358887780-06:00 stderr F 2024-12-12 20:42:54.357 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: connection closed 33\r\n2024-12-12T20:42:54.359392611-06:00 stderr F 2024-12-12 20:42:54.359 DEBUG (MainThread) [homeassistant.components.mqtt.client] Disconnected from MQTT server mosquitto.mydomain.com:443 (7)\r\n2024-12-12T20:44:01.895801964-06:00 stderr F 2024-12-12 20:44:01.893 DEBUG (MainThread) [homeassistant.components.mqtt.client] Transmitting message on homeassistant/switch/1/power: 'OFF', mid: 65, qos: 0\r\n2024-12-12T20:44:01.902817117-06:00 stderr F 2024-12-12 20:44:01.893 ERROR (MainThread) [homeassistant.components.websocket_api.http.connection] [140635271788096] Unexpected exception\r\n2024-12-12T20:44:01.902817117-06:00 stderr F Traceback (most recent call last):\r\n2024-12-12T20:44:01.902817117-06:00 stderr F   File \"/usr/src/homeassistant/homeassistant/components/websocket_api/commands.py\", line 245, in handle_call_service\r\n2024-12-12T20:44:01.902817117-06:00 stderr F     response = await hass.services.async_call(\r\n2024-12-12T20:44:01.902817117-06:00 stderr F                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n2024-12-12T20:44:01.902817117-06:00 stderr F     ...<7 lines>...\r\n2024-12-12T20:44:01.902817117-06:00 stderr F     )\r\n2024-12-12T20:44:01.902817117-06:00 stderr F     ^\r\n2024-12-12T20:44:01.902817117-06:00 stderr F   File \"/usr/src/homeassistant/homeassistant/core.py\", line 2802, in async_call\r\n2024-12-12T20:44:01.902817117-06:00 stderr F     response_data = await coro\r\n2024-12-12T20:44:01.902817117-06:00 stderr F                     ^^^^^^^^^^\r\n2024-12-12T20:44:01.902817117-06:00 stderr F   File \"/usr/src/homeassistant/homeassistant/core.py\", line 2845, in _execute_service\r\n2024-12-12T20:44:01.902817117-06:00 stderr F     return await target(service_call)\r\n2024-12-12T20:44:01.902817117-06:00 stderr F            ^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n2024-12-12T20:44:01.902817117-06:00 stderr F   File \"/usr/src/homeassistant/homeassistant/components/mqtt/__init__.py\", line 316, in async_publish_service\r\n2024-12-12T20:44:01.902817117-06:00 stderr F     await mqtt_data.client.async_publish(msg_topic, payload, qos, retain)\r\n2024-12-12T20:44:01.902817117-06:00 stderr F   File \"/usr/src/homeassistant/homeassistant/components/mqtt/client.py\", line 646, in async_publish\r\n2024-12-12T20:44:01.902817117-06:00 stderr F     await self._async_wait_for_mid_or_raise(msg_info.mid, msg_info.rc)\r\n2024-12-12T20:44:01.902817117-06:00 stderr F   File \"/usr/src/homeassistant/homeassistant/components/mqtt/client.py\", line 1215, in _async_wait_for_mid_or_raise\r\n2024-12-12T20:44:01.902817117-06:00 stderr F     raise HomeAssistantError(\r\n2024-12-12T20:44:01.902817117-06:00 stderr F         f\"Error talking to MQTT: {mqtt.error_string(result_code)}\"\r\n2024-12-12T20:44:01.902817117-06:00 stderr F     )\r\n2024-12-12T20:44:01.902817117-06:00 stderr F homeassistant.exceptions.HomeAssistantError: Error talking to MQTT: The client is not currently connected.\r\n```\r\n\r\n</details>\nRight. It might be some custom integrations do block the event loop. The connection to the MQTT broker can be easiliy disturbed.\r\nIf you see messages in the logs, notifying the event loop is blocked, please notify the maintainers, or in case of a Home Assistant core integration blocking the event loop, open an issue to report this.\r\n\r\nI could not reproduce the issues you were seeing. I also restarted the broker while connected over WebSockets, but the connection recovered normally.\nIt is likely you have other issues that avoid a reconnection to take place.\nI\u2019ve tested restarting non gracefully killing the broker scenarios and it all recovered before.  We are going to need either an `strace` or some manual code mods to instrument the reconnect code to add more debug logging\nYou might get another hint as to what is going on by enabling asyncio debug.\n\nhttps://community.home-assistant.io/t/2024-5-tracking-down-instability-issues-caused-by-integrations/724441/1\nSince my whole setup is just a bunch of Docker containers, I decided to create a new instance of Home Assistance and do nothing with it but add the MQTT integration to test with.\r\n\r\nWhen I execute my same steps against a simple Docker container that has no persistence, no volumes / mounts, the default untouched configuration, default integrations only - but with MQTT added, I get the same results. The main difference with my test container is that I'm running it in bridge mode vs host since I don't need mdns discovery for any of this.\r\n\r\nStarting from a fresh, default Home Assistant Docker container:\r\n1. Swap my account to advanced mode to setup web socket mode in MQTT.\r\n2. Add the MQTT integration (the same config as posted above).\r\n3. Send a test message to a test topic via the config UI - success!\r\n4. Restart my Mosquitto broker service - connection is immediately lost from HA.\r\n5. Wait for for the broker to start back up. Watch other clients reconnect. HA does not.\r\n6. Attempt to send a test message to a test topic again - fails with \"Error talking to MQTT: The client is not currently connected\" error.\r\n\r\nIf I exec into the container and turn on debug logging for MQTT in the configuration.yaml, and then restart HA from the UI, the HA MQTT client connects and I see all of the usual debug logs of a healthy connection. Running my test again gets the same results, but now with the debug log output.\r\n\r\nI don't see anything different in the logs from what I last posted:\r\n<details>\r\n<summary>MQTT Debug Logs</summary>\r\n\r\n```\r\n2024-12-13T20:58:59.200150971-06:00 stderr F 2024-12-13 20:58:59.184 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: connection opened 22\r\n2024-12-13T20:58:59.203032280-06:00 stderr F 2024-12-13 20:58:59.185 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: Starting client misc loop\r\n2024-12-13T20:58:59.203899924-06:00 stderr F 2024-12-13 20:58:59.185 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 22\r\n2024-12-13T20:58:59.204115780-06:00 stderr F 2024-12-13 20:58:59.203 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 22\r\n2024-12-13T20:58:59.208098530-06:00 stderr F 2024-12-13 20:58:59.206 DEBUG (MainThread) [homeassistant.components.mqtt.client] Connected to MQTT server mosquitto.mydomain.com:443 (0)\r\n2024-12-13T20:58:59.711127145-06:00 stderr F 2024-12-13 20:58:59.709 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 22\r\n2024-12-13T20:58:59.711437186-06:00 stderr F 2024-12-13 20:58:59.710 DEBUG (MainThread) [homeassistant.components.mqtt.client] Subscribing with mid: 1 to topics with qos: [('homeassistant/alarm_control_panel/+/config', 0)]\r\n2024-12-13T20:58:59.712288694-06:00 stderr F 2024-12-13 20:58:59.711 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 22\r\n2024-12-13T20:58:59.714700681-06:00 stderr F 2024-12-13 20:58:59.713 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 22\r\n2024-12-13T20:58:59.714896281-06:00 stderr F 2024-12-13 20:58:59.713 DEBUG (MainThread) [homeassistant.components.mqtt.client] Subscribing with mid: 2 to topics with qos: [('homeassistant/binary_sensor/+/config', 0)]\r\n2024-12-13T20:58:59.715137281-06:00 stderr F 2024-12-13 20:58:59.713 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 22\r\n2024-12-13T20:58:59.716015646-06:00 stderr F 2024-12-13 20:58:59.715 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 22\r\n2024-12-13T20:58:59.716423828-06:00 stderr F 2024-12-13 20:58:59.716 DEBUG (MainThread) [homeassistant.components.mqtt.client] Subscribing with mid: 3 to topics with qos: [('homeassistant/button/+/config', 0)]\r\n2024-12-13T20:58:59.718003599-06:00 stderr F 2024-12-13 20:58:59.717 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 22\r\n2024-12-13T20:58:59.721468150-06:00 stderr F 2024-12-13 20:58:59.721 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 22\r\n2024-12-13T20:58:59.721966963-06:00 stderr F 2024-12-13 20:58:59.721 DEBUG (MainThread) [homeassistant.components.mqtt.client] Subscribing with mid: 4 to topics with qos: [('homeassistant/camera/+/config', 0)]\r\n2024-12-13T20:58:59.728226256-06:00 stderr F 2024-12-13 20:58:59.727 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 22\r\n2024-12-13T20:58:59.734744997-06:00 stderr F 2024-12-13 20:58:59.733 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 22\r\n2024-12-13T20:58:59.734999529-06:00 stderr F 2024-12-13 20:58:59.733 DEBUG (MainThread) [homeassistant.components.mqtt.client] Subscribing with mid: 5 to topics with qos: [('homeassistant/climate/+/config', 0)]\r\n2024-12-13T20:58:59.740782036-06:00 stderr F 2024-12-13 20:58:59.740 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 22\r\n2024-12-13T20:58:59.743159606-06:00 stderr F 2024-12-13 20:58:59.742 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 22\r\n2024-12-13T20:58:59.743392011-06:00 stderr F 2024-12-13 20:58:59.742 DEBUG (MainThread) [homeassistant.components.mqtt.client] Subscribing with mid: 6 to topics with qos: [('homeassistant/cover/+/config', 0)]\r\n2024-12-13T20:58:59.744134645-06:00 stderr F 2024-12-13 20:58:59.743 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 22\r\n2024-12-13T20:58:59.755919374-06:00 stderr F 2024-12-13 20:58:59.755 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 22\r\n2024-12-13T20:58:59.761741992-06:00 stderr F 2024-12-13 20:58:59.755 DEBUG (MainThread) [homeassistant.components.mqtt.client] Subscribing with mid: 7 to topics with qos: [('homeassistant/device_automation/+/config', 0)]\r\n2024-12-13T20:58:59.766660905-06:00 stderr F 2024-12-13 20:58:59.760 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 22\r\n2024-12-13T20:58:59.766941121-06:00 stderr F 2024-12-13 20:58:59.765 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 22\r\n2024-12-13T20:58:59.767222080-06:00 stderr F 2024-12-13 20:58:59.765 DEBUG (MainThread) [homeassistant.components.mqtt.client] Subscribing with mid: 8 to topics with qos: [('homeassistant/device_tracker/+/config', 0)]\r\n2024-12-13T20:58:59.767568759-06:00 stderr F 2024-12-13 20:58:59.766 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 22\r\n2024-12-13T20:58:59.768849209-06:00 stderr F 2024-12-13 20:58:59.768 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 22\r\n2024-12-13T20:58:59.770587516-06:00 stderr F 2024-12-13 20:58:59.768 DEBUG (MainThread) [homeassistant.components.mqtt.client] Subscribing with mid: 9 to topics with qos: [('homeassistant/event/+/config', 0)]\r\n2024-12-13T20:58:59.770843895-06:00 stderr F 2024-12-13 20:58:59.769 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 22\r\n2024-12-13T20:58:59.772213656-06:00 stderr F 2024-12-13 20:58:59.771 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 22\r\n2024-12-13T20:58:59.772455888-06:00 stderr F 2024-12-13 20:58:59.771 DEBUG (MainThread) [homeassistant.components.mqtt.client] Subscribing with mid: 10 to topics with qos: [('homeassistant/fan/+/config', 0)]\r\n2024-12-13T20:58:59.774400589-06:00 stderr F 2024-12-13 20:58:59.773 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 22\r\n2024-12-13T20:58:59.783111872-06:00 stderr F 2024-12-13 20:58:59.778 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 22\r\n2024-12-13T20:58:59.783419887-06:00 stderr F 2024-12-13 20:58:59.778 DEBUG (MainThread) [homeassistant.components.mqtt.client] Subscribing with mid: 11 to topics with qos: [('homeassistant/humidifier/+/config', 0)]\r\n2024-12-13T20:58:59.783694671-06:00 stderr F 2024-12-13 20:58:59.779 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 22\r\n2024-12-13T20:58:59.783888763-06:00 stderr F 2024-12-13 20:58:59.782 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 22\r\n2024-12-13T20:58:59.784124352-06:00 stderr F 2024-12-13 20:58:59.782 DEBUG (MainThread) [homeassistant.components.mqtt.client] Subscribing with mid: 12 to topics with qos: [('homeassistant/image/+/config', 0)]\r\n2024-12-13T20:58:59.784877421-06:00 stderr F 2024-12-13 20:58:59.784 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 22\r\n2024-12-13T20:58:59.787347227-06:00 stderr F 2024-12-13 20:58:59.786 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 22\r\n2024-12-13T20:58:59.787582941-06:00 stderr F 2024-12-13 20:58:59.786 DEBUG (MainThread) [homeassistant.components.mqtt.client] Subscribing with mid: 13 to topics with qos: [('homeassistant/lawn_mower/+/config', 0)]\r\n2024-12-13T20:58:59.788763901-06:00 stderr F 2024-12-13 20:58:59.787 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 22\r\n2024-12-13T20:58:59.798953841-06:00 stderr F 2024-12-13 20:58:59.789 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 22\r\n2024-12-13T20:58:59.799307245-06:00 stderr F 2024-12-13 20:58:59.790 DEBUG (MainThread) [homeassistant.components.mqtt.client] Subscribing with mid: 14 to topics with qos: [('homeassistant/light/+/config', 0)]\r\n2024-12-13T20:58:59.799609045-06:00 stderr F 2024-12-13 20:58:59.796 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 22\r\n2024-12-13T20:58:59.807687188-06:00 stderr F 2024-12-13 20:58:59.801 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 22\r\n2024-12-13T20:58:59.807977296-06:00 stderr F 2024-12-13 20:58:59.801 DEBUG (MainThread) [homeassistant.components.mqtt.client] Subscribing with mid: 15 to topics with qos: [('homeassistant/lock/+/config', 0)]\r\n2024-12-13T20:58:59.816432209-06:00 stderr F 2024-12-13 20:58:59.815 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 22\r\n2024-12-13T20:58:59.816733601-06:00 stderr F 2024-12-13 20:58:59.815 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 22\r\n2024-12-13T20:58:59.830278492-06:00 stderr F 2024-12-13 20:58:59.815 DEBUG (MainThread) [homeassistant.components.mqtt.client] Subscribing with mid: 16 to topics with qos: [('homeassistant/notify/+/config', 0)]\r\n2024-12-13T20:58:59.830539902-06:00 stderr F 2024-12-13 20:58:59.822 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 22\r\n2024-12-13T20:58:59.846849466-06:00 stderr F 2024-12-13 20:58:59.836 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 22\r\n2024-12-13T20:58:59.847087177-06:00 stderr F 2024-12-13 20:58:59.836 DEBUG (MainThread) [homeassistant.components.mqtt.client] Subscribing with mid: 17 to topics with qos: [('homeassistant/number/+/config', 0)]\r\n2024-12-13T20:58:59.851715325-06:00 stderr F 2024-12-13 20:58:59.850 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 22\r\n2024-12-13T20:58:59.853269491-06:00 stderr F 2024-12-13 20:58:59.852 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 22\r\n2024-12-13T20:58:59.854355723-06:00 stderr F 2024-12-13 20:58:59.852 DEBUG (MainThread) [homeassistant.components.mqtt.client] Subscribing with mid: 18 to topics with qos: [('homeassistant/scene/+/config', 0)]\r\n2024-12-13T20:58:59.855696990-06:00 stderr F 2024-12-13 20:58:59.853 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 22\r\n2024-12-13T20:58:59.856873237-06:00 stderr F 2024-12-13 20:58:59.856 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 22\r\n2024-12-13T20:58:59.857048669-06:00 stderr F 2024-12-13 20:58:59.856 DEBUG (MainThread) [homeassistant.components.mqtt.client] Subscribing with mid: 19 to topics with qos: [('homeassistant/siren/+/config', 0)]\r\n2024-12-13T20:58:59.857545061-06:00 stderr F 2024-12-13 20:58:59.857 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 22\r\n2024-12-13T20:58:59.860217166-06:00 stderr F 2024-12-13 20:58:59.859 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 22\r\n2024-12-13T20:58:59.860407816-06:00 stderr F 2024-12-13 20:58:59.859 DEBUG (MainThread) [homeassistant.components.mqtt.client] Subscribing with mid: 20 to topics with qos: [('homeassistant/select/+/config', 0)]\r\n2024-12-13T20:58:59.860630658-06:00 stderr F 2024-12-13 20:58:59.859 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 22\r\n2024-12-13T20:58:59.863789422-06:00 stderr F 2024-12-13 20:58:59.862 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 22\r\n2024-12-13T20:58:59.872036201-06:00 stderr F 2024-12-13 20:58:59.862 DEBUG (MainThread) [homeassistant.components.mqtt.client] Subscribing with mid: 21 to topics with qos: [('homeassistant/sensor/+/config', 0)]\r\n2024-12-13T20:58:59.872335930-06:00 stderr F 2024-12-13 20:58:59.863 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 22\r\n2024-12-13T20:58:59.873162052-06:00 stderr F 2024-12-13 20:58:59.872 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 22\r\n2024-12-13T20:58:59.873454190-06:00 stderr F 2024-12-13 20:58:59.872 DEBUG (MainThread) [homeassistant.components.mqtt.client] Subscribing with mid: 22 to topics with qos: [('homeassistant/switch/+/config', 0)]\r\n2024-12-13T20:58:59.881010324-06:00 stderr F 2024-12-13 20:58:59.880 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 22\r\n2024-12-13T20:58:59.895503958-06:00 stderr F 2024-12-13 20:58:59.893 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 22\r\n2024-12-13T20:58:59.896951670-06:00 stderr F 2024-12-13 20:58:59.893 DEBUG (MainThread) [homeassistant.components.mqtt.client] Subscribing with mid: 23 to topics with qos: [('homeassistant/tag/+/config', 0)]\r\n2024-12-13T20:58:59.897295519-06:00 stderr F 2024-12-13 20:58:59.894 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 22\r\n2024-12-13T20:58:59.903831154-06:00 stderr F 2024-12-13 20:58:59.903 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 22\r\n2024-12-13T20:58:59.904078795-06:00 stderr F 2024-12-13 20:58:59.903 DEBUG (MainThread) [homeassistant.components.mqtt.client] Subscribing with mid: 24 to topics with qos: [('homeassistant/text/+/config', 0)]\r\n2024-12-13T20:58:59.910352364-06:00 stderr F 2024-12-13 20:58:59.904 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 22\r\n2024-12-13T20:58:59.913458907-06:00 stderr F 2024-12-13 20:58:59.912 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 22\r\n2024-12-13T20:58:59.914262643-06:00 stderr F 2024-12-13 20:58:59.913 DEBUG (MainThread) [homeassistant.components.mqtt.client] Subscribing with mid: 25 to topics with qos: [('homeassistant/update/+/config', 0)]\r\n2024-12-13T20:58:59.920567341-06:00 stderr F 2024-12-13 20:58:59.914 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 22\r\n2024-12-13T20:58:59.938989672-06:00 stderr F 2024-12-13 20:58:59.934 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 22\r\n2024-12-13T20:58:59.939226136-06:00 stderr F 2024-12-13 20:58:59.934 DEBUG (MainThread) [homeassistant.components.mqtt.client] Subscribing with mid: 26 to topics with qos: [('homeassistant/vacuum/+/config', 0)]\r\n2024-12-13T20:58:59.939880895-06:00 stderr F 2024-12-13 20:58:59.939 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 22\r\n2024-12-13T20:58:59.941063588-06:00 stderr F 2024-12-13 20:58:59.940 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 22\r\n2024-12-13T20:58:59.941694007-06:00 stderr F 2024-12-13 20:58:59.941 DEBUG (MainThread) [homeassistant.components.mqtt.client] Subscribing with mid: 27 to topics with qos: [('homeassistant/valve/+/config', 0)]\r\n2024-12-13T20:58:59.942143678-06:00 stderr F 2024-12-13 20:58:59.941 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 22\r\n2024-12-13T20:58:59.944264100-06:00 stderr F 2024-12-13 20:58:59.943 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 22\r\n2024-12-13T20:58:59.945041855-06:00 stderr F 2024-12-13 20:58:59.944 DEBUG (MainThread) [homeassistant.components.mqtt.client] Subscribing with mid: 28 to topics with qos: [('homeassistant/water_heater/+/config', 0)]\r\n2024-12-13T20:58:59.948512778-06:00 stderr F 2024-12-13 20:58:59.948 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 22\r\n2024-12-13T20:58:59.952783429-06:00 stderr F 2024-12-13 20:58:59.952 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 22\r\n2024-12-13T20:58:59.953322810-06:00 stderr F 2024-12-13 20:58:59.952 DEBUG (MainThread) [homeassistant.components.mqtt.client] Subscribing with mid: 29 to topics with qos: [('homeassistant/alarm_control_panel/+/+/config', 0)]\r\n2024-12-13T20:58:59.959166307-06:00 stderr F 2024-12-13 20:58:59.953 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 22\r\n2024-12-13T20:58:59.968038100-06:00 stderr F 2024-12-13 20:58:59.967 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 22\r\n2024-12-13T20:58:59.968267702-06:00 stderr F 2024-12-13 20:58:59.967 DEBUG (MainThread) [homeassistant.components.mqtt.client] Subscribing with mid: 30 to topics with qos: [('homeassistant/binary_sensor/+/+/config', 0)]\r\n2024-12-13T20:58:59.968892197-06:00 stderr F 2024-12-13 20:58:59.968 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 22\r\n2024-12-13T20:58:59.973087606-06:00 stderr F 2024-12-13 20:58:59.972 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 22\r\n2024-12-13T20:58:59.973725481-06:00 stderr F 2024-12-13 20:58:59.973 DEBUG (MainThread) [homeassistant.components.mqtt.client] Subscribing with mid: 31 to topics with qos: [('homeassistant/button/+/+/config', 0)]\r\n2024-12-13T20:58:59.974260229-06:00 stderr F 2024-12-13 20:58:59.973 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 22\r\n2024-12-13T20:58:59.977205501-06:00 stderr F 2024-12-13 20:58:59.976 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 22\r\n2024-12-13T20:58:59.977604815-06:00 stderr F 2024-12-13 20:58:59.977 DEBUG (MainThread) [homeassistant.components.mqtt.client] Subscribing with mid: 32 to topics with qos: [('homeassistant/camera/+/+/config', 0)]\r\n2024-12-13T20:59:00.005067443-06:00 stderr F 2024-12-13 20:59:00.004 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 22\r\n2024-12-13T20:59:00.007743154-06:00 stderr F 2024-12-13 20:59:00.006 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 22\r\n2024-12-13T20:59:00.007955473-06:00 stderr F 2024-12-13 20:59:00.007 DEBUG (MainThread) [homeassistant.components.mqtt.client] Subscribing with mid: 33 to topics with qos: [('homeassistant/climate/+/+/config', 0)]\r\n2024-12-13T20:59:00.012578466-06:00 stderr F 2024-12-13 20:59:00.012 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 22\r\n2024-12-13T20:59:00.040430233-06:00 stderr F 2024-12-13 20:59:00.026 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 22\r\n2024-12-13T20:59:00.040729569-06:00 stderr F 2024-12-13 20:59:00.026 DEBUG (MainThread) [homeassistant.components.mqtt.client] Subscribing with mid: 34 to topics with qos: [('homeassistant/cover/+/+/config', 0)]\r\n2024-12-13T20:59:00.047012523-06:00 stderr F 2024-12-13 20:59:00.046 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 22\r\n2024-12-13T20:59:00.079044046-06:00 stderr F 2024-12-13 20:59:00.072 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 22\r\n2024-12-13T20:59:00.079267939-06:00 stderr F 2024-12-13 20:59:00.072 DEBUG (MainThread) [homeassistant.components.mqtt.client] Subscribing with mid: 35 to topics with qos: [('homeassistant/device_automation/+/+/config', 0)]\r\n2024-12-13T20:59:00.082471722-06:00 stderr F 2024-12-13 20:59:00.079 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 22\r\n2024-12-13T20:59:00.085562055-06:00 stderr F 2024-12-13 20:59:00.082 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 22\r\n2024-12-13T20:59:00.085809401-06:00 stderr F 2024-12-13 20:59:00.083 DEBUG (MainThread) [homeassistant.components.mqtt.client] Subscribing with mid: 36 to topics with qos: [('homeassistant/device_tracker/+/+/config', 0)]\r\n2024-12-13T20:59:00.086324626-06:00 stderr F 2024-12-13 20:59:00.085 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 22\r\n2024-12-13T20:59:00.089177609-06:00 stderr F 2024-12-13 20:59:00.088 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 22\r\n2024-12-13T20:59:00.089508594-06:00 stderr F 2024-12-13 20:59:00.088 DEBUG (MainThread) [homeassistant.components.mqtt.client] Subscribing with mid: 37 to topics with qos: [('homeassistant/event/+/+/config', 0)]\r\n2024-12-13T20:59:00.090934426-06:00 stderr F 2024-12-13 20:59:00.090 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 22\r\n2024-12-13T20:59:00.093687848-06:00 stderr F 2024-12-13 20:59:00.093 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 22\r\n2024-12-13T20:59:00.093949309-06:00 stderr F 2024-12-13 20:59:00.093 DEBUG (MainThread) [homeassistant.components.mqtt.client] Subscribing with mid: 38 to topics with qos: [('homeassistant/fan/+/+/config', 0)]\r\n2024-12-13T20:59:00.094509439-06:00 stderr F 2024-12-13 20:59:00.094 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 22\r\n2024-12-13T20:59:00.096690449-06:00 stderr F 2024-12-13 20:59:00.096 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 22\r\n2024-12-13T20:59:00.096936835-06:00 stderr F 2024-12-13 20:59:00.096 DEBUG (MainThread) [homeassistant.components.mqtt.client] Subscribing with mid: 39 to topics with qos: [('homeassistant/humidifier/+/+/config', 0)]\r\n2024-12-13T20:59:00.097707602-06:00 stderr F 2024-12-13 20:59:00.097 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 22\r\n2024-12-13T20:59:00.099443966-06:00 stderr F 2024-12-13 20:59:00.098 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 22\r\n2024-12-13T20:59:00.100673870-06:00 stderr F 2024-12-13 20:59:00.098 DEBUG (MainThread) [homeassistant.components.mqtt.client] Subscribing with mid: 40 to topics with qos: [('homeassistant/image/+/+/config', 0)]\r\n2024-12-13T20:59:00.100950510-06:00 stderr F 2024-12-13 20:59:00.099 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 22\r\n2024-12-13T20:59:00.103142084-06:00 stderr F 2024-12-13 20:59:00.101 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 22\r\n2024-12-13T20:59:00.103709876-06:00 stderr F 2024-12-13 20:59:00.101 DEBUG (MainThread) [homeassistant.components.mqtt.client] Subscribing with mid: 41 to topics with qos: [('homeassistant/lawn_mower/+/+/config', 0)]\r\n2024-12-13T20:59:00.103980166-06:00 stderr F 2024-12-13 20:59:00.102 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 22\r\n2024-12-13T20:59:00.109024712-06:00 stderr F 2024-12-13 20:59:00.104 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 22\r\n2024-12-13T20:59:00.109024712-06:00 stderr F 2024-12-13 20:59:00.104 DEBUG (MainThread) [homeassistant.components.mqtt.client] Subscribing with mid: 42 to topics with qos: [('homeassistant/light/+/+/config', 0)]\r\n2024-12-13T20:59:00.109024712-06:00 stderr F 2024-12-13 20:59:00.105 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 22\r\n2024-12-13T20:59:00.109587248-06:00 stderr F 2024-12-13 20:59:00.108 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 22\r\n2024-12-13T20:59:00.109838087-06:00 stderr F 2024-12-13 20:59:00.108 DEBUG (MainThread) [homeassistant.components.mqtt.client] Subscribing with mid: 43 to topics with qos: [('homeassistant/lock/+/+/config', 0)]\r\n2024-12-13T20:59:00.110098462-06:00 stderr F 2024-12-13 20:59:00.109 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 22\r\n2024-12-13T20:59:00.111962271-06:00 stderr F 2024-12-13 20:59:00.111 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 22\r\n2024-12-13T20:59:00.112273819-06:00 stderr F 2024-12-13 20:59:00.111 DEBUG (MainThread) [homeassistant.components.mqtt.client] Subscribing with mid: 44 to topics with qos: [('homeassistant/notify/+/+/config', 0)]\r\n2024-12-13T20:59:00.113036801-06:00 stderr F 2024-12-13 20:59:00.112 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 22\r\n2024-12-13T20:59:00.126770773-06:00 stderr F 2024-12-13 20:59:00.125 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 22\r\n2024-12-13T20:59:00.127031946-06:00 stderr F 2024-12-13 20:59:00.126 DEBUG (MainThread) [homeassistant.components.mqtt.client] Subscribing with mid: 45 to topics with qos: [('homeassistant/number/+/+/config', 0)]\r\n2024-12-13T20:59:00.127874771-06:00 stderr F 2024-12-13 20:59:00.127 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 22\r\n2024-12-13T20:59:00.130656913-06:00 stderr F 2024-12-13 20:59:00.129 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 22\r\n2024-12-13T20:59:00.130922721-06:00 stderr F 2024-12-13 20:59:00.130 DEBUG (MainThread) [homeassistant.components.mqtt.client] Subscribing with mid: 46 to topics with qos: [('homeassistant/scene/+/+/config', 0)]\r\n2024-12-13T20:59:00.131567575-06:00 stderr F 2024-12-13 20:59:00.131 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 22\r\n2024-12-13T20:59:00.135162404-06:00 stderr F 2024-12-13 20:59:00.134 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 22\r\n2024-12-13T20:59:00.136378826-06:00 stderr F 2024-12-13 20:59:00.135 DEBUG (MainThread) [homeassistant.components.mqtt.client] Subscribing with mid: 47 to topics with qos: [('homeassistant/siren/+/+/config', 0)]\r\n2024-12-13T20:59:00.136991416-06:00 stderr F 2024-12-13 20:59:00.136 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 22\r\n2024-12-13T20:59:00.139499876-06:00 stderr F 2024-12-13 20:59:00.138 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 22\r\n2024-12-13T20:59:00.139775042-06:00 stderr F 2024-12-13 20:59:00.138 DEBUG (MainThread) [homeassistant.components.mqtt.client] Subscribing with mid: 48 to topics with qos: [('homeassistant/select/+/+/config', 0)]\r\n2024-12-13T20:59:00.143630402-06:00 stderr F 2024-12-13 20:59:00.141 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 22\r\n2024-12-13T20:59:00.143914827-06:00 stderr F 2024-12-13 20:59:00.142 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 22\r\n2024-12-13T20:59:00.144366407-06:00 stderr F 2024-12-13 20:59:00.142 DEBUG (MainThread) [homeassistant.components.mqtt.client] Subscribing with mid: 49 to topics with qos: [('homeassistant/sensor/+/+/config', 0)]\r\n2024-12-13T20:59:00.144420729-06:00 stderr F 2024-12-13 20:59:00.142 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 22\r\n2024-12-13T20:59:00.146333782-06:00 stderr F 2024-12-13 20:59:00.145 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 22\r\n2024-12-13T20:59:00.147306140-06:00 stderr F 2024-12-13 20:59:00.145 DEBUG (MainThread) [homeassistant.components.mqtt.client] Subscribing with mid: 50 to topics with qos: [('homeassistant/switch/+/+/config', 0)]\r\n2024-12-13T20:59:00.147620987-06:00 stderr F 2024-12-13 20:59:00.146 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 22\r\n2024-12-13T20:59:00.150065989-06:00 stderr F 2024-12-13 20:59:00.149 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 22\r\n2024-12-13T20:59:00.150594661-06:00 stderr F 2024-12-13 20:59:00.149 DEBUG (MainThread) [homeassistant.components.mqtt.client] Subscribing with mid: 51 to topics with qos: [('homeassistant/tag/+/+/config', 0)]\r\n2024-12-13T20:59:00.151332312-06:00 stderr F 2024-12-13 20:59:00.150 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 22\r\n2024-12-13T20:59:00.158886493-06:00 stderr F 2024-12-13 20:59:00.156 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 22\r\n2024-12-13T20:59:00.159213257-06:00 stderr F 2024-12-13 20:59:00.156 DEBUG (MainThread) [homeassistant.components.mqtt.client] Subscribing with mid: 52 to topics with qos: [('homeassistant/text/+/+/config', 0)]\r\n2024-12-13T20:59:00.160820370-06:00 stderr F 2024-12-13 20:59:00.159 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 22\r\n2024-12-13T20:59:00.163215221-06:00 stderr F 2024-12-13 20:59:00.162 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 22\r\n2024-12-13T20:59:00.163541492-06:00 stderr F 2024-12-13 20:59:00.162 DEBUG (MainThread) [homeassistant.components.mqtt.client] Subscribing with mid: 53 to topics with qos: [('homeassistant/update/+/+/config', 0)]\r\n2024-12-13T20:59:00.164536070-06:00 stderr F 2024-12-13 20:59:00.163 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 22\r\n2024-12-13T20:59:00.166599904-06:00 stderr F 2024-12-13 20:59:00.165 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 22\r\n2024-12-13T20:59:00.167742690-06:00 stderr F 2024-12-13 20:59:00.165 DEBUG (MainThread) [homeassistant.components.mqtt.client] Subscribing with mid: 54 to topics with qos: [('homeassistant/vacuum/+/+/config', 0)]\r\n2024-12-13T20:59:00.168785735-06:00 stderr F 2024-12-13 20:59:00.168 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 22\r\n2024-12-13T20:59:00.170519702-06:00 stderr F 2024-12-13 20:59:00.169 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 22\r\n2024-12-13T20:59:00.170822087-06:00 stderr F 2024-12-13 20:59:00.169 DEBUG (MainThread) [homeassistant.components.mqtt.client] Subscribing with mid: 55 to topics with qos: [('homeassistant/valve/+/+/config', 0)]\r\n2024-12-13T20:59:00.171244915-06:00 stderr F 2024-12-13 20:59:00.170 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 22\r\n2024-12-13T20:59:00.175154507-06:00 stderr F 2024-12-13 20:59:00.174 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 22\r\n2024-12-13T20:59:00.175433046-06:00 stderr F 2024-12-13 20:59:00.174 DEBUG (MainThread) [homeassistant.components.mqtt.client] Subscribing with mid: 56 to topics with qos: [('homeassistant/water_heater/+/+/config', 0)]\r\n2024-12-13T20:59:00.175879426-06:00 stderr F 2024-12-13 20:59:00.175 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 22\r\n2024-12-13T20:59:00.178987679-06:00 stderr F 2024-12-13 20:59:00.178 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 22\r\n2024-12-13T20:59:00.179648902-06:00 stderr F 2024-12-13 20:59:00.178 DEBUG (MainThread) [homeassistant.components.mqtt.client] Subscribing with mid: 57 to topics with qos: [('homeassistant/device/+/config', 0)]\r\n2024-12-13T20:59:00.179955411-06:00 stderr F 2024-12-13 20:59:00.179 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 22\r\n2024-12-13T20:59:00.185276708-06:00 stderr F 2024-12-13 20:59:00.184 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 22\r\n2024-12-13T20:59:00.185688706-06:00 stderr F 2024-12-13 20:59:00.184 DEBUG (MainThread) [homeassistant.components.mqtt.client] Subscribing with mid: 58 to topics with qos: [('homeassistant/device/+/+/config', 0)]\r\n2024-12-13T20:59:00.189432281-06:00 stderr F 2024-12-13 20:59:00.186 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 22\r\n2024-12-13T20:59:00.190901863-06:00 stderr F 2024-12-13 20:59:00.187 ERROR (SyncWorker_1) [aiodhcpwatcher] Cannot watch for dhcp packets: [Errno 1] Operation not permitted\r\n2024-12-13T20:59:00.192818905-06:00 stderr F 2024-12-13 20:59:00.191 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 22\r\n2024-12-13T20:59:00.193053468-06:00 stderr F 2024-12-13 20:59:00.191 DEBUG (MainThread) [homeassistant.components.mqtt.client] Subscribing with mid: 59 to topics with qos: [('drop_connect/discovery/#', 0)]\r\n2024-12-13T20:59:00.196103425-06:00 stderr F 2024-12-13 20:59:00.194 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 22\r\n2024-12-13T20:59:00.202546569-06:00 stderr F 2024-12-13 20:59:00.201 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 22\r\n2024-12-13T20:59:00.202887537-06:00 stderr F 2024-12-13 20:59:00.201 DEBUG (MainThread) [homeassistant.components.mqtt.client] Subscribing with mid: 60 to topics with qos: [('dsmr/#', 0)]\r\n2024-12-13T20:59:00.207476946-06:00 stderr F 2024-12-13 20:59:00.206 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 22\r\n2024-12-13T20:59:00.210002789-06:00 stderr F 2024-12-13 20:59:00.208 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 22\r\n2024-12-13T20:59:00.210301744-06:00 stderr F 2024-12-13 20:59:00.208 DEBUG (MainThread) [homeassistant.components.mqtt.client] Subscribing with mid: 61 to topics with qos: [('esphome/discover/#', 0)]\r\n2024-12-13T20:59:00.210967104-06:00 stderr F 2024-12-13 20:59:00.209 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 22\r\n2024-12-13T20:59:00.212297038-06:00 stderr F 2024-12-13 20:59:00.211 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 22\r\n2024-12-13T20:59:00.212572212-06:00 stderr F 2024-12-13 20:59:00.211 DEBUG (MainThread) [homeassistant.components.mqtt.client] Subscribing with mid: 62 to topics with qos: [('fully/deviceInfo/+', 0)]\r\n2024-12-13T20:59:00.213260220-06:00 stderr F 2024-12-13 20:59:00.212 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 22\r\n2024-12-13T20:59:00.217233977-06:00 stderr F 2024-12-13 20:59:00.216 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 22\r\n2024-12-13T20:59:00.219410746-06:00 stderr F 2024-12-13 20:59:00.218 DEBUG (MainThread) [homeassistant.components.mqtt.client] Subscribing with mid: 63 to topics with qos: [('tasmota/discovery/#', 0)]\r\n2024-12-13T20:59:00.221050886-06:00 stderr F 2024-12-13 20:59:00.219 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 22\r\n2024-12-13T20:59:05.221184517-06:00 stderr F 2024-12-13 20:59:05.220 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 22\r\n2024-12-13T20:59:05.221475342-06:00 stderr F 2024-12-13 20:59:05.220 DEBUG (MainThread) [homeassistant.components.mqtt.client] Transmitting message on homeassistant/status: 'online', mid: 64, qos: 0\r\n2024-12-13T20:59:05.222088887-06:00 stderr F 2024-12-13 20:59:05.221 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 22\r\n2024-12-13T20:59:05.222740798-06:00 stderr F 2024-12-13 20:59:05.222 INFO (MainThread) [homeassistant.components.mqtt.client] MQTT client initialized, birth message sent\r\n2024-12-13T20:59:18.603167289-06:00 stderr F 2024-12-13 20:59:18.601 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: register write 22\r\n2024-12-13T20:59:18.605734418-06:00 stderr F 2024-12-13 20:59:18.602 DEBUG (MainThread) [homeassistant.components.mqtt.client] Transmitting message on homeassistant/switch/1/power: 'OFF', mid: 65, qos: 0\r\n2024-12-13T20:59:18.606009345-06:00 stderr F 2024-12-13 20:59:18.603 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: unregister write 22\r\n2024-12-13T20:59:27.979391384-06:00 stderr F 2024-12-13 20:59:27.977 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: connection closed 22\r\n2024-12-13T20:59:27.980029244-06:00 stderr F 2024-12-13 20:59:27.979 DEBUG (MainThread) [homeassistant.components.mqtt.client] Disconnected from MQTT server mosquitto.mydomain.com:443 (7)\r\n```\r\n\r\n</details>\r\n\r\nI only have fragments of time to troubleshoot at the moment. I'll try the same test this weekend some time with debug logging on for everything to see if that turns up anything.\r\n\nDid you test without the proxy service in between?\r\nDo you see the same if Mosquito is installed as an addon?\r\nDid you test without a TLS layer ( without SSL)?\r\n\nFound this link:\r\nhttps://stackoverflow.com/questions/71379937/configure-nginx-reverse-proxy-for-mqtt\r\n\r\nMaybe it is of any help?\nIf I skip Nginx and go right to the broker directly, I don't see the same issue. The MQTT client in HA attempts to reconnect every few seconds and eventually succeeds once the broker is ready.\r\n\r\nSo I just need to determine why the HA client doesn't attempt to reconnect when Nginx is involved even though other clients do. There must be something different among the various clients or their connections via the proxy. I'll dig into that some more.\nFor what it's worth, I tweaked the `_reconnect_loop` method in the client.py file to this:\r\n\r\n```python\r\nasync def _reconnect_loop(self) -> None:\r\n    \"\"\"Reconnect to the MQTT server.\"\"\"\r\n    _LOGGER.debug(\"Started _reconnect_loop\")\r\n    while True:\r\n        _LOGGER.debug(\"Connected status: %s\", self.connected)\r\n        if not self.connected:\r\n            try:\r\n                _LOGGER.debug(\"Entering connection lock\")\r\n                async with self._connection_lock, self._async_connect_in_executor():\r\n                    _LOGGER.debug(\"Adding reconnect executor job\")\r\n                    await self.hass.async_add_executor_job(self._mqttc.reconnect)\r\n            except OSError as err:\r\n                _LOGGER.debug(\r\n                    \"Error re-connecting to MQTT server due to exception: %s\", err\r\n                )\r\n\r\n        _LOGGER.debug(\"Entering sleep\")\r\n        await asyncio.sleep(RECONNECT_INTERVAL_SECONDS)\r\n        _LOGGER.debug(\"Exited sleep\")\r\n```\r\n\r\nBasically just adding debug statements on every line.\r\nIf I point at my proxy and run my test again, logs look like this:\r\n\r\n```\r\n2024-12-14T20:33:43.127498847-06:00 stderr F 2024-12-14 20:33:43.126 DEBUG (MainThread) [homeassistant.components.mqtt.client] mosquitto.mydomain.com: connection closed 25\r\n2024-12-14T20:33:43.128743687-06:00 stderr F 2024-12-14 20:33:43.126 DEBUG (MainThread) [homeassistant.components.mqtt.client] Started _reconnect_loop\r\n2024-12-14T20:33:43.128969237-06:00 stderr F 2024-12-14 20:33:43.126 DEBUG (MainThread) [homeassistant.components.mqtt.client] Connected status: True\r\n2024-12-14T20:33:43.129227593-06:00 stderr F 2024-12-14 20:33:43.126 DEBUG (MainThread) [homeassistant.components.mqtt.client] Entering sleep\r\n2024-12-14T20:33:43.129469099-06:00 stderr F 2024-12-14 20:33:43.127 DEBUG (MainThread) [homeassistant.components.mqtt.client] Disconnected from MQTT server mosquitto.mydomain.com:443 (7)\r\n2024-12-14T20:33:53.128922332-06:00 stderr F 2024-12-14 20:33:53.127 DEBUG (MainThread) [homeassistant.components.mqtt.client] Exited sleep\r\n2024-12-14T20:33:53.129726676-06:00 stderr F 2024-12-14 20:33:53.128 DEBUG (MainThread) [homeassistant.components.mqtt.client] Connected status: False\r\n2024-12-14T20:33:53.129960993-06:00 stderr F 2024-12-14 20:33:53.128 DEBUG (MainThread) [homeassistant.components.mqtt.client] Entering connection lock\r\n2024-12-14T20:33:53.130156956-06:00 stderr F 2024-12-14 20:33:53.128 DEBUG (MainThread) [homeassistant.components.mqtt.client] Adding reconnect executor job\r\n```\r\n\r\nI get nothing after that last log line. No errors. Just nothing.\r\n\r\nIn the test where I connect without the proxy, I get a few \"Error re-connecting to MQTT server due to exception:\" errors logged from that `except` branch until the broker is back online, and then finally connection made logs.\r\n\r\nAnyways, I'll keep trying stuff. I didn't find anything noteworthy while re-looking at Nginx configurations around websockets. Most things you find out there on Nginx websocket proxying is just getting clients to connect to upstreams, which isn't relevant since my clients are connecting fine and keeping healthy connections.\r\n\nMore oddities for me.\r\n\r\nIf I alter the code now to this instead:\r\n```python\r\n    def _testing(self) -> None:\r\n        _LOGGER.debug(\"Entered reconnect\")\r\n        time.sleep(15) # Only works if I put in a delay that prevents the attempt to reconnect until the broker is back online.\r\n        self._mqttc.reconnect()\r\n        _LOGGER.debug(\"Exited reconnect\")\r\n\r\n    async def _reconnect_loop(self) -> None:\r\n        \"\"\"Reconnect to the MQTT server.\"\"\"\r\n        _LOGGER.debug(\"Started _reconnect_loop\")\r\n        while True:\r\n            _LOGGER.debug(\"Connected status: %s\", self.connected)\r\n            if not self.connected:\r\n                try:\r\n                    _LOGGER.debug(\"Entering connection lock\")\r\n                    async with self._connection_lock, self._async_connect_in_executor():\r\n                        _LOGGER.debug(\"Adding reconnect executor job\")\r\n                        await self.hass.async_add_executor_job(self._testing)\r\n                except OSError as err:\r\n                    _LOGGER.debug(\r\n                        \"Error re-connecting to MQTT server due to exception: %s\", err\r\n                    )\r\n\r\n            _LOGGER.debug(\"Entering sleep\")\r\n            await asyncio.sleep(RECONNECT_INTERVAL_SECONDS)\r\n            _LOGGER.debug(\"Exited sleep\")\r\n```\r\n\r\nThis `sleep` delay until the broker is back online works! The client reconnects.\r\n\r\nWithout the delay, I see the log \"Entered reconnect\" and then nothing. It seems like something inside the paho mqtt client is locking up within the reconnect method.\r\nThough I'm still not sure how Nginx impacts that.\nFrom what I can see in Nginx access logs, the HA mqtt client does attempt to reconnect when the `self._mqttc.reconnect()` method is hit.\r\n\r\nNginx immediately returns with a 502 status code and a generic HTML message. I'm wondering if the paho client isn't handling this correctly? If I set it up to connect to the broker directly, it would just get a connection refused error instead of the served up 502 error that Nginx serves out.\r\n\r\nI'm trying to play around with serving difference responses in Nginx while the broker is down, but I haven't landed on anything that works yet. Even hanging up the connection when the mqtt client attempts to reconnect isn't working.\nIf you'd like to test without NGINX websockets you can also use:\r\nhttps://test.mosquitto.org/\r\n\nThanks, but I've mentioned a few times already about testing against my broker without Nginx, which is a helpful comparison.\r\n\r\nI ended up grabbing a simplified example of using paho's client directly in a test python script to recreate what was going on.\r\nThe `reconnect()` is raising the exception: `paho.mqtt.client.WebsocketConnectionError: WebSocket handshake error` while the broker is offline.\r\n\r\nIf I change the HA integration client to catch any exception type in addition to the OSError it is already catching, it all starts working again. HA reconnects just fine.\r\nSo it seems like the exception that is being raised just isn't being caught and is causing the reconnect loop to die.\r\n\r\nFor example, my working `_reconnect_loop` method looks like this now:\r\n```python\r\nasync def _reconnect_loop(self) -> None:\r\n        \"\"\"Reconnect to the MQTT server.\"\"\"\r\n        while True:\r\n            if not self.connected:\r\n                try:\r\n                    async with self._connection_lock, self._async_connect_in_executor():\r\n                        await self.hass.async_add_executor_job(self._mqttc.reconnect)\r\n                except OSError as err:\r\n                    _LOGGER.debug(\r\n                        \"Error re-connecting to MQTT server due to exception: %s\", err\r\n                    )\r\n                except Exception as err: # This catch all fixes it.\r\n                    _LOGGER.debug(\r\n                        \"Error re-connecting to MQTT server due to exception: %s\", err\r\n                    )\r\n\r\n            await asyncio.sleep(RECONNECT_INTERVAL_SECONDS)\r\n```\r\n\r\nI see the debug log: `Error re-connecting to MQTT server due to exception: WebSocket handshake error` and eventually a bunch of connected messages once the broker is back.\r\n\r\nFor some reason I can't get it to work right if I catch `mqtt.WebsocketConnectionError` instead of `Exception`.\r\n\nYou could try to print the error in the catch all except \nI'll try that later.\r\nWhy is just the `OSError` caught when any uncaught error causes the reconnect loop to die? Why not just have a single catch block with the `Exception` type?\n> I'll try that later. Why is just the `OSError` caught when any uncaught error causes the reconnect loop to die? Why not just have a single catch block with the `Exception` type?\r\n\r\nMay be we will add that later. But it is a principle not allow a broad except by design.\nWe don't want broad exception catches as they hide bugs https://pylint.readthedocs.io/en/latest/user_guide/messages/warning/broad-exception-caught.html\r\n\r\nloop_forever is documented to `Raises OSError/WebsocketConnectionError on first connection failures unless retry_first_connection=True`\r\n\r\nSo adding an exception catch for `WebsocketConnectionError` should be sufficient\r\n\r\n\r\n\nI don't disagree in general, I'm just thinking of the lessor evil in terms of recovering in critical systems that don't benefit from any high level reset watchdogs.\r\n\r\nAnyways, I'll try to determine why the catch on that specific exception type wasn't hitting when I tested last night when I get some more time later. I'm not that native to python, so there is a lot of stumbling around.\r\n\r\nI'm satisfied with the approach of just catching what is documented to raise since that should address my issue.", "created_at": "2024-12-19T19:32:18Z"}
{"repo": "home-assistant/core", "pull_number": 133597, "instance_id": "home-assistant__core-133597", "issue_numbers": ["131995"], "base_commit": "e357e0a406c648f957f845642e39a37ebcc68135", "patch": "diff --git a/homeassistant/components/music_assistant/media_player.py b/homeassistant/components/music_assistant/media_player.py\nindex 7d09bd5b888da6..7004f09aad5165 100644\n--- a/homeassistant/components/music_assistant/media_player.py\n+++ b/homeassistant/components/music_assistant/media_player.py\n@@ -565,17 +565,13 @@ def _update_media_attributes(\n             # shuffle and repeat are not (yet) supported for external sources\n             self._attr_shuffle = None\n             self._attr_repeat = None\n-            if TYPE_CHECKING:\n-                assert player.elapsed_time is not None\n-            self._attr_media_position = int(player.elapsed_time)\n+            self._attr_media_position = int(player.elapsed_time or 0)\n             self._attr_media_position_updated_at = (\n                 utc_from_timestamp(player.elapsed_time_last_updated)\n                 if player.elapsed_time_last_updated\n                 else None\n             )\n-            if TYPE_CHECKING:\n-                assert player.elapsed_time is not None\n-            self._prev_time = player.elapsed_time\n+            self._prev_time = player.elapsed_time or 0\n             return\n \n         if queue is None:\n", "test_patch": "diff --git a/tests/components/music_assistant/fixtures/players.json b/tests/components/music_assistant/fixtures/players.json\nindex 2d8b88d0e8e223..8a08a55dc45dc8 100644\n--- a/tests/components/music_assistant/fixtures/players.json\n+++ b/tests/components/music_assistant/fixtures/players.json\n@@ -20,7 +20,7 @@\n         \"power\",\n         \"enqueue\"\n       ],\n-      \"elapsed_time\": 0,\n+      \"elapsed_time\": null,\n       \"elapsed_time_last_updated\": 0,\n       \"state\": \"idle\",\n       \"volume_level\": 20,\n", "problem_statement": "Music Assistant TypeError int(player.elapsed_time)\n### The problem\n\nHome Assistant log reports TypeError int(player.elapsed_time) in Music Assistant media_player.py.\n\n### What version of Home Assistant Core has the issue?\n\ncore-2024.12.0b3\n\n### What was the last working version of Home Assistant Core?\n\ncore-2024.11.2\n\n### What type of installation are you running?\n\nHome Assistant OS\n\n### Integration causing the issue\n\nmusic_assistant\n\n### Link to integration documentation on our website\n\nhttps://rc.home-assistant.io/integrations/music_assistant\n\n### Diagnostics information\n\n_No response_\n\n### Example YAML snippet\n\n_No response_\n\n### Anything in the logs that might be useful for us?\n\n```txt\n2024-12-01 10:45:30.741 ERROR (MainThread) [homeassistant.components.media_player] Error adding entity media_player.denon_3 for domain media_player with platform music_assistant\r\nTraceback (most recent call last):\r\n  File \"/usr/src/homeassistant/homeassistant/helpers/entity_platform.py\", line 608, in _async_add_entities\r\n    await coro\r\n  File \"/usr/src/homeassistant/homeassistant/helpers/entity_platform.py\", line 927, in _async_add_entity\r\n    await entity.add_to_platform_finish()\r\n  File \"/usr/src/homeassistant/homeassistant/helpers/entity.py\", line 1367, in add_to_platform_finish\r\n    await self.async_added_to_hass()\r\n  File \"/usr/src/homeassistant/homeassistant/components/music_assistant/media_player.py\", line 205, in async_added_to_hass\r\n    await super().async_added_to_hass()\r\n  File \"/usr/src/homeassistant/homeassistant/components/music_assistant/entity.py\", line 43, in async_added_to_hass\r\n    await self.async_on_update()\r\n  File \"/usr/src/homeassistant/homeassistant/components/music_assistant/media_player.py\", line 274, in async_on_update\r\n    self._update_media_attributes(player, active_queue)\r\n    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/src/homeassistant/homeassistant/components/music_assistant/media_player.py\", line 571, in _update_media_attributes\r\n    self._attr_media_position = int(player.elapsed_time)\r\n                                ~~~^^^^^^^^^^^^^^^^^^^^^\r\nTypeError: int() argument must be a string, a bytes-like object or a real number, not 'NoneType'\n```\n\n\n### Additional information\n\n_No response_\n", "hints_text": "\nHey there @music-assistant, mind taking a look at this issue as it has been labeled with an integration (`music_assistant`) you are listed as a [code owner](https://github.com/home-assistant/core/blob/dev/CODEOWNERS#L959) for? Thanks!\n\n<details>\n<summary>Code owner commands</summary>\n\n\nCode owners of `music_assistant` can trigger bot actions by commenting:\n\n- `@home-assistant close` Closes the issue.\n- `@home-assistant rename Awesome new title` Renames the issue.\n- `@home-assistant reopen` Reopen the issue.\n- `@home-assistant unassign music_assistant` Removes the current integration label and assignees on the issue, add the integration domain after the command.\n- `@home-assistant add-label needs-more-information` Add a label (needs-more-information, problem in dependency, problem in custom component) to the issue.\n- `@home-assistant remove-label needs-more-information` Remove a label (needs-more-information, problem in dependency, problem in custom component) on the issue.\n\n</details>\n\n\n<sub><sup>(message by CodeOwnersMention)</sup></sub>\n\n---\n\n[music_assistant documentation](https://www.home-assistant.io/integrations/music_assistant)\n[music_assistant source](https://github.com/home-assistant/core/tree/dev/homeassistant/components/music_assistant)\n<sub><sup>(message by IssueLinks)</sup></sub>\nI getting the same for one TV, PC and my Yamaha AVR:\r\n```\r\nError adding entity media_player.tv_samsung_tv for domain media_player with platform music_assistant\r\nError adding entity media_player.mw_e3222 for domain media_player with platform music_assistant\r\nError adding entity media_player.rx_v573_stbnet for domain media_player with platform music_assistant\r\n``` \r\nI think the TV is not compatible then Samsung was doing some strange firmware for some early series but the Yamaha shall working OK and also the media share running Widows 10.\nThis is not an issue with Home Assistant, or the Music Assistant integration within Home Assistant. Somehow your player is reporting none/null for a value that should always be a number/integer.\r\n\r\nI will put a small fix in the code to at least not crash on this situation but keep an eye on the player if the progress reporting is working\r\n", "created_at": "2024-12-19T17:42:08Z"}
{"repo": "home-assistant/core", "pull_number": 133553, "instance_id": "home-assistant__core-133553", "issue_numbers": ["132865", "133397"], "base_commit": "cd384cadbef19cc23987f5994c30a8ee69d52a15", "patch": "diff --git a/homeassistant/components/recorder/history/modern.py b/homeassistant/components/recorder/history/modern.py\nindex 9159bbc6181e5..e9af4a673c38f 100644\n--- a/homeassistant/components/recorder/history/modern.py\n+++ b/homeassistant/components/recorder/history/modern.py\n@@ -28,7 +28,12 @@\n import homeassistant.util.dt as dt_util\n \n from ..const import LAST_REPORTED_SCHEMA_VERSION\n-from ..db_schema import SHARED_ATTR_OR_LEGACY_ATTRIBUTES, StateAttributes, States\n+from ..db_schema import (\n+    SHARED_ATTR_OR_LEGACY_ATTRIBUTES,\n+    StateAttributes,\n+    States,\n+    StatesMeta,\n+)\n from ..filters import Filters\n from ..models import (\n     LazyState,\n@@ -558,40 +563,38 @@ def _get_start_time_state_for_entities_stmt(\n     include_last_changed: bool,\n ) -> Select:\n     \"\"\"Baked query to get states for specific entities.\"\"\"\n-    # We got an include-list of entities, accelerate the query by filtering already\n-    # in the inner and the outer query.\n+    # This query is the result of significant research in\n+    # https://github.com/home-assistant/core/issues/132865\n+    # A reverse index scan with a limit 1 is the fastest way to get the\n+    # last state change before a specific point in time for all supported\n+    # databases. Since all databases support this query as a join\n+    # condition we can use it as a subquery to get the last state change\n+    # before a specific point in time for all entities.\n     stmt = (\n         _stmt_and_join_attributes_for_start_state(\n             no_attributes, include_last_changed, False\n         )\n+        .select_from(StatesMeta)\n         .join(\n-            (\n-                most_recent_states_for_entities_by_date := (\n-                    select(\n-                        States.metadata_id.label(\"max_metadata_id\"),\n-                        func.max(States.last_updated_ts).label(\"max_last_updated\"),\n-                    )\n-                    .filter(\n-                        (States.last_updated_ts >= run_start_ts)\n+            States,\n+            and_(\n+                States.last_updated_ts\n+                == (\n+                    select(States.last_updated_ts)\n+                    .where(\n+                        (StatesMeta.metadata_id == States.metadata_id)\n                         & (States.last_updated_ts < epoch_time)\n-                        & States.metadata_id.in_(metadata_ids)\n+                        & (States.last_updated_ts >= run_start_ts)\n                     )\n-                    .group_by(States.metadata_id)\n-                    .subquery()\n+                    .order_by(States.last_updated_ts.desc())\n+                    .limit(1)\n                 )\n+                .scalar_subquery()\n+                .correlate(StatesMeta),\n+                States.metadata_id == StatesMeta.metadata_id,\n             ),\n-            and_(\n-                States.metadata_id\n-                == most_recent_states_for_entities_by_date.c.max_metadata_id,\n-                States.last_updated_ts\n-                == most_recent_states_for_entities_by_date.c.max_last_updated,\n-            ),\n-        )\n-        .filter(\n-            (States.last_updated_ts >= run_start_ts)\n-            & (States.last_updated_ts < epoch_time)\n-            & States.metadata_id.in_(metadata_ids)\n         )\n+        .where(StatesMeta.metadata_id.in_(metadata_ids))\n     )\n     if no_attributes:\n         return stmt\ndiff --git a/homeassistant/components/recorder/statistics.py b/homeassistant/components/recorder/statistics.py\nindex 3f1d5b981e37e..c6783a5cbc2c5 100644\n--- a/homeassistant/components/recorder/statistics.py\n+++ b/homeassistant/components/recorder/statistics.py\n@@ -63,6 +63,7 @@\n     STATISTICS_TABLES,\n     Statistics,\n     StatisticsBase,\n+    StatisticsMeta,\n     StatisticsRuns,\n     StatisticsShortTerm,\n )\n@@ -2034,24 +2035,35 @@ def _generate_statistics_at_time_stmt(\n     types: set[Literal[\"last_reset\", \"max\", \"mean\", \"min\", \"state\", \"sum\"]],\n ) -> StatementLambdaElement:\n     \"\"\"Create the statement for finding the statistics for a given time.\"\"\"\n+    # This query is the result of significant research in\n+    # https://github.com/home-assistant/core/issues/132865\n+    # A reverse index scan with a limit 1 is the fastest way to get the\n+    # last start_time_ts before a specific point in time for all supported\n+    # databases. Since all databases support this query as a join\n+    # condition we can use it as a subquery to get the last start_time_ts\n+    # before a specific point in time for all entities.\n     stmt = _generate_select_columns_for_types_stmt(table, types)\n-    stmt += lambda q: q.join(\n-        (\n-            most_recent_statistic_ids := (\n-                select(\n-                    func.max(table.start_ts).label(\"max_start_ts\"),\n-                    table.metadata_id.label(\"max_metadata_id\"),\n+    stmt += (\n+        lambda q: q.select_from(StatisticsMeta)\n+        .join(\n+            table,\n+            and_(\n+                table.start_ts\n+                == (\n+                    select(table.start_ts)\n+                    .where(\n+                        (StatisticsMeta.id == table.metadata_id)\n+                        & (table.start_ts < start_time_ts)\n+                    )\n+                    .order_by(table.start_ts.desc())\n+                    .limit(1)\n                 )\n-                .filter(table.start_ts < start_time_ts)\n-                .filter(table.metadata_id.in_(metadata_ids))\n-                .group_by(table.metadata_id)\n-                .subquery()\n-            )\n-        ),\n-        and_(\n-            table.start_ts == most_recent_statistic_ids.c.max_start_ts,\n-            table.metadata_id == most_recent_statistic_ids.c.max_metadata_id,\n-        ),\n+                .scalar_subquery()\n+                .correlate(StatisticsMeta),\n+                table.metadata_id == StatisticsMeta.id,\n+            ),\n+        )\n+        .where(table.metadata_id.in_(metadata_ids))\n     )\n     return stmt\n \n", "test_patch": "", "problem_statement": "Poor SQL performance finding start time state/stat results in HA Blocking Indefinitely\n### The problem\r\n\r\nRandomly, I've yet to see a pattern, HA statistics will get stuck - nothing will update, no graphs, metrcis, etc.\r\n\r\nDigging into the SQL console, there will be a massive query that is chewing up CPU, and executing forever.   Killing this process seems to unblock it.  However it will randomly return.\r\n\r\n### What version of Home Assistant Core has the issue?\r\n\r\ncore-2024.12.1\r\n\r\n### What was the last working version of Home Assistant Core?\r\n\r\n_No response_\r\n\r\n### What type of installation are you running?\r\n\r\nHome Assistant Container\r\n\r\n### Integration causing the issue\r\n\r\n_No response_\r\n\r\n### Link to integration documentation on our website\r\n\r\n_No response_\r\n\r\n### Diagnostics information\r\n\r\n_No response_\r\n\r\n### Example YAML snippet\r\n\r\n_No response_\r\n\r\n### Anything in the logs that might be useful for us?\r\n\r\n```txt\r\nHere are some examples from the slow query log - it appears to be doing a full table scan.  Last one in the list is from when I killed it.\r\n\r\nhttps://gist.github.com/thenoid/8bb6f1b90bf40ea6627c1d9f864e6aa5\r\n\r\nRows Scanned : 27709990\r\n```\r\nIt feels like a race condition, in that it works *alot of the time* though slowly - but just will randomly get stuck.\r\n\r\n\r\n### Additional information\r\n\r\nI see other issues that were closed as stale referencing the same thing, seems like @bdraco needs access to the db? I'll gladly figure out something to make it work to help fix this regression.\nOptimize start time state queries for MySQL/MariaDB\n## Proposed change\r\n<!--\r\n  Describe the big picture of your changes here to communicate to the\r\n  maintainers why we should accept this pull request. If it fixes a bug\r\n  or resolves a feature request, be sure to link to that issue in the\r\n  additional information section.\r\n-->\r\nfixes #132865 (PostgreSQL case is not fixed by this PR and is in https://github.com/home-assistant/core/pull/133228, SQLite case is still being worked out)\r\n\r\nThe MariaDB/MySQL query optimizers will switch from using an index only scan to reading the table data when a GROUP BY has 1000 or more elements. We now chunk that need to find the start time to have a maximum of 999 metadata_ids to ensure the optimizer continues to use an index only scan since its multiple orders of magnitude faster.\r\n\r\n\r\nAs soon as we get over 999 metadata_ids\r\n\r\n\r\n<1000 is fine\r\n\r\n```\r\n+------+-------------+--------+-------+-----------------------------------------------------------------+---------------------------------------+---------+------+------+---------------------------------------+\r\n| id   | select_type | table  | type  | possible_keys                                                   | key                                   | key_len | ref  | rows | Extra                                 |\r\n+------+-------------+--------+-------+-----------------------------------------------------------------+---------------------------------------+---------+------+------+---------------------------------------+\r\n|    1 | SIMPLE      | states | range | ix_states_last_updated_ts,ix_states_metadata_id_last_updated_ts | ix_states_metadata_id_last_updated_ts | 18      | NULL | 999  | Using where; Using index for group-by |\r\n+------+-------------+--------+-------+-----------------------------------------------------------------+---------------------------------------+---------+------+------+---------------------------------------+\r\n1 row in set (0.010 sec)\r\n```\r\n\r\n\r\nwhere-as >=1000, the query optimizes completely differently and we end up with a temp table instead the `Using index for group-by` optimization.\r\n\r\n```\r\n+------+-------------+------------+------+-----------------------------------------------------------------+---------------------------------------+---------+--------------+------+---------------------------------+\r\n| id   | select_type | table      | type | possible_keys                                                   | key                                   | key_len | ref          | rows | Extra                           |\r\n+------+-------------+------------+------+-----------------------------------------------------------------+---------------------------------------+---------+--------------+------+---------------------------------+\r\n|    1 | PRIMARY     | <derived3> | ALL  | distinct_key                                                    | NULL                                  | NULL    | NULL         | 1396 | Using temporary; Using filesort |\r\n|    1 | PRIMARY     | states     | ref  | ix_states_last_updated_ts,ix_states_metadata_id_last_updated_ts | ix_states_metadata_id_last_updated_ts | 9       | tvc_0._col_1 | 558  | Using where; Using index        |\r\n|    3 | DERIVED     | NULL       | NULL | NULL                                                            | NULL                                  | NULL    | NULL         | NULL | No tables used                  |\r\n+------+-------------+------------+------+-----------------------------------------------------------------+---------------------------------------+---------+--------------+------+---------------------------------+\r\n```\r\n\r\n\r\n### Optimizer analysis\r\n\r\n`>=1000`\r\nhttps://github.com/home-assistant/core/issues/132865#issuecomment-2543165625\r\n\r\n`<1000`\r\nhttps://github.com/home-assistant/core/issues/132865#issuecomment-2543166587\r\n\r\n## Type of change\r\n<!--\r\n  What type of change does your PR introduce to Home Assistant?\r\n  NOTE: Please, check only 1! box!\r\n  If your PR requires multiple boxes to be checked, you'll most likely need to\r\n  split it into multiple PRs. This makes things easier and faster to code review.\r\n-->\r\n\r\n- [ ] Dependency upgrade\r\n- [x] Bugfix (non-breaking change which fixes an issue)\r\n- [ ] New integration (thank you!)\r\n- [ ] New feature (which adds functionality to an existing integration)\r\n- [ ] Deprecation (breaking change to happen in the future)\r\n- [ ] Breaking change (fix/feature causing existing functionality to break)\r\n- [ ] Code quality improvements to existing code or addition of tests\r\n\r\n## Additional information\r\n<!--\r\n  Details are important, and help maintainers processing your PR.\r\n  Please be sure to fill out additional details, if applicable.\r\n-->\r\n\r\n- This PR fixes or closes issue: fixes #120856\r\n- This PR is related to issue: \r\n- Link to documentation pull request: \r\n\r\n## Checklist\r\n<!--\r\n  Put an `x` in the boxes that apply. You can also fill these out after\r\n  creating the PR. If you're unsure about any of them, don't hesitate to ask.\r\n  We're here to help! This is simply a reminder of what we are going to look\r\n  for before merging your code.\r\n-->\r\n\r\n- [x] The code change is tested and works locally.\r\n- [ ] Local tests pass. **Your PR cannot be merged unless tests pass**\r\n- [ ] There is no commented out code in this PR.\r\n- [ ] I have followed the [development checklist][dev-checklist]\r\n- [ ] I have followed the [perfect PR recommendations][perfect-pr]\r\n- [ ] The code has been formatted using Ruff (`ruff format homeassistant tests`)\r\n- [x] Tests have been added to verify that the new code works.\r\n\r\nIf user exposed functionality or configuration variables are added/changed:\r\n\r\n- [ ] Documentation added/updated for [www.home-assistant.io][docs-repository]\r\n\r\nIf the code communicates with devices, web services, or third-party tools:\r\n\r\n- [ ] The [manifest file][manifest-docs] has all fields filled out correctly.  \r\n      Updated and included derived files by running: `python3 -m script.hassfest`.\r\n- [ ] New or updated dependencies have been added to `requirements_all.txt`.  \r\n      Updated by running `python3 -m script.gen_requirements_all`.\r\n- [ ] For the updated dependencies - a link to the changelog, or at minimum a diff between library versions is added to the PR description.\r\n\r\n<!--\r\n  This project is very active and we have a high turnover of pull requests.\r\n\r\n  Unfortunately, the number of incoming pull requests is higher than what our\r\n  reviewers can review and merge so there is a long backlog of pull requests\r\n  waiting for review. You can help here!\r\n  \r\n  By reviewing another pull request, you will help raise the code quality of\r\n  that pull request and the final review will be faster. This way the general\r\n  pace of pull request reviews will go up and your wait time will go down.\r\n  \r\n  When picking a pull request to review, try to choose one that hasn't yet\r\n  been reviewed.\r\n\r\n  Thanks for helping out!\r\n-->\r\n\r\nTo help with the load of incoming pull requests:\r\n\r\n- [ ] I have reviewed two other [open pull requests][prs] in this repository.\r\n\r\n[prs]: https://github.com/home-assistant/core/pulls?q=is%3Aopen+is%3Apr+-author%3A%40me+-draft%3Atrue+-label%3Awaiting-for-upstream+sort%3Acreated-desc+review%3Anone+-status%3Afailure\r\n\r\n<!--\r\n  Thank you for contributing <3\r\n\r\n  Below, some useful links you could explore:\r\n-->\r\n[dev-checklist]: https://developers.home-assistant.io/docs/development_checklist/\r\n[manifest-docs]: https://developers.home-assistant.io/docs/creating_integration_manifest/\r\n[quality-scale]: https://developers.home-assistant.io/docs/integration_quality_scale_index/\r\n[docs-repository]: https://github.com/home-assistant/home-assistant.io\r\n[perfect-pr]: https://developers.home-assistant.io/docs/review-process/#creating-the-perfect-pr\r\n\n", "hints_text": "Stuck again.\r\n\r\n```\r\nmysql> show full processlist \\G;\r\n*************************** 1. row ***************************\r\n      Id: 4\r\n    User: homeassistant\r\n    Host: 172.31.0.1:55022\r\n      db: ha_db\r\n Command: Query\r\n    Time: 5090\r\n   State: Creating sort index\r\n    Info: SELECT anon_1.metadata_id, anon_1.state, anon_1.last_updated_ts, anon_1.attributes \r\nFROM (SELECT anon_2.metadata_id AS metadata_id, anon_2.state AS state, anon_2.last_updated_ts AS last_updated_ts, anon_2.attributes AS attributes \r\nFROM (SELECT states.metadata_id AS metadata_id, states.state AS state, 0 AS last_updated_ts, CASE WHEN (state_attributes.shared_attrs IS NULL) THEN states.attributes ELSE state_attributes.shared_attrs END AS attributes \r\nFROM states INNER JOIN (SELECT states.metadata_id AS max_metadata_id, max(states.last_updated_ts) AS max_last_updated \r\nFROM states \r\nWHERE states.last_updated_ts >= 1732708152.6401002e0 AND states.last_updated_ts < 1733831399.999999e0 AND states.metadata_id IN (222, 223, 224, 246, 248, 251, 50501, 50518, 50535, 50564, 50581, 50598, 31965, 31966, 31967, 31968, 31969, 235, 236, 237, 238, 239, 302, 303, 304, 305, 306, 307, 32006, 299, 300, 32141, 32199, 32134, 32204, 32208, 32209, 32210, 32214, 32215, 32216, 32220, 32221, 32222, 32226, 32227, 32228, 32232, 32233, 32234, 32238, 32239, 32240, 32244, 32245, 32081, 32085, 32086, 32087, 32091, 32092, 32093, 32097, 32098, 32099, 32103, 32104, 32105, 32109, 32110, 32111, 32115, 32116, 32117, 32121, 32122, 32146, 32150, 32151, 32152, 32156, 32157, 32158, 32162, 32163, 32164, 32168, 32169, 32170, 32174, 32175, 32176, 32180, 32181, 32182, 32186, 32187, 32030, 32034, 32035, 32036, 32040, 32041, 32042, 32046, 32047, 32048, 32052, 32053, 32054, 32058, 32059, 32060, 32064, 32065, 32066, 32070, 32071, 49788, 49792, 49793, 49794, 49798, 49799, 49800, 49804, 49805, 49806, 49810, 49811, 49812, 49816, 49817, 49818, 49822, 49823, 49824, 49828, 49829, 32307, 32308, 32310, 32371, 389, 49770, 391, 49772, 394, 395, 397, 10809, 10810, 34465, 10814, 10812, 10813, 10816, 10817, 10818, 42219, 42217, 42221, 42222, 49716, 42223, 10826, 10828, 10830, 45857, 10831, 10832, 10833, 10834, 42224, 45850, 10837, 10839, 10838, 10840, 10836, 10842, 10843, 10844, 50378, 10845, 10846, 49717, 49971, 42226, 10851, 42227, 49975, 10909, 10854, 10855, 42228, 42229, 10858, 10859, 42230, 10861, 42231, 10864, 34537, 42232, 10867, 49842, 50294, 10869, 10870, 42233, 42234, 10874, 49718, 10878, 10880, 10881, 42236, 10883, 10884, 10885, 49720, 49721, 10890, 10891, 10893, 50675, 50394, 10898, 42238, 49722, 49723, 50297, 10902, 10903, 10904, 10905, 42239, 49785, 42240, 10825, 42242, 10913, 45592, 10916, 45565, 50412, 10919, 42541, 10920, 10921, 45895, 10923, 42243, 10926, 10927, 49728, 49724, 42246, 10931, 10933, 42247, 42248, 42249, 42250, 10972, 49725, 49726, 10940, 42253, 49727, 10943, 42254, 10966, 10945, 10960, 49719, 10911, 10922, 42220, 45556, 10822, 10985, 10895, 34469, 10824, 34473, 10841, 34474, 10872, 10853, 34475, 10906, 10934, 10957, 34486, 34493, 34501, 34505, 10970, 34545, 10971, 34557, 10975, 34559, 34561, 34568, 45263, 45270, 45273, 45302, 45534, 45537, 45540, 45543, 45546, 45549, 45553, 45559, 45562, 45567, 45571, 45581, 45584, 45590, 45596, 10924, 45603, 45750, 45760, 10961, 11008, 10962, 42241, 10954, 10900, 45752, 10965, 10946, 45754, 10980, 45867, 45880, 45885, 10964, 10974, 45893, 49843, 45897, 42244, 45899, 45901, 45903, 45905, 45907, 45909, 45931, 45948, 45950, 45952, 45954, 45956, 45963, 45965, 45967, 45972, 45974, 45976, 45978, 45980, 45987, 45989, 45991, 45993, 45995, 45997, 45999, 46001, 46003, 46005, 46007, 46009, 46011, 46013, 46015, 46017, 46019, 46021, 46023, 46025, 46027, 46029, 46031, 46033, 46035, 46037, 46039, 46041, 46043, 46045, 46047, 46049, 46051, 46086, 46088, 46090, 46092, 46094, 46096, 46098, 46100, 49962, 49967, 46102, 46104, 50008, 50011, 50013, 50015, 50022, 50043, 50062, 50071, 50073, 50076, 50106, 50114, 50165, 50170, 50173, 50309, 50312, 50331, 50335, 50344, 50346, 50354, 50357, 50360, 50363, 50366, 50369, 50373, 50375, 50391, 50397, 50402, 50409, 50415, 50418, 50475, 50478, 50481, 50484, 50487, 50606, 50616, 50619, 50621, 50625, 50668, 21117, 21118, 34466, 21122, 21120, 21121, 21124, 21125, 21126, 42257, 42255, 42259, 42260, 49729, 42261, 21134, 21136, 21138, 45858, 21139, 21140, 21141, 21142, 42262, 45851, 21145, 21147, 21146, 21148, 21144, 21150, 21151, 21152, 50379, 21153, 21154, 49730, 49972, 42264, 21159, 42265, 49976, 21217, 21162, 21163, 42266, 42267, 21166, 21167, 42268, 21169, 42269, 21172, 34538, 42270, 21175, 49844, 50295, 21177, 21178, 42271, 42272, 21182, 49731, 21186, 21188, 21189, 42274, 21191, 21192, 21193, 49733, 49734, 21198, 21199, 21201, 50676, 50395, 21206, 42276, 49735, 49736, 50298, 21210, 21211, 21212, 21213, 42277, 49786, 42278, 21133, 42280, 21221, 45593, 21224, 45566, 50413, 21227, 42542, 21228, 21229, 45896, 21231, 42281, 21234, 21235, 49741, 49737, 42284, 21239, 21241, 42285, 42286, 42287, 42288, 21280, 49738, 49739, 21248, 42291, 49740, 21251, 42292, 21274, 21253, 21268, 49732, 21219, 21230, 42258, 45557, 21130, 21293, 21203, 34470, 21132, 34477, 21149, 34478, 21180, 21161, 34479, 21214, 21242, 21265, 34487, 34494, 34502, 34506, 21278, 34546, 21279, 34558, 21283, 34560, 34562, 34569, 45264, 45271, 45274, 45303, 45535, 45538, 45541, 45544, 45547, 45550, 45554, 45560, 45563, 45568, 45572, 45582, 45585, 45591, 45597, 21232, 45604, 45751, 45761, 21269, 21316, 21270, 42279, 21262, 21208, 45753, 21273, 21254, 45755, 21288, 45868, 45881, 45886, 21272, 21282, 45894, 49845, 45898, 42282, 45900, 45902, 45904, 45906, 45908, 45910, 45932, 45949, 45951, 45953, 45955, 45957, 45964, 45966, 45968, 45973, 45975, 45977, 45979, 45981, 45988, 45990, 45992, 45994, 45996, 45998, 46000, 46002, 46004, 46006, 46008, 46010, 46012, 46014, 46016, 46018, 46020, 46022, 46024, 46026, 46028, 46030, 46032, 46034, 46036, 46038, 46040, 46042, 46044, 46046, 46048, 46050, 46052, 46087, 46089, 46091, 46093, 46095, 46097, 46099, 46101, 49963, 49968, 46103, 46105, 50009, 50012, 50014, 50016, 50023, 50044, 50063, 50072, 50074, 50077, 50107, 50115, 50166, 50171, 50174, 50310, 50313, 50332, 50336, 50345, 50347, 50355, 50358, 50361, 50364, 50367, 50370, 50374, 50376, 50392, 50398, 50403, 50410, 50416, 50419, 50476, 50479, 50482, 50485, 50488, 50607, 50617, 50620, 50622, 50626, 50669, 31525, 31526, 31527, 31528, 31571, 49965, 31574, 31573, 31575, 50329, 31576, 31577, 31579, 31578, 31572, 31581, 31582, 31583, 31584, 31585, 31586, 31587, 31588, 49966, 31591, 31590, 31592, 50330, 31593, 31594, 31596, 31595, 31589, 31598, 31599, 31600, 31601, 31602, 31603, 31604, 31808, 31813, 31826, 31829, 31825, 371, 45941, 45942, 48118, 48119, 31763, 31764, 31774, 31775, 48075, 48076, 48105, 48106, 31769, 31770, 48048, 48049, 48134, 48135, 45918, 45919, 31758, 31759, 31784, 31785, 31786, 31787, 31788, 31789, 31790, 31791, 316, 317, 318, 323, 32611, 32612, 32615, 32616, 32617, 32618, 32619, 32620, 32621, 32623, 32627, 32629, 32631, 32633, 32634, 33374, 33382, 33383, 33384, 33395, 33396, 33397, 33398, 33399, 33400, 33402, 33408, 33410, 33409, 33411, 33415, 33420, 33421, 33422, 33427, 33429, 33430, 33431, 33436, 33439, 33442, 33443, 33444, 33451, 33452, 33453, 33460, 33461, 33462, 33469, 33472, 33473, 33474, 33475, 33476, 33478, 33484, 33486, 33487, 33488, 33489, 33493, 33495, 33496, 33497, 33498, 33502, 33504, 33505, 33506, 33507, 33511, 33513, 33514, 33516, 33520, 33523, 33003, 32975, 32979, 33146, 33147, 33148, 33149, 33150, 33151, 33152, 33153, 33154, 45842, 33102, 33105, 33106, 31922, 31927, 31932, 31937, 31942, 31947, 31948, 32906, 32910, 32938, 32942, 45763, 32995, 32996, 32997, 32998, 45612, 32988, 32989, 32990, 32991, 45766, 33004, 33005, 33006, 33007, 33012, 33013, 33014, 33011, 33172, 33173, 33174, 33175, 33176, 33177, 33178, 33179, 33180, 33181, 33182, 33183, 33184, 33185, 33186, 33187, 33188, 33189, 33190, 33191, 33192, 33193, 33194, 33195, 33160, 33161, 33162, 33163, 33164, 33165, 33166, 33167, 33113, 33114, 33115, 33116, 33117, 33118, 33119, 33120, 33121, 33122, 33123, 33124, 33125, 33126, 33127, 33128, 33129, 33130, 33131, 33216, 33217, 33218, 33219, 33220, 33221, 33222, 33223, 33224, 33225, 33226, 33227, 33235, 33236, 33237, 33238, 33239, 33240, 33241, 33242, 33243, 33244, 33245, 33246, 33247, 33248, 33249, 33261, 33264, 33265, 33985, 33995, 34002, 34009, 33794, 33795, 33796, 33797, 33798, 33799, 32702, 32703, 32704, 32706, 32707, 32708, 32709, 32710, 32711, 32712, 32713, 32714, 32715, 32716, 33547, 33548, 32717, 32720, 32721, 32722, 32723, 32724, 32725, 32726, 32727, 32728, 32729, 32732, 50094, 50095, 50096, 50097, 50098, 50099, 50100, 50101, 50102, 50103, 50104, 50105, 32738, 32739, 32740, 32749, 32750, 32751, 32752, 32753, 32755, 32757, 35876, 35877, 35878, 35879, 49980, 49984, 49989, 49994, 50161, 50025, 50026, 50027, 50028, 50029, 50031, 50059, 34509, 34510, 34511, 34512, 34513, 34514, 34516, 34517, 34518, 34519, 34520, 34521, 34523, 34530, 34531, 34532, 34533, 34534, 33365, 33366, 33367, 33368, 34398, 34402, 34403, 34404, 34419, 34422, 34423, 34424, 34425, 34426, 34427, 34429, 34432, 34433, 34434, 34440, 34442, 34443, 34446, 34448, 34450, 34451, 34453, 34456, 34499, 34553, 34599, 34604, 34638, 34669, 34693, 34728, 34766, 34768, 34772, 34787, 34808, 34941, 34949, 34972, 34979, 34987, 34999, 35004, 35015, 35017, 35019, 35021, 35026, 35029, 35034, 35036, 35041, 35043, 35045, 35052, 35057, 35059, 33369, 35061, 35063, 35065, 35081, 35089, 35093, 35095, 35114, 35119, 35121, 35123, 35125, 35127, 35129, 35131, 35136, 35138, 35140, 35142, 35144, 35155, 35181, 35186, 35191, 35211, 35213, 35215, 35222, 35224, 35232, 35234, 35236, 35238, 35240, 35248, 35259, 35268, 35279, 35281, 35283, 35285, 35287, 35289, 35291, 35296, 35298, 35300, 35302, 35304, 35320, 35322, 35324, 35326, 35328, 35330, 35332, 35334, 35336, 35338, 35340, 35342, 35344, 35346, 35348, 35350, 35352, 35354, 35356, 35358, 35360, 35362, 35364, 35366, 35368, 35370, 35372, 35373, 35376, 35378, 35380, 35382, 35384, 35386, 35391, 35393, 35395, 33987, 33986, 33988, 35398, 35400, 35402, 35404, 35406, 35408, 35410, 35412, 35414, 35416, 35418, 35420, 35422, 35424, 35426, 35428, 35430, 35432, 35434, 35436, 35438, 35440, 35442, 35444, 35447, 35449, 35451, 35453, 35455, 35457, 35459, 35461, 35463, 35465, 35466, 35468, 35470, 43835, 45575, 45577, 45871, 45873, 45875, 45877, 45879, 45884, 45889, 49847, 49851, 49852, 49853, 49857, 49858, 49859, 49863, 49864, 49865, 49869, 49870, 49871, 49875, 49876, 49877, 49881, 49882, 49883, 49887, 49888, 50021, 50033, 50035, 50037, 50039, 50129, 50131, 50133, 50169, 50179, 50340, 50387, 50390, 50406, 50450, 50452, 50454, 50471, 50473, 50491, 50615, 50667, 50672, 50674, 50679) GROUP BY states.metadata_id) AS anon_3 ON states.metadata_id = anon_3.max_metadata_id AND states.last_updated_ts = anon_3.max_last_updated LEFT OUTER JOIN state_attributes ON states.attributes_id = state_attributes.attributes_id \r\nWHERE states.last_updated_ts >= 1732708152.6401002e0 AND states.last_updated_ts < 1733831399.999999e0 AND states.metadata_id IN (222, 223, 224, 246, 248, 251, 50501, 50518, 50535, 50564, 50581, 50598, 31965, 31966, 31967, 31968, 31969, 235, 236, 237, 238, 239, 302, 303, 304, 305, 306, 307, 32006, 299, 300, 32141, 32199, 32134, 32204, 32208, 32209, 32210, 32214, 32215, 32216, 32220, 32221, 32222, 32226, 32227, 32228, 32232, 32233, 32234, 32238, 32239, 32240, 32244, 32245, 32081, 32085, 32086, 32087, 32091, 32092, 32093, 32097, 32098, 32099, 32103, 32104, 32105, 32109, 32110, 32111, 32115, 32116, 32117, 32121, 32122, 32146, 32150, 32151, 32152, 32156, 32157, 32158, 32162, 32163, 32164, 32168, 32169, 32170, 32174, 32175, 32176, 32180, 32181, 32182, 32186, 32187, 32030, 32034, 32035, 32036, 32040, 32041, 32042, 32046, 32047, 32048, 32052, 32053, 32054, 32058, 32059, 32060, 32064, 32065, 32066, 32070, 32071, 49788, 49792, 49793, 49794, 49798, 49799, 49800, 49804, 49805, 49806, 49810, 49811, 49812, 49816, 49817, 49818, 49822, 49823, 49824, 49828, 49829, 32307, 32308, 32310, 32371, 389, 49770, 391, 49772, 394, 395, 397, 10809, 10810, 34465, 10814, 10812, 10813, 10816, 10817, 10818, 42219, 42217, 42221, 42222, 49716, 42223, 10826, 10828, 10830, 45857, 10831, 10832, 10833, 10834, 42224, 45850, 10837, 10839, 10838, 10840, 10836, 10842, 10843, 10844, 50378, 10845, 10846, 49717, 49971, 42226, 10851, 42227, 49975, 10909, 10854, 10855, 42228, 42229, 10858, 10859, 42230, 10861, 42231, 10864, 34537, 42232, 10867, 49842, 50294, 10869, 10870, 42233, 42234, 10874, 49718, 10878, 10880, 10881, 42236, 10883, 10884, 10885, 49720, 49721, 10890, 10891, 10893, 50675, 50394, 10898, 42238, 49722, 49723, 50297, 10902, 10903, 10904, 10905, 42239, 49785, 42240, 10825, 42242, 10913, 45592, 10916, 45565, 50412, 10919, 42541, 10920, 10921, 45895, 10923, 42243, 10926, 10927, 49728, 49724, 42246, 10931, 10933, 42247, 42248, 42249, 42250, 10972, 49725, 49726, 10940, 42253, 49727, 10943, 42254, 10966, 10945, 10960, 49719, 10911, 10922, 42220, 45556, 10822, 10985, 10895, 34469, 10824, 34473, 10841, 34474, 10872, 10853, 34475, 10906, 10934, 10957, 34486, 34493, 34501, 34505, 10970, 34545, 10971, 34557, 10975, 34559, 34561, 34568, 45263, 45270, 45273, 45302, 45534, 45537, 45540, 45543, 45546, 45549, 45553, 45559, 45562, 45567, 45571, 45581, 45584, 45590, 45596, 10924, 45603, 45750, 45760, 10961, 11008, 10962, 42241, 10954, 10900, 45752, 10965, 10946, 45754, 10980, 45867, 45880, 45885, 10964, 10974, 45893, 49843, 45897, 42244, 45899, 45901, 45903, 45905, 45907, 45909, 45931, 45948, 45950, 45952, 45954, 45956, 45963, 45965, 45967, 45972, 45974, 45976, 45978, 45980, 45987, 45989, 45991, 45993, 45995, 45997, 45999, 46001, 46003, 46005, 46007, 46009, 46011, 46013, 46015, 46017, 46019, 46021, 46023, 46025, 46027, 46029, 46031, 46033, 46035, 46037, 46039, 46041, 46043, 46045, 46047, 46049, 46051, 46086, 46088, 46090, 46092, 46094, 46096, 46098, 46100, 49962, 49967, 46102, 46104, 50008, 50011, 50013, 50015, 50022, 50043, 50062, 50071, 50073, 50076, 50106, 50114, 50165, 50170, 50173, 50309, 50312, 50331, 50335, 50344, 50346, 50354, 50357, 50360, 50363, 50366, 50369, 50373, 50375, 50391, 50397, 50402, 50409, 50415, 50418, 50475, 50478, 50481, 50484, 50487, 50606, 50616, 50619, 50621, 50625, 50668, 21117, 21118, 34466, 21122, 21120, 21121, 21124, 21125, 21126, 42257, 42255, 42259, 42260, 49729, 42261, 21134, 21136, 21138, 45858, 21139, 21140, 21141, 21142, 42262, 45851, 21145, 21147, 21146, 21148, 21144, 21150, 21151, 21152, 50379, 21153, 21154, 49730, 49972, 42264, 21159, 42265, 49976, 21217, 21162, 21163, 42266, 42267, 21166, 21167, 42268, 21169, 42269, 21172, 34538, 42270, 21175, 49844, 50295, 21177, 21178, 42271, 42272, 21182, 49731, 21186, 21188, 21189, 42274, 21191, 21192, 21193, 49733, 49734, 21198, 21199, 21201, 50676, 50395, 21206, 42276, 49735, 49736, 50298, 21210, 21211, 21212, 21213, 42277, 49786, 42278, 21133, 42280, 21221, 45593, 21224, 45566, 50413, 21227, 42542, 21228, 21229, 45896, 21231, 42281, 21234, 21235, 49741, 49737, 42284, 21239, 21241, 42285, 42286, 42287, 42288, 21280, 49738, 49739, 21248, 42291, 49740, 21251, 42292, 21274, 21253, 21268, 49732, 21219, 21230, 42258, 45557, 21130, 21293, 21203, 34470, 21132, 34477, 21149, 34478, 21180, 21161, 34479, 21214, 21242, 21265, 34487, 34494, 34502, 34506, 21278, 34546, 21279, 34558, 21283, 34560, 34562, 34569, 45264, 45271, 45274, 45303, 45535, 45538, 45541, 45544, 45547, 45550, 45554, 45560, 45563, 45568, 45572, 45582, 45585, 45591, 45597, 21232, 45604, 45751, 45761, 21269, 21316, 21270, 42279, 21262, 21208, 45753, 21273, 21254, 45755, 21288, 45868, 45881, 45886, 21272, 21282, 45894, 49845, 45898, 42282, 45900, 45902, 45904, 45906, 45908, 45910, 45932, 45949, 45951, 45953, 45955, 45957, 45964, 45966, 45968, 45973, 45975, 45977, 45979, 45981, 45988, 45990, 45992, 45994, 45996, 45998, 46000, 46002, 46004, 46006, 46008, 46010, 46012, 46014, 46016, 46018, 46020, 46022, 46024, 46026, 46028, 46030, 46032, 46034, 46036, 46038, 46040, 46042, 46044, 46046, 46048, 46050, 46052, 46087, 46089, 46091, 46093, 46095, 46097, 46099, 46101, 49963, 49968, 46103, 46105, 50009, 50012, 50014, 50016, 50023, 50044, 50063, 50072, 50074, 50077, 50107, 50115, 50166, 50171, 50174, 50310, 50313, 50332, 50336, 50345, 50347, 50355, 50358, 50361, 50364, 50367, 50370, 50374, 50376, 50392, 50398, 50403, 50410, 50416, 50419, 50476, 50479, 50482, 50485, 50488, 50607, 50617, 50620, 50622, 50626, 50669, 31525, 31526, 31527, 31528, 31571, 49965, 31574, 31573, 31575, 50329, 31576, 31577, 31579, 31578, 31572, 31581, 31582, 31583, 31584, 31585, 31586, 31587, 31588, 49966, 31591, 31590, 31592, 50330, 31593, 31594, 31596, 31595, 31589, 31598, 31599, 31600, 31601, 31602, 31603, 31604, 31808, 31813, 31826, 31829, 31825, 371, 45941, 45942, 48118, 48119, 31763, 31764, 31774, 31775, 48075, 48076, 48105, 48106, 31769, 31770, 48048, 48049, 48134, 48135, 45918, 45919, 31758, 31759, 31784, 31785, 31786, 31787, 31788, 31789, 31790, 31791, 316, 317, 318, 323, 32611, 32612, 32615, 32616, 32617, 32618, 32619, 32620, 32621, 32623, 32627, 32629, 32631, 32633, 32634, 33374, 33382, 33383, 33384, 33395, 33396, 33397, 33398, 33399, 33400, 33402, 33408, 33410, 33409, 33411, 33415, 33420, 33421, 33422, 33427, 33429, 33430, 33431, 33436, 33439, 33442, 33443, 33444, 33451, 33452, 33453, 33460, 33461, 33462, 33469, 33472, 33473, 33474, 33475, 33476, 33478, 33484, 33486, 33487, 33488, 33489, 33493, 33495, 33496, 33497, 33498, 33502, 33504, 33505, 33506, 33507, 33511, 33513, 33514, 33516, 33520, 33523, 33003, 32975, 32979, 33146, 33147, 33148, 33149, 33150, 33151, 33152, 33153, 33154, 45842, 33102, 33105, 33106, 31922, 31927, 31932, 31937, 31942, 31947, 31948, 32906, 32910, 32938, 32942, 45763, 32995, 32996, 32997, 32998, 45612, 32988, 32989, 32990, 32991, 45766, 33004, 33005, 33006, 33007, 33012, 33013, 33014, 33011, 33172, 33173, 33174, 33175, 33176, 33177, 33178, 33179, 33180, 33181, 33182, 33183, 33184, 33185, 33186, 33187, 33188, 33189, 33190, 33191, 33192, 33193, 33194, 33195, 33160, 33161, 33162, 33163, 33164, 33165, 33166, 33167, 33113, 33114, 33115, 33116, 33117, 33118, 33119, 33120, 33121, 33122, 33123, 33124, 33125, 33126, 33127, 33128, 33129, 33130, 33131, 33216, 33217, 33218, 33219, 33220, 33221, 33222, 33223, 33224, 33225, 33226, 33227, 33235, 33236, 33237, 33238, 33239, 33240, 33241, 33242, 33243, 33244, 33245, 33246, 33247, 33248, 33249, 33261, 33264, 33265, 33985, 33995, 34002, 34009, 33794, 33795, 33796, 33797, 33798, 33799, 32702, 32703, 32704, 32706, 32707, 32708, 32709, 32710, 32711, 32712, 32713, 32714, 32715, 32716, 33547, 33548, 32717, 32720, 32721, 32722, 32723, 32724, 32725, 32726, 32727, 32728, 32729, 32732, 50094, 50095, 50096, 50097, 50098, 50099, 50100, 50101, 50102, 50103, 50104, 50105, 32738, 32739, 32740, 32749, 32750, 32751, 32752, 32753, 32755, 32757, 35876, 35877, 35878, 35879, 49980, 49984, 49989, 49994, 50161, 50025, 50026, 50027, 50028, 50029, 50031, 50059, 34509, 34510, 34511, 34512, 34513, 34514, 34516, 34517, 34518, 34519, 34520, 34521, 34523, 34530, 34531, 34532, 34533, 34534, 33365, 33366, 33367, 33368, 34398, 34402, 34403, 34404, 34419, 34422, 34423, 34424, 34425, 34426, 34427, 34429, 34432, 34433, 34434, 34440, 34442, 34443, 34446, 34448, 34450, 34451, 34453, 34456, 34499, 34553, 34599, 34604, 34638, 34669, 34693, 34728, 34766, 34768, 34772, 34787, 34808, 34941, 34949, 34972, 34979, 34987, 34999, 35004, 35015, 35017, 35019, 35021, 35026, 35029, 35034, 35036, 35041, 35043, 35045, 35052, 35057, 35059, 33369, 35061, 35063, 35065, 35081, 35089, 35093, 35095, 35114, 35119, 35121, 35123, 35125, 35127, 35129, 35131, 35136, 35138, 35140, 35142, 35144, 35155, 35181, 35186, 35191, 35211, 35213, 35215, 35222, 35224, 35232, 35234, 35236, 35238, 35240, 35248, 35259, 35268, 35279, 35281, 35283, 35285, 35287, 35289, 35291, 35296, 35298, 35300, 35302, 35304, 35320, 35322, 35324, 35326, 35328, 35330, 35332, 35334, 35336, 35338, 35340, 35342, 35344, 35346, 35348, 35350, 35352, 35354, 35356, 35358, 35360, 35362, 35364, 35366, 35368, 35370, 35372, 35373, 35376, 35378, 35380, 35382, 35384, 35386, 35391, 35393, 35395, 33987, 33986, 33988, 35398, 35400, 35402, 35404, 35406, 35408, 35410, 35412, 35414, 35416, 35418, 35420, 35422, 35424, 35426, 35428, 35430, 35432, 35434, 35436, 35438, 35440, 35442, 35444, 35447, 35449, 35451, 35453, 35455, 35457, 35459, 35461, 35463, 35465, 35466, 35468, 35470, 43835, 45575, 45577, 45871, 45873, 45875, 45877, 45879, 45884, 45889, 49847, 49851, 49852, 49853, 49857, 49858, 49859, 49863, 49864, 49865, 49869, 49870, 49871, 49875, 49876, 49877, 49881, 49882, 49883, 49887, 49888, 50021, 50033, 50035, 50037, 50039, 50129, 50131, 50133, 50169, 50179, 50340, 50387, 50390, 50406, 50450, 50452, 50454, 50471, 50473, 50491, 50615, 50667, 50672, 50674, 50679)) AS anon_2 UNION ALL SELECT anon_4.metadata_id AS metadata_id, anon_4.state AS state, anon_4.last_updated_ts AS last_updated_ts, anon_4.attributes AS attributes \r\nFROM (SELECT states.metadata_id AS metadata_id, states.state AS state, states.last_updated_ts AS last_updated_ts, CASE WHEN (state_attributes.shared_attrs IS NULL) THEN states.attributes ELSE state_attributes.shared_attrs END AS attributes \r\nFROM states LEFT OUTER JOIN state_attributes ON states.attributes_id = state_attributes.attributes_id \r\nWHERE (states.last_changed_ts = states.last_updated_ts OR states.last_changed_ts IS NULL) AND states.metadata_id IN (222, 223, 224, 246, 248, 251, 50501, 50518, 50535, 50564, 50581, 50598, 31965, 31966, 31967, 31968, 31969, 235, 236, 237, 238, 239, 302, 303, 304, 305, 306, 307, 32006, 299, 300, 32141, 32199, 32134, 32204, 32208, 32209, 32210, 32214, 32215, 32216, 32220, 32221, 32222, 32226, 32227, 32228, 32232, 32233, 32234, 32238, 32239, 32240, 32244, 32245, 32081, 32085, 32086, 32087, 32091, 32092, 32093, 32097, 32098, 32099, 32103, 32104, 32105, 32109, 32110, 32111, 32115, 32116, 32117, 32121, 32122, 32146, 32150, 32151, 32152, 32156, 32157, 32158, 32162, 32163, 32164, 32168, 32169, 32170, 32174, 32175, 32176, 32180, 32181, 32182, 32186, 32187, 32030, 32034, 32035, 32036, 32040, 32041, 32042, 32046, 32047, 32048, 32052, 32053, 32054, 32058, 32059, 32060, 32064, 32065, 32066, 32070, 32071, 49788, 49792, 49793, 49794, 49798, 49799, 49800, 49804, 49805, 49806, 49810, 49811, 49812, 49816, 49817, 49818, 49822, 49823, 49824, 49828, 49829, 32307, 32308, 32310, 32371, 389, 49770, 391, 49772, 394, 395, 397, 10809, 10810, 34465, 10814, 10812, 10813, 10816, 10817, 10818, 42219, 42217, 42221, 42222, 49716, 42223, 10826, 10828, 10830, 45857, 10831, 10832, 10833, 10834, 42224, 45850, 10837, 10839, 10838, 10840, 10836, 10842, 10843, 10844, 50378, 10845, 10846, 49717, 49971, 42226, 10851, 42227, 49975, 10909, 10854, 10855, 42228, 42229, 10858, 10859, 42230, 10861, 42231, 10864, 34537, 42232, 10867, 49842, 50294, 10869, 10870, 42233, 42234, 10874, 49718, 10878, 10880, 10881, 42236, 10883, 10884, 10885, 49720, 49721, 10890, 10891, 10893, 50675, 50394, 10898, 42238, 49722, 49723, 50297, 10902, 10903, 10904, 10905, 42239, 49785, 42240, 10825, 42242, 10913, 45592, 10916, 45565, 50412, 10919, 42541, 10920, 10921, 45895, 10923, 42243, 10926, 10927, 49728, 49724, 42246, 10931, 10933, 42247, 42248, 42249, 42250, 10972, 49725, 49726, 10940, 42253, 49727, 10943, 42254, 10966, 10945, 10960, 49719, 10911, 10922, 42220, 45556, 10822, 10985, 10895, 34469, 10824, 34473, 10841, 34474, 10872, 10853, 34475, 10906, 10934, 10957, 34486, 34493, 34501, 34505, 10970, 34545, 10971, 34557, 10975, 34559, 34561, 34568, 45263, 45270, 45273, 45302, 45534, 45537, 45540, 45543, 45546, 45549, 45553, 45559, 45562, 45567, 45571, 45581, 45584, 45590, 45596, 10924, 45603, 45750, 45760, 10961, 11008, 10962, 42241, 10954, 10900, 45752, 10965, 10946, 45754, 10980, 45867, 45880, 45885, 10964, 10974, 45893, 49843, 45897, 42244, 45899, 45901, 45903, 45905, 45907, 45909, 45931, 45948, 45950, 45952, 45954, 45956, 45963, 45965, 45967, 45972, 45974, 45976, 45978, 45980, 45987, 45989, 45991, 45993, 45995, 45997, 45999, 46001, 46003, 46005, 46007, 46009, 46011, 46013, 46015, 46017, 46019, 46021, 46023, 46025, 46027, 46029, 46031, 46033, 46035, 46037, 46039, 46041, 46043, 46045, 46047, 46049, 46051, 46086, 46088, 46090, 46092, 46094, 46096, 46098, 46100, 49962, 49967, 46102, 46104, 50008, 50011, 50013, 50015, 50022, 50043, 50062, 50071, 50073, 50076, 50106, 50114, 50165, 50170, 50173, 50309, 50312, 50331, 50335, 50344, 50346, 50354, 50357, 50360, 50363, 50366, 50369, 50373, 50375, 50391, 50397, 50402, 50409, 50415, 50418, 50475, 50478, 50481, 50484, 50487, 50606, 50616, 50619, 50621, 50625, 50668, 21117, 21118, 34466, 21122, 21120, 21121, 21124, 21125, 21126, 42257, 42255, 42259, 42260, 49729, 42261, 21134, 21136, 21138, 45858, 21139, 21140, 21141, 21142, 42262, 45851, 21145, 21147, 21146, 21148, 21144, 21150, 21151, 21152, 50379, 21153, 21154, 49730, 49972, 42264, 21159, 42265, 49976, 21217, 21162, 21163, 42266, 42267, 21166, 21167, 42268, 21169, 42269, 21172, 34538, 42270, 21175, 49844, 50295, 21177, 21178, 42271, 42272, 21182, 49731, 21186, 21188, 21189, 42274, 21191, 21192, 21193, 49733, 49734, 21198, 21199, 21201, 50676, 50395, 21206, 42276, 49735, 49736, 50298, 21210, 21211, 21212, 21213, 42277, 49786, 42278, 21133, 42280, 21221, 45593, 21224, 45566, 50413, 21227, 42542, 21228, 21229, 45896, 21231, 42281, 21234, 21235, 49741, 49737, 42284, 21239, 21241, 42285, 42286, 42287, 42288, 21280, 49738, 49739, 21248, 42291, 49740, 21251, 42292, 21274, 21253, 21268, 49732, 21219, 21230, 42258, 45557, 21130, 21293, 21203, 34470, 21132, 34477, 21149, 34478, 21180, 21161, 34479, 21214, 21242, 21265, 34487, 34494, 34502, 34506, 21278, 34546, 21279, 34558, 21283, 34560, 34562, 34569, 45264, 45271, 45274, 45303, 45535, 45538, 45541, 45544, 45547, 45550, 45554, 45560, 45563, 45568, 45572, 45582, 45585, 45591, 45597, 21232, 45604, 45751, 45761, 21269, 21316, 21270, 42279, 21262, 21208, 45753, 21273, 21254, 45755, 21288, 45868, 45881, 45886, 21272, 21282, 45894, 49845, 45898, 42282, 45900, 45902, 45904, 45906, 45908, 45910, 45932, 45949, 45951, 45953, 45955, 45957, 45964, 45966, 45968, 45973, 45975, 45977, 45979, 45981, 45988, 45990, 45992, 45994, 45996, 45998, 46000, 46002, 46004, 46006, 46008, 46010, 46012, 46014, 46016, 46018, 46020, 46022, 46024, 46026, 46028, 46030, 46032, 46034, 46036, 46038, 46040, 46042, 46044, 46046, 46048, 46050, 46052, 46087, 46089, 46091, 46093, 46095, 46097, 46099, 46101, 49963, 49968, 46103, 46105, 50009, 50012, 50014, 50016, 50023, 50044, 50063, 50072, 50074, 50077, 50107, 50115, 50166, 50171, 50174, 50310, 50313, 50332, 50336, 50345, 50347, 50355, 50358, 50361, 50364, 50367, 50370, 50374, 50376, 50392, 50398, 50403, 50410, 50416, 50419, 50476, 50479, 50482, 50485, 50488, 50607, 50617, 50620, 50622, 50626, 50669, 31525, 31526, 31527, 31528, 31571, 49965, 31574, 31573, 31575, 50329, 31576, 31577, 31579, 31578, 31572, 31581, 31582, 31583, 31584, 31585, 31586, 31587, 31588, 49966, 31591, 31590, 31592, 50330, 31593, 31594, 31596, 31595, 31589, 31598, 31599, 31600, 31601, 31602, 31603, 31604, 31808, 31813, 31826, 31829, 31825, 371, 45941, 45942, 48118, 48119, 31763, 31764, 31774, 31775, 48075, 48076, 48105, 48106, 31769, 31770, 48048, 48049, 48134, 48135, 45918, 45919, 31758, 31759, 31784, 31785, 31786, 31787, 31788, 31789, 31790, 31791, 316, 317, 318, 323, 32611, 32612, 32615, 32616, 32617, 32618, 32619, 32620, 32621, 32623, 32627, 32629, 32631, 32633, 32634, 33374, 33382, 33383, 33384, 33395, 33396, 33397, 33398, 33399, 33400, 33402, 33408, 33410, 33409, 33411, 33415, 33420, 33421, 33422, 33427, 33429, 33430, 33431, 33436, 33439, 33442, 33443, 33444, 33451, 33452, 33453, 33460, 33461, 33462, 33469, 33472, 33473, 33474, 33475, 33476, 33478, 33484, 33486, 33487, 33488, 33489, 33493, 33495, 33496, 33497, 33498, 33502, 33504, 33505, 33506, 33507, 33511, 33513, 33514, 33516, 33520, 33523, 33003, 32975, 32979, 33146, 33147, 33148, 33149, 33150, 33151, 33152, 33153, 33154, 45842, 33102, 33105, 33106, 31922, 31927, 31932, 31937, 31942, 31947, 31948, 32906, 32910, 32938, 32942, 45763, 32995, 32996, 32997, 32998, 45612, 32988, 32989, 32990, 32991, 45766, 33004, 33005, 33006, 33007, 33012, 33013, 33014, 33011, 33172, 33173, 33174, 33175, 33176, 33177, 33178, 33179, 33180, 33181, 33182, 33183, 33184, 33185, 33186, 33187, 33188, 33189, 33190, 33191, 33192, 33193, 33194, 33195, 33160, 33161, 33162, 33163, 33164, 33165, 33166, 33167, 33113, 33114, 33115, 33116, 33117, 33118, 33119, 33120, 33121, 33122, 33123, 33124, 33125, 33126, 33127, 33128, 33129, 33130, 33131, 33216, 33217, 33218, 33219, 33220, 33221, 33222, 33223, 33224, 33225, 33226, 33227, 33235, 33236, 33237, 33238, 33239, 33240, 33241, 33242, 33243, 33244, 33245, 33246, 33247, 33248, 33249, 33261, 33264, 33265, 33985, 33995, 34002, 34009, 33794, 33795, 33796, 33797, 33798, 33799, 32702, 32703, 32704, 32706, 32707, 32708, 32709, 32710, 32711, 32712, 32713, 32714, 32715, 32716, 33547, 33548, 32717, 32720, 32721, 32722, 32723, 32724, 32725, 32726, 32727, 32728, 32729, 32732, 50094, 50095, 50096, 50097, 50098, 50099, 50100, 50101, 50102, 50103, 50104, 50105, 32738, 32739, 32740, 32749, 32750, 32751, 32752, 32753, 32755, 32757, 35876, 35877, 35878, 35879, 49980, 49984, 49989, 49994, 50161, 50025, 50026, 50027, 50028, 50029, 50031, 50059, 34509, 34510, 34511, 34512, 34513, 34514, 34516, 34517, 34518, 34519, 34520, 34521, 34523, 34530, 34531, 34532, 34533, 34534, 33365, 33366, 33367, 33368, 34398, 34402, 34403, 34404, 34419, 34422, 34423, 34424, 34425, 34426, 34427, 34429, 34432, 34433, 34434, 34440, 34442, 34443, 34446, 34448, 34450, 34451, 34453, 34456, 34499, 34553, 34599, 34604, 34638, 34669, 34693, 34728, 34766, 34768, 34772, 34787, 34808, 34941, 34949, 34972, 34979, 34987, 34999, 35004, 35015, 35017, 35019, 35021, 35026, 35029, 35034, 35036, 35041, 35043, 35045, 35052, 35057, 35059, 33369, 35061, 35063, 35065, 35081, 35089, 35093, 35095, 35114, 35119, 35121, 35123, 35125, 35127, 35129, 35131, 35136, 35138, 35140, 35142, 35144, 35155, 35181, 35186, 35191, 35211, 35213, 35215, 35222, 35224, 35232, 35234, 35236, 35238, 35240, 35248, 35259, 35268, 35279, 35281, 35283, 35285, 35287, 35289, 35291, 35296, 35298, 35300, 35302, 35304, 35320, 35322, 35324, 35326, 35328, 35330, 35332, 35334, 35336, 35338, 35340, 35342, 35344, 35346, 35348, 35350, 35352, 35354, 35356, 35358, 35360, 35362, 35364, 35366, 35368, 35370, 35372, 35373, 35376, 35378, 35380, 35382, 35384, 35386, 35391, 35393, 35395, 33987, 33986, 33988, 35398, 35400, 35402, 35404, 35406, 35408, 35410, 35412, 35414, 35416, 35418, 35420, 35422, 35424, 35426, 35428, 35430, 35432, 35434, 35436, 35438, 35440, 35442, 35444, 35447, 35449, 35451, 35453, 35455, 35457, 35459, 35461, 35463, 35465, 35466, 35468, 35470, 43835, 45575, 45577, 45871, 45873, 45875, 45877, 45879, 45884, 45889, 49847, 49851, 49852, 49853, 49857, 49858, 49859, 49863, 49864, 49865, 49869, 49870, 49871, 49875, 49876, 49877, 49881, 49882, 49883, 49887, 49888, 50021, 50033, 50035, 50037, 50039, 50129, 50131, 50133, 50169, 50179, 50340, 50387, 50390, 50406, 50450, 50452, 50454, 50471, 50473, 50491, 50615, 50667, 50672, 50674, 50679) AND states.last_updated_ts > 1733831399.999999e0 AND states.last_updated_ts < 1733831700.0e0) AS anon_4) AS anon_1 ORDER BY anon_1.metadata_id, anon_1.last_updated_ts\r\nProgress: 0.000\r\n*************************** 2. row ***************************\r\n      Id: 68\r\n    User: root\r\n    Host: 172.31.0.1:43558\r\n      db: NULL\r\n Command: Query\r\n    Time: 0\r\n   State: starting\r\n    Info: show full processlist\r\nProgress: 0.000\r\n*************************** 3. row ***************************\r\n      Id: 975\r\n    User: homeassistant\r\n    Host: 172.31.0.1:50608\r\n      db: ha_db\r\n Command: Sleep\r\n    Time: 45\r\n   State: \r\n    Info: NULL\r\nProgress: 0.000\r\n*************************** 4. row ***************************\r\n      Id: 976\r\n    User: homeassistant\r\n    Host: 172.31.0.1:49240\r\n      db: ha_db\r\n Command: Query\r\n    Time: 848\r\n   State: Creating sort index\r\n    Info: SELECT anon_1.metadata_id, anon_1.state, anon_1.last_updated_ts, anon_1.attributes \r\nFROM (SELECT anon_2.metadata_id AS metadata_id, anon_2.state AS state, anon_2.last_updated_ts AS last_updated_ts, anon_2.attributes AS attributes \r\nFROM (SELECT states.metadata_id AS metadata_id, states.state AS state, 0 AS last_updated_ts, CASE WHEN (state_attributes.shared_attrs IS NULL) THEN states.attributes ELSE state_attributes.shared_attrs END AS attributes \r\nFROM states INNER JOIN (SELECT states.metadata_id AS max_metadata_id, max(states.last_updated_ts) AS max_last_updated \r\nFROM states \r\nWHERE states.last_updated_ts >= 1732708152.6401002e0 AND states.last_updated_ts < 1733830799.999999e0 AND states.metadata_id IN (224, 223, 222, 50501, 50518, 50535, 50564, 50581, 50598, 246, 248, 251, 32307, 32308, 32310, 32371, 31965, 31966, 31967, 31968, 31969, 32199, 32141, 32134, 32081, 32085, 32086, 32087, 32091, 32092, 32093, 32097, 32098, 32099, 32103, 32104, 32105, 32109, 32110, 32111, 32115, 32116, 32117, 32121, 32122, 32146, 32150, 32151, 32152, 32156, 32157, 32158, 32162, 32163, 32164, 32168, 32169, 32170, 32174, 32175, 32176, 32180, 32181, 32182, 32186, 32187, 32204, 32208, 32209, 32210, 32214, 32215, 32216, 32220, 32221, 32222, 32226, 32227, 32228, 32232, 32233, 32234, 32238, 32239, 32240, 32244, 32245, 32030, 32034, 32035, 32036, 32040, 32041, 32042, 32046, 32047, 32048, 32052, 32053, 32054, 32058, 32059, 32060, 32064, 32065, 32066, 32070, 32071, 49788, 49792, 49793, 49794, 49798, 49799, 49800, 49804, 49805, 49806, 49810, 49811, 49812, 49816, 49817, 49818, 49822, 49823, 49824, 49828, 49829, 31826, 31813, 31808, 31829, 31825, 316, 317, 318, 323, 45941, 45942, 48118, 48119, 31763, 31764, 31774, 31775, 48075, 48076, 48105, 48106, 31769, 31770, 48048, 48049, 48134, 48135, 45918, 45919, 31758, 31759, 31784, 31785, 31786, 31787, 31788, 31789, 31790, 31791, 32006, 299, 300, 371, 302, 303, 304, 305, 306, 307, 32611, 32612, 32615, 32616, 32617, 32618, 32619, 32620, 32621, 32623, 32627, 32629, 32631, 32633, 32634, 389, 49770, 391, 49772, 394, 395, 397, 10809, 10810, 34465, 10814, 10812, 10813, 10816, 10817, 10818, 42219, 42217, 42221, 42222, 49716, 42223, 10826, 10828, 10830, 45857, 10831, 10832, 10833, 10834, 42224, 45850, 10837, 10839, 10838, 10961, 10840, 10836, 10842, 10843, 10844, 50378, 10845, 10846, 49717, 49971, 42226, 10851, 42227, 49975, 10909, 10854, 10855, 42228, 42229, 10858, 10859, 42230, 10861, 42231, 10864, 42232, 10867, 49842, 50294, 10869, 10870, 42233, 42234, 10874, 49718, 10878, 10880, 10881, 42236, 10883, 10884, 10885, 49720, 49721, 10890, 10891, 10893, 50675, 10954, 10960, 50394, 10898, 42238, 49722, 49723, 50297, 10902, 10903, 10904, 10905, 42239, 49785, 42240, 10825, 42242, 10913, 45592, 10916, 45565, 50412, 10919, 42541, 10920, 10921, 45895, 10923, 42243, 10926, 10927, 49728, 49724, 42246, 10931, 10933, 42247, 42248, 42249, 42250, 10972, 49725, 49726, 10940, 42253, 49727, 10943, 42254, 10966, 10945, 49719, 10911, 10922, 42220, 45556, 10822, 10985, 10895, 34469, 10824, 34473, 10841, 34474, 10872, 10853, 34475, 10906, 10934, 10957, 34486, 34493, 34501, 34505, 10970, 34537, 34545, 10971, 34557, 10975, 34559, 34561, 34568, 45263, 45270, 45273, 45302, 45534, 45537, 45540, 45543, 45546, 45549, 45553, 45559, 45562, 45567, 45571, 45581, 45584, 45590, 45596, 10924, 45603, 45750, 45760, 11008, 10962, 42241, 10900, 45752, 10965, 10946, 45754, 10980, 45867, 45880, 45885, 10964, 10974, 45893, 49843, 45897, 42244, 45899, 45901, 45903, 45905, 45907, 45909, 45931, 45948, 45950, 45952, 45954, 45956, 45963, 45965, 45967, 45972, 45974, 45976, 45978, 45980, 45987, 45989, 45991, 45993, 45995, 45997, 45999, 46001, 46003, 46005, 46007, 46009, 46011, 46013, 46015, 46017, 46019, 46021, 46023, 46025, 46027, 46029, 46031, 46033, 46035, 46037, 46039, 46041, 46043, 46045, 46047, 46049, 46051, 46086, 46088, 46090, 46092, 46094, 46096, 46098, 46100, 49962, 49967, 46102, 46104, 50008, 50011, 50013, 50015, 50022, 50043, 50062, 50071, 50073, 50076, 50106, 50114, 50165, 50170, 50173, 50309, 50312, 50331, 50335, 50344, 50346, 50354, 50357, 50360, 50363, 50366, 50369, 50373, 50375, 50391, 50397, 50402, 50409, 50415, 50418, 50475, 50478, 50481, 50484, 50487, 50606, 50616, 50619, 50621, 50625, 50668, 21117, 21118, 34466, 21122, 21120, 21121, 21124, 21125, 21126, 42257, 42255, 42259, 42260, 49729, 42261, 21134, 21136, 21138, 45858, 21139, 21140, 21141, 21142, 42262, 45851, 21145, 21147, 21146, 21269, 21148, 21144, 21150, 21151, 21152, 50379, 21153, 21154, 49730, 49972, 42264, 21159, 42265, 49976, 21217, 21162, 21163, 42266, 42267, 21166, 21167, 42268, 21169, 42269, 21172, 42270, 21175, 49844, 50295, 21177, 21178, 42271, 42272, 21182, 49731, 21186, 21188, 21189, 42274, 21191, 21192, 21193, 49733, 49734, 21198, 21199, 21201, 50676, 21262, 21268, 50395, 21206, 42276, 49735, 49736, 50298, 21210, 21211, 21212, 21213, 42277, 49786, 42278, 21133, 42280, 21221, 45593, 21224, 45566, 50413, 21227, 42542, 21228, 21229, 45896, 21231, 42281, 21234, 21235, 49741, 49737, 42284, 21239, 21241, 42285, 42286, 42287, 42288, 21280, 49738, 49739, 21248, 42291, 49740, 21251, 42292, 21274, 21253, 49732, 21219, 21230, 42258, 45557, 21130, 21293, 21203, 34470, 21132, 34477, 21149, 34478, 21180, 21161, 34479, 21214, 21242, 21265, 34487, 34494, 34502, 34506, 21278, 34538, 34546, 21279, 34558, 21283, 34560, 34562, 34569, 45264, 45271, 45274, 45303, 45535, 45538, 45541, 45544, 45547, 45550, 45554, 45560, 45563, 45568, 45572, 45582, 45585, 45591, 45597, 21232, 45604, 45751, 45761, 21316, 21270, 42279, 21208, 45753, 21273, 21254, 45755, 21288, 45868, 45881, 45886, 21272, 21282, 45894, 49845, 45898, 42282, 45900, 45902, 45904, 45906, 45908, 45910, 45932, 45949, 45951, 45953, 45955, 45957, 45964, 45966, 45968, 45973, 45975, 45977, 45979, 45981, 45988, 45990, 45992, 45994, 45996, 45998, 46000, 46002, 46004, 46006, 46008, 46010, 46012, 46014, 46016, 46018, 46020, 46022, 46024, 46026, 46028, 46030, 46032, 46034, 46036, 46038, 46040, 46042, 46044, 46046, 46048, 46050, 46052, 46087, 46089, 46091, 46093, 46095, 46097, 46099, 46101, 49963, 49968, 46103, 46105, 50009, 50012, 50014, 50016, 50023, 50044, 50063, 50072, 50074, 50077, 50107, 50115, 50166, 50171, 50174, 50310, 50313, 50332, 50336, 50345, 50347, 50355, 50358, 50361, 50364, 50367, 50370, 50374, 50376, 50392, 50398, 50403, 50410, 50416, 50419, 50476, 50479, 50482, 50485, 50488, 50607, 50617, 50620, 50622, 50626, 50669, 31525, 31526, 31527, 31528, 31571, 49965, 31574, 31573, 31575, 50329, 31576, 31577, 31579, 31578, 31572, 31581, 31582, 31583, 31584, 31585, 31586, 31587, 31588, 49966, 31591, 31590, 31592, 50330, 31593, 31594, 31596, 31595, 31589, 31598, 31599, 31600, 31601, 31602, 31603, 31604, 235, 236, 237, 238, 239, 32906, 32910, 32938, 32942, 32975, 32979, 33003, 45612, 32988, 32989, 32990, 32991, 45763, 32995, 32996, 32997, 32998, 45766, 33004, 33005, 33006, 33007, 33011, 33012, 33013, 33014, 33172, 33173, 33174, 33175, 33176, 33177, 33178, 33179, 33180, 33181, 33182, 33183, 33184, 33185, 33186, 33187, 33188, 33189, 33190, 33191, 33192, 33193, 33194, 33195, 33113, 33114, 33115, 33116, 33117, 33118, 33119, 33120, 33121, 33122, 33123, 33124, 33125, 33126, 33127, 33128, 33129, 33130, 33131, 33146, 33147, 33148, 33149, 33150, 33151, 33152, 33153, 33154, 33160, 33161, 33162, 33163, 33164, 33165, 33166, 33167, 33216, 33217, 33218, 33219, 33220, 33221, 33222, 33223, 33224, 33225, 33226, 33227, 33235, 33236, 33237, 33238, 33239, 33240, 33241, 33242, 33243, 33244, 33245, 33246, 33247, 33248, 33249, 33102, 33105, 33106, 33261, 33264, 33265, 45842, 31922, 31927, 31932, 31937, 31942, 31947, 31948, 33374, 33382, 33383, 33384, 33395, 33396, 33397, 33398, 33399, 33400, 33402, 33408, 33410, 33409, 33411, 33415, 33420, 33421, 33422, 33427, 33429, 33430, 33431, 33436, 33439, 33442, 33443, 33444, 33451, 33452, 33453, 33460, 33461, 33462, 33469, 33472, 33473, 33474, 33475, 33476, 33478, 33484, 33486, 33487, 33488, 33489, 33493, 33495, 33496, 33497, 33498, 33502, 33504, 33505, 33506, 33507, 33511, 33513, 33514, 33516, 33520, 33523, 33794, 33795, 33796, 33797, 33798, 33799, 33985, 33995, 34002, 34009, 33547, 33548, 32702, 32703, 32704, 32706, 32707, 32708, 32709, 32710, 32711, 32712, 32713, 32714, 32715, 32716, 32717, 32720, 32721, 32722, 32723, 32724, 32725, 32726, 32727, 32728, 32729, 32732, 32738, 32739, 32740, 32749, 32750, 32751, 32752, 32753, 32755, 32757, 35876, 35877, 35878, 35879, 49980, 49984, 49989, 49994, 50161, 50094, 50095, 50096, 50097, 50098, 50099, 50100, 50101, 50102, 50103, 50104, 50105, 50025, 50026, 50027, 50028, 50029, 50031, 50059, 33365, 33366, 33367, 33368, 34398, 34402, 34403, 34404, 34419, 34422, 34423, 34424, 34425, 34426, 34427, 34429, 34432, 34433, 34434, 34440, 34442, 34443, 34446, 34448, 34450, 34451, 34453, 34456, 34499, 34509, 34510, 34511, 34512, 34513, 34514, 34516, 34517, 34518, 34519, 34520, 34521, 34523, 34530, 34531, 34532, 34533, 34534, 34553, 34599, 34604, 34638, 34669, 34693, 34728, 34766, 34768, 34772, 34787, 34808, 34941, 34949, 34972, 34979, 34987, 34999, 35004, 35015, 35017, 35019, 35021, 35026, 35029, 35034, 35036, 35041, 35043, 35045, 35052, 35057, 35059, 33369, 35061, 35063, 35065, 35081, 35089, 35093, 35095, 35114, 35119, 35121, 35123, 35125, 35127, 35129, 35131, 35136, 35138, 35140, 35142, 35144, 35155, 35181, 35186, 35191, 35211, 35213, 35215, 35222, 35224, 35232, 35234, 35236, 35238, 35240, 35248, 35259, 35268, 35279, 35281, 35283, 35285, 35287, 35289, 35291, 35296, 35298, 35300, 35302, 35304, 35320, 35322, 35324, 35326, 35328, 35330, 35332, 35334, 35336, 35338, 35340, 35342, 35344, 35346, 35348, 35350, 35352, 35354, 35356, 35358, 35360, 35362, 35364, 35366, 35368, 35370, 35372, 35373, 35376, 35378, 35380, 35382, 35384, 35386, 35391, 35393, 35395, 33987, 33986, 33988, 35398, 35400, 35402, 35404, 35406, 35408, 35410, 35412, 35414, 35416, 35418, 35420, 35422, 35424, 35426, 35428, 35430, 35432, 35434, 35436, 35438, 35440, 35442, 35444, 35447, 35449, 35451, 35453, 35455, 35457, 35459, 35461, 35463, 35465, 35466, 35468, 35470, 43835, 45575, 45577, 45871, 45873, 45875, 45877, 45879, 45884, 45889, 49847, 49851, 49852, 49853, 49857, 49858, 49859, 49863, 49864, 49865, 49869, 49870, 49871, 49875, 49876, 49877, 49881, 49882, 49883, 49887, 49888, 50021, 50033, 50035, 50037, 50039, 50129, 50131, 50133, 50169, 50179, 50340, 50387, 50390, 50406, 50450, 50452, 50454, 50471, 50473, 50491, 50615, 50667, 50672, 50674, 50679) GROUP BY states.metadata_id) AS anon_3 ON states.metadata_id = anon_3.max_metadata_id AND states.last_updated_ts = anon_3.max_last_updated LEFT OUTER JOIN state_attributes ON states.attributes_id = state_attributes.attributes_id \r\nWHERE states.last_updated_ts >= 1732708152.6401002e0 AND states.last_updated_ts < 1733830799.999999e0 AND states.metadata_id IN (224, 223, 222, 50501, 50518, 50535, 50564, 50581, 50598, 246, 248, 251, 32307, 32308, 32310, 32371, 31965, 31966, 31967, 31968, 31969, 32199, 32141, 32134, 32081, 32085, 32086, 32087, 32091, 32092, 32093, 32097, 32098, 32099, 32103, 32104, 32105, 32109, 32110, 32111, 32115, 32116, 32117, 32121, 32122, 32146, 32150, 32151, 32152, 32156, 32157, 32158, 32162, 32163, 32164, 32168, 32169, 32170, 32174, 32175, 32176, 32180, 32181, 32182, 32186, 32187, 32204, 32208, 32209, 32210, 32214, 32215, 32216, 32220, 32221, 32222, 32226, 32227, 32228, 32232, 32233, 32234, 32238, 32239, 32240, 32244, 32245, 32030, 32034, 32035, 32036, 32040, 32041, 32042, 32046, 32047, 32048, 32052, 32053, 32054, 32058, 32059, 32060, 32064, 32065, 32066, 32070, 32071, 49788, 49792, 49793, 49794, 49798, 49799, 49800, 49804, 49805, 49806, 49810, 49811, 49812, 49816, 49817, 49818, 49822, 49823, 49824, 49828, 49829, 31826, 31813, 31808, 31829, 31825, 316, 317, 318, 323, 45941, 45942, 48118, 48119, 31763, 31764, 31774, 31775, 48075, 48076, 48105, 48106, 31769, 31770, 48048, 48049, 48134, 48135, 45918, 45919, 31758, 31759, 31784, 31785, 31786, 31787, 31788, 31789, 31790, 31791, 32006, 299, 300, 371, 302, 303, 304, 305, 306, 307, 32611, 32612, 32615, 32616, 32617, 32618, 32619, 32620, 32621, 32623, 32627, 32629, 32631, 32633, 32634, 389, 49770, 391, 49772, 394, 395, 397, 10809, 10810, 34465, 10814, 10812, 10813, 10816, 10817, 10818, 42219, 42217, 42221, 42222, 49716, 42223, 10826, 10828, 10830, 45857, 10831, 10832, 10833, 10834, 42224, 45850, 10837, 10839, 10838, 10961, 10840, 10836, 10842, 10843, 10844, 50378, 10845, 10846, 49717, 49971, 42226, 10851, 42227, 49975, 10909, 10854, 10855, 42228, 42229, 10858, 10859, 42230, 10861, 42231, 10864, 42232, 10867, 49842, 50294, 10869, 10870, 42233, 42234, 10874, 49718, 10878, 10880, 10881, 42236, 10883, 10884, 10885, 49720, 49721, 10890, 10891, 10893, 50675, 10954, 10960, 50394, 10898, 42238, 49722, 49723, 50297, 10902, 10903, 10904, 10905, 42239, 49785, 42240, 10825, 42242, 10913, 45592, 10916, 45565, 50412, 10919, 42541, 10920, 10921, 45895, 10923, 42243, 10926, 10927, 49728, 49724, 42246, 10931, 10933, 42247, 42248, 42249, 42250, 10972, 49725, 49726, 10940, 42253, 49727, 10943, 42254, 10966, 10945, 49719, 10911, 10922, 42220, 45556, 10822, 10985, 10895, 34469, 10824, 34473, 10841, 34474, 10872, 10853, 34475, 10906, 10934, 10957, 34486, 34493, 34501, 34505, 10970, 34537, 34545, 10971, 34557, 10975, 34559, 34561, 34568, 45263, 45270, 45273, 45302, 45534, 45537, 45540, 45543, 45546, 45549, 45553, 45559, 45562, 45567, 45571, 45581, 45584, 45590, 45596, 10924, 45603, 45750, 45760, 11008, 10962, 42241, 10900, 45752, 10965, 10946, 45754, 10980, 45867, 45880, 45885, 10964, 10974, 45893, 49843, 45897, 42244, 45899, 45901, 45903, 45905, 45907, 45909, 45931, 45948, 45950, 45952, 45954, 45956, 45963, 45965, 45967, 45972, 45974, 45976, 45978, 45980, 45987, 45989, 45991, 45993, 45995, 45997, 45999, 46001, 46003, 46005, 46007, 46009, 46011, 46013, 46015, 46017, 46019, 46021, 46023, 46025, 46027, 46029, 46031, 46033, 46035, 46037, 46039, 46041, 46043, 46045, 46047, 46049, 46051, 46086, 46088, 46090, 46092, 46094, 46096, 46098, 46100, 49962, 49967, 46102, 46104, 50008, 50011, 50013, 50015, 50022, 50043, 50062, 50071, 50073, 50076, 50106, 50114, 50165, 50170, 50173, 50309, 50312, 50331, 50335, 50344, 50346, 50354, 50357, 50360, 50363, 50366, 50369, 50373, 50375, 50391, 50397, 50402, 50409, 50415, 50418, 50475, 50478, 50481, 50484, 50487, 50606, 50616, 50619, 50621, 50625, 50668, 21117, 21118, 34466, 21122, 21120, 21121, 21124, 21125, 21126, 42257, 42255, 42259, 42260, 49729, 42261, 21134, 21136, 21138, 45858, 21139, 21140, 21141, 21142, 42262, 45851, 21145, 21147, 21146, 21269, 21148, 21144, 21150, 21151, 21152, 50379, 21153, 21154, 49730, 49972, 42264, 21159, 42265, 49976, 21217, 21162, 21163, 42266, 42267, 21166, 21167, 42268, 21169, 42269, 21172, 42270, 21175, 49844, 50295, 21177, 21178, 42271, 42272, 21182, 49731, 21186, 21188, 21189, 42274, 21191, 21192, 21193, 49733, 49734, 21198, 21199, 21201, 50676, 21262, 21268, 50395, 21206, 42276, 49735, 49736, 50298, 21210, 21211, 21212, 21213, 42277, 49786, 42278, 21133, 42280, 21221, 45593, 21224, 45566, 50413, 21227, 42542, 21228, 21229, 45896, 21231, 42281, 21234, 21235, 49741, 49737, 42284, 21239, 21241, 42285, 42286, 42287, 42288, 21280, 49738, 49739, 21248, 42291, 49740, 21251, 42292, 21274, 21253, 49732, 21219, 21230, 42258, 45557, 21130, 21293, 21203, 34470, 21132, 34477, 21149, 34478, 21180, 21161, 34479, 21214, 21242, 21265, 34487, 34494, 34502, 34506, 21278, 34538, 34546, 21279, 34558, 21283, 34560, 34562, 34569, 45264, 45271, 45274, 45303, 45535, 45538, 45541, 45544, 45547, 45550, 45554, 45560, 45563, 45568, 45572, 45582, 45585, 45591, 45597, 21232, 45604, 45751, 45761, 21316, 21270, 42279, 21208, 45753, 21273, 21254, 45755, 21288, 45868, 45881, 45886, 21272, 21282, 45894, 49845, 45898, 42282, 45900, 45902, 45904, 45906, 45908, 45910, 45932, 45949, 45951, 45953, 45955, 45957, 45964, 45966, 45968, 45973, 45975, 45977, 45979, 45981, 45988, 45990, 45992, 45994, 45996, 45998, 46000, 46002, 46004, 46006, 46008, 46010, 46012, 46014, 46016, 46018, 46020, 46022, 46024, 46026, 46028, 46030, 46032, 46034, 46036, 46038, 46040, 46042, 46044, 46046, 46048, 46050, 46052, 46087, 46089, 46091, 46093, 46095, 46097, 46099, 46101, 49963, 49968, 46103, 46105, 50009, 50012, 50014, 50016, 50023, 50044, 50063, 50072, 50074, 50077, 50107, 50115, 50166, 50171, 50174, 50310, 50313, 50332, 50336, 50345, 50347, 50355, 50358, 50361, 50364, 50367, 50370, 50374, 50376, 50392, 50398, 50403, 50410, 50416, 50419, 50476, 50479, 50482, 50485, 50488, 50607, 50617, 50620, 50622, 50626, 50669, 31525, 31526, 31527, 31528, 31571, 49965, 31574, 31573, 31575, 50329, 31576, 31577, 31579, 31578, 31572, 31581, 31582, 31583, 31584, 31585, 31586, 31587, 31588, 49966, 31591, 31590, 31592, 50330, 31593, 31594, 31596, 31595, 31589, 31598, 31599, 31600, 31601, 31602, 31603, 31604, 235, 236, 237, 238, 239, 32906, 32910, 32938, 32942, 32975, 32979, 33003, 45612, 32988, 32989, 32990, 32991, 45763, 32995, 32996, 32997, 32998, 45766, 33004, 33005, 33006, 33007, 33011, 33012, 33013, 33014, 33172, 33173, 33174, 33175, 33176, 33177, 33178, 33179, 33180, 33181, 33182, 33183, 33184, 33185, 33186, 33187, 33188, 33189, 33190, 33191, 33192, 33193, 33194, 33195, 33113, 33114, 33115, 33116, 33117, 33118, 33119, 33120, 33121, 33122, 33123, 33124, 33125, 33126, 33127, 33128, 33129, 33130, 33131, 33146, 33147, 33148, 33149, 33150, 33151, 33152, 33153, 33154, 33160, 33161, 33162, 33163, 33164, 33165, 33166, 33167, 33216, 33217, 33218, 33219, 33220, 33221, 33222, 33223, 33224, 33225, 33226, 33227, 33235, 33236, 33237, 33238, 33239, 33240, 33241, 33242, 33243, 33244, 33245, 33246, 33247, 33248, 33249, 33102, 33105, 33106, 33261, 33264, 33265, 45842, 31922, 31927, 31932, 31937, 31942, 31947, 31948, 33374, 33382, 33383, 33384, 33395, 33396, 33397, 33398, 33399, 33400, 33402, 33408, 33410, 33409, 33411, 33415, 33420, 33421, 33422, 33427, 33429, 33430, 33431, 33436, 33439, 33442, 33443, 33444, 33451, 33452, 33453, 33460, 33461, 33462, 33469, 33472, 33473, 33474, 33475, 33476, 33478, 33484, 33486, 33487, 33488, 33489, 33493, 33495, 33496, 33497, 33498, 33502, 33504, 33505, 33506, 33507, 33511, 33513, 33514, 33516, 33520, 33523, 33794, 33795, 33796, 33797, 33798, 33799, 33985, 33995, 34002, 34009, 33547, 33548, 32702, 32703, 32704, 32706, 32707, 32708, 32709, 32710, 32711, 32712, 32713, 32714, 32715, 32716, 32717, 32720, 32721, 32722, 32723, 32724, 32725, 32726, 32727, 32728, 32729, 32732, 32738, 32739, 32740, 32749, 32750, 32751, 32752, 32753, 32755, 32757, 35876, 35877, 35878, 35879, 49980, 49984, 49989, 49994, 50161, 50094, 50095, 50096, 50097, 50098, 50099, 50100, 50101, 50102, 50103, 50104, 50105, 50025, 50026, 50027, 50028, 50029, 50031, 50059, 33365, 33366, 33367, 33368, 34398, 34402, 34403, 34404, 34419, 34422, 34423, 34424, 34425, 34426, 34427, 34429, 34432, 34433, 34434, 34440, 34442, 34443, 34446, 34448, 34450, 34451, 34453, 34456, 34499, 34509, 34510, 34511, 34512, 34513, 34514, 34516, 34517, 34518, 34519, 34520, 34521, 34523, 34530, 34531, 34532, 34533, 34534, 34553, 34599, 34604, 34638, 34669, 34693, 34728, 34766, 34768, 34772, 34787, 34808, 34941, 34949, 34972, 34979, 34987, 34999, 35004, 35015, 35017, 35019, 35021, 35026, 35029, 35034, 35036, 35041, 35043, 35045, 35052, 35057, 35059, 33369, 35061, 35063, 35065, 35081, 35089, 35093, 35095, 35114, 35119, 35121, 35123, 35125, 35127, 35129, 35131, 35136, 35138, 35140, 35142, 35144, 35155, 35181, 35186, 35191, 35211, 35213, 35215, 35222, 35224, 35232, 35234, 35236, 35238, 35240, 35248, 35259, 35268, 35279, 35281, 35283, 35285, 35287, 35289, 35291, 35296, 35298, 35300, 35302, 35304, 35320, 35322, 35324, 35326, 35328, 35330, 35332, 35334, 35336, 35338, 35340, 35342, 35344, 35346, 35348, 35350, 35352, 35354, 35356, 35358, 35360, 35362, 35364, 35366, 35368, 35370, 35372, 35373, 35376, 35378, 35380, 35382, 35384, 35386, 35391, 35393, 35395, 33987, 33986, 33988, 35398, 35400, 35402, 35404, 35406, 35408, 35410, 35412, 35414, 35416, 35418, 35420, 35422, 35424, 35426, 35428, 35430, 35432, 35434, 35436, 35438, 35440, 35442, 35444, 35447, 35449, 35451, 35453, 35455, 35457, 35459, 35461, 35463, 35465, 35466, 35468, 35470, 43835, 45575, 45577, 45871, 45873, 45875, 45877, 45879, 45884, 45889, 49847, 49851, 49852, 49853, 49857, 49858, 49859, 49863, 49864, 49865, 49869, 49870, 49871, 49875, 49876, 49877, 49881, 49882, 49883, 49887, 49888, 50021, 50033, 50035, 50037, 50039, 50129, 50131, 50133, 50169, 50179, 50340, 50387, 50390, 50406, 50450, 50452, 50454, 50471, 50473, 50491, 50615, 50667, 50672, 50674, 50679)) AS anon_2 UNION ALL SELECT anon_4.metadata_id AS metadata_id, anon_4.state AS state, anon_4.last_updated_ts AS last_updated_ts, anon_4.attributes AS attributes \r\nFROM (SELECT states.metadata_id AS metadata_id, states.state AS state, states.last_updated_ts AS last_updated_ts, CASE WHEN (state_attributes.shared_attrs IS NULL) THEN states.attributes ELSE state_attributes.shared_attrs END AS attributes \r\nFROM states LEFT OUTER JOIN state_attributes ON states.attributes_id = state_attributes.attributes_id \r\nWHERE (states.last_changed_ts = states.last_updated_ts OR states.last_changed_ts IS NULL) AND states.metadata_id IN (224, 223, 222, 50501, 50518, 50535, 50564, 50581, 50598, 246, 248, 251, 32307, 32308, 32310, 32371, 31965, 31966, 31967, 31968, 31969, 32199, 32141, 32134, 32081, 32085, 32086, 32087, 32091, 32092, 32093, 32097, 32098, 32099, 32103, 32104, 32105, 32109, 32110, 32111, 32115, 32116, 32117, 32121, 32122, 32146, 32150, 32151, 32152, 32156, 32157, 32158, 32162, 32163, 32164, 32168, 32169, 32170, 32174, 32175, 32176, 32180, 32181, 32182, 32186, 32187, 32204, 32208, 32209, 32210, 32214, 32215, 32216, 32220, 32221, 32222, 32226, 32227, 32228, 32232, 32233, 32234, 32238, 32239, 32240, 32244, 32245, 32030, 32034, 32035, 32036, 32040, 32041, 32042, 32046, 32047, 32048, 32052, 32053, 32054, 32058, 32059, 32060, 32064, 32065, 32066, 32070, 32071, 49788, 49792, 49793, 49794, 49798, 49799, 49800, 49804, 49805, 49806, 49810, 49811, 49812, 49816, 49817, 49818, 49822, 49823, 49824, 49828, 49829, 31826, 31813, 31808, 31829, 31825, 316, 317, 318, 323, 45941, 45942, 48118, 48119, 31763, 31764, 31774, 31775, 48075, 48076, 48105, 48106, 31769, 31770, 48048, 48049, 48134, 48135, 45918, 45919, 31758, 31759, 31784, 31785, 31786, 31787, 31788, 31789, 31790, 31791, 32006, 299, 300, 371, 302, 303, 304, 305, 306, 307, 32611, 32612, 32615, 32616, 32617, 32618, 32619, 32620, 32621, 32623, 32627, 32629, 32631, 32633, 32634, 389, 49770, 391, 49772, 394, 395, 397, 10809, 10810, 34465, 10814, 10812, 10813, 10816, 10817, 10818, 42219, 42217, 42221, 42222, 49716, 42223, 10826, 10828, 10830, 45857, 10831, 10832, 10833, 10834, 42224, 45850, 10837, 10839, 10838, 10961, 10840, 10836, 10842, 10843, 10844, 50378, 10845, 10846, 49717, 49971, 42226, 10851, 42227, 49975, 10909, 10854, 10855, 42228, 42229, 10858, 10859, 42230, 10861, 42231, 10864, 42232, 10867, 49842, 50294, 10869, 10870, 42233, 42234, 10874, 49718, 10878, 10880, 10881, 42236, 10883, 10884, 10885, 49720, 49721, 10890, 10891, 10893, 50675, 10954, 10960, 50394, 10898, 42238, 49722, 49723, 50297, 10902, 10903, 10904, 10905, 42239, 49785, 42240, 10825, 42242, 10913, 45592, 10916, 45565, 50412, 10919, 42541, 10920, 10921, 45895, 10923, 42243, 10926, 10927, 49728, 49724, 42246, 10931, 10933, 42247, 42248, 42249, 42250, 10972, 49725, 49726, 10940, 42253, 49727, 10943, 42254, 10966, 10945, 49719, 10911, 10922, 42220, 45556, 10822, 10985, 10895, 34469, 10824, 34473, 10841, 34474, 10872, 10853, 34475, 10906, 10934, 10957, 34486, 34493, 34501, 34505, 10970, 34537, 34545, 10971, 34557, 10975, 34559, 34561, 34568, 45263, 45270, 45273, 45302, 45534, 45537, 45540, 45543, 45546, 45549, 45553, 45559, 45562, 45567, 45571, 45581, 45584, 45590, 45596, 10924, 45603, 45750, 45760, 11008, 10962, 42241, 10900, 45752, 10965, 10946, 45754, 10980, 45867, 45880, 45885, 10964, 10974, 45893, 49843, 45897, 42244, 45899, 45901, 45903, 45905, 45907, 45909, 45931, 45948, 45950, 45952, 45954, 45956, 45963, 45965, 45967, 45972, 45974, 45976, 45978, 45980, 45987, 45989, 45991, 45993, 45995, 45997, 45999, 46001, 46003, 46005, 46007, 46009, 46011, 46013, 46015, 46017, 46019, 46021, 46023, 46025, 46027, 46029, 46031, 46033, 46035, 46037, 46039, 46041, 46043, 46045, 46047, 46049, 46051, 46086, 46088, 46090, 46092, 46094, 46096, 46098, 46100, 49962, 49967, 46102, 46104, 50008, 50011, 50013, 50015, 50022, 50043, 50062, 50071, 50073, 50076, 50106, 50114, 50165, 50170, 50173, 50309, 50312, 50331, 50335, 50344, 50346, 50354, 50357, 50360, 50363, 50366, 50369, 50373, 50375, 50391, 50397, 50402, 50409, 50415, 50418, 50475, 50478, 50481, 50484, 50487, 50606, 50616, 50619, 50621, 50625, 50668, 21117, 21118, 34466, 21122, 21120, 21121, 21124, 21125, 21126, 42257, 42255, 42259, 42260, 49729, 42261, 21134, 21136, 21138, 45858, 21139, 21140, 21141, 21142, 42262, 45851, 21145, 21147, 21146, 21269, 21148, 21144, 21150, 21151, 21152, 50379, 21153, 21154, 49730, 49972, 42264, 21159, 42265, 49976, 21217, 21162, 21163, 42266, 42267, 21166, 21167, 42268, 21169, 42269, 21172, 42270, 21175, 49844, 50295, 21177, 21178, 42271, 42272, 21182, 49731, 21186, 21188, 21189, 42274, 21191, 21192, 21193, 49733, 49734, 21198, 21199, 21201, 50676, 21262, 21268, 50395, 21206, 42276, 49735, 49736, 50298, 21210, 21211, 21212, 21213, 42277, 49786, 42278, 21133, 42280, 21221, 45593, 21224, 45566, 50413, 21227, 42542, 21228, 21229, 45896, 21231, 42281, 21234, 21235, 49741, 49737, 42284, 21239, 21241, 42285, 42286, 42287, 42288, 21280, 49738, 49739, 21248, 42291, 49740, 21251, 42292, 21274, 21253, 49732, 21219, 21230, 42258, 45557, 21130, 21293, 21203, 34470, 21132, 34477, 21149, 34478, 21180, 21161, 34479, 21214, 21242, 21265, 34487, 34494, 34502, 34506, 21278, 34538, 34546, 21279, 34558, 21283, 34560, 34562, 34569, 45264, 45271, 45274, 45303, 45535, 45538, 45541, 45544, 45547, 45550, 45554, 45560, 45563, 45568, 45572, 45582, 45585, 45591, 45597, 21232, 45604, 45751, 45761, 21316, 21270, 42279, 21208, 45753, 21273, 21254, 45755, 21288, 45868, 45881, 45886, 21272, 21282, 45894, 49845, 45898, 42282, 45900, 45902, 45904, 45906, 45908, 45910, 45932, 45949, 45951, 45953, 45955, 45957, 45964, 45966, 45968, 45973, 45975, 45977, 45979, 45981, 45988, 45990, 45992, 45994, 45996, 45998, 46000, 46002, 46004, 46006, 46008, 46010, 46012, 46014, 46016, 46018, 46020, 46022, 46024, 46026, 46028, 46030, 46032, 46034, 46036, 46038, 46040, 46042, 46044, 46046, 46048, 46050, 46052, 46087, 46089, 46091, 46093, 46095, 46097, 46099, 46101, 49963, 49968, 46103, 46105, 50009, 50012, 50014, 50016, 50023, 50044, 50063, 50072, 50074, 50077, 50107, 50115, 50166, 50171, 50174, 50310, 50313, 50332, 50336, 50345, 50347, 50355, 50358, 50361, 50364, 50367, 50370, 50374, 50376, 50392, 50398, 50403, 50410, 50416, 50419, 50476, 50479, 50482, 50485, 50488, 50607, 50617, 50620, 50622, 50626, 50669, 31525, 31526, 31527, 31528, 31571, 49965, 31574, 31573, 31575, 50329, 31576, 31577, 31579, 31578, 31572, 31581, 31582, 31583, 31584, 31585, 31586, 31587, 31588, 49966, 31591, 31590, 31592, 50330, 31593, 31594, 31596, 31595, 31589, 31598, 31599, 31600, 31601, 31602, 31603, 31604, 235, 236, 237, 238, 239, 32906, 32910, 32938, 32942, 32975, 32979, 33003, 45612, 32988, 32989, 32990, 32991, 45763, 32995, 32996, 32997, 32998, 45766, 33004, 33005, 33006, 33007, 33011, 33012, 33013, 33014, 33172, 33173, 33174, 33175, 33176, 33177, 33178, 33179, 33180, 33181, 33182, 33183, 33184, 33185, 33186, 33187, 33188, 33189, 33190, 33191, 33192, 33193, 33194, 33195, 33113, 33114, 33115, 33116, 33117, 33118, 33119, 33120, 33121, 33122, 33123, 33124, 33125, 33126, 33127, 33128, 33129, 33130, 33131, 33146, 33147, 33148, 33149, 33150, 33151, 33152, 33153, 33154, 33160, 33161, 33162, 33163, 33164, 33165, 33166, 33167, 33216, 33217, 33218, 33219, 33220, 33221, 33222, 33223, 33224, 33225, 33226, 33227, 33235, 33236, 33237, 33238, 33239, 33240, 33241, 33242, 33243, 33244, 33245, 33246, 33247, 33248, 33249, 33102, 33105, 33106, 33261, 33264, 33265, 45842, 31922, 31927, 31932, 31937, 31942, 31947, 31948, 33374, 33382, 33383, 33384, 33395, 33396, 33397, 33398, 33399, 33400, 33402, 33408, 33410, 33409, 33411, 33415, 33420, 33421, 33422, 33427, 33429, 33430, 33431, 33436, 33439, 33442, 33443, 33444, 33451, 33452, 33453, 33460, 33461, 33462, 33469, 33472, 33473, 33474, 33475, 33476, 33478, 33484, 33486, 33487, 33488, 33489, 33493, 33495, 33496, 33497, 33498, 33502, 33504, 33505, 33506, 33507, 33511, 33513, 33514, 33516, 33520, 33523, 33794, 33795, 33796, 33797, 33798, 33799, 33985, 33995, 34002, 34009, 33547, 33548, 32702, 32703, 32704, 32706, 32707, 32708, 32709, 32710, 32711, 32712, 32713, 32714, 32715, 32716, 32717, 32720, 32721, 32722, 32723, 32724, 32725, 32726, 32727, 32728, 32729, 32732, 32738, 32739, 32740, 32749, 32750, 32751, 32752, 32753, 32755, 32757, 35876, 35877, 35878, 35879, 49980, 49984, 49989, 49994, 50161, 50094, 50095, 50096, 50097, 50098, 50099, 50100, 50101, 50102, 50103, 50104, 50105, 50025, 50026, 50027, 50028, 50029, 50031, 50059, 33365, 33366, 33367, 33368, 34398, 34402, 34403, 34404, 34419, 34422, 34423, 34424, 34425, 34426, 34427, 34429, 34432, 34433, 34434, 34440, 34442, 34443, 34446, 34448, 34450, 34451, 34453, 34456, 34499, 34509, 34510, 34511, 34512, 34513, 34514, 34516, 34517, 34518, 34519, 34520, 34521, 34523, 34530, 34531, 34532, 34533, 34534, 34553, 34599, 34604, 34638, 34669, 34693, 34728, 34766, 34768, 34772, 34787, 34808, 34941, 34949, 34972, 34979, 34987, 34999, 35004, 35015, 35017, 35019, 35021, 35026, 35029, 35034, 35036, 35041, 35043, 35045, 35052, 35057, 35059, 33369, 35061, 35063, 35065, 35081, 35089, 35093, 35095, 35114, 35119, 35121, 35123, 35125, 35127, 35129, 35131, 35136, 35138, 35140, 35142, 35144, 35155, 35181, 35186, 35191, 35211, 35213, 35215, 35222, 35224, 35232, 35234, 35236, 35238, 35240, 35248, 35259, 35268, 35279, 35281, 35283, 35285, 35287, 35289, 35291, 35296, 35298, 35300, 35302, 35304, 35320, 35322, 35324, 35326, 35328, 35330, 35332, 35334, 35336, 35338, 35340, 35342, 35344, 35346, 35348, 35350, 35352, 35354, 35356, 35358, 35360, 35362, 35364, 35366, 35368, 35370, 35372, 35373, 35376, 35378, 35380, 35382, 35384, 35386, 35391, 35393, 35395, 33987, 33986, 33988, 35398, 35400, 35402, 35404, 35406, 35408, 35410, 35412, 35414, 35416, 35418, 35420, 35422, 35424, 35426, 35428, 35430, 35432, 35434, 35436, 35438, 35440, 35442, 35444, 35447, 35449, 35451, 35453, 35455, 35457, 35459, 35461, 35463, 35465, 35466, 35468, 35470, 43835, 45575, 45577, 45871, 45873, 45875, 45877, 45879, 45884, 45889, 49847, 49851, 49852, 49853, 49857, 49858, 49859, 49863, 49864, 49865, 49869, 49870, 49871, 49875, 49876, 49877, 49881, 49882, 49883, 49887, 49888, 50021, 50033, 50035, 50037, 50039, 50129, 50131, 50133, 50169, 50179, 50340, 50387, 50390, 50406, 50450, 50452, 50454, 50471, 50473, 50491, 50615, 50667, 50672, 50674, 50679) AND states.last_updated_ts > 1733830799.999999e0 AND states.last_updated_ts < 1733831100.0e0) AS anon_4) AS anon_1 ORDER BY anon_1.metadata_id, anon_1.last_updated_ts\r\nProgress: 0.000\r\n*************************** 5. row ***************************\r\n      Id: 977\r\n    User: homeassistant\r\n    Host: 172.31.0.1:49244\r\n      db: ha_db\r\n Command: Sleep\r\n    Time: 45\r\n   State: \r\n    Info: NULL\r\nProgress: 0.000\r\n5 rows in set (0.00 sec)\r\n\r\nERROR: \r\nNo query specified\r\n\r\nmysql> \r\n```\nI'm traveling this week so I can't take a look at the moment.\r\n\r\nIf you post some explains of those it might give a clue about why its selecting so many rows\r\n\r\nhttps://dev.mysql.com/doc/refman/8.4/en/explain.html\nStack Traces from murdered queries.\r\n\r\n```omeassistant  | [SQL: SELECT anon_1.metadata_id, anon_1.state, anon_1.last_updated_ts, anon_1.attributes\r\nhomeassistant  | FROM (SELECT anon_2.metadata_id AS metadata_id, anon_2.state AS state, anon_2.last_updated_ts AS last_updated_ts, anon_2.attributes AS attributes\r\nhomeassistant  | FROM (SELECT states.metadata_id AS metadata_id, states.state AS state, %s AS last_updated_ts, CASE WHEN (state_attributes.shared_attrs IS NULL) THEN states.attributes ELSE state_attributes.shared_attrs END AS attributes\r\nhomeassistant  | FROM states INNER JOIN (SELECT states.metadata_id AS max_metadata_id, max(states.last_updated_ts) AS max_last_updated\r\nhomeassistant  | FROM states\r\nhomeassistant  | WHERE states.last_updated_ts >= %s AND states.last_updated_ts < %s AND states.metadata_id IN (%s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s) GROUP BY states.metadata_id) AS anon_3 ON states.metadata_id = anon_3.max_metadata_id AND states.last_updated_ts = anon_3.max_last_updated LEFT OUTER JOIN state_attributes ON states.attributes_id = state_attributes.attributes_id\r\nhomeassistant  | WHERE states.last_updated_ts >= %s AND states.last_updated_ts < %s AND states.metadata_id IN (%s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s)) AS anon_2 UNION ALL SELECT anon_4.metadata_id AS metadata_id, anon_4.state AS state, anon_4.last_updated_ts AS last_updated_ts, anon_4.attributes AS attributes\r\nhomeassistant  | FROM (SELECT states.metadata_id AS metadata_id, states.state AS state, states.last_updated_ts AS last_updated_ts, CASE WHEN (state_attributes.shared_attrs IS NULL) THEN states.attributes ELSE state_attributes.shared_attrs END AS attributes\r\nhomeassistant  | FROM states LEFT OUTER JOIN state_attributes ON states.attributes_id = state_attributes.attributes_id\r\nhomeassistant  | WHERE (states.last_changed_ts = states.last_updated_ts OR states.last_changed_ts IS NULL) AND states.metadata_id IN (%s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s) AND states.last_updated_ts > %s AND states.last_updated_ts < %s) AS anon_4) AS anon_1 ORDER BY anon_1.metadata_id, anon_1.last_updated_ts]\r\nhomeassistant  | [parameters: (0, 1732708152.6401002, 1733830799.999999, 224, 223, 222, 50501, 50518, 50535, 50564, 50581, 50598, 246, 248, 251, 32307, 32308, 32310, 32371, 31965, 31966, 31967, 31968, 31969, 32199, 32141, 32134, 32081, 32085, 32086, 32087, 32091, 32092, 32093, 32097, 32098, 32099, 32103, 32104, 32105, 32109, 32110, 32111, 32115, 32116, 32117, 32121, 32122, 32146, 32150 ... 4092 parameters truncated ... 45884, 45889, 49847, 49851, 49852, 49853, 49857, 49858, 49859, 49863, 49864, 49865, 49869, 49870, 49871, 49875, 49876, 49877, 49881, 49882, 49883, 49887, 49888, 50021, 50033, 50035, 50037, 50039, 50129, 50131, 50133, 50169, 50179, 50340, 50387, 50390, 50406, 50450, 50452, 50454, 50471, 50473, 50491, 50615, 50667, 50672, 50674, 50679, 1733830799.999999, 1733831100.0)]\r\nhomeassistant  | (Background on this error at: https://sqlalche.me/e/20/e3q8)\r\nhomeassistant  | 2024-12-10 15:29:03.316 ERROR (Recorder) [homeassistant.components.recorder.util] Error executing query: Can't reconnect until invalid transaction is rolled back.  Please rollback() fully before proceeding (Background on this error at: https://sqlalche.me/e/20/8s2b)\r\nhomeassistant  | 2024-12-10 15:29:03.454 ERROR (Recorder) [homeassistant.components.recorder.util] Error executing query: Can't reconnect until invalid transaction is rolled back.  Please rollback() fully before proceeding (Background on this error at: https://sqlalche.me/e/20/8s2b)\r\nhomeassistant  | 2024-12-10 15:29:03.505 ERROR (Recorder) [homeassistant.helpers.recorder] Error executing query\r\nhomeassistant  | Traceback (most recent call last):\r\nhomeassistant  |   File \"/usr/src/homeassistant/homeassistant/helpers/recorder.py\", line 101, in session_scope\r\nhomeassistant  |     yield session\r\nhomeassistant  |   File \"/usr/src/homeassistant/homeassistant/components/recorder/statistics.py\", line 484, in compile_missing_statistics\r\nhomeassistant  |     modified_statistic_ids = _compile_statistics(\r\nhomeassistant  |         instance, session, start, end >= last_period\r\nhomeassistant  |     )\r\nhomeassistant  |   File \"/usr/src/homeassistant/homeassistant/components/recorder/statistics.py\", line 566, in _compile_statistics\r\nhomeassistant  |     compiled: PlatformCompiledStatistics = platform_compile_statistics(\r\nhomeassistant  |                                            ~~~~~~~~~~~~~~~~~~~~~~~~~~~^\r\nhomeassistant  |         instance.hass, session, start, end\r\nhomeassistant  |         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\nhomeassistant  |     )\r\nhomeassistant  |     ^\r\nhomeassistant  |   File \"/usr/src/homeassistant/homeassistant/components/sensor/recorder.py\", line 436, in compile_statistics\r\nhomeassistant  |     _history_list = history.get_full_significant_states_with_session(\r\nhomeassistant  |         hass,\r\nhomeassistant  |     ...<3 lines>...\r\nhomeassistant  |         entity_ids=entities_significant_history,\r\nhomeassistant  |     )\r\nhomeassistant  |   File \"/usr/src/homeassistant/homeassistant/components/recorder/history/__init__.py\", line 55, in get_full_significant_states_with_session\r\nhomeassistant  |     return _target(\r\nhomeassistant  |         hass,\r\nhomeassistant  |     ...<7 lines>...\r\nhomeassistant  |         no_attributes,\r\nhomeassistant  |     )\r\nhomeassistant  |   File \"/usr/src/homeassistant/homeassistant/components/recorder/history/modern.py\", line 306, in get_full_significant_states_with_session\r\nhomeassistant  |     get_significant_states_with_session(\r\nhomeassistant  |     ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^\r\nhomeassistant  |         hass=hass,\r\nhomeassistant  |         ^^^^^^^^^^\r\nhomeassistant  |     ...<8 lines>...\r\nhomeassistant  |         no_attributes=no_attributes,\r\nhomeassistant  |         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\nhomeassistant  |     ),\r\nhomeassistant  |     ^\r\nhomeassistant  |   File \"/usr/src/homeassistant/homeassistant/components/recorder/history/modern.py\", line 278, in get_significant_states_with_session\r\nhomeassistant  |     execute_stmt_lambda_element(session, stmt, None, end_time, orm_rows=False),\r\nhomeassistant  |     ~~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\nhomeassistant  |   File \"/usr/src/homeassistant/homeassistant/components/recorder/util.py\", line 197, in execute_stmt_lambda_element\r\nhomeassistant  |     executed = session.connection().execute(stmt)\r\nhomeassistant  |   File \"/usr/local/lib/python3.13/site-packages/sqlalchemy/engine/base.py\", line 1418, in execute\r\nhomeassistant  |     return meth(\r\nhomeassistant  |         self,\r\nhomeassistant  |         distilled_parameters,\r\nhomeassistant  |         execution_options or NO_OPTIONS,\r\nhomeassistant  |     )\r\nhomeassistant  |   File \"/usr/local/lib/python3.13/site-packages/sqlalchemy/sql/lambdas.py\", line 603, in _execute_on_connection\r\nhomeassistant  |     return connection._execute_clauseelement(\r\nhomeassistant  |            ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^\r\nhomeassistant  |         self, distilled_params, execution_options\r\nhomeassistant  |         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\nhomeassistant  |     )\r\nhomeassistant  |     ^\r\nhomeassistant  |   File \"/usr/local/lib/python3.13/site-packages/sqlalchemy/engine/base.py\", line 1640, in _execute_clauseelement\r\nhomeassistant  |     ret = self._execute_context(\r\nhomeassistant  |         dialect,\r\nhomeassistant  |     ...<8 lines>...\r\nhomeassistant  |         cache_hit=cache_hit,\r\nhomeassistant  |     )\r\nhomeassistant  |   File \"/usr/local/lib/python3.13/site-packages/sqlalchemy/engine/base.py\", line 1813, in _execute_context\r\nhomeassistant  |     conn = self._revalidate_connection()\r\nhomeassistant  |   File \"/usr/local/lib/python3.13/site-packages/sqlalchemy/engine/base.py\", line 677, in _revalidate_connection\r\nhomeassistant  |     self._invalid_transaction()\r\nhomeassistant  |     ~~~~~~~~~~~~~~~~~~~~~~~~~^^\r\nhomeassistant  |   File \"/usr/local/lib/python3.13/site-packages/sqlalchemy/engine/base.py\", line 667, in _invalid_transaction\r\nhomeassistant  |     raise exc.PendingRollbackError(\r\nhomeassistant  |     ...<4 lines>...\r\nhomeassistant  |     )\r\nhomeassistant  | sqlalchemy.exc.PendingRollbackError: Can't reconnect until invalid transaction is rolled back.  Please rollback() fully before proceeding (Background on this error at: https://sqlalche.me/e/20/8s2b)\r\nhomeassistant  | 2024-12-10 15:29:03.557 ERROR (Recorder) [homeassistant.components.recorder.core] SQLAlchemyError error processing task CompileMissingStatisticsTask()\r\nhomeassistant  | Traceback (most recent call last):\r\nhomeassistant  |   File \"/usr/src/homeassistant/homeassistant/components/recorder/core.py\", line 882, in _process_one_task_or_event_or_recover\r\nhomeassistant  |     task.run(self)\r\nhomeassistant  |     ~~~~~~~~^^^^^^\r\nhomeassistant  |   File \"/usr/src/homeassistant/homeassistant/components/recorder/tasks.py\", line 182, in run\r\nhomeassistant  |     if statistics.compile_missing_statistics(instance):\r\nhomeassistant  |        ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^\r\nhomeassistant  |   File \"/usr/src/homeassistant/homeassistant/components/recorder/util.py\", line 689, in wrapper\r\nhomeassistant  |     return job(*args, **kwargs)\r\nhomeassistant  |   File \"/usr/src/homeassistant/homeassistant/components/recorder/statistics.py\", line 484, in compile_missing_statistics\r\nhomeassistant  |     modified_statistic_ids = _compile_statistics(\r\nhomeassistant  |         instance, session, start, end >= last_period\r\nhomeassistant  |     )\r\nhomeassistant  |   File \"/usr/src/homeassistant/homeassistant/components/recorder/statistics.py\", line 566, in _compile_statistics\r\nhomeassistant  |     compiled: PlatformCompiledStatistics = platform_compile_statistics(\r\nhomeassistant  |                                            ~~~~~~~~~~~~~~~~~~~~~~~~~~~^\r\nhomeassistant  |         instance.hass, session, start, end\r\nhomeassistant  |         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\nhomeassistant  |     )\r\nhomeassistant  |     ^\r\nhomeassistant  |   File \"/usr/src/homeassistant/homeassistant/components/sensor/recorder.py\", line 436, in compile_statistics\r\nhomeassistant  |     _history_list = history.get_full_significant_states_with_session(\r\nhomeassistant  |         hass,\r\nhomeassistant  |     ...<3 lines>...\r\nhomeassistant  |         entity_ids=entities_significant_history,\r\nhomeassistant  |     )\r\nhomeassistant  |   File \"/usr/src/homeassistant/homeassistant/components/recorder/history/__init__.py\", line 55, in get_full_significant_states_with_session\r\nhomeassistant  |     return _target(\r\nhomeassistant  |         hass,\r\nhomeassistant  |     ...<7 lines>...\r\nhomeassistant  |         no_attributes,\r\nhomeassistant  |     )\r\nhomeassistant  |   File \"/usr/src/homeassistant/homeassistant/components/recorder/history/modern.py\", line 306, in get_full_significant_states_with_session\r\nhomeassistant  |     get_significant_states_with_session(\r\nhomeassistant  |     ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^\r\nhomeassistant  |         hass=hass,\r\nhomeassistant  |         ^^^^^^^^^^\r\nhomeassistant  |     ...<8 lines>...\r\nhomeassistant  |         no_attributes=no_attributes,\r\nhomeassistant  |         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\nhomeassistant  |     ),\r\nhomeassistant  |     ^\r\nhomeassistant  |   File \"/usr/src/homeassistant/homeassistant/components/recorder/history/modern.py\", line 278, in get_significant_states_with_session\r\nhomeassistant  |     execute_stmt_lambda_element(session, stmt, None, end_time, orm_rows=False),\r\nhomeassistant  |     ~~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\nhomeassistant  |   File \"/usr/src/homeassistant/homeassistant/components/recorder/util.py\", line 197, in execute_stmt_lambda_element\r\nhomeassistant  |     executed = session.connection().execute(stmt)\r\nhomeassistant  |   File \"/usr/local/lib/python3.13/site-packages/sqlalchemy/engine/base.py\", line 1418, in execute\r\nhomeassistant  |     return meth(\r\nhomeassistant  |         self,\r\nhomeassistant  |         distilled_parameters,\r\nhomeassistant  |         execution_options or NO_OPTIONS,\r\nhomeassistant  |     )\r\nhomeassistant  |   File \"/usr/local/lib/python3.13/site-packages/sqlalchemy/sql/lambdas.py\", line 603, in _execute_on_connection\r\nhomeassistant  |     return connection._execute_clauseelement(\r\nhomeassistant  |            ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^\r\nhomeassistant  |         self, distilled_params, execution_options\r\nhomeassistant  |         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\nhomeassistant  |     )\r\nhomeassistant  |     ^\r\nhomeassistant  |   File \"/usr/local/lib/python3.13/site-packages/sqlalchemy/engine/base.py\", line 1640, in _execute_clauseelement\r\nhomeassistant  |     ret = self._execute_context(\r\nhomeassistant  |         dialect,\r\nhomeassistant  |     ...<8 lines>...\r\nhomeassistant  |         cache_hit=cache_hit,\r\nhomeassistant  |     )\r\nhomeassistant  |   File \"/usr/local/lib/python3.13/site-packages/sqlalchemy/engine/base.py\", line 1813, in _execute_context\r\nhomeassistant  |     conn = self._revalidate_connection()\r\nhomeassistant  |   File \"/usr/local/lib/python3.13/site-packages/sqlalchemy/engine/base.py\", line 677, in _revalidate_connection\r\nhomeassistant  |     self._invalid_transaction()\r\nhomeassistant  |     ~~~~~~~~~~~~~~~~~~~~~~~~~^^\r\nhomeassistant  |   File \"/usr/local/lib/python3.13/site-packages/sqlalchemy/engine/base.py\", line 667, in _invalid_transaction\r\nhomeassistant  |     raise exc.PendingRollbackError(\r\nhomeassistant  |     ...<4 lines>...\r\nhomeassistant  |     )\r\nhomeassistant  | sqlalchemy.exc.PendingRollbackError: Can't reconnect until invalid transaction is rolled back.  Please rollback() fully before proceeding (Background on this error at: https://sqlalche.me/e/20/8s2b)\r\n```\n> I'm traveling this week so I can't take a look at the moment.\r\n> \r\n> If you post some explains of those it might give a clue about why its selecting so many rows\r\n> \r\n> https://dev.mysql.com/doc/refman/8.4/en/explain.html\r\n\r\nNP!  Just vomiting up info hope to help get it resolved :D \n```+------+-------------+------------------+--------+-----------------------------------------------------------------+---------------------------------------+---------+-------------------------------------------------------+---------+------------------------------------+\r\n| id   | select_type | table            | type   | possible_keys                                                   | key                                   | key_len | ref                                                   | rows    | Extra                              |\r\n+------+-------------+------------------+--------+-----------------------------------------------------------------+---------------------------------------+---------+-------------------------------------------------------+---------+------------------------------------+\r\n|    1 | PRIMARY     | <derived2>       | ALL    | NULL                                                            | NULL                                  | NULL    | NULL                                                  | 5245201 | Using filesort                     |\r\n|    2 | DERIVED     | <derived8>       | ALL    | distinct_key                                                    | NULL                                  | NULL    | NULL                                                  | 1395    |                                    |\r\n|    2 | DERIVED     | states           | ref    | ix_states_last_updated_ts,ix_states_metadata_id_last_updated_ts | ix_states_metadata_id_last_updated_ts | 9       | tvc_0._col_1                                          | 376     | Using index condition              |\r\n|    2 | DERIVED     | state_attributes | eq_ref | PRIMARY                                                         | PRIMARY                               | 8       | ha_db.states.attributes_id                            | 1       | Using where                        |\r\n|    2 | DERIVED     | <derived4>       | ref    | key0                                                            | key0                                  | 18      | ha_db.states.metadata_id,ha_db.states.last_updated_ts | 10      |                                    |\r\n|    8 | DERIVED     | NULL             | NULL   | NULL                                                            | NULL                                  | NULL    | NULL                                                  | NULL    | No tables used                     |\r\n|    4 | DERIVED     | <derived10>      | ALL    | distinct_key                                                    | NULL                                  | NULL    | NULL                                                  | 1395    | Using temporary; Using filesort    |\r\n|    4 | DERIVED     | states           | ref    | ix_states_last_updated_ts,ix_states_metadata_id_last_updated_ts | ix_states_metadata_id_last_updated_ts | 9       | tvc_0._col_1                                          | 376     | Using where; Using index           |\r\n|   10 | DERIVED     | NULL             | NULL   | NULL                                                            | NULL                                  | NULL    | NULL                                                  | NULL    | No tables used                     |\r\n|    5 | UNION       | states           | range  | ix_states_last_updated_ts,ix_states_metadata_id_last_updated_ts | ix_states_last_updated_ts             | 9       | NULL                                                  | 1       | Using index condition; Using where |\r\n|    5 | UNION       | state_attributes | eq_ref | PRIMARY                                                         | PRIMARY                               | 8       | ha_db.states.attributes_id                            | 1       | Using where                        |\r\n|    5 | UNION       | <derived12>      | eq_ref | distinct_key                                                    | distinct_key                          | 4       | ha_db.states.metadata_id                              | 1       | Using where                        |\r\n|   12 | DERIVED     | NULL             | NULL   | NULL                                                            | NULL                                  | NULL    | NULL                                                  | NULL    | No tables used                     |\r\n+------+-------------+------------------+--------+-----------------------------------------------------------------+---------------------------------------+---------+-------------------------------------------------------+---------+------------------------------------+\r\n```\nI have the same problem on 2024.12.2. [https://community.home-assistant.io/t/creating-sort-index-on-mariadb-and-statistics-not-updating/808387/2](url). I've been stuck for 24 hours now on a 24gb database. Almost like the case after the 2024.8 database upgrade snafoo.\r\nSo massive bump on this.\nSame problem here. Postgresql is getting choked by these SELECTs. Seems to have started with 2024.12.\r\n\r\n```\r\n~$ psql -A -c 'select * from pg_stat_activity ;'\r\ndatid|datname|pid|leader_pid|usesysid|usename|application_name|client_addr|client_hostname|client_port|backend_start|xact_start|query_start|state_change|wait_event_type|wait_event|state|backend_xid|backend_xmin|query_id|query|backend_type\r\n\r\n16597|hass|2698008||16386|hass||127.0.0.1||38968|2024-12-11 12:19:22.602254+00|2024-12-11 12:20:33.796924+00|2024-12-11 12:20:33.822763+00|2024-12-11 12:20:33.822765+00|IO|DataFileRead|active||49508101||SELECT anon_1.metadata_id, anon_1.state, anon_1.last_updated_ts, anon_1.last_changed_ts, anon_1.attributes \r\nFROM (SELECT anon_2.metadata_id AS metadata_id, anon_2.state AS state, anon_2.last_updated_ts AS last_updated_ts, anon_2.last_changed_ts AS last_changed_ts, anon_2.attributes AS attributes \r\nFROM (SELECT states.metadata_id AS metadata_id, states.state AS state, 0 AS last_updated_ts, 0 AS last_changed_ts, CASE WHEN (state_attributes.shared_attrs IS NULL) THEN states.attributes ELSE state_attributes.shared_attrs END AS attributes \r\nFROM states JOIN (SELECT states.metadata_id AS max_metadata_id, max(states.last_updated_ts) AS max_last_updated \r\nFROM states \r\nWHERE states.last_updated_ts >= 1668568337.475832 AND states.last_updated_ts < 1733899499.999999 AND states.metadata_id IN (2169, 2170, 485, 661, 672, 673, 753, 754, 755, 756, 759, 450, 463, 483, 2003, 2004, 2007, 2008, 2009, 2000, 2001, 1968, 627, 569, 570, 571, 572, 573, 574, 591, 592, 593, 634, 643, 1559, 1537, 1546, 1741, 1742, 1743, 1745, 1751, 1753, 1756, 1757, 1758, 1759, 1760, 1761, 421, 2, 7, 20, 12, 2118, 2120, 2135, 2137, 494, 502, 511, 549, 554, 561, 566, 929, 935, 1313, 1314, 1315, 608) GROUP BY states.metadata_id) AS anon_3 ON states.metadata_id = anon_3.max_metadata_id AND states.last_updated_ts = anon_3.max_last_updated LEFT OUTER JOIN state_attributes ON states.attributes_id = state_attributes.attributes_id \r\nWHERE states.last_updated_ts >= 1668568337.475832 AND states.last_updated_ts < 1733899499.999999 AND states.metadata_id IN (2169, 2170, 485, 661, 672, 673, 753, 754, 755, 756, 759, 450, 463, 483, 2003, 2004, 2007, 2008, 2009, 2000, 2001, 1968, 627, 569, 570, 571, 572, 573, 574, 591, 592, 593, 634, 643, 1559, 1537, 1546, 1741, 1742, 1743, 1745, 1751, 1753, 1756, 1757, 1758, 1759, 1760, 1761, 421, 2, 7, 20, 12, 2118, 2120, 2135, 2137, 494, 502, 511, 549, 554, 561, 566, 929, 935, 1313, 1314, 1315, 608)) AS anon_2 UNION ALL SELECT anon_4.metadata_id AS metadata_id, anon_4.state AS state, anon_4.last_updated_ts AS last_updated_ts, anon_4.last_changed_ts AS last_changed_ts, anon_4.attributes AS attributes \r\nFROM (SELECT states.metadata_id AS metadata_id, states.state AS state, states.last_updated_ts AS last_updated_ts, states.last_changed_ts AS last_changed_ts, CASE WHEN (state_attributes.shared_attrs IS NULL) THEN states.attributes ELSE state_attributes.shared_attrs END AS attributes \r\nFROM states LEFT OUTER JOIN state_attributes ON states.attributes_id = state_attributes.attributes_id \r\nWHERE states.metadata_id IN (2169, 2170, 485, 661, 672, 673, 753, 754, 755, 756, 759, 450, 463, 483, 2003, 2004, 2007, 2008, 2009, 2000, 2001, 1968, 627, 569, 570, 571, 572, 573, 574, 591, 592, 593, 634, 643, 1559, 1537, 1546, 1741, 1742, 1743, 1745, 1751, 1753, 1756, 1757, 1758, 1759, 1760, 1761, 421, 2, 7, 20, 12, 2118, 2120, 2135, 2137, 494, 502, 511, 549, 554, 561, 566, 929, 935, 1313, 1314, 1315, 608) AND states.last_updated_ts > 1733899499.999999 AND states.last_updated_ts < 1733899800.0) AS anon_4) AS anon_1 ORDER BY anon_1.metadata_id, anon_1.last_updated_ts|client backend`\r\n```\r\n\r\nHere's an explain analyze from Postgres:\r\n                                                               \r\n> QUERY PLAN                                                                                                                                                                                                                                                                        \r\n> ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------\r\n\r\n>  Sort  (cost=7294986.81..7294986.83 rows=9 width=572) (actual time=106296.257..111217.361 rows=395 loops=1)\r\n>    Sort Key: \"*SELECT* 1\".metadata_id, ((0)::double precision)\r\n>    Sort Method: quicksort  Memory: 110kB\r\n>    ->  Append  (cost=7292978.19..7294986.67 rows=9 width=572) (actual time=106294.162..111217.134 rows=395 loops=1)\r\n>          ->  Subquery Scan on \"*SELECT* 1\"  (cost=7292978.19..7294844.21 rows=1 width=62) (actual time=106294.162..111215.900 rows=71 loops=1)\r\n>                ->  Nested Loop Left Join  (cost=7292978.19..7294844.19 rows=1 width=54) (actual time=106294.159..111215.890 rows=71 loops=1)\r\n>                      ->  Nested Loop  (cost=7292977.76..7294836.80 rows=1 width=54) (actual time=106293.475..111214.851 rows=71 loops=1)\r\n>                            ->  Finalize GroupAggregate  (cost=7292977.01..7293078.80 rows=200 width=16) (actual time=106293.425..111214.607 rows=71 loops=1)\r\n>                                  Group Key: states_1.metadata_id\r\n>                                  ->  Gather Merge  (cost=7292977.01..7293072.80 rows=800 width=16) (actual time=106293.394..111214.544 rows=355 loops=1)\r\n>                                        Workers Planned: 4\r\n>                                        Workers Launched: 4\r\n>                                        ->  Sort  (cost=7291976.95..7291977.45 rows=200 width=16) (actual time=106190.916..106190.923 rows=71 loops=5)\r\n>                                              Sort Key: states_1.metadata_id\r\n>                                              Sort Method: quicksort  Memory: 27kB\r\n>                                              Worker 0:  Sort Method: quicksort  Memory: 27kB\r\n>                                              Worker 1:  Sort Method: quicksort  Memory: 27kB\r\n>                                              Worker 2:  Sort Method: quicksort  Memory: 27kB\r\n>                                              Worker 3:  Sort Method: quicksort  Memory: 27kB\r\n>                                              ->  Partial HashAggregate  (cost=7291967.31..7291969.31 rows=200 width=16) (actual time=106190.844..106190.859 rows=71 loops=5)\r\n>                                                    Group Key: states_1.metadata_id\r\n>                                                    Batches: 1  Memory Usage: 40kB\r\n>                                                    Worker 0:  Batches: 1  Memory Usage: 40kB\r\n>                                                    Worker 1:  Batches: 1  Memory Usage: 40kB\r\n>                                                    Worker 2:  Batches: 1  Memory Usage: 40kB\r\n>                                                    Worker 3:  Batches: 1  Memory Usage: 40kB\r\n>                                                    ->  Parallel Seq Scan on states states_1  (cost=0.18..7147716.66 rows=28850129 width=16) (actual time=464.436..104908.228 rows=6480979 loops=5)\r\n>                                                          Filter: ((last_updated_ts >= '1668568337.475832'::double precision) AND (last_updated_ts < '1733899499.999999'::double precision) AND (metadata_id = ANY ('{2169,2170,485,661,672,673,753,754,755,756,759,450,463,483,2003,2004,2007,2008,2009,2000,2001,1968,627,569,570,571,572,573,574,591,592,593,634,643,1559,1537,1546,1741,1742,1743,1745,1751,1753,1756,1757,1758,1759,1760,1761,421,2,7,20,12,2118,2120,2135,2137,494,502,511,549,554,561,566,929,935,1313,1314,1315,608}'::bigint[])))\r\n>                                                          Rows Removed by Filter: 64233791\r\n>                            ->  Index Scan using ix_states_last_updated_ts on states  (cost=0.75..8.78 rows=1 width=62) (actual time=0.003..0.003 rows=1 loops=71)\r\n>                                  Index Cond: ((last_updated_ts = (max(states_1.last_updated_ts))) AND (last_updated_ts >= '1668568337.475832'::double precision) AND (last_updated_ts < '1733899499.999999'::double precision))\r\n>                                  Filter: ((metadata_id = states_1.metadata_id) AND (metadata_id = ANY ('{2169,2170,485,661,672,673,753,754,755,756,759,450,463,483,2003,2004,2007,2008,2009,2000,2001,1968,627,569,570,571,572,573,574,591,592,593,634,643,1559,1537,1546,1741,1742,1743,1745,1751,1753,1756,1757,1758,1759,1760,1761,421,2,7,20,12,2118,2120,2135,2137,494,502,511,549,554,561,566,929,935,1313,1314,1315,608}'::bigint[])))\r\n>                      ->  Index Scan using state_attributes_pkey on state_attributes  (cost=0.43..7.39 rows=1 width=255) (actual time=0.014..0.014 rows=1 loops=71)\r\n>                            Index Cond: (attributes_id = states.attributes_id)\r\n>          ->  Nested Loop Left Join  (cost=1.19..142.42 rows=8 width=62) (actual time=0.028..1.209 rows=324 loops=1)\r\n>                ->  Index Scan using ix_states_last_updated_ts on states states_2  (cost=0.75..74.80 rows=8 width=70) (actual time=0.018..0.737 rows=324 loops=1)\r\n>                      Index Cond: ((last_updated_ts > '1733899499.999999'::double precision) AND (last_updated_ts < '1733899800'::double precision))\r\n>                      Filter: (metadata_id = ANY ('{2169,2170,485,661,672,673,753,754,755,756,759,450,463,483,2003,2004,2007,2008,2009,2000,2001,1968,627,569,570,571,572,573,574,591,592,593,634,643,1559,1537,1546,1741,1742,1743,1745,1751,1753,1756,1757,1758,1759,1760,1761,421,2,7,20,12,2118,2120,2135,2137,494,502,511,549,554,561,566,929,935,1313,1314,1315,608}'::bigint[]))\r\n>                      Rows Removed by Filter: 1713\r\n>                ->  Index Scan using state_attributes_pkey on state_attributes state_attributes_1  (cost=0.43..8.45 rows=1 width=255) (actual time=0.001..0.001 rows=1 loops=324)\r\n>                      Index Cond: (attributes_id = states_2.attributes_id)\r\n>  Planning Time: 0.777 ms\r\n>  JIT:\r\n>    Functions: 71\r\n>    Options: Inlining true, Optimization true, Expressions true, Deforming true\r\n>    Timing: Generation 12.758 ms, Inlining 441.125 ms, Optimization 1096.428 ms, Emission 632.528 ms, Total 2182.839 ms\r\n>  Execution Time: 111219.685 ms\r\n> (47 rows)\r\n> \r\n\nas a stop gap i've added `max_statement_time = 600` to my mariadb.conf.  Kills any query running for more than 10m.  Not great, but appears to unblock things.\r\n\r\nThe pattern is interesting, every 30min is when it gets stuck.\r\n\r\n```root@donnager:~# hadc logs homeassistant | egrep \"Error executing compile statistics\"\r\nhomeassistant  | 2024-12-11 01:01:47.496 WARNING (Recorder) [homeassistant.components.recorder.util] Error executing compile statistics: (MySQLdb.OperationalError) (1969, 'Query execution was interrupted (max_statement_time exceeded)')\r\nhomeassistant  | 2024-12-11 01:31:52.475 WARNING (Recorder) [homeassistant.components.recorder.util] Error executing compile statistics: (MySQLdb.OperationalError) (1969, 'Query execution was interrupted (max_statement_time exceeded)')\r\nhomeassistant  | 2024-12-11 02:01:58.216 WARNING (Recorder) [homeassistant.components.recorder.util] Error executing compile statistics: (MySQLdb.OperationalError) (1969, 'Query execution was interrupted (max_statement_time exceeded)')\r\nhomeassistant  | 2024-12-11 02:32:05.135 WARNING (Recorder) [homeassistant.components.recorder.util] Error executing compile statistics: (MySQLdb.OperationalError) (1969, 'Query execution was interrupted (max_statement_time exceeded)')\r\nhomeassistant  | 2024-12-11 03:02:11.138 WARNING (Recorder) [homeassistant.components.recorder.util] Error executing compile statistics: (MySQLdb.OperationalError) (1969, 'Query execution was interrupted (max_statement_time exceeded)')\r\nhomeassistant  | 2024-12-11 03:32:16.489 WARNING (Recorder) [homeassistant.components.recorder.util] Error executing compile statistics: (MySQLdb.OperationalError) (1969, 'Query execution was interrupted (max_statement_time exceeded)')\r\nhomeassistant  | 2024-12-11 04:02:22.932 WARNING (Recorder) [homeassistant.components.recorder.util] Error executing compile statistics: (MySQLdb.OperationalError) (1969, 'Query execution was interrupted (max_statement_time exceeded)')\r\nhomeassistant  | 2024-12-11 04:32:29.468 WARNING (Recorder) [homeassistant.components.recorder.util] Error executing compile statistics: (MySQLdb.OperationalError) (1969, 'Query execution was interrupted (max_statement_time exceeded)')\r\nhomeassistant  | 2024-12-11 05:02:38.035 WARNING (Recorder) [homeassistant.components.recorder.util] Error executing compile statistics: (MySQLdb.OperationalError) (1969, 'Query execution was interrupted (max_statement_time exceeded)')\r\nhomeassistant  | 2024-12-11 05:32:43.452 WARNING (Recorder) [homeassistant.components.recorder.util] Error executing compile statistics: (MySQLdb.OperationalError) (1969, 'Query execution was interrupted (max_statement_time exceeded)')\r\nhomeassistant  | 2024-12-11 06:02:52.965 WARNING (Recorder) [homeassistant.components.recorder.util] Error executing compile statistics: (MySQLdb.OperationalError) (1969, 'Query execution was interrupted (max_statement_time exceeded)')\r\nhomeassistant  | 2024-12-11 06:32:58.990 WARNING (Recorder) [homeassistant.components.recorder.util] Error executing compile statistics: (MySQLdb.OperationalError) (1969, 'Query execution was interrupted (max_statement_time exceeded)')\r\nhomeassistant  | 2024-12-11 07:03:09.276 WARNING (Recorder) [homeassistant.components.recorder.util] Error executing compile statistics: (MySQLdb.OperationalError) (1969, 'Query execution was interrupted (max_statement_time exceeded)')\r\nhomeassistant  | 2024-12-11 07:33:14.342 WARNING (Recorder) [homeassistant.components.recorder.util] Error executing compile statistics: (MySQLdb.OperationalError) (1969, 'Query execution was interrupted (max_statement_time exceeded)')\r\nhomeassistant  | 2024-12-11 08:03:20.446 WARNING (Recorder) [homeassistant.components.recorder.util] Error executing compile statistics: (MySQLdb.OperationalError) (1969, 'Query execution was interrupted (max_statement_time exceeded)')\r\nhomeassistant  | 2024-12-11 08:33:26.123 WARNING (Recorder) [homeassistant.components.recorder.util] Error executing compile statistics: (MySQLdb.OperationalError) (1969, 'Query execution was interrupted (max_statement_time exceeded)')\r\nhomeassistant  | 2024-12-11 09:03:35.520 WARNING (Recorder) [homeassistant.components.recorder.util] Error executing compile statistics: (MySQLdb.OperationalError) (1969, 'Query execution was interrupted (max_statement_time exceeded)')\r\nhomeassistant  | 2024-12-11 09:33:46.294 WARNING (Recorder) [homeassistant.components.recorder.util] Error executing compile statistics: (MySQLdb.OperationalError) (1969, 'Query execution was interrupted (max_statement_time exceeded)')\r\nhomeassistant  | 2024-12-11 10:03:57.440 WARNING (Recorder) [homeassistant.components.recorder.util] Error executing compile statistics: (MySQLdb.OperationalError) (1969, 'Query execution was interrupted (max_statement_time exceeded)')\r\nhomeassistant  | 2024-12-11 10:34:09.224 WARNING (Recorder) [homeassistant.components.recorder.util] Error executing compile statistics: (MySQLdb.OperationalError) (1969, 'Query execution was interrupted (max_statement_time exceeded)')\r\nroot@donnager:~# hadc logs homeassistant | egrep \"Error executing compile statistics\" | wc -l\r\n20\r\n```\nI'm gonna try this MariaDB setting. Fun thing, when I killed the long-running create index process sort of pushes all missing grafs, one after one they fill upp with data. Energy though is completely broken, it seems to have tried to summarize mny consumtion this year into one bar.\nCan you pls advice, where to find this DB setting?\r\nI think i got the same issue, RPi5 nvme drive and latest HA version\nSame issue here since the update, 150G postgres database. Its doing something heavy over and over and over again.\r\n![Screenshot 2024-12-12 at 11 32 55](https://github.com/user-attachments/assets/dd3eca68-8fe3-4b2d-809b-0940755eac12)\r\n\n> Can you pls advice, where to find this DB setting? I think i got the same issue, RPi5 nvme drive and latest HA version\r\n\r\nI my case I run MariaDB and use phpMyAdmin as management. The max statement time setting can be found under Variables. \r\n![image](https://github.com/user-attachments/assets/f39f175b-cebe-4747-8163-ab1140bd2d97)\r\n\r\nSetting this to 600 seems to have stopped the long running \"Creat Sort Index\" tasks for me but the task soon restarts and statistics aren't getting updated at the moment.\r\n\nI think what happened is that the query to find the start time state is now selecting a significantly larger time block after the bug fix in #131702.  The problem is that the query to get the func.max can only be optimized away to use the index with MySQL or PostgreSQL when it\u2019s a selecting a single value/entity. With the larger time window it has to potentially look at millions of rows.\n\nWe might be able to better optimize that query by doing recursive query for the start time state instead.  Unfortunately I don\u2019t thin it will be a simple fix as it will take a long time to work out query that performs well with all supported database engines.\n\nI\u2019ll need an sql dump of an affected postgresql and MySQL database along with a log of the slow query to be able to tune each one\r\n\r\nIf anyone is willing to share my gdrive is bdraco@gmail.com or my Dropbox is nick@koston.org\n> I\u2019ll need an sql dump of an affected postgresql and MySQL database along with a log of the slow query to be able to tune each one\r\n> \r\n> If anyone is willing to share my gdrive is [bdraco@gmail.com](mailto:bdraco@gmail.com) or my Dropbox is [nick@koston.org](mailto:nick@koston.org)\r\n\r\nI can assist with whatever can aid in a solution. As things stand right now I'm lacking core HA functionality.\r\nI'm exporting the database right now but I'm unsure how to \"log the query\". Do you need the select command that is running?\n> > I\u2019ll need an sql dump of an affected postgresql and MySQL database along with a log of the slow query to be able to tune each one\n> \n> > \n> \n> > If anyone is willing to share my gdrive is [bdraco@gmail.com](mailto:bdraco@gmail.com) or my Dropbox is [nick@koston.org](mailto:nick@koston.org)\n> \n> \n> \n> I can assist with whatever can aid in a solution. As things stand right now I'm lacking core HA functionality.\n> \n> I'm exporting the database right now but I'm unsure how to \"log the query\". Do you need the select command that is running?\n\nYes the select command is the query I'm looking for \n> > > I\u2019ll need an sql dump of an affected postgresql and MySQL database along with a log of the slow query to be able to tune each one\r\n> > \r\n> > \r\n> > > \r\n> > \r\n> > \r\n> > > If anyone is willing to share my gdrive is [bdraco@gmail.com](mailto:bdraco@gmail.com) or my Dropbox is [nick@koston.org](mailto:nick@koston.org)\r\n> > \r\n> > \r\n> > I can assist with whatever can aid in a solution. As things stand right now I'm lacking core HA functionality.\r\n> > I'm exporting the database right now but I'm unsure how to \"log the query\". Do you need the select command that is running?\r\n> \r\n> Yes the select command is the query I'm looking for\r\n\r\nSELECT anon_1.metadata_id, anon_1.state, anon_1.last_updated_ts, anon_1.attributes FROM (SELECT anon_2.metadata_id AS metadata_id, anon_2.state AS state, anon_2.last_updated_ts AS last_updated_ts, anon_2.attributes AS attributes FROM (SELECT states.metadata_id AS metadata_id, states.state AS state, 0 AS last_updated_ts, CASE WHEN (state_attributes.shared_attrs IS NULL) THEN states.attributes ELSE state_attributes.shared_attrs END AS attributes FROM states INNER JOIN (SELECT states.metadata_id AS max_metadata_id, max(states.last_updated_ts) AS max_last_updated FROM states WHERE states.last_updated_ts >= 1731219794.579708e0 AND states.last_updated_ts < 1733999399.999999e0 AND states.metadata_id IN (301, 6280, 7616, 10297, 11317, 11738, 11745, 488, 492, 493, 83, 6499, 7871, 10571, 496, 314, 6487, 14138, 6574, 10650, 64, 336, 338, 40, 43, 339, 2027, 2021, 8732, 340, 7868, 7939, 345, 346, 347, 348, 1424, 351, 8507, 14, 354, 2090, 8679, 13989, 1581, 6316, 355, 2, 10555, 81, 337, 1186, 6414, 6227, 344, 87, 353, 357, 358, 1457, 1197, 1844, 6366, 6472, 1381, 7875, 8390, 10330, 10688, 12065, 12170, 13611, 343, 6488, 14139, 6575, 10651, 53, 359, 361, 75, 55, 362, 2028, 2022, 8733, 363, 7869, 7940, 368, 369, 370, 371, 1425, 374, 8508, 33, 377, 2091, 8680, 13990, 1582, 6317, 378, 80, 10556, 20, 360, 1187, 6415, 6228, 367, 56, 376, 380, 381, 1456, 1198, 1845, 6367, 6473, 1365, 7876, 8391, 10331, 10689, 12066, 12171, 13612, 366, 6241, 6242, 6243, 8436, 8437, 8438, 10541, 8467, 8439, 8440, 8441, 10542, 8468, 421, 422, 423, 7595, 2264, 2266, 2289, 2290, 2291, 2292, 2293, 2294, 2295, 2075, 2238, 7926, 7928, 6468, 6470, 417, 419, 8682, 12153, 12154, 14120, 14121, 14556, 15815, 15816, 15823, 15824, 16037, 16038, 14150, 14151, 14826, 14827, 16208, 16209, 16210, 16211, 16212, 16201, 16222, 16202, 16203, 16204, 16205, 16206, 16207, 16217, 16218, 16219, 16220, 16221, 16225, 16226, 16227, 16228, 16229, 16563, 16564, 16565, 16566, 16567, 13981, 13669, 13677, 13668, 7246, 7245, 7247, 7243, 16271, 16272, 16273, 16270, 16028, 16029, 16027, 16031, 16032, 16030, 16233, 16234, 16232, 16267, 16268, 16269, 16266, 16236, 16237, 16238, 16235, 15905, 15906, 14919, 15904, 15879, 15880, 15884, 15924, 15878, 15881, 15883, 15882, 15885, 16069, 792, 16070, 791, 15961, 15962, 15963, 15960, 16042, 12682, 16043, 757, 16044, 16045, 16055, 6236, 16056, 16072, 16067, 748, 16068, 746, 13889, 11350, 13890, 11351, 16061, 749, 16062, 747, 7143, 7142, 775, 774, 776, 10267, 10268, 10269, 10264, 10311, 10265, 10266, 10270, 10271, 10272, 8420, 8422, 8421, 6630, 6631, 6632, 6633, 6634, 16263, 1799, 882, 884, 885, 883, 874, 8172, 7877, 7494, 16533, 16538, 16535, 16536, 16537, 16511, 16512, 1995, 1997, 10370, 7900, 666, 668, 664, 658, 670, 674, 672, 680, 11374, 688, 692, 712, 708, 706, 694, 710, 655, 716, 700, 662, 676, 660, 698, 656, 6304, 8600, 8602, 13833, 10014, 16494, 16496, 6392, 6398, 6308, 11358, 11256, 888, 11141, 2097, 2095, 2098, 2105, 2104, 1042, 1043, 1044, 724, 722, 1064, 1116, 1118, 1120, 342, 365, 356, 379, 341, 364, 78, 34, 350, 373, 1448, 1447, 1528, 1524, 1526, 1523, 1879, 1880, 1537, 1539, 1906, 1907, 1350, 1301, 1061, 1543, 1544, 1972, 1974, 1556, 1545, 1983, 2020, 1559, 1546, 1549, 1551, 1547, 1554, 1555, 1552, 1564, 1565, 1250, 1346, 349, 372, 1709, 1708, 1740, 1739, 1750, 1751, 2083, 2084, 2085, 2086, 2087, 2088, 6412, 6413, 6486, 6518, 6519, 6520, 6521, 6524, 6525, 6530, 6531, 6576, 6577, 6642, 6643, 6644, 6645, 1226, 1213, 6652, 6653, 6656, 6657, 6664, 6665, 6666, 6667, 6673, 6674, 6679, 6680, 6721, 6722, 6750, 6751, 6752, 6753, 6767, 6768, 6841, 6842, 6853, 6854, 6856, 6857, 6858, 6859, 6860, 6861, 6862, 6863, 6877, 6878, 6962, 6963, 7026, 7027, 7065, 7066, 7091, 7092, 7112, 7113, 7411, 7412, 7564, 7565, 7793, 7794, 7795, 7796, 7812, 7813, 7837, 7838, 7839, 7840, 7841, 7842, 7843, 7844, 7846, 7847, 7854, 7855, 7864, 7865, 8023, 8042, 8043, 8070, 8071, 8081, 8082, 8118, 8119, 8221, 8222, 8226, 8227, 8241, 8242, 8262, 8263, 8264, 8265, 8275, 8276, 8337, 8338, 8382, 8383, 8442, 8443, 8454, 8455, 8721, 8722, 8728, 8729, 10133, 10134, 10135, 10136, 10137, 10138, 10143, 10144, 10201, 10202, 10324, 10325, 10366, 10367, 10382, 10383, 10505, 10506, 10507, 10508, 10511, 10512, 10514, 10515, 10516, 10517, 10530, 10531, 10558, 10559, 10560, 10561, 10575, 10576, 10598, 10599, 10657, 10658, 10659, 10660, 1748, 1747, 11399, 11400, 11985, 11986, 11992, 11993, 11994, 11995, 11996, 11997, 12014, 12015, 12016, 12017, 12095, 12096, 12097, 12098, 12099, 12100, 11837, 11838, 11839, 11840, 11841, 11842, 12107, 12108, 12109, 12110, 12111, 12112, 12141, 12142, 12143, 12144, 12145, 12146, 12149, 12150, 12151, 12175, 12176, 12177, 12178, 12181, 12182, 12135, 12136, 12137, 12138, 12139, 12140, 11425, 11426, 11427, 11428, 11429, 12587, 12588, 12609, 12610, 12611, 12612, 12613, 12614, 12615, 12616, 12626, 12627, 12628, 12629, 12630, 12631, 12632, 12633, 12634, 12635, 12636, 12637, 12639, 12640, 12641, 12642, 12643, 12644, 10967, 10968, 10969, 10970, 10971, 10972, 12645, 12646, 12647, 12648, 12649, 12650, 12651, 12652, 12653, 12654, 12655, 12656, 12657, 12658, 12659, 12660, 12661, 12662, 10984, 10985, 10986, 10987, 10988, 10989, 12663, 12664, 12665, 12666, 12667, 12668, 10955, 10956, 10957, 10958, 10959, 10960, 10940, 10941, 10942, 10943, 10944, 10945, 12685, 12686, 12687, 12688, 12689, 12690, 12704, 12705, 12706, 12707, 12708, 12709, 12710, 12711, 12712, 12713, 12714, 12715, 12716, 12717, 12718, 12719, 12720, 12721, 12722, 12723, 12724, 12725, 12726, 12727, 12728, 12729, 12730, 12731, 12732, 12733, 12734, 12735, 12736, 12737, 12738, 12739, 11782, 11783, 11784, 11785, 11786, 11787, 11477, 11478, 11479, 11480, 11481, 11482, 12740, 12741, 12742, 12743, 12744, 12745, 12751, 12752, 12753, 12754, 12755, 12756, 12757, 12758, 12759, 12760, 12761, 12762, 12765, 12766, 12767, 12768, 12769, 11579, 11580, 11581, 11582, 11583, 11584, 12771, 12772, 12773, 12774, 12775, 12776, 12777, 12778, 12779, 12780, 12781, 12782, 12786, 12787, 12788, 12789, 12790, 12791, 11758, 11759, 11760, 11761, 11762, 11763, 12792, 12793, 12794, 12795, 12796, 12797, 11788, 11789, 11790, 11791, 11792, 11793, 10946, 10947, 10948, 10949, 10950, 10951, 12798, 12799, 12800, 12801, 12802, 12803, 12804, 12805, 12806, 12807, 12808, 12809, 12810, 12811, 12812, 12813, 12814, 12815, 12818, 12819, 12820, 12821, 12822, 12823, 12835, 12836, 12837, 12838, 12839, 12840, 12846, 12847, 12155, 12156, 12157, 12158, 12159, 12848, 12849, 12850, 12851, 12852, 12853, 12854, 12855, 12857, 12858, 12859, 12860, 12861, 12862, 12863, 12864, 12865, 12866, 12867, 12868, 12869, 12870, 12871, 12872, 12873, 12874, 12875, 12876, 12877, 12878, 12879, 12880, 12881, 12882, 12883, 12884, 12885, 12886, 12887, 12888, 12889, 12890, 12891, 12892, 12894, 12895, 12896, 12897, 12898, 12899, 12906, 12907, 12908, 12909, 12910, 12911, 12915, 12916, 12917, 12918, 12919, 12920, 12921, 12922, 12923, 12924, 12925, 12926, 12931, 12932, 12933, 12934, 12935, 12936, 12161, 12162, 12163, 12164, 12165, 12950, 12951, 12952, 12953, 12954, 12955, 12956, 12829, 12830, 12831, 12832, 12833, 12834, 12962, 12963, 12964, 12965, 12966, 12967, 12968, 12969, 12970, 12971, 12972, 12973, 12974, 12975, 12976, 12977, 12978, 12979, 10931, 10932, 10933, 10934, 10935, 10936, 12981, 12982, 12983, 12984, 12985, 12986, 12987, 12988, 12989, 12990, 12991, 12992, 10925, 10926, 10927, 10928, 10929, 10930, 12996, 12997, 12998, 12999, 13000, 13001, 13002, 13004, 13005, 13006, 13007, 13008, 13009, 13010, 13011, 13012, 13013, 13014, 13015, 13016, 13017, 13018, 13019, 13020, 13021, 12022, 12023, 12024, 12025, 12026, 13030, 13031, 13032, 13033, 13034, 13035, 13037, 13038, 13039, 13040, 13041, 13042, 13043, 13044, 13045, 13046, 13047, 13048, 12669, 12670, 12671, 12672, 12673, 12674, 13053, 13054, 13055, 13056, 13057, 13058, 13070, 13071, 13072, 13073, 13074, 13075, 13089, 13090, 13091, 13092, 13093, 13094, 11847, 11848, 11849, 11850, 11851, 11852, 11752, 11753, 11754, 11755, 11756, 11757, 13115, 13116, 13117, 13118, 13119, 13120, 13121, 13122, 13123, 13124, 13125, 13126, 13127, 13128, 13129, 13130, 13131, 13132, 13133, 13134, 13135, 13136, 13137, 13138, 13139, 13140, 13141, 13142, 13143, 13144, 13145, 13146, 13147, 13148, 13149, 13150, 13153, 13154, 13155, 12089, 12090, 12091, 12092, 12093, 12094, 13162, 13163, 13164, 13165, 13166, 13167, 13170, 13171, 13172, 13173, 13174, 13175, 13177, 13178, 13179, 13180, 13181, 13182, 13184, 13185, 13186, 13187, 13188, 13189, 13191, 13192, 13193, 13194, 13195, 13196, 13222, 13223, 13224, 13225, 13226, 13227, 13239, 13240, 13241, 13242, 13243, 13253, 13254, 13255, 13256, 13257, 13258, 13264, 13265, 13266, 13267, 13268, 13269, 13270, 13271, 13272, 13273, 13274, 13275, 13277, 13278, 13279, 13280, 13281, 13282, 13288, 13289, 13290, 13291, 13292, 13293, 13299, 13300, 13301, 13302, 13303, 13304, 13305, 13306, 13307, 13308, 13309, 13310, 13312, 13313, 13314, 13315, 13316, 13317, 13323, 13324, 13325, 13326, 13327, 13328, 13337, 13338, 13339, 13340, 13341, 13342, 13343, 13344, 13345, 13346, 13347, 13348, 12101, 12102, 12103, 12104, 12105, 12106, 13351, 13352, 13353, 13354, 13355, 13356, 12038, 12039, 12040, 12041, 12042, 12043, 13373, 13374, 13375, 13376, 13377, 13378, 13379, 13380, 13381, 13382, 13383, 13384, 13385, 13386, 13387, 13388, 13389, 13390, 13391, 13392, 13393, 13394, 13395, 13396, 13397, 13398, 13399, 13400, 13401, 13403, 12047, 12048, 12049, 12050, 12051, 13584, 13585, 13586, 13587, 13588, 13589, 13590, 13591, 13592, 13593, 13594, 13077, 13078, 13079, 13080, 13082, 13083, 13084, 13085, 13086, 13087, 13620, 13621, 13622, 13623, 13624, 13625, 13626, 13627, 13628, 13629, 13630, 13631, 13632, 13633, 13634, 13635, 13636, 13637, 13638, 13639, 13640, 13641, 13642, 13643, 13644, 13645, 13646, 13647, 13648, 13649, 13650, 13651, 13652, 13653, 13654, 13655, 13656, 13657, 13708, 13709, 13710, 13711, 13712, 13735, 13736, 13737, 13738, 13739, 13740, 13741, 13742, 13743, 13749, 13750, 13751, 13752, 13753, 13754, 13755, 13756, 13757, 13758, 13759, 13760, 13762, 13763, 13764, 13793, 13794, 13799, 13816, 13817, 13840, 13841, 13846, 13863, 13864, 13869, 13870, 13871, 13872, 13873, 13874, 13884, 13885, 13886, 13887, 13905, 13906, 13907, 13908, 13909, 13910, 13915, 13916, 13917, 13918, 13919, 13921, 13922, 13923, 13924, 13925, 13928, 13929, 13930, 13931, 13932, 13933, 13935, 13936, 13939, 13940, 13944, 13945, 13946, 13947, 13948, 13949, 13950, 13951, 13953, 13954, 13955, 13956, 13957, 13958, 13959, 13960, 13961, 13962, 13963, 13964, 12675, 12676, 12677, 12678, 12679, 12680, 13966, 13967, 13968, 13969, 13970, 13998, 13999, 14000, 14001, 14003, 14004, 14005, 14006, 14007, 14008, 14011, 14012, 14013, 14014, 14015, 14016, 14018, 14019, 14020, 14021, 14022, 14023, 14024, 14025, 14026, 14027, 14028, 14037, 14038, 14039, 14040, 14041, 14042, 14043, 14044, 14045, 14046, 14047, 14048, 14049, 14055, 14056, 14057, 14058, 14062, 14063, 14064, 14065, 14066, 14067, 14068, 14069, 14070, 14071, 14072, 14073, 14074, 14075, 14076, 14077, 14078, 14079, 14080, 14081, 14082, 14083, 14084, 14085, 14086, 14087, 14088, 14089, 14090, 14091, 14093, 14094, 14095, 14096, 14097, 14098, 14099, 14100, 14101, 14102, 14111, 14112, 14142, 14143, 14144, 14145, 14152, 14153, 14154, 14155, 14156, 14157, 14158, 14159, 14161, 14162, 14163, 14164, 14165, 14166, 14167, 14168, 14169, 14170, 14171, 14172, 14175, 14176, 14177, 14178, 14181, 14182, 14183, 14184, 14185, 14186, 14187, 14188, 14189, 14190, 14191, 14192, 14193, 14194, 14201, 14202, 14203, 14204, 14206, 14207, 14208, 14209, 14210, 14211, 14212, 14213, 14214, 14215, 14216, 14217, 14218, 14219, 14220, 14221, 14222, 14223, 14225, 14226, 14227, 14228, 14229, 14230, 14235, 14236, 14237, 14238, 14239, 14244, 14245, 14246, 14247, 14248, 14249, 14250, 14251, 14252, 14253, 14254, 14255, 14258, 14259, 14260, 14263, 14264, 14265, 14266, 14267, 14268, 14271, 14272, 14273, 14274, 14276, 14277, 14278, 14279, 14280, 14281, 14282, 14283, 14284, 14285, 14286, 14287, 14288, 14289, 14290, 14291, 14292, 14293, 14294, 14295, 14296, 14297, 12681, 12683, 12684, 14300, 14301, 14302, 14303, 14304, 14305, 14307, 14308, 14309, 14322, 14323, 14324, 14325, 14326, 14327, 14328, 14329, 14330, 14331, 14332, 14333, 14345, 14346, 14347, 14348, 14349, 14350, 14351, 14352, 14353, 14354, 14355, 14356, 14357, 14358, 14359, 14360, 14361, 14362, 14363, 14364, 14365, 14366, 14367, 14375, 14376, 14377, 14378, 14379, 14380, 14381, 14382, 14383, 14384, 14385, 14386, 14387, 14388, 14389, 14390, 14395, 14396, 14397, 14398, 14399, 14400, 14401, 14403, 14404, 14405, 14406, 14407, 14408, 14410, 14411, 14412, 14414, 14415, 14416, 14417, 14418, 14419, 14420, 14421, 14422, 14423, 14424, 14425, 14426, 14427, 14428, 14429, 14430, 14431, 14432, 14433, 14434, 14435, 14436, 14437, 14438, 14439, 14441, 14442, 14443, 14444, 14445, 14446, 14447, 14448, 14449, 14450, 14451, 14452, 14453, 14454, 14455, 14456, 14457, 14458, 14462, 14463, 14464, 14465, 14466, 14467, 14469, 14470, 14471, 14472, 14473, 14474, 14475, 14476, 14477, 14478, 14479, 14480, 14481, 14482, 14483, 14484, 14485, 14486, 14487, 14488, 14489, 14490, 14496, 14497, 14498, 14499, 14500, 14506, 14507, 14508, 14509, 14510, 14511, 14513, 14514, 14515, 14516, 14517, 14518, 14519, 14520, 14521, 14545, 14546, 14551, 14552, 14553, 14554, 14561, 14562, 14563, 14564, 14580, 14581, 14593, 14594, 14595, 14596, 14597, 14598, 14599, 14600, 14601, 14602, 14603, 14604, 14605, 13744, 13745, 13746, 13747, 13748, 14606, 14607, 14608, 14609, 14610, 14611, 14620, 14621, 14622, 14623, 14624, 14630, 14629, 14632, 14633, 14631, 14638, 14639, 14640, 14641, 14642, 14643, 14646, 14647, 14648, 14649, 14650, 14651, 14652, 14653, 14654, 14655, 14656, 14657, 14658, 14659, 14660, 14661, 14662, 14663, 14664, 14665, 14666, 14667, 14668, 14669, 14670, 14671, 14672, 14673, 14674, 14675, 12824, 12825, 12826, 12827, 12828, 14677, 14678, 14679, 14680, 14681, 14682, 14683, 14684, 14685, 14686, 14687, 14688, 14689, 14691, 14692, 14693, 14695, 14696, 14697, 14698, 14699, 14700, 14701, 14702, 14704, 14705, 14706, 14708, 14709, 14710, 14711, 14712, 14713, 14714, 14715, 14716, 14717, 14718, 14719, 14720, 14721, 14722, 14723, 14724, 14725, 14726, 14727, 14728, 14729, 14730, 14731, 14732, 14733, 14734, 14735, 14736, 14737, 14738, 14739, 14740, 14741, 14742, 14743, 14744, 14745, 14746, 14747, 14748, 14749, 14750, 14751, 14752, 14753, 14754, 14755, 14756, 14757, 14758, 14759, 14760, 14761, 14762, 14763, 14764, 14765, 14766, 14767, 14768, 14769, 14770, 14771, 14772, 14773, 14774, 14775, 14776, 14777, 14778, 14779, 14780, 14781, 14782, 14783, 14784, 14785, 14786, 14787, 14788, 14789, 14790, 14791, 14792, 14793, 14794, 14795, 14797, 14798, 14799, 14801, 14802, 14803, 14804, 14805, 14806, 14807, 14808, 14810, 14811, 14812, 14813, 14814, 14815, 14817, 14818, 14819, 14820, 14821, 14822, 14832, 14833, 14834, 14835, 14836, 14837, 14838, 14839, 14840, 14841, 14842, 14843, 14845, 14846, 14847, 14853, 14854, 14855, 14856, 14857, 14858, 14861, 14862, 14863, 14864, 14865, 14867, 14868, 14869, 14870, 14871, 11979, 11980, 11981, 12029, 12030, 12031, 14885, 14886, 14887, 14888, 14889, 14890, 14891, 14892, 14893, 14894, 14895, 14897, 14898, 14899, 14900, 14901, 14903, 14904, 14905, 14906, 14907, 14908, 14910, 14911, 14912, 14913, 14914, 14915, 14916, 14917, 14918, 14920, 14921, 14927, 14928, 14929, 14930, 14931, 14932, 14933, 14934, 14935, 14936, 14937, 14938, 14939, 14941, 14942, 14945, 14946, 14947, 14948, 14950, 14951, 14953, 14954, 14955, 14956, 14957, 14960, 14961, 14962, 14963, 14964, 14965, 14966, 14967, 14968, 14969, 14970, 14971, 14972, 14973, 14974, 14975, 14976, 14977, 14978, 14979, 14980, 14981, 14982, 14983, 14984, 14985, 14986, 14987, 14988, 14992, 14993, 14994, 14995, 14996, 14997, 14998, 14999, 15000, 15001, 15002, 15003, 15004, 15005, 15011, 15012, 15013, 15014, 15015, 15016, 15018, 15019, 15020, 15021, 15022, 15023, 15024, 15025, 15026, 15027, 15028, 15029, 15034, 15035, 15036, 15037, 15038, 15039, 15041, 15042, 15043, 15044, 15045, 15046, 15047, 15048, 15055, 15056, 15057, 15058, 15059, 15060, 15062, 15063, 15064, 15065, 15066, 15067, 15068, 15069, 15070, 15071, 15074, 15075, 15076, 15077, 15078, 15079, 15080, 15081, 15082, 15083, 15084, 15085, 15086, 15087, 15088, 15089, 15090, 15093, 15094, 15095, 15096, 15097, 15098, 15099, 15100, 15101, 15102, 15103, 15104, 15105, 15106, 15107, 15108, 15109, 15111, 15112, 15113, 15114, 15115, 15116, 15117, 15118, 15119, 15120, 15121, 15122, 15123, 15124, 15125, 15126, 15127, 15128, 15129, 15130, 15131, 15132, 15133, 15134, 15135, 15136, 15137, 15138, 15139, 15140, 15141, 15142, 15143, 15144, 15145, 15146, 15147, 15148, 15149, 15150, 15151, 15152, 15153, 15154, 15155, 15156, 15157, 15160, 15161, 15162, 15163, 15164, 15165, 15166, 15167, 15168, 15169, 15170, 15171, 15172, 15173, 15174, 15175, 15176, 15177, 15178, 15179, 15180, 15181, 15182, 15183, 15184, 15185, 15186, 15187, 15189, 15190, 15191, 15192, 15193, 15198, 15199, 15200, 15201, 15202, 15204, 15205, 15206, 15208, 15209, 15210, 15211, 15213, 15214, 15215, 15217, 15218, 15219, 15221, 15222, 15223, 15225, 15226, 15227, 15229, 15230, 15231, 15233, 15234, 15235, 15237, 15238, 15239, 15241, 15242, 15243, 15245, 15246, 15247, 15249, 15250, 15251, 15253, 15254, 15255, 15257, 15258, 15259, 15260, 15261, 15262, 15263, 15264, 15266, 15267, 15268, 15270, 15271, 15272, 15273, 15274, 15275, 15276, 15277, 15278, 15279, 15280, 15281, 15282, 15283, 15285, 15286, 15287, 15289, 15290, 15291, 15293, 15294, 15295, 15297, 15298, 15299, 15301, 15302, 15303, 15305, 15306, 15307, 15309, 15310, 15311, 15313, 15314, 15315, 15317, 15318, 15319, 15321, 15322, 15323, 15325, 15326, 15327, 15329, 15330, 15331, 15333, 15334, 15335, 15336, 15337, 15338, 15339, 15340, 15342, 15343, 15344, 15346, 15347, 15348, 15350, 15351, 15352, 15354, 15355, 15356, 15358, 15359, 15360, 15362, 15363, 15364, 15366, 15367, 15368, 15370, 15371, 15372, 15374, 15375, 15376, 15377, 15378, 15379, 15380, 15381, 15382, 15384, 15385, 15386, 15388, 15389, 15390, 15391, 15392, 15393, 15394, 15395, 15397, 15398, 15399, 15401, 15402, 15403, 15405, 15406, 15407, 15408, 15409, 15410, 15411, 15412, 15413, 15415, 15416, 15417, 15419, 15420, 15421, 15423, 15424, 15425, 15427, 15428, 15429, 15431, 15432, 15433, 15435, 15436, 15437, 15439, 15440, 15441, 15443, 15444, 15445, 15447, 15448, 15449, 15451, 15452, 15453, 15455, 15456, 15457, 15459, 15460, 15461, 15463, 15464, 15465, 15467, 15468, 15469, 15471, 15472, 15473, 15475, 15476, 15477, 15479, 15480, 15481, 15483, 15484, 15485, 15487, 15488, 15489, 15490, 15491, 15492, 15493, 15494, 15496, 15497, 15498, 15500, 15501, 15502, 15504, 15505, 15506, 15508, 15509, 15510, 15512, 15513, 15514, 15516, 15517, 15518, 15520, 15521, 15522, 15524, 15525, 15526, 15528, 15529, 15530, 15532, 15533, 15534, 15536, 15537, 15538, 15540, 15541, 15542, 15544, 15545, 15546, 15548, 15549, 15550, 15552, 15553, 15554, 15555, 15556, 15557, 15558, 15559, 15560, 15561, 15562, 15563, 15564, 15566, 15567, 15568, 15569, 15570, 15571, 15572, 15573, 15574, 15575, 15576, 15577, 15578, 15579, 11465, 11466, 11467, 11468, 11469, 15580, 15581, 15582, 15583, 15584, 15586, 15587, 15588, 15590, 15591, 15592, 15594, 15595, 15596, 15598, 15599, 15600, 15602, 15603, 15604, 15606, 15607, 15608, 15610, 15611, 15612, 15614, 15615, 15616, 15618, 15619, 15620, 15622, 15623, 15624, 15626, 15627, 15628, 15630, 15631, 15632, 15634, 15635, 15636, 15638, 15639, 15640, 15642, 15643, 15644, 15646, 15647, 15648, 15650, 15651, 15652, 15654, 15655, 15656, 15657, 15658, 15659, 15660, 15661, 15663, 15664, 15665, 15667, 15668, 15669, 15671, 15672, 15673, 15675, 15676, 15677, 15679, 15680, 15681, 15683, 15684, 15685, 15687, 15688, 15689, 15691, 15692, 15693, 15695, 15696, 15697, 15699, 15700, 15701, 15703, 15704, 15705, 15707, 15708, 15709, 15711, 15712, 15713, 15715, 15716, 15717, 15719, 15720, 15721, 15723, 15724, 15725, 15727, 15728, 15729, 15730, 15731, 15732, 15733, 15734, 15736, 15737, 15738, 15740, 15741, 15742, 15744, 15745, 15746, 15748, 15749, 15750, 15751, 15752, 15753, 15754, 15755, 15757, 15758, 15759, 15762, 15763, 15764, 15765, 15766, 15767, 15772, 15773, 15777, 15778, 11729, 11730, 11731, 11732, 11733, 11734, 15794, 15795, 15837, 15838, 15839, 15840, 15841, 15842, 15843, 15844, 15845, 15849, 15850, 15851, 15852, 15853, 15854, 15855, 15856, 15857, 15858, 15859, 15860, 15861, 15862, 15863, 15866, 15867, 15868, 15869, 15870, 15889, 15890, 15891, 15892, 15893, 15894, 15895, 15896, 15897, 15898, 15899, 15900, 15901, 15902, 15903, 15907, 15908, 15909, 15910, 15911, 15912, 15921, 15922, 15923, 15925, 15926, 15927, 15928, 15929, 15930, 15931, 15933, 15934, 15935, 15936, 15937, 15938, 15939, 15948, 15949, 15950, 15951, 15952, 15953, 15954, 15955, 15956, 15957, 15958, 15959, 15964, 15965, 15966, 15967, 15969, 15970, 15971, 15973, 15974, 15975, 15991, 15992, 15993, 15999, 16007, 16008, 16009, 16010, 16011, 16012, 16013, 16014, 16015, 16016, 16021, 16022, 16074, 16075, 16078, 16079, 16085, 16086, 16090, 16091, 16241, 16242, 16583, 16584, 16585, 16586, 16587, 16588, 16589, 16590, 16591, 16592, 16593, 16594, 16595, 16557, 2327) GROUP BY states.metadata_id) AS anon_3 ON states.metadata_id = anon_3.max_metadata_id AND states.last_updated_ts = anon_3.max_last_updated LEFT OUTER JOIN state_attributes ON states.attributes_id = state_attributes.attributes_id WHERE states.last_updated_ts >= 1731219794.579708e0 AND states.last_updated_ts < 1733999399.999999e0 AND states.metadata_id IN (301, 6280, 7616, 10297, 11317, 11738, 11745, 488, 492, 493, 83, 6499, 7871, 10571, 496, 314, 6487, 14138, 6574, 10650, 64, 336, 338, 40, 43, 339, 2027, 2021, 8732, 340, 7868, 7939, 345, 346, 347, 348, 1424, 351, 8507, 14, 354, 2090, 8679, 13989, 1581, 6316, 355, 2, 10555, 81, 337, 1186, 6414, 6227, 344, 87, 353, 357, 358, 1457, 1197, 1844, 6366, 6472, 1381, 7875, 8390, 10330, 10688, 12065, 12170, 13611, 343, 6488, 14139, 6575, 10651, 53, 359, 361, 75, 55, 362, 2028, 2022, 8733, 363, 7869, 7940, 368, 369, 370, 371, 1425, 374, 8508, 33, 377, 2091, 8680, 13990, 1582, 6317, 378, 80, 10556, 20, 360, 1187, 6415, 6228, 367, 56, 376, 380, 381, 1456, 1198, 1845, 6367, 6473, 1365, 7876, 8391, 10331, 10689, 12066, 12171, 13612, 366, 6241, 6242, 6243, 8436, 8437, 8438, 10541, 8467, 8439, 8440, 8441, 10542, 8468, 421, 422, 423, 7595, 2264, 2266, 2289, 2290, 2291, 2292, 2293, 2294, 2295, 2075, 2238, 7926, 7928, 6468, 6470, 417, 419, 8682, 12153, 12154, 14120, 14121, 14556, 15815, 15816, 15823, 15824, 16037, 16038, 14150, 14151, 14826, 14827, 16208, 16209, 16210, 16211, 16212, 16201, 16222, 16202, 16203, 16204, 16205, 16206, 16207, 16217, 16218, 16219, 16220, 16221, 16225, 16226, 16227, 16228, 16229, 16563, 16564, 16565, 16566, 16567, 13981, 13669, 13677, 13668, 7246, 7245, 7247, 7243, 16271, 16272, 16273, 16270, 16028, 16029, 16027, 16031, 16032, 16030, 16233, 16234, 16232, 16267, 16268, 16269, 16266, 16236, 16237, 16238, 16235, 15905, 15906, 14919, 15904, 15879, 15880, 15884, 15924, 15878, 15881, 15883, 15882, 15885, 16069, 792, 16070, 791, 15961, 15962, 15963, 15960, 16042, 12682, 16043, 757, 16044, 16045, 16055, 6236, 16056, 16072, 16067, 748, 16068, 746, 13889, 11350, 13890, 11351, 16061, 749, 16062, 747, 7143, 7142, 775, 774, 776, 10267, 10268, 10269, 10264, 10311, 10265, 10266, 10270, 10271, 10272, 8420, 8422, 8421, 6630, 6631, 6632, 6633, 6634, 16263, 1799, 882, 884, 885, 883, 874, 8172, 7877, 7494, 16533, 16538, 16535, 16536, 16537, 16511, 16512, 1995, 1997, 10370, 7900, 666, 668, 664, 658, 670, 674, 672, 680, 11374, 688, 692, 712, 708, 706, 694, 710, 655, 716, 700, 662, 676, 660, 698, 656, 6304, 8600, 8602, 13833, 10014, 16494, 16496, 6392, 6398, 6308, 11358, 11256, 888, 11141, 2097, 2095, 2098, 2105, 2104, 1042, 1043, 1044, 724, 722, 1064, 1116, 1118, 1120, 342, 365, 356, 379, 341, 364, 78, 34, 350, 373, 1448, 1447, 1528, 1524, 1526, 1523, 1879, 1880, 1537, 1539, 1906, 1907, 1350, 1301, 1061, 1543, 1544, 1972, 1974, 1556, 1545, 1983, 2020, 1559, 1546, 1549, 1551, 1547, 1554, 1555, 1552, 1564, 1565, 1250, 1346, 349, 372, 1709, 1708, 1740, 1739, 1750, 1751, 2083, 2084, 2085, 2086, 2087, 2088, 6412, 6413, 6486, 6518, 6519, 6520, 6521, 6524, 6525, 6530, 6531, 6576, 6577, 6642, 6643, 6644, 6645, 1226, 1213, 6652, 6653, 6656, 6657, 6664, 6665, 6666, 6667, 6673, 6674, 6679, 6680, 6721, 6722, 6750, 6751, 6752, 6753, 6767, 6768, 6841, 6842, 6853, 6854, 6856, 6857, 6858, 6859, 6860, 6861, 6862, 6863, 6877, 6878, 6962, 6963, 7026, 7027, 7065, 7066, 7091, 7092, 7112, 7113, 7411, 7412, 7564, 7565, 7793, 7794, 7795, 7796, 7812, 7813, 7837, 7838, 7839, 7840, 7841, 7842, 7843, 7844, 7846, 7847, 7854, 7855, 7864, 7865, 8023, 8042, 8043, 8070, 8071, 8081, 8082, 8118, 8119, 8221, 8222, 8226, 8227, 8241, 8242, 8262, 8263, 8264, 8265, 8275, 8276, 8337, 8338, 8382, 8383, 8442, 8443, 8454, 8455, 8721, 8722, 8728, 8729, 10133, 10134, 10135, 10136, 10137, 10138, 10143, 10144, 10201, 10202, 10324, 10325, 10366, 10367, 10382, 10383, 10505, 10506, 10507, 10508, 10511, 10512, 10514, 10515, 10516, 10517, 10530, 10531, 10558, 10559, 10560, 10561, 10575, 10576, 10598, 10599, 10657, 10658, 10659, 10660, 1748, 1747, 11399, 11400, 11985, 11986, 11992, 11993, 11994, 11995, 11996, 11997, 12014, 12015, 12016, 12017, 12095, 12096, 12097, 12098, 12099, 12100, 11837, 11838, 11839, 11840, 11841, 11842, 12107, 12108, 12109, 12110, 12111, 12112, 12141, 12142, 12143, 12144, 12145, 12146, 12149, 12150, 12151, 12175, 12176, 12177, 12178, 12181, 12182, 12135, 12136, 12137, 12138, 12139, 12140, 11425, 11426, 11427, 11428, 11429, 12587, 12588, 12609, 12610, 12611, 12612, 12613, 12614, 12615, 12616, 12626, 12627, 12628, 12629, 12630, 12631, 12632, 12633, 12634, 12635, 12636, 12637, 12639, 12640, 12641, 12642, 12643, 12644, 10967, 10968, 10969, 10970, 10971, 10972, 12645, 12646, 12647, 12648, 12649, 12650, 12651, 12652, 12653, 12654, 12655, 12656, 12657, 12658, 12659, 12660, 12661, 12662, 10984, 10985, 10986, 10987, 10988, 10989, 12663, 12664, 12665, 12666, 12667, 12668, 10955, 10956, 10957, 10958, 10959, 10960, 10940, 10941, 10942, 10943, 10944, 10945, 12685, 12686, 12687, 12688, 12689, 12690, 12704, 12705, 12706, 12707, 12708, 12709, 12710, 12711, 12712, 12713, 12714, 12715, 12716, 12717, 12718, 12719, 12720, 12721, 12722, 12723, 12724, 12725, 12726, 12727, 12728, 12729, 12730, 12731, 12732, 12733, 12734, 12735, 12736, 12737, 12738, 12739, 11782, 11783, 11784, 11785, 11786, 11787, 11477, 11478, 11479, 11480, 11481, 11482, 12740, 12741, 12742, 12743, 12744, 12745, 12751, 12752, 12753, 12754, 12755, 12756, 12757, 12758, 12759, 12760, 12761, 12762, 12765, 12766, 12767, 12768, 12769, 11579, 11580, 11581, 11582, 11583, 11584, 12771, 12772, 12773, 12774, 12775, 12776, 12777, 12778, 12779, 12780, 12781, 12782, 12786, 12787, 12788, 12789, 12790, 12791, 11758, 11759, 11760, 11761, 11762, 11763, 12792, 12793, 12794, 12795, 12796, 12797, 11788, 11789, 11790, 11791, 11792, 11793, 10946, 10947, 10948, 10949, 10950, 10951, 12798, 12799, 12800, 12801, 12802, 12803, 12804, 12805, 12806, 12807, 12808, 12809, 12810, 12811, 12812, 12813, 12814, 12815, 12818, 12819, 12820, 12821, 12822, 12823, 12835, 12836, 12837, 12838, 12839, 12840, 12846, 12847, 12155, 12156, 12157, 12158, 12159, 12848, 12849, 12850, 12851, 12852, 12853, 12854, 12855, 12857, 12858, 12859, 12860, 12861, 12862, 12863, 12864, 12865, 12866, 12867, 12868, 12869, 12870, 12871, 12872, 12873, 12874, 12875, 12876, 12877, 12878, 12879, 12880, 12881, 12882, 12883, 12884, 12885, 12886, 12887, 12888, 12889, 12890, 12891, 12892, 12894, 12895, 12896, 12897, 12898, 12899, 12906, 12907, 12908, 12909, 12910, 12911, 12915, 12916, 12917, 12918, 12919, 12920, 12921, 12922, 12923, 12924, 12925, 12926, 12931, 12932, 12933, 12934, 12935, 12936, 12161, 12162, 12163, 12164, 12165, 12950, 12951, 12952, 12953, 12954, 12955, 12956, 12829, 12830, 12831, 12832, 12833, 12834, 12962, 12963, 12964, 12965, 12966, 12967, 12968, 12969, 12970, 12971, 12972, 12973, 12974, 12975, 12976, 12977, 12978, 12979, 10931, 10932, 10933, 10934, 10935, 10936, 12981, 12982, 12983, 12984, 12985, 12986, 12987, 12988, 12989, 12990, 12991, 12992, 10925, 10926, 10927, 10928, 10929, 10930, 12996, 12997, 12998, 12999, 13000, 13001, 13002, 13004, 13005, 13006, 13007, 13008, 13009, 13010, 13011, 13012, 13013, 13014, 13015, 13016, 13017, 13018, 13019, 13020, 13021, 12022, 12023, 12024, 12025, 12026, 13030, 13031, 13032, 13033, 13034, 13035, 13037, 13038, 13039, 13040, 13041, 13042, 13043, 13044, 13045, 13046, 13047, 13048, 12669, 12670, 12671, 12672, 12673, 12674, 13053, 13054, 13055, 13056, 13057, 13058, 13070, 13071, 13072, 13073, 13074, 13075, 13089, 13090, 13091, 13092, 13093, 13094, 11847, 11848, 11849, 11850, 11851, 11852, 11752, 11753, 11754, 11755, 11756, 11757, 13115, 13116, 13117, 13118, 13119, 13120, 13121, 13122, 13123, 13124, 13125, 13126, 13127, 13128, 13129, 13130, 13131, 13132, 13133, 13134, 13135, 13136, 13137, 13138, 13139, 13140, 13141, 13142, 13143, 13144, 13145, 13146, 13147, 13148, 13149, 13150, 13153, 13154, 13155, 12089, 12090, 12091, 12092, 12093, 12094, 13162, 13163, 13164, 13165, 13166, 13167, 13170, 13171, 13172, 13173, 13174, 13175, 13177, 13178, 13179, 13180, 13181, 13182, 13184, 13185, 13186, 13187, 13188, 13189, 13191, 13192, 13193, 13194, 13195, 13196, 13222, 13223, 13224, 13225, 13226, 13227, 13239, 13240, 13241, 13242, 13243, 13253, 13254, 13255, 13256, 13257, 13258, 13264, 13265, 13266, 13267, 13268, 13269, 13270, 13271, 13272, 13273, 13274, 13275, 13277, 13278, 13279, 13280, 13281, 13282, 13288, 13289, 13290, 13291, 13292, 13293, 13299, 13300, 13301, 13302, 13303, 13304, 13305, 13306, 13307, 13308, 13309, 13310, 13312, 13313, 13314, 13315, 13316, 13317, 13323, 13324, 13325, 13326, 13327, 13328, 13337, 13338, 13339, 13340, 13341, 13342, 13343, 13344, 13345, 13346, 13347, 13348, 12101, 12102, 12103, 12104, 12105, 12106, 13351, 13352, 13353, 13354, 13355, 13356, 12038, 12039, 12040, 12041, 12042, 12043, 13373, 13374, 13375, 13376, 13377, 13378, 13379, 13380, 13381, 13382, 13383, 13384, 13385, 13386, 13387, 13388, 13389, 13390, 13391, 13392, 13393, 13394, 13395, 13396, 13397, 13398, 13399, 13400, 13401, 13403, 12047, 12048, 12049, 12050, 12051, 13584, 13585, 13586, 13587, 13588, 13589, 13590, 13591, 13592, 13593, 13594, 13077, 13078, 13079, 13080, 13082, 13083, 13084, 13085, 13086, 13087, 13620, 13621, 13622, 13623, 13624, 13625, 13626, 13627, 13628, 13629, 13630, 13631, 13632, 13633, 13634, 13635, 13636, 13637, 13638, 13639, 13640, 13641, 13642, 13643, 13644, 13645, 13646, 13647, 13648, 13649, 13650, 13651, 13652, 13653, 13654, 13655, 13656, 13657, 13708, 13709, 13710, 13711, 13712, 13735, 13736, 13737, 13738, 13739, 13740, 13741, 13742, 13743, 13749, 13750, 13751, 13752, 13753, 13754, 13755, 13756, 13757, 13758, 13759, 13760, 13762, 13763, 13764, 13793, 13794, 13799, 13816, 13817, 13840, 13841, 13846, 13863, 13864, 13869, 13870, 13871, 13872, 13873, 13874, 13884, 13885, 13886, 13887, 13905, 13906, 13907, 13908, 13909, 13910, 13915, 13916, 13917, 13918, 13919, 13921, 13922, 13923, 13924, 13925, 13928, 13929, 13930, 13931, 13932, 13933, 13935, 13936, 13939, 13940, 13944, 13945, 13946, 13947, 13948, 13949, 13950, 13951, 13953, 13954, 13955, 13956, 13957, 13958, 13959, 13960, 13961, 13962, 13963, 13964, 12675, 12676, 12677, 12678, 12679, 12680, 13966, 13967, 13968, 13969, 13970, 13998, 13999, 14000, 14001, 14003, 14004, 14005, 14006, 14007, 14008, 14011, 14012, 14013, 14014, 14015, 14016, 14018, 14019, 14020, 14021, 14022, 14023, 14024, 14025, 14026, 14027, 14028, 14037, 14038, 14039, 14040, 14041, 14042, 14043, 14044, 14045, 14046, 14047, 14048, 14049, 14055, 14056, 14057, 14058, 14062, 14063, 14064, 14065, 14066, 14067, 14068, 14069, 14070, 14071, 14072, 14073, 14074, 14075, 14076, 14077, 14078, 14079, 14080, 14081, 14082, 14083, 14084, 14085, 14086, 14087, 14088, 14089, 14090, 14091, 14093, 14094, 14095, 14096, 14097, 14098, 14099, 14100, 14101, 14102, 14111, 14112, 14142, 14143, 14144, 14145, 14152, 14153, 14154, 14155, 14156, 14157, 14158, 14159, 14161, 14162, 14163, 14164, 14165, 14166, 14167, 14168, 14169, 14170, 14171, 14172, 14175, 14176, 14177, 14178, 14181, 14182, 14183, 14184, 14185, 14186, 14187, 14188, 14189, 14190, 14191, 14192, 14193, 14194, 14201, 14202, 14203, 14204, 14206, 14207, 14208, 14209, 14210, 14211, 14212, 14213, 14214, 14215, 14216, 14217, 14218, 14219, 14220, 14221, 14222, 14223, 14225, 14226, 14227, 14228, 14229, 14230, 14235, 14236, 14237, 14238, 14239, 14244, 14245, 14246, 14247, 14248, 14249, 14250, 14251, 14252, 14253, 14254, 14255, 14258, 14259, 14260, 14263, 14264, 14265, 14266, 14267, 14268, 14271, 14272, 14273, 14274, 14276, 14277, 14278, 14279, 14280, 14281, 14282, 14283, 14284, 14285, 14286, 14287, 14288, 14289, 14290, 14291, 14292, 14293, 14294, 14295, 14296, 14297, 12681, 12683, 12684, 14300, 14301, 14302, 14303, 14304, 14305, 14307, 14308, 14309, 14322, 14323, 14324, 14325, 14326, 14327, 14328, 14329, 14330, 14331, 14332, 14333, 14345, 14346, 14347, 14348, 14349, 14350, 14351, 14352, 14353, 14354, 14355, 14356, 14357, 14358, 14359, 14360, 14361, 14362, 14363, 14364, 14365, 14366, 14367, 14375, 14376, 14377, 14378, 14379, 14380, 14381, 14382, 14383, 14384, 14385, 14386, 14387, 14388, 14389, 14390, 14395, 14396, 14397, 14398, 14399, 14400, 14401, 14403, 14404, 14405, 14406, 14407, 14408, 14410, 14411, 14412, 14414, 14415, 14416, 14417, 14418, 14419, 14420, 14421, 14422, 14423, 14424, 14425, 14426, 14427, 14428, 14429, 14430, 14431, 14432, 14433, 14434, 14435, 14436, 14437, 14438, 14439, 14441, 14442, 14443, 14444, 14445, 14446, 14447, 14448, 14449, 14450, 14451, 14452, 14453, 14454, 14455, 14456, 14457, 14458, 14462, 14463, 14464, 14465, 14466, 14467, 14469, 14470, 14471, 14472, 14473, 14474, 14475, 14476, 14477, 14478, 14479, 14480, 14481, 14482, 14483, 14484, 14485, 14486, 14487, 14488, 14489, 14490, 14496, 14497, 14498, 14499, 14500, 14506, 14507, 14508, 14509, 14510, 14511, 14513, 14514, 14515, 14516, 14517, 14518, 14519, 14520, 14521, 14545, 14546, 14551, 14552, 14553, 14554, 14561, 14562, 14563, 14564, 14580, 14581, 14593, 14594, 14595, 14596, 14597, 14598, 14599, 14600, 14601, 14602, 14603, 14604, 14605, 13744, 13745, 13746, 13747, 13748, 14606, 14607, 14608, 14609, 14610, 14611, 14620, 14621, 14622, 14623, 14624, 14630, 14629, 14632, 14633, 14631, 14638, 14639, 14640, 14641, 14642, 14643, 14646, 14647, 14648, 14649, 14650, 14651, 14652, 14653, 14654, 14655, 14656, 14657, 14658, 14659, 14660, 14661, 14662, 14663, 14664, 14665, 14666, 14667, 14668, 14669, 14670, 14671, 14672, 14673, 14674, 14675, 12824, 12825, 12826, 12827, 12828, 14677, 14678, 14679, 14680, 14681, 14682, 14683, 14684, 14685, 14686, 14687, 14688, 14689, 14691, 14692, 14693, 14695, 14696, 14697, 14698, 14699, 14700, 14701, 14702, 14704, 14705, 14706, 14708, 14709, 14710, 14711, 14712, 14713, 14714, 14715, 14716, 14717, 14718, 14719, 14720, 14721, 14722, 14723, 14724, 14725, 14726, 14727, 14728, 14729, 14730, 14731, 14732, 14733, 14734, 14735, 14736, 14737, 14738, 14739, 14740, 14741, 14742, 14743, 14744, 14745, 14746, 14747, 14748, 14749, 14750, 14751, 14752, 14753, 14754, 14755, 14756, 14757, 14758, 14759, 14760, 14761, 14762, 14763, 14764, 14765, 14766, 14767, 14768, 14769, 14770, 14771, 14772, 14773, 14774, 14775, 14776, 14777, 14778, 14779, 14780, 14781, 14782, 14783, 14784, 14785, 14786, 14787, 14788, 14789, 14790, 14791, 14792, 14793, 14794, 14795, 14797, 14798, 14799, 14801, 14802, 14803, 14804, 14805, 14806, 14807, 14808, 14810, 14811, 14812, 14813, 14814, 14815, 14817, 14818, 14819, 14820, 14821, 14822, 14832, 14833, 14834, 14835, 14836, 14837, 14838, 14839, 14840, 14841, 14842, 14843, 14845, 14846, 14847, 14853, 14854, 14855, 14856, 14857, 14858, 14861, 14862, 14863, 14864, 14865, 14867, 14868, 14869, 14870, 14871, 11979, 11980, 11981, 12029, 12030, 12031, 14885, 14886, 14887, 14888, 14889, 14890, 14891, 14892, 14893, 14894, 14895, 14897, 14898, 14899, 14900, 14901, 14903, 14904, 14905, 14906, 14907, 14908, 14910, 14911, 14912, 14913, 14914, 14915, 14916, 14917, 14918, 14920, 14921, 14927, 14928, 14929, 14930, 14931, 14932, 14933, 14934, 14935, 14936, 14937, 14938, 14939, 14941, 14942, 14945, 14946, 14947, 14948, 14950, 14951, 14953, 14954, 14955, 14956, 14957, 14960, 14961, 14962, 14963, 14964, 14965, 14966, 14967, 14968, 14969, 14970, 14971, 14972, 14973, 14974, 14975, 14976, 14977, 14978, 14979, 14980, 14981, 14982, 14983, 14984, 14985, 14986, 14987, 14988, 14992, 14993, 14994, 14995, 14996, 14997, 14998, 14999, 15000, 15001, 15002, 15003, 15004, 15005, 15011, 15012, 15013, 15014, 15015, 15016, 15018, 15019, 15020, 15021, 15022, 15023, 15024, 15025, 15026, 15027, 15028, 15029, 15034, 15035, 15036, 15037, 15038, 15039, 15041, 15042, 15043, 15044, 15045, 15046, 15047, 15048, 15055, 15056, 15057, 15058, 15059, 15060, 15062, 15063, 15064, 15065, 15066, 15067, 15068, 15069, 15070, 15071, 15074, 15075, 15076, 15077, 15078, 15079, 15080, 15081, 15082, 15083, 15084, 15085, 15086, 15087, 15088, 15089, 15090, 15093, 15094, 15095, 15096, 15097, 15098, 15099, 15100, 15101, 15102, 15103, 15104, 15105, 15106, 15107, 15108, 15109, 15111, 15112, 15113, 15114, 15115, 15116, 15117, 15118, 15119, 15120, 15121, 15122, 15123, 15124, 15125, 15126, 15127, 15128, 15129, 15130, 15131, 15132, 15133, 15134, 15135, 15136, 15137, 15138, 15139, 15140, 15141, 15142, 15143, 15144, 15145, 15146, 15147, 15148, 15149, 15150, 15151, 15152, 15153, 15154, 15155, 15156, 15157, 15160, 15161, 15162, 15163, 15164, 15165, 15166, 15167, 15168, 15169, 15170, 15171, 15172, 15173, 15174, 15175, 15176, 15177, 15178, 15179, 15180, 15181, 15182, 15183, 15184, 15185, 15186, 15187, 15189, 15190, 15191, 15192, 15193, 15198, 15199, 15200, 15201, 15202, 15204, 15205, 15206, 15208, 15209, 15210, 15211, 15213, 15214, 15215, 15217, 15218, 15219, 15221, 15222, 15223, 15225, 15226, 15227, 15229, 15230, 15231, 15233, 15234, 15235, 15237, 15238, 15239, 15241, 15242, 15243, 15245, 15246, 15247, 15249, 15250, 15251, 15253, 15254, 15255, 15257, 15258, 15259, 15260, 15261, 15262, 15263, 15264, 15266, 15267, 15268, 15270, 15271, 15272, 15273, 15274, 15275, 15276, 15277, 15278, 15279, 15280, 15281, 15282, 15283, 15285, 15286, 15287, 15289, 15290, 15291, 15293, 15294, 15295, 15297, 15298, 15299, 15301, 15302, 15303, 15305, 15306, 15307, 15309, 15310, 15311, 15313, 15314, 15315, 15317, 15318, 15319, 15321, 15322, 15323, 15325, 15326, 15327, 15329, 15330, 15331, 15333, 15334, 15335, 15336, 15337, 15338, 15339, 15340, 15342, 15343, 15344, 15346, 15347, 15348, 15350, 15351, 15352, 15354, 15355, 15356, 15358, 15359, 15360, 15362, 15363, 15364, 15366, 15367, 15368, 15370, 15371, 15372, 15374, 15375, 15376, 15377, 15378, 15379, 15380, 15381, 15382, 15384, 15385, 15386, 15388, 15389, 15390, 15391, 15392, 15393, 15394, 15395, 15397, 15398, 15399, 15401, 15402, 15403, 15405, 15406, 15407, 15408, 15409, 15410, 15411, 15412, 15413, 15415, 15416, 15417, 15419, 15420, 15421, 15423, 15424, 15425, 15427, 15428, 15429, 15431, 15432, 15433, 15435, 15436, 15437, 15439, 15440, 15441, 15443, 15444, 15445, 15447, 15448, 15449, 15451, 15452, 15453, 15455, 15456, 15457, 15459, 15460, 15461, 15463, 15464, 15465, 15467, 15468, 15469, 15471, 15472, 15473, 15475, 15476, 15477, 15479, 15480, 15481, 15483, 15484, 15485, 15487, 15488, 15489, 15490, 15491, 15492, 15493, 15494, 15496, 15497, 15498, 15500, 15501, 15502, 15504, 15505, 15506, 15508, 15509, 15510, 15512, 15513, 15514, 15516, 15517, 15518, 15520, 15521, 15522, 15524, 15525, 15526, 15528, 15529, 15530, 15532, 15533, 15534, 15536, 15537, 15538, 15540, 15541, 15542, 15544, 15545, 15546, 15548, 15549, 15550, 15552, 15553, 15554, 15555, 15556, 15557, 15558, 15559, 15560, 15561, 15562, 15563, 15564, 15566, 15567, 15568, 15569, 15570, 15571, 15572, 15573, 15574, 15575, 15576, 15577, 15578, 15579, 11465, 11466, 11467, 11468, 11469, 15580, 15581, 15582, 15583, 15584, 15586, 15587, 15588, 15590, 15591, 15592, 15594, 15595, 15596, 15598, 15599, 15600, 15602, 15603, 15604, 15606, 15607, 15608, 15610, 15611, 15612, 15614, 15615, 15616, 15618, 15619, 15620, 15622, 15623, 15624, 15626, 15627, 15628, 15630, 15631, 15632, 15634, 15635, 15636, 15638, 15639, 15640, 15642, 15643, 15644, 15646, 15647, 15648, 15650, 15651, 15652, 15654, 15655, 15656, 15657, 15658, 15659, 15660, 15661, 15663, 15664, 15665, 15667, 15668, 15669, 15671, 15672, 15673, 15675, 15676, 15677, 15679, 15680, 15681, 15683, 15684, 15685, 15687, 15688, 15689, 15691, 15692, 15693, 15695, 15696, 15697, 15699, 15700, 15701, 15703, 15704, 15705, 15707, 15708, 15709, 15711, 15712, 15713, 15715, 15716, 15717, 15719, 15720, 15721, 15723, 15724, 15725, 15727, 15728, 15729, 15730, 15731, 15732, 15733, 15734, 15736, 15737, 15738, 15740, 15741, 15742, 15744, 15745, 15746, 15748, 15749, 15750, 15751, 15752, 15753, 15754, 15755, 15757, 15758, 15759, 15762, 15763, 15764, 15765, 15766, 15767, 15772, 15773, 15777, 15778, 11729, 11730, 11731, 11732, 11733, 11734, 15794, 15795, 15837, 15838, 15839, 15840, 15841, 15842, 15843, 15844, 15845, 15849, 15850, 15851, 15852, 15853, 15854, 15855, 15856, 15857, 15858, 15859, 15860, 15861, 15862, 15863, 15866, 15867, 15868, 15869, 15870, 15889, 15890, 15891, 15892, 15893, 15894, 15895, 15896, 15897, 15898, 15899, 15900, 15901, 15902, 15903, 15907, 15908, 15909, 15910, 15911, 15912, 15921, 15922, 15923, 15925, 15926, 15927, 15928, 15929, 15930, 15931, 15933, 15934, 15935, 15936, 15937, 15938, 15939, 15948, 15949, 15950, 15951, 15952, 15953, 15954, 15955, 15956, 15957, 15958, 15959, 15964, 15965, 15966, 15967, 15969, 15970, 15971, 15973, 15974, 15975, 15991, 15992, 15993, 15999, 16007, 16008, 16009, 16010, 16011, 16012, 16013, 16014, 16015, 16016, 16021, 16022, 16074, 16075, 16078, 16079, 16085, 16086, 16090, 16091, 16241, 16242, 16583, 16584, 16585, 16586, 16587, 16588, 16589, 16590, 16591, 16592, 16593, 16594, 16595, 16557, 2327)) AS anon_2 UNION ALL SELECT anon_4.metadata_id AS metadata_id, anon_4.state AS state, anon_4.last_updated_ts AS last_updated_ts, anon_4.attributes AS attributes FROM (SELECT states.metadata_id AS metadata_id, states.state AS state, states.last_updated_ts AS last_updated_ts, CASE WHEN (state_attributes.shared_attrs IS NULL) THEN states.attributes ELSE state_attributes.shared_attrs END AS attributes FROM states LEFT OUTER JOIN state_attributes ON states.attributes_id = state_attributes.attributes_id WHERE (states.last_changed_ts = states.last_updated_ts OR states.last_changed_ts IS NULL) AND states.metadata_id IN (301, 6280, 7616, 10297, 11317, 11738, 11745, 488, 492, 493, 83, 6499, 7871, 10571, 496, 314, 6487, 14138, 6574, 10650, 64, 336, 338, 40, 43, 339, 2027, 2021, 8732, 340, 7868, 7939, 345, 346, 347, 348, 1424, 351, 8507, 14, 354, 2090, 8679, 13989, 1581, 6316, 355, 2, 10555, 81, 337, 1186, 6414, 6227, 344, 87, 353, 357, 358, 1457, 1197, 1844, 6366, 6472, 1381, 7875, 8390, 10330, 10688, 12065, 12170, 13611, 343, 6488, 14139, 6575, 10651, 53, 359, 361, 75, 55, 362, 2028, 2022, 8733, 363, 7869, 7940, 368, 369, 370, 371, 1425, 374, 8508, 33, 377, 2091, 8680, 13990, 1582, 6317, 378, 80, 10556, 20, 360, 1187, 6415, 6228, 367, 56, 376, 380, 381, 1456, 1198, 1845, 6367, 6473, 1365, 7876, 8391, 10331, 10689, 12066, 12171, 13612, 366, 6241, 6242, 6243, 8436, 8437, 8438, 10541, 8467, 8439, 8440, 8441, 10542, 8468, 421, 422, 423, 7595, 2264, 2266, 2289, 2290, 2291, 2292, 2293, 2294, 2295, 2075, 2238, 7926, 7928, 6468, 6470, 417, 419, 8682, 12153, 12154, 14120, 14121, 14556, 15815, 15816, 15823, 15824, 16037, 16038, 14150, 14151, 14826, 14827, 16208, 16209, 16210, 16211, 16212, 16201, 16222, 16202, 16203, 16204, 16205, 16206, 16207, 16217, 16218, 16219, 16220, 16221, 16225, 16226, 16227, 16228, 16229, 16563, 16564, 16565, 16566, 16567, 13981, 13669, 13677, 13668, 7246, 7245, 7247, 7243, 16271, 16272, 16273, 16270, 16028, 16029, 16027, 16031, 16032, 16030, 16233, 16234, 16232, 16267, 16268, 16269, 16266, 16236, 16237, 16238, 16235, 15905, 15906, 14919, 15904, 15879, 15880, 15884, 15924, 15878, 15881, 15883, 15882, 15885, 16069, 792, 16070, 791, 15961, 15962, 15963, 15960, 16042, 12682, 16043, 757, 16044, 16045, 16055, 6236, 16056, 16072, 16067, 748, 16068, 746, 13889, 11350, 13890, 11351, 16061, 749, 16062, 747, 7143, 7142, 775, 774, 776, 10267, 10268, 10269, 10264, 10311, 10265, 10266, 10270, 10271, 10272, 8420, 8422, 8421, 6630, 6631, 6632, 6633, 6634, 16263, 1799, 882, 884, 885, 883, 874, 8172, 7877, 7494, 16533, 16538, 16535, 16536, 16537, 16511, 16512, 1995, 1997, 10370, 7900, 666, 668, 664, 658, 670, 674, 672, 680, 11374, 688, 692, 712, 708, 706, 694, 710, 655, 716, 700, 662, 676, 660, 698, 656, 6304, 8600, 8602, 13833, 10014, 16494, 16496, 6392, 6398, 6308, 11358, 11256, 888, 11141, 2097, 2095, 2098, 2105, 2104, 1042, 1043, 1044, 724, 722, 1064, 1116, 1118, 1120, 342, 365, 356, 379, 341, 364, 78, 34, 350, 373, 1448, 1447, 1528, 1524, 1526, 1523, 1879, 1880, 1537, 1539, 1906, 1907, 1350, 1301, 1061, 1543, 1544, 1972, 1974, 1556, 1545, 1983, 2020, 1559, 1546, 1549, 1551, 1547, 1554, 1555, 1552, 1564, 1565, 1250, 1346, 349, 372, 1709, 1708, 1740, 1739, 1750, 1751, 2083, 2084, 2085, 2086, 2087, 2088, 6412, 6413, 6486, 6518, 6519, 6520, 6521, 6524, 6525, 6530, 6531, 6576, 6577, 6642, 6643, 6644, 6645, 1226, 1213, 6652, 6653, 6656, 6657, 6664, 6665, 6666, 6667, 6673, 6674, 6679, 6680, 6721, 6722, 6750, 6751, 6752, 6753, 6767, 6768, 6841, 6842, 6853, 6854, 6856, 6857, 6858, 6859, 6860, 6861, 6862, 6863, 6877, 6878, 6962, 6963, 7026, 7027, 7065, 7066, 7091, 7092, 7112, 7113, 7411, 7412, 7564, 7565, 7793, 7794, 7795, 7796, 7812, 7813, 7837, 7838, 7839, 7840, 7841, 7842, 7843, 7844, 7846, 7847, 7854, 7855, 7864, 7865, 8023, 8042, 8043, 8070, 8071, 8081, 8082, 8118, 8119, 8221, 8222, 8226, 8227, 8241, 8242, 8262, 8263, 8264, 8265, 8275, 8276, 8337, 8338, 8382, 8383, 8442, 8443, 8454, 8455, 8721, 8722, 8728, 8729, 10133, 10134, 10135, 10136, 10137, 10138, 10143, 10144, 10201, 10202, 10324, 10325, 10366, 10367, 10382, 10383, 10505, 10506, 10507, 10508, 10511, 10512, 10514, 10515, 10516, 10517, 10530, 10531, 10558, 10559, 10560, 10561, 10575, 10576, 10598, 10599, 10657, 10658, 10659, 10660, 1748, 1747, 11399, 11400, 11985, 11986, 11992, 11993, 11994, 11995, 11996, 11997, 12014, 12015, 12016, 12017, 12095, 12096, 12097, 12098, 12099, 12100, 11837, 11838, 11839, 11840, 11841, 11842, 12107, 12108, 12109, 12110, 12111, 12112, 12141, 12142, 12143, 12144, 12145, 12146, 12149, 12150, 12151, 12175, 12176, 12177, 12178, 12181, 12182, 12135, 12136, 12137, 12138, 12139, 12140, 11425, 11426, 11427, 11428, 11429, 12587, 12588, 12609, 12610, 12611, 12612, 12613, 12614, 12615, 12616, 12626, 12627, 12628, 12629, 12630, 12631, 12632, 12633, 12634, 12635, 12636, 12637, 12639, 12640, 12641, 12642, 12643, 12644, 10967, 10968, 10969, 10970, 10971, 10972, 12645, 12646, 12647, 12648, 12649, 12650, 12651, 12652, 12653, 12654, 12655, 12656, 12657, 12658, 12659, 12660, 12661, 12662, 10984, 10985, 10986, 10987, 10988, 10989, 12663, 12664, 12665, 12666, 12667, 12668, 10955, 10956, 10957, 10958, 10959, 10960, 10940, 10941, 10942, 10943, 10944, 10945, 12685, 12686, 12687, 12688, 12689, 12690, 12704, 12705, 12706, 12707, 12708, 12709, 12710, 12711, 12712, 12713, 12714, 12715, 12716, 12717, 12718, 12719, 12720, 12721, 12722, 12723, 12724, 12725, 12726, 12727, 12728, 12729, 12730, 12731, 12732, 12733, 12734, 12735, 12736, 12737, 12738, 12739, 11782, 11783, 11784, 11785, 11786, 11787, 11477, 11478, 11479, 11480, 11481, 11482, 12740, 12741, 12742, 12743, 12744, 12745, 12751, 12752, 12753, 12754, 12755, 12756, 12757, 12758, 12759, 12760, 12761, 12762, 12765, 12766, 12767, 12768, 12769, 11579, 11580, 11581, 11582, 11583, 11584, 12771, 12772, 12773, 12774, 12775, 12776, 12777, 12778, 12779, 12780, 12781, 12782, 12786, 12787, 12788, 12789, 12790, 12791, 11758, 11759, 11760, 11761, 11762, 11763, 12792, 12793, 12794, 12795, 12796, 12797, 11788, 11789, 11790, 11791, 11792, 11793, 10946, 10947, 10948, 10949, 10950, 10951, 12798, 12799, 12800, 12801, 12802, 12803, 12804, 12805, 12806, 12807, 12808, 12809, 12810, 12811, 12812, 12813, 12814, 12815, 12818, 12819, 12820, 12821, 12822, 12823, 12835, 12836, 12837, 12838, 12839, 12840, 12846, 12847, 12155, 12156, 12157, 12158, 12159, 12848, 12849, 12850, 12851, 12852, 12853, 12854, 12855, 12857, 12858, 12859, 12860, 12861, 12862, 12863, 12864, 12865, 12866, 12867, 12868, 12869, 12870, 12871, 12872, 12873, 12874, 12875, 12876, 12877, 12878, 12879, 12880, 12881, 12882, 12883, 12884, 12885, 12886, 12887, 12888, 12889, 12890, 12891, 12892, 12894, 12895, 12896, 12897, 12898, 12899, 12906, 12907, 12908, 12909, 12910, 12911, 12915, 12916, 12917, 12918, 12919, 12920, 12921, 12922, 12923, 12924, 12925, 12926, 12931, 12932, 12933, 12934, 12935, 12936, 12161, 12162, 12163, 12164, 12165, 12950, 12951, 12952, 12953, 12954, 12955, 12956, 12829, 12830, 12831, 12832, 12833, 12834, 12962, 12963, 12964, 12965, 12966, 12967, 12968, 12969, 12970, 12971, 12972, 12973, 12974, 12975, 12976, 12977, 12978, 12979, 10931, 10932, 10933, 10934, 10935, 10936, 12981, 12982, 12983, 12984, 12985, 12986, 12987, 12988, 12989, 12990, 12991, 12992, 10925, 10926, 10927, 10928, 10929, 10930, 12996, 12997, 12998, 12999, 13000, 13001, 13002, 13004, 13005, 13006, 13007, 13008, 13009, 13010, 13011, 13012, 13013, 13014, 13015, 13016, 13017, 13018, 13019, 13020, 13021, 12022, 12023, 12024, 12025, 12026, 13030, 13031, 13032, 13033, 13034, 13035, 13037, 13038, 13039, 13040, 13041, 13042, 13043, 13044, 13045, 13046, 13047, 13048, 12669, 12670, 12671, 12672, 12673, 12674, 13053, 13054, 13055, 13056, 13057, 13058, 13070, 13071, 13072, 13073, 13074, 13075, 13089, 13090, 13091, 13092, 13093, 13094, 11847, 11848, 11849, 11850, 11851, 11852, 11752, 11753, 11754, 11755, 11756, 11757, 13115, 13116, 13117, 13118, 13119, 13120, 13121, 13122, 13123, 13124, 13125, 13126, 13127, 13128, 13129, 13130, 13131, 13132, 13133, 13134, 13135, 13136, 13137, 13138, 13139, 13140, 13141, 13142, 13143, 13144, 13145, 13146, 13147, 13148, 13149, 13150, 13153, 13154, 13155, 12089, 12090, 12091, 12092, 12093, 12094, 13162, 13163, 13164, 13165, 13166, 13167, 13170, 13171, 13172, 13173, 13174, 13175, 13177, 13178, 13179, 13180, 13181, 13182, 13184, 13185, 13186, 13187, 13188, 13189, 13191, 13192, 13193, 13194, 13195, 13196, 13222, 13223, 13224, 13225, 13226, 13227, 13239, 13240, 13241, 13242, 13243, 13253, 13254, 13255, 13256, 13257, 13258, 13264, 13265, 13266, 13267, 13268, 13269, 13270, 13271, 13272, 13273, 13274, 13275, 13277, 13278, 13279, 13280, 13281, 13282, 13288, 13289, 13290, 13291, 13292, 13293, 13299, 13300, 13301, 13302, 13303, 13304, 13305, 13306, 13307, 13308, 13309, 13310, 13312, 13313, 13314, 13315, 13316, 13317, 13323, 13324, 13325, 13326, 13327, 13328, 13337, 13338, 13339, 13340, 13341, 13342, 13343, 13344, 13345, 13346, 13347, 13348, 12101, 12102, 12103, 12104, 12105, 12106, 13351, 13352, 13353, 13354, 13355, 13356, 12038, 12039, 12040, 12041, 12042, 12043, 13373, 13374, 13375, 13376, 13377, 13378, 13379, 13380, 13381, 13382, 13383, 13384, 13385, 13386, 13387, 13388, 13389, 13390, 13391, 13392, 13393, 13394, 13395, 13396, 13397, 13398, 13399, 13400, 13401, 13403, 12047, 12048, 12049, 12050, 12051, 13584, 13585, 13586, 13587, 13588, 13589, 13590, 13591, 13592, 13593, 13594, 13077, 13078, 13079, 13080, 13082, 13083, 13084, 13085, 13086, 13087, 13620, 13621, 13622, 13623, 13624, 13625, 13626, 13627, 13628, 13629, 13630, 13631, 13632, 13633, 13634, 13635, 13636, 13637, 13638, 13639, 13640, 13641, 13642, 13643, 13644, 13645, 13646, 13647, 13648, 13649, 13650, 13651, 13652, 13653, 13654, 13655, 13656, 13657, 13708, 13709, 13710, 13711, 13712, 13735, 13736, 13737, 13738, 13739, 13740, 13741, 13742, 13743, 13749, 13750, 13751, 13752, 13753, 13754, 13755, 13756, 13757, 13758, 13759, 13760, 13762, 13763, 13764, 13793, 13794, 13799, 13816, 13817, 13840, 13841, 13846, 13863, 13864, 13869, 13870, 13871, 13872, 13873, 13874, 13884, 13885, 13886, 13887, 13905, 13906, 13907, 13908, 13909, 13910, 13915, 13916, 13917, 13918, 13919, 13921, 13922, 13923, 13924, 13925, 13928, 13929, 13930, 13931, 13932, 13933, 13935, 13936, 13939, 13940, 13944, 13945, 13946, 13947, 13948, 13949, 13950, 13951, 13953, 13954, 13955, 13956, 13957, 13958, 13959, 13960, 13961, 13962, 13963, 13964, 12675, 12676, 12677, 12678, 12679, 12680, 13966, 13967, 13968, 13969, 13970, 13998, 13999, 14000, 14001, 14003, 14004, 14005, 14006, 14007, 14008, 14011, 14012, 14013, 14014, 14015, 14016, 14018, 14019, 14020, 14021, 14022, 14023, 14024, 14025, 14026, 14027, 14028, 14037, 14038, 14039, 14040, 14041, 14042, 14043, 14044, 14045, 14046, 14047, 14048, 14049, 14055, 14056, 14057, 14058, 14062, 14063, 14064, 14065, 14066, 14067, 14068, 14069, 14070, 14071, 14072, 14073, 14074, 14075, 14076, 14077, 14078, 14079, 14080, 14081, 14082, 14083, 14084, 14085, 14086, 14087, 14088, 14089, 14090, 14091, 14093, 14094, 14095, 14096, 14097, 14098, 14099, 14100, 14101, 14102, 14111, 14112, 14142, 14143, 14144, 14145, 14152, 14153, 14154, 14155, 14156, 14157, 14158, 14159, 14161, 14162, 14163, 14164, 14165, 14166, 14167, 14168, 14169, 14170, 14171, 14172, 14175, 14176, 14177, 14178, 14181, 14182, 14183, 14184, 14185, 14186, 14187, 14188, 14189, 14190, 14191, 14192, 14193, 14194, 14201, 14202, 14203, 14204, 14206, 14207, 14208, 14209, 14210, 14211, 14212, 14213, 14214, 14215, 14216, 14217, 14218, 14219, 14220, 14221, 14222, 14223, 14225, 14226, 14227, 14228, 14229, 14230, 14235, 14236, 14237, 14238, 14239, 14244, 14245, 14246, 14247, 14248, 14249, 14250, 14251, 14252, 14253, 14254, 14255, 14258, 14259, 14260, 14263, 14264, 14265, 14266, 14267, 14268, 14271, 14272, 14273, 14274, 14276, 14277, 14278, 14279, 14280, 14281, 14282, 14283, 14284, 14285, 14286, 14287, 14288, 14289, 14290, 14291, 14292, 14293, 14294, 14295, 14296, 14297, 12681, 12683, 12684, 14300, 14301, 14302, 14303, 14304, 14305, 14307, 14308, 14309, 14322, 14323, 14324, 14325, 14326, 14327, 14328, 14329, 14330, 14331, 14332, 14333, 14345, 14346, 14347, 14348, 14349, 14350, 14351, 14352, 14353, 14354, 14355, 14356, 14357, 14358, 14359, 14360, 14361, 14362, 14363, 14364, 14365, 14366, 14367, 14375, 14376, 14377, 14378, 14379, 14380, 14381, 14382, 14383, 14384, 14385, 14386, 14387, 14388, 14389, 14390, 14395, 14396, 14397, 14398, 14399, 14400, 14401, 14403, 14404, 14405, 14406, 14407, 14408, 14410, 14411, 14412, 14414, 14415, 14416, 14417, 14418, 14419, 14420, 14421, 14422, 14423, 14424, 14425, 14426, 14427, 14428, 14429, 14430, 14431, 14432, 14433, 14434, 14435, 14436, 14437, 14438, 14439, 14441, 14442, 14443, 14444, 14445, 14446, 14447, 14448, 14449, 14450, 14451, 14452, 14453, 14454, 14455, 14456, 14457, 14458, 14462, 14463, 14464, 14465, 14466, 14467, 14469, 14470, 14471, 14472, 14473, 14474, 14475, 14476, 14477, 14478, 14479, 14480, 14481, 14482, 14483, 14484, 14485, 14486, 14487, 14488, 14489, 14490, 14496, 14497, 14498, 14499, 14500, 14506, 14507, 14508, 14509, 14510, 14511, 14513, 14514, 14515, 14516, 14517, 14518, 14519, 14520, 14521, 14545, 14546, 14551, 14552, 14553, 14554, 14561, 14562, 14563, 14564, 14580, 14581, 14593, 14594, 14595, 14596, 14597, 14598, 14599, 14600, 14601, 14602, 14603, 14604, 14605, 13744, 13745, 13746, 13747, 13748, 14606, 14607, 14608, 14609, 14610, 14611, 14620, 14621, 14622, 14623, 14624, 14630, 14629, 14632, 14633, 14631, 14638, 14639, 14640, 14641, 14642, 14643, 14646, 14647, 14648, 14649, 14650, 14651, 14652, 14653, 14654, 14655, 14656, 14657, 14658, 14659, 14660, 14661, 14662, 14663, 14664, 14665, 14666, 14667, 14668, 14669, 14670, 14671, 14672, 14673, 14674, 14675, 12824, 12825, 12826, 12827, 12828, 14677, 14678, 14679, 14680, 14681, 14682, 14683, 14684, 14685, 14686, 14687, 14688, 14689, 14691, 14692, 14693, 14695, 14696, 14697, 14698, 14699, 14700, 14701, 14702, 14704, 14705, 14706, 14708, 14709, 14710, 14711, 14712, 14713, 14714, 14715, 14716, 14717, 14718, 14719, 14720, 14721, 14722, 14723, 14724, 14725, 14726, 14727, 14728, 14729, 14730, 14731, 14732, 14733, 14734, 14735, 14736, 14737, 14738, 14739, 14740, 14741, 14742, 14743, 14744, 14745, 14746, 14747, 14748, 14749, 14750, 14751, 14752, 14753, 14754, 14755, 14756, 14757, 14758, 14759, 14760, 14761, 14762, 14763, 14764, 14765, 14766, 14767, 14768, 14769, 14770, 14771, 14772, 14773, 14774, 14775, 14776, 14777, 14778, 14779, 14780, 14781, 14782, 14783, 14784, 14785, 14786, 14787, 14788, 14789, 14790, 14791, 14792, 14793, 14794, 14795, 14797, 14798, 14799, 14801, 14802, 14803, 14804, 14805, 14806, 14807, 14808, 14810, 14811, 14812, 14813, 14814, 14815, 14817, 14818, 14819, 14820, 14821, 14822, 14832, 14833, 14834, 14835, 14836, 14837, 14838, 14839, 14840, 14841, 14842, 14843, 14845, 14846, 14847, 14853, 14854, 14855, 14856, 14857, 14858, 14861, 14862, 14863, 14864, 14865, 14867, 14868, 14869, 14870, 14871, 11979, 11980, 11981, 12029, 12030, 12031, 14885, 14886, 14887, 14888, 14889, 14890, 14891, 14892, 14893, 14894, 14895, 14897, 14898, 14899, 14900, 14901, 14903, 14904, 14905, 14906, 14907, 14908, 14910, 14911, 14912, 14913, 14914, 14915, 14916, 14917, 14918, 14920, 14921, 14927, 14928, 14929, 14930, 14931, 14932, 14933, 14934, 14935, 14936, 14937, 14938, 14939, 14941, 14942, 14945, 14946, 14947, 14948, 14950, 14951, 14953, 14954, 14955, 14956, 14957, 14960, 14961, 14962, 14963, 14964, 14965, 14966, 14967, 14968, 14969, 14970, 14971, 14972, 14973, 14974, 14975, 14976, 14977, 14978, 14979, 14980, 14981, 14982, 14983, 14984, 14985, 14986, 14987, 14988, 14992, 14993, 14994, 14995, 14996, 14997, 14998, 14999, 15000, 15001, 15002, 15003, 15004, 15005, 15011, 15012, 15013, 15014, 15015, 15016, 15018, 15019, 15020, 15021, 15022, 15023, 15024, 15025, 15026, 15027, 15028, 15029, 15034, 15035, 15036, 15037, 15038, 15039, 15041, 15042, 15043, 15044, 15045, 15046, 15047, 15048, 15055, 15056, 15057, 15058, 15059, 15060, 15062, 15063, 15064, 15065, 15066, 15067, 15068, 15069, 15070, 15071, 15074, 15075, 15076, 15077, 15078, 15079, 15080, 15081, 15082, 15083, 15084, 15085, 15086, 15087, 15088, 15089, 15090, 15093, 15094, 15095, 15096, 15097, 15098, 15099, 15100, 15101, 15102, 15103, 15104, 15105, 15106, 15107, 15108, 15109, 15111, 15112, 15113, 15114, 15115, 15116, 15117, 15118, 15119, 15120, 15121, 15122, 15123, 15124, 15125, 15126, 15127, 15128, 15129, 15130, 15131, 15132, 15133, 15134, 15135, 15136, 15137, 15138, 15139, 15140, 15141, 15142, 15143, 15144, 15145, 15146, 15147, 15148, 15149, 15150, 15151, 15152, 15153, 15154, 15155, 15156, 15157, 15160, 15161, 15162, 15163, 15164, 15165, 15166, 15167, 15168, 15169, 15170, 15171, 15172, 15173, 15174, 15175, 15176, 15177, 15178, 15179, 15180, 15181, 15182, 15183, 15184, 15185, 15186, 15187, 15189, 15190, 15191, 15192, 15193, 15198, 15199, 15200, 15201, 15202, 15204, 15205, 15206, 15208, 15209, 15210, 15211, 15213, 15214, 15215, 15217, 15218, 15219, 15221, 15222, 15223, 15225, 15226, 15227, 15229, 15230, 15231, 15233, 15234, 15235, 15237, 15238, 15239, 15241, 15242, 15243, 15245, 15246, 15247, 15249, 15250, 15251, 15253, 15254, 15255, 15257, 15258, 15259, 15260, 15261, 15262, 15263, 15264, 15266, 15267, 15268, 15270, 15271, 15272, 15273, 15274, 15275, 15276, 15277, 15278, 15279, 15280, 15281, 15282, 15283, 15285, 15286, 15287, 15289, 15290, 15291, 15293, 15294, 15295, 15297, 15298, 15299, 15301, 15302, 15303, 15305, 15306, 15307, 15309, 15310, 15311, 15313, 15314, 15315, 15317, 15318, 15319, 15321, 15322, 15323, 15325, 15326, 15327, 15329, 15330, 15331, 15333, 15334, 15335, 15336, 15337, 15338, 15339, 15340, 15342, 15343, 15344, 15346, 15347, 15348, 15350, 15351, 15352, 15354, 15355, 15356, 15358, 15359, 15360, 15362, 15363, 15364, 15366, 15367, 15368, 15370, 15371, 15372, 15374, 15375, 15376, 15377, 15378, 15379, 15380, 15381, 15382, 15384, 15385, 15386, 15388, 15389, 15390, 15391, 15392, 15393, 15394, 15395, 15397, 15398, 15399, 15401, 15402, 15403, 15405, 15406, 15407, 15408, 15409, 15410, 15411, 15412, 15413, 15415, 15416, 15417, 15419, 15420, 15421, 15423, 15424, 15425, 15427, 15428, 15429, 15431, 15432, 15433, 15435, 15436, 15437, 15439, 15440, 15441, 15443, 15444, 15445, 15447, 15448, 15449, 15451, 15452, 15453, 15455, 15456, 15457, 15459, 15460, 15461, 15463, 15464, 15465, 15467, 15468, 15469, 15471, 15472, 15473, 15475, 15476, 15477, 15479, 15480, 15481, 15483, 15484, 15485, 15487, 15488, 15489, 15490, 15491, 15492, 15493, 15494, 15496, 15497, 15498, 15500, 15501, 15502, 15504, 15505, 15506, 15508, 15509, 15510, 15512, 15513, 15514, 15516, 15517, 15518, 15520, 15521, 15522, 15524, 15525, 15526, 15528, 15529, 15530, 15532, 15533, 15534, 15536, 15537, 15538, 15540, 15541, 15542, 15544, 15545, 15546, 15548, 15549, 15550, 15552, 15553, 15554, 15555, 15556, 15557, 15558, 15559, 15560, 15561, 15562, 15563, 15564, 15566, 15567, 15568, 15569, 15570, 15571, 15572, 15573, 15574, 15575, 15576, 15577, 15578, 15579, 11465, 11466, 11467, 11468, 11469, 15580, 15581, 15582, 15583, 15584, 15586, 15587, 15588, 15590, 15591, 15592, 15594, 15595, 15596, 15598, 15599, 15600, 15602, 15603, 15604, 15606, 15607, 15608, 15610, 15611, 15612, 15614, 15615, 15616, 15618, 15619, 15620, 15622, 15623, 15624, 15626, 15627, 15628, 15630, 15631, 15632, 15634, 15635, 15636, 15638, 15639, 15640, 15642, 15643, 15644, 15646, 15647, 15648, 15650, 15651, 15652, 15654, 15655, 15656, 15657, 15658, 15659, 15660, 15661, 15663, 15664, 15665, 15667, 15668, 15669, 15671, 15672, 15673, 15675, 15676, 15677, 15679, 15680, 15681, 15683, 15684, 15685, 15687, 15688, 15689, 15691, 15692, 15693, 15695, 15696, 15697, 15699, 15700, 15701, 15703, 15704, 15705, 15707, 15708, 15709, 15711, 15712, 15713, 15715, 15716, 15717, 15719, 15720, 15721, 15723, 15724, 15725, 15727, 15728, 15729, 15730, 15731, 15732, 15733, 15734, 15736, 15737, 15738, 15740, 15741, 15742, 15744, 15745, 15746, 15748, 15749, 15750, 15751, 15752, 15753, 15754, 15755, 15757, 15758, 15759, 15762, 15763, 15764, 15765, 15766, 15767, 15772, 15773, 15777, 15778, 11729, 11730, 11731, 11732, 11733, 11734, 15794, 15795, 15837, 15838, 15839, 15840, 15841, 15842, 15843, 15844, 15845, 15849, 15850, 15851, 15852, 15853, 15854, 15855, 15856, 15857, 15858, 15859, 15860, 15861, 15862, 15863, 15866, 15867, 15868, 15869, 15870, 15889, 15890, 15891, 15892, 15893, 15894, 15895, 15896, 15897, 15898, 15899, 15900, 15901, 15902, 15903, 15907, 15908, 15909, 15910, 15911, 15912, 15921, 15922, 15923, 15925, 15926, 15927, 15928, 15929, 15930, 15931, 15933, 15934, 15935, 15936, 15937, 15938, 15939, 15948, 15949, 15950, 15951, 15952, 15953, 15954, 15955, 15956, 15957, 15958, 15959, 15964, 15965, 15966, 15967, 15969, 15970, 15971, 15973, 15974, 15975, 15991, 15992, 15993, 15999, 16007, 16008, 16009, 16010, 16011, 16012, 16013, 16014, 16015, 16016, 16021, 16022, 16074, 16075, 16078, 16079, 16085, 16086, 16090, 16091, 16241, 16242, 16583, 16584, 16585, 16586, 16587, 16588, 16589, 16590, 16591, 16592, 16593, 16594, 16595, 16557, 2327) AND states.last_updated_ts > 1733999399.999999e0 AND states.last_updated_ts < 1733999700.0e0) AS anon_4) AS anon_1 ORDER BY anon_1.metadata_id, anon_1.last_updated_ts\r\n\nI have similar issue, but with 7GB SQLite. My issue is increased CPU usage for ~25 sec every 5 minutes. It starts happening from  2024.12.0b2.  2024.12.0b1 was good. Can someone confirm, that  2024.12.0b1 is still good, while  2024.12.0b2 is where it starts happening?\r\nAlso it only happening when shelly integration is enabled (it has quite noisy shelly em3 pro power usage sensors)\r\nAlso can I trace SQLite slowness and confirm, that we have same issue?\r\n\r\n![image](https://github.com/user-attachments/assets/ae5a2b53-96e9-4414-8c58-9610edce6418)\r\n\nI  have  2024,12,1 and its faulty, if ithis issue is HW related , dont know yet, I will try the official power supply on the next days, if this doesnt make any difference, i will go back from SSD to an SD card. \r\nIn any case I didnt notice cpu peaks like in your graph\nHow do you see the SQL DB  size?\n> [nikplas](/nikplas)\r\n\r\nIf you use default sqlite then it's a file: \\config\\home-assistant_v2.db\nThanks to those who have provided databases for testing so far.  Once I have a few more to validate optimizations, I'll start working on a solution.  I'll wait until Monday to give everyone a chance to send them in and work with what I have.  If you want to be sure your case is considered please be sure to get it to be before Monday.\nAlso don't forget to send in the query it's stuck on with the database as I'll need to validate  a rewritten query against the one that was being run once we have a solution \n@bdraco any way I could determine query in SQLite?\r\nAnd either way would my SQLite db file be useful? :-)\n> @bdraco any way I could determine query in SQLite?\n> \n> And either way would my SQLite db file be useful? :-)\n\nYou can turn on debug logging for `sqlalchemy` even info level is probably enough. \n\nAnd yes it would be useful \n> Thanks to those who have provided databases for testing so far. Once I have a few more to validate optimizations, I'll start working on a solution. I'll wait until Monday to give everyone a chance to send them in and work with what I have. If you want to be sure your case is considered please be sure to get it to be before Monday.\r\n\r\nI've sent you an e-mail with a download link to my PSQL dump.\nI've been busy with the dreaded \"OnCall Rotation\" this week kind of lost track of this issue - do you need a mysql dump/query set? or are you good?\n> I've been busy with the dreaded \"OnCall Rotation\" this week kind of lost track of this issue - do you need a mysql dump/query set? or are you good?\n\nYes. Still could use a few more test databases to make sure whatever optimizations I work on next week are effective. \nSent a GDrive share with the db dump and the slow.log - you can all see my original slow/killed queries above.\r\n\r\nFrom:\r\n```mysql> select version();\r\n+----------------------------+\r\n| version()                  |\r\n+----------------------------+\r\n| 11.6.2-MariaDB-ubu2404-log |\r\n+----------------------------+\r\n1 row in set (0.00 sec)\r\n```\nsame as #132525 \nIf you are using postgresql and have held off sending in data for testing and optimization, please try to do it soon as I'm starting working on this and don't want postgresql users left in the cold because I didn't have enough data to optimize for all the possible cases.\nIt looks like we are hitting some internal optimization limit in MySQL/MariaDB\r\n\r\nAs soon as we get over 999 metadata_ids\r\n\r\n\r\n<1000 is fine\r\n\r\n```\r\n+------+-------------+--------+-------+-----------------------------------------------------------------+---------------------------------------+---------+------+------+---------------------------------------+\r\n| id   | select_type | table  | type  | possible_keys                                                   | key                                   | key_len | ref  | rows | Extra                                 |\r\n+------+-------------+--------+-------+-----------------------------------------------------------------+---------------------------------------+---------+------+------+---------------------------------------+\r\n|    1 | SIMPLE      | states | range | ix_states_last_updated_ts,ix_states_metadata_id_last_updated_ts | ix_states_metadata_id_last_updated_ts | 18      | NULL | 999  | Using where; Using index for group-by |\r\n+------+-------------+--------+-------+-----------------------------------------------------------------+---------------------------------------+---------+------+------+---------------------------------------+\r\n1 row in set (0.010 sec)\r\n```\r\n\r\n\r\nwhere-as >=1000, the query optimizes completely differently \r\n\r\n```\r\n+------+-------------+------------+------+-----------------------------------------------------------------+---------------------------------------+---------+--------------+------+---------------------------------+\r\n| id   | select_type | table      | type | possible_keys                                                   | key                                   | key_len | ref          | rows | Extra                           |\r\n+------+-------------+------------+------+-----------------------------------------------------------------+---------------------------------------+---------+--------------+------+---------------------------------+\r\n|    1 | PRIMARY     | <derived3> | ALL  | distinct_key                                                    | NULL                                  | NULL    | NULL         | 1396 | Using temporary; Using filesort |\r\n|    1 | PRIMARY     | states     | ref  | ix_states_last_updated_ts,ix_states_metadata_id_last_updated_ts | ix_states_metadata_id_last_updated_ts | 9       | tvc_0._col_1 | 558  | Using where; Using index        |\r\n|    3 | DERIVED     | NULL       | NULL | NULL                                                            | NULL                                  | NULL    | NULL         | NULL | No tables used                  |\r\n+------+-------------+------------+------+-----------------------------------------------------------------+---------------------------------------+---------+--------------+------+---------------------------------+\r\n```\r\n\r\n\r\nThis is the problem query\r\n```sql\r\nSELECT states.metadata_id          AS max_metadata_id,\r\n       Max(states.last_updated_ts) AS max_last_updated\r\nFROM   states\r\nWHERE  states.last_updated_ts >= 1732708152.6401002e0\r\n       AND states.last_updated_ts < 1734107999.999999e0\r\n       AND states.metadata_id IN ( 222, 223, 224, 50501,\r\n                                   50518, 50535, 50564, 50581,\r\n                                   50598, 389, 49770, 391,\r\n                                   49772, 394, 395, 397,\r\n                                   32307, 32308, 32310, 32371,\r\n                                   235, 236, 237, 238,\r\n                                   239, 299, 300, 31826,\r\n                                   31808, 31813, 31825, 31829,\r\n                                   302, 303, 304, 305,\r\n                                   306, 307, 371, 246,\r\n                                   248, 251, 31965, 31966,\r\n                                   31967, 31968, 31969, 10809,\r\n                                   10810, 34465, 10813, 10812,\r\n                                   10814, 10816, 10817, 10818,\r\n                                   42219, 42217, 42221, 42222,\r\n                                   49716, 42223, 10826, 10828,\r\n                                   10830, 45857, 10832, 10831,\r\n                                   10833, 10834, 42224, 45850,\r\n                                   10837, 10839, 10838, 10840,\r\n                                   10836, 10842, 10843, 10844,\r\n                                   50378, 10845, 10846, 49717,\r\n                                   49971, 42226, 10851, 42227,\r\n                                   10909, 49975, 10854, 10855,\r\n                                   42228, 42229, 10858, 10859,\r\n                                   10861, 42230, 42231, 10864,\r\n                                   42232, 34537, 10867, 49842,\r\n                                   50294, 10869, 10870, 42233,\r\n                                   42234, 10874, 49718, 10878,\r\n                                   10880, 10881, 42236, 10883,\r\n                                   10884, 10885, 49720, 49721,\r\n                                   10890, 10891, 10893, 50675,\r\n                                   50394, 10898, 42238, 49722,\r\n                                   49723, 50297, 10902, 10903,\r\n                                   10904, 10905, 42239, 49785,\r\n                                   42240, 10825, 42242, 10913,\r\n                                   45592, 10916, 45565, 50412,\r\n                                   42541, 10919, 10920, 10921,\r\n                                   45895, 10923, 42243, 10926,\r\n                                   10927, 49728, 49724, 10931,\r\n                                   42246, 10933, 42247, 42248,\r\n                                   42249, 42250, 10972, 49725,\r\n                                   49726, 10940, 49727, 42253,\r\n                                   10943, 42254, 10945, 10960,\r\n                                   49719, 10911, 10922, 42220,\r\n                                   45556, 10822, 10985, 10895,\r\n                                   34469, 10824, 34473, 10841,\r\n                                   34474, 10872, 10853, 34475,\r\n                                   10906, 10934, 10957, 34486,\r\n                                   34493, 34501, 34505, 10970,\r\n                                   34545, 10971, 34557, 10975,\r\n                                   34559, 34561, 34568, 45263,\r\n                                   45270, 45273, 45302, 45534,\r\n                                   45537, 45540, 45543, 45546,\r\n                                   45549, 45553, 45559, 45562,\r\n                                   45567, 45571, 45581, 45584,\r\n                                   45590, 45596, 10924, 45603,\r\n                                   45750, 45760, 10961, 11008,\r\n                                   10962, 42241, 10954, 10900,\r\n                                   45752, 10965, 10946, 45754,\r\n                                   10980, 10966, 45867, 45880,\r\n                                   45885, 10964, 10974, 45893,\r\n                                   49843, 45897, 42244, 45899,\r\n                                   45901, 45903, 45905, 45907,\r\n                                   45909, 45931, 45948, 45950,\r\n                                   45952, 45954, 45956, 45963,\r\n                                   45965, 45967, 45972, 45974,\r\n                                   45976, 45978, 45980, 45987,\r\n                                   45989, 45991, 45993, 45995,\r\n                                   45997, 45999, 46001, 46003,\r\n                                   46005, 46007, 46009, 46011,\r\n                                   46013, 46015, 46017, 46019,\r\n                                   46021, 46023, 46025, 46027,\r\n                                   46029, 46031, 46033, 46035,\r\n                                   46037, 46039, 46041, 46043,\r\n                                   46045, 46047, 46049, 46051,\r\n                                   46086, 46088, 46090, 46092,\r\n                                   46094, 46096, 46098, 46100,\r\n                                   49962, 49967, 46102, 46104,\r\n                                   50008, 50011, 50013, 50015,\r\n                                   50022, 50043, 50062, 50071,\r\n                                   50073, 50076, 50106, 50114,\r\n                                   50165, 50170, 50173, 50309,\r\n                                   50312, 50331, 50335, 50344,\r\n                                   50346, 50354, 50357, 50360,\r\n                                   50363, 50366, 50369, 50373,\r\n                                   50375, 50391, 50397, 50402,\r\n                                   50409, 50415, 50418, 50475,\r\n                                   50478, 50481, 50484, 50487,\r\n                                   50606, 50616, 50619, 50621,\r\n                                   50625, 50668, 21117, 21118,\r\n                                   34466, 21121, 21120, 21122,\r\n                                   21124, 21125, 21126, 42257,\r\n                                   42255, 42259, 42260, 49729,\r\n                                   42261, 21134, 21136, 21138,\r\n                                   45858, 21140, 21139, 21141,\r\n                                   21142, 42262, 45851, 21145,\r\n                                   21147, 21146, 21148, 21144,\r\n                                   21150, 21151, 21152, 50379,\r\n                                   21153, 21154, 49730, 49972,\r\n                                   42264, 21159, 42265, 21217,\r\n                                   49976, 21162, 21163, 42266,\r\n                                   42267, 21166, 21167, 21169,\r\n                                   42268, 42269, 21172, 42270,\r\n                                   34538, 21175, 49844, 50295,\r\n                                   21177, 21178, 42271, 42272,\r\n                                   21182, 49731, 21186, 21188,\r\n                                   21189, 42274, 21191, 21192,\r\n                                   21193, 49733, 49734, 21198,\r\n                                   21199, 21201, 50676, 50395,\r\n                                   21206, 42276, 49735, 49736,\r\n                                   50298, 21210, 21211, 21212,\r\n                                   21213, 42277, 49786, 42278,\r\n                                   21133, 42280, 21221, 45593,\r\n                                   21224, 45566, 50413, 42542,\r\n                                   21227, 21228, 21229, 45896,\r\n                                   21231, 42281, 21234, 21235,\r\n                                   49741, 49737, 21239, 42284,\r\n                                   21241, 42285, 42286, 42287,\r\n                                   42288, 21280, 49738, 49739,\r\n                                   21248, 49740, 42291, 21251,\r\n                                   42292, 21253, 21268, 49732,\r\n                                   21219, 21230, 42258, 45557,\r\n                                   21130, 21293, 21203, 34470,\r\n                                   21132, 34477, 21149, 34478,\r\n                                   21180, 21161, 34479, 21214,\r\n                                   21242, 21265, 34487, 34494,\r\n                                   34502, 34506, 21278, 34546,\r\n                                   21279, 34558, 21283, 34560,\r\n                                   34562, 34569, 45264, 45271,\r\n                                   45274, 45303, 45535, 45538,\r\n                                   45541, 45544, 45547, 45550,\r\n                                   45554, 45560, 45563, 45568,\r\n                                   45572, 45582, 45585, 45591,\r\n                                   45597, 21232, 45604, 45751,\r\n                                   45761, 21269, 21316, 21270,\r\n                                   42279, 21262, 21208, 45753,\r\n                                   21273, 21254, 45755, 21288,\r\n                                   21274, 45868, 45881, 45886,\r\n                                   21272, 21282, 45894, 49845,\r\n                                   45898, 42282, 45900, 45902,\r\n                                   45904, 45906, 45908, 45910,\r\n                                   45932, 45949, 45951, 45953,\r\n                                   45955, 45957, 45964, 45966,\r\n                                   45968, 45973, 45975, 45977,\r\n                                   45979, 45981, 45988, 45990,\r\n                                   45992, 45994, 45996, 45998,\r\n                                   46000, 46002, 46004, 46006,\r\n                                   46008, 46010, 46012, 46014,\r\n                                   46016, 46018, 46020, 46022,\r\n                                   46024, 46026, 46028, 46030,\r\n                                   46032, 46034, 46036, 46038,\r\n                                   46040, 46042, 46044, 46046,\r\n                                   46048, 46050, 46052, 46087,\r\n                                   46089, 46091, 46093, 46095,\r\n                                   46097, 46099, 46101, 49963,\r\n                                   49968, 46103, 46105, 50009,\r\n                                   50012, 50014, 50016, 50023,\r\n                                   50044, 50063, 50072, 50074,\r\n                                   50077, 50107, 50115, 50166,\r\n                                   50171, 50174, 50310, 50313,\r\n                                   50332, 50336, 50345, 50347,\r\n                                   50355, 50358, 50361, 50364,\r\n                                   50367, 50370, 50374, 50376,\r\n                                   50392, 50398, 50403, 50410,\r\n                                   50416, 50419, 50476, 50479,\r\n                                   50482, 50485, 50488, 50607,\r\n                                   50617, 50620, 50622, 50626,\r\n                                   50669, 31525, 31526, 31527,\r\n                                   31528, 31571, 49965, 31574,\r\n                                   31573, 31575, 50329, 31576,\r\n                                   31577, 31579, 31578, 31572,\r\n                                   31581, 31582, 31583, 31584,\r\n                                   31585, 31586, 31587, 31588,\r\n                                   49966, 31591, 31590, 31592,\r\n                                   50330, 31593, 31594, 31596,\r\n                                   31595, 31589, 31598, 31599,\r\n                                   31600, 31601, 31602, 31603,\r\n                                   31604, 32146, 32150, 32151,\r\n                                   32152, 32156, 32157, 32158,\r\n                                   32162, 32163, 32164, 32168,\r\n                                   32169, 32170, 32174, 32175,\r\n                                   32176, 32180, 32181, 32182,\r\n                                   32186, 32187, 32199, 32134,\r\n                                   32030, 32034, 32035, 32036,\r\n                                   32040, 32041, 32042, 32046,\r\n                                   32047, 32048, 32052, 32053,\r\n                                   32054, 32058, 32059, 32060,\r\n                                   32064, 32065, 32066, 32070,\r\n                                   32071, 49788, 49792, 49793,\r\n                                   49794, 49798, 49799, 49800,\r\n                                   49804, 49805, 49806, 49810,\r\n                                   49811, 49812, 49816, 49817,\r\n                                   49818, 49822, 49823, 49824,\r\n                                   49828, 49829, 32081, 32085,\r\n                                   32086, 32087, 32091, 32092,\r\n                                   32093, 32097, 32098, 32099,\r\n                                   32103, 32104, 32105, 32109,\r\n                                   32110, 32111, 32115, 32116,\r\n                                   32117, 32121, 32122, 32141,\r\n                                   32204, 32208, 32209, 32210,\r\n                                   32214, 32215, 32216, 32220,\r\n                                   32221, 32222, 32226, 32227,\r\n                                   32228, 32232, 32233, 32234,\r\n                                   32238, 32239, 32240, 32244,\r\n                                   32245, 316, 317, 318,\r\n                                   323, 31922, 31927, 31932,\r\n                                   31937, 31942, 31947, 31948,\r\n                                   45941, 45942, 48118, 48119,\r\n                                   31763, 31764, 31774, 31775,\r\n                                   48075, 48076, 48105, 48106,\r\n                                   31769, 31770, 48048, 48049,\r\n                                   48134, 48135, 45918, 45919,\r\n                                   31758, 31759, 31784, 31785,\r\n                                   31786, 31787, 31788, 31789,\r\n                                   31790, 31791, 32906, 32910,\r\n                                   32938, 32942, 32975, 32979,\r\n                                   45612, 32988, 32989, 32990,\r\n                                   32991, 33003, 45763, 32995,\r\n                                   32996, 32997, 32998, 45766,\r\n                                   33004, 33005, 33006, 33007,\r\n                                   33012, 33013, 33014, 33011,\r\n                                   45842, 33146, 33147, 33148,\r\n                                   33149, 33150, 33151, 33152,\r\n                                   33153, 33154, 33113, 33114,\r\n                                   33115, 33116, 33117, 33118,\r\n                                   33119, 33120, 33121, 33122,\r\n                                   33123, 33124, 33125, 33126,\r\n                                   33127, 33128, 33129, 33130,\r\n                                   33131, 33160, 33161, 33162,\r\n                                   33163, 33164, 33165, 33166,\r\n                                   33167, 33235, 33236, 33237,\r\n                                   33238, 33239, 33240, 33241,\r\n                                   33242, 33243, 33244, 33245,\r\n                                   33246, 33247, 33248, 33249,\r\n                                   33172, 33173, 33174, 33175,\r\n                                   33176, 33177, 33178, 33179,\r\n                                   33180, 33181, 33182, 33183,\r\n                                   33184, 33185, 33186, 33187,\r\n                                   33188, 33189, 33190, 33191,\r\n                                   33192, 33193, 33194, 33195,\r\n                                   33216, 33217, 33218, 33219,\r\n                                   33220, 33221, 33222, 33223,\r\n                                   33224, 33225, 33226, 33227,\r\n                                   33261, 33264, 33265, 33102,\r\n                                   33105, 33106, 32702, 32703,\r\n                                   32704, 32706, 32707, 32708,\r\n                                   32709, 32710, 32711, 32712,\r\n                                   32713, 32714, 32715, 32716,\r\n                                   32717, 32720, 32721, 32722,\r\n                                   32723, 32724, 32725, 32726,\r\n                                   32727, 32728, 32729, 32732,\r\n                                   32738, 32739, 32740, 32749,\r\n                                   32750, 32751, 32752, 32753,\r\n                                   32755, 32757, 35876, 35877,\r\n                                   35878, 35879, 49980, 33374,\r\n                                   33382, 33383, 33384, 33395,\r\n                                   33396, 33397, 33398, 33399,\r\n                                   33400, 33402, 33408, 33410,\r\n                                   33409, 33411, 33415, 33420,\r\n                                   33421, 33422, 33427, 33429,\r\n                                   33430, 33431, 33436, 33439,\r\n                                   33442, 33443, 33444, 33451,\r\n                                   33452, 33453, 33460, 33461,\r\n                                   33462, 33469, 33472, 33473,\r\n                                   33474, 33475, 33476, 33478,\r\n                                   33484, 33486, 33487, 33488,\r\n                                   33489, 33493, 33495, 33496,\r\n                                   33497, 33498, 33502, 33504,\r\n                                   33505, 33506, 33507, 33511,\r\n                                   33513, 33514, 33516, 33520,\r\n                                   33523, 49984, 50094, 50095,\r\n                                   50096, 50097, 50098, 50099,\r\n                                   50100, 50101, 50102, 50103,\r\n                                   50104, 50105, 33547, 33548,\r\n                                   34949, 49989, 33794, 33795,\r\n                                   33796, 33797, 33798, 33799,\r\n                                   33985, 33995, 34002, 34009,\r\n                                   49994, 50161, 50025, 50026,\r\n                                   50027, 50028, 50029, 50031,\r\n                                   50059, 33365, 33366, 33367,\r\n                                   33368, 34398, 34402, 34403,\r\n                                   34404, 34419, 34422, 34423,\r\n                                   34424, 34425, 34426, 34427,\r\n                                   34429, 34432, 34433, 34434,\r\n                                   34440, 34442, 34443, 34446,\r\n                                   34448, 34450, 34451, 34453,\r\n                                   34456, 34499, 34509, 34510,\r\n                                   34511, 34512, 34513, 34514,\r\n                                   34516, 34517, 34518, 34519,\r\n                                   34520, 34521, 34523, 34530,\r\n                                   34531, 34532, 34533, 34534,\r\n                                   34553, 32611, 32612, 32615,\r\n                                   32616, 32617, 32618, 32619,\r\n                                   32620, 32621, 32623, 32627,\r\n                                   32629, 32631, 32633, 32634,\r\n                                   34599, 34604, 34638, 34669,\r\n                                   34693, 34728, 34766, 34768,\r\n                                   34772, 34787, 34808, 34941,\r\n                                   34972, 34979, 34987, 34999,\r\n                                   35004, 35015, 35017, 35019,\r\n                                   35021, 35026, 35029, 35034,\r\n                                   35036, 35041, 35043, 35045,\r\n                                   35052, 35057, 35059, 33369,\r\n                                   35061, 35063, 35065, 35081,\r\n                                   35089, 35093, 35095, 35114,\r\n                                   35119, 35121, 35123, 35125,\r\n                                   35127, 35129, 35131, 35136,\r\n                                   35138, 35140, 35142, 35144,\r\n                                   35155, 35181, 35186, 35191,\r\n                                   35211, 35213, 35215, 35222,\r\n                                   35224, 35232, 35234, 35236,\r\n                                   35238, 35240, 35248, 35259,\r\n                                   35268, 35279, 35281, 35283,\r\n                                   35285, 35287, 35289, 35291,\r\n                                   35296, 35298, 35300, 35302,\r\n                                   35304, 35320, 35322, 35324,\r\n                                   35326, 35328, 35330, 35332,\r\n                                   35334, 35336, 35338, 35340,\r\n                                   35342, 35344, 35346, 35348,\r\n                                   35350, 35352, 35354, 35356,\r\n                                   35358, 35360, 35362, 35364,\r\n                                   35366, 35368, 35370, 35372,\r\n                                   35373, 32006, 35376, 35378,\r\n                                   35380, 35382, 35384, 35386,\r\n                                   35391, 35393, 35395, 33987,\r\n                                   33986, 33988, 35398, 35400,\r\n                                   35402, 35404, 35406, 35408,\r\n                                   35410, 35412, 35414, 35416,\r\n                                   35418, 35420, 35422, 35424,\r\n                                   35426, 35428, 35430, 35432,\r\n                                   35434, 35436, 35438, 35440,\r\n                                   35442, 35444, 35447, 35449,\r\n                                   35451, 35453, 35455, 35457,\r\n                                   35459, 35461, 35463, 35465,\r\n                                   35466, 35468, 35470, 43835,\r\n                                   45575, 45577, 45871, 45873,\r\n                                   45875, 45877, 45879, 45884,\r\n                                   45889, 49847, 49851, 49852,\r\n                                   49853, 49857, 49858, 49859,\r\n                                   49863, 49864, 49865, 49869,\r\n                                   49870, 49871, 49875, 49876,\r\n                                   49877, 49881, 49882, 49883,\r\n                                   49887, 49888, 50021, 50033,\r\n                                   50035, 50037, 50039, 50129,\r\n                                   50131, 50133, 50169, 50179,\r\n                                   50340, 50387, 50390, 50406,\r\n                                   50450, 50452, 50454, 50471,\r\n                                   50473, 50491, 50615, 50667,\r\n                                   50672, 50674, 50679, 50704 )\r\nGROUP  BY states.metadata_id \r\n```\r\n\nThis doesn't seem to be documented anywhere in MySQL\r\nhttps://dev.mysql.com/doc/refman/8.4/en/group-by-optimization.html\r\n\nLooks like we will need to do a deep dive in the MySQL and MariaDB source code\nThis is the optimizer result in >= 1000\r\n```\r\nMariaDB [hass_132865_rocky]>  select * from information_schema.optimizer_trace\\G\r\n*************************** 1. row ***************************\r\n                            QUERY: explain SELECT states.metadata_id          AS max_metadata_id,\r\n       Max(states.last_updated_ts) AS max_last_updated\r\nFROM   states\r\nWHERE  states.last_updated_ts >= 1732708152.6401002e0\r\n       AND states.last_updated_ts < 1734107999.999999e0\r\n       AND states.metadata_id IN ( 222, 223, 224, 50501,\r\n                                   50518, 50535, 50564, 50581,\r\n                                   50598, 389, 49770, 391,\r\n                                   49772, 394, 395, 397,\r\n                                   32307, 32308, 32310, 32371,\r\n                                   235, 236, 237, 238,\r\n                                   239, 299, 300, 31826,\r\n                                   31808, 31813, 31825, 31829,\r\n                                   302, 303, 304, 305,\r\n                                   306, 307, 371, 246,\r\n                                   248, 251, 31965, 31966,\r\n                                   31967, 31968, 31969, 10809,\r\n                                   10810, 34465, 10813, 10812,\r\n                                   10814, 10816, 10817, 10818,\r\n                                   42219, 42217, 42221, 42222,\r\n                                   49716, 42223, 10826, 10828,\r\n                                   10830, 45857, 10832, 10831,\r\n                                   10833, 10834, 42224, 45850,\r\n                                   10837, 10839, 10838, 10840,\r\n                                   10836, 10842, 10843, 10844,\r\n                                   50378, 10845, 10846, 49717,\r\n                                   49971, 42226, 10851, 42227,\r\n                                   10909, 49975, 10854, 10855,\r\n                                   42228, 42229, 10858, 10859,\r\n                                   10861, 42230, 42231, 10864,\r\n                                   42232, 34537, 10867, 49842,\r\n                                   50294, 10869, 10870, 42233,\r\n                                   42234, 10874, 49718, 10878,\r\n                                   10880, 10881, 42236, 10883,\r\n                                   10884, 10885, 49720, 49721,\r\n                                   10890, 10891, 10893, 50675,\r\n                                   50394, 10898, 42238, 49722,\r\n                                   49723, 50297, 10902, 10903,\r\n                                   10904, 10905, 42239, 49785,\r\n                                   42240, 10825, 42242, 10913,\r\n                                   45592, 10916, 45565, 50412,\r\n                                   42541, 10919, 10920, 10921,\r\n                                   45895, 10923, 42243, 10926,\r\n                                   10927, 49728, 49724, 10931,\r\n                                   42246, 10933, 42247, 42248,\r\n                                   42249, 42250, 10972, 49725,\r\n                                   49726, 10940, 49727, 42253,\r\n                                   10943, 42254, 10945, 10960,\r\n                                   49719, 10911, 10922, 42220,\r\n                                   45556, 10822, 10985, 10895,\r\n                                   34469, 10824, 34473, 10841,\r\n                                   34474, 10872, 10853, 34475,\r\n                                   10906, 10934, 10957, 34486,\r\n                                   34493, 34501, 34505, 10970,\r\n                                   34545, 10971, 34557, 10975,\r\n                                   34559, 34561, 34568, 45263,\r\n                                   45270, 45273, 45302, 45534,\r\n                                   45537, 45540, 45543, 45546,\r\n                                   45549, 45553, 45559, 45562,\r\n                                   45567, 45571, 45581, 45584,\r\n                                   45590, 45596, 10924, 45603,\r\n                                   45750, 45760, 10961, 11008,\r\n                                   10962, 42241, 10954, 10900,\r\n                                   45752, 10965, 10946, 45754,\r\n                                   10980, 10966, 45867, 45880,\r\n                                   45885, 10964, 10974, 45893,\r\n                                   49843, 45897, 42244, 45899,\r\n                                   45901, 45903, 45905, 45907,\r\n                                   45909, 45931, 45948, 45950,\r\n                                   45952, 45954, 45956, 45963,\r\n                                   45965, 45967, 45972, 45974,\r\n                                   45976, 45978, 45980, 45987,\r\n                                   45989, 45991, 45993, 45995,\r\n                                   45997, 45999, 46001, 46003,\r\n                                   46005, 46007, 46009, 46011,\r\n                                   46013, 46015, 46017, 46019,\r\n                                   46021, 46023, 46025, 46027,\r\n                                   46029, 46031, 46033, 46035,\r\n                                   46037, 46039, 46041, 46043,\r\n                                   46045, 46047, 46049, 46051,\r\n                                   46086, 46088, 46090, 46092,\r\n                                   46094, 46096, 46098, 46100,\r\n                                   49962, 49967, 46102, 46104,\r\n                                   50008, 50011, 50013, 50015,\r\n                                   50022, 50043, 50062, 50071,\r\n                                   50073, 50076, 50106, 50114,\r\n                                   50165, 50170, 50173, 50309,\r\n                                   50312, 50331, 50335, 50344,\r\n                                   50346, 50354, 50357, 50360,\r\n                                   50363, 50366, 50369, 50373,\r\n                                   50375, 50391, 50397, 50402,\r\n                                   50409, 50415, 50418, 50475,\r\n                                   50478, 50481, 50484, 50487,\r\n                                   50606, 50616, 50619, 50621,\r\n                                   50625, 50668, 21117, 21118,\r\n                                   34466, 21121, 21120, 21122,\r\n                                   21124, 21125, 21126, 42257,\r\n                                   42255, 42259, 42260, 49729,\r\n                                   42261, 21134, 21136, 21138,\r\n                                   45858, 21140, 21139, 21141,\r\n                                   21142, 42262, 45851, 21145,\r\n                                   21147, 21146, 21148, 21144,\r\n                                   21150, 21151, 21152, 50379,\r\n                                   21153, 21154, 49730, 49972,\r\n                                   42264, 21159, 42265, 21217,\r\n                                   49976, 21162, 21163, 42266,\r\n                                   42267, 21166, 21167, 21169,\r\n                                   42268, 42269, 21172, 42270,\r\n                                   34538, 21175, 49844, 50295,\r\n                                   21177, 21178, 42271, 42272,\r\n                                   21182, 49731, 21186, 21188,\r\n                                   21189, 42274, 21191, 21192,\r\n                                   21193, 49733, 49734, 21198,\r\n                                   21199, 21201, 50676, 50395,\r\n                                   21206, 42276, 49735, 49736,\r\n                                   50298, 21210, 21211, 21212,\r\n                                   21213, 42277, 49786, 42278,\r\n                                   21133, 42280, 21221, 45593,\r\n                                   21224, 45566, 50413, 42542,\r\n                                   21227, 21228, 21229, 45896,\r\n                                   21231, 42281, 21234, 21235,\r\n                                   49741, 49737, 21239, 42284,\r\n                                   21241, 42285, 42286, 42287,\r\n                                   42288, 21280, 49738, 49739,\r\n                                   21248, 49740, 42291, 21251,\r\n                                   42292, 21253, 21268, 49732,\r\n                                   21219, 21230, 42258, 45557,\r\n                                   21130, 21293, 21203, 34470,\r\n                                   21132, 34477, 21149, 34478,\r\n                                   21180, 21161, 34479, 21214,\r\n                                   21242, 21265, 34487, 34494,\r\n                                   34502, 34506, 21278, 34546,\r\n                                   21279, 34558, 21283, 34560,\r\n                                   34562, 34569, 45264, 45271,\r\n                                   45274, 45303, 45535, 45538,\r\n                                   45541, 45544, 45547, 45550,\r\n                                   45554, 45560, 45563, 45568,\r\n                                   45572, 45582, 45585, 45591,\r\n                                   45597, 21232, 45604, 45751,\r\n                                   45761, 21269, 21316, 21270,\r\n                                   42279, 21262, 21208, 45753,\r\n                                   21273, 21254, 45755, 21288,\r\n                                   21274, 45868, 45881, 45886,\r\n                                   21272, 21282, 45894, 49845,\r\n                                   45898, 42282, 45900, 45902,\r\n                                   45904, 45906, 45908, 45910,\r\n                                   45932, 45949, 45951, 45953,\r\n                                   45955, 45957, 45964, 45966,\r\n                                   45968, 45973, 45975, 45977,\r\n                                   45979, 45981, 45988, 45990,\r\n                                   45992, 45994, 45996, 45998,\r\n                                   46000, 46002, 46004, 46006,\r\n                                   46008, 46010, 46012, 46014,\r\n                                   46016, 46018, 46020, 46022,\r\n                                   46024, 46026, 46028, 46030,\r\n                                   46032, 46034, 46036, 46038,\r\n                                   46040, 46042, 46044, 46046,\r\n                                   46048, 46050, 46052, 46087,\r\n                                   46089, 46091, 46093, 46095,\r\n                                   46097, 46099, 46101, 49963,\r\n                                   49968, 46103, 46105, 50009,\r\n                                   50012, 50014, 50016, 50023,\r\n                                   50044, 50063, 50072, 50074,\r\n                                   50077, 50107, 50115, 50166,\r\n                                   50171, 50174, 50310, 50313,\r\n                                   50332, 50336, 50345, 50347,\r\n                                   50355, 50358, 50361, 50364,\r\n                                   50367, 50370, 50374, 50376,\r\n                                   50392, 50398, 50403, 50410,\r\n                                   50416, 50419, 50476, 50479,\r\n                                   50482, 50485, 50488, 50607,\r\n                                   50617, 50620, 50622, 50626,\r\n                                   50669, 31525, 31526, 31527,\r\n                                   31528, 31571, 49965, 31574,\r\n                                   31573, 31575, 50329, 31576,\r\n                                   31577, 31579, 31578, 31572,\r\n                                   31581, 31582, 31583, 31584,\r\n                                   31585, 31586, 31587, 31588,\r\n                                   49966, 31591, 31590, 31592,\r\n                                   50330, 31593, 31594, 31596,\r\n                                   31595, 31589, 31598, 31599,\r\n                                   31600, 31601, 31602, 31603,\r\n                                   31604, 32146, 32150, 32151,\r\n                                   32152, 32156, 32157, 32158,\r\n                                   32162, 32163, 32164, 32168,\r\n                                   32169, 32170, 32174, 32175,\r\n                                   32176, 32180, 32181, 32182,\r\n                                   32186, 32187, 32199, 32134,\r\n                                   32030, 32034, 32035, 32036,\r\n                                   32040, 32041, 32042, 32046,\r\n                                   32047, 32048, 32052, 32053,\r\n                                   32054, 32058, 32059, 32060,\r\n                                   32064, 32065, 32066, 32070,\r\n                                   32071, 49788, 49792, 49793,\r\n                                   49794, 49798, 49799, 49800,\r\n                                   49804, 49805, 49806, 49810,\r\n                                   49811, 49812, 49816, 49817,\r\n                                   49818, 49822, 49823, 49824,\r\n                                   49828, 49829, 32081, 32085,\r\n                                   32086, 32087, 32091, 32092,\r\n                                   32093, 32097, 32098, 32099,\r\n                                   32103, 32104, 32105, 32109,\r\n                                   32110, 32111, 32115, 32116,\r\n                                   32117, 32121, 32122, 32141,\r\n                                   32204, 32208, 32209, 32210,\r\n                                   32214, 32215, 32216, 32220,\r\n                                   32221, 32222, 32226, 32227,\r\n                                   32228, 32232, 32233, 32234,\r\n                                   32238, 32239, 32240, 32244,\r\n                                   32245, 316, 317, 318,\r\n                                   323, 31922, 31927, 31932,\r\n                                   31937, 31942, 31947, 31948,\r\n                                   45941, 45942, 48118, 48119,\r\n                                   31763, 31764, 31774, 31775,\r\n                                   48075, 48076, 48105, 48106,\r\n                                   31769, 31770, 48048, 48049,\r\n                                   48134, 48135, 45918, 45919,\r\n                                   31758, 31759, 31784, 31785,\r\n                                   31786, 31787, 31788, 31789,\r\n                                   31790, 31791, 32906, 32910,\r\n                                   32938, 32942, 32975, 32979,\r\n                                   45612, 32988, 32989, 32990,\r\n                                   32991, 33003, 45763, 32995,\r\n                                   32996, 32997, 32998, 45766,\r\n                                   33004, 33005, 33006, 33007,\r\n                                   33012, 33013, 33014, 33011,\r\n                                   45842, 33146, 33147, 33148,\r\n                                   33149, 33150, 33151, 33152,\r\n                                   33153, 33154, 33113, 33114,\r\n                                   33115, 33116, 33117, 33118,\r\n                                   33119, 33120, 33121, 33122,\r\n                                   33123, 33124, 33125, 33126,\r\n                                   33127, 33128, 33129, 33130,\r\n                                   33131, 33160, 33161, 33162,\r\n                                   33163, 33164, 33165, 33166,\r\n                                   33167, 33235, 33236, 33237,\r\n                                   33238, 33239, 33240, 33241,\r\n                                   33242, 33243, 33244, 33245,\r\n                                   33246, 33247, 33248, 33249,\r\n                                   33172, 33173, 33174, 33175,\r\n                                   33176, 33177, 33178, 33179,\r\n                                   33180, 33181, 33182, 33183,\r\n                                   33184, 33185, 33186, 33187,\r\n                                   33188, 33189, 33190, 33191,\r\n                                   33192, 33193, 33194, 33195,\r\n                                   33216, 33217, 33218, 33219,\r\n                                   33220, 33221, 33222, 33223,\r\n                                   33224, 33225, 33226, 33227,\r\n                                   33261, 33264, 33265, 33102,\r\n                                   33105, 33106, 32702, 32703,\r\n                                   32704, 32706, 32707, 32708,\r\n                                   32709, 32710, 32711, 32712,\r\n                                   32713, 32714, 32715, 32716,\r\n                                   32717, 32720, 32721, 32722,\r\n                                   32723, 32724, 32725, 32726,\r\n                                   32727, 32728, 32729, 32732,\r\n                                   32738, 32739, 32740, 32749,\r\n                                   32750, 32751, 32752, 32753,\r\n                                   32755, 32757, 35876, 35877,\r\n                                   35878, 35879, 49980, 33374,\r\n                                   33382, 33383, 33384, 33395,\r\n                                   33396, 33397, 33398, 33399,\r\n                                   33400, 33402, 33408, 33410,\r\n                                   33409, 33411, 33415, 33420,\r\n                                   33421, 33422, 33427, 33429,\r\n                                   33430, 33431, 33436, 33439,\r\n                                   33442, 33443, 33444, 33451,\r\n                                   33452, 33453, 33460, 33461,\r\n                                   33462, 33469, 33472, 33473,\r\n                                   33474, 33475, 33476, 33478,\r\n                                   33484, 33486, 33487, 33488,\r\n                                   33489, 33493, 33495, 33496,\r\n                                   33497, 33498, 33502, 33504,\r\n                                   33505, 33506, 33507, 33511,\r\n                                   33513, 33514, 33516, 33520,\r\n                                   33523, 49984, 50094, 50095,\r\n                                   50096, 50097, 50098, 50099,\r\n                                   50100, 50101, 50102, 50103,\r\n                                   50104, 50105, 33547, 33548,\r\n                                   34949, 49989, 33794, 33795,\r\n                                   33796, 33797, 33798, 33799,\r\n                                   33985, 33995, 34002, 34009,\r\n                                   49994, 50161, 50025, 50026,\r\n                                   50027, 50028, 50029, 50031,\r\n                                   50059, 33365, 33366, 33367,\r\n                                   33368, 34398, 34402, 34403,\r\n                                   34404, 34419, 34422, 34423,\r\n                                   34424, 34425, 34426, 34427,\r\n                                   34429, 34432, 34433, 34434,\r\n                                   34440, 34442, 34443, 34446,\r\n                                   34448, 34450, 34451, 34453,\r\n                                   34456, 34499, 34509, 34510,\r\n                                   34511, 34512, 34513, 34514,\r\n                                   34516, 34517, 34518, 34519,\r\n                                   34520, 34521, 34523, 34530,\r\n                                   34531, 34532, 34533, 34534,\r\n                                   34553, 32611, 32612, 32615,\r\n                                   32616, 32617, 32618, 32619,\r\n                                   32620, 32621, 32623, 32627,\r\n                                   32629, 32631, 32633, 32634,\r\n                                   34599, 34604, 34638, 34669,\r\n                                   34693, 34728, 34766, 34768,\r\n                                   34772, 34787, 34808, 34941,\r\n                                   34972, 34979, 34987, 34999,\r\n                                   35004, 35015, 35017, 35019,\r\n                                   35021, 35026, 35029, 35034,\r\n                                   35036, 35041, 35043, 35045,\r\n                                   35052, 35057, 35059, 33369,\r\n                                   35061, 35063, 35065, 35081,\r\n                                   35089, 35093, 35095, 35114,\r\n                                   35119, 35121, 35123, 35125,\r\n                                   35127, 35129, 35131, 35136,\r\n                                   35138, 35140, 35142, 35144,\r\n                                   35155, 35181, 35186, 35191,\r\n                                   35211, 35213, 35215, 35222,\r\n                                   35224, 35232, 35234, 35236,\r\n                                   35238, 35240, 35248, 35259,\r\n                                   35268, 35279, 35281, 35283,\r\n                                   35285, 35287, 35289, 35291,\r\n                                   35296, 35298, 35300, 35302,\r\n                                   35304, 35320, 35322, 35324,\r\n                                   35326, 35328, 35330, 35332,\r\n                                   35334, 35336, 35338, 35340,\r\n                                   35342, 35344, 35346, 35348,\r\n                                   35350, 35352, 35354, 35356,\r\n                                   35358, 35360, 35362, 35364,\r\n                                   35366, 35368, 35370, 35372,\r\n                                   35373, 32006, 35376, 35378,\r\n                                   35380, 35382, 35384, 35386,\r\n                                   35391, 35393, 35395, 33987,\r\n                                   33986, 33988, 35398, 35400,\r\n                                   35402, 35404, 35406, 35408,\r\n                                   35410, 35412, 35414, 35416,\r\n                                   35418, 35420, 35422, 35424,\r\n                                   35426, 35428, 35430, 35432,\r\n                                   35434, 35436, 35438, 35440,\r\n                                   35442, 35444, 35447, 35449,\r\n                                   35451, 35453, 35455, 35457,\r\n                                   35459, 35461, 35463, 35465,\r\n                                   35466, 35468, 35470, 43835,\r\n                                   45575, 45577, 45871, 45873,\r\n                                   45875, 45877, 45879, 45884,\r\n                                   45889, 49847, 49851, 49852,\r\n                                   49853, 49857, 49858, 49859,\r\n                                   49863, 49864, 49865, 49869,\r\n                                   49870, 49871, 49875, 49876,\r\n                                   49877, 49881, 49882, 49883,\r\n                                   49887, 49888, 50021, 50033,\r\n                                   50035, 50037, 50039, 50129,\r\n                                   50131, 50133, 50169, 50179,\r\n                                   50340, 50387, 50390, 50406,\r\n                                   50450, 50452, 50454, 50471,\r\n                                   50473, 50491, 50615, 50667,\r\n                                   50672, 50674, 50679, 50704 )\r\nGROUP  BY states.metadata_id\r\n                            TRACE: {\r\n  \"steps\": [\r\n    {\r\n      \"join_preparation\": {\r\n        \"select_id\": 1,\r\n        \"steps\": [\r\n          {\r\n            \"expanded_query\": \"select states.metadata_id AS max_metadata_id,max(states.last_updated_ts) AS max_last_updated from states where states.last_updated_ts >= 1732708152.6401002e0 and states.last_updated_ts < 1734107999.999999e0 and states.metadata_id in (222,223,224,50501,50518,50535,50564,50581,50598,389,49770,391,49772,394,395,397,32307,32308,32310,32371,235,236,237,238,239,299,300,31826,31808,31813,31825,31829,302,303,304,305,306,307,371,246,248,251,31965,31966,31967,31968,31969,10809,10810,34465,10813,10812,10814,10816,10817,10818,42219,42217,42221,42222,49716,42223,10826,10828,10830,45857,10832,10831,10833,10834,42224,45850,10837,10839,10838,10840,10836,10842,10843,10844,50378,10845,10846,49717,49971,42226,10851,42227,10909,49975,10854,10855,42228,42229,10858,10859,10861,42230,42231,10864,42232,34537,10867,49842,50294,10869,10870,42233,42234,10874,49718,10878,10880,10881,42236,10883,10884,10885,49720,49721,10890,10891,10893,50675,50394,10898,42238,49722,49723,50297,10902,10903,10904,10905,42239,49785,42240,10825,42242,10913,45592,10916,45565,50412,42541,10919,10920,10921,45895,10923,42243,10926,10927,49728,49724,10931,42246,10933,42247,42248,42249,42250,10972,49725,49726,10940,49727,42253,10943,42254,10945,10960,49719,10911,10922,42220,45556,10822,10985,10895,34469,10824,34473,10841,34474,10872,10853,34475,10906,10934,10957,34486,34493,34501,34505,10970,34545,10971,34557,10975,34559,34561,34568,45263,45270,45273,45302,45534,45537,45540,45543,45546,45549,45553,45559,45562,45567,45571,45581,45584,45590,45596,10924,45603,45750,45760,10961,11008,10962,42241,10954,10900,45752,10965,10946,45754,10980,10966,45867,45880,45885,10964,10974,45893,49843,45897,42244,45899,45901,45903,45905,45907,45909,45931,45948,45950,45952,45954,45956,45963,45965,45967,45972,45974,45976,45978,45980,45987,45989,45991,45993,45995,45997,45999,46001,46003,46005,46007,46009,46011,46013,46015,46017,46019,46021,46023,46025,46027,46029,46031,46033,46035,46037,46039,46041,46043,46045,46047,46049,46051,46086,46088,46090,46092,46094,46096,46098,46100,49962,49967,46102,46104,50008,50011,50013,50015,50022,50043,50062,50071,50073,50076,50106,50114,50165,50170,50173,50309,50312,50331,50335,50344,50346,50354,50357,50360,50363,50366,50369,50373,50375,50391,50397,50402,50409,50415,50418,50475,50478,50481,50484,50487,50606,50616,50619,50621,50625,50668,21117,21118,34466,21121,21120,21122,21124,21125,21126,42257,42255,42259,42260,49729,42261,21134,21136,21138,45858,21140,21139,21141,21142,42262,45851,21145,21147,21146,21148,21144,21150,21151,21152,50379,21153,21154,49730,49972,42264,21159,42265,21217,49976,21162,21163,42266,42267,21166,21167,21169,42268,42269,21172,42270,34538,21175,49844,50295,21177,21178,42271,42272,21182,49731,21186,21188,21189,42274,21191,21192,21193,49733,49734,21198,21199,21201,50676,50395,21206,42276,49735,49736,50298,21210,21211,21212,21213,42277,49786,42278,21133,42280,21221,45593,21224,45566,50413,42542,21227,21228,21229,45896,21231,42281,21234,21235,49741,49737,21239,42284,21241,42285,42286,42287,42288,21280,49738,49739,21248,49740,42291,21251,42292,21253,21268,49732,21219,21230,42258,45557,21130,21293,21203,34470,21132,34477,21149,34478,21180,21161,34479,21214,21242,21265,34487,34494,34502,34506,21278,34546,21279,34558,21283,34560,34562,34569,45264,45271,45274,45303,45535,45538,45541,45544,45547,45550,45554,45560,45563,45568,45572,45582,45585,45591,45597,21232,45604,45751,45761,21269,21316,21270,42279,21262,21208,45753,21273,21254,45755,21288,21274,45868,45881,45886,21272,21282,45894,49845,45898,42282,45900,45902,45904,45906,45908,45910,45932,45949,45951,45953,45955,45957,45964,45966,45968,45973,45975,45977,45979,45981,45988,45990,45992,45994,45996,45998,46000,46002,46004,46006,46008,46010,46012,46014,46016,46018,46020,46022,46024,46026,46028,46030,46032,46034,46036,46038,46040,46042,46044,46046,46048,46050,46052,46087,46089,46091,46093,46095,46097,46099,46101,49963,49968,46103,46105,50009,50012,50014,50016,50023,50044,50063,50072,50074,50077,50107,50115,50166,50171,50174,50310,50313,50332,50336,50345,50347,50355,50358,50361,50364,50367,50370,50374,50376,50392,50398,50403,50410,50416,50419,50476,50479,50482,50485,50488,50607,50617,50620,50622,50626,50669,31525,31526,31527,31528,31571,49965,31574,31573,31575,50329,31576,31577,31579,31578,31572,31581,31582,31583,31584,31585,31586,31587,31588,49966,31591,31590,31592,50330,31593,31594,31596,31595,31589,31598,31599,31600,31601,31602,31603,31604,32146,32150,32151,32152,32156,32157,32158,32162,32163,32164,32168,32169,32170,32174,32175,32176,32180,32181,32182,32186,32187,32199,32134,32030,32034,32035,32036,32040,32041,32042,32046,32047,32048,32052,32053,32054,32058,32059,32060,32064,32065,32066,32070,32071,49788,49792,49793,49794,49798,49799,49800,49804,49805,49806,49810,49811,49812,49816,49817,49818,49822,49823,49824,49828,49829,32081,32085,32086,32087,32091,32092,32093,32097,32098,32099,32103,32104,32105,32109,32110,32111,32115,32116,32117,32121,32122,32141,32204,32208,32209,32210,32214,32215,32216,32220,32221,32222,32226,32227,32228,32232,32233,32234,32238,32239,32240,32244,32245,316,317,318,323,31922,31927,31932,31937,31942,31947,31948,45941,45942,48118,48119,31763,31764,31774,31775,48075,48076,48105,48106,31769,31770,48048,48049,48134,48135,45918,45919,31758,31759,31784,31785,31786,31787,31788,31789,31790,31791,32906,32910,32938,32942,32975,32979,45612,32988,32989,32990,32991,33003,45763,32995,32996,32997,32998,45766,33004,33005,33006,33007,33012,33013,33014,33011,45842,33146,33147,33148,33149,33150,33151,33152,33153,33154,33113,33114,33115,33116,33117,33118,33119,33120,33121,33122,33123,33124,33125,33126,33127,33128,33129,33130,33131,33160,33161,33162,33163,33164,33165,33166,33167,33235,33236,33237,33238,33239,33240,33241,33242,33243,33244,33245,33246,33247,33248,33249,33172,33173,33174,33175,33176,33177,33178,33179,33180,33181,33182,33183,33184,33185,33186,33187,33188,33189,33190,33191,33192,33193,33194,33195,33216,33217,33218,33219,33220,33221,33222,33223,33224,33225,33226,33227,33261,33264,33265,33102,33105,33106,32702,32703,32704,32706,32707,32708,32709,32710,32711,32712,32713,32714,32715,32716,32717,32720,32721,32722,32723,32724,32725,32726,32727,32728,32729,32732,32738,32739,32740,32749,32750,32751,32752,32753,32755,32757,35876,35877,35878,35879,49980,33374,33382,33383,33384,33395,33396,33397,33398,33399,33400,33402,33408,33410,33409,33411,33415,33420,33421,33422,33427,33429,33430,33431,33436,33439,33442,33443,33444,33451,33452,33453,33460,33461,33462,33469,33472,33473,33474,33475,33476,33478,33484,33486,33487,33488,33489,33493,33495,33496,33497,33498,33502,33504,33505,33506,33507,33511,33513,33514,33516,33520,33523,49984,50094,50095,50096,50097,50098,50099,50100,50101,50102,50103,50104,50105,33547,33548,34949,49989,33794,33795,33796,33797,33798,33799,33985,33995,34002,34009,49994,50161,50025,50026,50027,50028,50029,50031,50059,33365,33366,33367,33368,34398,34402,34403,34404,34419,34422,34423,34424,34425,34426,34427,34429,34432,34433,34434,34440,34442,34443,34446,34448,34450,34451,34453,34456,34499,34509,34510,34511,34512,34513,34514,34516,34517,34518,34519,34520,34521,34523,34530,34531,34532,34533,34534,34553,32611,32612,32615,32616,32617,32618,32619,32620,32621,32623,32627,32629,32631,32633,32634,34599,34604,34638,34669,34693,34728,34766,34768,34772,34787,34808,34941,34972,34979,34987,34999,35004,35015,35017,35019,35021,35026,35029,35034,35036,35041,35043,35045,35052,35057,35059,33369,35061,35063,35065,35081,35089,35093,35095,35114,35119,35121,35123,35125,35127,35129,35131,35136,35138,35140,35142,35144,35155,35181,35186,35191,35211,35213,35215,35222,35224,35232,35234,35236,35238,35240,35248,35259,35268,35279,35281,35283,35285,35287,35289,35291,35296,35298,35300,35302,35304,35320,35322,35324,35326,35328,35330,35332,35334,35336,35338,35340,35342,35344,35346,35348,35350,35352,35354,35356,35358,35360,35362,35364,35366,35368,35370,35372,35373,32006,35376,35378,35380,35382,35384,35386,35391,35393,35395,33987,33986,33988,35398,35400,35402,35404,35406,35408,35410,35412,35414,35416,35418,35420,35422,35424,35426,35428,35430,35432,35434,35436,35438,35440,35442,35444,35447,35449,35451,35453,35455,35457,35459,35461,35463,35465,35466,35468,35470,43835,45575,45577,45871,45873,45875,45877,45879,45884,45889,49847,49851,49852,49853,49857,49858,49859,49863,49864,49865,49869,49870,49871,49875,49876,49877,49881,49882,49883,49887,49888,50021,50033,50035,50037,50039,50129,50131,50133,50169,50179,50340,50387,50390,50406,50450,50452,50454,50471,50473,50491,50615,50667,50672,50674,50679,50704) group by states.metadata_id\"\r\n          }\r\n        ]\r\n      }\r\n    },\r\n    {\r\n      \"join_optimization\": {\r\n        \"select_id\": 1,\r\n        \"steps\": [\r\n          {\r\n            \"in_to_subquery_conversion\": {\r\n              \"item\": \"states.metadata_id in (222,223,224,50501,50518,50535,50564,50581,50598,389,49770,391,49772,394,395,397,32307,32308,32310,32371,235,236,237,238,239,299,300,31826,31808,31813,31825,31829,302,303,304,305,306,307,371,246,248,251,31965,31966,31967,31968,31969,10809,10810,34465,10813,10812,10814,10816,10817,10818,42219,42217,42221,42222,49716,42223,10826,10828,10830,45857,10832,10831,10833,10834,42224,45850,10837,10839,10838,10840,10836,10842,10843,10844,50378,10845,10846,49717,49971,42226,10851,42227,10909,49975,10854,10855,42228,42229,10858,10859,10861,42230,42231,10864,42232,34537,10867,49842,50294,10869,10870,42233,42234,10874,49718,10878,10880,10881,42236,10883,10884,10885,49720,49721,10890,10891,10893,50675,50394,10898,42238,49722,49723,50297,10902,10903,10904,10905,42239,49785,42240,10825,42242,10913,45592,10916,45565,50412,42541,10919,10920,10921,45895,10923,42243,10926,10927,49728,49724,10931,42246,10933,42247,42248,42249,42250,10972,49725,49726,10940,49727,42253,10943,42254,10945,10960,49719,10911,10922,42220,45556,10822,10985,10895,34469,10824,34473,10841,34474,10872,10853,34475,10906,10934,10957,34486,34493,34501,34505,10970,34545,10971,34557,10975,34559,34561,34568,45263,45270,45273,45302,45534,45537,45540,45543,45546,45549,45553,45559,45562,45567,45571,45581,45584,45590,45596,10924,45603,45750,45760,10961,11008,10962,42241,10954,10900,45752,10965,10946,45754,10980,10966,45867,45880,45885,10964,10974,45893,49843,45897,42244,45899,45901,45903,45905,45907,45909,45931,45948,45950,45952,45954,45956,45963,45965,45967,45972,45974,45976,45978,45980,45987,45989,45991,45993,45995,45997,45999,46001,46003,46005,46007,46009,46011,46013,46015,46017,46019,46021,46023,46025,46027,46029,46031,46033,46035,46037,46039,46041,46043,46045,46047,46049,46051,46086,46088,46090,46092,46094,46096,46098,46100,49962,49967,46102,46104,50008,50011,50013,50015,50022,50043,50062,50071,50073,50076,50106,50114,50165,50170,50173,50309,50312,50331,50335,50344,50346,50354,50357,50360,50363,50366,50369,50373,50375,50391,50397,50402,50409,50415,50418,50475,50478,50481,50484,50487,50606,50616,50619,50621,50625,50668,21117,21118,34466,21121,21120,21122,21124,21125,21126,42257,42255,42259,42260,49729,42261,21134,21136,21138,45858,21140,21139,21141,21142,42262,45851,21145,21147,21146,21148,21144,21150,21151,21152,50379,21153,21154,49730,49972,42264,21159,42265,21217,49976,21162,21163,42266,42267,21166,21167,21169,42268,42269,21172,42270,34538,21175,49844,50295,21177,21178,42271,42272,21182,49731,21186,21188,21189,42274,21191,21192,21193,49733,49734,21198,21199,21201,50676,50395,21206,42276,49735,49736,50298,21210,21211,21212,21213,42277,49786,42278,21133,42280,21221,45593,21224,45566,50413,42542,21227,21228,21229,45896,21231,42281,21234,21235,49741,49737,21239,42284,21241,42285,42286,42287,42288,21280,49738,49739,21248,49740,42291,21251,42292,21253,21268,49732,21219,21230,42258,45557,21130,21293,21203,34470,21132,34477,21149,34478,21180,21161,34479,21214,21242,21265,34487,34494,34502,34506,21278,34546,21279,34558,21283,34560,34562,34569,45264,45271,45274,45303,45535,45538,45541,45544,45547,45550,45554,45560,45563,45568,45572,45582,45585,45591,45597,21232,45604,45751,45761,21269,21316,21270,42279,21262,21208,45753,21273,21254,45755,21288,21274,45868,45881,45886,21272,21282,45894,49845,45898,42282,45900,45902,45904,45906,45908,45910,45932,45949,45951,45953,45955,45957,45964,45966,45968,45973,45975,45977,45979,45981,45988,45990,45992,45994,45996,45998,46000,46002,46004,46006,46008,46010,46012,46014,46016,46018,46020,46022,46024,46026,46028,46030,46032,46034,46036,46038,46040,46042,46044,46046,46048,46050,46052,46087,46089,46091,46093,46095,46097,46099,46101,49963,49968,46103,46105,50009,50012,50014,50016,50023,50044,50063,50072,50074,50077,50107,50115,50166,50171,50174,50310,50313,50332,50336,50345,50347,50355,50358,50361,50364,50367,50370,50374,50376,50392,50398,50403,50410,50416,50419,50476,50479,50482,50485,50488,50607,50617,50620,50622,50626,50669,31525,31526,31527,31528,31571,49965,31574,31573,31575,50329,31576,31577,31579,31578,31572,31581,31582,31583,31584,31585,31586,31587,31588,49966,31591,31590,31592,50330,31593,31594,31596,31595,31589,31598,31599,31600,31601,31602,31603,31604,32146,32150,32151,32152,32156,32157,32158,32162,32163,32164,32168,32169,32170,32174,32175,32176,32180,32181,32182,32186,32187,32199,32134,32030,32034,32035,32036,32040,32041,32042,32046,32047,32048,32052,32053,32054,32058,32059,32060,32064,32065,32066,32070,32071,49788,49792,49793,49794,49798,49799,49800,49804,49805,49806,49810,49811,49812,49816,49817,49818,49822,49823,49824,49828,49829,32081,32085,32086,32087,32091,32092,32093,32097,32098,32099,32103,32104,32105,32109,32110,32111,32115,32116,32117,32121,32122,32141,32204,32208,32209,32210,32214,32215,32216,32220,32221,32222,32226,32227,32228,32232,32233,32234,32238,32239,32240,32244,32245,316,317,318,323,31922,31927,31932,31937,31942,31947,31948,45941,45942,48118,48119,31763,31764,31774,31775,48075,48076,48105,48106,31769,31770,48048,48049,48134,48135,45918,45919,31758,31759,31784,31785,31786,31787,31788,31789,31790,31791,32906,32910,32938,32942,32975,32979,45612,32988,32989,32990,32991,33003,45763,32995,32996,32997,32998,45766,33004,33005,33006,33007,33012,33013,33014,33011,45842,33146,33147,33148,33149,33150,33151,33152,33153,33154,33113,33114,33115,33116,33117,33118,33119,33120,33121,33122,33123,33124,33125,33126,33127,33128,33129,33130,33131,33160,33161,33162,33163,33164,33165,33166,33167,33235,33236,33237,33238,33239,33240,33241,33242,33243,33244,33245,33246,33247,33248,33249,33172,33173,33174,33175,33176,33177,33178,33179,33180,33181,33182,33183,33184,33185,33186,33187,33188,33189,33190,33191,33192,33193,33194,33195,33216,33217,33218,33219,33220,33221,33222,33223,33224,33225,33226,33227,33261,33264,33265,33102,33105,33106,32702,32703,32704,32706,32707,32708,32709,32710,32711,32712,32713,32714,32715,32716,32717,32720,32721,32722,32723,32724,32725,32726,32727,32728,32729,32732,32738,32739,32740,32749,32750,32751,32752,32753,32755,32757,35876,35877,35878,35879,49980,33374,33382,33383,33384,33395,33396,33397,33398,33399,33400,33402,33408,33410,33409,33411,33415,33420,33421,33422,33427,33429,33430,33431,33436,33439,33442,33443,33444,33451,33452,33453,33460,33461,33462,33469,33472,33473,33474,33475,33476,33478,33484,33486,33487,33488,33489,33493,33495,33496,33497,33498,33502,33504,33505,33506,33507,33511,33513,33514,33516,33520,33523,49984,50094,50095,50096,50097,50098,50099,50100,50101,50102,50103,50104,50105,33547,33548,34949,49989,33794,33795,33796,33797,33798,33799,33985,33995,34002,34009,49994,50161,50025,50026,50027,50028,50029,50031,50059,33365,33366,33367,33368,34398,34402,34403,34404,34419,34422,34423,34424,34425,34426,34427,34429,34432,34433,34434,34440,34442,34443,34446,34448,34450,34451,34453,34456,34499,34509,34510,34511,34512,34513,34514,34516,34517,34518,34519,34520,34521,34523,34530,34531,34532,34533,34534,34553,32611,32612,32615,32616,32617,32618,32619,32620,32621,32623,32627,32629,32631,32633,32634,34599,34604,34638,34669,34693,34728,34766,34768,34772,34787,34808,34941,34972,34979,34987,34999,35004,35015,35017,35019,35021,35026,35029,35034,35036,35041,35043,35045,35052,35057,35059,33369,35061,35063,35065,35081,35089,35093,35095,35114,35119,35121,35123,35125,35127,35129,35131,35136,35138,35140,35142,35144,35155,35181,35186,35191,35211,35213,35215,35222,35224,35232,35234,35236,35238,35240,35248,35259,35268,35279,35281,35283,35285,35287,35289,35291,35296,35298,35300,35302,35304,35320,35322,35324,35326,35328,35330,35332,35334,35336,35338,35340,35342,35344,35346,35348,35350,35352,35354,35356,35358,35360,35362,35364,35366,35368,35370,35372,35373,32006,35376,35378,35380,35382,35384,35386,35391,35393,35395,33987,33986,33988,35398,35400,35402,35404,35406,35408,35410,35412,35414,35416,35418,35420,35422,35424,35426,35428,35430,35432,35434,35436,35438,35440,35442,35444,35447,35449,35451,35453,35455,35457,35459,35461,35463,35465,35466,35468,35470,43835,45575,45577,45871,45873,45875,45877,45879,45884,45889,49847,49851,49852,49853,49857,49858,49859,49863,49864,49865,49869,49870,49871,49875,49876,49877,49881,49882,49883,49887,49888,50021,50033,50035,50037,50039,50129,50131,50133,50169,50179,50340,50387,50390,50406,50450,50452,50454,50471,50473,50491,50615,50667,50672,50674,50679,50704)\",\r\n              \"conversion\": [\r\n                {\r\n                  \"join_preparation\": {\r\n                    \"select_id\": 2,\r\n                    \"steps\": [\r\n                      {\r\n                        \"derived\": {\r\n                          \"table\": \"tvc_0\",\r\n                          \"select_id\": 3,\r\n                          \"algorithm\": \"materialized\"\r\n                        }\r\n                      },\r\n                      {\r\n                        \"transformation\": {\r\n                          \"select_id\": 2,\r\n                          \"from\": \"IN (SELECT)\",\r\n                          \"to\": \"semijoin\",\r\n                          \"chosen\": true\r\n                        }\r\n                      },\r\n                      {\r\n                        \"expanded_query\": \"/* select#2 */ select tvc_0._col_1 from (values (222),(223),(224),(50501),(50518),(50535),(50564),(50581),(50598),(389),(49770),(391),(49772),(394),(395),(397),(32307),(32308),(32310),(32371),(235),(236),(237),(238),(239),(299),(300),(31826),(31808),(31813),(31825),(31829),(302),(303),(304),(305),(306),(307),(371),(246),(248),(251),(31965),(31966),(31967),(31968),(31969),(10809),(10810),(34465),(10813),(10812),(10814),(10816),(10817),(10818),(42219),(42217),(42221),(42222),(49716),(42223),(10826),(10828),(10830),(45857),(10832),(10831),(10833),(10834),(42224),(45850),(10837),(10839),(10838),(10840),(10836),(10842),(10843),(10844),(50378),(10845),(10846),(49717),(49971),(42226),(10851),(42227),(10909),(49975),(10854),(10855),(42228),(42229),(10858),(10859),(10861),(42230),(42231),(10864),(42232),(34537),(10867),(49842),(50294),(10869),(10870),(42233),(42234),(10874),(49718),(10878),(10880),(10881),(42236),(10883),(10884),(10885),(49720),(49721),(10890),(10891),(10893),(50675),(50394),(10898),(42238),(49722),(49723),(50297),(10902),(10903),(10904),(10905),(42239),(49785),(42240),(10825),(42242),(10913),(45592),(10916),(45565),(50412),(42541),(10919),(10920),(10921),(45895),(10923),(42243),(10926),(10927),(49728),(49724),(10931),(42246),(10933),(42247),(42248),(42249),(42250),(10972),(49725),(49726),(10940),(49727),(42253),(10943),(42254),(10945),(10960),(49719),(10911),(10922),(42220),(45556),(10822),(10985),(10895),(34469),(10824),(34473),(10841),(34474),(10872),(10853),(34475),(10906),(10934),(10957),(34486),(34493),(34501),(34505),(10970),(34545),(10971),(34557),(10975),(34559),(34561),(34568),(45263),(45270),(45273),(45302),(45534),(45537),(45540),(45543),(45546),(45549),(45553),(45559),(45562),(45567),(45571),(45581),(45584),(45590),(45596),(10924),(45603),(45750),(45760),(10961),(11008),(10962),(42241),(10954),(10900),(45752),(10965),(10946),(45754),(10980),(10966),(45867),(45880),(45885),(10964),(10974),(45893),(49843),(45897),(42244),(45899),(45901),(45903),(45905),(45907),(45909),(45931),(45948),(45950),(45952),(45954),(45956),(45963),(45965),(45967),(45972),(45974),(45976),(45978),(45980),(45987),(45989),(45991),(45993),(45995),(45997),(45999),(46001),(46003),(46005),(46007),(46009),(46011),(46013),(46015),(46017),(46019),(46021),(46023),(46025),(46027),(46029),(46031),(46033),(46035),(46037),(46039),(46041),(46043),(46045),(46047),(46049),(46051),(46086),(46088),(46090),(46092),(46094),(46096),(46098),(46100),(49962),(49967),(46102),(46104),(50008),(50011),(50013),(50015),(50022),(50043),(50062),(50071),(50073),(50076),(50106),(50114),(50165),(50170),(50173),(50309),(50312),(50331),(50335),(50344),(50346),(50354),(50357),(50360),(50363),(50366),(50369),(50373),(50375),(50391),(50397),(50402),(50409),(50415),(50418),(50475),(50478),(50481),(50484),(50487),(50606),(50616),(50619),(50621),(50625),(50668),(21117),(21118),(34466),(21121),(21120),(21122),(21124),(21125),(21126),(42257),(42255),(42259),(42260),(49729),(42261),(21134),(21136),(21138),(45858),(21140),(21139),(21141),(21142),(42262),(45851),(21145),(21147),(21146),(21148),(21144),(21150),(21151),(21152),(50379),(21153),(21154),(49730),(49972),(42264),(21159),(42265),(21217),(49976),(21162),(21163),(42266),(42267),(21166),(21167),(21169),(42268),(42269),(21172),(42270),(34538),(21175),(49844),(50295),(21177),(21178),(42271),(42272),(21182),(49731),(21186),(21188),(21189),(42274),(21191),(21192),(21193),(49733),(49734),(21198),(21199),(21201),(50676),(50395),(21206),(42276),(49735),(49736),(50298),(21210),(21211),(21212),(21213),(42277),(49786),(42278),(21133),(42280),(21221),(45593),(21224),(45566),(50413),(42542),(21227),(21228),(21229),(45896),(21231),(42281),(21234),(21235),(49741),(49737),(21239),(42284),(21241),(42285),(42286),(42287),(42288),(21280),(49738),(49739),(21248),(49740),(42291),(21251),(42292),(21253),(21268),(49732),(21219),(21230),(42258),(45557),(21130),(21293),(21203),(34470),(21132),(34477),(21149),(34478),(21180),(21161),(34479),(21214),(21242),(21265),(34487),(34494),(34502),(34506),(21278),(34546),(21279),(34558),(21283),(34560),(34562),(34569),(45264),(45271),(45274),(45303),(45535),(45538),(45541),(45544),(45547),(45550),(45554),(45560),(45563),(45568),(45572),(45582),(45585),(45591),(45597),(21232),(45604),(45751),(45761),(21269),(21316),(21270),(42279),(21262),(21208),(45753),(21273),(21254),(45755),(21288),(21274),(45868),(45881),(45886),(21272),(21282),(45894),(49845),(45898),(42282),(45900),(45902),(45904),(45906),(45908),(45910),(45932),(45949),(45951),(45953),(45955),(45957),(45964),(45966),(45968),(45973),(45975),(45977),(45979),(45981),(45988),(45990),(45992),(45994),(45996),(45998),(46000),(46002),(46004),(46006),(46008),(46010),(46012),(46014),(46016),(46018),(46020),(46022),(46024),(46026),(46028),(46030),(46032),(46034),(46036),(46038),(46040),(46042),(46044),(46046),(46048),(46050),(46052),(46087),(46089),(46091),(46093),(46095),(46097),(46099),(46101),(49963),(49968),(46103),(46105),(50009),(50012),(50014),(50016),(50023),(50044),(50063),(50072),(50074),(50077),(50107),(50115),(50166),(50171),(50174),(50310),(50313),(50332),(50336),(50345),(50347),(50355),(50358),(50361),(50364),(50367),(50370),(50374),(50376),(50392),(50398),(50403),(50410),(50416),(50419),(50476),(50479),(50482),(50485),(50488),(50607),(50617),(50620),(50622),(50626),(50669),(31525),(31526),(31527),(31528),(31571),(49965),(31574),(31573),(31575),(50329),(31576),(31577),(31579),(31578),(31572),(31581),(31582),(31583),(31584),(31585),(31586),(31587),(31588),(49966),(31591),(31590),(31592),(50330),(31593),(31594),(31596),(31595),(31589),(31598),(31599),(31600),(31601),(31602),(31603),(31604),(32146),(32150),(32151),(32152),(32156),(32157),(32158),(32162),(32163),(32164),(32168),(32169),(32170),(32174),(32175),(32176),(32180),(32181),(32182),(32186),(32187),(32199),(32134),(32030),(32034),(32035),(32036),(32040),(32041),(32042),(32046),(32047),(32048),(32052),(32053),(32054),(32058),(32059),(32060),(32064),(32065),(32066),(32070),(32071),(49788),(49792),(49793),(49794),(49798),(49799),(49800),(49804),(49805),(49806),(49810),(49811),(49812),(49816),(49817),(49818),(49822),(49823),(49824),(49828),(49829),(32081),(32085),(32086),(32087),(32091),(32092),(32093),(32097),(32098),(32099),(32103),(32104),(32105),(32109),(32110),(32111),(32115),(32116),(32117),(32121),(32122),(32141),(32204),(32208),(32209),(32210),(32214),(32215),(32216),(32220),(32221),(32222),(32226),(32227),(32228),(32232),(32233),(32234),(32238),(32239),(32240),(32244),(32245),(316),(317),(318),(323),(31922),(31927),(31932),(31937),(31942),(31947),(31948),(45941),(45942),(48118),(48119),(31763),(31764),(31774),(31775),(48075),(48076),(48105),(48106),(31769),(31770),(48048),(48049),(48134),(48135),(45918),(45919),(31758),(31759),(31784),(31785),(31786),(31787),(31788),(31789),(31790),(31791),(32906),(32910),(32938),(32942),(32975),(32979),(45612),(32988),(32989),(32990),(32991),(33003),(45763),(32995),(32996),(32997),(32998),(45766),(33004),(33005),(33006),(33007),(33012),(33013),(33014),(33011),(45842),(33146),(33147),(33148),(33149),(33150),(33151),(33152),(33153),(33154),(33113),(33114),(33115),(33116),(33117),(33118),(33119),(33120),(33121),(33122),(33123),(33124),(33125),(33126),(33127),(33128),(33129),(33130),(33131),(33160),(33161),(33162),(33163),(33164),(33165),(33166),(33167),(33235),(33236),(33237),(33238),(33239),(33240),(33241),(33242),(33243),(33244),(33245),(33246),(33247),(33248),(33249),(33172),(33173),(33174),(33175),(33176),(33177),(33178),(33179),(33180),(33181),(33182),(33183),(33184),(33185),(33186),(33187),(33188),(33189),(33190),(33191),(33192),(33193),(33194),(33195),(33216),(33217),(33218),(33219),(33220),(33221),(33222),(33223),(33224),(33225),(33226),(33227),(33261),(33264),(33265),(33102),(33105),(33106),(32702),(32703),(32704),(32706),(32707),(32708),(32709),(32710),(32711),(32712),(32713),(32714),(32715),(32716),(32717),(32720),(32721),(32722),(32723),(32724),(32725),(32726),(32727),(32728),(32729),(32732),(32738),(32739),(32740),(32749),(32750),(32751),(32752),(32753),(32755),(32757),(35876),(35877),(35878),(35879),(49980),(33374),(33382),(33383),(33384),(33395),(33396),(33397),(33398),(33399),(33400),(33402),(33408),(33410),(33409),(33411),(33415),(33420),(33421),(33422),(33427),(33429),(33430),(33431),(33436),(33439),(33442),(33443),(33444),(33451),(33452),(33453),(33460),(33461),(33462),(33469),(33472),(33473),(33474),(33475),(33476),(33478),(33484),(33486),(33487),(33488),(33489),(33493),(33495),(33496),(33497),(33498),(33502),(33504),(33505),(33506),(33507),(33511),(33513),(33514),(33516),(33520),(33523),(49984),(50094),(50095),(50096),(50097),(50098),(50099),(50100),(50101),(50102),(50103),(50104),(50105),(33547),(33548),(34949),(49989),(33794),(33795),(33796),(33797),(33798),(33799),(33985),(33995),(34002),(34009),(49994),(50161),(50025),(50026),(50027),(50028),(50029),(50031),(50059),(33365),(33366),(33367),(33368),(34398),(34402),(34403),(34404),(34419),(34422),(34423),(34424),(34425),(34426),(34427),(34429),(34432),(34433),(34434),(34440),(34442),(34443),(34446),(34448),(34450),(34451),(34453),(34456),(34499),(34509),(34510),(34511),(34512),(34513),(34514),(34516),(34517),(34518),(34519),(34520),(34521),(34523),(34530),(34531),(34532),(34533),(34534),(34553),(32611),(32612),(32615),(32616),(32617),(32618),(32619),(32620),(32621),(32623),(32627),(32629),(32631),(32633),(32634),(34599),(34604),(34638),(34669),(34693),(34728),(34766),(34768),(34772),(34787),(34808),(34941),(34972),(34979),(34987),(34999),(35004),(35015),(35017),(35019),(35021),(35026),(35029),(35034),(35036),(35041),(35043),(35045),(35052),(35057),(35059),(33369),(35061),(35063),(35065),(35081),(35089),(35093),(35095),(35114),(35119),(35121),(35123),(35125),(35127),(35129),(35131),(35136),(35138),(35140),(35142),(35144),(35155),(35181),(35186),(35191),(35211),(35213),(35215),(35222),(35224),(35232),(35234),(35236),(35238),(35240),(35248),(35259),(35268),(35279),(35281),(35283),(35285),(35287),(35289),(35291),(35296),(35298),(35300),(35302),(35304),(35320),(35322),(35324),(35326),(35328),(35330),(35332),(35334),(35336),(35338),(35340),(35342),(35344),(35346),(35348),(35350),(35352),(35354),(35356),(35358),(35360),(35362),(35364),(35366),(35368),(35370),(35372),(35373),(32006),(35376),(35378),(35380),(35382),(35384),(35386),(35391),(35393),(35395),(33987),(33986),(33988),(35398),(35400),(35402),(35404),(35406),(35408),(35410),(35412),(35414),(35416),(35418),(35420),(35422),(35424),(35426),(35428),(35430),(35432),(35434),(35436),(35438),(35440),(35442),(35444),(35447),(35449),(35451),(35453),(35455),(35457),(35459),(35461),(35463),(35465),(35466),(35468),(35470),(43835),(45575),(45577),(45871),(45873),(45875),(45877),(45879),(45884),(45889),(49847),(49851),(49852),(49853),(49857),(49858),(49859),(49863),(49864),(49865),(49869),(49870),(49871),(49875),(49876),(49877),(49881),(49882),(49883),(49887),(49888),(50021),(50033),(50035),(50037),(50039),(50129),(50131),(50133),(50169),(50179),(50340),(50387),(50390),(50406),(50450),(50452),(50454),(50471),(50473),(50491),(50615),(50667),(50672),(50674),(50679),(50704)) tvc_0\"\r\n                      }\r\n                    ]\r\n                  }\r\n                }\r\n              ]\r\n            }\r\n          },\r\n          {\r\n            \"transformation\": {\r\n              \"select_id\": 2,\r\n              \"from\": \"IN (SELECT)\",\r\n              \"to\": \"materialization\",\r\n              \"sjm_scan_allowed\": true,\r\n              \"possible\": true\r\n            }\r\n          },\r\n          {\r\n            \"transformation\": {\r\n              \"select_id\": 2,\r\n              \"from\": \"IN (SELECT)\",\r\n              \"to\": \"semijoin\",\r\n              \"converted_to_semi_join\": true\r\n            }\r\n          },\r\n          {\r\n            \"condition_processing\": {\r\n              \"condition\": \"WHERE\",\r\n              \"original_condition\": \"states.last_updated_ts >= 1732708152.6401002e0 and states.last_updated_ts < 1734107999.999999e0 and 1 and states.metadata_id = tvc_0._col_1\",\r\n              \"steps\": [\r\n                {\r\n                  \"transformation\": \"equality_propagation\",\r\n                  \"resulting_condition\": \"states.last_updated_ts >= 1732708152.6401002e0 and states.last_updated_ts < 1734107999.999999e0 and 1 and states.metadata_id = tvc_0._col_1\"\r\n                },\r\n                {\r\n                  \"transformation\": \"constant_propagation\",\r\n                  \"resulting_condition\": \"states.last_updated_ts >= 1732708152.6401002e0 and states.last_updated_ts < 1734107999.999999e0 and 1 and states.metadata_id = tvc_0._col_1\"\r\n                },\r\n                {\r\n                  \"transformation\": \"trivial_condition_removal\",\r\n                  \"resulting_condition\": \"states.last_updated_ts >= 1732708152.6401002e0 and states.last_updated_ts < 1734107999.999999e0 and states.metadata_id = tvc_0._col_1\"\r\n                }\r\n              ]\r\n            }\r\n          },\r\n          {\r\n            \"table_dependencies\": [\r\n              {\r\n                \"table\": \"states\",\r\n                \"row_may_be_null\": false,\r\n                \"map_bit\": 0,\r\n                \"depends_on_map_bits\": []\r\n              },\r\n              {\r\n                \"table\": \"<derived3>\",\r\n                \"row_may_be_null\": false,\r\n                \"map_bit\": 1,\r\n                \"depends_on_map_bits\": []\r\n              }\r\n            ]\r\n          },\r\n          {\r\n            \"ref_optimizer_key_uses\": [\r\n              {\r\n                \"table\": \"states\",\r\n                \"index\": \"ix_states_metadata_id_last_updated_ts\",\r\n                \"field\": \"metadata_id\",\r\n                \"equals\": \"tvc_0._col_1\",\r\n                \"null_rejecting\": true\r\n              },\r\n              {\r\n                \"table\": \"<derived3>\",\r\n                \"index\": \"distinct_key\",\r\n                \"field\": \"_col_1\",\r\n                \"equals\": \"states.metadata_id\",\r\n                \"null_rejecting\": true\r\n              },\r\n              {\r\n                \"table\": \"<derived3>\",\r\n                \"index\": \"key1\",\r\n                \"field\": \"_col_1\",\r\n                \"equals\": \"states.metadata_id\",\r\n                \"null_rejecting\": true\r\n              }\r\n            ]\r\n          },\r\n          {\r\n            \"rows_estimation\": [\r\n              {\r\n                \"table\": \"states\",\r\n                \"range_analysis\": {\r\n                  \"table_scan\": {\r\n                    \"rows\": 34802007,\r\n                    \"cost\": 5870.448962\r\n                  },\r\n                  \"potential_range_indexes\": [\r\n                    {\r\n                      \"index\": \"PRIMARY\",\r\n                      \"usable\": false,\r\n                      \"cause\": \"not applicable\"\r\n                    },\r\n                    {\r\n                      \"index\": \"ix_states_last_updated_ts\",\r\n                      \"usable\": true,\r\n                      \"key_parts\": [\"last_updated_ts\", \"state_id\"]\r\n                    },\r\n                    {\r\n                      \"index\": \"ix_states_context_id_bin\",\r\n                      \"usable\": false,\r\n                      \"cause\": \"not applicable\"\r\n                    },\r\n                    {\r\n                      \"index\": \"ix_states_metadata_id_last_updated_ts\",\r\n                      \"usable\": true,\r\n                      \"key_parts\": [\"metadata_id\", \"last_updated_ts\", \"state_id\"]\r\n                    },\r\n                    {\r\n                      \"index\": \"ix_states_old_state_id\",\r\n                      \"usable\": false,\r\n                      \"cause\": \"not applicable\"\r\n                    },\r\n                    {\r\n                      \"index\": \"ix_states_attributes_id\",\r\n                      \"usable\": false,\r\n                      \"cause\": \"not applicable\"\r\n                    }\r\n                  ],\r\n                  \"best_covering_index_scan\": {\r\n                    \"index\": \"ix_states_metadata_id_last_updated_ts\",\r\n                    \"cost\": 5167.88395,\r\n                    \"chosen\": true\r\n                  },\r\n                  \"setup_range_conditions\": [],\r\n                  \"analyzing_range_alternatives\": {\r\n                    \"range_scan_alternatives\": [\r\n                      {\r\n                        \"index\": \"ix_states_last_updated_ts\",\r\n                        \"ranges\": [\r\n                          \"(1732708152.6401002) <= (last_updated_ts) < (1734107999.999999)\"\r\n                        ],\r\n                        \"rowid_ordered\": false,\r\n                        \"using_mrr\": false,\r\n                        \"index_only\": false,\r\n                        \"rows\": 34802007,\r\n                        \"cost\": 34804.33004,\r\n                        \"chosen\": false,\r\n                        \"cause\": \"cost\"\r\n                      }\r\n                    ],\r\n                    \"analyzing_roworder_intersect\": {\r\n                      \"cause\": \"too few roworder scans\"\r\n                    },\r\n                    \"analyzing_index_merge_union\": []\r\n                  },\r\n                  \"group_index_range\": {\r\n                    \"chosen\": false,\r\n                    \"cause\": \"not single_table\"\r\n                  }\r\n                }\r\n              },\r\n              {\r\n                \"selectivity_for_indexes\": [\r\n                  {\r\n                    \"index_name\": \"ix_states_last_updated_ts\",\r\n                    \"selectivity_from_index\": 1\r\n                  }\r\n                ],\r\n                \"selectivity_for_columns\": [],\r\n                \"cond_selectivity\": 1\r\n              },\r\n              {\r\n                \"table\": \"<derived3>\",\r\n                \"table_scan\": {\r\n                  \"rows\": 1396,\r\n                  \"read_cost\": 0.024449438,\r\n                  \"read_and_compare_cost\": 0.072379702\r\n                }\r\n              }\r\n            ]\r\n          },\r\n          {\r\n            \"semijoin_table_pullout\": {\r\n              \"pulled_out_tables\": [\"tvc_0\"]\r\n            }\r\n          },\r\n          {\r\n            \"considered_execution_plans\": [\r\n              {\r\n                \"plan_prefix\": \"\",\r\n                \"get_costs_for_tables\": [\r\n                  {\r\n                    \"best_access_path\": {\r\n                      \"table\": \"<derived3>\",\r\n                      \"plan_details\": {\r\n                        \"record_count\": 1\r\n                      },\r\n                      \"considered_access_paths\": [\r\n                        {\r\n                          \"access_type\": \"scan\",\r\n                          \"rows\": 1396,\r\n                          \"rows_after_filter\": 1396,\r\n                          \"rows_out\": 1396,\r\n                          \"cost\": 0.072379702,\r\n                          \"index_only\": false,\r\n                          \"chosen\": true\r\n                        }\r\n                      ],\r\n                      \"chosen_access_method\": {\r\n                        \"type\": \"scan\",\r\n                        \"rows_read\": 1396,\r\n                        \"rows_out\": 1396,\r\n                        \"cost\": 0.072379702,\r\n                        \"uses_join_buffering\": false\r\n                      }\r\n                    }\r\n                  },\r\n                  {\r\n                    \"best_access_path\": {\r\n                      \"table\": \"states\",\r\n                      \"plan_details\": {\r\n                        \"record_count\": 1\r\n                      },\r\n                      \"considered_access_paths\": [\r\n                        {\r\n                          \"access_type\": \"scan\",\r\n                          \"rows\": 34802007,\r\n                          \"rows_after_filter\": 34802007,\r\n                          \"rows_out\": 34802007,\r\n                          \"cost\": 5167.88395,\r\n                          \"index_only\": true,\r\n                          \"chosen\": true,\r\n                          \"use_tmp_table\": true\r\n                        }\r\n                      ],\r\n                      \"chosen_access_method\": {\r\n                        \"type\": \"scan\",\r\n                        \"rows_read\": 34802007,\r\n                        \"rows_out\": 34802007,\r\n                        \"cost\": 5167.88395,\r\n                        \"uses_join_buffering\": false\r\n                      }\r\n                    }\r\n                  }\r\n                ]\r\n              },\r\n              {\r\n                \"plan_prefix\": \"\",\r\n                \"table\": \"<derived3>\",\r\n                \"rows_for_plan\": 1396,\r\n                \"cost_for_plan\": 0.072379702,\r\n                \"semijoin_strategy_choice\": [],\r\n                \"rest_of_plan\": [\r\n                  {\r\n                    \"plan_prefix\": \"<derived3>\",\r\n                    \"get_costs_for_tables\": [\r\n                      {\r\n                        \"best_access_path\": {\r\n                          \"table\": \"states\",\r\n                          \"plan_details\": {\r\n                            \"record_count\": 1396\r\n                          },\r\n                          \"considered_access_paths\": [\r\n                            {\r\n                              \"access_type\": \"ref\",\r\n                              \"index\": \"ix_states_metadata_id_last_updated_ts\",\r\n                              \"rows\": 558,\r\n                              \"cost\": 117.7539262,\r\n                              \"chosen\": true\r\n                            },\r\n                            {\r\n                              \"type\": \"scan\",\r\n                              \"chosen\": false,\r\n                              \"cause\": \"cost\"\r\n                            }\r\n                          ],\r\n                          \"chosen_access_method\": {\r\n                            \"type\": \"ref\",\r\n                            \"rows_read\": 558,\r\n                            \"rows_out\": 558,\r\n                            \"cost\": 117.7539262,\r\n                            \"uses_join_buffering\": false\r\n                          }\r\n                        }\r\n                      }\r\n                    ]\r\n                  },\r\n                  {\r\n                    \"plan_prefix\": \"<derived3>\",\r\n                    \"table\": \"states\",\r\n                    \"rows_for_plan\": 778968,\r\n                    \"cost_for_plan\": 117.8263059,\r\n                    \"semijoin_strategy_choice\": [],\r\n                    \"cost_for_sorting\": 530.0209546\r\n                  }\r\n                ]\r\n              },\r\n              {\r\n                \"plan_prefix\": \"\",\r\n                \"table\": \"states\",\r\n                \"rows_for_plan\": 34802007,\r\n                \"cost_for_plan\": 5167.88395,\r\n                \"semijoin_strategy_choice\": [],\r\n                \"pruned_by_cost\": true,\r\n                \"current_cost\": 5167.88395,\r\n                \"best_cost\": 647.8472605\r\n              }\r\n            ]\r\n          },\r\n          {\r\n            \"best_join_order\": [\"<derived3>\", \"states\"],\r\n            \"rows\": 778968,\r\n            \"cost\": 647.8472605\r\n          },\r\n          {\r\n            \"substitute_best_equal\": {\r\n              \"condition\": \"WHERE\",\r\n              \"resulting_condition\": \"states.last_updated_ts >= 1732708152.6401002e0 and states.last_updated_ts < 1734107999.999999e0 and states.metadata_id = tvc_0._col_1\"\r\n            }\r\n          },\r\n          {\r\n            \"attaching_conditions_to_tables\": {\r\n              \"attached_conditions_computation\": [],\r\n              \"attached_conditions_summary\": [\r\n                {\r\n                  \"table\": \"<derived3>\",\r\n                  \"attached_condition\": null\r\n                },\r\n                {\r\n                  \"table\": \"states\",\r\n                  \"attached_condition\": \"states.last_updated_ts >= 1732708152.6401002e0 and states.last_updated_ts < 1734107999.999999e0 and states.metadata_id = tvc_0._col_1\"\r\n                }\r\n              ]\r\n            }\r\n          },\r\n          {\r\n            \"make_join_readinfo\": []\r\n          },\r\n          {\r\n            \"prepare_sum_aggregators\": {\r\n              \"function\": \"max(states.last_updated_ts)\",\r\n              \"aggregator_type\": \"simple\"\r\n            }\r\n          }\r\n        ]\r\n      }\r\n    },\r\n    {\r\n      \"join_execution\": {\r\n        \"select_id\": 1,\r\n        \"steps\": []\r\n      }\r\n    }\r\n  ]\r\n}\r\nMISSING_BYTES_BEYOND_MAX_MEM_SIZE: 0\r\n          INSUFFICIENT_PRIVILEGES: 0\r\n1 row in set (0.009 sec)\r\n\r\n```\nHere is < 1000\r\n[opt_less_than_1000 (1).txt](https://github.com/user-attachments/files/18136569/opt_less_than_1000.1.txt)\r\n\r\n\r\n\n>=1000\r\n\r\ndoesn't choose `group_index_range` because \r\n\r\n```\r\n                  \"group_index_range\": {\r\n                    \"chosen\": false,\r\n                    \"cause\": \"not single_table\"\r\n                  }\r\n```\nPostgresql likely has a different optimizer issue\nThe solution for MySQL is to break up the query in 999 or less and than combine the result.\r\n\r\nPostgresql doesn't support \"skip scan\" or [\"loose index scan\"](https://wiki.postgresql.org/wiki/Loose_indexscan)s so we need to use a different query for postgresql to use a recursive query instead .. which is going to make the solution here quite complex as we need branching based on the db engine\r\n\nA lateral join will work for postgresql\r\nsomething like:\r\n```sql\r\nSELECT     known_metadata_id,\r\n           last_updated_ts\r\nFROM       unnest('{2169, 2170, 485, 661, 672, 673, 753, 754, 755, 756, 759, 450, 463, 483, 2003, 2004, 2007, 2008, 2009, 2000, 2001, 1968, 627, 569, 570, 571, 572, 573, 574, 591, 592, 593, 634, 643, 1559, 1537, 1546, 1741, 1742, 1743, 1745, 1751, 1753, 1756, 1757, 1758, 1759, 1760, 1761, 421, 2, 7, 20, 12, 2118, 2120, 2135, 2137, 494, 502, 511, 549, 554, 561, 566, 929, 935, 1313, 1314, 1315, 608}'::int[]) known_metadata_id\r\nCROSS JOIN lateral\r\n           (\r\n                  SELECT max(inner_states.last_updated_ts) AS last_updated_ts\r\n                  FROM   states inner_states\r\n                  WHERE  inner_states.last_updated_ts >= 1668568337.475832\r\n                  AND    inner_states.last_updated_ts < 1733899499.999999\r\n                  AND    inner_states.metadata_id = known_metadata_id ) AS start_time_states\r\n```\nFor MySQL/MariaDB/sqlite: limit to 999 metadata_ids https://github.com/home-assistant/core/issues/132865#issuecomment-2543160459 and than combine the results in Python (dict merge is cheap)\r\nFor Postgresql, use a lateral join: https://github.com/home-assistant/core/issues/132865#issuecomment-2543307753\r\n\r\nNow making that all work in sqlalchemy is likely going to be an nightmare\nShould look something like this for postgresql\r\n\r\n```\r\nSELECT \r\n  anon_1.metadata_id, \r\n  anon_1.state, \r\n  anon_1.last_updated_ts, \r\n  anon_1.last_changed_ts, \r\n  anon_1.attributes \r\nFROM \r\n  (\r\n    SELECT \r\n      anon_2.metadata_id AS metadata_id, \r\n      anon_2.state AS state, \r\n      anon_2.last_updated_ts AS last_updated_ts, \r\n      anon_2.last_changed_ts AS last_changed_ts, \r\n      anon_2.attributes AS attributes \r\n    FROM \r\n      (\r\n        SELECT \r\n          states.metadata_id AS metadata_id, \r\n          states.state AS state, \r\n          0 AS last_updated_ts, \r\n          0 AS last_changed_ts, \r\n          CASE WHEN (\r\n            state_attributes.shared_attrs IS NULL\r\n          ) THEN states.attributes ELSE state_attributes.shared_attrs END AS attributes \r\n        FROM \r\n          states \r\n          JOIN (\r\n            SELECT \r\n              known_metadata_id as max_metadata_id, \r\n              last_updated_ts as max_last_updated \r\n            FROM \r\n              unnest(\r\n                '{2169, 2170, 485, 661, 672, 673, 753, 754, 755, 756, 759, 450, 463, 483, 2003, 2004, 2007, 2008, 2009, 2000, 2001, 1968, 627, 569, 570, 571, 572, 573, 574, 591, 592, 593, 634, 643, 1559, 1537, 1546, 1741, 1742, 1743, 1745, 1751, 1753, 1756, 1757, 1758, 1759, 1760, 1761, 421, 2, 7, 20, 12, 2118, 2120, 2135, 2137, 494, 502, 511, 549, 554, 561, 566, 929, 935, 1313, 1314, 1315, 608}' :: int[]\r\n              ) known_metadata_id CROSS \r\n              JOIN LATERAL (\r\n                SELECT \r\n                  Max(inner_states.last_updated_ts) as last_updated_ts \r\n                FROM \r\n                  states inner_states \r\n                WHERE \r\n                  inner_states.last_updated_ts >= 1668568337.475832 \r\n                  AND inner_states.last_updated_ts < 1733899499.999999 \r\n                  AND inner_states.metadata_id = known_metadata_id\r\n              ) as start_time_states\r\n          ) AS anon_3 ON states.metadata_id = anon_3.max_metadata_id \r\n          AND states.last_updated_ts = anon_3.max_last_updated \r\n          LEFT OUTER JOIN state_attributes ON states.attributes_id = state_attributes.attributes_id \r\n        WHERE \r\n          states.last_updated_ts >= 1668568337.475832 \r\n          AND states.last_updated_ts < 1733899499.999999 \r\n          AND states.metadata_id IN (\r\n            2169, 2170, 485, 661, 672, 673, 753, 754, \r\n            755, 756, 759, 450, 463, 483, 2003, 2004, \r\n            2007, 2008, 2009, 2000, 2001, 1968, \r\n            627, 569, 570, 571, 572, 573, 574, 591, \r\n            592, 593, 634, 643, 1559, 1537, 1546, \r\n            1741, 1742, 1743, 1745, 1751, 1753, \r\n            1756, 1757, 1758, 1759, 1760, 1761, \r\n            421, 2, 7, 20, 12, 2118, 2120, 2135, 2137, \r\n            494, 502, 511, 549, 554, 561, 566, 929, \r\n            935, 1313, 1314, 1315, 608\r\n          )\r\n      ) AS anon_2 \r\n    UNION ALL \r\n    SELECT \r\n      anon_4.metadata_id AS metadata_id, \r\n      anon_4.state AS state, \r\n      anon_4.last_updated_ts AS last_updated_ts, \r\n      anon_4.last_changed_ts AS last_changed_ts, \r\n      anon_4.attributes AS attributes \r\n    FROM \r\n      (\r\n        SELECT \r\n          states.metadata_id AS metadata_id, \r\n          states.state AS state, \r\n          states.last_updated_ts AS last_updated_ts, \r\n          states.last_changed_ts AS last_changed_ts, \r\n          CASE WHEN (\r\n            state_attributes.shared_attrs IS NULL\r\n          ) THEN states.attributes ELSE state_attributes.shared_attrs END AS attributes \r\n        FROM \r\n          states \r\n          LEFT OUTER JOIN state_attributes ON states.attributes_id = state_attributes.attributes_id \r\n        WHERE \r\n          states.metadata_id IN (\r\n            2169, 2170, 485, 661, 672, 673, 753, 754, \r\n            755, 756, 759, 450, 463, 483, 2003, 2004, \r\n            2007, 2008, 2009, 2000, 2001, 1968, \r\n            627, 569, 570, 571, 572, 573, 574, 591, \r\n            592, 593, 634, 643, 1559, 1537, 1546, \r\n            1741, 1742, 1743, 1745, 1751, 1753, \r\n            1756, 1757, 1758, 1759, 1760, 1761, \r\n            421, 2, 7, 20, 12, 2118, 2120, 2135, 2137, \r\n            494, 502, 511, 549, 554, 561, 566, 929, \r\n            935, 1313, 1314, 1315, 608\r\n          ) \r\n          AND states.last_updated_ts > 1733899499.999999 \r\n          AND states.last_updated_ts < 1733899800.0\r\n      ) AS anon_4\r\n  ) AS anon_1 \r\nORDER BY \r\n  anon_1.metadata_id, \r\n  anon_1.last_updated_ts\r\n```\nHaven\u2019t found any issues with SQLite as it seems to optimize well regardless\n@bdraco thanks. I noticed, that other sql engines suffered way worse then just CPU spiking every five minutes which a few users have with SQLite. \r\nI now have one question if I may. I saw a revert for \"Improve recorder history queries\" which is most likely causing that spiking CPU every 5 minutes.  What is a future plan for it? Is it going to be removed, or you plan to combine your optimizations and bring it back? \nIt will get restored in a future version once we have the new optimizations in place \nAlright thanks. I will need to check release notes more carefully and when I see this restored I should try in my test home assistance instance first :-)\n`sqlalchemy` doesn't appear to have support for CROSS JOIN as it doesn't like the cartesian product\r\n\r\nMaybe we can write it as a join with an outerjoin.\r\n\r\nI've spent more time trying to get `sqlalchemy` to do it than figuring out how to optimize the query \ud83d\ude22 \n```sql\r\nSELECT \r\n  known_metadata_id, \r\n  last_updated_ts \r\nFROM \r\n  unnest(\r\n    '{2169, 2170, 485, 661, 672, 673, 753, 754, 755, 756, 759, 450, 463, 483, 2003, 2004, 2007, 2008, 2009, 2000, 2001, 1968, 627, 569, 570, 571, 572, 573, 574, 591, 592, 593, 634, 643, 1559, 1537, 1546, 1741, 1742, 1743, 1745, 1751, 1753, 1756, 1757, 1758, 1759, 1760, 1761, 421, 2, 7, 20, 12, 2118, 2120, 2135, 2137, 494, 502, 511, 549, 554, 561, 566, 929, 935, 1313, 1314, 1315, 608}' :: int[]\r\n  ) known_metadata_id \r\n  JOIN lateral (\r\n    SELECT \r\n      max(inner_states.last_updated_ts) AS last_updated_ts \r\n    FROM \r\n      states inner_states \r\n    WHERE \r\n      inner_states.last_updated_ts >= 1668568337.475832 \r\n      AND inner_states.last_updated_ts < 1733899499.999999 \r\n      AND inner_states.metadata_id = known_metadata_id\r\n  ) AS start_time_states\r\n  ON true;\r\n```\r\n\r\nThis should work to eliminate the `CROSS`.. kinda hacky but I don't think there is another way with `sqlalchemy` after spending some time digging through the `sqlalchemy` code\nfound https://groups.google.com/g/sqlalchemy/c/3nW-yX1Dm5Q/m/osU0B1lzd9kJ which pretty much suggests doing what I came up with above \ud83d\ude48 \n```python\r\n    max_metadata_id = func.unnest(metadata_ids)\r\n    max_metadata_id_alias = max_metadata_id.alias(\"max_metadata_id\")\r\n    max_metadata_id_alias_column = max_metadata_id_alias.column\r\n    max_last_updated = (\r\n        select(func.max(States.last_updated_ts))\r\n        .where(\r\n            (States.metadata_id == max_metadata_id_alias_column)\r\n            & (States.last_updated_ts >= run_start_ts)\r\n            & (States.last_updated_ts < epoch_time)\r\n        )\r\n        .subquery()\r\n        .lateral()\r\n    )\r\n    most_recent_states_for_entities_by_date = (\r\n        select(max_metadata_id_alias_column.label(\"max_metadata_id\"), max_last_updated.c[0].label(\"max_last_updated\"))\r\n        .select_from(max_metadata_id_alias)\r\n        .join(max_last_updated, true())\r\n    ).subquery()\r\n```\r\n\r\nThat works out side of a lambda, but inside a lambda the `metadata_ids` gets expanded so it fails.\r\n\r\nSo we probably need to use `VALUES`\n```sql\r\nSELECT \r\n  anon_1.metadata_id, \r\n  anon_1.state, \r\n  anon_1.last_updated_ts, \r\n  anon_1.last_changed_ts, \r\n  anon_1.attributes \r\nFROM \r\n  (\r\n    SELECT \r\n      anon_2.metadata_id AS metadata_id, \r\n      anon_2.state AS state, \r\n      anon_2.last_updated_ts AS last_updated_ts, \r\n      anon_2.last_changed_ts AS last_changed_ts, \r\n      anon_2.attributes AS attributes \r\n    FROM \r\n      (\r\n        SELECT \r\n          states.metadata_id AS metadata_id, \r\n          states.state AS state, \r\n          %(param_1) s AS last_updated_ts, \r\n          %(param_2) s AS last_changed_ts, \r\n          CASE WHEN (\r\n            state_attributes.shared_attrs IS NULL\r\n          ) THEN states.attributes ELSE state_attributes.shared_attrs END AS attributes \r\n        FROM \r\n          states \r\n          JOIN (\r\n            SELECT \r\n              max_metadata_id AS max_metadata_id, \r\n              anon_4.max_1 AS max_last_updated \r\n            FROM \r\n              unnest(\r\n                (\r\n                  %(metadata_ids_1_1) s, \r\n                  %(metadata_ids_1_2) s, \r\n                  %(metadata_ids_1_3) s\r\n                )\r\n              ) AS max_metadata_id \r\n              JOIN LATERAL (\r\n                SELECT \r\n                  max(states.last_updated_ts) AS max_1 \r\n                FROM \r\n                  states \r\n                WHERE \r\n                  states.metadata_id = max_metadata_id \r\n                  AND states.last_updated_ts >= %(oldest_ts_1) s \r\n                  AND states.last_updated_ts < %(start_time_ts_1) s\r\n              ) AS anon_4 ON true\r\n          ) AS anon_3 ON states.metadata_id = anon_3.max_metadata_id \r\n          AND states.last_updated_ts = anon_3.max_last_updated \r\n          LEFT OUTER JOIN state_attributes ON states.attributes_id = state_attributes.attributes_id \r\n        WHERE \r\n          states.last_updated_ts >= %(oldest_ts_1) s \r\n          AND states.last_updated_ts < %(start_time_ts_1) s \r\n          AND states.metadata_id IN (\r\n            %(metadata_ids_1_1) s, \r\n            %(metadata_ids_1_2) s, \r\n            %(metadata_ids_1_3) s\r\n          )\r\n      ) AS anon_2 \r\n    UNION ALL \r\n    SELECT \r\n      anon_5.metadata_id AS metadata_id, \r\n      anon_5.state AS state, \r\n      anon_5.last_updated_ts AS last_updated_ts, \r\n      anon_5.last_changed_ts AS last_changed_ts, \r\n      anon_5.attributes AS attributes \r\n    FROM \r\n      (\r\n        SELECT \r\n          states.metadata_id AS metadata_id, \r\n          states.state AS state, \r\n          states.last_updated_ts AS last_updated_ts, \r\n          states.last_changed_ts AS last_changed_ts, \r\n          CASE WHEN (\r\n            state_attributes.shared_attrs IS NULL\r\n          ) THEN states.attributes ELSE state_attributes.shared_attrs END AS attributes \r\n        FROM \r\n          states \r\n          LEFT OUTER JOIN state_attributes ON states.attributes_id = state_attributes.attributes_id \r\n        WHERE \r\n          states.metadata_id IN (\r\n            %(metadata_ids_1_1) s, \r\n            %(metadata_ids_1_2) s, \r\n            %(metadata_ids_1_3) s\r\n          ) \r\n          AND states.last_updated_ts > %(start_time_ts_1) s \r\n          AND states.last_updated_ts < %(end_time_ts_1) s\r\n      ) AS anon_5\r\n  ) AS anon_1 \r\nORDER BY \r\n  anon_1.metadata_id, \r\n  anon_1.last_updated_ts\r\n\r\n```\r\n\r\nThis is how `sqlalchemy` renders it\nproblem is \r\n```\r\n              unnest(\r\n                (\r\n                  %(metadata_ids_1_1) s, \r\n                  %(metadata_ids_1_2) s, \r\n                  %(metadata_ids_1_3) s\r\n                )\r\n              ) AS max_metadata_id \r\n```\r\n\r\nThis results in `record` and not an array\nits a tiny bit slower, but we can work around that by joining it to StatesMeta.\r\n\r\nThe cost is almost nothing for the query \r\n```\r\n# explain             SELECT \r\n              states_meta.metadata_id AS max_metadata_id, \r\n              anon_4.max_1 AS max_last_updated \r\n            FROM \r\n              states_meta \r\n              JOIN LATERAL (\r\n                SELECT \r\n                  max(states.last_updated_ts) AS max_1 \r\n                FROM \r\n                  states \r\n                WHERE \r\n                  states.metadata_id = states_meta.metadata_id \r\n                  AND states.last_updated_ts >= 0\r\n                  AND states.last_updated_ts < 1734382799.999999\r\n              ) AS anon_4 ON states_meta.metadata_id = states_meta.metadata_id \r\n            WHERE \r\n              states_meta.metadata_id IN (2169, 2170, 485, 661, 672, 673, 753, 754, 755, 756, 759, 450, 463, 483, 2003, 2004, 2007, 2008, 2009, 2000, 2001, 1968, 627, 569, 570, 571, 572, 573, 574, 591, 592, 593, 634, 643, 1559, 1537, 1546, 1741, 1742, 1743, 1745, 1751, 1753, 1756, 1757, 1758, 1759, 1760, 1761, 421, 2, 7, 20, 12, 2118, 2120, 2135, 2137, 494, 502, 511, 549, 554, 561, 566, 929, 935, 1313, 1314, 1315, 608);\r\n                                                                                                                                                                                                  QUERY PLAN                                                                                                                                                                                                   \r\n---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------\r\n Nested Loop  (cost=0.89..119.18 rows=71 width=16)\r\n   ->  Index Only Scan using states_meta_pkey on states_meta  (cost=0.28..73.50 rows=71 width=8)\r\n         Index Cond: ((metadata_id IS NOT NULL) AND (metadata_id = ANY ('{2169,2170,485,661,672,673,753,754,755,756,759,450,463,483,2003,2004,2007,2008,2009,2000,2001,1968,627,569,570,571,572,573,574,591,592,593,634,643,1559,1537,1546,1741,1742,1743,1745,1751,1753,1756,1757,1758,1759,1760,1761,421,2,7,20,12,2118,2120,2135,2137,494,502,511,549,554,561,566,929,935,1313,1314,1315,608}'::bigint[])))\r\n   ->  Result  (cost=0.61..0.62 rows=1 width=8)\r\n         InitPlan 1 (returns $1)\r\n           ->  Limit  (cost=0.57..0.61 rows=1 width=8)\r\n                 ->  Index Only Scan Backward using ix_states_metadata_id_last_updated_ts on states  (cost=0.57..22700.52 rows=555408 width=8)\r\n                       Index Cond: ((metadata_id = $0) AND (last_updated_ts IS NOT NULL) AND (last_updated_ts >= '0'::double precision) AND (last_updated_ts < '1734382799.999999'::double precision))\r\n(8 rows)\r\n```\neven with the join to StatesMeta its ~99.99956803% faster\n\nHey there @home-assistant/core, mind taking a look at this issue as it has been labeled with an integration (`recorder`) you are listed as a [code owner](https://github.com/home-assistant/core/blob/dev/CODEOWNERS#L1224) for? Thanks!\n\n<details>\n<summary>Code owner commands</summary>\n\n\nCode owners of `recorder` can trigger bot actions by commenting:\n\n- `@home-assistant close` Closes the issue.\n- `@home-assistant rename Awesome new title` Renames the issue.\n- `@home-assistant reopen` Reopen the issue.\n- `@home-assistant unassign recorder` Removes the current integration label and assignees on the issue, add the integration domain after the command.\n- `@home-assistant add-label needs-more-information` Add a label (needs-more-information, problem in dependency, problem in custom component) to the issue.\n- `@home-assistant remove-label needs-more-information` Remove a label (needs-more-information, problem in dependency, problem in custom component) on the issue.\n\n</details>\n\n\n<sub><sup>(message by CodeOwnersMention)</sup></sub>\n\n---\n\n[recorder documentation](https://www.home-assistant.io/integrations/recorder)\n[recorder source](https://github.com/home-assistant/core/tree/dev/homeassistant/components/recorder)\n<sub><sup>(message by IssueLinks)</sup></sub>\nhttps://github.com/home-assistant/core/pull/133228 will take care of the PostgreSQL case.\r\n\r\nA completely separate solution is needed for MariaDB/MySQL\nhttps://github.com/home-assistant/core/pull/133397 will take care of MySQL/MariaDB case \nStill have a bit more testing to do for MySQL/MariaDB but it's almost there.\nIt turned out there were two places we hit the undocumented 1000 id limit for MySQL/MariaDB.  I've taken care of both of them in the linked PR.  There is effectively no documentation available about the optimizer limits and very limited information in the code itself so it took a very long time and lot of trial and error to validate the queries perform well.  We are firmly into edge case territory and pushing the limits of what the database engine can do.\nhere is the sqlite query\r\n```\r\nSELECT \r\n  anon_1.metadata_id, \r\n  anon_1.state, \r\n  anon_1.last_updated_ts, \r\n  anon_1.attributes \r\nFROM \r\n  (\r\n    SELECT \r\n      anon_2.metadata_id AS metadata_id, \r\n      anon_2.state AS state, \r\n      anon_2.last_updated_ts AS last_updated_ts, \r\n      anon_2.attributes AS attributes \r\n    FROM \r\n      (\r\n        SELECT \r\n          states.metadata_id AS metadata_id, \r\n          states.state AS state, \r\n          0 AS last_updated_ts, \r\n          CASE WHEN (\r\n            state_attributes.shared_attrs IS NULL\r\n          ) THEN states.attributes ELSE state_attributes.shared_attrs END AS attributes \r\n        FROM \r\n          states \r\n          JOIN (\r\n            SELECT \r\n              states.metadata_id AS max_metadata_id, \r\n              max(states.last_updated_ts) AS max_last_updated \r\n            FROM \r\n              states \r\n            WHERE \r\n              states.last_updated_ts >= 1700964910.915863 \r\n              AND states.last_updated_ts < 1734104099.999999 \r\n              AND states.metadata_id IN (\r\n                1668, 154, 155, 156, 165, 157, 158, 159, \r\n                166, 160, 161, 162, 163\r\n              ) \r\n            GROUP BY \r\n              states.metadata_id\r\n          ) AS anon_3 ON states.metadata_id = anon_3.max_metadata_id \r\n          AND states.last_updated_ts = anon_3.max_last_updated \r\n          LEFT OUTER JOIN state_attributes ON states.attributes_id = state_attributes.attributes_id \r\n        WHERE \r\n          states.last_updated_ts >= 1700964910.915863 \r\n          AND states.last_updated_ts < 1734104099.999999 \r\n          AND states.metadata_id IN (\r\n            1668, 154, 155, 156, 165, 157, 158, 159, \r\n            166, 160, 161, 162, 163\r\n          )\r\n      ) AS anon_2 \r\n    UNION ALL \r\n    SELECT \r\n      anon_4.metadata_id AS metadata_id, \r\n      anon_4.state AS state, \r\n      anon_4.last_updated_ts AS last_updated_ts, \r\n      anon_4.attributes AS attributes \r\n    FROM \r\n      (\r\n        SELECT \r\n          states.metadata_id AS metadata_id, \r\n          states.state AS state, \r\n          states.last_updated_ts AS last_updated_ts, \r\n          CASE WHEN (\r\n            state_attributes.shared_attrs IS NULL\r\n          ) THEN states.attributes ELSE state_attributes.shared_attrs END AS attributes \r\n        FROM \r\n          states \r\n          LEFT OUTER JOIN state_attributes ON states.attributes_id = state_attributes.attributes_id \r\n        WHERE \r\n          (\r\n            states.last_changed_ts = states.last_updated_ts \r\n            OR states.last_changed_ts IS NULL\r\n          ) \r\n          AND states.metadata_id IN (\r\n            1668, 154, 155, 156, 165, 157, 158, 159, \r\n            166, 160, 161, 162, 163\r\n          ) \r\n          AND states.last_updated_ts > 1734104099.999999 \r\n          AND states.last_updated_ts < 1734104400.0\r\n      ) AS anon_4\r\n  ) AS anon_1 \r\nORDER BY \r\n  anon_1.metadata_id, \r\n  anon_1.last_updated_ts\r\n```\nsqlite optimizes well\r\n```\r\nQUERY PLAN\r\n|--CO-ROUTINE anon_1\r\n|  `--COMPOUND QUERY\r\n|     |--LEFT-MOST SUBQUERY\r\n|     |  |--CO-ROUTINE anon_3\r\n|     |  |  `--SEARCH states USING COVERING INDEX ix_states_metadata_id_last_updated_ts (metadata_id=? AND last_updated_ts>? AND last_updated_ts<?)\r\n|     |  |--SCAN anon_3\r\n|     |  |--SEARCH states USING INDEX ix_states_metadata_id_last_updated_ts (metadata_id=? AND last_updated_ts=?)\r\n|     |  `--SEARCH state_attributes USING INTEGER PRIMARY KEY (rowid=?) LEFT-JOIN\r\n|     `--UNION ALL\r\n|        |--SEARCH states USING INDEX ix_states_metadata_id_last_updated_ts (metadata_id=? AND last_updated_ts>? AND last_updated_ts<?)\r\n|        `--SEARCH state_attributes USING INTEGER PRIMARY KEY (rowid=?) LEFT-JOIN\r\n|--SCAN anon_1\r\n`--USE TEMP B-TREE FOR ORDER BY\r\n```\nOnce https://github.com/home-assistant/core/pull/133397 and https://github.com/home-assistant/core/pull/133228 are merged we plan to un-revert https://github.com/home-assistant/core/pull/133203 and https://github.com/home-assistant/core/pull/133201\r\n\r\nI wanted to point out what I have not been able to replicate any slowdown with SQLite before or after those revert PRs.  With PostgreSQL, MariaDB, and MySQL we have good replication of the slowdowns and confirmed solutions.\r\n\r\n\nIf you are seeing a slowdown with 2024.12.0/1/2/3 and using SQLite and haven't already provided logs/database dumps please be sure to do so soon as the data that has already been provided by others show no slowdown and no replication if the issue with SQLite. \nHi. Thank you @bdraco. I provided SQL lite db and logs. And technically I am not experiencing slow downs. Only spiking CPU usage every five minutes which were solved in 2024.12.4. Issue it's replicateble with vanilla HA having my db+ Shelly 3em pro sensor (noisy sensor)\r\nSo does it mean that after unrevert I will most likely have this issue? And I should open new PR for that as this one is for slow downs?\r\n\n> Hi. Thank you @bdraco. I provided SQL lite db and logs. And technically I am not experiencing slow downs. Only spiking CPU usage every five minutes which were solved in 2024.12.4. Issue it's replicateble with vanilla HA having my db+ Shelly 3em pro sensor (noisy sensor) So does it mean that after unrevert I will most likely have this issue? And I should open new PR for that as this one is for slow downs?\r\n\r\nI'm honestly not sure if the issue will come back or not as I couldn't reproduce the performance issue with your test data.  It was still very fast with and without the revert.  If it does come back please open a new issue and ping me.\nThanks will definitely do. Is this subscribing to this issue enough for unrevert tracking or should I subscribe to specific PR?\nLooking at the explain above\r\n`SEARCH states USING COVERING INDEX ix_states_metadata_id_last_updated_ts (metadata_id=? AND last_updated_ts>? AND last_updated_ts<?)`\r\n\r\nIt doesn't look like SQLite searches the index backwards like PostgreSQL/MariaDB/MySQL do so it likely having to go through the whole index. While thats a lot faster than a table scan, its not ideal.\r\n\r\nI'm guessing its fast one my system because my test environment is probably an order of magnitude faster than your production.  I do see a small difference between the queries that I didn't notice before because the timing is not significantly more on my faster system.\nCan I somehow participate in running some queries and showing statistics from my end? \r\nAnd my system is not a potato :-) I don't feel any slow down I just hear NUC fan kicking in every 5 minutes for a CPU spike from 1% to 7%\nI can measure a difference (even if its small) so I don't think there is anything else we need at this time. I've tried to optimize it but it doesn't look like SQLite supports reverse index scans so I'm not sure we can actually improve it regardless.\nThere is a difference, but the SQLite group by is a bit slow...134x slower.  The PostgreSQL query was ~ 100000x slower, and the MySQL one was ~50000x slower.  So while its now where near the difference, its still slower.\r\n\r\n```\r\nsqlite> .timer on\r\nsqlite> SELECT \r\n   ...>   states.metadata_id AS max_metadata_id, \r\n   ...>   max(states.last_updated_ts) AS max_last_updated \r\n   ...> FROM \r\n   ...>   states \r\n   ...> WHERE \r\n   ...>   states.last_updated_ts < 1734103799.999999 \r\n   ...>   AND states.metadata_id IN (\r\n(x1...>     1668, 154, 155, 156, 165, 157, 158, 159, \r\n(x1...>     166, 160, 161, 162, 163\r\n(x1...>   ) \r\n   ...> GROUP BY \r\n   ...>   states.metadata_id\r\n   ...> ORDER by last_updated_ts DESC;\r\n161|1734103798.11453\r\n166|1734103798.11451\r\n159|1734103798.11447\r\n158|1734103798.11445\r\n157|1734103798.11444\r\n165|1734103798.11441\r\n156|1734103798.11439\r\n155|1734103798.11437\r\n154|1734103798.11429\r\n160|1734103794.11315\r\n162|1734103787.11253\r\n1668|1734103703.1364\r\n163|1734103673.35398\r\nRun Time: real 0.985 user 0.926614 sys 0.057697\r\nsqlite> \r\nsqlite> .timer on\r\nsqlite> SELECT \r\n   ...>   states.metadata_id AS max_metadata_id, \r\n   ...>   max(states.last_updated_ts) AS max_last_updated \r\n   ...> FROM \r\n   ...>   states \r\n   ...> WHERE \r\n   ...>   states.last_updated_ts < 1734103799.999999 \r\n   ...>   AND states.metadata_id == 154\r\n   ...> GROUP BY \r\n   ...>   states.metadata_id\r\n   ...> ;\r\n154|1734103798.11429\r\nRun Time: real 0.134 user 0.123637 sys 0.009396\r\n```\r\n\r\nHowever if we eliminate the GROUP BY, its fast.... Sadly I don't know a way to do that in a single query\r\n\r\n```\r\nsqlite> SELECT \r\n   ...>   states.metadata_id AS max_metadata_id, \r\n   ...>   states.last_updated_ts AS max_last_updated \r\n   ...> FROM \r\n   ...>   states \r\n   ...> WHERE \r\n   ...>   states.last_updated_ts < 1734103799.999999 \r\n   ...>   AND states.metadata_id == 154\r\n   ...> ORDER BY \r\n   ...>   states.last_updated_ts DESC LIMIT 1;\r\n154|1734103798.11429\r\nRun Time: real 0.000 user 0.000086 sys 0.000039\r\nsqlite> \r\n```\nWe can rewrite\r\n```\r\nSELECT \r\n  states.metadata_id AS max_metadata_id, \r\n  max(states.last_updated_ts) AS max_last_updated \r\nFROM \r\n  states \r\nWHERE \r\n  states.last_updated_ts < 1734103799.999999 \r\n  AND states.metadata_id IN (\r\n    1668, 154, 155, 156, 165, 157, 158, 159, \r\n    166, 160, 161, 162, 163\r\n  ) \r\nGROUP BY \r\n  states.metadata_id \r\nORDER by \r\n  last_updated_ts DESC\r\n```\r\n\r\nas \r\n\r\n```\r\nSELECT \r\n  states_meta.metadata_id as max_metadata_id, \r\n  states.last_updated_ts as max_last_updated\r\nFROM \r\n  states_meta \r\n  JOIN states ON states.last_updated_ts = (\r\n    SELECT \r\n      last_updated_ts \r\n    FROM \r\n      states \r\n    WHERE \r\n      metadata_id = states_meta.metadata_id \r\n      and last_updated_ts < 1734103799.999999 \r\n    ORDER BY \r\n      last_updated_ts DESC \r\n    LIMIT \r\n      1\r\n  ) \r\nwhere \r\n  states_meta.metadata_id IN (\r\n    1668, 154, 155, 156, 165, 157, 158, 159, \r\n    166, 160, 161, 162, 163\r\n  );\r\n```\noriginal\r\n```\r\nsqlite> SELECT \r\n   ...>   states.metadata_id AS max_metadata_id, \r\n   ...>   max(states.last_updated_ts) AS max_last_updated \r\n   ...> FROM \r\n   ...>   states \r\n   ...> WHERE \r\n   ...>   states.last_updated_ts < 1734103799.999999 \r\n   ...>   AND states.metadata_id IN (\r\n(x1...>     1668, 154, 155, 156, 165, 157, 158, 159, \r\n(x1...>     166, 160, 161, 162, 163\r\n(x1...>   ) \r\n   ...> GROUP BY \r\n   ...>   states.metadata_id \r\n   ...> ORDER by \r\n   ...>   last_updated_ts DESC;\r\n161|1734103798.11453\r\n166|1734103798.11451\r\n159|1734103798.11447\r\n158|1734103798.11445\r\n157|1734103798.11444\r\n165|1734103798.11441\r\n156|1734103798.11439\r\n155|1734103798.11437\r\n154|1734103798.11429\r\n160|1734103794.11315\r\n162|1734103787.11253\r\n1668|1734103703.1364\r\n163|1734103673.35398\r\nRun Time: real 0.996 user 0.939981 sys 0.054994\r\nsqlite> \r\n```\r\n\r\nnew \r\n```\r\nsqlite> .timer on\r\nsqlite> SELECT \r\n   ...>   states_meta.metadata_id as max_metadata_id, \r\n   ...>   states.last_updated_ts as max_last_updated\r\n   ...> FROM \r\n   ...>   states_meta \r\n   ...>   JOIN states ON states.last_updated_ts = (\r\n(x1...>     SELECT \r\n(x1...>       last_updated_ts \r\n(x1...>     FROM \r\n(x1...>       states \r\n(x1...>     WHERE \r\n(x1...>       metadata_id = states_meta.metadata_id \r\n(x1...>       and last_updated_ts < 1734103799.999999 \r\n(x1...>     ORDER BY \r\n(x1...>       last_updated_ts DESC \r\n(x1...>     LIMIT \r\n(x1...>       1\r\n(x1...>   ) \r\n   ...> where \r\n   ...>   states_meta.metadata_id IN (\r\n(x1...>     1668, 154, 155, 156, 165, 157, 158, 159, \r\n(x1...>     166, 160, 161, 162, 163\r\n(x1...>   );\r\n154|1734103798.11429\r\n155|1734103798.11437\r\n156|1734103798.11439\r\n157|1734103798.11444\r\n158|1734103798.11445\r\n159|1734103798.11447\r\n160|1734103794.11315\r\n161|1734103798.11453\r\n162|1734103787.11253\r\n163|1734103673.35398\r\n165|1734103798.11441\r\n166|1734103798.11451\r\n1668|1734103703.1364\r\nRun Time: real 0.001 user 0.000386 sys 0.000257\r\n```\nso the new query is roughly 996x faster for sqlite\nSo we end up with yet another branch for SQLite... but 996x faster seems worth it\nWill need to see if we can do a CORRELATED SCALAR SUBQUERY for MariaDB as well\nthat query seems to work for MariaDB as well\r\n```\r\nSELECT \r\n  states_meta.metadata_id as max_metadata_id, \r\n  states.last_updated_ts as max_last_updated\r\nFROM \r\n  states_meta \r\n  JOIN states ON states.last_updated_ts = (\r\n    SELECT \r\n      last_updated_ts \r\n    FROM \r\n      states \r\n    WHERE \r\n      metadata_id = states_meta.metadata_id \r\n      and last_updated_ts < 1734107999.999999e0\r\n    ORDER BY \r\n      last_updated_ts DESC \r\n    LIMIT \r\n      1\r\n  ) \r\nwhere \r\n  states_meta.metadata_id IN ( 222, 223, 224, 50501,\r\n                                   50518, 50535, 50564, 50581,\r\n                                   50598, 389, 49770, 391,\r\n                                   49772, 394, 395, 397,\r\n                                   32307, 32308, 32310, 32371,\r\n                                   235, 236, 237, 238,\r\n                                   239, 299, 300, 31826,\r\n                                   31808, 31813, 31825, 31829,\r\n                                   302, 303, 304, 305,\r\n                                   306, 307, 371, 246,\r\n                                   248, 251, 31965, 31966,\r\n                                   31967, 31968, 31969, 10809,\r\n                                   10810, 34465, 10813, 10812,\r\n                                   10814, 10816, 10817, 10818,\r\n                                   42219, 42217, 42221, 42222,\r\n                                   49716, 42223, 10826, 10828,\r\n                                   10830, 45857, 10832, 10831,\r\n                                   10833, 10834, 42224, 45850,\r\n                                   10837, 10839, 10838, 10840,\r\n                                   10836, 10842, 10843, 10844,\r\n                                   50378, 10845, 10846, 49717,\r\n                                   49971, 42226, 10851, 42227,\r\n                                   10909, 49975, 10854, 10855,\r\n                                   42228, 42229, 10858, 10859,\r\n                                   10861, 42230, 42231, 10864,\r\n                                   42232, 34537, 10867, 49842,\r\n                                   50294, 10869, 10870, 42233,\r\n                                   42234, 10874, 49718, 10878,\r\n                                   10880, 10881, 42236, 10883,\r\n                                   10884, 10885, 49720, 49721,\r\n                                   10890, 10891, 10893, 50675,\r\n                                   50394, 10898, 42238, 49722,\r\n                                   49723, 50297, 10902, 10903,\r\n                                   10904, 10905, 42239, 49785,\r\n                                   42240, 10825, 42242, 10913,\r\n                                   45592, 10916, 45565, 50412,\r\n                                   42541, 10919, 10920, 10921,\r\n                                   45895, 10923, 42243, 10926,\r\n                                   10927, 49728, 49724, 10931,\r\n                                   42246, 10933, 42247, 42248,\r\n                                   42249, 42250, 10972, 49725,\r\n                                   49726, 10940, 49727, 42253,\r\n                                   10943, 42254, 10945, 10960,\r\n                                   49719, 10911, 10922, 42220,\r\n                                   45556, 10822, 10985, 10895,\r\n                                   34469, 10824, 34473, 10841,\r\n                                   34474, 10872, 10853, 34475,\r\n                                   10906, 10934, 10957, 34486,\r\n                                   34493, 34501, 34505, 10970,\r\n                                   34545, 10971, 34557, 10975,\r\n                                   34559, 34561, 34568, 45263,\r\n                                   45270, 45273, 45302, 45534,\r\n                                   45537, 45540, 45543, 45546,\r\n                                   45549, 45553, 45559, 45562,\r\n                                   45567, 45571, 45581, 45584,\r\n                                   45590, 45596, 10924, 45603,\r\n                                   45750, 45760, 10961, 11008,\r\n                                   10962, 42241, 10954, 10900,\r\n                                   45752, 10965, 10946, 45754,\r\n                                   10980, 10966, 45867, 45880,\r\n                                   45885, 10964, 10974, 45893,\r\n                                   49843, 45897, 42244, 45899,\r\n                                   45901, 45903, 45905, 45907,\r\n                                   45909, 45931, 45948, 45950,\r\n                                   45952, 45954, 45956, 45963,\r\n                                   45965, 45967, 45972, 45974,\r\n                                   45976, 45978, 45980, 45987,\r\n                                   45989, 45991, 45993, 45995,\r\n                                   45997, 45999, 46001, 46003,\r\n                                   46005, 46007, 46009, 46011,\r\n                                   46013, 46015, 46017, 46019,\r\n                                   46021, 46023, 46025, 46027,\r\n                                   46029, 46031, 46033, 46035,\r\n                                   46037, 46039, 46041, 46043,\r\n                                   46045, 46047, 46049, 46051,\r\n                                   46086, 46088, 46090, 46092,\r\n                                   46094, 46096, 46098, 46100,\r\n                                   49962, 49967, 46102, 46104,\r\n                                   50008, 50011, 50013, 50015,\r\n                                   50022, 50043, 50062, 50071,\r\n                                   50073, 50076, 50106, 50114,\r\n                                   50165, 50170, 50173, 50309,\r\n                                   50312, 50331, 50335, 50344,\r\n                                   50346, 50354, 50357, 50360,\r\n                                   50363, 50366, 50369, 50373,\r\n                                   50375, 50391, 50397, 50402,\r\n                                   50409, 50415, 50418, 50475,\r\n                                   50478, 50481, 50484, 50487,\r\n                                   50606, 50616, 50619, 50621,\r\n                                   50625, 50668, 21117, 21118,\r\n                                   34466, 21121, 21120, 21122,\r\n                                   21124, 21125, 21126, 42257,\r\n                                   42255, 42259, 42260, 49729,\r\n                                   42261, 21134, 21136, 21138,\r\n                                   45858, 21140, 21139, 21141,\r\n                                   21142, 42262, 45851, 21145,\r\n                                   21147, 21146, 21148, 21144,\r\n                                   21150, 21151, 21152, 50379,\r\n                                   21153, 21154, 49730, 49972,\r\n                                   42264, 21159, 42265, 21217,\r\n                                   49976, 21162, 21163, 42266,\r\n                                   42267, 21166, 21167, 21169,\r\n                                   42268, 42269, 21172, 42270,\r\n                                   34538, 21175, 49844, 50295,\r\n                                   21177, 21178, 42271, 42272,\r\n                                   21182, 49731, 21186, 21188,\r\n                                   21189, 42274, 21191, 21192,\r\n                                   21193, 49733, 49734, 21198,\r\n                                   21199, 21201, 50676, 50395,\r\n                                   21206, 42276, 49735, 49736,\r\n                                   50298, 21210, 21211, 21212,\r\n                                   21213, 42277, 49786, 42278,\r\n                                   21133, 42280, 21221, 45593,\r\n                                   21224, 45566, 50413, 42542,\r\n                                   21227, 21228, 21229, 45896,\r\n                                   21231, 42281, 21234, 21235,\r\n                                   49741, 49737, 21239, 42284,\r\n                                   21241, 42285, 42286, 42287,\r\n                                   42288, 21280, 49738, 49739,\r\n                                   21248, 49740, 42291, 21251,\r\n                                   42292, 21253, 21268, 49732,\r\n                                   21219, 21230, 42258, 45557,\r\n                                   21130, 21293, 21203, 34470,\r\n                                   21132, 34477, 21149, 34478,\r\n                                   21180, 21161, 34479, 21214,\r\n                                   21242, 21265, 34487, 34494,\r\n                                   34502, 34506, 21278, 34546,\r\n                                   21279, 34558, 21283, 34560,\r\n                                   34562, 34569, 45264, 45271,\r\n                                   45274, 45303, 45535, 45538,\r\n                                   45541, 45544, 45547, 45550,\r\n                                   45554, 45560, 45563, 45568,\r\n                                   45572, 45582, 45585, 45591,\r\n                                   45597, 21232, 45604, 45751,\r\n                                   45761, 21269, 21316, 21270,\r\n                                   42279, 21262, 21208, 45753,\r\n                                   21273, 21254, 45755, 21288,\r\n                                   21274, 45868, 45881, 45886,\r\n                                   21272, 21282, 45894, 49845,\r\n                                   45898, 42282, 45900, 45902,\r\n                                   45904, 45906, 45908, 45910,\r\n                                   45932, 45949, 45951, 45953,\r\n                                   45955, 45957, 45964, 45966,\r\n                                   45968, 45973, 45975, 45977,\r\n                                   45979, 45981, 45988, 45990,\r\n                                   45992, 45994, 45996, 45998,\r\n                                   46000, 46002, 46004, 46006,\r\n                                   46008, 46010, 46012, 46014,\r\n                                   46016, 46018, 46020, 46022,\r\n                                   46024, 46026, 46028, 46030,\r\n                                   46032, 46034, 46036, 46038,\r\n                                   46040, 46042, 46044, 46046,\r\n                                   46048, 46050, 46052, 46087,\r\n                                   46089, 46091, 46093, 46095,\r\n                                   46097, 46099, 46101, 49963,\r\n                                   49968, 46103, 46105, 50009,\r\n                                   50012, 50014, 50016, 50023,\r\n                                   50044, 50063, 50072, 50074,\r\n                                   50077, 50107, 50115, 50166,\r\n                                   50171, 50174, 50310, 50313,\r\n                                   50332, 50336, 50345, 50347,\r\n                                   50355, 50358, 50361, 50364,\r\n                                   50367, 50370, 50374, 50376,\r\n                                   50392, 50398, 50403, 50410,\r\n                                   50416, 50419, 50476, 50479,\r\n                                   50482, 50485, 50488, 50607,\r\n                                   50617, 50620, 50622, 50626,\r\n                                   50669, 31525, 31526, 31527,\r\n                                   31528, 31571, 49965, 31574,\r\n                                   31573, 31575, 50329, 31576,\r\n                                   31577, 31579, 31578, 31572,\r\n                                   31581, 31582, 31583, 31584,\r\n                                   31585, 31586, 31587, 31588,\r\n                                   49966, 31591, 31590, 31592,\r\n                                   50330, 31593, 31594, 31596,\r\n                                   31595, 31589, 31598, 31599,\r\n                                   31600, 31601, 31602, 31603,\r\n                                   31604, 32146, 32150, 32151,\r\n                                   32152, 32156, 32157, 32158,\r\n                                   32162, 32163, 32164, 32168,\r\n                                   32169, 32170, 32174, 32175,\r\n                                   32176, 32180, 32181, 32182,\r\n                                   32186, 32187, 32199, 32134,\r\n                                   32030, 32034, 32035, 32036,\r\n                                   32040, 32041, 32042, 32046,\r\n                                   32047, 32048, 32052, 32053,\r\n                                   32054, 32058, 32059, 32060,\r\n                                   32064, 32065, 32066, 32070,\r\n                                   32071, 49788, 49792, 49793,\r\n                                   49794, 49798, 49799, 49800,\r\n                                   49804, 49805, 49806, 49810,\r\n                                   49811, 49812, 49816, 49817,\r\n                                   49818, 49822, 49823, 49824,\r\n                                   49828, 49829, 32081, 32085,\r\n                                   32086, 32087, 32091, 32092,\r\n                                   32093, 32097, 32098, 32099,\r\n                                   32103, 32104, 32105, 32109,\r\n                                   32110, 32111, 32115, 32116,\r\n                                   32117, 32121, 32122, 32141,\r\n                                   32204, 32208, 32209, 32210,\r\n                                   32214, 32215, 32216, 32220,\r\n                                   32221, 32222, 32226, 32227,\r\n                                   32228, 32232, 32233, 32234,\r\n                                   32238, 32239, 32240, 32244,\r\n                                   32245, 316, 317, 318,\r\n                                   323, 31922, 31927, 31932,\r\n                                   31937, 31942, 31947, 31948,\r\n                                   45941, 45942, 48118, 48119,\r\n                                   31763, 31764, 31774, 31775,\r\n                                   48075, 48076, 48105, 48106,\r\n                                   31769, 31770, 48048, 48049,\r\n                                   48134, 48135, 45918, 45919,\r\n                                   31758, 31759, 31784, 31785,\r\n                                   31786, 31787, 31788, 31789,\r\n                                   31790, 31791, 32906, 32910,\r\n                                   32938, 32942, 32975, 32979,\r\n                                   45612, 32988, 32989, 32990,\r\n                                   32991, 33003, 45763, 32995,\r\n                                   32996, 32997, 32998, 45766,\r\n                                   33004, 33005, 33006, 33007,\r\n                                   33012, 33013, 33014, 33011,\r\n                                   45842, 33146, 33147, 33148,\r\n                                   33149, 33150, 33151, 33152,\r\n                                   33153, 33154, 33113, 33114,\r\n                                   33115, 33116, 33117, 33118,\r\n                                   33119, 33120, 33121, 33122,\r\n                                   33123, 33124, 33125, 33126,\r\n                                   33127, 33128, 33129, 33130,\r\n                                   33131, 33160, 33161, 33162,\r\n                                   33163, 33164, 33165, 33166,\r\n                                   33167, 33235, 33236, 33237,\r\n                                   33238, 33239, 33240, 33241,\r\n                                   33242, 33243, 33244, 33245,\r\n                                   33246, 33247, 33248, 33249,\r\n                                   33172, 33173, 33174, 33175,\r\n                                   33176, 33177, 33178, 33179,\r\n                                   33180, 33181, 33182, 33183,\r\n                                   33184, 33185, 33186, 33187,\r\n                                   33188, 33189, 33190, 33191,\r\n                                   33192, 33193, 33194, 33195,\r\n                                   33216, 33217, 33218, 33219,\r\n                                   33220, 33221, 33222, 33223,\r\n                                   33224, 33225, 33226, 33227,\r\n                                   33261, 33264, 33265, 33102,\r\n                                   33105, 33106, 32702, 32703,\r\n                                   32704, 32706, 32707, 32708,\r\n                                   32709, 32710, 32711, 32712,\r\n                                   32713, 32714, 32715, 32716,\r\n                                   32717, 32720, 32721, 32722,\r\n                                   32723, 32724, 32725, 32726,\r\n                                   32727, 32728, 32729, 32732,\r\n                                   32738, 32739, 32740, 32749,\r\n                                   32750, 32751, 32752, 32753,\r\n                                   32755, 32757, 35876, 35877,\r\n                                   35878, 35879, 49980, 33374,\r\n                                   33382, 33383, 33384, 33395,\r\n                                   33396, 33397, 33398, 33399,\r\n                                   33400, 33402, 33408, 33410,\r\n                                   33409, 33411, 33415, 33420,\r\n                                   33421, 33422, 33427, 33429,\r\n                                   33430, 33431, 33436, 33439,\r\n                                   33442, 33443, 33444, 33451,\r\n                                   33452, 33453, 33460, 33461,\r\n                                   33462, 33469, 33472, 33473,\r\n                                   33474, 33475, 33476, 33478,\r\n                                   33484, 33486, 33487, 33488,\r\n                                   33489, 33493, 33495, 33496,\r\n                                   33497, 33498, 33502, 33504,\r\n                                   33505, 33506, 33507, 33511,\r\n                                   33513, 33514, 33516, 33520,\r\n                                   33523, 49984, 50094, 50095,\r\n                                   50096, 50097, 50098, 50099,\r\n                                   50100, 50101, 50102, 50103,\r\n                                   50104, 50105, 33547, 33548,\r\n                                   34949, 49989, 33794, 33795,\r\n                                   33796, 33797, 33798, 33799,\r\n                                   33985, 33995, 34002, 34009,\r\n                                   49994, 50161, 50025, 50026,\r\n                                   50027, 50028, 50029, 50031,\r\n                                   50059, 33365, 33366, 33367,\r\n                                   33368, 34398, 34402, 34403,\r\n                                   34404, 34419, 34422, 34423,\r\n                                   34424, 34425, 34426, 34427,\r\n                                   34429, 34432, 34433, 34434,\r\n                                   34440, 34442, 34443, 34446,\r\n                                   34448, 34450, 34451, 34453,\r\n                                   34456, 34499, 34509, 34510,\r\n                                   34511, 34512, 34513, 34514,\r\n                                   34516, 34517, 34518, 34519,\r\n                                   34520, 34521, 34523, 34530,\r\n                                   34531, 34532, 34533, 34534,\r\n                                   34553, 32611, 32612, 32615,\r\n                                   32616, 32617, 32618, 32619,\r\n                                   32620, 32621, 32623, 32627,\r\n                                   32629, 32631, 32633, 32634,\r\n                                   34599, 34604, 34638, 34669,\r\n                                   34693, 34728, 34766, 34768,\r\n                                   34772, 34787, 34808, 34941,\r\n                                   34972, 34979, 34987, 34999,\r\n                                   35004, 35015, 35017, 35019,\r\n                                   35021, 35026, 35029, 35034,\r\n                                   35036, 35041, 35043, 35045,\r\n                                   35052, 35057, 35059, 33369,\r\n                                   35061, 35063, 35065, 35081,\r\n                                   35089, 35093, 35095, 35114,\r\n                                   35119, 35121, 35123, 35125,\r\n                                   35127, 35129, 35131, 35136,\r\n                                   35138, 35140, 35142, 35144,\r\n                                   35155, 35181, 35186, 35191,\r\n                                   35211, 35213, 35215, 35222,\r\n                                   35224, 35232, 35234, 35236,\r\n                                   35238, 35240, 35248, 35259,\r\n                                   35268, 35279, 35281, 35283,\r\n                                   35285, 35287, 35289, 35291,\r\n                                   35296, 35298, 35300, 35302,\r\n                                   35304, 35320, 35322, 35324,\r\n                                   35326, 35328, 35330, 35332,\r\n                                   35334, 35336, 35338, 35340,\r\n                                   35342, 35344, 35346, 35348,\r\n                                   35350, 35352, 35354, 35356,\r\n                                   35358, 35360, 35362, 35364,\r\n                                   35366, 35368, 35370, 35372,\r\n                                   35373, 32006, 35376, 35378,\r\n                                   35380, 35382, 35384, 35386,\r\n                                   35391, 35393, 35395, 33987,\r\n                                   33986, 33988, 35398, 35400,\r\n                                   35402, 35404, 35406, 35408,\r\n                                   35410, 35412, 35414, 35416,\r\n                                   35418, 35420, 35422, 35424,\r\n                                   35426, 35428, 35430, 35432,\r\n                                   35434, 35436, 35438, 35440,\r\n                                   35442, 35444, 35447, 35449,\r\n                                   35451, 35453, 35455, 35457,\r\n                                   35459, 35461, 35463, 35465,\r\n                                   35466, 35468, 35470, 43835,\r\n                                   45575, 45577, 45871, 45873,\r\n                                   45875, 45877, 45879, 45884,\r\n                                   45889, 49847, 49851, 49852,\r\n                                   49853, 49857, 49858, 49859,\r\n                                   49863, 49864, 49865, 49869,\r\n                                   49870, 49871, 49875, 49876,\r\n                                   49877, 49881, 49882, 49883,\r\n                                   49887, 49888, 50021, 50033,\r\n                                   50035, 50037, 50039, 50129,\r\n                                   50131, 50133, 50169, 50179,\r\n                                   50340, 50387, 50390, 50406,\r\n                                   50450, 50452, 50454, 50471,\r\n                                   50473, 50491, 50615, 50667,\r\n                                   50672, 50674, 50679, 50704 );\r\n```\nmight even work ok for postgresql\r\n\r\n```\r\nSELECT \r\n  states_meta.metadata_id as max_metadata_id, \r\n  states.last_updated_ts as max_last_updated\r\nFROM \r\n  states_meta \r\n  JOIN states ON states.last_updated_ts = (\r\n    SELECT \r\n      last_updated_ts \r\n    FROM \r\n      states \r\n    WHERE \r\n      metadata_id = states_meta.metadata_id \r\n      and last_updated_ts < 1733899499.999999 \r\n    ORDER BY \r\n      last_updated_ts DESC \r\n    LIMIT \r\n      1\r\n  ) \r\nwhere \r\n  states_meta.metadata_id IN ( 2169, 2170, 485, 661, 672, 673, 753, 754, 755, 756, 759, 450, 463, 483, 2003, 2004, 2007, 2008, 2009, 2000, 2001, 1968, 627, 569, 570, 571, 572, 573, 574, 591, 592, 593, 634, 643, 1559, 1537, 1546, 1741, 1742, 1743, 1745, 1751, 1753, 1756, 1757, 1758, 1759, 1760, 1761, 421, 2, 7, 20, 12, 2118, 2120, 2135, 2137, 494, 502, 511, 549, 554, 561, 566, 929, 935, 1313, 1314, 1315, 608 );\r\n```\n\nHey there @home-assistant/core, mind taking a look at this pull request as it has been labeled with an integration (`recorder`) you are listed as a [code owner](https://github.com/home-assistant/core/blob/dev/CODEOWNERS#L1224) for? Thanks!\n\n<details>\n<summary>Code owner commands</summary>\n\n\nCode owners of `recorder` can trigger bot actions by commenting:\n\n- `@home-assistant close` Closes the pull request.\n- `@home-assistant rename Awesome new title` Renames the pull request.\n- `@home-assistant reopen` Reopen the pull request.\n- `@home-assistant unassign recorder` Removes the current integration label and assignees on the pull request, add the integration domain after the command.\n- `@home-assistant add-label needs-more-information` Add a label (needs-more-information, problem in dependency, problem in custom component) to the pull request.\n- `@home-assistant remove-label needs-more-information` Remove a label (needs-more-information, problem in dependency, problem in custom component) on the pull request.\n\n</details>\n\n\ncodecov failed to report. Lets try again\nStill need to write a `test_change` that does multiple\n> The change to do multiple queries looks good, but we should add tests which assert we do multiple queries as needed.\n\nI patched the chunk size to 1 and 2 to make sure the multiple queries happen. If it didn't the test would fail for this case.\n\nAre you looking to a test that patches the internals to count the calls?\n> > The change to do multiple queries looks good, but we should add tests which assert we do multiple queries as needed.\r\n> \r\n> I patched the chunk size to 1 and 2 to make sure the multiple queries happen. If it didn't the test would fail for this case.\r\n> \r\n> Are you looking to a test that patches the internals to count the calls?\r\n\r\nYeah, I think we should make sure we execute the expected number of queries according to the chunk size to ensure the chunking is happening as we expect.\r\nMaybe wrap `execute_stmt_lambda_element` in a patch, or wrap some method on the `Session` class?", "created_at": "2024-12-19T08:34:58Z"}
{"repo": "home-assistant/core", "pull_number": 133519, "instance_id": "home-assistant__core-133519", "issue_numbers": ["133497"], "base_commit": "19e6867f1ae078d84ff3e1973d703c4b86504b89", "patch": "diff --git a/homeassistant/components/vicare/manifest.json b/homeassistant/components/vicare/manifest.json\nindex 0bb5594e82972..72bc3de53d876 100644\n--- a/homeassistant/components/vicare/manifest.json\n+++ b/homeassistant/components/vicare/manifest.json\n@@ -11,5 +11,5 @@\n   \"documentation\": \"https://www.home-assistant.io/integrations/vicare\",\n   \"iot_class\": \"cloud_polling\",\n   \"loggers\": [\"PyViCare\"],\n-  \"requirements\": [\"PyViCare==2.38.0\"]\n+  \"requirements\": [\"PyViCare==2.39.0\"]\n }\ndiff --git a/requirements_all.txt b/requirements_all.txt\nindex 79f1411ea42bd..75d0a88b0092e 100644\n--- a/requirements_all.txt\n+++ b/requirements_all.txt\n@@ -100,7 +100,7 @@ PyTransportNSW==0.1.1\n PyTurboJPEG==1.7.5\n \n # homeassistant.components.vicare\n-PyViCare==2.38.0\n+PyViCare==2.39.0\n \n # homeassistant.components.xiaomi_aqara\n PyXiaomiGateway==0.14.3\n", "test_patch": "diff --git a/requirements_test_all.txt b/requirements_test_all.txt\nindex 32e815babdd08..2052aa1d56055 100644\n--- a/requirements_test_all.txt\n+++ b/requirements_test_all.txt\n@@ -94,7 +94,7 @@ PyTransportNSW==0.1.1\n PyTurboJPEG==1.7.5\n \n # homeassistant.components.vicare\n-PyViCare==2.38.0\n+PyViCare==2.39.0\n \n # homeassistant.components.xiaomi_aqara\n PyXiaomiGateway==0.14.3\n", "problem_statement": "No Data from PV\n### The problem\r\n\r\nViessmann Advanced API is buy, but only the Heatpump can be seen.\r\n\r\n### What version of Home Assistant Core has the issue?\r\n\r\ncore-2024.12.3\r\n\r\n### What was the last working version of Home Assistant Core?\r\n\r\n_No response_\r\n\r\n### What type of installation are you running?\r\n\r\nHome Assistant OS\r\n\r\n### Integration causing the issue\r\n\r\nViCare\r\n\r\n### Link to integration documentation on our website\r\n\r\nhttps://www.home-assistant.io/integrations/vicare\r\n\r\n### Diagnostics information\r\n\r\n```\r\n\r\n\"https://api.viessmann.com/iot/v1/features/installations/#######/gateways/################/devices/################/features/pcc.transfer.consumption.total\"\r\n          },\r\n          {\r\n            \"apiVersion\": 1,\r\n            \"commands\": {},\r\n            \"deviceId\": \"################\",\r\n            \"feature\": \"pcc.transfer.feedIn.total\",\r\n            \"gatewayId\": \"################\",\r\n            \"isEnabled\": true,\r\n            \"isReady\": true,\r\n            \"properties\": {\r\n              \"value\": {\r\n                \"type\": \"number\",\r\n                \"unit\": \"wattHour\",\r\n                \"value\": 29200\r\n              }\r\n            },\r\n            \"timestamp\": \"2024-12-18T10:00:32.669Z\",\r\n            \"uri\": \"https://api.viessmann.com/iot/v1/features/installations/#######/gateways/################/devices/################/features/pcc.transfer.feedIn.total\"\r\n          },\r\n          {\r\n            \"apiVersion\": 1,\r\n            \"commands\": {},\r\n            \"deviceId\": \"################\",\r\n            \"feature\": \"photovoltaic.production.cumulated\",\r\n            \"gatewayId\": \"################\",\r\n            \"isEnabled\": true,\r\n            \"isReady\": true,\r\n            \"properties\": {\r\n              \"currentDay\": {\r\n                \"type\": \"number\",\r\n                \"unit\": \"wattHour\",\r\n                \"value\": 4731\r\n              },\r\n              \"currentMonth\": {\r\n                \"type\": \"number\",\r\n                \"unit\": \"wattHour\",\r\n                \"value\": 24050\r\n              },\r\n              \"currentWeek\": {\r\n                \"type\": \"number\",\r\n                \"unit\": \"wattHour\",\r\n                \"value\": 12980\r\n              },\r\n              \"currentYear\": {\r\n                \"type\": \"number\",\r\n                \"unit\": \"wattHour\",\r\n                \"value\": 24050\r\n              },\r\n              \"lifeCycle\": {\r\n                \"type\": \"number\",\r\n                \"unit\": \"wattHour\",\r\n                \"value\": 24058\r\n              }\r\n            },\r\n            \"timestamp\": \"2024-12-18T15:08:55.860Z\",\r\n            \"uri\": \"https://api.viessmann.com/iot/v1/features/installations/#######/gateways/################/devices/################/features/photovoltaic.production.cumulated\"\r\n          },\r\n          {\r\n            \"apiVersion\": 1,\r\n            \"commands\": {},\r\n            \"deviceId\": \"################\",\r\n            \"feature\": \"photovoltaic.production.current\",\r\n            \"gatewayId\": \"################\",\r\n            \"isEnabled\": true,\r\n            \"isReady\": true,\r\n            \"properties\": {\r\n              \"value\": {\r\n                \"type\": \"number\",\r\n                \"unit\": \"kilowatt\",\r\n                \"value\": 0\r\n              }\r\n            },\r\n            \"timestamp\": \"2024-12-18T15:03:44.079Z\",\r\n            \"uri\": \"https://api.viessmann.com/iot/v1/features/installations/#######/gateways/################/devices/################/features/photovoltaic.production.current\"\r\n          },\r\n          {\r\n            \"apiVersion\": 1,\r\n            \"commands\": {},\r\n            \"deviceId\": \"################\",\r\n            \"feature\": \"photovoltaic.status\",\r\n            \"gatewayId\": \"################\",\r\n            \"isEnabled\": true,\r\n            \"isReady\": true,\r\n            \"properties\": {\r\n              \"status\": {\r\n                \"type\": \"string\",\r\n                \"value\": \"ready\"\r\n              }\r\n            },\r\n            \"timestamp\": \"2024-12-18T14:51:51.578Z\",\r\n            \"uri\": \"https://api.viessmann.com/iot/v1/features/installations/#######/gateways/################/devices/################/features/photovoltaic.status\"\r\n          },\r\n          {\r\n            \"apiVersion\": 1,\r\n            \"commands\": {},\r\n            \"deviceId\": \"################\",\r\n            \"feature\": \"device.messages.errors.raw\",\r\n            \"gatewayId\": \"################\",\r\n            \"isEnabled\": true,\r\n            \"isReady\": true,\r\n            \"properties\": {\r\n              \"entries\": {\r\n                \"type\": \"array\",\r\n                \"value\": []\r\n              }\r\n            },\r\n            \"timestamp\": \"2024-12-14T19:52:37.453Z\",\r\n            \"uri\": \"https://api.viessmann.com/iot/v1/features/installations/#######/gateways/################/devices/################/features/device.messages.errors.raw\"\r\n          },\r\n\r\n```\r\n\r\n\r\n````\r\n\r\n2024-12-18 15:54:18.369 DEBUG (SyncWorker_2) [homeassistant.components.vicare.utils] Feature not supported ess_discharge_today: 'HeatPump' object has no attribute 'getElectricalEnergySystemTransferDischargeCumulatedCurrentDay'\r\n2024-12-18 15:54:18.369 DEBUG (SyncWorker_2) [homeassistant.components.vicare.utils] Feature not supported ess_discharge_this_week: 'HeatPump' object has no attribute 'getElectricalEnergySystemTransferDischargeCumulatedCurrentWeek'\r\n2024-12-18 15:54:18.369 DEBUG (SyncWorker_2) [homeassistant.components.vicare.utils] Feature not supported ess_discharge_this_month: 'HeatPump' object has no attribute 'getElectricalEnergySystemTransferDischargeCumulatedCurrentMonth'\r\n2024-12-18 15:54:18.369 DEBUG (SyncWorker_2) [homeassistant.components.vicare.utils] Feature not supported ess_discharge_this_year: 'HeatPump' object has no attribute 'getElectricalEnergySystemTransferDischargeCumulatedCurrentYear'\r\n2024-12-18 15:54:18.369 DEBUG (SyncWorker_2) [homeassistant.components.vicare.utils] Feature not supported ess_discharge_total: 'HeatPump' object has no attribute 'getElectricalEnergySystemTransferDischargeCumulatedLifeCycle'\r\n2024-12-18 15:54:18.369 DEBUG (SyncWorker_2) [homeassistant.components.vicare.utils] Feature not supported pcc_transfer_power_exchange: 'HeatPump' object has no attribute 'getPointOfCommonCouplingTransferPowerExchange'\r\n2024-12-18 15:54:18.369 DEBUG (SyncWorker_2) [homeassistant.components.vicare.utils] Feature not supported pcc_energy_consumption: 'HeatPump' object has no attribute 'getPointOfCommonCouplingTransferConsumptionTotal'\r\n2024-12-18 15:54:18.369 DEBUG (SyncWorker_2) [homeassistant.components.vicare.utils] Feature not supported pcc_energy_feed_in: 'HeatPump' object has no attribute 'getPointOfCommonCouplingTransferFeedInTotal'\r\n2024-12-18 15:54:18.369 DEBUG (SyncWorker_2) [homeassistant.components.vicare.utils] Feature not supported photovoltaic_power_production_current: 'HeatPump' object has no attribute 'getPhotovoltaicProductionCurrent'\r\n2024-12-18 15:54:18.369 DEBUG (SyncWorker_2) [homeassistant.components.vicare.utils] Feature not supported photovoltaic_energy_production_today: 'HeatPump' object has no attribute 'getPhotovoltaicProductionCumulatedCurrentDay'\r\n2024-12-18 15:54:18.370 DEBUG (SyncWorker_2) [homeassistant.components.vicare.utils] Feature not supported photovoltaic_energy_production_this_week: 'HeatPump' object has no attribute 'getPhotovoltaicProductionCumulatedCurrentWeek'\r\n2024-12-18 15:54:18.370 DEBUG (SyncWorker_2) [homeassistant.components.vicare.utils] Feature not supported photovoltaic_energy_production_this_month: 'HeatPump' object has no attribute 'getPhotovoltaicProductionCumulatedCurrentMonth'\r\n2024-12-18 15:54:18.370 DEBUG (SyncWorker_2) [homeassistant.components.vicare.utils] Feature not supported photovoltaic_energy_production_this_year: 'HeatPump' object has no attribute 'getPhotovoltaicProductionCumulatedCurrentYear'\r\n2024-12-18 15:54:18.370 DEBUG (SyncWorker_2) [homeassistant.components.vicare.utils] Feature not supported photovoltaic_energy_production_total: 'HeatPump' object has no attribute 'getPhotovoltaicProductionCumulatedLifeCycle'\r\n\r\n\r\n````\r\n\r\n### Example YAML snippet\r\n\r\n_No response_\r\n\r\n### Anything in the logs that might be useful for us?\r\n\r\n_No response_\r\n\r\n### Additional information\r\n\r\n_No response_\n", "hints_text": "\nHey there @cfenner, mind taking a look at this issue as it has been labeled with an integration (`vicare`) you are listed as a [code owner](https://github.com/home-assistant/core/blob/dev/CODEOWNERS#L1628) for? Thanks!\n\n<details>\n<summary>Code owner commands</summary>\n\n\nCode owners of `vicare` can trigger bot actions by commenting:\n\n- `@home-assistant close` Closes the issue.\n- `@home-assistant rename Awesome new title` Renames the issue.\n- `@home-assistant reopen` Reopen the issue.\n- `@home-assistant unassign vicare` Removes the current integration label and assignees on the issue, add the integration domain after the command.\n- `@home-assistant add-label needs-more-information` Add a label (needs-more-information, problem in dependency, problem in custom component) to the issue.\n- `@home-assistant remove-label needs-more-information` Remove a label (needs-more-information, problem in dependency, problem in custom component) on the issue.\n\n</details>\n\n\n<sub><sup>(message by CodeOwnersMention)</sup></sub>\n\n---\n\n[vicare documentation](https://www.home-assistant.io/integrations/vicare)\n[vicare source](https://github.com/home-assistant/core/tree/dev/homeassistant/components/vicare)\n<sub><sup>(message by IssueLinks)</sup></sub>\nPlease use markdown codeblocks.\r\n\r\nPlease share the diagnostics file. Did you set the heating type to auto? Is the PV integrated into the heat pump via the same gateway? \nOkay.\r\n\r\nYes, all devices run through the gateway of the heat pump. \r\n\r\n[config_entry-vicare-01JF3JQ2W4Y3TYZ6MPX56MNZKH.json](https://github.com/user-attachments/files/18186372/config_entry-vicare-01JF3JQ2W4Y3TYZ6MPX56MNZKH.json)\r\n\nIn the dataset I see two `ess` devices, it that correct, is the system connected to two batteries?\nYes, it\u2019s correct, 2 Vitocharge VX3 Typ B\r\n[Info](https://www.viessmann-climatesolutions.com/de/newsroom/loesungsangebot/vitocharge-vx3-stromspeicher.html)\nOk, HA will display the *point of common coupling* (pcc) per device, but these values seem to be identical for both devices. Probably it would be more accurate to model the pcc as a common device for both batteries, but I will not look into that for now.", "created_at": "2024-12-18T19:48:16Z"}
{"repo": "home-assistant/core", "pull_number": 133502, "instance_id": "home-assistant__core-133502", "issue_numbers": ["130638"], "base_commit": "51d63ba50872331a8a8aff2f86695ba37e897aca", "patch": "diff --git a/homeassistant/components/gardena_bluetooth/manifest.json b/homeassistant/components/gardena_bluetooth/manifest.json\nindex da5c08c38c5e77..28bba1015f5d1d 100644\n--- a/homeassistant/components/gardena_bluetooth/manifest.json\n+++ b/homeassistant/components/gardena_bluetooth/manifest.json\n@@ -14,5 +14,5 @@\n   \"documentation\": \"https://www.home-assistant.io/integrations/gardena_bluetooth\",\n   \"iot_class\": \"local_polling\",\n   \"loggers\": [\"bleak\", \"bleak_esphome\", \"gardena_bluetooth\"],\n-  \"requirements\": [\"gardena-bluetooth==1.4.4\"]\n+  \"requirements\": [\"gardena-bluetooth==1.5.0\"]\n }\ndiff --git a/requirements_all.txt b/requirements_all.txt\nindex af2457b8d88bbb..0f4a3f17a27a66 100644\n--- a/requirements_all.txt\n+++ b/requirements_all.txt\n@@ -956,7 +956,7 @@ fyta_cli==0.7.0\n gTTS==2.2.4\n \n # homeassistant.components.gardena_bluetooth\n-gardena-bluetooth==1.4.4\n+gardena-bluetooth==1.5.0\n \n # homeassistant.components.google_assistant_sdk\n gassist-text==0.0.11\n", "test_patch": "diff --git a/requirements_test_all.txt b/requirements_test_all.txt\nindex f7f79ed62007c4..f5f134e16daa0e 100644\n--- a/requirements_test_all.txt\n+++ b/requirements_test_all.txt\n@@ -809,7 +809,7 @@ fyta_cli==0.7.0\n gTTS==2.2.4\n \n # homeassistant.components.gardena_bluetooth\n-gardena-bluetooth==1.4.4\n+gardena-bluetooth==1.5.0\n \n # homeassistant.components.google_assistant_sdk\n gassist-text==0.0.11\n", "problem_statement": "Gardena 6300 Pump not found with bluetooth_proxy\n### The problem\n\nI have a Gardena 6300 Water Pump which should be supported as written on the integration's page. I use an esp32 with the bluetooth_proxy to get bluetooth into homeassistant, but the pump doesn't show up and when trying to add it manually, \"No devices found on the network\" is returned.\n\n### What version of Home Assistant Core has the issue?\n\n2024.10.x, 2024.11.1\n\n### What was the last working version of Home Assistant Core?\n\n_No response_\n\n### What type of installation are you running?\n\nHome Assistant OS\n\n### Integration causing the issue\n\ngardena_bluetooth\n\n### Link to integration documentation on our website\n\nhttps://www.home-assistant.io/integrations/gardena_bluetooth\n\n### Diagnostics information\n\n_No response_\n\n### Example YAML snippet\n\n```yaml\nesp32_ble_tracker:\r\n  # also didn't worked without this\r\n  on_ble_advertise:\r\n    - mac_address:\r\n        - 34:68:B5:2C:2E:DF\r\n      then:\r\n        - lambda: |-\r\n            ESP_LOGD(\"ble_adv\", \"New BLE device\");\r\n            ESP_LOGD(\"ble_adv\", \"  address: %s\", x.address_str().c_str());\r\n            ESP_LOGD(\"ble_adv\", \"  name: %s\", x.get_name().c_str());\r\n            ESP_LOGD(\"ble_adv\", \"  Advertised service UUIDs:\");\r\n            for (auto uuid : x.get_service_uuids()) {\r\n                ESP_LOGD(\"ble_adv\", \"    - %s\", uuid.to_string().c_str());\r\n            }\r\n            ESP_LOGD(\"ble_adv\", \"  Advertised service data:\");\r\n            for (auto data : x.get_service_datas()) {\r\n                ESP_LOGD(\"ble_adv\", \"    - %s: (length %i)\", data.uuid.to_string().c_str(), data.data.size());\r\n            }\r\n            ESP_LOGD(\"ble_adv\", \"  Advertised manufacturer data:\");\r\n            for (auto data : x.get_manufacturer_datas()) {\r\n                ESP_LOGD(\"ble_adv\", \"    - %s: (length %i)\", data.uuid.to_string().c_str(), data.data.size());\r\n            }\r\n  scan_parameters:\r\n    # tried multiple different values here\r\n    #interval: 1100ms\r\n    #window: 1100ms\r\n    active: true\r\n\r\nbluetooth_proxy:\r\n  active: true\n```\n\n\n### Anything in the logs that might be useful for us?\n\n```txt\nDebug message of the esp32 logs with loglevel verbose\r\n\r\n[17:14:14][D][ble_adv:043]:   address: 34:68:B5:2C:2E:DF\r\n[17:14:14][D][ble_adv:044]:   name: GARDENA PTU\r\n[17:14:14][D][ble_adv:045]:   Advertised service UUIDs:\r\n[17:14:14][D][ble_adv:047]:     - 98BD0001-0B0E-421A-84E5-DDBF75DC6DE4\r\n[17:14:14][D][ble_adv:049]:   Advertised service data:\r\n[17:14:14][D][ble_adv:053]:   Advertised manufacturer data:\r\n[17:14:14][D][ble_adv:055]:     - 0x0426: (length 14)\r\n\r\n[17:53:50][V][bluetooth_proxy:059]: Proxying raw packet from 34:68:B5:2C:2E:DF, length 21. RSSI: -66 dB\r\n[17:53:50][V][bluetooth_proxy:061]: Proxying 2 packets\n```\n\n\n### Additional information\n\nThe mobile app on my smartphone was able to connect and control the pump. A factory reset was performed afterwards again while trying to connect into homeassistant.\n", "hints_text": "\nHey there @elupus, mind taking a look at this issue as it has been labeled with an integration (`gardena_bluetooth`) you are listed as a [code owner](https://github.com/home-assistant/core/blob/dev/CODEOWNERS#L521) for? Thanks!\n\n<details>\n<summary>Code owner commands</summary>\n\n\nCode owners of `gardena_bluetooth` can trigger bot actions by commenting:\n\n- `@home-assistant close` Closes the issue.\n- `@home-assistant rename Awesome new title` Renames the issue.\n- `@home-assistant reopen` Reopen the issue.\n- `@home-assistant unassign gardena_bluetooth` Removes the current integration label and assignees on the issue, add the integration domain after the command.\n- `@home-assistant add-label needs-more-information` Add a label (needs-more-information, problem in dependency, problem in custom component) to the issue.\n- `@home-assistant remove-label needs-more-information` Remove a label (needs-more-information, problem in dependency, problem in custom component) on the issue.\n\n</details>\n\n\n<sub><sup>(message by CodeOwnersMention)</sup></sub>\n\n---\n\n[gardena_bluetooth documentation](https://www.home-assistant.io/integrations/gardena_bluetooth)\n[gardena_bluetooth source](https://github.com/home-assistant/core/tree/dev/homeassistant/components/gardena_bluetooth)\n<sub><sup>(message by IssueLinks)</sup></sub>\n@elupus Sorry for the ping, any news?\nNot had any time really. Best would be if you could try on a standard PC with the python package here https://github.com/elupus/gardena-bluetooth\r\n\r\nIt should ve able to detect the device.\nNo problem, I only need this sometime next year\r\n\r\nI've used my laptop with the other program and heres the output, in case this could help you:\r\n\r\n```bash\r\n$ python -m gardena_bluetooth scan\r\nScanning for devices\r\nDevice: 34:68:B5:2C:2E:DF: GARDENA PTU\r\n - Service: 98bd0001-0b0e-421a-84e5-ddbf75dc6de4 Husqvarna\r\n - Data: {}\r\n - Manu: {1062: b'\\x05\\x04\\x14\\x18\\x00\\x00\\x02\\x05\\x01\\x04\\x06\\x11\\x02\\x02'}\r\n -     : ManufacturerData(pairable=True, serial=6164, group=<ProductGroup.GARDEN_PUMP: 17>, model=2, variant=2)\r\n - RSSI: -73\r\n```\r\n\r\nRunning the second command, I got a system popup asking me to connect to the bluetooth device, which I left untouched, as it vanished, as the command exited. On the Pump display it showed the error, that the bluetooth connection wasn't established, yet I got an console output:\r\n<details>\r\n<summary>Full command output</summary>\r\n\r\n```bash\r\n$ python -m gardena_bluetooth connect 34:68:B5:2C:2E:DF\r\nConnecting to: 34:68:B5:2C:2E:DF\r\nService: 98bdff00-0b0e-421a-84e5-ddbf75dc6de4 (Handle: 182): Gardena Reset\r\n -  98bdff03-0b0e-421a-84e5-ddbf75dc6de4 (Handle: 187): Unknown\r\n -  ['read', 'write']\r\n -  98bdff04-0b0e-421a-84e5-ddbf75dc6de4 (Handle: 189): Unknown\r\n -  ['read', 'write']\r\n -  98bdff01-0b0e-421a-84e5-ddbf75dc6de4 (Handle: 183): Gardena Reset Factory Reset\r\n -  ['read', 'write']\r\n -  Data: False\r\n -  98bdff02-0b0e-421a-84e5-ddbf75dc6de4 (Handle: 185): Unknown\r\n -  ['read', 'write']\r\nService: 98bd0c20-0b0e-421a-84e5-ddbf75dc6de4 (Handle: 143): Unknown\r\n -  98bd0c25-0b0e-421a-84e5-ddbf75dc6de4 (Handle: 152): Unknown\r\n -  ['read', 'write']\r\n -  98bd0c23-0b0e-421a-84e5-ddbf75dc6de4 (Handle: 148): Unknown\r\n -  ['read', 'write']\r\n -  98bd0c21-0b0e-421a-84e5-ddbf75dc6de4 (Handle: 144): Unknown\r\n -  ['read', 'write']\r\n -  98bd0c22-0b0e-421a-84e5-ddbf75dc6de4 (Handle: 146): Unknown\r\n -  ['read', 'write']\r\n -  98bd0c24-0b0e-421a-84e5-ddbf75dc6de4 (Handle: 150): Unknown\r\n -  ['read', 'write']\r\n -  98bd0c26-0b0e-421a-84e5-ddbf75dc6de4 (Handle: 154): Unknown\r\n -  ['read', 'write']\r\nService: 98bd0100-0b0e-421a-84e5-ddbf75dc6de4 (Handle: 75): Gardena Pump\r\n -  98bd016b-0b0e-421a-84e5-ddbf75dc6de4 (Handle: 128): Unknown\r\n -  ['read', 'write']\r\n -  98bd0101-0b0e-421a-84e5-ddbf75dc6de4 (Handle: 76): Gardena Pump Status\r\n -  ['read', 'notify']\r\n -  Data: 2\r\n -  98bd0168-0b0e-421a-84e5-ddbf75dc6de4 (Handle: 122): Unknown\r\n -  ['read', 'write']\r\n -  98bd016a-0b0e-421a-84e5-ddbf75dc6de4 (Handle: 126): Unknown\r\n -  ['read', 'write']\r\n -  98bd0103-0b0e-421a-84e5-ddbf75dc6de4 (Handle: 82): Gardena Pump Flow Rate\r\n -  ['read', 'notify']\r\n -  Data: 28\r\n -  98bd0104-0b0e-421a-84e5-ddbf75dc6de4 (Handle: 85): Gardena Pump Ptu Mode\r\n -  ['read', 'write']\r\n -  Data: 1\r\n -  98bd0110-0b0e-421a-84e5-ddbf75dc6de4 (Handle: 110): Gardena Pump User Motor Runtime\r\n -  ['read', 'write']\r\n -  Data: 2018\r\n -  98bd010d-0b0e-421a-84e5-ddbf75dc6de4 (Handle: 103): Gardena Pump Cool Down Timer\r\n -  ['read']\r\n -  Data: 0\r\n -  98bd0166-0b0e-421a-84e5-ddbf75dc6de4 (Handle: 118): Unknown\r\n -  ['read', 'write']\r\n -  98bd0165-0b0e-421a-84e5-ddbf75dc6de4 (Handle: 116): Unknown\r\n -  ['read']\r\n -  98bd0167-0b0e-421a-84e5-ddbf75dc6de4 (Handle: 120): Unknown\r\n -  ['read', 'write']\r\n -  98bd010c-0b0e-421a-84e5-ddbf75dc6de4 (Handle: 101): Gardena Pump Safety Pump Time\r\n -  ['read', 'write']\r\n -  Data: 5\r\n -  98bd0164-0b0e-421a-84e5-ddbf75dc6de4 (Handle: 114): Unknown\r\n -  ['read', 'write']\r\n -  98bd0107-0b0e-421a-84e5-ddbf75dc6de4 (Handle: 91): Gardena Pump Max Preassure\r\n -  ['read', 'write']\r\n -  Data: 2500\r\n -  98bd0106-0b0e-421a-84e5-ddbf75dc6de4 (Handle: 89): Gardena Pump Min Preassure\r\n -  ['read', 'write']\r\n -  Data: 1500\r\n -  98bd0108-0b0e-421a-84e5-ddbf75dc6de4 (Handle: 93): Gardena Pump Child Lock\r\n -  ['read', 'write']\r\n -  Data: False\r\n -  98bd0105-0b0e-421a-84e5-ddbf75dc6de4 (Handle: 87): Gardena Pump Leakage Detection\r\n -  ['read', 'write']\r\n -  Data: True\r\n -  98bd010a-0b0e-421a-84e5-ddbf75dc6de4 (Handle: 97): Gardena Pump Direct Start\r\n -  ['read', 'write']\r\n -  Data: False\r\n -  98bd0109-0b0e-421a-84e5-ddbf75dc6de4 (Handle: 95): Gardena Pump Filter Reminder\r\n -  ['read', 'write']\r\n -  Data: 0\r\n -  98bd0102-0b0e-421a-84e5-ddbf75dc6de4 (Handle: 79): Gardena Pump Tank Preassure\r\n -  ['read', 'notify']\r\n -  Data: 1592\r\n -  98bd010e-0b0e-421a-84e5-ddbf75dc6de4 (Handle: 105): Gardena Pump Water Temperature\r\n -  ['read']\r\n -  Data: 17\r\n -  98bd0169-0b0e-421a-84e5-ddbf75dc6de4 (Handle: 124): Unknown\r\n -  ['read', 'write']\r\n -  98bd010b-0b0e-421a-84e5-ddbf75dc6de4 (Handle: 99): Gardena Pump Max Runtime\r\n -  ['read', 'write']\r\n -  Data: 0\r\n -  98bd010f-0b0e-421a-84e5-ddbf75dc6de4 (Handle: 107): Gardena Pump Error Code\r\n -  ['read', 'write', 'notify']\r\n -  Data: bytearray(b'\\x00\\x00')\r\n -  98bd0111-0b0e-421a-84e5-ddbf75dc6de4 (Handle: 112): Gardena Pump Total Motor Runtime\r\n -  ['read']\r\n -  Data: 2037\r\nService: 98bd0d10-0b0e-421a-84e5-ddbf75dc6de4 (Handle: 65): Gardena WateringHistory\r\n -  98bd0d13-0b0e-421a-84e5-ddbf75dc6de4 (Handle: 71): Gardena WateringHistory Skip Reason\r\n -  ['read']\r\n -  Data: bytearray(b'@@@@\\x00\\x00\\x00')\r\n -  98bd0d14-0b0e-421a-84e5-ddbf75dc6de4 (Handle: 73): Gardena WateringHistory Watering Duration\r\n -  ['read']\r\n -  Data: [655555, 84, 61, 125, 14, 21, 14]\r\n -  98bd0d12-0b0e-421a-84e5-ddbf75dc6de4 (Handle: 68): Gardena WateringHistory Timestamp Count\r\n -  ['read', 'notify']\r\n -  Data: 7\r\n -  98bd0d11-0b0e-421a-84e5-ddbf75dc6de4 (Handle: 66): Gardena WateringHistory Timestamp Array\r\n -  ['read']\r\n -  Data: [datetime.datetime(2024, 11, 22, 8, 0, 1), datetime.datetime(2024, 11, 22, 9, 1, 25), datetime.datetime(2024, 11, 22, 10, 2, 26), datetime.datetime(2024, 11, 22, 15, 4, 31), datetime.datetime(2024, 11, 22, 15, 36, 22), datetime.datetime(2024, 11, 22, 15, 38, 32), datetime.datetime(2024, 11, 22, 15, 44, 33)]\r\nService: 98bd0b10-0b0e-421a-84e5-ddbf75dc6de4 (Handle: 42): Gardena DeviceConfiguration\r\n -  98bd0b12-0b0e-421a-84e5-ddbf75dc6de4 (Handle: 45): Gardena DeviceConfiguration Seasonal Adjust\r\n -  ['read', 'write']\r\n -  Data: 100\r\n -  98bd0b18-0b0e-421a-84e5-ddbf75dc6de4 (Handle: 57): Gardena DeviceConfiguration Custom Device Name\r\n -  ['read', 'write']\r\n -  Data: \r\n -  98bd0b17-0b0e-421a-84e5-ddbf75dc6de4 (Handle: 55): Gardena DeviceConfiguration First User Start\r\n -  ['read', 'write']\r\n -  Data: False\r\n -  98bd0b13-0b0e-421a-84e5-ddbf75dc6de4 (Handle: 47): Gardena DeviceConfiguration Unix Timestamp\r\n -  ['read', 'write']\r\n -  Data: 2024-12-02 17:03:24\r\n -  98bd0b15-0b0e-421a-84e5-ddbf75dc6de4 (Handle: 51): Gardena DeviceConfiguration Device Language\r\n -  ['read', 'write']\r\n -  Data: 0\r\n -  98bd0b11-0b0e-421a-84e5-ddbf75dc6de4 (Handle: 43): Gardena DeviceConfiguration Rain Pause\r\n -  ['read', 'write']\r\n -  Data: 0\r\n -  98bd0b16-0b0e-421a-84e5-ddbf75dc6de4 (Handle: 53): Gardena DeviceConfiguration Display Brightness\r\n -  ['read', 'write']\r\n -  Data: 100\r\n -  98bd0b14-0b0e-421a-84e5-ddbf75dc6de4 (Handle: 49): Gardena DeviceConfiguration Mobile Device Name\r\n -  ['read', 'write']\r\n -  Data: 0\r\nService: f000ffc0-0451-4000-b000-000000000000 (Handle: 191): Gardena Fota\r\n -  f000ffc2-0451-4000-b000-000000000000 (Handle: 196): Gardena Fota Image Block Id\r\n -  ['write-without-response', 'write', 'notify']\r\n -  f000ffc5-0451-4000-b000-000000000000 (Handle: 200): Gardena Fota Control Point\r\n -  ['write-without-response', 'notify']\r\n -  f000ffc1-0451-4000-b000-000000000000 (Handle: 192): Gardena Fota Image Identify\r\n -  ['write-without-response', 'write', 'notify']\r\nService: 98bd0c10-0b0e-421a-84e5-ddbf75dc6de4 (Handle: 130): Unknown\r\n -  98bd0c12-0b0e-421a-84e5-ddbf75dc6de4 (Handle: 133): Unknown\r\n -  ['read', 'write']\r\n -  98bd0c11-0b0e-421a-84e5-ddbf75dc6de4 (Handle: 131): Unknown\r\n -  ['read', 'write']\r\n -  98bd0c14-0b0e-421a-84e5-ddbf75dc6de4 (Handle: 137): Unknown\r\n -  ['read', 'write']\r\n -  98bd0c15-0b0e-421a-84e5-ddbf75dc6de4 (Handle: 139): Unknown\r\n -  ['read', 'write']\r\n -  98bd0c13-0b0e-421a-84e5-ddbf75dc6de4 (Handle: 135): Unknown\r\n -  ['read', 'write']\r\n -  98bd0c16-0b0e-421a-84e5-ddbf75dc6de4 (Handle: 141): Unknown\r\n -  ['read', 'write']\r\nService: 98bd0f10-0b0e-421a-84e5-ddbf75dc6de4 (Handle: 169): Gardena Valve\r\n -  98bd0f14-0b0e-421a-84e5-ddbf75dc6de4 (Handle: 178): Gardena Valve Manual Watering Time\r\n -  ['read', 'write']\r\n -  Data: 1800\r\n -  98bd0f12-0b0e-421a-84e5-ddbf75dc6de4 (Handle: 173): Gardena Valve Connected State\r\n -  ['read', 'notify']\r\n -  Data: True\r\n -  98bd0f13-0b0e-421a-84e5-ddbf75dc6de4 (Handle: 176): Gardena Valve Remaining Open Time\r\n -  ['read', 'write']\r\n -  Data: -1\r\n -  98bd0f11-0b0e-421a-84e5-ddbf75dc6de4 (Handle: 170): Gardena Valve State\r\n -  ['read', 'notify']\r\n -  Data: False\r\n -  98bd0f15-0b0e-421a-84e5-ddbf75dc6de4 (Handle: 180): Gardena Valve Activation Reason\r\n -  ['read']\r\n -  Data: 0\r\nService: 98bd0010-0b0e-421a-84e5-ddbf75dc6de4 (Handle: 23): Gardena Sensor\r\n -  98bd0012-0b0e-421a-84e5-ddbf75dc6de4 (Handle: 27): Gardena Sensor Connected State\r\n -  ['read', 'notify']\r\n -  Data: False\r\n -  98bd0015-0b0e-421a-84e5-ddbf75dc6de4 (Handle: 34): Gardena Sensor Battery Level\r\n -  ['read']\r\n -  Data: 0\r\n -  98bd0011-0b0e-421a-84e5-ddbf75dc6de4 (Handle: 24): Gardena Sensor Value\r\n -  ['read', 'notify']\r\n -  Data: 0\r\n -  98bd0013-0b0e-421a-84e5-ddbf75dc6de4 (Handle: 30): Gardena Sensor Type\r\n -  ['read']\r\n -  Data: \r\n -  98bd0014-0b0e-421a-84e5-ddbf75dc6de4 (Handle: 32): Gardena Sensor Threshold\r\n -  ['read', 'write']\r\n -  Data: 80\r\n -  98bd0017-0b0e-421a-84e5-ddbf75dc6de4 (Handle: 39): Gardena Sensor Force Measurement\r\n -  ['read', 'write', 'notify']\r\n -  Data: 0\r\n -  98bd0016-0b0e-421a-84e5-ddbf75dc6de4 (Handle: 36): Gardena Sensor Measurement Timestamp\r\n -  ['read', 'notify']\r\n -  Data: 1970-01-01 01:00:00\r\nService: 98bd0c30-0b0e-421a-84e5-ddbf75dc6de4 (Handle: 156): Unknown\r\n -  98bd0c34-0b0e-421a-84e5-ddbf75dc6de4 (Handle: 163): Unknown\r\n -  ['read', 'write']\r\n -  98bd0c31-0b0e-421a-84e5-ddbf75dc6de4 (Handle: 157): Unknown\r\n -  ['read', 'write']\r\n -  98bd0c33-0b0e-421a-84e5-ddbf75dc6de4 (Handle: 161): Unknown\r\n -  ['read', 'write']\r\n -  98bd0c35-0b0e-421a-84e5-ddbf75dc6de4 (Handle: 165): Unknown\r\n -  ['read', 'write']\r\n -  98bd0c32-0b0e-421a-84e5-ddbf75dc6de4 (Handle: 159): Unknown\r\n -  ['read', 'write']\r\n -  98bd0c36-0b0e-421a-84e5-ddbf75dc6de4 (Handle: 167): Unknown\r\n -  ['read', 'write']\r\nService: 00001801-0000-1000-8000-00805f9b34fb (Handle: 12): Generic Attribute Profile\r\n -  00002a05-0000-1000-8000-00805f9b34fb (Handle: 13): Service Changed\r\n -  ['indicate']\r\nService: 0000180a-0000-1000-8000-00805f9b34fb (Handle: 16): Gardena DeviceInformation\r\n -  00002a26-0000-1000-8000-00805f9b34fb (Handle: 21): Gardena DeviceInformation Firmware Version\r\n -  ['read']\r\n -  Data: 1.0.0.0 PTU\r\n -  00002a29-0000-1000-8000-00805f9b34fb (Handle: 19): Gardena DeviceInformation Manufacturer Name\r\n -  ['read']\r\n -  Data: Husqvarna AB\r\n -  00002a24-0000-1000-8000-00805f9b34fb (Handle: 17): Gardena DeviceInformation Model Number\r\n -  ['read']\r\n -  Data: 09068\r\nService: 98bdeeee-0b0e-421a-84e5-ddbf75dc6de4 (Handle: 59): Gardena ErrorHistory\r\n -  98bdeeef-0b0e-421a-84e5-ddbf75dc6de4 (Handle: 60): Gardena ErrorHistory Error Id\r\n -  ['read']\r\n -  Data: bytearray(b'\\x01eeeeee\\x04')\r\n -  98bdeef0-0b0e-421a-84e5-ddbf75dc6de4 (Handle: 62): Gardena ErrorHistory Error Count\r\n -  ['read', 'notify']\r\n -  Data: 8\r\n```\r\n\r\n</details> ", "created_at": "2024-12-18T17:32:29Z"}
{"repo": "home-assistant/core", "pull_number": 133499, "instance_id": "home-assistant__core-133499", "issue_numbers": ["127245"], "base_commit": "a1558213c49871a955a3dec440cc1984b143615e", "patch": "diff --git a/homeassistant/components/fjaraskupan/light.py b/homeassistant/components/fjaraskupan/light.py\nindex b33904c805d3d..f0083591d4dd0 100644\n--- a/homeassistant/components/fjaraskupan/light.py\n+++ b/homeassistant/components/fjaraskupan/light.py\n@@ -4,8 +4,6 @@\n \n from typing import Any\n \n-from fjaraskupan import COMMAND_LIGHT_ON_OFF\n-\n from homeassistant.components.light import ATTR_BRIGHTNESS, ColorMode, LightEntity\n from homeassistant.config_entries import ConfigEntry\n from homeassistant.core import HomeAssistant\n@@ -62,7 +60,6 @@ async def async_turn_off(self, **kwargs: Any) -> None:\n         if self.is_on:\n             async with self.coordinator.async_connect_and_update() as device:\n                 await device.send_dim(0)\n-                await device.send_command(COMMAND_LIGHT_ON_OFF)\n \n     @property\n     def is_on(self) -> bool:\ndiff --git a/homeassistant/components/fjaraskupan/manifest.json b/homeassistant/components/fjaraskupan/manifest.json\nindex cc368b3e92f60..2fd49aac5eef1 100644\n--- a/homeassistant/components/fjaraskupan/manifest.json\n+++ b/homeassistant/components/fjaraskupan/manifest.json\n@@ -14,5 +14,5 @@\n   \"documentation\": \"https://www.home-assistant.io/integrations/fjaraskupan\",\n   \"iot_class\": \"local_polling\",\n   \"loggers\": [\"bleak\", \"fjaraskupan\"],\n-  \"requirements\": [\"fjaraskupan==2.3.1\"]\n+  \"requirements\": [\"fjaraskupan==2.3.2\"]\n }\ndiff --git a/requirements_all.txt b/requirements_all.txt\nindex 47929f65916ff..af2457b8d88bb 100644\n--- a/requirements_all.txt\n+++ b/requirements_all.txt\n@@ -915,7 +915,7 @@ fivem-api==0.1.2\n fixerio==1.0.0a0\n \n # homeassistant.components.fjaraskupan\n-fjaraskupan==2.3.1\n+fjaraskupan==2.3.2\n \n # homeassistant.components.flexit_bacnet\n flexit_bacnet==2.2.1\n", "test_patch": "diff --git a/requirements_test_all.txt b/requirements_test_all.txt\nindex 3b55231f89805..f7f79ed62007c 100644\n--- a/requirements_test_all.txt\n+++ b/requirements_test_all.txt\n@@ -774,7 +774,7 @@ fitbit==0.3.1\n fivem-api==0.1.2\n \n # homeassistant.components.fjaraskupan\n-fjaraskupan==2.3.1\n+fjaraskupan==2.3.2\n \n # homeassistant.components.flexit_bacnet\n flexit_bacnet==2.2.1\n", "problem_statement": "Light turn off command immediately toggles to on automatically\n### The problem\r\n\r\nHi!\r\n\r\nFirst off, I want to thank @elupus for contributing with developing this great integration.\r\nThe issue I am experiencing is the behaviour of the light control. Whenever I hit turn fan light off in Home Assistant, the light is turned off for a split second and then turned on at 100% brightness directly after, the light sort of automatically toggles back to 100% on. \r\nAlso, when sending a brightness percentage command, such as 10%, the light goes on at 100% brightness. Can you please help me out in finding out what might be wrong?\r\nThe fan (Fj\u00e4r\u00e5skupan Athena 120) is connecting to Home Assistant over Bluetooth proxy (ESP32/Esphome).\r\n\r\n### What version of Home Assistant Core has the issue?\r\n\r\ncore-2024.9.3\r\n\r\n### What was the last working version of Home Assistant Core?\r\n\r\n_No response_\r\n\r\n### What type of installation are you running?\r\n\r\nHome Assistant OS\r\n\r\n### Integration causing the issue\r\n\r\nFj\u00e4r\u00e5skupan\r\n\r\n### Link to integration documentation on our website\r\n\r\nhttps://www.home-assistant.io/integrations/fjaraskupan\r\n\r\n### Diagnostics information\r\n\r\n_No response_\r\n\r\n### Example YAML snippet\r\n\r\n_No response_\r\n\r\n### Anything in the logs that might be useful for us?\r\n\r\n_No response_\r\n\r\n### Additional information\r\n\r\n_No response_\n", "hints_text": "\nHey there @elupus, mind taking a look at this issue as it has been labeled with an integration (`fjaraskupan`) you are listed as a [code owner](https://github.com/home-assistant/core/blob/dev/CODEOWNERS#L474) for? Thanks!\n\n<details>\n<summary>Code owner commands</summary>\n\n\nCode owners of `fjaraskupan` can trigger bot actions by commenting:\n\n- `@home-assistant close` Closes the issue.\n- `@home-assistant rename Awesome new title` Renames the issue.\n- `@home-assistant reopen` Reopen the issue.\n- `@home-assistant unassign fjaraskupan` Removes the current integration label and assignees on the issue, add the integration domain after the command.\n- `@home-assistant add-label needs-more-information` Add a label (needs-more-information, problem in dependency, problem in custom component) to the issue.\n- `@home-assistant remove-label needs-more-information` Remove a label (needs-more-information, problem in dependency, problem in custom component) on the issue.\n\n</details>\n\n\n<sub><sup>(message by CodeOwnersMention)</sup></sub>\n\n---\n\n[fjaraskupan documentation](https://www.home-assistant.io/integrations/fjaraskupan)\n[fjaraskupan source](https://github.com/home-assistant/core/tree/dev/homeassistant/components/fjaraskupan)\n<sub><sup>(message by IssueLinks)</sup></sub>\nThere is a hack in place to sidestep the built in dimming. It will momentarily set it to fill brightness on turn on: https://github.com/elupus/fjaraskupan/blob/e253bae976b32e8faec106248dd8d7b67e1777e8/src/fjaraskupan/__init__.py#L335\r\n\r\nBut that does not seem to be your issue. My guess is your fan behaves different on turn of. We normally dim to 0 and turn of.\r\n\r\nhttps://github.com/home-assistant/core/blob/c175a68a26df7ae1720e1887914c4355129577f8/homeassistant/components/fjaraskupan/light.py#L65\n@Maaang does your Fj\u00e4r\u00e5skupan fan have a rotary wheel control-panel, or a button control-panel?\nI have the same issue.\r\nIt was working fine until about a year ago. The only way I can turn it off is by setting the brightness to 1% in home assistant. If I turn it off completely, by dragging brightness to 0% er pressing on/off it turns off but then immediately turns itself on with 100% brightness. I have a fan from 2021 with the new control panel with buttons and blue led bar. Connected through ESPHome Bluetooth Proxy.", "created_at": "2024-12-18T16:25:43Z"}
{"repo": "home-assistant/core", "pull_number": 133492, "instance_id": "home-assistant__core-133492", "issue_numbers": ["133486"], "base_commit": "d6c201de4aa1825d02369535305f6620aa63eed8", "patch": "diff --git a/homeassistant/components/roborock/manifest.json b/homeassistant/components/roborock/manifest.json\nindex c305e4710fcead..69d867aa164c94 100644\n--- a/homeassistant/components/roborock/manifest.json\n+++ b/homeassistant/components/roborock/manifest.json\n@@ -7,7 +7,7 @@\n   \"iot_class\": \"local_polling\",\n   \"loggers\": [\"roborock\"],\n   \"requirements\": [\n-    \"python-roborock==2.7.2\",\n+    \"python-roborock==2.8.1\",\n     \"vacuum-map-parser-roborock==0.1.2\"\n   ]\n }\ndiff --git a/requirements_all.txt b/requirements_all.txt\nindex a6316379d8f38f..6336205eed392f 100644\n--- a/requirements_all.txt\n+++ b/requirements_all.txt\n@@ -2415,7 +2415,7 @@ python-rabbitair==0.0.8\n python-ripple-api==0.0.3\n \n # homeassistant.components.roborock\n-python-roborock==2.7.2\n+python-roborock==2.8.1\n \n # homeassistant.components.smarttub\n python-smarttub==0.0.38\n", "test_patch": "diff --git a/requirements_test_all.txt b/requirements_test_all.txt\nindex 33e7327568e6d1..e8e131a5bd592f 100644\n--- a/requirements_test_all.txt\n+++ b/requirements_test_all.txt\n@@ -1942,7 +1942,7 @@ python-picnic-api==1.1.0\n python-rabbitair==0.0.8\n \n # homeassistant.components.roborock\n-python-roborock==2.7.2\n+python-roborock==2.8.1\n \n # homeassistant.components.smarttub\n python-smarttub==0.0.38\n", "problem_statement": "Integration will not load\n### The problem\n\nI have suddenly started seeing my integration fail to load with this error in the logs:\r\n`AttributeError: 'dict' object has no attribute 'duid'`\r\n\r\nIf I turned debug on, I do see `devices=[{'duid': `followed by an alphanumeric value in quotes.  So, I think the `duid` attribute is in fact there but something else is causing the failure.\n\n### What version of Home Assistant Core has the issue?\n\ncore-2024.12.4\n\n### What was the last working version of Home Assistant Core?\n\ncore-2024.12.4\n\n### What type of installation are you running?\n\nHome Assistant OS\n\n### Integration causing the issue\n\nRoborock\n\n### Link to integration documentation on our website\n\nhttps://www.home-assistant.io/integrations/roborock/\n\n### Diagnostics information\n\n_No response_\n\n### Example YAML snippet\n\n_No response_\n\n### Anything in the logs that might be useful for us?\n\n_No response_\n\n### Additional information\n\n_No response_\n", "hints_text": "\nHey there @lash-l, mind taking a look at this issue as it has been labeled with an integration (`roborock`) you are listed as a [code owner](https://github.com/home-assistant/core/blob/dev/CODEOWNERS#L1259) for? Thanks!\n\n<details>\n<summary>Code owner commands</summary>\n\n\nCode owners of `roborock` can trigger bot actions by commenting:\n\n- `@home-assistant close` Closes the issue.\n- `@home-assistant rename Awesome new title` Renames the issue.\n- `@home-assistant reopen` Reopen the issue.\n- `@home-assistant unassign roborock` Removes the current integration label and assignees on the issue, add the integration domain after the command.\n- `@home-assistant add-label needs-more-information` Add a label (needs-more-information, problem in dependency, problem in custom component) to the issue.\n- `@home-assistant remove-label needs-more-information` Remove a label (needs-more-information, problem in dependency, problem in custom component) on the issue.\n\n</details>\n\n\n<sub><sup>(message by CodeOwnersMention)</sup></sub>\n\n---\n\n[roborock documentation](https://www.home-assistant.io/integrations/roborock)\n[roborock source](https://github.com/home-assistant/core/tree/dev/homeassistant/components/roborock)\n<sub><sup>(message by IssueLinks)</sup></sub>\nSeeing same error occur this AM. Same version of HA. \r\n\r\nIntegration _was_ working, when I restarted HA this morning to apply other updates, issue started here and errors below.  \r\n             \r\n\r\n```\r\n^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/src/homeassistant/homeassistant/components/roborock/__init__.py\", line 72, in async_setup_entry\r\n    device.duid: device for device in all_devices\r\n    ^^^^^^^^^^^\r\nAttributeError: 'dict' object has no attribute 'duid'\r\n```\r\n\r\n```\r\nLogger: homeassistant.config_entries\r\nSource: config_entries.py:640\r\nFirst occurred: 7:47:22 AM (6 occurrences)\r\nLast logged: 8:09:38 AM\r\n\r\nError setting up entry xxxxxxx@yyyyy.com for roborock\r\nTraceback (most recent call last):\r\n  File \"/usr/src/homeassistant/homeassistant/config_entries.py\", line 640, in __async_setup_with_context\r\n    result = await component.async_setup_entry(hass, self)\r\n             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/src/homeassistant/homeassistant/components/roborock/__init__.py\", line 72, in async_setup_entry\r\n    device.duid: device for device in all_devices\r\n    ^^^^^^^^^^^\r\nAttributeError: 'dict' object has no attribute 'duid'\r\n```\r\n\r\n```\r\nLogger: roborock.containers\r\nSource: /usr/local/lib/python3.13/site-packages/roborock/containers.py:128\r\nFirst occurred: 7:47:22 AM (6 occurrences)\r\nLast logged: 8:09:38 AM\r\n\r\nHomeDataDevice.__init__() got an unexpected keyword argument 'cid'\r\nTraceback (most recent call last):\r\n  File \"/usr/local/lib/python3.13/site-packages/roborock/containers.py\", line 112, in convert_to_class_obj\r\n    return_list.append(cls_type.from_dict(obj))\r\n                       ~~~~~~~~~~~~~~~~~~^^^^^\r\n  File \"/usr/local/lib/python3.13/site-packages/roborock/containers.py\", line 166, in from_dict\r\n    return cls(**data)\r\nTypeError: HomeDataDevice.__init__() got an unexpected keyword argument 'cid'\r\n```\r\n\r\n\nCan you please share the full relevant section of the logs\nActually just reloaded my logs and I see to have this issue too. Something must have changed in the api. I'll try to get this fixed today\nOne more:\r\n\r\nTraceback (most recent call last):\r\n  File \"/usr/src/homeassistant/homeassistant/config_entries.py\", line 640, in __async_setup_with_context\r\n    result = await component.async_setup_entry(hass, self)\r\n             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/src/homeassistant/homeassistant/components/roborock/__init__.py\", line 72, in async_setup_entry\r\n    device.duid: device for device in all_devices\r\n    ^^^^^^^^^^^\r\nAttributeError: 'dict' object has no attribute 'duid'\nThey added a new field to the device object on their api named cid, just solved the issue on my home assistant docker modifying file: /usr/local/lib/python3.13/site-packages/roborock/containers.py\r\n\r\nHad to add a new field to  class HomeDataDevice(RoborockBase)\r\n\r\n`    cid: Any | None = None`\r\n\r\nIntegration started working again after that,\nYep! I changed the ordering of some logic in my dictionary to custom objects logic that will ensure in the future any new keys shouldn't break anything.\r\n\r\nI should have a PR out shortly for Home assistant and it should be released with the next update.\r\n\r\nI would recommend not updating your files yourself if you don't know what you're doing. @sbiglia's solution will work, but I have seen some people make mistakes so it is better to wait for a official HA update if you are able to!", "created_at": "2024-12-18T14:43:43Z"}
{"repo": "home-assistant/core", "pull_number": 133476, "instance_id": "home-assistant__core-133476", "issue_numbers": ["125224", "125224"], "base_commit": "7730f423b38c621c2d2c1665328b0a9907fa9504", "patch": "diff --git a/homeassistant/components/overkiz/button.py b/homeassistant/components/overkiz/button.py\nindex 5a1116aeeb540e..a3332a566ecf58 100644\n--- a/homeassistant/components/overkiz/button.py\n+++ b/homeassistant/components/overkiz/button.py\n@@ -4,7 +4,7 @@\n \n from dataclasses import dataclass\n \n-from pyoverkiz.enums import OverkizCommand\n+from pyoverkiz.enums import OverkizCommand, OverkizCommandParam\n from pyoverkiz.types import StateType as OverkizStateType\n \n from homeassistant.components.button import ButtonEntity, ButtonEntityDescription\n@@ -72,6 +72,14 @@ class OverkizButtonDescription(ButtonEntityDescription):\n         name=\"Toggle\",\n         icon=\"mdi:sync\",\n     ),\n+    # SmokeSensor\n+    OverkizButtonDescription(\n+        key=OverkizCommand.CHECK_EVENT_TRIGGER,\n+        press_args=OverkizCommandParam.SHORT,\n+        name=\"Test\",\n+        icon=\"mdi:smoke-detector\",\n+        entity_category=EntityCategory.DIAGNOSTIC,\n+    ),\n ]\n \n SUPPORTED_COMMANDS = {\n", "test_patch": "", "problem_statement": "Missing test button for Smoke Sensor in Overkiz integration\n### The problem\n\nI have a Somfy Smoke alarm (https://shop.somfy.co.uk/smoke-alarm-io/). In my Tahoma app, I can test the sensor alarm. Unfortunetly, in the Overkiz integration, I haven't (see screenshot).\r\n\r\n<img width=\"1333\" alt=\"overkiz-screenshot\" src=\"https://github.com/user-attachments/assets/e5e2d455-603f-4ee9-a40b-fe231a979f93\">\r\n\r\n![tahoma-screenshot1](https://github.com/user-attachments/assets/b86104fd-5252-47ee-a6e6-1e4734795316)\r\n\r\n\n\n### What version of Home Assistant Core has the issue?\n\ncore-2024.8.3\n\n### What was the last working version of Home Assistant Core?\n\n_No response_\n\n### What type of installation are you running?\n\nHome Assistant OS\n\n### Integration causing the issue\n\nintegration Overkiz\n\n### Link to integration documentation on our website\n\n_No response_\n\n### Diagnostics information\n\n_No response_\n\n### Example YAML snippet\n\n_No response_\n\n### Anything in the logs that might be useful for us?\n\n_No response_\n\n### Additional information\n\n_No response_\nMissing test button for Smoke Sensor in Overkiz integration\n### The problem\n\nI have a Somfy Smoke alarm (https://shop.somfy.co.uk/smoke-alarm-io/). In my Tahoma app, I can test the sensor alarm. Unfortunetly, in the Overkiz integration, I haven't (see screenshot).\r\n\r\n<img width=\"1333\" alt=\"overkiz-screenshot\" src=\"https://github.com/user-attachments/assets/e5e2d455-603f-4ee9-a40b-fe231a979f93\">\r\n\r\n![tahoma-screenshot1](https://github.com/user-attachments/assets/b86104fd-5252-47ee-a6e6-1e4734795316)\r\n\r\n\n\n### What version of Home Assistant Core has the issue?\n\ncore-2024.8.3\n\n### What was the last working version of Home Assistant Core?\n\n_No response_\n\n### What type of installation are you running?\n\nHome Assistant OS\n\n### Integration causing the issue\n\nintegration Overkiz\n\n### Link to integration documentation on our website\n\n_No response_\n\n### Diagnostics information\n\n_No response_\n\n### Example YAML snippet\n\n_No response_\n\n### Anything in the logs that might be useful for us?\n\n_No response_\n\n### Additional information\n\n_No response_\n", "hints_text": "\nHey there @imicknl, @vlebourl, @tetienne, @nyrodev, @tronix117, @alexfp14, mind taking a look at this issue as it has been labeled with an integration (`overkiz`) you are listed as a [code owner](https://github.com/home-assistant/core/blob/dev/CODEOWNERS#L1074) for? Thanks!\n\n<details>\n<summary>Code owner commands</summary>\n\n\nCode owners of `overkiz` can trigger bot actions by commenting:\n\n- `@home-assistant close` Closes the issue.\n- `@home-assistant rename Awesome new title` Renames the issue.\n- `@home-assistant reopen` Reopen the issue.\n- `@home-assistant unassign overkiz` Removes the current integration label and assignees on the issue, add the integration domain after the command.\n- `@home-assistant add-label needs-more-information` Add a label (needs-more-information, problem in dependency, problem in custom component) to the issue.\n- `@home-assistant remove-label needs-more-information` Remove a label (needs-more-information, problem in dependency, problem in custom component) on the issue.\n\n</details>\n\n\n<sub><sup>(message by CodeOwnersMention)</sup></sub>\n\n---\n\n[overkiz documentation](https://www.home-assistant.io/integrations/overkiz)\n[overkiz source](https://github.com/home-assistant/core/tree/dev/homeassistant/components/overkiz)\n<sub><sup>(message by IssueLinks)</sup></sub>\nCan you run the test from the app, wait a few minutes and generate your diagnostics? Please add your diagnostics to this issue by dragging the JSON in a new comment.\nIm' sorry but howI can I generate the diagnostics ? \r\nWhat I see after little more investigation is that the 'test button' in the Tahoma app is what you call in HA 'identity' for other Somfy product.\nSee https://www.home-assistant.io/integrations/diagnostics/\nI don't have this option for Overkiz integration. I have it for others integration (ex. Daikin).\r\nPlease have a look on my screenshot.\r\n\r\n<img width=\"1356\" alt=\"overkiz-screenshot1\" src=\"https://github.com/user-attachments/assets/47714467-4d19-428e-811f-78d180f691b6\">\r\n\r\n<img width=\"1920\" alt=\"overkiz-screenshot2\" src=\"https://github.com/user-attachments/assets/71d7d277-da83-438c-9eee-66e1eb5c6c7b\">\r\n\r\n\nCan you click on the 3 dots next to \"Visiter\". This will show the full menu.\nThank you :-) !\r\n[overkiz-c3870f84f152a0449c3a9448c042aa20-Capteur de fum\u00e9e \u00c9tage-015a934295c501564fa0aa50a13a8cba.json](https://github.com/user-attachments/files/16906958/overkiz-c3870f84f152a0449c3a9448c042aa20-Capteur.de.fumee.Etage-015a934295c501564fa0aa50a13a8cba.json)\r\n\n`\r\n\"HistoryExecution(id='c66d4820-0a19-0481-522a-5d22d0cf3076', event_time=1725610936356, owner=s****@****e.fr, source='mobile:tahoma:android', end_time=1725610937597, effective_start_time=1725610936356, duration=1241, label='identify', type='Immediate execution - MANUAL_CONTROL', state=<ExecutionState.COMPLETED: 'COMPLETED'>, failure_type='NO_FAILURE', commands=[HistoryExecutionCommand(device_url=io://****-****-8983/2820363, command='checkEventTrigger', rank=0, dynamic=False, state=<ExecutionState.COMPLETED: 'COMPLETED'>, failure_type='NO_FAILURE', parameters=['short'])], execution_type=<ExecutionType.IMMEDIATE_EXECUTION: 'Immediate execution'>, execution_sub_type=<ExecutionSubType.MANUAL_CONTROL: 'MANUAL_CONTROL'>)\",\r\n`\r\n\r\nIt seems that the command to test your system is `checkEventTrigger` with parameter `short`.\nThere hasn't been any activity on this issue recently. Due to the high number of incoming GitHub notifications, we have to clean some of the old issues, as many of them have already been resolved with the latest updates.\nPlease make sure to update to the latest Home Assistant version and check if that solves the issue. Let us know if that works for you by adding a comment \ud83d\udc4d\nThis issue has now been marked as stale and will be closed if no further activity occurs. Thank you for your contributions.\n\nHey there @imicknl, @vlebourl, @tetienne, @nyrodev, @tronix117, @alexfp14, mind taking a look at this issue as it has been labeled with an integration (`overkiz`) you are listed as a [code owner](https://github.com/home-assistant/core/blob/dev/CODEOWNERS#L1074) for? Thanks!\n\n<details>\n<summary>Code owner commands</summary>\n\n\nCode owners of `overkiz` can trigger bot actions by commenting:\n\n- `@home-assistant close` Closes the issue.\n- `@home-assistant rename Awesome new title` Renames the issue.\n- `@home-assistant reopen` Reopen the issue.\n- `@home-assistant unassign overkiz` Removes the current integration label and assignees on the issue, add the integration domain after the command.\n- `@home-assistant add-label needs-more-information` Add a label (needs-more-information, problem in dependency, problem in custom component) to the issue.\n- `@home-assistant remove-label needs-more-information` Remove a label (needs-more-information, problem in dependency, problem in custom component) on the issue.\n\n</details>\n\n\n<sub><sup>(message by CodeOwnersMention)</sup></sub>\n\n---\n\n[overkiz documentation](https://www.home-assistant.io/integrations/overkiz)\n[overkiz source](https://github.com/home-assistant/core/tree/dev/homeassistant/components/overkiz)\n<sub><sup>(message by IssueLinks)</sup></sub>\nCan you run the test from the app, wait a few minutes and generate your diagnostics? Please add your diagnostics to this issue by dragging the JSON in a new comment.\nIm' sorry but howI can I generate the diagnostics ? \r\nWhat I see after little more investigation is that the 'test button' in the Tahoma app is what you call in HA 'identity' for other Somfy product.\nSee https://www.home-assistant.io/integrations/diagnostics/\nI don't have this option for Overkiz integration. I have it for others integration (ex. Daikin).\r\nPlease have a look on my screenshot.\r\n\r\n<img width=\"1356\" alt=\"overkiz-screenshot1\" src=\"https://github.com/user-attachments/assets/47714467-4d19-428e-811f-78d180f691b6\">\r\n\r\n<img width=\"1920\" alt=\"overkiz-screenshot2\" src=\"https://github.com/user-attachments/assets/71d7d277-da83-438c-9eee-66e1eb5c6c7b\">\r\n\r\n\nCan you click on the 3 dots next to \"Visiter\". This will show the full menu.\nThank you :-) !\r\n[overkiz-c3870f84f152a0449c3a9448c042aa20-Capteur de fum\u00e9e \u00c9tage-015a934295c501564fa0aa50a13a8cba.json](https://github.com/user-attachments/files/16906958/overkiz-c3870f84f152a0449c3a9448c042aa20-Capteur.de.fumee.Etage-015a934295c501564fa0aa50a13a8cba.json)\r\n\n`\r\n\"HistoryExecution(id='c66d4820-0a19-0481-522a-5d22d0cf3076', event_time=1725610936356, owner=s****@****e.fr, source='mobile:tahoma:android', end_time=1725610937597, effective_start_time=1725610936356, duration=1241, label='identify', type='Immediate execution - MANUAL_CONTROL', state=<ExecutionState.COMPLETED: 'COMPLETED'>, failure_type='NO_FAILURE', commands=[HistoryExecutionCommand(device_url=io://****-****-8983/2820363, command='checkEventTrigger', rank=0, dynamic=False, state=<ExecutionState.COMPLETED: 'COMPLETED'>, failure_type='NO_FAILURE', parameters=['short'])], execution_type=<ExecutionType.IMMEDIATE_EXECUTION: 'Immediate execution'>, execution_sub_type=<ExecutionSubType.MANUAL_CONTROL: 'MANUAL_CONTROL'>)\",\r\n`\r\n\r\nIt seems that the command to test your system is `checkEventTrigger` with parameter `short`.\nThere hasn't been any activity on this issue recently. Due to the high number of incoming GitHub notifications, we have to clean some of the old issues, as many of them have already been resolved with the latest updates.\nPlease make sure to update to the latest Home Assistant version and check if that solves the issue. Let us know if that works for you by adding a comment \ud83d\udc4d\nThis issue has now been marked as stale and will be closed if no further activity occurs. Thank you for your contributions.", "created_at": "2024-12-18T10:25:45Z"}
{"repo": "home-assistant/core", "pull_number": 133473, "instance_id": "home-assistant__core-133473", "issue_numbers": ["132893", "132893"], "base_commit": "fa0e54e658975b3559656828b6e2464414000f1a", "patch": "diff --git a/homeassistant/components/overkiz/sensor.py b/homeassistant/components/overkiz/sensor.py\nindex 5c54a1bd383c65..184b4938fefaf5 100644\n--- a/homeassistant/components/overkiz/sensor.py\n+++ b/homeassistant/components/overkiz/sensor.py\n@@ -423,7 +423,7 @@ class OverkizSensorDescription(SensorEntityDescription):\n     OverkizSensorDescription(\n         key=OverkizState.CORE_REMAINING_HOT_WATER,\n         name=\"Warm water remaining\",\n-        device_class=SensorDeviceClass.VOLUME,\n+        device_class=SensorDeviceClass.VOLUME_STORAGE,\n         state_class=SensorStateClass.MEASUREMENT,\n         native_unit_of_measurement=UnitOfVolume.LITERS,\n     ),\n", "test_patch": "", "problem_statement": "wrong state_class for thermor_warm_water_remaining\n### The problem\n\nhello,\r\ncan you fix the stat_class for ```thermor_warm_water_remaining``` please ? thank you.\r\n![2](https://github.com/user-attachments/assets/e1c564f1-760e-4516-b3df-fffe10df68e6)\r\n![1](https://github.com/user-attachments/assets/62f12e71-2ee4-45a0-a921-784e1a0811c2)\r\n\r\n\n\n### What version of Home Assistant Core has the issue?\n\n \tcore-2024.12.2\n\n### What was the last working version of Home Assistant Core?\n\n_No response_\n\n### What type of installation are you running?\n\nHome Assistant OS\n\n### Integration causing the issue\n\noverkiz\n\n### Link to integration documentation on our website\n\nhttps://www.home-assistant.io/integrations/overkiz/\n\n### Diagnostics information\n\n_No response_\n\n### Example YAML snippet\n\n_No response_\n\n### Anything in the logs that might be useful for us?\n\n```txt\nLogger: homeassistant.components.sensor\r\nSource: components/sensor/__init__.py:584\r\nintegration: Sensor (documentation, issues)\r\nFirst occurred: 02:12:30 (1 occurrences)\r\nLast logged: 02:12:30\r\nEntity sensor.thermor_warm_water_remaining (<class 'homeassistant.components.overkiz.sensor.OverkizStateSensor'>) is using state class 'measurement' which is impossible considering device class ('volume') it is using; expected None or one of 'total', 'total_increasing'; Please update your configuration if your entity is manually configured, otherwise create a bug report at https://github.com/home-assistant/core/issues?q=is%3Aopen+is%3Aissue+label%3A%22integration%3A+overkiz%22\n```\n\n\n### Additional information\n\nDevice info\r\nDomesticHotWaterProduction\r\nby Thermor\r\nConnected via Cozytouch Sauter\r\nHardware: modbuslink:AtlanticDomesticHotWaterProductionMBLComponent\nwrong state_class for thermor_warm_water_remaining\n### The problem\n\nhello,\r\ncan you fix the stat_class for ```thermor_warm_water_remaining``` please ? thank you.\r\n![2](https://github.com/user-attachments/assets/e1c564f1-760e-4516-b3df-fffe10df68e6)\r\n![1](https://github.com/user-attachments/assets/62f12e71-2ee4-45a0-a921-784e1a0811c2)\r\n\r\n\n\n### What version of Home Assistant Core has the issue?\n\n \tcore-2024.12.2\n\n### What was the last working version of Home Assistant Core?\n\n_No response_\n\n### What type of installation are you running?\n\nHome Assistant OS\n\n### Integration causing the issue\n\noverkiz\n\n### Link to integration documentation on our website\n\nhttps://www.home-assistant.io/integrations/overkiz/\n\n### Diagnostics information\n\n_No response_\n\n### Example YAML snippet\n\n_No response_\n\n### Anything in the logs that might be useful for us?\n\n```txt\nLogger: homeassistant.components.sensor\r\nSource: components/sensor/__init__.py:584\r\nintegration: Sensor (documentation, issues)\r\nFirst occurred: 02:12:30 (1 occurrences)\r\nLast logged: 02:12:30\r\nEntity sensor.thermor_warm_water_remaining (<class 'homeassistant.components.overkiz.sensor.OverkizStateSensor'>) is using state class 'measurement' which is impossible considering device class ('volume') it is using; expected None or one of 'total', 'total_increasing'; Please update your configuration if your entity is manually configured, otherwise create a bug report at https://github.com/home-assistant/core/issues?q=is%3Aopen+is%3Aissue+label%3A%22integration%3A+overkiz%22\n```\n\n\n### Additional information\n\nDevice info\r\nDomesticHotWaterProduction\r\nby Thermor\r\nConnected via Cozytouch Sauter\r\nHardware: modbuslink:AtlanticDomesticHotWaterProductionMBLComponent\n", "hints_text": "\nHey there @imicknl, @vlebourl, @tetienne, @nyrodev, @tronix117, @alexfp14, mind taking a look at this issue as it has been labeled with an integration (`overkiz`) you are listed as a [code owner](https://github.com/home-assistant/core/blob/dev/CODEOWNERS#L1100) for? Thanks!\n\n<details>\n<summary>Code owner commands</summary>\n\n\nCode owners of `overkiz` can trigger bot actions by commenting:\n\n- `@home-assistant close` Closes the issue.\n- `@home-assistant rename Awesome new title` Renames the issue.\n- `@home-assistant reopen` Reopen the issue.\n- `@home-assistant unassign overkiz` Removes the current integration label and assignees on the issue, add the integration domain after the command.\n- `@home-assistant add-label needs-more-information` Add a label (needs-more-information, problem in dependency, problem in custom component) to the issue.\n- `@home-assistant remove-label needs-more-information` Remove a label (needs-more-information, problem in dependency, problem in custom component) on the issue.\n\n</details>\n\n\n<sub><sup>(message by CodeOwnersMention)</sup></sub>\n\n---\n\n[overkiz documentation](https://www.home-assistant.io/integrations/overkiz)\n[overkiz source](https://github.com/home-assistant/core/tree/dev/homeassistant/components/overkiz)\n<sub><sup>(message by IssueLinks)</sup></sub>\nHi @musapinar ,\r\n`warm_water_remaining` is not something always grow. It report the actual warm water available, it can go up and down. So, the state class _measurement_ is suitable.\r\nThe problem is the device class _volume_. It is designed to be a growing value : a 'total' or 'total_increasing' value,  as `water_volume_estimation_at_40_degc`\r\n\r\nWe should consider changing the device class to `volume storage`. According to the documentation it is for _'Generic stored volume, this device class should be used for sensors representing a stored volume, for example the amount of fuel in a fuel tank.'_\r\n[https://developers.home-assistant.io/docs/core/entity/sensor/#available-device-classes](https://developers.home-assistant.io/docs/core/entity/sensor/#available-device-classes)\n\nHey there @imicknl, @vlebourl, @tetienne, @nyrodev, @tronix117, @alexfp14, mind taking a look at this issue as it has been labeled with an integration (`overkiz`) you are listed as a [code owner](https://github.com/home-assistant/core/blob/dev/CODEOWNERS#L1100) for? Thanks!\n\n<details>\n<summary>Code owner commands</summary>\n\n\nCode owners of `overkiz` can trigger bot actions by commenting:\n\n- `@home-assistant close` Closes the issue.\n- `@home-assistant rename Awesome new title` Renames the issue.\n- `@home-assistant reopen` Reopen the issue.\n- `@home-assistant unassign overkiz` Removes the current integration label and assignees on the issue, add the integration domain after the command.\n- `@home-assistant add-label needs-more-information` Add a label (needs-more-information, problem in dependency, problem in custom component) to the issue.\n- `@home-assistant remove-label needs-more-information` Remove a label (needs-more-information, problem in dependency, problem in custom component) on the issue.\n\n</details>\n\n\n<sub><sup>(message by CodeOwnersMention)</sup></sub>\n\n---\n\n[overkiz documentation](https://www.home-assistant.io/integrations/overkiz)\n[overkiz source](https://github.com/home-assistant/core/tree/dev/homeassistant/components/overkiz)\n<sub><sup>(message by IssueLinks)</sup></sub>\nHi @musapinar ,\r\n`warm_water_remaining` is not something always grow. It report the actual warm water available, it can go up and down. So, the state class _measurement_ is suitable.\r\nThe problem is the device class _volume_. It is designed to be a growing value : a 'total' or 'total_increasing' value,  as `water_volume_estimation_at_40_degc`\r\n\r\nWe should consider changing the device class to `volume storage`. According to the documentation it is for _'Generic stored volume, this device class should be used for sensors representing a stored volume, for example the amount of fuel in a fuel tank.'_\r\n[https://developers.home-assistant.io/docs/core/entity/sensor/#available-device-classes](https://developers.home-assistant.io/docs/core/entity/sensor/#available-device-classes)", "created_at": "2024-12-18T10:12:13Z"}
{"repo": "home-assistant/core", "pull_number": 133471, "instance_id": "home-assistant__core-133471", "issue_numbers": ["127986"], "base_commit": "90208d2eb1da153fd3ada4de5465bce4a70ef9d1", "patch": "diff --git a/homeassistant/components/overkiz/config_flow.py b/homeassistant/components/overkiz/config_flow.py\nindex af7e277d92851..9a94c30d95d32 100644\n--- a/homeassistant/components/overkiz/config_flow.py\n+++ b/homeassistant/components/overkiz/config_flow.py\n@@ -76,7 +76,7 @@ async def async_validate_input(self, user_input: dict[str, Any]) -> dict[str, An\n             for gateway in gateways:\n                 if is_overkiz_gateway(gateway.id):\n                     gateway_id = gateway.id\n-                    await self.async_set_unique_id(gateway_id)\n+                    await self.async_set_unique_id(gateway_id, raise_on_progress=False)\n \n         return user_input\n \n", "test_patch": "", "problem_statement": "Overkiz integration hangs on `Flow aborted: already_in_progress`\n### The problem\r\n\r\nEverything was working fine, for a few months using the Cloud\u00a0API, then a few weeks using the Local\u00a0API, and everything became unavailable. I removed the integration and now can\u2019t get it t connect anymore.\r\n\r\nIf I try to use the Local API, I get a \u201cFailed to connect error\u201d with no logs. Using the mDNS or the IP address of the TaHoma\u00a0V2, enabling or disabling the \u201cVerify SSL certificate\u201d checkbox is the same.\r\n\r\nUsing the Cloud API, I get an \u201cUnexpected error\u201d:\r\n\r\n```\r\nLogger: homeassistant.components.overkiz\r\nSource: components/overkiz/config_flow.py:149\r\nintegration: Overkiz ([documentation](https://www.home-assistant.io/integrations/overkiz), [issues](https://github.com/home-assistant/core/issues?q=is%3Aissue+is%3Aopen+label%3A%22integration%3A+overkiz%22))\r\nFirst occurred: 11:27:20 (1 occurrences)\r\nLast logged: 11:27:20\r\n\r\nUnknown error\r\nTraceback (most recent call last):\r\n  File \"/usr/src/homeassistant/homeassistant/components/overkiz/config_flow.py\", line 149, in async_step_cloud\r\n    await self.async_validate_input(user_input)\r\n  File \"/usr/src/homeassistant/homeassistant/components/overkiz/config_flow.py\", line 80, in async_validate_input\r\n    await self.async_set_unique_id(gateway_id)\r\n  File \"/usr/src/homeassistant/homeassistant/config_entries.py\", line 2451, in async_set_unique_id\r\n    raise data_entry_flow.AbortFlow(\"already_in_progress\")\r\nhomeassistant.data_entry_flow.AbortFlow: Flow aborted: already_in_progress\r\n```\r\n\r\n### What version of Home Assistant Core has the issue?\r\n\r\ncore-2024.10.1\r\n\r\n### What was the last working version of Home Assistant Core?\r\n\r\n_No response_\r\n\r\n### What type of installation are you running?\r\n\r\nHome Assistant Container\r\n\r\n### Integration causing the issue\r\n\r\nOverkiz\r\n\r\n### Link to integration documentation on our website\r\n\r\nhttps://www.home-assistant.io/integrations/overkiz\r\n\r\n### Diagnostics information\r\n\r\n_No response_\r\n\r\n### Example YAML snippet\r\n\r\n_No response_\r\n\r\n### Anything in the logs that might be useful for us?\r\n\r\n_No response_\r\n\r\n### Additional information\r\n\r\n_No response_\n", "hints_text": "\nHey there @imicknl, @vlebourl, @tetienne, @nyrodev, @tronix117, @alexfp14, mind taking a look at this issue as it has been labeled with an integration (`overkiz`) you are listed as a [code owner](https://github.com/home-assistant/core/blob/dev/CODEOWNERS#L1085) for? Thanks!\n\n<details>\n<summary>Code owner commands</summary>\n\n\nCode owners of `overkiz` can trigger bot actions by commenting:\n\n- `@home-assistant close` Closes the issue.\n- `@home-assistant rename Awesome new title` Renames the issue.\n- `@home-assistant reopen` Reopen the issue.\n- `@home-assistant unassign overkiz` Removes the current integration label and assignees on the issue, add the integration domain after the command.\n- `@home-assistant add-label needs-more-information` Add a label (needs-more-information, problem in dependency, problem in custom component) to the issue.\n- `@home-assistant remove-label needs-more-information` Remove a label (needs-more-information, problem in dependency, problem in custom component) on the issue.\n\n</details>\n\n\n<sub><sup>(message by CodeOwnersMention)</sup></sub>\n\n---\n\n[overkiz documentation](https://www.home-assistant.io/integrations/overkiz)\n[overkiz source](https://github.com/home-assistant/core/tree/dev/homeassistant/components/overkiz)\n<sub><sup>(message by IssueLinks)</sup></sub>\nSimilar issue - mine has been working fine for about a year using somfy local API (europe) and stopped working altogether about a week ago. \r\n\r\nmy existing connection now gets an error \"failed setup, will retry: failed to connect\"\nsame problem  stopped working  about two weeks ago.\r\n![Zrzut ekranu 2024-10-09 204752](https://github.com/user-attachments/assets/af473ae8-f51d-400f-9104-7c398c764738)\r\n\n@wisien you are not using the Overkiz integration... Please create a new issue.\r\n\r\n@silkit @GilDev can you still access your box in the browser? Go to your mdns address or ip address, and port 8443. e.g. gateway-xxxx-xxxx-xxxx.local:8443. Most likely after an update your box is not available anymore in local mode, and it needs a reboot or you need to reenable the developer mode.\r\n\r\nRegarding the `already_in_progress` issue when you try to configure a cloud api, after you have tried to configure the local API. I would need to research this, but in the mean-time a restart might solve this issue.\r\n\r\n\n@iMicknl Thanks for the reply. Indeed I cannot access it in my browser, though I had never tried before.\r\nI already restarted, the box, Home\u00a0Assistant and my internet router but it didn\u2019t help.\r\nThe web interface says developer mode is enabled, I don\u2019t see a way to disable it and re enable it (maybe it needs to be factory reset for this?).\r\n\r\nA Cloud\u00a0API configuration following a reboot of Home\u00a0Assistant didn\u2019t help either, still get that \u201calready_in_progress\u201d error.\nOdd - mine was rebooted the other day but didn't seem to change anything. However, i completely rebooted everything this morning; All Ubiquiti/Fiber/HA/UPS etc all shutdown and restarted. Wouldn't you know, it's come back online :-)\r\n\r\nI have re-checked my somfy account and developer mode is still activated but oddly i have tried to access the somfy box via both the mdns address & ip address, and port 8443 - but neither will let me connect. I don't know if I've ever been able to though as i have never attempted to directly log into it this way. Not bothered by this though as it's comes back online and is functioning.\r\nThank you - At least that seems to have resolved it for me\r\n \n> @wisien you are not using the Overkiz integration... Please create a new issue.\r\n> \r\n> @silkit @GilDev can you still access your box in the browser? Go to your mdns address or ip address, and port 8443. e.g. gateway-xxxx-xxxx-xxxx.local:8443. Most likely after an update your box is not available anymore in local mode, and it needs a reboot or you need to reenable the developer mode.\r\n> \r\n> Regarding the `already_in_progress` issue when you try to configure a cloud api, after you have tried to configure the local API. I would need to research this, but in the mean-time a restart might solve this issue.\r\n\r\nThank you very much. I had the same problem and after a restart everything works again\nAny way to disable and enable back developer mode? Can\u2019t seem to disable it from the Somfy\u2019s web interface\u2026\n> Any way to disable and enable back developer mode? Can\u2019t seem to disable it from the Somfy\u2019s web interface\u2026\r\n\r\nNo, only through support if I am not mistaken.\nOkay thanks. Cloud would be fine but still no way to get through that `already_in_progress`. Still haven\u2019t tried factory resetting the TaHoma\u00a0V2.\nBonjour,\r\nJ'ai le m\u00eame probl\u00e8me que @GilDev : Overkiz fonctionnait parfaitement (Tahoma v2), puis depuis quelques jours, ni la local API, ni la cloud API ne fonctionnent (m\u00eame erreur `already_in_progress` sur Cloud API. La local API retourne l'erreur \"\u00c9chec de connexion\" ). L'ensemble des appareils ont \u00e9t\u00e9 red\u00e9marr\u00e9s (box Tahoma, routeur et HA). Le mode d\u00e9veloppeur est activ\u00e9 sur la box Tahoma...\r\nSi vous avez des id\u00e9es pour r\u00e9tablir la connexion, je suis preneur. \r\nMerci d'avance.\nR\u00e9solu \u00e0 l'instant. J'ai supprim\u00e9 l'int\u00e9gration Overkiz, puis l'ai recr\u00e9\u00e9 en passant directement par Cloud API.\nAlso tried again yesterday, and the connection via the Cloud API worked, don't know what happened\u2026", "created_at": "2024-12-18T10:01:03Z"}
{"repo": "home-assistant/core", "pull_number": 133458, "instance_id": "home-assistant__core-133458", "issue_numbers": ["132914"], "base_commit": "e73512e11c9938be4c274f2e824cda7d9fac1306", "patch": "diff --git a/homeassistant/components/overkiz/manifest.json b/homeassistant/components/overkiz/manifest.json\nindex 8c750aec6bd9e8..9ab901d500501a 100644\n--- a/homeassistant/components/overkiz/manifest.json\n+++ b/homeassistant/components/overkiz/manifest.json\n@@ -20,7 +20,7 @@\n   \"integration_type\": \"hub\",\n   \"iot_class\": \"local_polling\",\n   \"loggers\": [\"boto3\", \"botocore\", \"pyhumps\", \"pyoverkiz\", \"s3transfer\"],\n-  \"requirements\": [\"pyoverkiz==1.15.0\"],\n+  \"requirements\": [\"pyoverkiz==1.15.3\"],\n   \"zeroconf\": [\n     {\n       \"type\": \"_kizbox._tcp.local.\",\ndiff --git a/requirements_all.txt b/requirements_all.txt\nindex 37504e5ec410ae..b01683cbf7607c 100644\n--- a/requirements_all.txt\n+++ b/requirements_all.txt\n@@ -2162,7 +2162,7 @@ pyotgw==2.2.2\n pyotp==2.8.0\n \n # homeassistant.components.overkiz\n-pyoverkiz==1.15.0\n+pyoverkiz==1.15.3\n \n # homeassistant.components.onewire\n pyownet==0.10.0.post1\n", "test_patch": "diff --git a/requirements_test_all.txt b/requirements_test_all.txt\nindex 55bb0e6ac1f321..5b339e061b1bd8 100644\n--- a/requirements_test_all.txt\n+++ b/requirements_test_all.txt\n@@ -1755,7 +1755,7 @@ pyotgw==2.2.2\n pyotp==2.8.0\n \n # homeassistant.components.overkiz\n-pyoverkiz==1.15.0\n+pyoverkiz==1.15.3\n \n # homeassistant.components.onewire\n pyownet==0.10.0.post1\n", "problem_statement": "[pyoverkiz.enums.gateway] Unsupported value 122 has been returned for <enum 'GatewayType'>\n### The problem\n\nToday after HA restart the Overkiz integration didn't start and logs two different errors - one from the title, another about DNS. \r\nI use Local API, it has worked well for the past 2 months since I set it up.\r\n\r\nFollowing issues sound similar:\r\n- https://github.com/home-assistant/core/issues/116043\r\n- https://github.com/home-assistant/core/issues/132318\n\n### What version of Home Assistant Core has the issue?\n\n2024.12.2\n\n### What was the last working version of Home Assistant Core?\n\n_No response_\n\n### What type of installation are you running?\n\nHome Assistant OS\n\n### Integration causing the issue\n\nOverkiz\n\n### Link to integration documentation on our website\n\nhttps://www.home-assistant.io/integrations/overkiz\n\n### Diagnostics information\n\n_No response_\n\n### Example YAML snippet\n\n_No response_\n\n### Anything in the logs that might be useful for us?\n\n```txt\nThe following messages get logged with the debug logging enabled (gateway ID anonymised):\r\n\r\n2024-12-11 20:59:30.254 DEBUG (MainThread) [homeassistant.components.overkiz] ZeroConf discovery detected gateway ****-****-6495 on gateway-xxxx-xxxx-6495.local. (_kizbox._tcp.local.)\r\n2024-12-11 20:59:30.254 DEBUG (MainThread) [homeassistant.components.overkiz] ZeroConf discovery detected gateway ****-****-6495 on gateway-xxxx-xxxx-6495.local. (_kizboxdev._tcp.local.)\r\n2024-12-11 21:19:00.951 WARNING (MainThread) [pyoverkiz.enums.gateway] Unsupported value 122 has been returned for <enum 'GatewayType'>\r\n2024-12-11 21:19:01.334 DEBUG (MainThread) [homeassistant.components.overkiz] Cannot connect to host gateway-xxxx-xxxx-xxxx.local:8443 ssl:False [Connect call failed ('10.10.0.152', 8443)]\r\n2024-12-11 21:22:28.579 DEBUG (MainThread) [homeassistant.components.overkiz] Cannot connect to host gateway-xxxx-xxxx-xxxx:8443 ssl:False [DNS server returned answer with no data]\r\n```\n```\n\n\n### Additional information\n\nThe Tahoma switch had auto upgrade enabled so it may have upgraded its firmware. I have no way to check :(\r\n\n", "hints_text": "\nHey there @imicknl, @vlebourl, @tetienne, @nyrodev, @tronix117, @alexfp14, mind taking a look at this issue as it has been labeled with an integration (`overkiz`) you are listed as a [code owner](https://github.com/home-assistant/core/blob/dev/CODEOWNERS#L1100) for? Thanks!\n\n<details>\n<summary>Code owner commands</summary>\n\n\nCode owners of `overkiz` can trigger bot actions by commenting:\n\n- `@home-assistant close` Closes the issue.\n- `@home-assistant rename Awesome new title` Renames the issue.\n- `@home-assistant reopen` Reopen the issue.\n- `@home-assistant unassign overkiz` Removes the current integration label and assignees on the issue, add the integration domain after the command.\n- `@home-assistant add-label needs-more-information` Add a label (needs-more-information, problem in dependency, problem in custom component) to the issue.\n- `@home-assistant remove-label needs-more-information` Remove a label (needs-more-information, problem in dependency, problem in custom component) on the issue.\n\n</details>\n\n\n<sub><sup>(message by CodeOwnersMention)</sup></sub>\n\n---\n\n[overkiz documentation](https://www.home-assistant.io/integrations/overkiz)\n[overkiz source](https://github.com/home-assistant/core/tree/dev/homeassistant/components/overkiz)\n<sub><sup>(message by IssueLinks)</sup></sub>\nDo you know which TaHoma Switch you have? Apparently your specific gateway type is a new one that we haven't seen before. I will add the details to our underlying library.\r\n\r\nIt is just a warning that won't influence the working of the integration. Your issue with the local API is due to #132318.\nThanks for a quick response!\r\n\r\nThe only thing other than Tahoma Switch on the device is `5152601A` - possibly the model number? Otherwise it looks just like https://www.somfy.com.au/products/1871147/tahoma-switch\r\n\r\nI'll follow up in #132318 but I already had `verify_ssl: false` from my initial setup. Re-adding the integration with any setting (using switch s/n hostname or IP address) with or without ssl verification, local or cloud, always yields connection error.\r\nThe integration stopped working today. I'm connecting to somfy_oceania.", "created_at": "2024-12-17T23:11:03Z"}
{"repo": "home-assistant/core", "pull_number": 133455, "instance_id": "home-assistant__core-133455", "issue_numbers": ["132333"], "base_commit": "4c60e36f4f34590fd994fc4a2a23da8d61bfc944", "patch": "diff --git a/homeassistant/components/freebox/manifest.json b/homeassistant/components/freebox/manifest.json\nindex ad7da1703b805..46422cee1055b 100644\n--- a/homeassistant/components/freebox/manifest.json\n+++ b/homeassistant/components/freebox/manifest.json\n@@ -7,6 +7,6 @@\n   \"documentation\": \"https://www.home-assistant.io/integrations/freebox\",\n   \"iot_class\": \"local_polling\",\n   \"loggers\": [\"freebox_api\"],\n-  \"requirements\": [\"freebox-api==1.1.0\"],\n+  \"requirements\": [\"freebox-api==1.2.1\"],\n   \"zeroconf\": [\"_fbx-api._tcp.local.\"]\n }\ndiff --git a/requirements_all.txt b/requirements_all.txt\nindex 37504e5ec410a..6115923fd7b54 100644\n--- a/requirements_all.txt\n+++ b/requirements_all.txt\n@@ -940,7 +940,7 @@ forecast-solar==4.0.0\n fortiosapi==1.0.5\n \n # homeassistant.components.freebox\n-freebox-api==1.1.0\n+freebox-api==1.2.1\n \n # homeassistant.components.free_mobile\n freesms==0.2.0\n", "test_patch": "diff --git a/requirements_test_all.txt b/requirements_test_all.txt\nindex 55bb0e6ac1f32..b9b947b396acc 100644\n--- a/requirements_test_all.txt\n+++ b/requirements_test_all.txt\n@@ -796,7 +796,7 @@ foobot_async==1.0.0\n forecast-solar==4.0.0\n \n # homeassistant.components.freebox\n-freebox-api==1.1.0\n+freebox-api==1.2.1\n \n # homeassistant.components.fritz\n # homeassistant.components.fritzbox_callmonitor\n", "problem_statement": "Freebox integration is no longer working due to SSLCertVerificationError\n### The problem\r\n\r\nFollowing the installation of the Home Assistant update\r\n(2024.11.3), the freebox delta integration no longer works. I restarted the Freebox, restarted HA but the problem persists.\r\nKind regards\r\n\r\n\r\n### What version of Home Assistant Core has the issue?\r\n\r\ncore-2024.11.3\r\n\r\n### What was the last working version of Home Assistant Core?\r\n\r\ncore-2024.11.2\r\n\r\n### What type of installation are you running?\r\n\r\nHome Assistant OS\r\n\r\n### Integration causing the issue\r\n\r\nFreebox\r\n\r\n### Link to integration documentation on our website\r\n\r\nhttps://www.home-assistant.io/integrations/freebox\r\n\r\n### Diagnostics information\r\n\r\n_No response_\r\n\r\n### Example YAML snippet\r\n\r\n_No response_\r\n\r\n### Anything in the logs that might be useful for us?\r\n\r\n_No response_\r\n\r\n### Additional information\r\n\r\n_No response_\n", "hints_text": "\nHey there @hacf-fr, @quentame, mind taking a look at this issue as it has been labeled with an integration (`freebox`) you are listed as a [code owner](https://github.com/home-assistant/core/blob/dev/CODEOWNERS#L497) for? Thanks!\n\n<details>\n<summary>Code owner commands</summary>\n\n\nCode owners of `freebox` can trigger bot actions by commenting:\n\n- `@home-assistant close` Closes the issue.\n- `@home-assistant rename Awesome new title` Renames the issue.\n- `@home-assistant reopen` Reopen the issue.\n- `@home-assistant unassign freebox` Removes the current integration label and assignees on the issue, add the integration domain after the command.\n- `@home-assistant add-label needs-more-information` Add a label (needs-more-information, problem in dependency, problem in custom component) to the issue.\n- `@home-assistant remove-label needs-more-information` Remove a label (needs-more-information, problem in dependency, problem in custom component) on the issue.\n\n</details>\n\n\n<sub><sup>(message by CodeOwnersMention)</sup></sub>\n\n---\n\n[freebox documentation](https://www.home-assistant.io/integrations/freebox)\n[freebox source](https://github.com/home-assistant/core/tree/dev/homeassistant/components/freebox)\n<sub><sup>(message by IssueLinks)</sup></sub>\nI have the same issue after upgrading HA to 2024.12. Maybe a breaking change with the last firmware of Free because I had 2024.11.3.\r\n\n\r\nI don't think it comes from the Freebox firmware because it worked with version 2024.11.3.\r\n\n**Exception found in the logs :**\r\n\r\nThe cause :\r\naiohttp.client_exceptions.ClientConnectorCertificateError: Cannot connect to host xxx.fbxos.fr:12483 ssl:True [SSLCertVerificationError: (1, '[SSL: CERTIFICATE_VERIFY_FAILED] certificate verify failed: Missing Authority Key Identifier (_ssl.c:1020)')]\r\n\r\n\r\n`2024-12-05 08:25:31.030 WARNING (MainThread) [homeassistant.util.loop] Detected blocking call to load_default_certs with args (<ssl.SSLContext object at 0xffff84016450>, <Purpose.SERVER_AUTH: _ASN1Object(nid=129, shortname='serverAuth', longname='TLS Web Server Authentication', oid='1.3.6.1.5.5.7.3.1')>) inside the event loop by integration 'freebox' at homeassistant/components/freebox/__init__.py, line 26: await api.open(entry.data[CONF_HOST], entry.data[CONF_PORT]) (offender: /usr/local/lib/python3.13/ssl.py, line 722: context.load_default_certs(purpose)), please create a bug report at https://github.com/home-assistant/core/issues?q=is%3Aopen+is%3Aissue+label%3A%22integration%3A+freebox%22`\r\n\r\n```\r\nFor developers, please see https://developers.home-assistant.io/docs/asyncio_blocking_operations/#load_default_certs\r\nTraceback (most recent call last):\r\n  File \"<frozen runpy>\", line 198, in _run_module_as_main\r\n  File \"<frozen runpy>\", line 88, in _run_code\r\n  File \"/usr/src/homeassistant/homeassistant/__main__.py\", line 227, in <module>\r\n    sys.exit(main())\r\n  File \"/usr/src/homeassistant/homeassistant/__main__.py\", line 213, in main\r\n    exit_code = runner.run(runtime_conf)\r\n  File \"/usr/src/homeassistant/homeassistant/runner.py\", line 154, in run\r\n    return loop.run_until_complete(setup_and_run_hass(runtime_config))\r\n  File \"/usr/local/lib/python3.13/asyncio/base_events.py\", line 708, in run_until_complete\r\n    self.run_forever()\r\n  File \"/usr/local/lib/python3.13/asyncio/base_events.py\", line 679, in run_forever\r\n    self._run_once()\r\n  File \"/usr/local/lib/python3.13/asyncio/base_events.py\", line 2027, in _run_once\r\n    handle._run()\r\n  File \"/usr/local/lib/python3.13/asyncio/events.py\", line 89, in _run\r\n    self._context.run(self._callback, *self._args)\r\n  File \"/usr/src/homeassistant/homeassistant/setup.py\", line 165, in async_setup_component\r\n    result = await _async_setup_component(hass, domain, config)\r\n  File \"/usr/src/homeassistant/homeassistant/setup.py\", line 461, in _async_setup_component\r\n    await asyncio.gather(\r\n  File \"/usr/src/homeassistant/homeassistant/setup.py\", line 463, in <genexpr>\r\n    create_eager_task(\r\n  File \"/usr/src/homeassistant/homeassistant/util/async_.py\", line 45, in create_eager_task\r\n    return Task(coro, loop=loop, name=name, eager_start=True)\r\n  File \"/usr/src/homeassistant/homeassistant/config_entries.py\", line 788, in async_setup_locked\r\n    await self.async_setup(hass, integration=integration)\r\n  File \"/usr/src/homeassistant/homeassistant/config_entries.py\", line 551, in async_setup\r\n    await self.__async_setup_with_context(hass, integration)\r\n  File \"/usr/src/homeassistant/homeassistant/config_entries.py\", line 640, in __async_setup_with_context\r\n    result = await component.async_setup_entry(hass, self)\r\n  File \"/usr/src/homeassistant/homeassistant/components/freebox/__init__.py\", line 26, in async_setup_entry\r\n    await api.open(entry.data[CONF_HOST], entry.data[CONF_PORT])\r\n\r\n\r\n2024-12-05 08:25:31.355 ERROR (MainThread) [homeassistant.config_entries] Error setting up entry xxx.fbxos.fr for freebox\r\nTraceback (most recent call last):\r\n  File \"/usr/local/lib/python3.13/site-packages/aiohttp/connector.py\", line 1116, in _wrap_create_connection\r\n    return await self._loop.create_connection(*args, **kwargs, sock=sock)\r\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/local/lib/python3.13/asyncio/base_events.py\", line 1182, in create_connection\r\n    transport, protocol = await self._create_connection_transport(\r\n                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n    ...<2 lines>...\r\n        ssl_shutdown_timeout=ssl_shutdown_timeout)\r\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/local/lib/python3.13/asyncio/base_events.py\", line 1215, in _create_connection_transport\r\n    await waiter\r\n  File \"/usr/local/lib/python3.13/asyncio/sslproto.py\", line 578, in _on_handshake_complete\r\n    raise handshake_exc\r\n  File \"/usr/local/lib/python3.13/asyncio/sslproto.py\", line 560, in _do_handshake\r\n    self._sslobj.do_handshake()\r\n    ~~~~~~~~~~~~~~~~~~~~~~~~~^^\r\n  File \"/usr/local/lib/python3.13/ssl.py\", line 951, in do_handshake\r\n    self._sslobj.do_handshake()\r\n    ~~~~~~~~~~~~~~~~~~~~~~~~~^^\r\nssl.SSLCertVerificationError: [SSL: CERTIFICATE_VERIFY_FAILED] certificate verify failed: Missing Authority Key Identifier (_ssl.c:1020)\r\n\r\nThe above exception was the direct cause of the following exception:\r\n\r\nTraceback (most recent call last):\r\n  File \"/usr/src/homeassistant/homeassistant/config_entries.py\", line 640, in __async_setup_with_context\r\n    result = await component.async_setup_entry(hass, self)\r\n             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/src/homeassistant/homeassistant/components/freebox/__init__.py\", line 30, in async_setup_entry\r\n    freebox_config = await api.system.get_config()\r\n                     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/local/lib/python3.13/site-packages/freebox_api/api/system.py\", line 9, in get_config\r\n    return await self._access.get(\"system/\")\r\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/local/lib/python3.13/site-packages/freebox_api/access.py\", line 122, in get\r\n    return await self._perform_request(self.session.get, end_url)\r\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/local/lib/python3.13/site-packages/freebox_api/access.py\", line 86, in _perform_request\r\n    await self._refresh_session_token()\r\n  File \"/usr/local/lib/python3.13/site-packages/freebox_api/access.py\", line 69, in _refresh_session_token\r\n    session_token, session_permissions = await self._get_session_token(\r\n                                         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n        self.base_url, self.app_token, self.app_id, self.timeout\r\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n    )\r\n    ^\r\n  File \"/usr/local/lib/python3.13/site-packages/freebox_api/access.py\", line 45, in _get_session_token\r\n    challenge = await self._get_challenge(base_url, timeout)\r\n                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/local/lib/python3.13/site-packages/freebox_api/access.py\", line 28, in _get_challenge\r\n    r = await self.session.get(url, timeout=timeout)\r\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/local/lib/python3.13/site-packages/aiohttp/client.py\", line 701, in _request\r\n    conn = await self._connector.connect(\r\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n        req, traces=traces, timeout=real_timeout\r\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n    )\r\n    ^\r\n  File \"/usr/local/lib/python3.13/site-packages/aiohttp/connector.py\", line 544, in connect\r\n    proto = await self._create_connection(req, traces, timeout)\r\n            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/local/lib/python3.13/site-packages/aiohttp/connector.py\", line 1050, in _create_connection\r\n    _, proto = await self._create_direct_connection(req, traces, timeout)\r\n               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/local/lib/python3.13/site-packages/aiohttp/connector.py\", line 1394, in _create_direct_connection\r\n    raise last_exc\r\n  File \"/usr/local/lib/python3.13/site-packages/aiohttp/connector.py\", line 1363, in _create_direct_connection\r\n    transp, proto = await self._wrap_create_connection(\r\n                    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n    ...<7 lines>...\r\n    )\r\n    ^\r\n  File \"/usr/local/lib/python3.13/site-packages/aiohttp/connector.py\", line 1118, in _wrap_create_connection\r\n    raise ClientConnectorCertificateError(req.connection_key, exc) from exc\r\naiohttp.client_exceptions.ClientConnectorCertificateError: Cannot connect to host xxx.fbxos.fr:12483 ssl:True [SSLCertVerificationError: (1, '[SSL: CERTIFICATE_VERIFY_FAILED] certificate verify failed: Missing Authority Key Identifier (_ssl.c:1020)')]\r\n2024-12-05 08:25:31.590 ERROR (ImportExecutor_0) [homeassistant] Error doing job: Unclosed client session (None)\r\n```\nHello, i have the same problem with Freebox Revolution since last HA update\r\nCore 2024.12.0\r\nSupervisor 2024.11.4\r\nOperating System 14.0\r\nInterface utilisateur 20241127.4\r\nThanks\nHi,\r\nsame error here since last HA update 2024.12\r\nCore 2024.12.0\r\nSupervisor 2024.11.4\r\nOperating System 14.0\r\nInterface utilisateur 20241127.4\r\n\r\nWith the same error in the logs :\r\n\r\nTraceback (most recent call last):\r\n  File \"/usr/local/lib/python3.13/site-packages/aiohttp/connector.py\", line 1116, in _wrap_create_connection\r\n    return await self._loop.create_connection(*args, **kwargs, sock=sock)\r\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/local/lib/python3.13/asyncio/base_events.py\", line 1182, in create_connection\r\n    transport, protocol = await self._create_connection_transport(\r\n                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n    ...<2 lines>...\r\n        ssl_shutdown_timeout=ssl_shutdown_timeout)\r\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/local/lib/python3.13/asyncio/base_events.py\", line 1215, in _create_connection_transport\r\n    await waiter\r\n  File \"/usr/local/lib/python3.13/asyncio/sslproto.py\", line 578, in _on_handshake_complete\r\n    raise handshake_exc\r\n  File \"/usr/local/lib/python3.13/asyncio/sslproto.py\", line 560, in _do_handshake\r\n    self._sslobj.do_handshake()\r\n    ~~~~~~~~~~~~~~~~~~~~~~~~~^^\r\n  File \"/usr/local/lib/python3.13/ssl.py\", line 951, in do_handshake\r\n    self._sslobj.do_handshake()\r\n    ~~~~~~~~~~~~~~~~~~~~~~~~~^^\r\nssl.SSLCertVerificationError: [SSL: CERTIFICATE_VERIFY_FAILED] certificate verify failed: Missing Authority Key Identifier (_ssl.c:1020)\r\n\r\nThe above exception was the direct cause of the following exception:\nSame issue since upgrade to 2024.12.0, `CERTIFICATE_VERIFY_FAILED ` error with Freebox Pop.\nI think the issue is in the freebox-api package : https://freebox-api.readthedocs.io/en/latest/\r\nThe package seems to work only with python 3.11 while home assistant 2024.12 uses python 3.13.\r\n\r\nDocumentation of The freebox API : \r\n> When you access a Freebox with its default-assigned domain (ending in fbxos.fr), the library verifies its certificate by automatically trusting the Freebox certificate authority.\r\n\r\nThis is the feature that does not work with python 3.13.\nHello,\r\nFor information, i have a Rpi with previous HA version and Freebox integration works perfectly\r\nThanks\nI have the same issue after upgrading HA to 2024.12. Maybe a breaking change with the last firmware of Free because I had 2024.11.3.\n> I have the same issue after upgrading HA to 2024.12. Maybe a breaking change with the last firmware of Free because I had 2024.11.3.\r\n\r\nNo. The root cause is the step where ssl should be verified. With 2024.11.3, the last firmware of Free works.\nSame issue here with Delta.\nAre letsencrypt CA's up to date in the containers?\r\n\r\nMy Freebox Revolution cert is using CAs \"R10\" then \"ISRG Root X1\"\r\n\r\nSee this: https://letsencrypt.org/certificates/\nI have pop and same problem,\r\nI broke the golden rule, if it work don't touch\nUnfortunately, certificates expire...\n> Are letsencrypt CA's up to date in the containers?\r\n> \r\n> My Freebox Revolution cert is using CAs \"R10\" then \"ISRG Root X1\"\r\n> \r\n> See this: https://letsencrypt.org/certificates/\r\n\r\nNo this is not the root cause because it works with HA <= 2024.11.4\r\nProbably a dependency upgraded by HA/python3.13 and used by the integration.\r\nI think a maintenair should have a look.\nLooks like a strict ssl mode is now the default in python.\nHi !\r\nMaintainer of the integration here !\r\nI'll look into it soon.\nWorking on my installation\r\nHA-core: 2024.11.1\r\nFreeboxOS: 4.8.16 (latest)\r\n\r\nSo, but reading all previous comments:\r\n\r\n| Working ? | Versions |\r\n|-----------|----------|\r\n|       \u2705       | 2024.11.1 |\r\n|       \u2705       | 2024.11.2 |\r\n|       \u2705       | 2024.11.3 |\r\n|       \u274c       | 2024.12.0 |\r\n\r\nAm I right ?\r\n\n@Dgigie : Are you agree with me about that \u2b06\ufe0f ?\r\n\r\nBecause you said both that 2024.11.3 was the issue (in the issue description) and work (in a comment) \ud83d\ude05 \nWhen I try with openssl s_client -x509_strict -connect to freebox\r\n- Ok with custom name (mycustomname.freeboxos.fr)\r\n- verify error with generic name (crypticname.fbxos.fr) which is the auto discovered name\r\n\r\nNo problem with previous versions.\r\nSeems like new strict ssl mode with python 3.13\r\nWe need a workaround, but Free should correct their certificates.\r\n\r\nLatest revolution firmware (fix)\r\n\nHello, \nI think you're right.\nIt was working before the last HA update I made earlier today.\nI have Freebox Ultra (OS version 4.8.17).\n\n> We need a workaround, but Free should correct their certificates.\r\n\r\nIndeed, I've just check the SSL of my Freebox compared to the one in the library underlying: they are the same\nxxxxxxxx.fbxos.fr is not signed with letsencrypt:\r\n\r\nCertificate chain\r\n0 s:C=FR, CN=xxxxxxxx.fbxos.fr\r\ni:C=FR, ST=France, O=Freebox SA, CN=Freebox ECC Intermediate CA\r\na:PKEY: id-ecPublicKey, 256 (bit); sigalg: ecdsa-with-SHA256\r\nv:NotBefore: Dec  5 20:46:50 2024 GMT; NotAfter: Mar  5 20:51:50 2025 GMT\r\n1 s:C=FR, ST=France, O=Freebox SA, CN=Freebox ECC Intermediate CA\r\ni:C=FR, ST=France, L=Paris, O=Freebox SA, CN=Freebox ECC Root CA\r\na:PKEY: id-ecPublicKey, 384 (bit); sigalg: ecdsa-with-SHA256\r\nv:NotBefore: Sep 11 16:57:30 2024 GMT; NotAfter: Sep  9 16:57:30 2034 GMT\r\n\r\n\r\nNotBefore: Dec 5 20:46:50 2024 GMT ?!?\r\nJust wait?\nxxxxxxxx.fbxos.fr CA is not recognised on firefox: Freebox ECC Intermediate CA\nhttps://dev.freebox.fr/bugs/task/39716\r\nhttps://dev.freebox.fr/bugs/task/26978\r\n\r\nSo add CA and go F** yourself...\nAnother solution would be to be able to rename a discovered freebox to its proper name\n> xxxxxxxx.fbxos.fr is not signed with letsencrypt\r\n\r\nAnd ?\r\n\r\nA certificate do not need to be certificated by Let's Encrypt to be legit.\r\n\r\nA valid certificate need to be created by a trusted root authority/organisation and have an expiration date after now.\r\n\r\nBut a non valid certificate is still providing a secure connection, just that your browser shows a warning, and APIs need to clearly authorize it.\r\n\r\n> https://dev.freebox.fr/bugs/task/39716\r\n> https://dev.freebox.fr/bugs/task/26978\r\n> \r\n> So add CA and [REDACTED]\r\n\r\nThat is already the case, thanks mate, apparently you better know my work than myself ...\r\n\r\nSee by yourself here: https://github.com/hacf-fr/freebox-api/blob/master/src/freebox_api/freebox_certificates.pem\r\n\r\n> Another solution would be to be able to rename a discovered freebox to its proper name\r\n\r\nThis is not a solution/fix to an issue, this is a feature request.\r\n\n| That is already the case, thanks mate, apparently you better know my work than myself ...\r\nLooking for a solution, not a fight, but I have quite good ssl knowledge from my work.\r\nSo maybe strict python needs a full valid chain, which is not the case with freebox CA.\r\nIf firefox itself complains, there's a real problem with fbxos.fr certificates.\r\n\n> Looking for a solution, not a fight, but I have quite good ssl knowledge from my work.\r\n\r\nI don't need to be insulted to be helped. I'm not the one starting a fight.\nI haven't found where to find logs to explain the problem .... but I have the same...\r\n- impossible to remove integration on public dns xxxxx.fbxos.fr:44230 ...\r\n- managed to add an other occurence of it with its local name mafreebox.freebox.fr:443 \nThe real question is, can we get python to accept the incomplete Freebox ECC Intermediate CA?\n> > Looking for a solution, not a fight, but I have quite good ssl knowledge from my work.\r\n> \r\n> I don't need to be insulted to be helped. I'm not the one starting a fight.\r\n\r\n| That is already the case, thanks mate, apparently you better know my work than myself \r\n\r\nNever said that... Just looking for a solution...\r\n\r\nAs I said, my best guess would be \"Freebox ECC Intermediate CA\" vs new python \"strict mode\"\r\n\nFirefox is complaining about xxxxx.fbxos.fr ssl trust.\nMy 2 cents: the auto discovery of the module is finding a name in xxx.fbxos.fr \r\nIf you configure a TLS certificate and a fully qualified domain name in xxx.freeboxos.fr (which configure a let's encrypt certificate btw) through the admin console of the Freebox, it's working.\r\nYou have to use the fqdn in the parameter of the module and voil\u00e0 !\nOK, soooooo, I've updated my setup to 2024.12.0 and it also worked for me \ud83d\ude05\r\n\r\nI am running my installation on container, that's maybe why.\r\n\r\nAlso my Freebox is configured with a `[custom_name].freeboxos.fr` and not configured with `*.fbxos.fr` and neither `http://mafreebox.freebox.fr/`\r\n\r\nI may need some more details on your installation all of you \ud83d\ude05 \r\n\r\n\r\nMay you copy paste and fill this template please ? \ud83d\ude4f \r\n```\r\nHA version: \r\nHA installation: OS/container/core/supervised\r\nIntegration: working: \u2705  OR \u274c (remove the useless emoji)\r\nIntegration URL: `[custom_name].freeboxos.fr` OR `*.fbxos.fr` OR `http://mafreebox.freebox.fr/` (remove all useless choices)\r\n```\n> The real question is, can we get python to accept the incomplete Freebox ECC Intermediate CA?\r\n\r\nYes \ud83d\ude0c \n> OK, soooooo, I've updated my setup to 2024.12.0 and it also worked for me \ud83d\ude05\r\n> \r\n> I am running my installation on container, that's maybe why.\r\n> \r\n> Also my Freebox is configured with a `[custom_name].freeboxos.fr` and not configured with `*.fbxos.fr` and neither `http://mafreebox.freebox.fr/`\r\n> \r\n> I may need some more details on your installation all of you \ud83d\ude05\r\n> \r\n> May you copy paste and fill this template please ? \ud83d\ude4f\r\n> \r\n> ```\r\n> HA version: \r\n> HA installation: OS/container/core/supervised\r\n> Integration: working: \u2705  OR \u274c (remove the useless emoji)\r\n> Integration URL: `[custom_name].freeboxos.fr` OR `*.fbxos.fr` OR `http://mafreebox.freebox.fr/` (remove all useless choices)\r\n> ```\r\nHi, \r\n\r\nHA version: Core = 2024.12.0  / Supervisor = 2024.11.4 / OS = 14\r\nHA installation: VM in proxmox\r\nIntegration: working: \u274c \r\nIntegration URL: *.fbxos.fr \nHA version: 2024.12.0\r\nHA installation: supervised\r\nIntegration: working: \u274c\r\nIntegration URL: *.fbxos.fr (auto detect)\r\n\r\nworked with 2024.11, must be linked to python 3.13 update.\r\n\n> OK, soooooo, I've updated my setup to 2024.12.0 and it also worked for me \ud83d\ude05\r\n> \r\n> I am running my installation on container, that's maybe why.\r\n> \r\n> Also my Freebox is configured with a `[custom_name].freeboxos.fr` and not configured with `*.fbxos.fr` and neither `http://mafreebox.freebox.fr/`\r\n> \r\n> I may need some more details on your installation all of you \ud83d\ude05\r\n> \r\n> May you copy paste and fill this template please ? \ud83d\ude4f\r\n> \r\n> ```\r\n> HA version: \r\n> HA installation: OS/container/core/supervised\r\n> Integration: working: \u2705  OR \u274c (remove the useless emoji)\r\n> Integration URL: `[custom_name].freeboxos.fr` OR `*.fbxos.fr` OR `http://mafreebox.freebox.fr/` (remove all useless choices)\r\n> ```\r\n\r\nHi\r\n\r\nwhere can we change URL to test xxxxxxxxxx.freeboxos.fr\nAuto detect (mdns?) reports fbxos.fr name\nHA version: 2024.12.0\r\nHA installation: HA OS 14\r\nIntegration: working: \u274c\r\nIntegration URL: `*.fbxos.fr` \nSite A: Freebox DELTA 4.8.15\r\nHA version: 2024.12.0\r\nHA installation: VM in proxmox\r\nIntegration: working: \u274c\r\nIntegration URL: *.fbxos.fr\r\n\r\nSite B: Freebox DELTA 4.8.17.1\r\nHA version: 2024.12.0\r\nHA installation: VM in proxmox\r\nIntegration: working: \u274c\r\nIntegration URL: mafreebox.freebox.fr\nIs there a way to migrate an autodetected freebox url (with a bad cert) to a stable url (with a good cert) ?\r\nOtherwise device presence is a real problem, duplicates, etc...\r\n\nmafreebox.freebox.fr is using \"Freebox ECC Intermediate CA\"\r\n\r\nBut ports are defaults ones instead of the configured ones.\r\n\r\ndns lookup shows:\r\nmafreebox.freebox.fr is an alias for freeplayer.freebox.fr.\r\nfreeplayer.freebox.fr has address 212.27.38.253\r\n\r\nLooks like another problem...\n> @Dgigie : Are you agree with me about that \u2b06\ufe0f ?\r\n> \r\n> Because you said both that 2024.11.3 was the issue (in the issue description) and work (in a comment) \ud83d\ude05\r\n\r\nyes you are absolutely right, I looked at the saved version instead of looking at the installed version... sorry...\nVMS Freebox Delta\r\nCore                  2024.12.0\r\nSupervisor            2024.11.4\r\nOperating System      14.0\r\nInterface utilisateur 20241127.4\r\nURL :                 *.fbox.fr\r\n\r\nOtherwise Quentame, I just wanted to thank you for all the hours spent behind your screen and for allowing us for quite some time to use our Freebox with HA without any problem...\r\nSome people tend to \"forget\" that everything is free with HA and that the people who allow us to enjoy all these technologies do it voluntarily....\r\nAgain, a big thank you for all the work!!!\n> Hello, I think you're right. It was working before the last HA update I made earlier today. I have Freebox Ultra (OS version 4.8.17).\r\n\r\nBefore deleting the Freebox: \r\n```\r\nHA version: 2024.12.0\r\nHA installation: OS (Raspberry Pi4)\r\nIntegration: working: \u274c\r\nIntegration URL: `[custom_name].freeboxos.fr` OR `http://mafreebox.freebox.fr/` (remove all useless choices)\r\n```\r\n\r\nAfter deleting the Freebox: (can't adding it)\r\n```\r\nHA version: 2024.12.0\r\nHA installation: OS (Raspberry Pi4)\r\nIntegration: working: \u274c\r\nIntegration URL: `http://mafreebox.freebox.fr/`\r\n```\r\n\r\nThank you for your time and your reactivity. :-)\n> HA version: 2024.12.0\r\n> HA installation: OS (VM AARCH-64, Freebox Delta)\r\n> Integration: working: \u274c \r\n> Integration URL:  *.fbxos.fr\r\n\r\nThank you for your investigation :)\n> Hi, same error here since last HA update 2024.12 Core 2024.12.0 Supervisor 2024.11.4 Operating System 14.0 Interface utilisateur 20241127.4\r\n> \r\n> With the same error in the logs :\r\n> \r\n> Traceback (most recent call last): File \"/usr/local/lib/python3.13/site-packages/aiohttp/connector.py\", line 1116, in _wrap_create_connection return await self._loop.create_connection(*args, **kwargs, sock=sock) ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^ File \"/usr/local/lib/python3.13/asyncio/base_events.py\", line 1182, in create_connection transport, protocol = await self._create_connection_transport( ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^ ...<2 lines>... ssl_shutdown_timeout=ssl_shutdown_timeout) ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^ File \"/usr/local/lib/python3.13/asyncio/base_events.py\", line 1215, in _create_connection_transport await waiter File \"/usr/local/lib/python3.13/asyncio/sslproto.py\", line 578, in _on_handshake_complete raise handshake_exc File \"/usr/local/lib/python3.13/asyncio/sslproto.py\", line 560, in _do_handshake self._sslobj.do_handshake() ~~~~~~~~~~~~~~~~~~~~~~~~~^^ File \"/usr/local/lib/python3.13/ssl.py\", line 951, in do_handshake self._sslobj.do_handshake() ~~~~~~~~~~~~~~~~~~~~~~~~~^^ ssl.SSLCertVerificationError: [SSL: CERTIFICATE_VERIFY_FAILED] certificate verify failed: Missing Authority Key Identifier (_ssl.c:1020)\r\n> \r\n> The above exception was the direct cause of the following exception:\r\n\r\nI try to change hostname with custom.freeboxos.fr and it works fine with HA Core 2024.12.0\nGood news! A workaround \ud83d\udc4d \r\nHow to rename the hostname ?\nWorkaround confirmed:\r\n\r\nHA version: 2024.12.0\r\nHA installation: OS (Raspberry Pi4)\r\nIntegration working: \u2705 \r\nIntegration URL: `http://custom.freeboxos.fr/`\r\nFreebox type: Freebox Revolution\r\n\r\n> Good news! A workaround \ud83d\udc4d How to rename the hostname ?\r\n\r\nI personally removed the integration from HA, then re-added it with the custom hostname.\nIf indeed this can be solved in such a simple way I think that Quentame will very quickly release a fix for us. :-)\nHi @Quentame many thanks for the support\r\n\r\nHA version: \r\nHA installation: OS\r\nIntegration: working: \u274c\r\nIntegration URL: *.fbxos.fr`\nThanks the workaround work perfectly for me\n\r\n\r\n\r\n> Workaround confirmed:\r\n> \r\n> HA version: 2024.12.0 HA installation: OS (Raspberry Pi4) Integration working: \u2705 Integration URL: `http://custom.freeboxos.fr/`\r\n> \r\n> > Good news! A workaround \ud83d\udc4d How to rename the hostname ?\r\n> \r\n> I personally removed the integration from HA, then re-added it with the custom hostname.\r\n\r\nWhat is your freebox and if you have the Delta do you use the alarm of the latter and does it work with HA?\nSame here, i change value in file : .storage/core.config_entries\r\n\r\nreplace xxxxxxxxxx.fbxos.fr by xxxxxxxxxxxx.freeboxos.fr ( 2 values changed in the line)\r\n\r\nAnd it's ok !\r\n\r\nHA version: 2024.12.0\r\nHA installation: Proxmox / Docker\r\nIntegration working: \u2705\r\nIntegration URL: http://custom.freeboxos.fr/\r\nFreebox type: Freebox Delta\n> > Workaround confirmed:\r\n> > HA version: 2024.12.0 HA installation: OS (Raspberry Pi4) Integration working: \u2705 Integration URL: `http://custom.freeboxos.fr/`\r\n> > > Good news! A workaround \ud83d\udc4d How to rename the hostname ?\r\n> > \r\n> > \r\n> > I personally removed the integration from HA, then re-added it with the custom hostname.\r\n> \r\n> What is your freebox and if you have the Delta do you use the alarm of the latter and does it work with HA?\r\n\r\nFreebox Revolution here, sorry :'( \n> Same here, i change value in file : .storage/core.config_entries\r\n> \r\n> replace xxxxxxxxxx.fbxos.fr by xxxxxxxxxxxx.freeboxos.fr ( 2 values changed in the line)\r\n> \r\n> And it's ok !\r\n> \r\n> HA version: 2024.12.0 HA installation: Proxmox / Docker Integration working: \u2705 Integration URL: http://custom.freeboxos.fr/ Freebox type: Freebox Delta\r\n\r\n@LiloBzH \r\nunfortunately I'm using a VMS on the Delta and I don't think I can access \".storage/core.config_entries\" or I don't know how to do it\nHA version: 2024.12.0\r\nHA installation: OS (Rpi 3B+)\r\nIntegration: working: \u274c\r\nIntegration URL: *.fbxos.fr`\r\n\r\nI tried to change the url but i did not found the .storage/core.config_entries on the file system, so i removed the integration and tried to add it again but impossible now : auto-discovery does not work, manual with xxx.fbxos.fr, or xxx.freeboxos.fr or mafreebox.freebox.fr does not work.\r\n\r\nExample for freeboxos.fr:\r\n``aiohttp.client_exceptions.ClientConnectorDNSError: Cannot connect to host xxxx.freeboxos.fr:1337 ssl:default [Domain name not found]``\r\n\r\nFreebox model : Pop\r\nThank you.\nHi there, \r\n\r\nI was using the following configuration :\r\n\r\n\r\nHA version: 2024.11.3\r\nHA installation: OS (Raspberry Pi4)\r\nIntegration: working: \u2705\r\nIntegration URL: *.fbxos.fr\r\nFreebox type: Freebox Delta\r\n\r\nAfter upgrading  :  \r\n\r\nHA version: 2024.12.0\r\nHA installation: OS (Raspberry Pi4)\r\nIntegration working: \u274c\r\nIntegration URL: *.fbxos.fr\r\nFreebox type: Freebox Delta\r\n\r\nFinally, after reading the whole topic :D I switched to this:\r\n\r\nHA version: 2024.12.0\r\nHA installation: OS (Raspberry Pi4)\r\nIntegration working: \u2705\r\nIntegration URL: http://custom.freeboxos.fr/\r\nFreebox type: Freebox Delta\r\n\r\n[EDIT] I had to delete the old entry and add manually the new one, not using the discovered Freebox\r\n\r\nI think this might be both:\r\n - a workaround if you consider using this plugin \"out-of-the-box\"\r\n - a solution if you see the `http://custom.freeboxos.fr/` as and advanced configuration setup.\r\nWhat do you think ? :) \r\n\r\nAnyway, thanks a lot for your work and the help as well.\r\n\r\nKindly\nHi, \r\nHA version:\r\nCore  2024.12.0\r\nSupervisor  2024.11.4\r\nOperating System  14.0\r\nInterface utilisateur  20241127.4\r\nHA installation: VM delta\r\nIntegration: working: \u274c\r\nIntegration URL: *.freeboxos.fr\r\n\r\nAfter removing freebox addon, restarting, and try to add it by discover option, same error. Even if i connect trough http://192.0.x.x or https://custom.freeboxos.fr. And of course no access to .storage\nHi,\r\n\r\nSorry but the workaround is not 100% clear for me...\r\n\r\nWith Freebox Revolution and HA 2024.12.0\r\nI removed the Integration (was using mafreebox.freebox.fr:443) but it stopped working after 2024.12.0\r\nSince i use HA OS i can't access \".storage/core.config_entries\"\r\n\r\nIt seems the workaround is to use \"http://custom.freeboxos.fr/\". \r\n\r\nBut:\r\n\r\n- `replace xxxxxxxxxx.fbxos.fr by xxxxxxxxxxxx.freeboxos.fr ( 2 values changed in the line)`\r\n=> changing the \"api_domain\" from https://mafreebox.freebox.fr/api_version => [whatever123].fbxos.fr\" to  [whatever123].freeboxos.fr :  [whatever123].freeboxos.fr does not resolve in my DNS (neither ipV4 or IPV6).\r\n\r\n- `custom.freeboxos.fr`\r\nI assumed it's the domain name found here:  \r\n![image](https://github.com/user-attachments/assets/3f52d804-6b7a-4166-b40f-d3eabbd68baf)\r\n\r\nBut trying in HA give an error.\r\n\r\n**So clearly what am i supposed to input into the Freebox integration \"H\u00f4te\" and \"Port\" ?** \r\nI mean : \r\nfor the \"H\u00f4te\":  is it \"http://mycustomdomain.freeboxos.fr\" or just \"mycustomdomain.freeboxos.fr\"\r\nfor the \"Port : Is it the 443 or the \"https_port\" reported by https://mafreebox.freebox.fr/api_version or...something else ?\r\n\r\nThere is obviously something i don't understand (sorry about that) :)\r\n\r\nThanks a lot :)\nHi,\r\nYou need to pur your somthing.freeboxos.fr and port 51073.\r\nIt\u2019s work for me\r\n\r\nLe ven. 6 d\u00e9c. 2024 \u00e0 13:56, Atarinside ***@***.***> a \u00e9crit :\r\n\r\n> Hi,\r\n>\r\n> Sorry but the workaround is not 100% clear for me...\r\n>\r\n> With Freebox Revolution and HA 2024.12.0\r\n> I removed the Integration (was using mafreebox.freebox.fr:443) but it\r\n> stopped working after 2024.12.0\r\n> Since i use HA OS i can't access \".storage/core.config_entries\"\r\n>\r\n> It seems the workaround is to use \"http://custom.freeboxos.fr/\".\r\n>\r\n> But:\r\n>\r\n>    -\r\n>\r\n>    replace xxxxxxxxxx.fbxos.fr by xxxxxxxxxxxx.freeboxos.fr ( 2 values\r\n>    changed in the line)\r\n>    => changing the \"api_domain\" from\r\n>    https://mafreebox.freebox.fr/api_version => [whatever123].fbxos.fr\" to\r\n>    [whatever123].freeboxos.fr : [whatever123].freeboxos.fr does not\r\n>    resolve in my DNS (neither ipV4 or IPV6).\r\n>    -\r\n>\r\n>    custom.freeboxos.fr\r\n>    I assumed it's the domain name found here:\r\n>    image.png (view on web)\r\n>    <https://github.com/user-attachments/assets/3f52d804-6b7a-4166-b40f-d3eabbd68baf>\r\n>\r\n> But trying in HA give an error.\r\n>\r\n> *So clearly what am i supposed to input into the Freebox integration\r\n> \"H\u00f4te\" and \"Port\" ?*\r\n> I mean :\r\n> for the \"H\u00f4te\": is it \"http://mycustomdomain.freeboxos.fr\" or just \"\r\n> mycustomdomain.freeboxos.fr\"\r\n> for the \"Port : Is it the 443 or the \"https_port\" reported by\r\n> https://mafreebox.freebox.fr/api_version or...something else ?\r\n>\r\n> There is obviously something i don't understand (sorry about that) :)\r\n>\r\n> Thanks a lot :)\r\n>\r\n> \u2014\r\n> Reply to this email directly, view it on GitHub\r\n> <https://github.com/home-assistant/core/issues/132333#issuecomment-2523192961>,\r\n> or unsubscribe\r\n> <https://github.com/notifications/unsubscribe-auth/BFK3TF2EU7OOB3DSNV7PC5D2EGNGLAVCNFSM6AAAAABTBYCIH2VHI2DSMVQWIX3LMV43OSLTON2WKQ3PNVWWK3TUHMZDKMRTGE4TEOJWGE>\r\n> .\r\n> You are receiving this because you commented.Message ID:\r\n> ***@***.***>\r\n>\r\n\nHi,\r\n\r\n\r\nThe port number is the one in HTTPS window\r\n\r\n![image](https://github.com/user-attachments/assets/70ebaeac-b367-480d-b035-98353284cc1b)\r\n\n> Hi,\r\n> \r\n> Sorry but the workaround is not 100% clear for me...\r\n> \r\n> With Freebox Revolution and HA 2024.12.0 I removed the Integration (was using mafreebox.freebox.fr:443) but it stopped working after 2024.12.0 Since i use HA OS i can't access \".storage/core.config_entries\"\r\n> \r\n> It seems the workaround is to use \"http://custom.freeboxos.fr/\".\r\n> \r\n> But:\r\n> \r\n> * `replace xxxxxxxxxx.fbxos.fr by xxxxxxxxxxxx.freeboxos.fr ( 2 values changed in the line)`\r\n>   => changing the \"api_domain\" from https://mafreebox.freebox.fr/api_version => [whatever123].fbxos.fr\" to  [whatever123].freeboxos.fr :  [whatever123].freeboxos.fr does not resolve in my DNS (neither ipV4 or IPV6).\r\n> * `custom.freeboxos.fr`\r\n>   I assumed it's the domain name found here:\r\n>   ![image](https://private-user-images.githubusercontent.com/84465576/393251347-3f52d804-6b7a-4166-b40f-d3eabbd68baf.png?jwt=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJnaXRodWIuY29tIiwiYXVkIjoicmF3LmdpdGh1YnVzZXJjb250ZW50LmNvbSIsImtleSI6ImtleTUiLCJleHAiOjE3MzM0OTEzMjcsIm5iZiI6MTczMzQ5MTAyNywicGF0aCI6Ii84NDQ2NTU3Ni8zOTMyNTEzNDctM2Y1MmQ4MDQtNmI3YS00MTY2LWI0MGYtZDNlYWJiZDY4YmFmLnBuZz9YLUFtei1BbGdvcml0aG09QVdTNC1ITUFDLVNIQTI1NiZYLUFtei1DcmVkZW50aWFsPUFLSUFWQ09EWUxTQTUzUFFLNFpBJTJGMjAyNDEyMDYlMkZ1cy1lYXN0LTElMkZzMyUyRmF3czRfcmVxdWVzdCZYLUFtei1EYXRlPTIwMjQxMjA2VDEzMTcwN1omWC1BbXotRXhwaXJlcz0zMDAmWC1BbXotU2lnbmF0dXJlPTdkNjI2ZmRiZjdmNmE4MjBhNDJlODg3Mjk1OGY4MzkwMWY2MWU2YjFiNWY2ZWNhNmEyNjdiZjdiMTQ1MzRlMzkmWC1BbXotU2lnbmVkSGVhZGVycz1ob3N0In0.1RrMhayRcHAEQvHPE3Lfz8DV9_1n2oBWfNkEJYCjaPY)\r\n> \r\n> But trying in HA give an error.\r\n> \r\n> **So clearly what am i supposed to input into the Freebox integration \"H\u00f4te\" and \"Port\" ?** I mean : for the \"H\u00f4te\": is it \"http://mycustomdomain.freeboxos.fr\" or just \"mycustomdomain.freeboxos.fr\" for the \"Port : Is it the 443 or the \"https_port\" reported by https://mafreebox.freebox.fr/api_version or...something else ?\r\n> \r\n> There is obviously something i don't understand (sorry about that) :)\r\n> \r\n> Thanks a lot :)\r\n\r\nI just did the test after deleting the Freebox integration.\r\nI created a domain xxxxx.freeboxos.fr from the mafreebox.free.fr interface and set it as default.\r\nI redid the Freebox integration manually in Ha and I put in the host xxxxx.freeboxos.fr and the external access port in https which is indicated in the access management. And this time I was able to validate the access on the Freebox and all the entities are uploaded in HA.\nI confirm as well that using the host as \"xxxxxx.freeboxos.fr\" is ok.\r\n\r\nA remark now maybe in a fix ? it should be better if we could use the mafreebox.freebox.fr or the locale IP of the freebox as it would not have to go outside network then go back inside. Maybe this is what it was already done when using xxx.fbxos.fr, but this is only now i notice that. But maybe the problem will be the same with the SSL check.\nThanks a lot folks \ud83e\udd47 I can confirm it's working now.\n> Workaround confirmed:\r\n> \r\n> HA version: 2024.12.0 HA installation: OS (Raspberry Pi4) Integration working: \u2705 Integration URL: `http://custom.freeboxos.fr/` Freebox type: Freebox Revolution\r\n> \r\n> > Good news! A workaround \ud83d\udc4d How to rename the hostname ?\r\n> \r\n> I personally removed the integration from HA, then re-added it with the custom hostname.\r\n\r\nI've did the same a now it works also for me. In addition I had to re-set a `device_tracker` which was no longer attached to the person.\r\n\r\nFor what I gather the auto discover is kinda broken?\r\n\r\nHA version: 2024.12.0\r\nHA installation: OS \r\nIntegration: working: \u2705\r\nIntegration URL:  *.iliadboxos.it\nWorkaround confirmed with manual integration\r\nVersion HA : 2024.12.0\r\nInstallation HA : OS\r\nInt\u00e9gration : fonctionne : \u2705\r\nURL d'int\u00e9gration : xxxxxx.freeboxos.fr\r\n\r\nThanks a lot\nI've tried the workaround and it's working.\r\n\r\n```\r\nHA version: 2024.12.0\r\nHA installation: OS (Raspberry Pi4)\r\nIntegration: working: \u2705\r\nIntegration URL: `mycostomdomain.freeboxos.fr:myport\r\n```\n+1\r\nAbsolutely same problem\r\n\r\n```\r\nFile \"/usr/local/lib/python3.13/site-packages/aiohttp/connector.py\", line 1118, in _wrap_create_connection\r\n    raise ClientConnectorCertificateError(req.connection_key, exc) from exc\r\naiohttp.client_exceptions.ClientConnectorCertificateError: Cannot connect to host XXXXXX.fbxos:XXX  ssl:True [SSLCertVerificationError: (1, '[SSL: CERTIFICATE_VERIFY_FAILED] certificate verify failed: Missing Authority Key Identifier (_ssl.c:1020)')]\r\n```\r\n\r\nBut SSL certificate is OK, and everything work well ...\r\nThanks for your responce\r\n\r\n\n> Good news! A workaround \ud83d\udc4d How to rename the hostname ?\r\n\r\nAdvanced settings > domain name > create a domain name\r\nI checked TLS certificat\n> > Good news! A workaround \ud83d\udc4d How to rename the hostname ?\r\n> \r\n> Advanced settings > domain name > create a domain name I checked TLS certificat\r\n\r\nthe same problem, i delete my domain name -> reboot freebox -> create new domain (same name) -> still here :'( \r\nWell, when i make config Freebox integration out from discovered - i'ts work - but, i have always notified what my freebox not configured ...\r\n\r\nAny suggestions\nHA version: 2024.12.0\r\nHA installation: OS (Home Assistant OS Generic aarch64)\r\nIntegration working: \u2705\r\nIntegration URL: http://xxxxx.freeboxos.fr/\r\nFreebox type: Freebox Delta\r\n\r\n\r\nUse the domain name that you had previously configured on your Freebox, activate https access and note the chosen port number.\r\nIf these steps had not been completed, do them (see the screenshots above).\r\n\r\nIf adding the integration still does not work, which was my case, it may be that there are traces of an old configuration (especially if you have not changed the domain name).\r\n\r\nDelete the *.conf files present in the \"rm /config/.storage/freebox/*.conf\" directory and restart the integration.\r\n\n> HA version: 2024.12.0 HA installation: OS (Home Assistant OS Generic aarch64) Integration working: \u2705 Integration URL: http://xxxxx.freeboxos.fr/ Freebox type: Freebox Delta\r\n> \r\n> Use the domain name that you had previously configured on your Freebox, activate https access and note the chosen port number. If these steps had not been completed, do them (see the screenshots above).\r\n> \r\n> If adding the integration still does not work, which was my case, it may be that there are traces of an old configuration (especially if you have not changed the domain name).\r\n> \r\n> Delete the _.conf files present in the \"rm /config/.storage/freebox/_.conf\" directory and restart the integration.\r\n\r\nWhen i'm update CORE to last version, the integration was BUG i i'm removed *.conf  i still the same problem ...\r\n\r\nSo what ?\r\n\nHi all,\r\n\r\nThanks a lot for your active support. I confirm it\u2019s working for me too\nThe workarround doesent work here:\r\nHA version: 2024.12.1 and  2024.12.0\r\nHA installation: Proxmox VM\r\nIntegration working: \u274c\r\nIntegration URL: xxxxx.freeboxos.fr and mafreebox.freebox.fr and local ip\r\nFreebox type: Freebox Delta\r\n\r\nIn log: Autorisation fail \"error_code\": \"denied_from_external_ip\r\n\r\nFinding another workaround for me beacause i have multi subnet and openmptrouter.\r\nSo i added a DNS entry for xxxxx.freeboxos.fr to my freebox local ip and its work !\r\n\r\nHA version: 2024.12.1\r\nHA installation: Proxmox VM\r\nIntegration working: \u2705\r\nIntegration URL: xxxxx.freeboxos.fr\r\nFreebox type: Freebox Delta\r\nand a custom DNS xxxxx.freeboxos.fr -> freebox local IP\nHi all !\n\nThanks for all you feedback (while I slept and worked \ud83d\ude05)\n\nIt just confirms the thought I had last night:\n\n- `[custom_name].freeboxos.fr` \u2705 : because of valid certificate by a trusted authority\n- `*.fbxos.fr` \u274c : because of self signed certificate\n- `mafreebox.freebox.fr` \u274c : because of self signed certificate\n\nSo, will I found a fix, you can:\n- \u26a0\ufe0f DO NOT USE DISCOVERY: as it use both `mafreebox.freebox.fr` to get info on your router, then use `*.fbxos.fr` for API connections.\n\n- Instead, please remove your previous configuration, then add the integration back manually. When the configuration is asking for host and IP, please add the host similar to `[custom_name].freeboxos.fr`\nDo not forget to reconfigure your device_tracker entities with your person entities and automations\n\n- \u2139\ufe0f Please note that `[custom_name].freeboxos.fr` needs to be configured into the FreeboxOS configuration panel. Go to \"Freebox settings\" -> \"Domain name\" (into the \"Internet connexion\" section) -> \"Add a new domain name\"\n\nIf you configured multiple subnet/VLANs, you are on your own on configuring that.\n\nDocumentation : https://www.home-assistant.io/integrations/freebox\n\nThanks you all !\nMerci \u00e0 tous !\n> Instead, please remove your previous configuration, then add the integration back manually. When the configuration is asking for host and IP, please add the host similar to `[custom_name].freeboxos.fr`\r\n> Do not forget to reconfigure your device_tracker entities with your person entities and automations\r\n\r\nI'd like to add (as other have already mentioned) that editing `/config/.storage/core.config_entries` has worked for me. It's definitely a file that you need to edit carefully. But it has allowed me to change the address of the existing integration, instead of removing and re-adding the integration.\r\n\r\nWhen using the Studio Code Server extension, press `Ctrl+P`, type `/config/.storage/core.config_entries`, then `Enter`. Then use the search tool to locate `fbxos.fr`. I only had to replace the `host` field with the new custom domain, not the two other fields. Once that's done, head over to `Developer tools` to make sure Home Assistant is happy about the configuration and restart. When the integration will start, the Freebox display will prompt for a new authentication.\r\n\r\nOh and I guess I should advice you to make a backup before doing all of that, otherwise I'm going to get yelled at.\r\n\r\nBon bricolage !\n> Salut tout le monde !\r\n> \r\n> Merci pour tous vos commentaires (pendant que je dormais et travaillais \ud83d\ude05)\r\n> \r\n> Cela ne fait que confirmer la pens\u00e9e que j'ai eue hier soir :\r\n> \r\n> * `[custom_name].freeboxos.fr`\u2705 : en raison d'un certificat valide d\u00e9livr\u00e9 par une autorit\u00e9 de confiance\r\n> * `*.fbxos.fr`\u274c : \u00e0 cause du certificat auto-sign\u00e9\r\n> * `mafreebox.freebox.fr`\u274c : \u00e0 cause du certificat auto-sign\u00e9\r\n> \r\n> Alors, si je trouve une solution, vous pouvez :\r\n> \r\n> * \u26a0\ufe0fN'UTILISEZ PAS DISCOVERY\u00a0: car il est utilis\u00e9 \u00e0 la fois `mafreebox.freebox.fr`pour obtenir des informations sur votre routeur, puis `*.fbxos.fr`pour les connexions API.\r\n> * Au lieu de cela, supprimez votre configuration pr\u00e9c\u00e9dente, puis rajoutez l'int\u00e9gration manuellement. Lorsque la configuration demande l'h\u00f4te et l'IP, veuillez ajouter l'h\u00f4te de la m\u00eame mani\u00e8re que `[custom_name].freeboxos.fr`\r\n>   N'oubliez pas de reconfigurer vos entit\u00e9s device_tracker avec vos entit\u00e9s personnelles et vos automatisations\r\n> * \u2139\ufe0f Attention, `[custom_name].freeboxos.fr`il faut configurer cela dans le panneau de configuration de FreeboxOS. Allez dans \u00ab Param\u00e8tres Freebox \u00bb -> \u00ab Nom de domaine \u00bb (dans la section \u00ab Connexion Internet \u00bb) -> \u00ab Ajouter un nouveau nom de domaine \u00bb\r\n> \r\n> Si vous avez configur\u00e9 plusieurs sous-r\u00e9seaux/VLAN, vous devez les configurer vous-m\u00eame.\r\n> \r\n> Documentation : https://www.home-assistant.io/integrations/freebox\r\n> \r\n> Merci \u00e0 tous ! Merci \u00e0 tous !\r\n\r\nHi and thanks for your feedback,\r\nIs this a temporary solution while you find a solution or will we no longer be able to go through the \"official integration\" and will we have to use this procedure?\r\nBy following your procedure, do you think that the Delta alarm and its sensors will be functional in the same way?\r\nThanks again for the hours spent!!! :-)\nHello\r\n\r\nI confirm that it works with my domain name. Thanks for sharing the solution.\n> Hi and thanks for your feedback, Is this a temporary solution while you find a solution or will we no longer be able to go through the \"official integration\" and will we have to use this procedure?\r\n\r\nYou may continue using this solution, even when a fix will be released. You improve security by using <custom domain>.freeboxos.fr because the certificate used is not self signed. It means it is verified by an authority.\r\n\r\n> By following your procedure, do you think that the Delta alarm and its sensors will be functional in the same way? Thanks again for the hours spent!!! :-)\r\n\r\nNo, there is no link between this issue and your issue with the alarm / sensors. \n> Hi all !\r\n> \r\n> Thanks for all you feedback (while I slept and worked \ud83d\ude05)\r\n> \r\n> It just confirms the thought I had last night:\r\n> \r\n> * `[custom_name].freeboxos.fr` \u2705 : because of valid certificate by a trusted authority\r\n> * `*.fbxos.fr` \u274c : because of self signed certificate\r\n> * `mafreebox.freebox.fr` \u274c : because of self signed certificate\r\n> \r\n> So, will I found a fix, you can:\r\n> \r\n> * \u26a0\ufe0f DO NOT USE DISCOVERY: as it use both `mafreebox.freebox.fr` to get info on your router, then use `*.fbxos.fr` for API connections.\r\n> * Instead, please remove your previous configuration, then add the integration back manually. When the configuration is asking for host and IP, please add the host similar to `[custom_name].freeboxos.fr`\r\n>   Do not forget to reconfigure your device_tracker entities with your person entities and automations\r\n> * \u2139\ufe0f Please note that `[custom_name].freeboxos.fr` needs to be configured into the FreeboxOS configuration panel. Go to \"Freebox settings\" -> \"Domain name\" (into the \"Internet connexion\" section) -> \"Add a new domain name\"\r\n> \r\n> If you configured multiple subnet/VLANs, you are on your own on configuring that.\r\n> \r\n> Documentation : https://www.home-assistant.io/integrations/freebox\r\n> \r\n> Thanks you all ! Merci \u00e0 tous !\r\n\r\nThanks a lot for this solution !\r\n\r\nFor whom wondering, it works like a charm with my own domain name (example.example.com) signed by let's encrypt through a reverse proxy.\nMany thanks to all for your contributions and I have access to my freebox and my alarm on the Delta again after following the procedure with my domain name xxx.freeboxos.fr\r\nPS: it makes me laugh to communicate with Gauls in English when the only ones concerned here are all French... :-)))\nHello,\r\n\r\nI also have the issue since I updated to Core v2024.12.1.\r\n\r\nAccording to the various answers here, the certificate served on the \"custom\" FQDN (which can be set on FreeboxOS at http://mafreebox.freebox.fr/#Fbx.os.app.settings.domains.Domains) should be used\r\n\r\nBut in my case:\r\n\r\n~~The \"custom\" FQDN serves me an expired self-signed certificate, the \"[cryptic].fbxos.fr\" serves the exact same certificate:~~\r\n\r\n```\r\n 0 s:C = AZ, ST = Some-State, O = Internet Widgits Pty Ltd, CN = foobar\r\n   i:C = AZ, ST = Some-State, O = Internet Widgits Pty Ltd, CN = foobar\r\n   a:PKEY: rsaEncryption, 4096 (bit); sigalg: RSA-SHA1\r\n   v:NotBefore: Jul 20 12:52:34 2014 GMT; NotAfter: Apr 15 12:52:34 2017 GMT\r\n```\r\n\r\nUpdate: I was requesting port 443, not the \"Port acc\u00e8s distant s\u00e9curis\u00e9 (HTTPS)\" (set at https://mafreebox.freebox.fr/#Fbx.os.app.settings.ConnectionConfig). With the correct port I get a valid Let's Encrypt signed certificate at both \"custom\" and \"[cryptic].fbxos.fr\" FQDN (but not the same certificate this time).\r\n\r\nAt \"mafreebox.freebox.fr\" I have a signed certificate, but not by a trusted authority.\r\n\r\n```\r\n 0 s:C = FR, CN = [cryptic].fbxos.fr\r\n   i:C = FR, ST = France, O = Freebox SA, CN = Freebox ECC Intermediate CA\r\n   a:PKEY: id-ecPublicKey, 256 (bit); sigalg: ecdsa-with-SHA256\r\n   v:NotBefore: Dec  6 11:26:34 2024 GMT; NotAfter: Mar  6 11:31:34 2025 GMT\r\n 1 s:C = FR, ST = France, O = Freebox SA, CN = Freebox ECC Intermediate CA\r\n   i:C = FR, ST = France, L = Paris, O = Freebox SA, CN = Freebox ECC Root CA\r\n   a:PKEY: id-ecPublicKey, 384 (bit); sigalg: ecdsa-with-SHA256\r\n   v:NotBefore: Sep 11 16:57:30 2024 GMT; NotAfter: Sep  9 16:57:30 2034 GMT\r\n```\r\n\r\nA workaround would be to add \"C = FR, ST = France, L = Paris, O = Freebox SA, CN = Freebox ECC Root CA\" to the list of trusted authorities right?\nHi,\r\nI did the workaround (define a subomain at freeboxos.fr to get a trusted TLS certificate) and it works.\r\nHowever, it seems that this is typically the kind of counter-productive security enforcement:\r\n- You now have to define an official subdomain, which will attrack many scanning bots trying to break the Freebow password\r\n- And that because you can't allow Home Assistant to access locally your Freebox (because of self-signed certificate)\r\n\r\nSo basically we are exposing an API that could be fully private to the whole word just because Home Assistant can no longer use a local not trusted TLS API...\r\nBest way would be to allow Python scripts to access local untrusted URL or trust the self signed certificate.\r\nAny chance for that?\r\nThanks,\r\nJean\n> So basically we are exposing an API that could be fully private to the whole word just because Home Assistant can no longer use a local not trusted TLS API... Best way would be to allow Python scripts to access local untrusted URL or trust the self signed certificate. Any chance for that? Thanks, Jean\r\n\r\nI have a preference for trusting Free's root CA (\"Freebox ECC Root CA\").\r\n\r\nMaybe it can be done with [hass-additional-ca](https://github.com/Athozs/hass-additional-ca)?\nhye, i managed to add  \r\nfreebox integration with :  \r\n- mafreebox.freebox.fr (http)\r\n- mafreebox6.freebox.fr (https) (because i have seen it in one off Dn in cert)\r\n- [custom_name].freeboxos.fr (next to previous comments recomandation)\r\n... but I still have a warning on the integration... because of the original settings on [ID].fbxos.fr that do not work anymore ...\r\nhow to remove it ?  \r\n\r\ni'm on a freebox vm with haos... I can access to system with freebox vm web-shell as root ... or in ha web-terminal  \r\n\r\n\r\n![image](https://github.com/user-attachments/assets/36d2fcb1-628d-477d-b0ef-76b7fd90233c)\r\n\r\n\nHi,\r\nI am super new in this issue.... I changed my freebox revolution for a new one (the first one died after 6 months)... and even the first step. i.e. to validate the application is not working (nothing is displayed on the Freebox)... Was also not detected in 2024.11.3 and of  with 2024.12.1... I of course activated everything that's was required...  \nHi, \r\n\r\nI have the same issue despite fallow each workaround.\r\nMy configuration is :\r\n\r\n- Version HA : 2024.12.1\r\n- Version Supervisor : 2024.11.4\r\n- Operating System : 14.0\r\n- Installation HA : VM on Freebox v7\r\n- Int\u00e9gration : fonctionne :  \u274c \r\n- URL d'int\u00e9gration : \r\n  - \u274c IP\r\n  - \u274c xxxxxx.freeboxos.fr (with certificat give by Let's Encrypt) \r\n  - \u274c xxxxxx.fbxos.fr (with certificat give by Freebox SA)\r\n\r\nI have remove Free integration and the folder \"/config/.storage/freeebox\", same issue.\r\nAfter installation of Free integration, i configure it with the different URL and i don't have a response on the FreeboxV7 for allow the connexion.\r\n\r\n\n> Hi,\r\n> \r\n> I have the same issue despite fallow each workaround. My configuration is :\r\n> \r\n> * Version HA : 2024.12.1\r\n> * Version Supervisor : 2024.11.4\r\n> * Operating System : 14.0\r\n> * Installation HA : VM on Freebox v7\r\n> * Int\u00e9gration : fonctionne :  \u274c\r\n> * URL d'int\u00e9gration :\r\n>   \r\n>   * \u274c IP\r\n>   * \u274c xxxxxx.freeboxos.fr (with certificat give by Let's Encrypt)\r\n>   * \u274c xxxxxx.fbxos.fr (with certificat give by Freebox SA)\r\n> \r\n> I have remove Free integration and the folder \"/config/.storage/freeebox\", same issue. After installation of Free integration, i configure it with the different URL and i don't have a response on the FreeboxV7 for allow the connexion.\r\n\r\nHi,\r\nI try again this morning and it work :)\r\n* Version HA : 2024.12.1\r\n* Version Supervisor : 2024.11.4\r\n* Operating System : 14.0\r\n* Installation HA : VM on Freebox v7\r\n* Int\u00e9gration : fonctionne :  \u2705\r\n* URL d'int\u00e9gration :\r\n   * \u274c IP   \r\n   * \u2705 xxxxxx.freeboxos.fr (with certificat give by Let's Encrypt)\r\n   * \u274c xxxxxx.fbxos.fr (with certificat give by Freebox SA)\r\n\r\nIs it possible to use API trought the LAN  instead WAN ?\nHello everyone,\r\n\r\ni tried the workaround on my end, but it does not work\r\ni'm reaching this state:\r\n\r\n![image](https://github.com/user-attachments/assets/00b648f0-6d4d-414e-9f9e-68f7a3fb3fbe)\r\n\r\nI put [custom].freeboxos.fr\r\ni tried port: 80,443,0 (default)\r\n\r\nNothing is working\r\n\r\nwhen i try to reach https://[custom].freeboxos.fr it does work and redirect me to my HA tho\r\n\r\nThanks for help!\n> Hello everyone,\r\n> \r\n> i tried the workaround on my end, but it does not work i'm reaching this state:\r\n> \r\n> ![image](https://private-user-images.githubusercontent.com/9402188/393591205-00b648f0-6d4d-414e-9f9e-68f7a3fb3fbe.png?jwt=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJnaXRodWIuY29tIiwiYXVkIjoicmF3LmdpdGh1YnVzZXJjb250ZW50LmNvbSIsImtleSI6ImtleTUiLCJleHAiOjE3MzM2NTc1MTEsIm5iZiI6MTczMzY1NzIxMSwicGF0aCI6Ii85NDAyMTg4LzM5MzU5MTIwNS0wMGI2NDhmMC02ZDRkLTQxNGUtOWY5ZS02OGY3YTNmYjNmYmUucG5nP1gtQW16LUFsZ29yaXRobT1BV1M0LUhNQUMtU0hBMjU2JlgtQW16LUNyZWRlbnRpYWw9QUtJQVZDT0RZTFNBNTNQUUs0WkElMkYyMDI0MTIwOCUyRnVzLWVhc3QtMSUyRnMzJTJGYXdzNF9yZXF1ZXN0JlgtQW16LURhdGU9MjAyNDEyMDhUMTEyNjUxWiZYLUFtei1FeHBpcmVzPTMwMCZYLUFtei1TaWduYXR1cmU9MjZmMGExZTJjNjBmMGY0NzM3NzE3NTdmOWU1NWYwYmIxZGExNTAyNmY2OWIxYjhhMjZjNjk1Mjc4ZmE4NmE1NyZYLUFtei1TaWduZWRIZWFkZXJzPWhvc3QifQ.0IsbI6yy9x0zh3GBexM2F5IqNdTTcJUAVDm4r-wqhVc)\r\n> \r\n> I put [custom].freeboxos.fr i tried port: 80,443,0 (default)\r\n> \r\n> Nothing is working\r\n> \r\n> when i try to reach https://[custom].freeboxos.fr it does work and redirect me to my HA tho\r\n> \r\n> Thanks for help!\r\n\r\nYou have to check your port set in the freebox settings for public access. Or check according the document of the integration, the call to the freebox API will give you your settings including the port.\n> Hello everyone,\r\n> \r\n> i tried the workaround on my end, but it does not work i'm reaching this state:\r\n> \r\n> \u2026\r\n> \r\n> I put [custom].freeboxos.fr i tried port: 80,443,0 (default)\r\n> \r\n> Nothing is working\r\n\r\nIf you already had authorized Home Assistant access to your Freebox prior to changing the integration's settings: try revoking/deleting it's access using FreeboxOS UI and retry integration configuration.\r\n\r\n(I suspect a username conflict between new authorization request and old/existing authorization)\r\n\r\n\r\n\nSorry for my dummy question, but where to change [custom].freeboxos.fr   ? in FreeOS ?\n> Sorry for my dummy question, but where to change [custom].freeboxos.fr ? in FreeOS ?\r\n\r\nHello,\r\n\r\nHere ;-)\r\n\r\n![Capture d\u2019\u00e9cran 2024-12-08 150135](https://github.com/user-attachments/assets/ec4aed87-02be-4889-b99e-dd01bd3a4c6d)\r\n\n> Sorry for my dummy question, but where to change [custom].freeboxos.fr ? in FreeOS ?\r\n\r\nHere: http://mafreebox.freebox.fr/#Fbx.os.app.settings.domains.Domains\nI don't know if I'm on the right track or not, but:\r\n\r\nupdated version of Core 2024.12.1 & Supervisor 2024.11.4 integration and (or) the whole HAOS almost coincided with the release of the new version of FreeboxOS (4.8.17.1), so, in the new version of FreeboxOS it is indicated that the transition to the API version was made (Api changes from version 1.1 to 2.0) [https://mediaelf.freeboxos.fr:5001/#Fbx.os.app.help.app](https://mediaelf.freeboxos.fr:5001/#Fbx.os.app.help.app) \r\nand in the manifest file:\r\n [https://github.com/home-assistant/core/blob/dev/homeassistant/components/freebox/manifest.json](https://github.com/home-assistant/core/blob/dev/homeassistant/components/freebox/manifest.json) \r\nthe following \"requirements\" are indicated: [\"freebox-api==1.1.0\"],\r\n\r\nMaybe this is the problem? No ?\nSecond freebox delta fixed with the workaround with custom domain in .freeboxos.fr\r\n\r\nYou can still use your local ip by adding this line in your \"/etc/host\" of your home assistant :\r\nexample:\r\n192.168.1.10  mycustomdomain.freeboxos.fr\r\n\r\nThat's usefull for some network configuration (vpn, mptcp...)\r\n\r\nThanks a lot for the fisrt who found the workaroud !\r\n\r\nDeuxi\u00e8me acc\u00e9s \u00e0 une freebox delta r\u00e9par\u00e9 grace \u00e0 la solution de contournement en utilisant le domaine personals\u00e9 en freeboxos.fr.\r\nIl est possible de continuer \u00e0 utilser l'ip local en \u00e9ditant le fichier host situ\u00e9 dans \"/etc/host\" de votre installation home assistant\r\nexample:\r\n192.168.1.10  mondomaineamoi.freeboxos.fr\r\nCela peut etre utile sur certaines installation r\u00e9seau (vpn, mptcp...)\r\nMerci encore au premier qui a trouv\u00e9 la solution de contournement.\nProbably a stupid question, but why is http not supported by the `freebox` integration (which would work around the problem) ? It seems that the API responds on 192.168.1.254:80.\r\n\r\nAlso, having to reach the public IP to reach the freebox sounds like a bad idea: in case of outage, doesn't that mean that HA cannot reach the freebox anymore ? To me, you MUST target the internal IP or any outage will cause havoc...\r\n\r\n> You can still use your local ip by adding this line in your \"/etc/host\" of your home assistant : example: 192.168.1.10 mycustomdomain.freeboxos.fr\r\n\r\nFor those who, like me, are using a vanilla HA OS (meaning no access to the `/etc/hosts` file), i used my AdGuard Home add-on to resolve `mycustomdomain.freeboxos.fr` to `192.168.1.254`.\r\n\r\nTo sum up, what really worked for me:\r\n- remove previous integration\r\n- add a custom domain `mycustomdomain.freeboxos.fr` with let's encrypt certificate using http://mafreebox.freebox.fr/#Fbx.os.app.settings.domains.Domains \r\n- add static DNS resolution for `mycustomdomain.freeboxos.fr` to `192.168.1.254`\r\n- add a new freebox integration manually with host `mycustomdomain.freeboxos.fr` and port `443`\r\n- ignore the auto-detected freebox device\nI have this is issue but no ssl certificat on my custom domain (ovh), i'm working to have it.\r\nPerahps somebody can tell me where put key on freeboxos ?\nHello,\nSo I have several questions if I understood correctly mafreebox.free.fr no longer works and if I understood correctly you have to create a custom domain name. But so those who have the box set to Bridge how do they do it because the ports are closed on the box \ud83e\udd14\nHi, https://github.com/hacf-fr/freebox-api/pull/737 seems to close this issue, as this is the same workaround suggested by other Python projects (like https://github.com/elastic/elasticsearch-py/issues/2716). This is a better workaround than creating a hostname for the Freebox and tinkering with local DNS records IMO\n@SamyDjemai it says doesn't work for the freebox integration\n> @SamyDjemai it says doesn't work for the freebox integration\r\n\r\nwhich is based on hacf-fr/freebox-api according to [the integration's manifest](https://github.com/home-assistant/core/blob/dev/homeassistant/components/freebox/manifest.json#L10). A new `freebox-api` release should be created, then the manifest should be updated to use the new release, and the issue should be solved\n> > @SamyDjemai it says doesn't work for the freebox integration\r\n> \r\n> which is based on hacf-fr/freebox-api according to [the integration's manifest](https://github.com/home-assistant/core/blob/dev/homeassistant/components/freebox/manifest.json#L10). A new `freebox-api` release should be created, then the manifest should be updated to use the new release, and the issue should be solved\r\n\r\n@SamyDjemai thats exactly what i wrote just few posts ago \n> Hello everyone,\r\n> \r\n> i tried the workaround on my end, but it does not work i'm reaching this state:\r\n> \r\n> ![image](https://private-user-images.githubusercontent.com/9402188/393591205-00b648f0-6d4d-414e-9f9e-68f7a3fb3fbe.png?jwt=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJnaXRodWIuY29tIiwiYXVkIjoicmF3LmdpdGh1YnVzZXJjb250ZW50LmNvbSIsImtleSI6ImtleTUiLCJleHAiOjE3MzM4NjMwNjksIm5iZiI6MTczMzg2Mjc2OSwicGF0aCI6Ii85NDAyMTg4LzM5MzU5MTIwNS0wMGI2NDhmMC02ZDRkLTQxNGUtOWY5ZS02OGY3YTNmYjNmYmUucG5nP1gtQW16LUFsZ29yaXRobT1BV1M0LUhNQUMtU0hBMjU2JlgtQW16LUNyZWRlbnRpYWw9QUtJQVZDT0RZTFNBNTNQUUs0WkElMkYyMDI0MTIxMCUyRnVzLWVhc3QtMSUyRnMzJTJGYXdzNF9yZXF1ZXN0JlgtQW16LURhdGU9MjAyNDEyMTBUMjAzMjQ5WiZYLUFtei1FeHBpcmVzPTMwMCZYLUFtei1TaWduYXR1cmU9YmEyOWU5MzcwZTEzNmQyMGY3YWM1ZjA0MTNlNWMxYTlmNzMxNWNiZjNiYTg2MWU0NmE5MDM4OWUwODYxODVkNyZYLUFtei1TaWduZWRIZWFkZXJzPWhvc3QifQ.Qhbrcm3fP1qDWNrkBwKlR8rE3hd7j6EHFwoxPjX6aJo)\r\n> \r\n> I put [custom].freeboxos.fr i tried port: 80,443,0 (default)\r\n> \r\n> Nothing is working\r\n> \r\n> when i try to reach https://[custom].freeboxos.fr it does work and redirect me to my HA tho\r\n> \r\n> Thanks for help!\r\n\r\nSalut,\r\nJ'ai pareil, le message ne s'affiche pas sur ma box tu as r\u00e9ussi au finale ?\r\nLe souci c'est que chez moi le 443 et redirig\u00e9 vers mon Nas donc pas vers la freebox. \n> > > @SamyDjemai it says doesn't work for the freebox integration\r\n> > \r\n> > \r\n> > which is based on hacf-fr/freebox-api according to [the integration's manifest](https://github.com/home-assistant/core/blob/dev/homeassistant/components/freebox/manifest.json#L10). A new `freebox-api` release should be created, then the manifest should be updated to use the new release, and the issue should be solved\r\n> \r\n> @SamyDjemai thats exactly what i wrote just few posts ago\r\n\r\nNot exactly. The `freebox-api` Python package is not provided by Free themselves, it is a community package maintained by @Quentame. The issue here is only due to a new default flag in Python 3.13 which HA was just upgraded to that blocks non-strictly X.509-compliant certificates.\r\n\r\nOn my Freebox, when going to http://mafreebox.freebox.fr/api_version, I see `\"api_version\":\"12.2\"`, however the provided documentation says `Current API version is \u201c5.0\u201d` :thinking: not sure what's going on with versioning at Free\nAs a (not very pretty) workaround, I've completely disabled certificate verification.\r\nIn src/freebox_api/aiofreepybox.py :        \r\n```\r\n        cert_path = os.path.join(os.path.dirname(__file__), \u201cfreebox_certificates.pem\u201d)\r\n        ssl_ctx = ssl.create_default_context()\r\n        ssl_ctx.load_verify_locations(cafile=cert_path)\r\n+     ssl_ctx.check_hostname = False\r\n+     ssl_ctx.verify_mode = ssl.CERT_NONE\r\n\r\n        conn = aiohttp.TCPConnector(ssl_context=ssl_ctx)\r\n        self._session = aiohttp.ClientSession(connector=conn)\r\n```\n> Hi, [hacf-fr/freebox-api#737](https://github.com/hacf-fr/freebox-api/pull/737) seems to close this issue, as this is the same workaround suggested by other Python projects (like [elastic/elasticsearch-py#2716](https://github.com/elastic/elasticsearch-py/issues/2716)). This is a better workaround than creating a hostname for the Freebox and tinkering with local DNS records IMO\r\n\r\nAfter editing `src/freebox_api/aiofreepybox.py` on my setup based on the PR contents and restarting Home Assistant, I can confirm that the integration works properly.\nwell apparently everyone has managed to reconnect their Freebox and now I have another problem, now that mine is working perfectly again, I would like to add a second Freebox to my home assistant and of course it is outside my home, I have tried a lot of things but no success so far. I tried with xxx.freeboxos.fr, in http, in https, with the remote and secure access ports and nothing.... it is a V6, I connect to the HA which is at home on my Delta and nothing, nothing is displayed on the V6 to validate the authorization. I know that some have been able to do it but I can't find the solution, maybe a port redirection on the V6 or the Delta.... ???\n> As a (not very pretty) workaround, I've completely disabled certificate verification. In src/freebox_api/aiofreepybox.py :\r\n> \r\n> ```\r\n>         cert_path = os.path.join(os.path.dirname(__file__), \u201cfreebox_certificates.pem\u201d)\r\n>         ssl_ctx = ssl.create_default_context()\r\n>         ssl_ctx.load_verify_locations(cafile=cert_path)\r\n> +     ssl_ctx.check_hostname = False\r\n> +     ssl_ctx.verify_mode = ssl.CERT_NONE\r\n> \r\n>         conn = aiohttp.TCPConnector(ssl_context=ssl_ctx)\r\n>         self._session = aiohttp.ClientSession(connector=conn)\r\n> ```\r\n\r\nCan you explain to me how to put the patch or edit?\r\n\r\nI don't know how I should do it.\n> > As a (not very pretty) workaround, I've completely disabled certificate verification. In src/freebox_api/aiofreepybox.py :\r\n> > ```\r\n> >         cert_path = os.path.join(os.path.dirname(__file__), \u201cfreebox_certificates.pem\u201d)\r\n> >         ssl_ctx = ssl.create_default_context()\r\n> >         ssl_ctx.load_verify_locations(cafile=cert_path)\r\n> > +     ssl_ctx.check_hostname = False\r\n> > +     ssl_ctx.verify_mode = ssl.CERT_NONE\r\n> > \r\n> >         conn = aiohttp.TCPConnector(ssl_context=ssl_ctx)\r\n> >         self._session = aiohttp.ClientSession(connector=conn)\r\n> > ```\r\n> \r\n> Can you explain to me how to put the patch or edit?\r\n> \r\n> I don't know how I should do it.\r\n\r\nHi,\r\nLike you, i want to know how can i disable these 2 likes.\r\nThanks \nHi @Quentame \r\nI managed to add this integration, but doing the same thing, I can't add the https://github.com/gvigroux/freebox_home integration. It seems that this integration has been abandoned, in any case, it will not pass the 2025.01 update. Is it possible to add the specific access of the freebox V7 (delta) for the shutters, camera, alarm system to your integration please.\n\r\n\r\n\r\n> Salut@Quentame J'ai r\u00e9ussi \u00e0 ajouter cette int\u00e9gration, mais en faisant la m\u00eame chose, je n'arrive pas \u00e0 ajouter l'int\u00e9gration https://github.com/gvigroux/freebox_home . Il semble que cette int\u00e9gration ait \u00e9t\u00e9 abandonn\u00e9e, en tout cas, elle ne passera pas la mise \u00e0 jour 2025.01. Est-il possible d'ajouter l'acc\u00e8s sp\u00e9cifique de la freebox V7 (delta) pour les volets, la cam\u00e9ra, le syst\u00e8me d'alarme \u00e0 votre int\u00e9gration svp.\r\n\r\nBonjour, \u00e0 ma connaissance seuls les volets ne sont h\u00e9las pas g\u00e9r\u00e9s pas l'int\u00e9gration officiel Freebox.\n\r\n\r\n\r\n> > Bonjour, [hacf-fr/freebox-api#737](https://github.com/hacf-fr/freebox-api/pull/737) semble r\u00e9soudre ce probl\u00e8me, car il s'agit de la m\u00eame solution de contournement sugg\u00e9r\u00e9e par d'autres projets Python (comme [elastic/elasticsearch-py#2716](https://github.com/elastic/elasticsearch-py/issues/2716) ). C'est une meilleure solution de contournement qui permet de cr\u00e9er un nom d'h\u00f4te pour la Freebox et de bricoler avec les enregistrements DNS locaux \u00e0 mon avis\r\n> \r\n> Apr\u00e8s avoir modifi\u00e9 `src/freebox_api/aiofreepybox.py`ma configuration en fonction du contenu du PR et red\u00e9marr\u00e9 Home Assistant, je peux confirmer que l'int\u00e9gration fonctionne correctement.\r\n\r\nBonjour, Je n'arrive pas \u00e0 trouver le fichier aiofreepybox.py dans l'arborescence de HA. Merci pour une petite aide\r\n \nc'est justement ce dont j'ai besoin ;)\n> Hi @Quentame I managed to add this integration, but doing the same thing, I can't add the https://github.com/gvigroux/freebox_home integration. It seems that this integration has been abandoned, in any case, it will not pass the 2025.01 update. Is it possible to add the specific access of the freebox V7 (delta) for the shutters, camera, alarm system to your integration please.\r\n\r\nAvec un domaine freebox dont le certificat est valide, logiquement tout type de volet est support\u00e9.\r\nhttps://github.com/echauvet/freebox_home\r\n\n> Hi @Quentame I managed to add this integration, but doing the same thing, I can't add the https://github.com/gvigroux/freebox_home integration. It seems that this integration has been abandoned, in any case, it will not pass the 2025.01 update. Is it possible to add the specific access of the freebox V7 (delta) for the shutters, camera, alarm system to your integration please.\r\n\r\nPourtant avec exactement les m\u00eames informations que cette int\u00e9gration, cela fonctionne pour celle de gvigroux. Cela a fonctionn\u00e9 pour moi sans probl\u00e8me. Si tu as une erreur alors que ton nom de domaine est bon, c'est le port qui n'est pas bon, comme je te l'ai dis sur l'autre topic \n> > > Bonjour, [hacf-fr/freebox-api#737](https://github.com/hacf-fr/freebox-api/pull/737) semble r\u00e9soudre ce probl\u00e8me, car il s'agit de la m\u00eame solution de contournement sugg\u00e9r\u00e9e par d'autres projets Python (comme [elastic/elasticsearch-py#2716](https://github.com/elastic/elasticsearch-py/issues/2716) ). C'est une meilleure solution de contournement qui permet de cr\u00e9er un nom d'h\u00f4te pour la Freebox et de bricoler avec les enregistrements DNS locaux \u00e0 mon avis\r\n> > \r\n> > \r\n> > Apr\u00e8s avoir modifi\u00e9 `src/freebox_api/aiofreepybox.py`ma configuration en fonction du contenu du PR et red\u00e9marr\u00e9 Home Assistant, je peux confirmer que l'int\u00e9gration fonctionne correctement.\r\n> \r\n> Bonjour, Je n'arrive pas \u00e0 trouver le fichier aiofreepybox.py dans l'arborescence de HA. Merci pour une petite aide\r\n\r\nHello, cela d\u00e9pend de ton installation, mais dans mon install Docker j'ai pu trouver le fichier dans le container dans `/usr/local/lib/python3.13/site-packages/freebox_api/` :)\nHello. Any ideas on which version of HA this fix is going to be released?\r\nI have an alarm system on my Delta that I manage via HomeAssistant and automations. And since this issue happened I have to remember to set my alarm manually again. not ideal with my capacity to forget \ud83d\ude05\r\n\r\nI tried the manual fix but could not find where this file is located in my case (VM of HomeAssistant on Delta)\nin the end i was able to find where this file was situated with the command:\r\n`find / -type d -name 'freebox_api'`\r\n\r\nit found it on a a few different paths\r\n\r\n`/var/lib/docker/overlay2/alongstringofhexa/diff/usr/local/lib/python3.13/site-packages/freebox_api`\r\nor\r\n`/var/lib/docker/overlay2/anotherlongstringofhexa/merged/usr/local/lib/python3.13/site-packages/freebox_api`\r\n\r\nI modified the file on the paths i could find aiofreepybox.py file (in my case in two out of the 3 paths the find command had fetched)\r\nRestarted HomeAssistant and now freebox integration works again.\n`find / -name 'aiofreepybox.py'` might be just as efficient to find the location(s) of the file to modify ;-)\nUne solution pour \u00e9viter de passer par un nom freeboxos et ouvrir les ports ( il faut pouvoir manipuler vos DNS, pihole, unbound etc etc) : \r\n\r\n1: Cr\u00e9er un certificat SSL autosign\u00e9 par exemple avec : https://fr.rakko.tools/tools/46/\r\n\r\n2: Ajouter le nom de domaine personnalis\u00e9 dans FreeboxOS et importer le certificat cr\u00e9\u00e9.\r\n\r\n![Sans titre2](https://github.com/user-attachments/assets/a7dc11aa-3ef0-4bf2-8b6d-755a2ec6af02)\r\n\r\n3: Installer [hass-additional-ca](https://github.com/Athozs/hass-additional-ca) avec HACS ou manuellement.\r\n(La premi\u00e8re fois j'ai eu une erreur \u00e0 l'initialisation, j'ai du modifier la ligne 35 du fichier init.py comme ceci : \r\n`config_path = \"/config/custom_components/additional_ca\"`)\r\n\r\n4: Importer le certificat dans le dossier d'additional_ca.\r\n\r\n5: Suivre les instruction d'additional_ca pour prendre en compte votre certificat dans votre fichier `configuration.yaml`.\r\n\r\n6: Cr\u00e9er un enregistrement DNS A sur l'ip : `212.27.38.253` ou CNAME sur `mafreebox.freebox.fr`\r\n\r\n7: Reboot HA\r\n\r\n8: Ajout de la Freebox sur HA en utilisant votre nom de domaine personnalis\u00e9 sur le port 443.\r\n\r\n![Sans titre](https://github.com/user-attachments/assets/f34bc41c-c696-4c22-98b7-4fb7a9117d1a)\r\n\r\nNormalement \u00e7a devrait fonctionner, avec un certificat valide 10 ans on est tranquille et pas besoin d'ouvrir son port vers l'ext\u00e9rieure et de cr\u00e9er un nom de domaine freeboxos. \n> As a (not very pretty) workaround, I've completely disabled certificate verification. In src/freebox_api/aiofreepybox.py :\r\n> \r\n> ```\r\n>         cert_path = os.path.join(os.path.dirname(__file__), \u201cfreebox_certificates.pem\u201d)\r\n>         ssl_ctx = ssl.create_default_context()\r\n>         ssl_ctx.load_verify_locations(cafile=cert_path)\r\n> +     ssl_ctx.check_hostname = False\r\n> +     ssl_ctx.verify_mode = ssl.CERT_NONE\r\n> \r\n>         conn = aiohttp.TCPConnector(ssl_context=ssl_ctx)\r\n>         self._session = aiohttp.ClientSession(connector=conn)\r\n> ```\r\n\r\nSalut, Je suis connect\u00e9 en WinSCP mais impossible de trouv\u00e9 le dossier ou le fichier que tu mentionne. Je suis avec une VM sous Promox tu serait me dire le dossier racine ? Merci\n> > As a (not very pretty) workaround, I've completely disabled certificate verification. In src/freebox_api/aiofreepybox.py :\r\n> > ```\r\n> >         cert_path = os.path.join(os.path.dirname(__file__), \u201cfreebox_certificates.pem\u201d)\r\n> >         ssl_ctx = ssl.create_default_context()\r\n> >         ssl_ctx.load_verify_locations(cafile=cert_path)\r\n> > +     ssl_ctx.check_hostname = False\r\n> > +     ssl_ctx.verify_mode = ssl.CERT_NONE\r\n> > \r\n> >         conn = aiohttp.TCPConnector(ssl_context=ssl_ctx)\r\n> >         self._session = aiohttp.ClientSession(connector=conn)\r\n> > ```\r\n> \r\n> Salut, Je suis connect\u00e9 en WinSCP mais impossible de trouv\u00e9 le dossier ou le fichier que tu mentionne. Je suis avec une VM sous Promox tu serait me dire le dossier racine ? Merci\r\n\r\nPareil introuvable\n> > > As a (not very pretty) workaround, I've completely disabled certificate verification. In src/freebox_api/aiofreepybox.py :\r\n> > > ```\r\n> > >         cert_path = os.path.join(os.path.dirname(__file__), \u201cfreebox_certificates.pem\u201d)\r\n> > >         ssl_ctx = ssl.create_default_context()\r\n> > >         ssl_ctx.load_verify_locations(cafile=cert_path)\r\n> > > +     ssl_ctx.check_hostname = False\r\n> > > +     ssl_ctx.verify_mode = ssl.CERT_NONE\r\n> > > \r\n> > >         conn = aiohttp.TCPConnector(ssl_context=ssl_ctx)\r\n> > >         self._session = aiohttp.ClientSession(connector=conn)\r\n> > > ```\r\n> > \r\n> > \r\n> > Salut, Je suis connect\u00e9 en WinSCP mais impossible de trouv\u00e9 le dossier ou le fichier que tu mentionne. Je suis avec une VM sous Promox tu serait me dire le dossier racine ? Merci\r\n> \r\n> Pareil introuvable\r\n\r\nUsing Docker image: **ghcr.io/home-assistant/home-assistant:2024.12.2**\r\n\r\nfile path is:\r\n/usr/local/lib/python3.13/site-packages/freebox_api/aiofreepybox.py\nBonsoir\r\nJ'ai HA qui tourne sur une VM sur ma Delta. Dans l'interface FreeboxOs, j'ai ouvert le fen\u00eatre des VM, et ouvert un terminal sur la VM HA.\r\nJe me suis connect\u00e9 en root, puis j'ai pass\u00e9 la commande \"find / -name aiofreepybox.py\"\r\nJ'ai obtenu une liste de 4 fichiers, 2 dans le r\u00e9pertoire /mnt et 2 autres dans le r\u00e9pertoire /var.\r\n-  /var/lib/docker/overlay2/........../diff/usr/local/lib/python3.13/site-packages/freebox_api/aiofreepybox.py\r\n-  /var/lib/docker/overlay2/.........../merged/usr/local/lib/python3.13/site-packages/freebox_api/aiofreepybox.py\r\n\r\nAvec vi, j'ai \u00e9dit\u00e9 le premier et ajout\u00e9 les 2 lignes\r\n>       ssl_ctx.check_hostname = False\r\n>       ssl_ctx.verify_mode = ssl.CERT_NONE\r\njuste apr\u00e8s la ligne \"...load_verify_locations\" et en respectant l'indentation de la ligne au-dessus.\r\n\r\nJ'ai sauvegard\u00e9 et quand j'ai voulu faire la m\u00eame chose avec le second fichier, il avait d\u00e9j\u00e0 \u00e9t\u00e9 modifi\u00e9. Il y a probablement un lien symbolique entre les 2 mais je n'ai pas vu l'info...\r\nJ'ai ensuite red\u00e9marr\u00e9 HA et les infos de ma freebox sont redevenues disponibles...... jusqu'\u00e0 ce que je fasse une mise \u00e0 jour de HA Core qui a \u00e9cras\u00e9 mes modifs :(\n> Une solution pour \u00e9viter de passer par un nom freeboxos et ouvrir les ports ( il faut pouvoir manipuler vos DNS, pihole, unbound etc etc) :\r\n> \r\n> 1: Cr\u00e9er un certificat SSL autosign\u00e9 par exemple avec : https://fr.rakko.tools/tools/46/\r\n> \r\n> 2: Ajouter le nom de domaine personnalis\u00e9 dans FreeboxOS et importer le certificat cr\u00e9\u00e9.\r\n> \r\n> ![Sans titre2](https://private-user-images.githubusercontent.com/25287809/395643679-a7dc11aa-3ef0-4bf2-8b6d-755a2ec6af02.png?jwt=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJnaXRodWIuY29tIiwiYXVkIjoicmF3LmdpdGh1YnVzZXJjb250ZW50LmNvbSIsImtleSI6ImtleTUiLCJleHAiOjE3MzQxMjkzODAsIm5iZiI6MTczNDEyOTA4MCwicGF0aCI6Ii8yNTI4NzgwOS8zOTU2NDM2NzktYTdkYzExYWEtM2VmMC00YmYyLThiNmQtNzU1YTJlYzZhZjAyLnBuZz9YLUFtei1BbGdvcml0aG09QVdTNC1ITUFDLVNIQTI1NiZYLUFtei1DcmVkZW50aWFsPUFLSUFWQ09EWUxTQTUzUFFLNFpBJTJGMjAyNDEyMTMlMkZ1cy1lYXN0LTElMkZzMyUyRmF3czRfcmVxdWVzdCZYLUFtei1EYXRlPTIwMjQxMjEzVDIyMzEyMFomWC1BbXotRXhwaXJlcz0zMDAmWC1BbXotU2lnbmF0dXJlPTFiMjM4OTRkN2NiOGFmZTYwZmUzNjU5Njg1NTViMDk4N2NkMDI1YWE0M2M2ODZhNzIyNDE3NjNhYWI0MjVhYzYmWC1BbXotU2lnbmVkSGVhZGVycz1ob3N0In0.zl-elbvgbo709WO_9QQGLxDtWU8_2GZkMe0j1Sv11xI)\r\n> \r\n> 3: Installer [hass-additional-ca](https://github.com/Athozs/hass-additional-ca) avec HACS ou manuellement. (La premi\u00e8re fois j'ai eu une erreur \u00e0 l'initialisation, j'ai du modifier la ligne 35 du fichier init.py comme ceci : `config_path = \"/config/custom_components/additional_ca\"`)\r\n> \r\n> 4: Importer le certificat dans le dossier d'additional_ca.\r\n> \r\n> 5: Suivre les instruction d'additional_ca pour prendre en compte votre certificat dans votre fichier `configuration.yaml`.\r\n> \r\n> 6: Cr\u00e9er un enregistrement DNS A sur l'ip : `212.27.38.253` ou CNAME sur `mafreebox.freebox.fr`\r\n> \r\n> 7: Reboot HA\r\n> \r\n> 8: Ajout de la Freebox sur HA en utilisant votre nom de domaine personnalis\u00e9 sur le port 443.\r\n> \r\n> ![Sans titre](https://private-user-images.githubusercontent.com/25287809/395642369-f34bc41c-c696-4c22-98b7-4fb7a9117d1a.png?jwt=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJnaXRodWIuY29tIiwiYXVkIjoicmF3LmdpdGh1YnVzZXJjb250ZW50LmNvbSIsImtleSI6ImtleTUiLCJleHAiOjE3MzQxMjkzODAsIm5iZiI6MTczNDEyOTA4MCwicGF0aCI6Ii8yNTI4NzgwOS8zOTU2NDIzNjktZjM0YmM0MWMtYzY5Ni00YzIyLTk4YjctNGZiN2E5MTE3ZDFhLnBuZz9YLUFtei1BbGdvcml0aG09QVdTNC1ITUFDLVNIQTI1NiZYLUFtei1DcmVkZW50aWFsPUFLSUFWQ09EWUxTQTUzUFFLNFpBJTJGMjAyNDEyMTMlMkZ1cy1lYXN0LTElMkZzMyUyRmF3czRfcmVxdWVzdCZYLUFtei1EYXRlPTIwMjQxMjEzVDIyMzEyMFomWC1BbXotRXhwaXJlcz0zMDAmWC1BbXotU2lnbmF0dXJlPTBkMzE4ZWQzOTRmM2M2MzMwOTk4M2ViODc4OTgzY2MzZGI2YWI2MDA3YWMyYzBhMGE2N2ZiZDc1MWE0OGY0N2EmWC1BbXotU2lnbmVkSGVhZGVycz1ob3N0In0.JbDE9zxVc7Bbos0o9NlOacP4FZuJ93ABLnOD5OoZCgM)\r\n> \r\n> Normalement \u00e7a devrait fonctionner, avec un certificat valide 10 ans on est tranquille et pas besoin d'ouvrir son port vers l'ext\u00e9rieure et de cr\u00e9er un nom de domaine freeboxos.\r\n\r\nMerci pour cette solution qui fonctionne bien pour moi.\r\n\r\nJ'ai voulu faire la modif du fichier pour d\u00e9sactiver le check ssl, mais \u00e0 priori on n'a pas acc\u00e8s au fichier aiofreepybox.py en HAOS... (o\u00f9 alors je ne l'ai pas trouv\u00e9...)\n> Un petit `find / -name freebox_api -type d` aidera \u00e0 trouver le bon chemin ;-)\r\n\r\nMerci pour votre aide. J'avais d\u00e9ja avant de vous solliciter fait une recherche de ce genre sans succ\u00e8s. Je suis sur HAos et je ne doit pas avoir la m\u00eame arborescence que sur d'autres configs. J'ai finalement solutionn\u00e9 en ajoutant un nom de domaine freeboxos en virant puis en r\u00e9installant  l'int\u00e9gration Freebox puis remis au go\u00fbt du jour toutes mes entit\u00e9s dans mon tbd, scripts et automatisations....\n@Dede29AZ : je suis comme toi sur HA OS et 'ai d\u00e9j\u00e0 un nom de domaine perso en freeboxos.fr avec un certificat valide ! \r\nMAIS quand je tente de r\u00e9installer l'int\u00e9gration, il tente de se connecter pxxxx.fbxos.fr \r\ncomment fais-tu pour qu'il tente de se connecter \u00e0 ton domaine perso et pas au domaine fbxos.fr stp ?\n@Dede29AZ  : j'ai trouv\u00e9 \ud83d\udc4d en fait je ne laisse pas l'int\u00e9gration d\u00e9couvrir ma Freebox mais je l'ajoute en pr\u00e9cisant le host - donc c'est bon pour moi aussi\r\n\r\nmais en fait ce probl\u00e8me a mon avis (et je n'ai pas lu tous les commentaires de bug) n'est pas li\u00e9 \u00e0 l'int\u00e9gration mais au fait que free n'est plus de certificat valide pour les noms fbxos.fr \r\n\n> Une solution pour \u00e9viter de passer par un nom freeboxos et ouvrir les ports ( il faut pouvoir manipuler vos DNS, pihole, unbound etc etc) :\r\n> \r\n> 1: Cr\u00e9er un certificat SSL autosign\u00e9 par exemple avec : https://fr.rakko.tools/tools/46/\r\n> \r\n> 2: Ajouter le nom de domaine personnalis\u00e9 dans FreeboxOS et importer le certificat cr\u00e9\u00e9.\r\n> \r\n> ![Sans titre2](https://private-user-images.githubusercontent.com/25287809/395643679-a7dc11aa-3ef0-4bf2-8b6d-755a2ec6af02.png?jwt=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJnaXRodWIuY29tIiwiYXVkIjoicmF3LmdpdGh1YnVzZXJjb250ZW50LmNvbSIsImtleSI6ImtleTUiLCJleHAiOjE3MzQyMTY0ODcsIm5iZiI6MTczNDIxNjE4NywicGF0aCI6Ii8yNTI4NzgwOS8zOTU2NDM2NzktYTdkYzExYWEtM2VmMC00YmYyLThiNmQtNzU1YTJlYzZhZjAyLnBuZz9YLUFtei1BbGdvcml0aG09QVdTNC1ITUFDLVNIQTI1NiZYLUFtei1DcmVkZW50aWFsPUFLSUFWQ09EWUxTQTUzUFFLNFpBJTJGMjAyNDEyMTQlMkZ1cy1lYXN0LTElMkZzMyUyRmF3czRfcmVxdWVzdCZYLUFtei1EYXRlPTIwMjQxMjE0VDIyNDMwN1omWC1BbXotRXhwaXJlcz0zMDAmWC1BbXotU2lnbmF0dXJlPTdjMDQ1YTZkZDRlZjNhNGNjODk1NGFiYWQ5NDVlMmQ3MjdiZWEzN2IwMDlmMTA4ZmM4Yzk0ODcwOTdmMjQwMzUmWC1BbXotU2lnbmVkSGVhZGVycz1ob3N0In0.Tq0HE72H4QpT06m5ezUvVK2gbC3Hfm8HFtn80Gj5V70)\r\n> \r\n> 3: Installer [hass-additional-ca](https://github.com/Athozs/hass-additional-ca) avec HACS ou manuellement. (La premi\u00e8re fois j'ai eu une erreur \u00e0 l'initialisation, j'ai du modifier la ligne 35 du fichier init.py comme ceci : `config_path = \"/config/custom_components/additional_ca\"`)\r\n> \r\n> 4: Importer le certificat dans le dossier d'additional_ca.\r\n> \r\n> 5: Suivre les instruction d'additional_ca pour prendre en compte votre certificat dans votre fichier `configuration.yaml`.\r\n> \r\n> 6: Cr\u00e9er un enregistrement DNS A sur l'ip : `212.27.38.253` ou CNAME sur `mafreebox.freebox.fr`\r\n> \r\n> 7: Reboot HA\r\n> \r\n> 8: Ajout de la Freebox sur HA en utilisant votre nom de domaine personnalis\u00e9 sur le port 443.\r\n> \r\n> ![Sans titre](https://private-user-images.githubusercontent.com/25287809/395642369-f34bc41c-c696-4c22-98b7-4fb7a9117d1a.png?jwt=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJnaXRodWIuY29tIiwiYXVkIjoicmF3LmdpdGh1YnVzZXJjb250ZW50LmNvbSIsImtleSI6ImtleTUiLCJleHAiOjE3MzQyMTY0ODcsIm5iZiI6MTczNDIxNjE4NywicGF0aCI6Ii8yNTI4NzgwOS8zOTU2NDIzNjktZjM0YmM0MWMtYzY5Ni00YzIyLTk4YjctNGZiN2E5MTE3ZDFhLnBuZz9YLUFtei1BbGdvcml0aG09QVdTNC1ITUFDLVNIQTI1NiZYLUFtei1DcmVkZW50aWFsPUFLSUFWQ09EWUxTQTUzUFFLNFpBJTJGMjAyNDEyMTQlMkZ1cy1lYXN0LTElMkZzMyUyRmF3czRfcmVxdWVzdCZYLUFtei1EYXRlPTIwMjQxMjE0VDIyNDMwN1omWC1BbXotRXhwaXJlcz0zMDAmWC1BbXotU2lnbmF0dXJlPTBmZmNmMWY1MGZlZmY2NGE2ZGVjNTJiOGE5ZjBiZjYwMDZjNjdjMGIxNjgxOWEzMTJhYTkxMDA5OGUzYjc1NTEmWC1BbXotU2lnbmVkSGVhZGVycz1ob3N0In0.XuImC1IRFWTNC8GPr7fCremx8TzMeOnbLQq9Fdbbokw)\r\n> \r\n> Normalement \u00e7a devrait fonctionner, avec un certificat valide 10 ans on est tranquille et pas besoin d'ouvrir son port vers l'ext\u00e9rieure et de cr\u00e9er un nom de domaine freeboxos.\r\n\r\nIt seems that solution will work but how can I help to have a native solution?\n> is en fait ce probl\u00e8me a mon avis (et je n'ai pas lu tous les commentaires de bug) n'est pas li\u00e9 \u00e0 l'int\u00e9gration mais au fait que free n'est plus de certificat valide pour le\r\n\r\nJe ne trouve pas ou est le chemin pour modifier le fichier et les autres personne donne le chemin avec Docker sauf moi je n'ai pas de docker pouvez vous me dire comment faire car la commande find me donne rien du tout.\r\nCordialement\nBonjour,\r\nJ'avais exactement le m\u00eame probl\u00e8me sur ma freebox mini4K mais \u00e7a n'emp\u00eachait pas l'int\u00e9gration de fonctionner. Depuis la derni\u00e8re mise \u00e0 jour de la freebox plus rien ne fonctionne. J'ai supprim\u00e9 l'int\u00e9gration, HA d\u00e9tecte un nouvel equipement mais lorsque je clique sur \"Submit\" j'ai un message \"erreur inattendue\" qui apparait:\r\n\r\n![image](https://github.com/user-attachments/assets/61f14818-0352-4610-8bc1-d24b5240755f)\r\n\r\nLe contenu du log\r\n\r\n`Logger: homeassistant.components.freebox.config_flow\r\nSource: components/freebox/config_flow.py:71\r\nintegration: freebox (documentation, issues)\r\nFirst occurred: 09:57:43 (2 occurrences)\r\nLast logged: 10:26:18\r\n\r\nUnknown error connecting with Freebox router at xtu9k4c6.fbxos.fr\r\nTraceback (most recent call last):\r\n  File \"/usr/local/lib/python3.13/site-packages/aiohttp/connector.py\", line 1116, in _wrap_create_connection\r\n    return await self._loop.create_connection(*args, **kwargs, sock=sock)\r\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/local/lib/python3.13/asyncio/base_events.py\", line 1182, in create_connection\r\n    transport, protocol = await self._create_connection_transport(\r\n                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n    ...<2 lines>...\r\n        ssl_shutdown_timeout=ssl_shutdown_timeout)\r\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/local/lib/python3.13/asyncio/base_events.py\", line 1215, in _create_connection_transport\r\n    await waiter\r\n  File \"/usr/local/lib/python3.13/asyncio/sslproto.py\", line 578, in _on_handshake_complete\r\n    raise handshake_exc\r\n  File \"/usr/local/lib/python3.13/asyncio/sslproto.py\", line 560, in _do_handshake\r\n    self._sslobj.do_handshake()\r\n    ~~~~~~~~~~~~~~~~~~~~~~~~~^^\r\n  File \"/usr/local/lib/python3.13/ssl.py\", line 951, in do_handshake\r\n    self._sslobj.do_handshake()\r\n    ~~~~~~~~~~~~~~~~~~~~~~~~~^^\r\nssl.SSLCertVerificationError: [SSL: CERTIFICATE_VERIFY_FAILED] certificate verify failed: Missing Authority Key Identifier (_ssl.c:1020)\r\n\r\nThe above exception was the direct cause of the following exception:\r\n\r\nTraceback (most recent call last):\r\n  File \"/usr/src/homeassistant/homeassistant/components/freebox/config_flow.py\", line 71, in async_step_link\r\n    await fbx.system.get_config()\r\n  File \"/usr/local/lib/python3.13/site-packages/freebox_api/api/system.py\", line 9, in get_config\r\n    return await self._access.get(\"system/\")\r\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/local/lib/python3.13/site-packages/freebox_api/access.py\", line 122, in get\r\n    return await self._perform_request(self.session.get, end_url)\r\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/local/lib/python3.13/site-packages/freebox_api/access.py\", line 86, in _perform_request\r\n    await self._refresh_session_token()\r\n  File \"/usr/local/lib/python3.13/site-packages/freebox_api/access.py\", line 69, in _refresh_session_token\r\n    session_token, session_permissions = await self._get_session_token(\r\n                                         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n        self.base_url, self.app_token, self.app_id, self.timeout\r\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n    )\r\n    ^\r\n  File \"/usr/local/lib/python3.13/site-packages/freebox_api/access.py\", line 45, in _get_session_token\r\n    challenge = await self._get_challenge(base_url, timeout)\r\n                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/local/lib/python3.13/site-packages/freebox_api/access.py\", line 28, in _get_challenge\r\n    r = await self.session.get(url, timeout=timeout)\r\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/local/lib/python3.13/site-packages/aiohttp/client.py\", line 701, in _request\r\n    conn = await self._connector.connect(\r\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n        req, traces=traces, timeout=real_timeout\r\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n    )\r\n    ^\r\n  File \"/usr/local/lib/python3.13/site-packages/aiohttp/connector.py\", line 544, in connect\r\n    proto = await self._create_connection(req, traces, timeout)\r\n            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/local/lib/python3.13/site-packages/aiohttp/connector.py\", line 1050, in _create_connection\r\n    _, proto = await self._create_direct_connection(req, traces, timeout)\r\n               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/local/lib/python3.13/site-packages/aiohttp/connector.py\", line 1394, in _create_direct_connection\r\n    raise last_exc\r\n  File \"/usr/local/lib/python3.13/site-packages/aiohttp/connector.py\", line 1363, in _create_direct_connection\r\n    transp, proto = await self._wrap_create_connection(\r\n                    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n    ...<7 lines>...\r\n    )\r\n    ^\r\n  File \"/usr/local/lib/python3.13/site-packages/aiohttp/connector.py\", line 1118, in _wrap_create_connection\r\n    raise ClientConnectorCertificateError(req.connection_key, exc) from exc\r\naiohttp.client_exceptions.ClientConnectorCertificateError: Cannot connect to host xxxxxxxxxxxx.fbxos.fr:000 ssl:True [SSLCertVerificationError: (1, '[SSL: CERTIFICATE_VERIFY_FAILED] certificate verify failed: Missing Authority Key Identifier (_ssl.c:1020)')]`\r\n\r\nNote: HA est \u00e0 jour\nHello, quelqu'un peut d\u00e9tailler l'\u00e9tape 6 de @Ozaroth ?\r\n_6: Cr\u00e9er un enregistrement DNS A sur l'ip : 212.27.38.253 ou CNAME sur mafreebox.freebox.fr_\r\nEn effet, je ne vois pas OU cr\u00e9er cet enregistrement ? Chez Free ? Sur HA ?\r\nEt surtout on ne voit absolument pas le lien avec le certificat api.freebox cr\u00e9\u00e9 par ailleurs.\r\nMerci :)\r\n\nPour cette \u00e9tape, il te faut \"poss\u00e9der\" (contr\u00f4ler) un nom de domaine (une zone DNS).\nBonjour \u00e0 tous, \r\n\r\nJ'ai pu faire de mani\u00e8re plus simple de mon c\u00f4t\u00e9 , je vous partage : \r\n\r\n1. Se connecter au freebox OS \r\n2. Aller dans param\u00e8tres puis Nom de domaine\r\n3. Cliquer sur ajouter un nom de domaine \r\n5. Choisir \"je veux choisir un nom de domaine freebox personnalis\u00e9\"\r\n6. Cliquer sur suivant , puis choisir le nom dans la case \"sous domaine\" (un nom perso, il faut qu'il soit disponible) puis suivant : \r\n7. ![image](https://github.com/user-attachments/assets/813ce519-1893-4a1a-a555-5a672fd6b341)\r\n8. Puis choisir demander un certificat let's encrypt et attendre quelques minutes une fois qu'il affiche valide\r\n9. ![image](https://github.com/user-attachments/assets/3644c3b0-0774-4f68-bf64-1a6c7293c187)\r\n10. Ensuite il faut retourner dans l'integration freebox , ajouter une nouvelle entr\u00e9e et mettre comme host : votrenomcustom.freeboxos.fr et en port le port que vous trouvez dans votre freebox OS au niveau du porte acc\u00e8s distant s\u00e9curis\u00e9 HTTPS dans configuration.\r\n\r\nJe suppose que pour cette solution simple ce qui va p\u00e9cher c'est le fait que le certificat expire au bout de 90 jours ? \u00e0 voir.\r\n\r\n\r\n\r\n\r\n\r\n\nLes certificat est automatiquement renouvel\u00e9 pour le nom de domaine. \u00c7a fait plus de 2 ans que j'ai mon nom de domaine et que cela ne pose aucun probl\u00e8me de certificat \nle certificat genere opar let's encrypt est effectivement correct. C'est celui qui est sur https://mafreebox.freebox.fr/ et *.fbxos.fr qui n'a plus approuv\u00e9.\r\nRechercher l'api domain et le port de la box en allant sur https://mafreebox.freebox.fr/api_version\r\nAller sur https://www.sslchecker.com/sslchecker par example et lancer la verification de cette url\r\n\r\n![2024-12-16 12_27_18-Window](https://github.com/user-attachments/assets/0cc5c081-9d58-4a17-95ce-ecddd020e65b)\r\n![2024-12-16 12_30_40-Window](https://github.com/user-attachments/assets/89812faa-dae6-4a91-8ecf-68e8eb7cc411)\nMerci @Titou84240 \u00e7a fonctionne parfaitement.\n@Gillus66 \r\nTu dois l'enregistrer dans ton serveur DNS, mais si tu pose la question je pense que tu utilise les serveurs DNS de la freebox, dans ton cas seul la cr\u00e9ation d'un nom de domaine freeboxos.fr convient (ou faire la modif du fichier pour d\u00e9sactiver la v\u00e9rification SSL)\r\n\r\n@Titou84240 @Yoanf26 \r\nIl me semble qu'avec la cr\u00e9ation d'un domaine freeboxos.fr \u00e7a ouvre le port d'acc\u00e8s distant sur internet (\u00e0 confirmer ?)\r\n\r\nVous utilisez quel port lors de la configuration de l'int\u00e9gration dans HA ?\n> @Gillus66 Tu dois l'enregistrer dans ton serveur DNS, mais si tu pose la question je pense que tu utilise les serveurs DNS de la freebox, dans ton cas seul la cr\u00e9ation d'un nom de domaine freeboxos.fr convient (ou faire la modif du fichier pour d\u00e9sactiver la v\u00e9rification SSL)\r\n> \r\n> @Titou84240 @Yoanf26 Il me semble qu'avec la cr\u00e9ation d'un domaine freeboxos.fr \u00e7a ouvre le port d'acc\u00e8s distant sur internet (\u00e0 confirmer ?)\r\n> \r\n> Vous utilisez quel port lors de la configuration de l'int\u00e9gration dans HA ?\r\n\r\nJ'utilise le port HTTPS pr\u00e9sent dans la config de la freebox , donc si j'ai bien compris \u00e7a ouvre une br\u00eache ? \n@Titou84240 \r\nSi tu utilise celui ci et que sur la seconde photo \u00e0 gauche c'est Oui/Oui, alors oui c'est que ton interface freebox est ouvert sur internet.\r\n![Sans titre](https://github.com/user-attachments/assets/cea2ac8d-d3dd-4be8-ad13-ee8784b15b99)\r\n![Sans titre1](https://github.com/user-attachments/assets/b3a94395-1c18-457a-9de3-1587c8c97524)\r\n\n> @Titou84240 Si tu utilise celui ci et que sur la seconde photo \u00e0 gauche c'est Oui/Oui, alors oui c'est que ton interface freebox est ouvert sur internet. ![Sans titre](https://private-user-images.githubusercontent.com/25287809/396183328-cea2ac8d-d3dd-4be8-ad13-ee8784b15b99.png?jwt=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJnaXRodWIuY29tIiwiYXVkIjoicmF3LmdpdGh1YnVzZXJjb250ZW50LmNvbSIsImtleSI6ImtleTUiLCJleHAiOjE3MzQzNjczNzEsIm5iZiI6MTczNDM2NzA3MSwicGF0aCI6Ii8yNTI4NzgwOS8zOTYxODMzMjgtY2VhMmFjOGQtZDNkZC00YmU4LWFkMTMtZWU4Nzg0YjE1Yjk5LnBuZz9YLUFtei1BbGdvcml0aG09QVdTNC1ITUFDLVNIQTI1NiZYLUFtei1DcmVkZW50aWFsPUFLSUFWQ09EWUxTQTUzUFFLNFpBJTJGMjAyNDEyMTYlMkZ1cy1lYXN0LTElMkZzMyUyRmF3czRfcmVxdWVzdCZYLUFtei1EYXRlPTIwMjQxMjE2VDE2Mzc1MVomWC1BbXotRXhwaXJlcz0zMDAmWC1BbXotU2lnbmF0dXJlPThkMzRjMTM1YTE3NWQ2Mjc2ZWYzNTcxNWNlZjMyYjhlNmNkMmJhNjc3YmFjYzkyNThiYjM2MTlkZTZlYjRhNDkmWC1BbXotU2lnbmVkSGVhZGVycz1ob3N0In0.tDh_OdwJIIBWSFifD2bQjTSs1nS5Y6OYOa54qqjnu0E) ![Sans titre1](https://private-user-images.githubusercontent.com/25287809/396183333-b3a94395-1c18-457a-9de3-1587c8c97524.png?jwt=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJnaXRodWIuY29tIiwiYXVkIjoicmF3LmdpdGh1YnVzZXJjb250ZW50LmNvbSIsImtleSI6ImtleTUiLCJleHAiOjE3MzQzNjczNzEsIm5iZiI6MTczNDM2NzA3MSwicGF0aCI6Ii8yNTI4NzgwOS8zOTYxODMzMzMtYjNhOTQzOTUtMWMxOC00NTdhLTlkZTMtMTU4N2M4Yzk3NTI0LnBuZz9YLUFtei1BbGdvcml0aG09QVdTNC1ITUFDLVNIQTI1NiZYLUFtei1DcmVkZW50aWFsPUFLSUFWQ09EWUxTQTUzUFFLNFpBJTJGMjAyNDEyMTYlMkZ1cy1lYXN0LTElMkZzMyUyRmF3czRfcmVxdWVzdCZYLUFtei1EYXRlPTIwMjQxMjE2VDE2Mzc1MVomWC1BbXotRXhwaXJlcz0zMDAmWC1BbXotU2lnbmF0dXJlPTI0YzRhYTE1ZTVlMDQzOGQyOGY4ZGE2NTZhNGUzZTQ2OWE4NDRiNjRmYTU2M2U3MzVkNTA4Y2E4MzM0NDlhODcmWC1BbXotU2lnbmVkSGVhZGVycz1ob3N0In0.sK-No8d-1WjC-0M1yimT_fDtsWxqGhXg--ViayH2quE)\r\n\r\nOui effectivement mais la connexion HTTPS n'est pas justement une connexion securis\u00e9e ?\r\nDonc la seule autre solution plus s\u00e9curis\u00e9e est la cr\u00e9ation du certificat auto sign\u00e9e et la creation d'un autre nom de domaine ?\n@Titou84240 Je suis pas expert en SSL mais pour simplifier: le HTTPS signifie juste que l'\u00e9change entre toi et la Freebox est \"s\u00e9curis\u00e9\" dans le sens ou gr\u00e2ce au certificat etc tu est s\u00fbr de bien parler avec ta Freebox (en gros hein) mais \u00e7a n'emp\u00eache pas quelqu'un qui connais ton IP ou ton domaine freeboxos ou les bots (qui scanne les IP \u00e0 la recherche de port ouvert) de parler aussi avec ta Freebox.\r\n\r\nDans un premier temps tu peut essayer de reconfigurer l'int\u00e9gration HA manuellement en pr\u00e9cisant ton domaine freeboxos et en entrant le port 443, si \u00e7a fonctionne tu peut d\u00e9sactiver le port distant (2eme photo) et voir si l'int\u00e9gration fonctionne toujours.\r\n\r\nSi \u00e7a ne marche pas avec le port 443 il faudra alors passer par un certificat autosign\u00e9 qui lui fonctionnera sur le port 443.\r\nOu la modif du fichier (voir plus haut dans le thread) qui d\u00e9sactive la v\u00e9rification SSL.\n>  @SamyDjemai:\n> \n> On my Freebox, when going to http://mafreebox.freebox.fr/api_version, I see `\"api_version\":\"12.2\"`, however the provided documentation says `Current API version is \u201c5.0\u201d` :thinking: not sure what's going on with versioning at Free\n\nIt's just an out-of-date page of the documentation, if you go to \"Api Changes\", you will see newer API versions\n", "created_at": "2024-12-17T21:20:59Z"}
{"repo": "home-assistant/core", "pull_number": 133438, "instance_id": "home-assistant__core-133438", "issue_numbers": ["133375"], "base_commit": "98d50206900695d5108852b0c3c2340dff5ddb90", "patch": "diff --git a/homeassistant/components/integration/sensor.py b/homeassistant/components/integration/sensor.py\nindex a053e5cea5cea..27aa74d0785cd 100644\n--- a/homeassistant/components/integration/sensor.py\n+++ b/homeassistant/components/integration/sensor.py\n@@ -576,7 +576,7 @@ def _schedule_max_sub_interval_exceeded_if_state_is_numeric(\n         if (\n             self._max_sub_interval is not None\n             and source_state is not None\n-            and (source_state_dec := _decimal_state(source_state.state))\n+            and (source_state_dec := _decimal_state(source_state.state)) is not None\n         ):\n \n             @callback\n", "test_patch": "diff --git a/tests/components/integration/test_sensor.py b/tests/components/integration/test_sensor.py\nindex 974c8bb8691be..07390cd9571f4 100644\n--- a/tests/components/integration/test_sensor.py\n+++ b/tests/components/integration/test_sensor.py\n@@ -843,6 +843,39 @@ async def test_on_valid_source_expect_update_on_time(\n         assert float(state.state) < 1.8\n \n \n+async def test_on_0_source_expect_0_and_update_when_source_gets_positive(\n+    hass: HomeAssistant,\n+) -> None:\n+    \"\"\"Test whether time based integration updates the integral on a valid zero source.\"\"\"\n+    start_time = dt_util.utcnow()\n+\n+    with freeze_time(start_time) as freezer:\n+        await _setup_integral_sensor(hass, max_sub_interval=DEFAULT_MAX_SUB_INTERVAL)\n+        await _update_source_sensor(hass, 0)\n+        await hass.async_block_till_done()\n+\n+        # wait one minute and one second\n+        freezer.tick(61)\n+        async_fire_time_changed(hass, dt_util.now())\n+        await hass.async_block_till_done()\n+\n+        state = hass.states.get(\"sensor.integration\")\n+\n+        assert condition.async_numeric_state(hass, state) is True\n+        assert float(state.state) == 0  # integral is 0 after integration of 0\n+\n+        # wait one second and update state\n+        freezer.tick(1)\n+        async_fire_time_changed(hass, dt_util.now())\n+        await _update_source_sensor(hass, 100)\n+        await hass.async_block_till_done()\n+\n+        state = hass.states.get(\"sensor.integration\")\n+\n+        # approx 100*1/3600 (right method after 1 second since last integration)\n+        assert 0.027 < float(state.state) < 0.029\n+\n+\n async def test_on_unvailable_source_expect_no_update_on_time(\n     hass: HomeAssistant,\n ) -> None:\n", "problem_statement": "Integral integration does not work correctly\n### The problem\n\nThe maximum sub interval is not used correctly when the input value is 0 and then changes to a different value. This is very common for solar energy returned to the grid, as there is no production for hours and then when energy is returned, it is calculated with the previous hours.\r\n\r\nThis change:\r\nhttps://github.com/home-assistant/core/pull/110685\r\nis exactly to correct this, but it does not work when the input is 0.\r\n\r\n![image](https://github.com/user-attachments/assets/f4f22740-1323-40b1-9069-14bc09758262)\r\n\r\n![image](https://github.com/user-attachments/assets/b76a80f8-987a-42e4-b4c4-d3826b686796)\r\n\r\n![image](https://github.com/user-attachments/assets/fba65910-c9f2-47c1-b517-5df33898dc41)\r\n\r\n![image](https://github.com/user-attachments/assets/f97661ad-1439-481c-a74e-17a03b842132)\r\n\r\nAfter turning integral_input from 0 to 1 the result jumps up using all the time where the input was 0.\n\n### What version of Home Assistant Core has the issue?\n\n2024.12.3\n\n### What was the last working version of Home Assistant Core?\n\n_No response_\n\n### What type of installation are you running?\n\nHome Assistant OS\n\n### Integration causing the issue\n\nIntegral\n\n### Link to integration documentation on our website\n\nhttps://www.home-assistant.io/integrations/integration\n\n### Diagnostics information\n\n_No response_\n\n### Example YAML snippet\n\n_No response_\n\n### Anything in the logs that might be useful for us?\n\n_No response_\n\n### Additional information\n\n_No response_\n", "hints_text": "\nHey there @dgomes, mind taking a look at this issue as it has been labeled with an integration (`integration`) you are listed as a [code owner](https://github.com/home-assistant/core/blob/dev/CODEOWNERS#L723) for? Thanks!\n\n<details>\n<summary>Code owner commands</summary>\n\n\nCode owners of `integration` can trigger bot actions by commenting:\n\n- `@home-assistant close` Closes the issue.\n- `@home-assistant rename Awesome new title` Renames the issue.\n- `@home-assistant reopen` Reopen the issue.\n- `@home-assistant unassign integration` Removes the current integration label and assignees on the issue, add the integration domain after the command.\n- `@home-assistant add-label needs-more-information` Add a label (needs-more-information, problem in dependency, problem in custom component) to the issue.\n- `@home-assistant remove-label needs-more-information` Remove a label (needs-more-information, problem in dependency, problem in custom component) on the issue.\n\n</details>\n\n\n<sub><sup>(message by CodeOwnersMention)</sup></sub>\n\n---\n\n[integration documentation](https://www.home-assistant.io/integrations/integration)\n[integration source](https://github.com/home-assistant/core/tree/dev/homeassistant/components/integration)\n<sub><sup>(message by IssueLinks)</sup></sub>\nCC @ronweikamp as the proponent of this feature\n@rollodroid this will probably work to your expectations if you change the method to \"left\"\nI believe I found the problem. [This](https://github.com/home-assistant/core/blob/2d8e693cdbbc5877f130e5e3fdfea859ff08f4b5/homeassistant/components/integration/sensor.py#L579) assignment expression evaluates to falsy in case the state is 0 (which is actually a valid decimal state), as a consequence no new time based integration is scheduled and the next integration is the new state change with a too large time interval. I'll see if I can make a bugfix PR for that.\n@dgomes can confirm that. \r\n@ronweikamp this is much like what I thought, but with very little to no python knowledge I could not find it. Thanks for figuring that out.\n> I believe I found the problem. [This](https://github.com/home-assistant/core/blob/2d8e693cdbbc5877f130e5e3fdfea859ff08f4b5/homeassistant/components/integration/sensor.py#L579) assignment expression evaluates to falsy in case the state is 0 (which is actually a valid decimal state), as a consequence no new time based integration is scheduled and the next integration is the new state change with a too large time interval. I'll see if I can make a bugfix PR for that.\r\n\r\n```\r\n            and (source_state_dec := _decimal_state(source_state.state)) is not None\r\n```", "created_at": "2024-12-17T17:09:52Z"}
{"repo": "home-assistant/core", "pull_number": 133433, "instance_id": "home-assistant__core-133433", "issue_numbers": ["132343"], "base_commit": "44a86f537ff7f5d1f48bfc518a4c6d89de4c3ff4", "patch": "diff --git a/homeassistant/components/palazzetti/manifest.json b/homeassistant/components/palazzetti/manifest.json\nindex 05a5d260b50eb2..70e585071596d3 100644\n--- a/homeassistant/components/palazzetti/manifest.json\n+++ b/homeassistant/components/palazzetti/manifest.json\n@@ -15,5 +15,5 @@\n   \"documentation\": \"https://www.home-assistant.io/integrations/palazzetti\",\n   \"integration_type\": \"device\",\n   \"iot_class\": \"local_polling\",\n-  \"requirements\": [\"pypalazzetti==0.1.14\"]\n+  \"requirements\": [\"pypalazzetti==0.1.15\"]\n }\ndiff --git a/requirements_all.txt b/requirements_all.txt\nindex 2540a297334031..9e6a662cb0d035 100644\n--- a/requirements_all.txt\n+++ b/requirements_all.txt\n@@ -2168,7 +2168,7 @@ pyoverkiz==1.15.0\n pyownet==0.10.0.post1\n \n # homeassistant.components.palazzetti\n-pypalazzetti==0.1.14\n+pypalazzetti==0.1.15\n \n # homeassistant.components.elv\n pypca==0.0.7\n", "test_patch": "diff --git a/requirements_test_all.txt b/requirements_test_all.txt\nindex fe528899ad3d51..4f7e8af8b9f96b 100644\n--- a/requirements_test_all.txt\n+++ b/requirements_test_all.txt\n@@ -1761,7 +1761,7 @@ pyoverkiz==1.15.0\n pyownet==0.10.0.post1\n \n # homeassistant.components.palazzetti\n-pypalazzetti==0.1.14\n+pypalazzetti==0.1.15\n \n # homeassistant.components.lcn\n pypck==0.7.24\n", "problem_statement": "Palazzeti set fan mode silent not supported\n### The problem\n\nHello,\r\nI wrote an automation to silence the stove, and I have this issue\r\n\r\nerror form automation \r\nExecuted: December 5, 2024 at 08:29:11\r\n**Error: Fan mode silent is not valid. Valid fan modes are: 1, 2, 3, 4, 5, high, auto**\r\nResult:\r\nparams:\r\n  domain: climate\r\n  service: set_fan_mode\r\n  service_data:\r\n    fan_mode: silent\r\n[...]\r\n\r\n**Documentation says :** \r\n[set_fan_mode](https://www.home-assistant.io/integrations/climate/#action-climateset_fan_mode)\r\n> _Silent_ let the stove run in silent mode\n\n### What version of Home Assistant Core has the issue?\n\ncore-2024.12.0\n\n### What was the last working version of Home Assistant Core?\n\n_No response_\n\n### What type of installation are you running?\n\nHome Assistant OS\n\n### Integration causing the issue\n\nPalazzeti\n\n### Link to integration documentation on our website\n\nhttps://www.home-assistant.io/integrations/palazzetti\n\n### Diagnostics information\n\n_No response_\n\n### Example YAML snippet\n\n_No response_\n\n### Anything in the logs that might be useful for us?\n\n```txt\n2024-12-05 08:29:11.564 ERROR (MainThread) [homeassistant.components.automation.poele_auto_silence] [Poele] Auto silence: Error executing script. Error for call_service at pos 1: Fan mode silent is not valid. Valid fan modes are: 1, 2, 3, 4, 5, high, auto\r\n2024-12-05 08:29:11.564 ERROR (MainThread) [homeassistant.components.automation.poele_auto_silence] Error while executing automation automation.poele_auto_silence: Fan mode silent is not valid. Valid fan modes are: 1, 2, 3, 4, 5, high, auto\n```\n\n\n### Additional information\n\n_No response_\n", "hints_text": "\nHey there @home-assistant/core, mind taking a look at this issue as it has been labeled with an integration (`climate`) you are listed as a [code owner](https://github.com/home-assistant/core/blob/dev/CODEOWNERS#L259) for? Thanks!\n\n<details>\n<summary>Code owner commands</summary>\n\n\nCode owners of `climate` can trigger bot actions by commenting:\n\n- `@home-assistant close` Closes the issue.\n- `@home-assistant rename Awesome new title` Renames the issue.\n- `@home-assistant reopen` Reopen the issue.\n- `@home-assistant unassign climate` Removes the current integration label and assignees on the issue, add the integration domain after the command.\n- `@home-assistant add-label needs-more-information` Add a label (needs-more-information, problem in dependency, problem in custom component) to the issue.\n- `@home-assistant remove-label needs-more-information` Remove a label (needs-more-information, problem in dependency, problem in custom component) on the issue.\n\n</details>\n\n\n<sub><sup>(message by CodeOwnersMention)</sup></sub>\n\n---\n\n[climate documentation](https://www.home-assistant.io/integrations/climate)\n[climate source](https://github.com/home-assistant/core/tree/dev/homeassistant/components/climate)\n<sub><sup>(message by IssueLinks)</sup></sub>\n\nHey there @dotvav, mind taking a look at this issue as it has been labeled with an integration (`palazzetti`) you are listed as a [code owner](https://github.com/home-assistant/core/blob/dev/CODEOWNERS#L1104) for? Thanks!\n\n<details>\n<summary>Code owner commands</summary>\n\n\nCode owners of `palazzetti` can trigger bot actions by commenting:\n\n- `@home-assistant close` Closes the issue.\n- `@home-assistant rename Awesome new title` Renames the issue.\n- `@home-assistant reopen` Reopen the issue.\n- `@home-assistant unassign palazzetti` Removes the current integration label and assignees on the issue, add the integration domain after the command.\n- `@home-assistant add-label needs-more-information` Add a label (needs-more-information, problem in dependency, problem in custom component) to the issue.\n- `@home-assistant remove-label needs-more-information` Remove a label (needs-more-information, problem in dependency, problem in custom component) on the issue.\n\n</details>\n\n\n<sub><sup>(message by CodeOwnersMention)</sup></sub>\n\n---\n\n[palazzetti documentation](https://www.home-assistant.io/integrations/palazzetti)\n[palazzetti source](https://github.com/home-assistant/core/tree/dev/homeassistant/components/palazzetti)\n<sub><sup>(message by IssueLinks)</sup></sub>\nSome fan modes are not available to all stove models. Can you share your stove brand and model, and your diagnostics file?\nAlso, is `silent` available for you in the Palazzetti app?\nHi,\r\nThe stove is : ECOFIRE INES ACCIAIO NERA\r\nDiagnostics file : [config_entry-palazzetti-01JDAG5Z2N7Y9VH523RZ5CN71S.json](https://github.com/user-attachments/files/18019587/config_entry-palazzetti-01JDAG5Z2N7Y9VH523RZ5CN71S.json)\r\n\r\nOn the Palazzeti application I can set the \"central fan\" to Off. \r\nbut before your integration I used to slient my stove with :\r\nhttp://xxxx/cgi-bin/sendmsg.lua?cmd=SET+RFAN+0\r\n\r\n- 0 for **Off**\r\n- 1 to 5 for **Speed**\r\n- 6 for **High**\r\n- 7 for **Auto**\r\n\r\nI can set the fire power too with http://xxxx/cgi-bin/sendmsg.lua?cmd=SET+POWR+1  to 5 ;)\r\n\r\n\nI have a PR in progress for the combustion power control. https://github.com/home-assistant/core/pull/131833\r\n\r\nI will look into the data that you have shared for the silent mode. Maybe I wouldn't be surprised too if the app doesn't show some of the available features.\nI don't know where you get informations but i worked with a doc found in a old forum.\r\nhere is an extract (in french) it may be help:\r\n\r\n GET+LABL : Obtient le nom donn\u00e9 au po\u00eale\r\n GET+STDT : Obtient les informations sur la CBox, les configuration r\u00e9seau WiFi et LAN et enfin la version et date du firmware du po\u00eale ainsi que le type de pellet et la configuration du po\u00eale (1 normal ou 2 chrono-thermostat ext\u00e9rieur\r\n GET+FWST : Obtient l'\u00e9tat du Firmware (???)\r\n GET+TMPS : Obtient la temp\u00e9rature relev\u00e9e par la sonde d'ambiance du po\u00eale (nomm\u00e9e TMP_ROOM_WATER)\r\n GET+FAND : Obtient la configuration de ventilation et la vitesse des ventilateurs\r\n GET+SETP : Obtient la consigne actuelle du po\u00eale\r\n GET+STAT : Obtient le status du po\u00eale.\r\n 0: OFF\r\n 1: OFF TIMER\r\n 2: TESTFIRE\r\n 3: HEATUP\r\n 4: FUELIGN\r\n 5: IGNTEST\r\n 6: BURNING\r\n 9: COOLFLUID\r\n 10: FIRESTOP\r\n 11: CLEANFIRE\r\n 12: COOL\r\n\r\n 241: CHIMNEY ALARM\r\n 243: GRATE ERROR\r\n 244: NTC2 ALARM\r\n 245: NTC3 ALARM\r\n 247: DOOR ALARM\r\n 248: PRESS ALARM\r\n 249: NTC1 ALARM\r\n 250: TC1 ALARM\r\n 252: GAS ALARM\r\n 253: NOPELLET ALARM\r\n\r\n GET+TIME : Obtient la date/heure du po\u00eale et le jour de la semaine (1=lundi, 2=mardi, etc., ...)\r\n GET+MDVE : Obtient le model du po\u00eale, la version et la date du firmware\r\n GET+CHRD : Obtient les diff\u00e9rentes programmations horaires et les programmes des jours de la semaine\r\n EXT+ADRD+2066+1 : Obtient le nombre d'allumage du po\u00eale\r\n EXT+ADRD+206A+1 : Obtient le nombre d'heure durant laquelle le po\u00eale a \u00e9t\u00e9 aliment\u00e9 \u00e9lectriquement\r\n EXT+ADRD+2070+1 : Obtient le nombre d'heure de chauffe total\r\n EXT+ADRD+2076+1 : Obtient le nombre d'heure de chauffe depuis le dernier entretien\r\n EXT+ADRD+207C+1 : Obtient le nombre d'allumage manqu\u00e9 (\u00e0 confirmer)\r\n EXT+ADRD+207A+1 : Obtient le nombre d'erreur pour cause de surchauffe\r\n\r\n Les commandes d'\u00e9criture/Contr\u00f4le du po\u00eale\r\n\r\n CMD+ON : Allumage du Po\u00eale\r\n CMD+OFF : Extinction du Po\u00eale\r\n SETP+20 : r\u00e9glage de la consigne \u00e0 la temp\u00e9rature d\u00e9sir\u00e9e\r\n RFAN+1 : r\u00e9glage de la vitesse de ventilation (de 0 \u00e0 7)\r\nPOWR+1 : r\u00e9glage de la puissance de chauffe (de 1 \u00e0 5)\nThanks. I use mostly GET STDT and GET ALLS to read configuration and state, and the bottom commands to write. You can join [my discord server](https://discord.gg/gyMfe36F) if you want to chat or need specific support (English or French) on the Palazzetti integration. I'd like to keep this issue dedicated to 1 problem: \"set fan mode silent\".\n@Calagan74 I have a bugfix for the fan speed 0. I was mistaken and I thought that Silent and 0 were the same, but they are not. The bugfix will be in the API lib (already commited [there](https://github.com/dotvav/py-palazzetti-api/commit/c7475ea0d5c2afeadb92320d1849ae283a5959b0)) and after I release a new version of it, I'll open a PR to HA.", "created_at": "2024-12-17T16:19:33Z"}
{"repo": "home-assistant/core", "pull_number": 133388, "instance_id": "home-assistant__core-133388", "issue_numbers": ["133378"], "base_commit": "ac6d7180949358d8f8708ae4a903312ca0bb739d", "patch": "diff --git a/homeassistant/components/flexit_bacnet/number.py b/homeassistant/components/flexit_bacnet/number.py\nindex 6e6e2eea980e9..029ce896445c0 100644\n--- a/homeassistant/components/flexit_bacnet/number.py\n+++ b/homeassistant/components/flexit_bacnet/number.py\n@@ -29,6 +29,8 @@ class FlexitNumberEntityDescription(NumberEntityDescription):\n     \"\"\"Describes a Flexit number entity.\"\"\"\n \n     native_value_fn: Callable[[FlexitBACnet], float]\n+    native_max_value_fn: Callable[[FlexitBACnet], int]\n+    native_min_value_fn: Callable[[FlexitBACnet], int]\n     set_native_value_fn: Callable[[FlexitBACnet], Callable[[int], Awaitable[None]]]\n \n \n@@ -37,121 +39,121 @@ class FlexitNumberEntityDescription(NumberEntityDescription):\n         key=\"away_extract_fan_setpoint\",\n         translation_key=\"away_extract_fan_setpoint\",\n         device_class=NumberDeviceClass.POWER_FACTOR,\n-        native_min_value=0,\n-        native_max_value=100,\n         native_step=1,\n         mode=NumberMode.SLIDER,\n         native_value_fn=lambda device: device.fan_setpoint_extract_air_away,\n         set_native_value_fn=lambda device: device.set_fan_setpoint_extract_air_away,\n         native_unit_of_measurement=PERCENTAGE,\n+        native_max_value_fn=lambda device: int(device.fan_setpoint_extract_air_home),\n+        native_min_value_fn=lambda _: 30,\n     ),\n     FlexitNumberEntityDescription(\n         key=\"away_supply_fan_setpoint\",\n         translation_key=\"away_supply_fan_setpoint\",\n         device_class=NumberDeviceClass.POWER_FACTOR,\n-        native_min_value=0,\n-        native_max_value=100,\n         native_step=1,\n         mode=NumberMode.SLIDER,\n         native_value_fn=lambda device: device.fan_setpoint_supply_air_away,\n         set_native_value_fn=lambda device: device.set_fan_setpoint_supply_air_away,\n         native_unit_of_measurement=PERCENTAGE,\n+        native_max_value_fn=lambda device: int(device.fan_setpoint_supply_air_home),\n+        native_min_value_fn=lambda _: 30,\n     ),\n     FlexitNumberEntityDescription(\n         key=\"cooker_hood_extract_fan_setpoint\",\n         translation_key=\"cooker_hood_extract_fan_setpoint\",\n         device_class=NumberDeviceClass.POWER_FACTOR,\n-        native_min_value=0,\n-        native_max_value=100,\n         native_step=1,\n         mode=NumberMode.SLIDER,\n         native_value_fn=lambda device: device.fan_setpoint_extract_air_cooker,\n         set_native_value_fn=lambda device: device.set_fan_setpoint_extract_air_cooker,\n         native_unit_of_measurement=PERCENTAGE,\n+        native_max_value_fn=lambda _: 100,\n+        native_min_value_fn=lambda _: 30,\n     ),\n     FlexitNumberEntityDescription(\n         key=\"cooker_hood_supply_fan_setpoint\",\n         translation_key=\"cooker_hood_supply_fan_setpoint\",\n         device_class=NumberDeviceClass.POWER_FACTOR,\n-        native_min_value=0,\n-        native_max_value=100,\n         native_step=1,\n         mode=NumberMode.SLIDER,\n         native_value_fn=lambda device: device.fan_setpoint_supply_air_cooker,\n         set_native_value_fn=lambda device: device.set_fan_setpoint_supply_air_cooker,\n         native_unit_of_measurement=PERCENTAGE,\n+        native_max_value_fn=lambda _: 100,\n+        native_min_value_fn=lambda _: 30,\n     ),\n     FlexitNumberEntityDescription(\n         key=\"fireplace_extract_fan_setpoint\",\n         translation_key=\"fireplace_extract_fan_setpoint\",\n         device_class=NumberDeviceClass.POWER_FACTOR,\n-        native_min_value=0,\n-        native_max_value=100,\n         native_step=1,\n         mode=NumberMode.SLIDER,\n         native_value_fn=lambda device: device.fan_setpoint_extract_air_fire,\n         set_native_value_fn=lambda device: device.set_fan_setpoint_extract_air_fire,\n         native_unit_of_measurement=PERCENTAGE,\n+        native_max_value_fn=lambda _: 100,\n+        native_min_value_fn=lambda _: 30,\n     ),\n     FlexitNumberEntityDescription(\n         key=\"fireplace_supply_fan_setpoint\",\n         translation_key=\"fireplace_supply_fan_setpoint\",\n         device_class=NumberDeviceClass.POWER_FACTOR,\n-        native_min_value=0,\n-        native_max_value=100,\n         native_step=1,\n         mode=NumberMode.SLIDER,\n         native_value_fn=lambda device: device.fan_setpoint_supply_air_fire,\n         set_native_value_fn=lambda device: device.set_fan_setpoint_supply_air_fire,\n         native_unit_of_measurement=PERCENTAGE,\n+        native_max_value_fn=lambda _: 100,\n+        native_min_value_fn=lambda _: 30,\n     ),\n     FlexitNumberEntityDescription(\n         key=\"high_extract_fan_setpoint\",\n         translation_key=\"high_extract_fan_setpoint\",\n         device_class=NumberDeviceClass.POWER_FACTOR,\n-        native_min_value=0,\n-        native_max_value=100,\n         native_step=1,\n         mode=NumberMode.SLIDER,\n         native_value_fn=lambda device: device.fan_setpoint_extract_air_high,\n         set_native_value_fn=lambda device: device.set_fan_setpoint_extract_air_high,\n         native_unit_of_measurement=PERCENTAGE,\n+        native_max_value_fn=lambda _: 100,\n+        native_min_value_fn=lambda device: int(device.fan_setpoint_extract_air_home),\n     ),\n     FlexitNumberEntityDescription(\n         key=\"high_supply_fan_setpoint\",\n         translation_key=\"high_supply_fan_setpoint\",\n         device_class=NumberDeviceClass.POWER_FACTOR,\n-        native_min_value=0,\n-        native_max_value=100,\n         native_step=1,\n         mode=NumberMode.SLIDER,\n         native_value_fn=lambda device: device.fan_setpoint_supply_air_high,\n         set_native_value_fn=lambda device: device.set_fan_setpoint_supply_air_high,\n         native_unit_of_measurement=PERCENTAGE,\n+        native_max_value_fn=lambda _: 100,\n+        native_min_value_fn=lambda device: int(device.fan_setpoint_supply_air_home),\n     ),\n     FlexitNumberEntityDescription(\n         key=\"home_extract_fan_setpoint\",\n         translation_key=\"home_extract_fan_setpoint\",\n         device_class=NumberDeviceClass.POWER_FACTOR,\n-        native_min_value=0,\n-        native_max_value=100,\n         native_step=1,\n         mode=NumberMode.SLIDER,\n         native_value_fn=lambda device: device.fan_setpoint_extract_air_home,\n         set_native_value_fn=lambda device: device.set_fan_setpoint_extract_air_home,\n         native_unit_of_measurement=PERCENTAGE,\n+        native_max_value_fn=lambda _: 100,\n+        native_min_value_fn=lambda device: int(device.fan_setpoint_extract_air_away),\n     ),\n     FlexitNumberEntityDescription(\n         key=\"home_supply_fan_setpoint\",\n         translation_key=\"home_supply_fan_setpoint\",\n         device_class=NumberDeviceClass.POWER_FACTOR,\n-        native_min_value=0,\n-        native_max_value=100,\n         native_step=1,\n         mode=NumberMode.SLIDER,\n         native_value_fn=lambda device: device.fan_setpoint_supply_air_home,\n         set_native_value_fn=lambda device: device.set_fan_setpoint_supply_air_home,\n         native_unit_of_measurement=PERCENTAGE,\n+        native_max_value_fn=lambda _: 100,\n+        native_min_value_fn=lambda device: int(device.fan_setpoint_supply_air_away),\n     ),\n )\n \n@@ -192,6 +194,16 @@ def native_value(self) -> float:\n         \"\"\"Return the state of the number.\"\"\"\n         return self.entity_description.native_value_fn(self.coordinator.device)\n \n+    @property\n+    def native_max_value(self) -> float:\n+        \"\"\"Return the native max value of the number.\"\"\"\n+        return self.entity_description.native_max_value_fn(self.coordinator.device)\n+\n+    @property\n+    def native_min_value(self) -> float:\n+        \"\"\"Return the native min value of the number.\"\"\"\n+        return self.entity_description.native_min_value_fn(self.coordinator.device)\n+\n     async def async_set_native_value(self, value: float) -> None:\n         \"\"\"Update the current value.\"\"\"\n         set_native_value_fn = self.entity_description.set_native_value_fn(\n", "test_patch": "diff --git a/tests/components/flexit_bacnet/conftest.py b/tests/components/flexit_bacnet/conftest.py\nindex a6205bac50633..6ce17261bfc62 100644\n--- a/tests/components/flexit_bacnet/conftest.py\n+++ b/tests/components/flexit_bacnet/conftest.py\n@@ -69,16 +69,16 @@ def mock_flexit_bacnet() -> Generator[AsyncMock]:\n         flexit_bacnet.electric_heater = True\n \n         # Mock fan setpoints\n-        flexit_bacnet.fan_setpoint_extract_air_fire = 10\n-        flexit_bacnet.fan_setpoint_supply_air_fire = 20\n-        flexit_bacnet.fan_setpoint_extract_air_away = 30\n-        flexit_bacnet.fan_setpoint_supply_air_away = 40\n-        flexit_bacnet.fan_setpoint_extract_air_home = 50\n-        flexit_bacnet.fan_setpoint_supply_air_home = 60\n-        flexit_bacnet.fan_setpoint_extract_air_high = 70\n-        flexit_bacnet.fan_setpoint_supply_air_high = 80\n-        flexit_bacnet.fan_setpoint_extract_air_cooker = 90\n-        flexit_bacnet.fan_setpoint_supply_air_cooker = 100\n+        flexit_bacnet.fan_setpoint_extract_air_fire = 56\n+        flexit_bacnet.fan_setpoint_supply_air_fire = 77\n+        flexit_bacnet.fan_setpoint_extract_air_away = 40\n+        flexit_bacnet.fan_setpoint_supply_air_away = 42\n+        flexit_bacnet.fan_setpoint_extract_air_home = 70\n+        flexit_bacnet.fan_setpoint_supply_air_home = 74\n+        flexit_bacnet.fan_setpoint_extract_air_high = 100\n+        flexit_bacnet.fan_setpoint_supply_air_high = 100\n+        flexit_bacnet.fan_setpoint_extract_air_cooker = 50\n+        flexit_bacnet.fan_setpoint_supply_air_cooker = 70\n \n         yield flexit_bacnet\n \ndiff --git a/tests/components/flexit_bacnet/snapshots/test_number.ambr b/tests/components/flexit_bacnet/snapshots/test_number.ambr\nindex c4fb1e7c43444..78eefd083455b 100644\n--- a/tests/components/flexit_bacnet/snapshots/test_number.ambr\n+++ b/tests/components/flexit_bacnet/snapshots/test_number.ambr\n@@ -5,8 +5,8 @@\n     }),\n     'area_id': None,\n     'capabilities': dict({\n-      'max': 100,\n-      'min': 0,\n+      'max': 70,\n+      'min': 30,\n       'mode': <NumberMode.SLIDER: 'slider'>,\n       'step': 1,\n     }),\n@@ -42,8 +42,8 @@\n     'attributes': ReadOnlyDict({\n       'device_class': 'power_factor',\n       'friendly_name': 'Device Name Away extract fan setpoint',\n-      'max': 100,\n-      'min': 0,\n+      'max': 70,\n+      'min': 30,\n       'mode': <NumberMode.SLIDER: 'slider'>,\n       'step': 1,\n       'unit_of_measurement': '%',\n@@ -53,7 +53,7 @@\n     'last_changed': <ANY>,\n     'last_reported': <ANY>,\n     'last_updated': <ANY>,\n-    'state': '30',\n+    'state': '40',\n   })\n # ---\n # name: test_numbers[number.device_name_away_supply_fan_setpoint-entry]\n@@ -62,8 +62,8 @@\n     }),\n     'area_id': None,\n     'capabilities': dict({\n-      'max': 100,\n-      'min': 0,\n+      'max': 74,\n+      'min': 30,\n       'mode': <NumberMode.SLIDER: 'slider'>,\n       'step': 1,\n     }),\n@@ -99,8 +99,8 @@\n     'attributes': ReadOnlyDict({\n       'device_class': 'power_factor',\n       'friendly_name': 'Device Name Away supply fan setpoint',\n-      'max': 100,\n-      'min': 0,\n+      'max': 74,\n+      'min': 30,\n       'mode': <NumberMode.SLIDER: 'slider'>,\n       'step': 1,\n       'unit_of_measurement': '%',\n@@ -110,7 +110,7 @@\n     'last_changed': <ANY>,\n     'last_reported': <ANY>,\n     'last_updated': <ANY>,\n-    'state': '40',\n+    'state': '42',\n   })\n # ---\n # name: test_numbers[number.device_name_cooker_hood_extract_fan_setpoint-entry]\n@@ -120,7 +120,7 @@\n     'area_id': None,\n     'capabilities': dict({\n       'max': 100,\n-      'min': 0,\n+      'min': 30,\n       'mode': <NumberMode.SLIDER: 'slider'>,\n       'step': 1,\n     }),\n@@ -157,7 +157,7 @@\n       'device_class': 'power_factor',\n       'friendly_name': 'Device Name Cooker hood extract fan setpoint',\n       'max': 100,\n-      'min': 0,\n+      'min': 30,\n       'mode': <NumberMode.SLIDER: 'slider'>,\n       'step': 1,\n       'unit_of_measurement': '%',\n@@ -167,7 +167,7 @@\n     'last_changed': <ANY>,\n     'last_reported': <ANY>,\n     'last_updated': <ANY>,\n-    'state': '90',\n+    'state': '50',\n   })\n # ---\n # name: test_numbers[number.device_name_cooker_hood_supply_fan_setpoint-entry]\n@@ -177,7 +177,7 @@\n     'area_id': None,\n     'capabilities': dict({\n       'max': 100,\n-      'min': 0,\n+      'min': 30,\n       'mode': <NumberMode.SLIDER: 'slider'>,\n       'step': 1,\n     }),\n@@ -214,7 +214,7 @@\n       'device_class': 'power_factor',\n       'friendly_name': 'Device Name Cooker hood supply fan setpoint',\n       'max': 100,\n-      'min': 0,\n+      'min': 30,\n       'mode': <NumberMode.SLIDER: 'slider'>,\n       'step': 1,\n       'unit_of_measurement': '%',\n@@ -224,7 +224,7 @@\n     'last_changed': <ANY>,\n     'last_reported': <ANY>,\n     'last_updated': <ANY>,\n-    'state': '100',\n+    'state': '70',\n   })\n # ---\n # name: test_numbers[number.device_name_fireplace_extract_fan_setpoint-entry]\n@@ -234,7 +234,7 @@\n     'area_id': None,\n     'capabilities': dict({\n       'max': 100,\n-      'min': 0,\n+      'min': 30,\n       'mode': <NumberMode.SLIDER: 'slider'>,\n       'step': 1,\n     }),\n@@ -271,7 +271,7 @@\n       'device_class': 'power_factor',\n       'friendly_name': 'Device Name Fireplace extract fan setpoint',\n       'max': 100,\n-      'min': 0,\n+      'min': 30,\n       'mode': <NumberMode.SLIDER: 'slider'>,\n       'step': 1,\n       'unit_of_measurement': '%',\n@@ -281,7 +281,7 @@\n     'last_changed': <ANY>,\n     'last_reported': <ANY>,\n     'last_updated': <ANY>,\n-    'state': '10',\n+    'state': '56',\n   })\n # ---\n # name: test_numbers[number.device_name_fireplace_supply_fan_setpoint-entry]\n@@ -291,7 +291,7 @@\n     'area_id': None,\n     'capabilities': dict({\n       'max': 100,\n-      'min': 0,\n+      'min': 30,\n       'mode': <NumberMode.SLIDER: 'slider'>,\n       'step': 1,\n     }),\n@@ -328,7 +328,7 @@\n       'device_class': 'power_factor',\n       'friendly_name': 'Device Name Fireplace supply fan setpoint',\n       'max': 100,\n-      'min': 0,\n+      'min': 30,\n       'mode': <NumberMode.SLIDER: 'slider'>,\n       'step': 1,\n       'unit_of_measurement': '%',\n@@ -338,7 +338,7 @@\n     'last_changed': <ANY>,\n     'last_reported': <ANY>,\n     'last_updated': <ANY>,\n-    'state': '20',\n+    'state': '77',\n   })\n # ---\n # name: test_numbers[number.device_name_high_extract_fan_setpoint-entry]\n@@ -348,7 +348,7 @@\n     'area_id': None,\n     'capabilities': dict({\n       'max': 100,\n-      'min': 0,\n+      'min': 70,\n       'mode': <NumberMode.SLIDER: 'slider'>,\n       'step': 1,\n     }),\n@@ -385,7 +385,7 @@\n       'device_class': 'power_factor',\n       'friendly_name': 'Device Name High extract fan setpoint',\n       'max': 100,\n-      'min': 0,\n+      'min': 70,\n       'mode': <NumberMode.SLIDER: 'slider'>,\n       'step': 1,\n       'unit_of_measurement': '%',\n@@ -395,7 +395,7 @@\n     'last_changed': <ANY>,\n     'last_reported': <ANY>,\n     'last_updated': <ANY>,\n-    'state': '70',\n+    'state': '100',\n   })\n # ---\n # name: test_numbers[number.device_name_high_supply_fan_setpoint-entry]\n@@ -405,7 +405,7 @@\n     'area_id': None,\n     'capabilities': dict({\n       'max': 100,\n-      'min': 0,\n+      'min': 74,\n       'mode': <NumberMode.SLIDER: 'slider'>,\n       'step': 1,\n     }),\n@@ -442,7 +442,7 @@\n       'device_class': 'power_factor',\n       'friendly_name': 'Device Name High supply fan setpoint',\n       'max': 100,\n-      'min': 0,\n+      'min': 74,\n       'mode': <NumberMode.SLIDER: 'slider'>,\n       'step': 1,\n       'unit_of_measurement': '%',\n@@ -452,7 +452,7 @@\n     'last_changed': <ANY>,\n     'last_reported': <ANY>,\n     'last_updated': <ANY>,\n-    'state': '80',\n+    'state': '100',\n   })\n # ---\n # name: test_numbers[number.device_name_home_extract_fan_setpoint-entry]\n@@ -462,7 +462,7 @@\n     'area_id': None,\n     'capabilities': dict({\n       'max': 100,\n-      'min': 0,\n+      'min': 40,\n       'mode': <NumberMode.SLIDER: 'slider'>,\n       'step': 1,\n     }),\n@@ -499,7 +499,7 @@\n       'device_class': 'power_factor',\n       'friendly_name': 'Device Name Home extract fan setpoint',\n       'max': 100,\n-      'min': 0,\n+      'min': 40,\n       'mode': <NumberMode.SLIDER: 'slider'>,\n       'step': 1,\n       'unit_of_measurement': '%',\n@@ -509,7 +509,7 @@\n     'last_changed': <ANY>,\n     'last_reported': <ANY>,\n     'last_updated': <ANY>,\n-    'state': '50',\n+    'state': '70',\n   })\n # ---\n # name: test_numbers[number.device_name_home_supply_fan_setpoint-entry]\n@@ -519,7 +519,7 @@\n     'area_id': None,\n     'capabilities': dict({\n       'max': 100,\n-      'min': 0,\n+      'min': 42,\n       'mode': <NumberMode.SLIDER: 'slider'>,\n       'step': 1,\n     }),\n@@ -556,7 +556,7 @@\n       'device_class': 'power_factor',\n       'friendly_name': 'Device Name Home supply fan setpoint',\n       'max': 100,\n-      'min': 0,\n+      'min': 42,\n       'mode': <NumberMode.SLIDER: 'slider'>,\n       'step': 1,\n       'unit_of_measurement': '%',\n@@ -566,6 +566,6 @@\n     'last_changed': <ANY>,\n     'last_reported': <ANY>,\n     'last_updated': <ANY>,\n-    'state': '60',\n+    'state': '74',\n   })\n # ---\ndiff --git a/tests/components/flexit_bacnet/test_number.py b/tests/components/flexit_bacnet/test_number.py\nindex ad49908fa96d4..f566b623f124f 100644\n--- a/tests/components/flexit_bacnet/test_number.py\n+++ b/tests/components/flexit_bacnet/test_number.py\n@@ -64,21 +64,21 @@ async def test_numbers_implementation(\n     assert len(mocked_method.mock_calls) == 1\n     assert hass.states.get(ENTITY_ID).state == \"60\"\n \n-    mock_flexit_bacnet.fan_setpoint_supply_air_fire = 10\n+    mock_flexit_bacnet.fan_setpoint_supply_air_fire = 40\n \n     await hass.services.async_call(\n         NUMBER_DOMAIN,\n         SERVICE_SET_VALUE,\n         {\n             ATTR_ENTITY_ID: ENTITY_ID,\n-            ATTR_VALUE: 10,\n+            ATTR_VALUE: 40,\n         },\n         blocking=True,\n     )\n \n     mocked_method = getattr(mock_flexit_bacnet, \"set_fan_setpoint_supply_air_fire\")\n     assert len(mocked_method.mock_calls) == 2\n-    assert hass.states.get(ENTITY_ID).state == \"10\"\n+    assert hass.states.get(ENTITY_ID).state == \"40\"\n \n     # Error recovery, when setting the value\n     mock_flexit_bacnet.set_fan_setpoint_supply_air_fire.side_effect = DecodingError\n@@ -89,7 +89,7 @@ async def test_numbers_implementation(\n             SERVICE_SET_VALUE,\n             {\n                 ATTR_ENTITY_ID: ENTITY_ID,\n-                ATTR_VALUE: 10,\n+                ATTR_VALUE: 40,\n             },\n             blocking=True,\n         )\n", "problem_statement": "Flexit integration breaks when setting Away extract/supply setpoint\n### The problem\n\nFlexit integration breaks when setting Away extract/supply fan setpoint higher than Home extract/away fan setpoint.\r\n\r\nHow to reproduce: set Home extract fan setpoint to 90%, then set Away extract fan setpoint to above 90%.\n\n### What version of Home Assistant Core has the issue?\n\ncore-2025.1.0.dev0\n\n### What was the last working version of Home Assistant Core?\n\nUnknown/It newer worked\n\n### What type of installation are you running?\n\nHome Assistant Core\n\n### Integration causing the issue\n\nflexit_bacnet\n\n### Link to integration documentation on our website\n\nhttps://www.home-assistant.io/integrations/flexit_bacnet/\n\n### Diagnostics information\n\n_No response_\n\n### Example YAML snippet\n\n_No response_\n\n### Anything in the logs that might be useful for us?\n\n_No response_\n\n### Additional information\n\n_No response_\n", "hints_text": "\nHey there @piotrbulinski, mind taking a look at this issue as it has been labeled with an integration (`flexit_bacnet`) you are listed as a [code owner](https://github.com/home-assistant/core/blob/dev/CODEOWNERS#L482) for? Thanks!\n\n<details>\n<summary>Code owner commands</summary>\n\n\nCode owners of `flexit_bacnet` can trigger bot actions by commenting:\n\n- `@home-assistant close` Closes the issue.\n- `@home-assistant rename Awesome new title` Renames the issue.\n- `@home-assistant reopen` Reopen the issue.\n- `@home-assistant unassign flexit_bacnet` Removes the current integration label and assignees on the issue, add the integration domain after the command.\n- `@home-assistant add-label needs-more-information` Add a label (needs-more-information, problem in dependency, problem in custom component) to the issue.\n- `@home-assistant remove-label needs-more-information` Remove a label (needs-more-information, problem in dependency, problem in custom component) on the issue.\n\n</details>\n\n\n<sub><sup>(message by CodeOwnersMention)</sup></sub>\n\n---\n\n[flexit_bacnet documentation](https://www.home-assistant.io/integrations/flexit_bacnet)\n[flexit_bacnet source](https://github.com/home-assistant/core/tree/dev/homeassistant/components/flexit_bacnet)\n<sub><sup>(message by IssueLinks)</sup></sub>", "created_at": "2024-12-16T21:37:14Z"}
{"repo": "home-assistant/core", "pull_number": 133364, "instance_id": "home-assistant__core-133364", "issue_numbers": ["133195", "133195"], "base_commit": "5adb7f4542ad116672e16580348fb9b14ea211b6", "patch": "diff --git a/homeassistant/components/imgw_pib/manifest.json b/homeassistant/components/imgw_pib/manifest.json\nindex b5c35f3f1eb62..ce3bc14d37b9f 100644\n--- a/homeassistant/components/imgw_pib/manifest.json\n+++ b/homeassistant/components/imgw_pib/manifest.json\n@@ -5,5 +5,5 @@\n   \"config_flow\": true,\n   \"documentation\": \"https://www.home-assistant.io/integrations/imgw_pib\",\n   \"iot_class\": \"cloud_polling\",\n-  \"requirements\": [\"imgw_pib==1.0.6\"]\n+  \"requirements\": [\"imgw_pib==1.0.7\"]\n }\ndiff --git a/requirements_all.txt b/requirements_all.txt\nindex 9ffc6a8f16e03..5eecf96d09626 100644\n--- a/requirements_all.txt\n+++ b/requirements_all.txt\n@@ -1193,7 +1193,7 @@ iglo==1.2.7\n ihcsdk==2.8.5\n \n # homeassistant.components.imgw_pib\n-imgw_pib==1.0.6\n+imgw_pib==1.0.7\n \n # homeassistant.components.incomfort\n incomfort-client==0.6.4\n", "test_patch": "diff --git a/requirements_test_all.txt b/requirements_test_all.txt\nindex 25c4167a0bfc4..c10645dc29362 100644\n--- a/requirements_test_all.txt\n+++ b/requirements_test_all.txt\n@@ -1007,7 +1007,7 @@ idasen-ha==2.6.2\n ifaddr==0.2.0\n \n # homeassistant.components.imgw_pib\n-imgw_pib==1.0.6\n+imgw_pib==1.0.7\n \n # homeassistant.components.incomfort\n incomfort-client==0.6.4\n", "problem_statement": "IMGW-PIB - Failed to connect during add entry\n### The problem\n\nIMGW-PIB Failed to connect during add entry\r\n\r\n![image](https://github.com/user-attachments/assets/f71db6e1-93ee-431e-9bf5-5883bc1c2f15)\r\n\r\n\n\n### What version of Home Assistant Core has the issue?\n\ncore-2024.12.3\n\n### What was the last working version of Home Assistant Core?\n\ncore-2024.11.3\n\n### What type of installation are you running?\n\nHome Assistant Supervised\n\n### Integration causing the issue\n\nIMGW-PIB \n\n### Link to integration documentation on our website\n\nhttps://www.home-assistant.io/integrations/imgw_pib\n\n### Diagnostics information\n\n[home-assistant_imgw_pib_2024-12-14T09-14-54.864Z.log](https://github.com/user-attachments/files/18135261/home-assistant_imgw_pib_2024-12-14T09-14-54.864Z.log)\r\n\n\n### Example YAML snippet\n\n_No response_\n\n### Anything in the logs that might be useful for us?\n\n```txt\nno logs\n```\n\n\n### Additional information\n\nstop wording in core-2024.11.3 after upgrade stil not working\nIMGW-PIB - Failed to connect during add entry\n### The problem\n\nIMGW-PIB Failed to connect during add entry\r\n\r\n![image](https://github.com/user-attachments/assets/f71db6e1-93ee-431e-9bf5-5883bc1c2f15)\r\n\r\n\n\n### What version of Home Assistant Core has the issue?\n\ncore-2024.12.3\n\n### What was the last working version of Home Assistant Core?\n\ncore-2024.11.3\n\n### What type of installation are you running?\n\nHome Assistant Supervised\n\n### Integration causing the issue\n\nIMGW-PIB \n\n### Link to integration documentation on our website\n\nhttps://www.home-assistant.io/integrations/imgw_pib\n\n### Diagnostics information\n\n[home-assistant_imgw_pib_2024-12-14T09-14-54.864Z.log](https://github.com/user-attachments/files/18135261/home-assistant_imgw_pib_2024-12-14T09-14-54.864Z.log)\r\n\n\n### Example YAML snippet\n\n_No response_\n\n### Anything in the logs that might be useful for us?\n\n```txt\nno logs\n```\n\n\n### Additional information\n\nstop wording in core-2024.11.3 after upgrade stil not working\n", "hints_text": "\nHey there @bieniu, mind taking a look at this issue as it has been labeled with an integration (`imgw_pib`) you are listed as a [code owner](https://github.com/home-assistant/core/blob/dev/CODEOWNERS#L699) for? Thanks!\n\n<details>\n<summary>Code owner commands</summary>\n\n\nCode owners of `imgw_pib` can trigger bot actions by commenting:\n\n- `@home-assistant close` Closes the issue.\n- `@home-assistant rename Awesome new title` Renames the issue.\n- `@home-assistant reopen` Reopen the issue.\n- `@home-assistant unassign imgw_pib` Removes the current integration label and assignees on the issue, add the integration domain after the command.\n- `@home-assistant add-label needs-more-information` Add a label (needs-more-information, problem in dependency, problem in custom component) to the issue.\n- `@home-assistant remove-label needs-more-information` Remove a label (needs-more-information, problem in dependency, problem in custom component) on the issue.\n\n</details>\n\n\n<sub><sup>(message by CodeOwnersMention)</sup></sub>\n\n---\n\n[imgw_pib documentation](https://www.home-assistant.io/integrations/imgw_pib)\n[imgw_pib source](https://github.com/home-assistant/core/tree/dev/homeassistant/components/imgw_pib)\n<sub><sup>(message by IssueLinks)</sup></sub>\n\nHey there @bieniu, mind taking a look at this issue as it has been labeled with an integration (`imgw_pib`) you are listed as a [code owner](https://github.com/home-assistant/core/blob/dev/CODEOWNERS#L699) for? Thanks!\n\n<details>\n<summary>Code owner commands</summary>\n\n\nCode owners of `imgw_pib` can trigger bot actions by commenting:\n\n- `@home-assistant close` Closes the issue.\n- `@home-assistant rename Awesome new title` Renames the issue.\n- `@home-assistant reopen` Reopen the issue.\n- `@home-assistant unassign imgw_pib` Removes the current integration label and assignees on the issue, add the integration domain after the command.\n- `@home-assistant add-label needs-more-information` Add a label (needs-more-information, problem in dependency, problem in custom component) to the issue.\n- `@home-assistant remove-label needs-more-information` Remove a label (needs-more-information, problem in dependency, problem in custom component) on the issue.\n\n</details>\n\n\n<sub><sup>(message by CodeOwnersMention)</sup></sub>\n\n---\n\n[imgw_pib documentation](https://www.home-assistant.io/integrations/imgw_pib)\n[imgw_pib source](https://github.com/home-assistant/core/tree/dev/homeassistant/components/imgw_pib)\n<sub><sup>(message by IssueLinks)</sup></sub>", "created_at": "2024-12-16T15:33:03Z"}
{"repo": "home-assistant/core", "pull_number": 133299, "instance_id": "home-assistant__core-133299", "issue_numbers": ["125993"], "base_commit": "2a49378f4cb3e808bee83d959aaff9755da044cb", "patch": "diff --git a/homeassistant/block_async_io.py b/homeassistant/block_async_io.py\nindex 7a68b2515e995b..767716dbe27d58 100644\n--- a/homeassistant/block_async_io.py\n+++ b/homeassistant/block_async_io.py\n@@ -50,6 +50,12 @@ def _check_sleep_call_allowed(mapped_args: dict[str, Any]) -> bool:\n     return False\n \n \n+def _check_load_verify_locations_call_allowed(mapped_args: dict[str, Any]) -> bool:\n+    # If only cadata is passed, we can ignore it\n+    kwargs = mapped_args.get(\"kwargs\")\n+    return bool(kwargs and len(kwargs) == 1 and \"cadata\" in kwargs)\n+\n+\n @dataclass(slots=True, frozen=True)\n class BlockingCall:\n     \"\"\"Class to hold information about a blocking call.\"\"\"\n@@ -158,7 +164,7 @@ class BlockingCall:\n         original_func=SSLContext.load_verify_locations,\n         object=SSLContext,\n         function=\"load_verify_locations\",\n-        check_allowed=None,\n+        check_allowed=_check_load_verify_locations_call_allowed,\n         strict=False,\n         strict_core=False,\n         skip_for_tests=True,\n", "test_patch": "diff --git a/tests/test_block_async_io.py b/tests/test_block_async_io.py\nindex dc2b096f5958df..dd23d4e9709bc9 100644\n--- a/tests/test_block_async_io.py\n+++ b/tests/test_block_async_io.py\n@@ -429,6 +429,12 @@ async def test_protect_loop_load_verify_locations(\n         context.load_verify_locations(\"/dev/null\")\n     assert \"Detected blocking call to load_verify_locations\" in caplog.text\n \n+    # ignore with only cadata\n+    caplog.clear()\n+    with pytest.raises(ssl.SSLError):\n+        context.load_verify_locations(cadata=\"xxx\")\n+    assert \"Detected blocking call to load_verify_locations\" not in caplog.text\n+\n \n async def test_protect_loop_load_cert_chain(\n     hass: HomeAssistant, caplog: pytest.LogCaptureFixture\n", "problem_statement": "`load_verify_locations` blocking I/O check needs an exception implemented for `cadata` via `check_allowed`\n### The problem\n\nUse of `load_verify_locations` from `ssl` is getting flagged as blocking IO even if the CA is actually being passed as a variable not read from disk.\r\n\r\neg. if you have the equivalent of\r\n```python\r\nmyca = \"\"\"\r\n-----BEGIN CERTIFICATE-----\r\n# Cert....\r\n-----END CERTIFICATE-----\r\n\"\"\"\r\nctx =- ssl.SSLContext(ssl.PROTOCOL_TLS_CLIENT)\r\nctx.load_verify_locations(cadata=myca)\r\n```\r\n\r\nthis is flagged as blocking IO but should not be?   Other uses of `load_verifiy_locations` will read from disk (`cafile` or `capath` arguments)\r\n\r\nIn practice this is normally done by a custom CA being uploaded in a config flow and stored in config rather than hardcoded as above but that is just showing the issue.\r\n\r\nThe docs (https://developers.home-assistant.io/docs/asyncio_blocking_operations/#load_verify_locations) say to use `homeassistant.util.ssl` for generic `ssl` (as that caches single context instances) however that only provides contexts to disable verification or use the default certificates.   You can not use this for a custom CA.\r\n\n\n### What version of Home Assistant Core has the issue?\n\ncore-2024.9.1\n\n### What was the last working version of Home Assistant Core?\n\n_No response_\n\n### What type of installation are you running?\n\nHome Assistant Container\n\n### Integration causing the issue\n\n_No response_\n\n### Link to integration documentation on our website\n\nhttps://developers.home-assistant.io/docs/asyncio_blocking_operations/#load_verify_locations\n\n### Diagnostics information\n\n_No response_\n\n### Example YAML snippet\n\n_No response_\n\n### Anything in the logs that might be useful for us?\n\n_No response_\n\n### Additional information\n\n_No response_\n", "hints_text": "You can wrap the call to [`SSLContext.load_verify_locations`](https://docs.python.org/3/library/ssl.html#ssl.SSLContext.load_verify_locations) into an executer job as described in [Running blocking calls in the executor](https://developers.home-assistant.io/docs/asyncio_blocking_operations/#running-blocking-calls-in-the-executor). I've not checked the code of `SSLContext.load_verify_locations` (_most properly because it is part of openssl code_), but it is possible, that there is still some IO within the openssl code.\nIt has been a very long since I was forced to do C at university but\r\nhttps://github.com/python/cpython/blob/401fff7423ca3c8bf1d02e594edfd1412616a559/Modules/_ssl.c#L4113\r\ndoes suggest there is no IO at al.  The whole point of the SSLContext is to hold the config to be used when doing the actual IO and the `load_verify_locations` call is purely to add the certificate to this config (passing `cafile` or `capath` would cause it read from disk but `cadata` will just read from memory)\r\n\r\nI can add the code in an executer job but that seems like a workaround to avoid the erroneous error flagging.\n> I can add the code in an executer job but that seems like a workaround to avoid the erroneous error flagging.\r\n\r\nit is not flagged as doing blocking IO, but it is detected that there is IO done (_so it is not an assumption, it is a detected behavior_).\r\n\r\n> It has been a very long since I was forced to do C at university but\r\n> https://github.com/python/cpython/blob/401fff7423ca3c8bf1d02e594edfd1412616a559/Modules/_ssl.c#L4113\r\n> does suggest there is no IO at al.\r\n\r\nThe code you're referring to, does also make use of a function called [`_add_ca_certs`](https://github.com/python/cpython/blob/401fff7423ca3c8bf1d02e594edfd1412616a559/Modules/_ssl.c#L3971) which itself relies on functions from openssl code.\r\n\r\nAnyway, figuring out, what is doing IO at the end in some `_ssl` or `openssl` library code, should not be part of an issue report in the HA core repository :wink: \r\n\r\n\n> it is not flagged as doing blocking IO, but it is detected that there is IO done (_so it is not an assumption, it is a detected behavior_).\r\n\r\nMy understanding is that the blocking IO checks are based on their being a call to `SSLContext.load_verify_locations` not that there is any actual blocking IO taking place.\r\n\r\nhttps://github.com/home-assistant/core/blob/d9812f0d48ac7c38a2404270bdbc7c81af534101/homeassistant/block_async_io.py#L157-L165\r\nOr have I missed something in how the blocking IO checks are working?\r\n\r\nHence the issue with Core, I am 99.99% certain that in this scenario the warning is wrong.\nUntil now I thought it was based on real detected IO, was not aware, that there is a list of functions _known_ to do IO :see_no_evil: \r\n\r\nwe could add a `check_allowed` function to [this](https://github.com/home-assistant/core/blob/d9812f0d48ac7c38a2404270bdbc7c81af534101/homeassistant/block_async_io.py#L157-L165) that filters out function calls which only has `cadata` defined :thinking: \nThere hasn't been any activity on this issue recently. Due to the high number of incoming GitHub notifications, we have to clean some of the old issues, as many of them have already been resolved with the latest updates.\nPlease make sure to update to the latest Home Assistant version and check if that solves the issue. Let us know if that works for you by adding a comment \ud83d\udc4d\nThis issue has now been marked as stale and will be closed if no further activity occurs. Thank you for your contributions.\nBumping this.   It is still there in 2024.12.\r\nStill think this should not be flagged as blocking IO\nIt looks like its true that `cadata` doesn't do blocking I/O, and `check_allowed` should be implemented for this function\r\n\r\nhttps://github.com/python/cpython/blob/9c6bd272b40bbd8264a00413e94e8246f550275a/Modules/_ssl.c#L4278\r\n\r\n", "created_at": "2024-12-15T17:32:02Z"}
{"repo": "home-assistant/core", "pull_number": 133284, "instance_id": "home-assistant__core-133284", "issue_numbers": ["119125"], "base_commit": "b4b6067e8ee3ec660b893cba734c0f83aa89d211", "patch": "diff --git a/homeassistant/components/homekit_controller/alarm_control_panel.py b/homeassistant/components/homekit_controller/alarm_control_panel.py\nindex 3cb80f2c817ceb..b17f122dfa5c80 100644\n--- a/homeassistant/components/homekit_controller/alarm_control_panel.py\n+++ b/homeassistant/components/homekit_controller/alarm_control_panel.py\n@@ -69,6 +69,7 @@ class HomeKitAlarmControlPanelEntity(HomeKitEntity, AlarmControlPanelEntity):\n         | AlarmControlPanelEntityFeature.ARM_AWAY\n         | AlarmControlPanelEntityFeature.ARM_NIGHT\n     )\n+    _attr_code_arm_required = False\n \n     def get_characteristic_types(self) -> list[str]:\n         \"\"\"Define the homekit characteristics the entity cares about.\"\"\"\n", "test_patch": "diff --git a/tests/components/homekit_controller/snapshots/test_init.ambr b/tests/components/homekit_controller/snapshots/test_init.ambr\nindex b96da507adfc20..2bd5e7faf75b81 100644\n--- a/tests/components/homekit_controller/snapshots/test_init.ambr\n+++ b/tests/components/homekit_controller/snapshots/test_init.ambr\n@@ -1474,7 +1474,7 @@\n           'state': dict({\n             'attributes': dict({\n               'changed_by': None,\n-              'code_arm_required': True,\n+              'code_arm_required': False,\n               'code_format': None,\n               'friendly_name': 'Aqara-Hub-E1-00A0 Security System',\n               'supported_features': <AlarmControlPanelEntityFeature: 7>,\n@@ -1848,7 +1848,7 @@\n           'state': dict({\n             'attributes': dict({\n               'changed_by': None,\n-              'code_arm_required': True,\n+              'code_arm_required': False,\n               'code_format': None,\n               'friendly_name': 'Aqara Hub-1563 Security System',\n               'supported_features': <AlarmControlPanelEntityFeature: 7>,\ndiff --git a/tests/components/homekit_controller/test_alarm_control_panel.py b/tests/components/homekit_controller/test_alarm_control_panel.py\nindex 1e9f023fc4647e..3ab9dc82e41267 100644\n--- a/tests/components/homekit_controller/test_alarm_control_panel.py\n+++ b/tests/components/homekit_controller/test_alarm_control_panel.py\n@@ -6,6 +6,7 @@\n from aiohomekit.model.characteristics import CharacteristicsTypes\n from aiohomekit.model.services import ServicesTypes\n \n+from homeassistant.components.alarm_control_panel import ATTR_CODE_ARM_REQUIRED\n from homeassistant.core import HomeAssistant\n from homeassistant.helpers import entity_registry as er\n \n@@ -106,6 +107,7 @@ async def test_switch_read_alarm_state(\n     state = await helper.poll_and_get_state()\n     assert state.state == \"armed_home\"\n     assert state.attributes[\"battery_level\"] == 50\n+    assert state.attributes[ATTR_CODE_ARM_REQUIRED] is False\n \n     await helper.async_update(\n         ServicesTypes.SECURITY_SYSTEM,\n", "problem_statement": "Fix Alarm control panel not require code in Homekit\n### The problem\r\n\r\nMy Abode alarm connects using the HomeKit controller. Both the 6.0 and 6.1 core update break the alarm panel. Giving the error code required where this alarm has no code required.\r\n\r\n### What version of Home Assistant Core has the issue?\r\n\r\n2024.6.0, 2024.6.1\r\n\r\n### What was the last working version of Home Assistant Core?\r\n\r\n2024.5.5\r\n\r\n### What type of installation are you running?\r\n\r\nHome Assistant OS\r\n\r\n### Integration causing the issue\r\n\r\nAlarm.py\r\n\r\n### Link to integration documentation on our website\r\n\r\nhttps://www.home-assistant.io/integrations/homekit_controller/\r\n\r\n### Diagnostics information\r\n\r\n_No response_\r\n\r\n### Example YAML snippet\r\n\r\n_No response_\r\n\r\n### Anything in the logs that might be useful for us?\r\n\r\n_No response_\r\n\r\n### Additional information\r\n\r\n_No response_\n```[tasklist]\n### Tasks\n```\n\n", "hints_text": "Thank you for reporting. I have the same issue.\nI am having this issue as well.\nI found a workaround was to set the code in the Alarm Control Panel entity to something, doesn't have to be a real code (0000 should work).\r\n<img width=\"577\" alt=\"Screenshot 2024-06-09 at 13 43 14\" src=\"https://github.com/home-assistant/core/assets/13852784/07fb2104-e9f8-4da5-94e7-5f339034bf9a\">\r\n\nThis is not limited to Homekit. I am seeing similar behavior with the Simplisafe integration; however, inputting a dummy code as described doesn't work. I am able to submit a valid code that I obtain by repeating the initial Simplisafe integration steps to get a new code; however, I must input that code every time before HA will submit the request to Simplisafe. I can submit a different issue, if necessary, to document this but I thought it was still useful information for this issue.\nI'm having the same problem with Abode via HomeKit.\r\n\r\nNote that this ticket might not get assigned since it's lacking a link to the documentation - https://www.home-assistant.io/integrations/homekit_controller/\nPutting in a default pin like 0000 does work for me as a work around. Also\r\nthe issue is caused by a change they made to the alarm panel really has\r\nnothing to do with abode. Also mine connects under homekit controller\r\nintegration so I can control over local network. Avoid cloud integration as\r\nmuch as possible.\r\n\r\nOn Mon, Jun 10, 2024, 10:04\u202fAM lymanepp ***@***.***> wrote:\r\n\r\n> I'm having the same problem with Abode via HomeKit.\r\n>\r\n> Note that this ticket might not get assigned since it's lacking a link to\r\n> the documentation - https://www.home-assistant.io/integrations/abode/\r\n>\r\n> \u2014\r\n> Reply to this email directly, view it on GitHub\r\n> <https://github.com/home-assistant/core/issues/119125#issuecomment-2158882549>,\r\n> or unsubscribe\r\n> <https://github.com/notifications/unsubscribe-auth/AP4SMEUNDJCAMRNATYFREU3ZGXMARAVCNFSM6AAAAABI72IBSGVHI2DSMVQWIX3LMV43OSLTON2WKQ3PNVWWK3TUHMZDCNJYHA4DENJUHE>\r\n> .\r\n> You are receiving this because you authored the thread.Message ID:\r\n> ***@***.***>\r\n>\r\n\n\nHey there @jc2k, @bdraco, mind taking a look at this issue as it has been labeled with an integration (`homekit_controller`) you are listed as a [code owner](https://github.com/home-assistant/core/blob/dev/CODEOWNERS#L607) for? Thanks!\n\n<details>\n<summary>Code owner commands</summary>\n\n\nCode owners of `homekit_controller` can trigger bot actions by commenting:\n\n- `@home-assistant close` Closes the issue.\n- `@home-assistant rename Awesome new title` Renames the issue.\n- `@home-assistant reopen` Reopen the issue.\n- `@home-assistant unassign homekit_controller` Removes the current integration label and assignees on the issue, add the integration domain after the command.\n- `@home-assistant add-label needs-more-information` Add a label (needs-more-information, problem in dependency, problem in custom component) to the issue.\n- `@home-assistant remove-label needs-more-information` Remove a label (needs-more-information, problem in dependency, problem in custom component) on the issue.\n\n</details>\n\n\n<sub><sup>(message by CodeOwnersMention)</sup></sub>\n\n---\n\n[homekit_controller documentation](https://www.home-assistant.io/integrations/homekit_controller)\n[homekit_controller source](https://github.com/home-assistant/core/tree/dev/homeassistant/components/homekit_controller)\n<sub><sup>(message by IssueLinks)</sup></sub>\nI have reported a similar problem... also HomeKit and the alarm panel, but 'with' a code.\r\nhttps://github.com/home-assistant/core/issues/119541\nI am having the same issue. Is this related to this post?\r\n\r\nhttps://developers.home-assistant.io/blog/2024/05/22/alarm_control_panel_validation/\r\n\r\nWhere is this `code_arm_required` set?\nI too am having issues with this with Simplisafe:\r\n\r\n```\r\nFailed to call service alarm_control_panel/alarm_arm_home. Validation error: Arming requires a code but none was given for alarm_control_panel.alarm_control_panel\r\n```\nDid you try putting in a a fake code like 0000 in the settings for the\r\nalarm panel card.\r\n\r\nOn Sat, Jun 15, 2024, 11:46\u202fAM Seth Ryder ***@***.***> wrote:\r\n\r\n> I too am having issues with this with Simplisafe:\r\n>\r\n> Failed to call service alarm_control_panel/alarm_arm_home. Validation error: Arming requires a code but none was given for alarm_control_panel.alarm_control_panel\r\n>\r\n> \u2014\r\n> Reply to this email directly, view it on GitHub\r\n> <https://github.com/home-assistant/core/issues/119125#issuecomment-2170490911>,\r\n> or unsubscribe\r\n> <https://github.com/notifications/unsubscribe-auth/AP4SMEU7YVM7PU4ZOPWYYNLZHSDW5AVCNFSM6AAAAABI72IBSGVHI2DSMVQWIX3LMV43OSLTON2WKQ3PNVWWK3TUHMZDCNZQGQ4TAOJRGE>\r\n> .\r\n> You are receiving this because you authored the thread.Message ID:\r\n> ***@***.***>\r\n>\r\n\n> Did you try putting in a a fake code like 0000 in the settings for the alarm panel card.\r\n> [\u2026](#)\r\n> On Sat, Jun 15, 2024, 11:46\u202fAM Seth Ryder ***@***.***> wrote: I too am having issues with this with Simplisafe: Failed to call service alarm_control_panel/alarm_arm_home. Validation error: Arming requires a code but none was given for alarm_control_panel.alarm_control_panel \u2014 Reply to this email directly, view it on GitHub <[#119125 (comment)](https://github.com/home-assistant/core/issues/119125#issuecomment-2170490911)>, or unsubscribe <https://github.com/notifications/unsubscribe-auth/AP4SMEU7YVM7PU4ZOPWYYNLZHSDW5AVCNFSM6AAAAABI72IBSGVHI2DSMVQWIX3LMV43OSLTON2WKQ3PNVWWK3TUHMZDCNZQGQ4TAOJRGE> . You are receiving this because you authored the thread.Message ID: ***@***.***>\r\n\r\nThis worked for me.\nThere hasn't been any activity on this issue recently. Due to the high number of incoming GitHub notifications, we have to clean some of the old issues, as many of them have already been resolved with the latest updates.\nPlease make sure to update to the latest Home Assistant version and check if that solves the issue. Let us know if that works for you by adding a comment \ud83d\udc4d\nThis issue has now been marked as stale and will be closed if no further activity occurs. Thank you for your contributions.\nHey there @Jc2k, @bdraco, mind taking a look at this issue as it has been labeled with an integration (homekit_controller) you are listed as a [code owner](https://github.com/home-assistant/core/blob/dev/CODEOWNERS#L607) for? Thanks!\nThere hasn't been any activity on this issue recently. Due to the high number of incoming GitHub notifications, we have to clean some of the old issues, as many of them have already been resolved with the latest updates.\nPlease make sure to update to the latest Home Assistant version and check if that solves the issue. Let us know if that works for you by adding a comment \ud83d\udc4d\nThis issue has now been marked as stale and will be closed if no further activity occurs. Thank you for your contributions.\nHey there @Jc2k, @bdraco, mind taking a look at this issue as it has been labeled with an integration (homekit_controller) you are listed as a [code owner](https://github.com/home-assistant/core/blob/dev/CODEOWNERS#L607) for? Thanks!", "created_at": "2024-12-15T15:01:41Z"}
{"repo": "home-assistant/core", "pull_number": 133228, "instance_id": "home-assistant__core-133228", "issue_numbers": ["132865"], "base_commit": "308200781f16b7f4a75f45c8b7705361852e76d0", "patch": "diff --git a/homeassistant/components/recorder/history/modern.py b/homeassistant/components/recorder/history/modern.py\nindex 9159bbc6181e54..279ca9c9eea513 100644\n--- a/homeassistant/components/recorder/history/modern.py\n+++ b/homeassistant/components/recorder/history/modern.py\n@@ -27,8 +27,13 @@\n from homeassistant.helpers.recorder import get_instance\n import homeassistant.util.dt as dt_util\n \n-from ..const import LAST_REPORTED_SCHEMA_VERSION\n-from ..db_schema import SHARED_ATTR_OR_LEGACY_ATTRIBUTES, StateAttributes, States\n+from ..const import LAST_REPORTED_SCHEMA_VERSION, SupportedDialect\n+from ..db_schema import (\n+    SHARED_ATTR_OR_LEGACY_ATTRIBUTES,\n+    StateAttributes,\n+    States,\n+    StatesMeta,\n+)\n from ..filters import Filters\n from ..models import (\n     LazyState,\n@@ -145,6 +150,7 @@ def _significant_states_stmt(\n     no_attributes: bool,\n     include_start_time_state: bool,\n     run_start_ts: float | None,\n+    lateral_join_for_start_time: bool,\n ) -> Select | CompoundSelect:\n     \"\"\"Query the database for significant state changes.\"\"\"\n     include_last_changed = not significant_changes_only\n@@ -184,6 +190,7 @@ def _significant_states_stmt(\n                 metadata_ids,\n                 no_attributes,\n                 include_last_changed,\n+                lateral_join_for_start_time,\n             ).subquery(),\n             no_attributes,\n             include_last_changed,\n@@ -254,6 +261,7 @@ def get_significant_states_with_session(\n     start_time_ts = start_time.timestamp()\n     end_time_ts = datetime_to_timestamp_or_none(end_time)\n     single_metadata_id = metadata_ids[0] if len(metadata_ids) == 1 else None\n+    lateral_join_for_start_time = instance.dialect_name == SupportedDialect.POSTGRESQL\n     stmt = lambda_stmt(\n         lambda: _significant_states_stmt(\n             start_time_ts,\n@@ -265,6 +273,7 @@ def get_significant_states_with_session(\n             no_attributes,\n             include_start_time_state,\n             run_start_ts,\n+            lateral_join_for_start_time,\n         ),\n         track_on=[\n             bool(single_metadata_id),\n@@ -556,30 +565,61 @@ def _get_start_time_state_for_entities_stmt(\n     metadata_ids: list[int],\n     no_attributes: bool,\n     include_last_changed: bool,\n+    lateral_join_for_start_time: bool,\n ) -> Select:\n     \"\"\"Baked query to get states for specific entities.\"\"\"\n     # We got an include-list of entities, accelerate the query by filtering already\n     # in the inner and the outer query.\n+    if lateral_join_for_start_time:\n+        # PostgreSQL does not support index skip scan/loose index scan\n+        # https://wiki.postgresql.org/wiki/Loose_indexscan\n+        # so we need to do a lateral join to get the max last_updated_ts\n+        # for each metadata_id as a group-by is too slow.\n+        # https://github.com/home-assistant/core/issues/132865\n+        max_metadata_id = StatesMeta.metadata_id.label(\"max_metadata_id\")\n+        max_last_updated = (\n+            select(func.max(States.last_updated_ts))\n+            .where(\n+                (States.metadata_id == max_metadata_id)\n+                & (States.last_updated_ts >= run_start_ts)\n+                & (States.last_updated_ts < epoch_time)\n+            )\n+            .subquery()\n+            .lateral()\n+        )\n+        most_recent_states_for_entities_by_date = (\n+            select(max_metadata_id, max_last_updated.c[0].label(\"max_last_updated\"))\n+            .select_from(StatesMeta)\n+            .join(\n+                max_last_updated,\n+                StatesMeta.metadata_id == max_metadata_id,\n+            )\n+            .where(StatesMeta.metadata_id.in_(metadata_ids))\n+        ).subquery()\n+    else:\n+        # Simple group-by for MySQL and SQLite, must use less\n+        # than 1000 metadata_ids in the IN clause for MySQL\n+        # or it will optimize poorly.\n+        most_recent_states_for_entities_by_date = (\n+            select(\n+                States.metadata_id.label(\"max_metadata_id\"),\n+                func.max(States.last_updated_ts).label(\"max_last_updated\"),\n+            )\n+            .filter(\n+                (States.last_updated_ts >= run_start_ts)\n+                & (States.last_updated_ts < epoch_time)\n+                & States.metadata_id.in_(metadata_ids)\n+            )\n+            .group_by(States.metadata_id)\n+            .subquery()\n+        )\n+\n     stmt = (\n         _stmt_and_join_attributes_for_start_state(\n             no_attributes, include_last_changed, False\n         )\n         .join(\n-            (\n-                most_recent_states_for_entities_by_date := (\n-                    select(\n-                        States.metadata_id.label(\"max_metadata_id\"),\n-                        func.max(States.last_updated_ts).label(\"max_last_updated\"),\n-                    )\n-                    .filter(\n-                        (States.last_updated_ts >= run_start_ts)\n-                        & (States.last_updated_ts < epoch_time)\n-                        & States.metadata_id.in_(metadata_ids)\n-                    )\n-                    .group_by(States.metadata_id)\n-                    .subquery()\n-                )\n-            ),\n+            most_recent_states_for_entities_by_date,\n             and_(\n                 States.metadata_id\n                 == most_recent_states_for_entities_by_date.c.max_metadata_id,\n@@ -621,6 +661,7 @@ def _get_start_time_state_stmt(\n     metadata_ids: list[int],\n     no_attributes: bool,\n     include_last_changed: bool,\n+    lateral_join_for_start_time: bool,\n ) -> Select:\n     \"\"\"Return the states at a specific point in time.\"\"\"\n     if single_metadata_id:\n@@ -641,6 +682,7 @@ def _get_start_time_state_stmt(\n         metadata_ids,\n         no_attributes,\n         include_last_changed,\n+        lateral_join_for_start_time,\n     )\n \n \ndiff --git a/homeassistant/components/recorder/statistics.py b/homeassistant/components/recorder/statistics.py\nindex 3f1d5b981e37e5..9e47ca43c5b546 100644\n--- a/homeassistant/components/recorder/statistics.py\n+++ b/homeassistant/components/recorder/statistics.py\n@@ -63,6 +63,7 @@\n     STATISTICS_TABLES,\n     Statistics,\n     StatisticsBase,\n+    StatisticsMeta,\n     StatisticsRuns,\n     StatisticsShortTerm,\n )\n@@ -1669,6 +1670,7 @@ def _augment_result_with_change(\n     drop_sum = \"sum\" not in _types\n     prev_sums = {}\n     if tmp := _statistics_at_time(\n+        hass,\n         session,\n         {metadata[statistic_id][0] for statistic_id in result},\n         table,\n@@ -2032,22 +2034,50 @@ def _generate_statistics_at_time_stmt(\n     metadata_ids: set[int],\n     start_time_ts: float,\n     types: set[Literal[\"last_reset\", \"max\", \"mean\", \"min\", \"state\", \"sum\"]],\n+    lateral_join_for_start_time: bool,\n ) -> StatementLambdaElement:\n     \"\"\"Create the statement for finding the statistics for a given time.\"\"\"\n     stmt = _generate_select_columns_for_types_stmt(table, types)\n-    stmt += lambda q: q.join(\n-        (\n-            most_recent_statistic_ids := (\n-                select(\n-                    func.max(table.start_ts).label(\"max_start_ts\"),\n-                    table.metadata_id.label(\"max_metadata_id\"),\n-                )\n-                .filter(table.start_ts < start_time_ts)\n-                .filter(table.metadata_id.in_(metadata_ids))\n-                .group_by(table.metadata_id)\n-                .subquery()\n+    if lateral_join_for_start_time:\n+        # PostgreSQL does not support index skip scan/loose index scan\n+        # https://wiki.postgresql.org/wiki/Loose_indexscan\n+        # so we need to do a lateral join to get the max max_start_ts\n+        # for each metadata_id as a group-by is too slow.\n+        # https://github.com/home-assistant/core/issues/132865\n+        max_metadata_id = StatisticsMeta.id.label(\"max_metadata_id\")\n+        max_start = (\n+            select(func.max(table.start_ts))\n+            .filter(table.metadata_id == max_metadata_id)\n+            .filter(table.start_ts < start_time_ts)\n+            .filter(table.metadata_id.in_(metadata_ids))\n+            .subquery()\n+            .lateral()\n+        )\n+        most_recent_statistic_ids = (\n+            select(max_metadata_id, max_start.c[0].label(\"max_start_ts\"))\n+            .select_from(StatisticsMeta)\n+            .join(\n+                max_start,\n+                StatisticsMeta.id == max_metadata_id,\n             )\n-        ),\n+            .where(StatisticsMeta.id.in_(metadata_ids))\n+        ).subquery()\n+    else:\n+        # Simple group-by for MySQL and SQLite, must use less\n+        # than 1000 metadata_ids in the IN clause for MySQL\n+        # or it will optimize poorly.\n+        most_recent_statistic_ids = (\n+            select(\n+                func.max(table.start_ts).label(\"max_start_ts\"),\n+                table.metadata_id.label(\"max_metadata_id\"),\n+            )\n+            .filter(table.start_ts < start_time_ts)\n+            .filter(table.metadata_id.in_(metadata_ids))\n+            .group_by(table.metadata_id)\n+            .subquery()\n+        )\n+    stmt += lambda q: q.join(\n+        most_recent_statistic_ids,\n         and_(\n             table.start_ts == most_recent_statistic_ids.c.max_start_ts,\n             table.metadata_id == most_recent_statistic_ids.c.max_metadata_id,\n@@ -2057,6 +2087,7 @@ def _generate_statistics_at_time_stmt(\n \n \n def _statistics_at_time(\n+    hass: HomeAssistant,\n     session: Session,\n     metadata_ids: set[int],\n     table: type[StatisticsBase],\n@@ -2065,7 +2096,11 @@ def _statistics_at_time(\n ) -> Sequence[Row] | None:\n     \"\"\"Return last known statistics, earlier than start_time, for the metadata_ids.\"\"\"\n     start_time_ts = start_time.timestamp()\n-    stmt = _generate_statistics_at_time_stmt(table, metadata_ids, start_time_ts, types)\n+    dialect_name = get_instance(hass).dialect_name\n+    lateral_join_for_start_time = dialect_name == SupportedDialect.POSTGRESQL\n+    stmt = _generate_statistics_at_time_stmt(\n+        table, metadata_ids, start_time_ts, types, lateral_join_for_start_time\n+    )\n     return cast(Sequence[Row], execute_stmt_lambda_element(session, stmt))\n \n \n", "test_patch": "diff --git a/tests/components/recorder/test_history.py b/tests/components/recorder/test_history.py\nindex 28b8275247c876..eea4605039badd 100644\n--- a/tests/components/recorder/test_history.py\n+++ b/tests/components/recorder/test_history.py\n@@ -1014,3 +1014,127 @@ async def test_get_last_state_changes_with_non_existent_entity_ids_returns_empty\n ) -> None:\n     \"\"\"Test get_last_state_changes returns an empty dict when entities not in the db.\"\"\"\n     assert history.get_last_state_changes(hass, 1, \"nonexistent.entity\") == {}\n+\n+\n+@pytest.mark.skip_on_db_engine([\"sqlite\", \"mysql\"])\n+@pytest.mark.usefixtures(\"skip_by_db_engine\")\n+@pytest.mark.usefixtures(\"recorder_db_url\")\n+async def test_get_significant_states_with_session_uses_lateral_with_postgresql(\n+    hass: HomeAssistant, caplog: pytest.LogCaptureFixture\n+) -> None:\n+    \"\"\"Test get_significant_states_with_session uses the lateral path with PostgreSQL.\"\"\"\n+    entity_id = \"media_player.test\"\n+    hass.states.async_set(\"any.other\", \"on\")\n+    await async_wait_recording_done(hass)\n+    hass.states.async_set(entity_id, \"off\")\n+\n+    def set_state(state):\n+        \"\"\"Set the state.\"\"\"\n+        hass.states.async_set(entity_id, state, {\"any\": 1})\n+        return hass.states.get(entity_id)\n+\n+    start = dt_util.utcnow().replace(microsecond=0)\n+    point = start + timedelta(seconds=1)\n+    point2 = start + timedelta(seconds=1, microseconds=100)\n+    point3 = start + timedelta(seconds=1, microseconds=200)\n+    end = point + timedelta(seconds=1, microseconds=400)\n+\n+    with freeze_time(start) as freezer:\n+        set_state(\"idle\")\n+        set_state(\"YouTube\")\n+\n+        freezer.move_to(point)\n+        states = [set_state(\"idle\")]\n+\n+        freezer.move_to(point2)\n+        states.append(set_state(\"Netflix\"))\n+\n+        freezer.move_to(point3)\n+        states.append(set_state(\"Plex\"))\n+\n+        freezer.move_to(end)\n+        set_state(\"Netflix\")\n+        set_state(\"Plex\")\n+    await async_wait_recording_done(hass)\n+\n+    start_time = point2 + timedelta(microseconds=10)\n+    hist = history.get_significant_states(\n+        hass=hass,\n+        start_time=start_time,  # Pick a point where we will generate a start time state\n+        end_time=end,\n+        entity_ids=[entity_id, \"any.other\"],\n+        include_start_time_state=True,\n+    )\n+    assert len(hist[entity_id]) == 2\n+\n+    sqlalchemy_logs = \"\".join(\n+        [\n+            record.getMessage()\n+            for record in caplog.records\n+            if record.name.startswith(\"sqlalchemy.engine\")\n+        ]\n+    )\n+    # We can't patch inside the lambda so we have to check the logs\n+    assert \"JOIN LATERAL\" in sqlalchemy_logs\n+\n+\n+@pytest.mark.skip_on_db_engine([\"postgresql\"])\n+@pytest.mark.usefixtures(\"skip_by_db_engine\")\n+@pytest.mark.usefixtures(\"recorder_db_url\")\n+async def test_get_significant_states_with_session_uses_non_lateral_without_postgresql(\n+    hass: HomeAssistant, caplog: pytest.LogCaptureFixture\n+) -> None:\n+    \"\"\"Test get_significant_states_with_session does not use a the lateral path without PostgreSQL.\"\"\"\n+    entity_id = \"media_player.test\"\n+    hass.states.async_set(\"any.other\", \"on\")\n+    await async_wait_recording_done(hass)\n+    hass.states.async_set(entity_id, \"off\")\n+\n+    def set_state(state):\n+        \"\"\"Set the state.\"\"\"\n+        hass.states.async_set(entity_id, state, {\"any\": 1})\n+        return hass.states.get(entity_id)\n+\n+    start = dt_util.utcnow().replace(microsecond=0)\n+    point = start + timedelta(seconds=1)\n+    point2 = start + timedelta(seconds=1, microseconds=100)\n+    point3 = start + timedelta(seconds=1, microseconds=200)\n+    end = point + timedelta(seconds=1, microseconds=400)\n+\n+    with freeze_time(start) as freezer:\n+        set_state(\"idle\")\n+        set_state(\"YouTube\")\n+\n+        freezer.move_to(point)\n+        states = [set_state(\"idle\")]\n+\n+        freezer.move_to(point2)\n+        states.append(set_state(\"Netflix\"))\n+\n+        freezer.move_to(point3)\n+        states.append(set_state(\"Plex\"))\n+\n+        freezer.move_to(end)\n+        set_state(\"Netflix\")\n+        set_state(\"Plex\")\n+    await async_wait_recording_done(hass)\n+\n+    start_time = point2 + timedelta(microseconds=10)\n+    hist = history.get_significant_states(\n+        hass=hass,\n+        start_time=start_time,  # Pick a point where we will generate a start time state\n+        end_time=end,\n+        entity_ids=[entity_id, \"any.other\"],\n+        include_start_time_state=True,\n+    )\n+    assert len(hist[entity_id]) == 2\n+\n+    sqlalchemy_logs = \"\".join(\n+        [\n+            record.getMessage()\n+            for record in caplog.records\n+            if record.name.startswith(\"sqlalchemy.engine\")\n+        ]\n+    )\n+    # We can't patch inside the lambda so we have to check the logs\n+    assert \"JOIN LATERAL\" not in sqlalchemy_logs\ndiff --git a/tests/components/recorder/test_statistics.py b/tests/components/recorder/test_statistics.py\nindex 6b1e1a655db3c1..55029c3eacfe5b 100644\n--- a/tests/components/recorder/test_statistics.py\n+++ b/tests/components/recorder/test_statistics.py\n@@ -1914,20 +1914,185 @@ def test_cache_key_for_generate_max_mean_min_statistic_in_sub_period_stmt() -> N\n     assert cache_key_1 != cache_key_3\n \n \n-def test_cache_key_for_generate_statistics_at_time_stmt() -> None:\n+@pytest.mark.parametrize(\"lateral_join_for_start_time\", [True, False])\n+def test_cache_key_for_generate_statistics_at_time_stmt(\n+    lateral_join_for_start_time: bool,\n+) -> None:\n     \"\"\"Test cache key for _generate_statistics_at_time_stmt.\"\"\"\n-    stmt = _generate_statistics_at_time_stmt(StatisticsShortTerm, {0}, 0.0, set())\n+    stmt = _generate_statistics_at_time_stmt(\n+        StatisticsShortTerm, {0}, 0.0, set(), lateral_join_for_start_time\n+    )\n     cache_key_1 = stmt._generate_cache_key()\n-    stmt2 = _generate_statistics_at_time_stmt(StatisticsShortTerm, {0}, 0.0, set())\n+    stmt2 = _generate_statistics_at_time_stmt(\n+        StatisticsShortTerm, {0}, 0.0, set(), lateral_join_for_start_time\n+    )\n     cache_key_2 = stmt2._generate_cache_key()\n     assert cache_key_1 == cache_key_2\n     stmt3 = _generate_statistics_at_time_stmt(\n-        StatisticsShortTerm, {0}, 0.0, {\"sum\", \"mean\"}\n+        StatisticsShortTerm,\n+        {0},\n+        0.0,\n+        {\"sum\", \"mean\"},\n+        lateral_join_for_start_time,\n     )\n     cache_key_3 = stmt3._generate_cache_key()\n     assert cache_key_1 != cache_key_3\n \n \n+@pytest.mark.skip_on_db_engine([\"sqlite\", \"mysql\"])\n+@pytest.mark.usefixtures(\"skip_by_db_engine\")\n+@pytest.mark.usefixtures(\"recorder_db_url\")\n+@pytest.mark.freeze_time(\"2022-10-01 00:00:00+00:00\")\n+async def test_statistics_at_time_uses_lateral_query_with_postgresql(\n+    hass: HomeAssistant,\n+    setup_recorder: None,\n+    caplog: pytest.LogCaptureFixture,\n+) -> None:\n+    \"\"\"Test statistics_at_time uses a lateral query with PostgreSQL.\"\"\"\n+    await async_wait_recording_done(hass)\n+    assert \"Compiling statistics for\" not in caplog.text\n+    assert \"Statistics already compiled\" not in caplog.text\n+\n+    zero = dt_util.utcnow()\n+    period1 = dt_util.as_utc(dt_util.parse_datetime(\"2023-05-08 00:00:00\"))\n+    period2 = dt_util.as_utc(dt_util.parse_datetime(\"2023-05-08 01:00:00\"))\n+    period3 = dt_util.as_utc(dt_util.parse_datetime(\"2023-05-08 02:00:00\"))\n+    period4 = dt_util.as_utc(dt_util.parse_datetime(\"2023-05-08 03:00:00\"))\n+\n+    external_statistics = (\n+        {\n+            \"start\": period1,\n+            \"last_reset\": None,\n+            \"state\": 0,\n+            \"sum\": 2,\n+        },\n+        {\n+            \"start\": period2,\n+            \"last_reset\": None,\n+            \"state\": 1,\n+            \"sum\": 3,\n+        },\n+        {\n+            \"start\": period3,\n+            \"last_reset\": None,\n+            \"state\": 2,\n+            \"sum\": 5,\n+        },\n+        {\n+            \"start\": period4,\n+            \"last_reset\": None,\n+            \"state\": 3,\n+            \"sum\": 8,\n+        },\n+    )\n+    external_metadata = {\n+        \"has_mean\": False,\n+        \"has_sum\": True,\n+        \"name\": \"Total imported energy\",\n+        \"source\": \"recorder\",\n+        \"statistic_id\": \"sensor.total_energy_import\",\n+        \"unit_of_measurement\": \"kWh\",\n+    }\n+\n+    async_import_statistics(hass, external_metadata, external_statistics)\n+    await async_wait_recording_done(hass)\n+    # Get change from far in the past\n+    stats = statistics_during_period(\n+        hass,\n+        zero,\n+        period=\"hour\",\n+        statistic_ids={\"sensor.total_energy_import\"},\n+        types={\"change\", \"sum\"},\n+    )\n+    assert stats\n+    sqlalchemy_logs = \"\".join(\n+        [\n+            record.getMessage()\n+            for record in caplog.records\n+            if record.name.startswith(\"sqlalchemy.engine\")\n+        ]\n+    )\n+    # We can't patch inside the lambda so we have to check the logs\n+    assert \"JOIN LATERAL\" in sqlalchemy_logs\n+\n+\n+@pytest.mark.skip_on_db_engine([\"postgresql\"])\n+@pytest.mark.usefixtures(\"skip_by_db_engine\")\n+@pytest.mark.usefixtures(\"recorder_db_url\")\n+@pytest.mark.freeze_time(\"2022-10-01 00:00:00+00:00\")\n+async def test_statistics_at_time_uses_non_lateral_query_without_postgresql(\n+    hass: HomeAssistant,\n+    setup_recorder: None,\n+    caplog: pytest.LogCaptureFixture,\n+) -> None:\n+    \"\"\"Test statistics_at_time does not use a lateral query without PostgreSQL.\"\"\"\n+    await async_wait_recording_done(hass)\n+    assert \"Compiling statistics for\" not in caplog.text\n+    assert \"Statistics already compiled\" not in caplog.text\n+\n+    zero = dt_util.utcnow()\n+    period1 = dt_util.as_utc(dt_util.parse_datetime(\"2023-05-08 00:00:00\"))\n+    period2 = dt_util.as_utc(dt_util.parse_datetime(\"2023-05-08 01:00:00\"))\n+    period3 = dt_util.as_utc(dt_util.parse_datetime(\"2023-05-08 02:00:00\"))\n+    period4 = dt_util.as_utc(dt_util.parse_datetime(\"2023-05-08 03:00:00\"))\n+\n+    external_statistics = (\n+        {\n+            \"start\": period1,\n+            \"last_reset\": None,\n+            \"state\": 0,\n+            \"sum\": 2,\n+        },\n+        {\n+            \"start\": period2,\n+            \"last_reset\": None,\n+            \"state\": 1,\n+            \"sum\": 3,\n+        },\n+        {\n+            \"start\": period3,\n+            \"last_reset\": None,\n+            \"state\": 2,\n+            \"sum\": 5,\n+        },\n+        {\n+            \"start\": period4,\n+            \"last_reset\": None,\n+            \"state\": 3,\n+            \"sum\": 8,\n+        },\n+    )\n+    external_metadata = {\n+        \"has_mean\": False,\n+        \"has_sum\": True,\n+        \"name\": \"Total imported energy\",\n+        \"source\": \"recorder\",\n+        \"statistic_id\": \"sensor.total_energy_import\",\n+        \"unit_of_measurement\": \"kWh\",\n+    }\n+\n+    async_import_statistics(hass, external_metadata, external_statistics)\n+    await async_wait_recording_done(hass)\n+    # Get change from far in the past\n+    stats = statistics_during_period(\n+        hass,\n+        zero,\n+        period=\"hour\",\n+        statistic_ids={\"sensor.total_energy_import\"},\n+        types={\"change\", \"sum\"},\n+    )\n+    assert stats\n+    sqlalchemy_logs = \"\".join(\n+        [\n+            record.getMessage()\n+            for record in caplog.records\n+            if record.name.startswith(\"sqlalchemy.engine\")\n+        ]\n+    )\n+    # We can't patch inside the lambda so we have to check the logs\n+    assert \"JOIN LATERAL\" not in sqlalchemy_logs\n+\n+\n @pytest.mark.parametrize(\"timezone\", [\"America/Regina\", \"Europe/Vienna\", \"UTC\"])\n @pytest.mark.freeze_time(\"2022-10-01 00:00:00+00:00\")\n async def test_change(\n", "problem_statement": "Poor SQL performance finding start time state/stat results in HA Blocking Indefinitely\n### The problem\r\n\r\nRandomly, I've yet to see a pattern, HA statistics will get stuck - nothing will update, no graphs, metrcis, etc.\r\n\r\nDigging into the SQL console, there will be a massive query that is chewing up CPU, and executing forever.   Killing this process seems to unblock it.  However it will randomly return.\r\n\r\n### What version of Home Assistant Core has the issue?\r\n\r\ncore-2024.12.1\r\n\r\n### What was the last working version of Home Assistant Core?\r\n\r\n_No response_\r\n\r\n### What type of installation are you running?\r\n\r\nHome Assistant Container\r\n\r\n### Integration causing the issue\r\n\r\n_No response_\r\n\r\n### Link to integration documentation on our website\r\n\r\n_No response_\r\n\r\n### Diagnostics information\r\n\r\n_No response_\r\n\r\n### Example YAML snippet\r\n\r\n_No response_\r\n\r\n### Anything in the logs that might be useful for us?\r\n\r\n```txt\r\nHere are some examples from the slow query log - it appears to be doing a full table scan.  Last one in the list is from when I killed it.\r\n\r\nhttps://gist.github.com/thenoid/8bb6f1b90bf40ea6627c1d9f864e6aa5\r\n\r\nRows Scanned : 27709990\r\n```\r\nIt feels like a race condition, in that it works *alot of the time* though slowly - but just will randomly get stuck.\r\n\r\n\r\n### Additional information\r\n\r\nI see other issues that were closed as stale referencing the same thing, seems like @bdraco needs access to the db? I'll gladly figure out something to make it work to help fix this regression.\n", "hints_text": "Stuck again.\r\n\r\n```\r\nmysql> show full processlist \\G;\r\n*************************** 1. row ***************************\r\n      Id: 4\r\n    User: homeassistant\r\n    Host: 172.31.0.1:55022\r\n      db: ha_db\r\n Command: Query\r\n    Time: 5090\r\n   State: Creating sort index\r\n    Info: SELECT anon_1.metadata_id, anon_1.state, anon_1.last_updated_ts, anon_1.attributes \r\nFROM (SELECT anon_2.metadata_id AS metadata_id, anon_2.state AS state, anon_2.last_updated_ts AS last_updated_ts, anon_2.attributes AS attributes \r\nFROM (SELECT states.metadata_id AS metadata_id, states.state AS state, 0 AS last_updated_ts, CASE WHEN (state_attributes.shared_attrs IS NULL) THEN states.attributes ELSE state_attributes.shared_attrs END AS attributes \r\nFROM states INNER JOIN (SELECT states.metadata_id AS max_metadata_id, max(states.last_updated_ts) AS max_last_updated \r\nFROM states \r\nWHERE states.last_updated_ts >= 1732708152.6401002e0 AND states.last_updated_ts < 1733831399.999999e0 AND states.metadata_id IN (222, 223, 224, 246, 248, 251, 50501, 50518, 50535, 50564, 50581, 50598, 31965, 31966, 31967, 31968, 31969, 235, 236, 237, 238, 239, 302, 303, 304, 305, 306, 307, 32006, 299, 300, 32141, 32199, 32134, 32204, 32208, 32209, 32210, 32214, 32215, 32216, 32220, 32221, 32222, 32226, 32227, 32228, 32232, 32233, 32234, 32238, 32239, 32240, 32244, 32245, 32081, 32085, 32086, 32087, 32091, 32092, 32093, 32097, 32098, 32099, 32103, 32104, 32105, 32109, 32110, 32111, 32115, 32116, 32117, 32121, 32122, 32146, 32150, 32151, 32152, 32156, 32157, 32158, 32162, 32163, 32164, 32168, 32169, 32170, 32174, 32175, 32176, 32180, 32181, 32182, 32186, 32187, 32030, 32034, 32035, 32036, 32040, 32041, 32042, 32046, 32047, 32048, 32052, 32053, 32054, 32058, 32059, 32060, 32064, 32065, 32066, 32070, 32071, 49788, 49792, 49793, 49794, 49798, 49799, 49800, 49804, 49805, 49806, 49810, 49811, 49812, 49816, 49817, 49818, 49822, 49823, 49824, 49828, 49829, 32307, 32308, 32310, 32371, 389, 49770, 391, 49772, 394, 395, 397, 10809, 10810, 34465, 10814, 10812, 10813, 10816, 10817, 10818, 42219, 42217, 42221, 42222, 49716, 42223, 10826, 10828, 10830, 45857, 10831, 10832, 10833, 10834, 42224, 45850, 10837, 10839, 10838, 10840, 10836, 10842, 10843, 10844, 50378, 10845, 10846, 49717, 49971, 42226, 10851, 42227, 49975, 10909, 10854, 10855, 42228, 42229, 10858, 10859, 42230, 10861, 42231, 10864, 34537, 42232, 10867, 49842, 50294, 10869, 10870, 42233, 42234, 10874, 49718, 10878, 10880, 10881, 42236, 10883, 10884, 10885, 49720, 49721, 10890, 10891, 10893, 50675, 50394, 10898, 42238, 49722, 49723, 50297, 10902, 10903, 10904, 10905, 42239, 49785, 42240, 10825, 42242, 10913, 45592, 10916, 45565, 50412, 10919, 42541, 10920, 10921, 45895, 10923, 42243, 10926, 10927, 49728, 49724, 42246, 10931, 10933, 42247, 42248, 42249, 42250, 10972, 49725, 49726, 10940, 42253, 49727, 10943, 42254, 10966, 10945, 10960, 49719, 10911, 10922, 42220, 45556, 10822, 10985, 10895, 34469, 10824, 34473, 10841, 34474, 10872, 10853, 34475, 10906, 10934, 10957, 34486, 34493, 34501, 34505, 10970, 34545, 10971, 34557, 10975, 34559, 34561, 34568, 45263, 45270, 45273, 45302, 45534, 45537, 45540, 45543, 45546, 45549, 45553, 45559, 45562, 45567, 45571, 45581, 45584, 45590, 45596, 10924, 45603, 45750, 45760, 10961, 11008, 10962, 42241, 10954, 10900, 45752, 10965, 10946, 45754, 10980, 45867, 45880, 45885, 10964, 10974, 45893, 49843, 45897, 42244, 45899, 45901, 45903, 45905, 45907, 45909, 45931, 45948, 45950, 45952, 45954, 45956, 45963, 45965, 45967, 45972, 45974, 45976, 45978, 45980, 45987, 45989, 45991, 45993, 45995, 45997, 45999, 46001, 46003, 46005, 46007, 46009, 46011, 46013, 46015, 46017, 46019, 46021, 46023, 46025, 46027, 46029, 46031, 46033, 46035, 46037, 46039, 46041, 46043, 46045, 46047, 46049, 46051, 46086, 46088, 46090, 46092, 46094, 46096, 46098, 46100, 49962, 49967, 46102, 46104, 50008, 50011, 50013, 50015, 50022, 50043, 50062, 50071, 50073, 50076, 50106, 50114, 50165, 50170, 50173, 50309, 50312, 50331, 50335, 50344, 50346, 50354, 50357, 50360, 50363, 50366, 50369, 50373, 50375, 50391, 50397, 50402, 50409, 50415, 50418, 50475, 50478, 50481, 50484, 50487, 50606, 50616, 50619, 50621, 50625, 50668, 21117, 21118, 34466, 21122, 21120, 21121, 21124, 21125, 21126, 42257, 42255, 42259, 42260, 49729, 42261, 21134, 21136, 21138, 45858, 21139, 21140, 21141, 21142, 42262, 45851, 21145, 21147, 21146, 21148, 21144, 21150, 21151, 21152, 50379, 21153, 21154, 49730, 49972, 42264, 21159, 42265, 49976, 21217, 21162, 21163, 42266, 42267, 21166, 21167, 42268, 21169, 42269, 21172, 34538, 42270, 21175, 49844, 50295, 21177, 21178, 42271, 42272, 21182, 49731, 21186, 21188, 21189, 42274, 21191, 21192, 21193, 49733, 49734, 21198, 21199, 21201, 50676, 50395, 21206, 42276, 49735, 49736, 50298, 21210, 21211, 21212, 21213, 42277, 49786, 42278, 21133, 42280, 21221, 45593, 21224, 45566, 50413, 21227, 42542, 21228, 21229, 45896, 21231, 42281, 21234, 21235, 49741, 49737, 42284, 21239, 21241, 42285, 42286, 42287, 42288, 21280, 49738, 49739, 21248, 42291, 49740, 21251, 42292, 21274, 21253, 21268, 49732, 21219, 21230, 42258, 45557, 21130, 21293, 21203, 34470, 21132, 34477, 21149, 34478, 21180, 21161, 34479, 21214, 21242, 21265, 34487, 34494, 34502, 34506, 21278, 34546, 21279, 34558, 21283, 34560, 34562, 34569, 45264, 45271, 45274, 45303, 45535, 45538, 45541, 45544, 45547, 45550, 45554, 45560, 45563, 45568, 45572, 45582, 45585, 45591, 45597, 21232, 45604, 45751, 45761, 21269, 21316, 21270, 42279, 21262, 21208, 45753, 21273, 21254, 45755, 21288, 45868, 45881, 45886, 21272, 21282, 45894, 49845, 45898, 42282, 45900, 45902, 45904, 45906, 45908, 45910, 45932, 45949, 45951, 45953, 45955, 45957, 45964, 45966, 45968, 45973, 45975, 45977, 45979, 45981, 45988, 45990, 45992, 45994, 45996, 45998, 46000, 46002, 46004, 46006, 46008, 46010, 46012, 46014, 46016, 46018, 46020, 46022, 46024, 46026, 46028, 46030, 46032, 46034, 46036, 46038, 46040, 46042, 46044, 46046, 46048, 46050, 46052, 46087, 46089, 46091, 46093, 46095, 46097, 46099, 46101, 49963, 49968, 46103, 46105, 50009, 50012, 50014, 50016, 50023, 50044, 50063, 50072, 50074, 50077, 50107, 50115, 50166, 50171, 50174, 50310, 50313, 50332, 50336, 50345, 50347, 50355, 50358, 50361, 50364, 50367, 50370, 50374, 50376, 50392, 50398, 50403, 50410, 50416, 50419, 50476, 50479, 50482, 50485, 50488, 50607, 50617, 50620, 50622, 50626, 50669, 31525, 31526, 31527, 31528, 31571, 49965, 31574, 31573, 31575, 50329, 31576, 31577, 31579, 31578, 31572, 31581, 31582, 31583, 31584, 31585, 31586, 31587, 31588, 49966, 31591, 31590, 31592, 50330, 31593, 31594, 31596, 31595, 31589, 31598, 31599, 31600, 31601, 31602, 31603, 31604, 31808, 31813, 31826, 31829, 31825, 371, 45941, 45942, 48118, 48119, 31763, 31764, 31774, 31775, 48075, 48076, 48105, 48106, 31769, 31770, 48048, 48049, 48134, 48135, 45918, 45919, 31758, 31759, 31784, 31785, 31786, 31787, 31788, 31789, 31790, 31791, 316, 317, 318, 323, 32611, 32612, 32615, 32616, 32617, 32618, 32619, 32620, 32621, 32623, 32627, 32629, 32631, 32633, 32634, 33374, 33382, 33383, 33384, 33395, 33396, 33397, 33398, 33399, 33400, 33402, 33408, 33410, 33409, 33411, 33415, 33420, 33421, 33422, 33427, 33429, 33430, 33431, 33436, 33439, 33442, 33443, 33444, 33451, 33452, 33453, 33460, 33461, 33462, 33469, 33472, 33473, 33474, 33475, 33476, 33478, 33484, 33486, 33487, 33488, 33489, 33493, 33495, 33496, 33497, 33498, 33502, 33504, 33505, 33506, 33507, 33511, 33513, 33514, 33516, 33520, 33523, 33003, 32975, 32979, 33146, 33147, 33148, 33149, 33150, 33151, 33152, 33153, 33154, 45842, 33102, 33105, 33106, 31922, 31927, 31932, 31937, 31942, 31947, 31948, 32906, 32910, 32938, 32942, 45763, 32995, 32996, 32997, 32998, 45612, 32988, 32989, 32990, 32991, 45766, 33004, 33005, 33006, 33007, 33012, 33013, 33014, 33011, 33172, 33173, 33174, 33175, 33176, 33177, 33178, 33179, 33180, 33181, 33182, 33183, 33184, 33185, 33186, 33187, 33188, 33189, 33190, 33191, 33192, 33193, 33194, 33195, 33160, 33161, 33162, 33163, 33164, 33165, 33166, 33167, 33113, 33114, 33115, 33116, 33117, 33118, 33119, 33120, 33121, 33122, 33123, 33124, 33125, 33126, 33127, 33128, 33129, 33130, 33131, 33216, 33217, 33218, 33219, 33220, 33221, 33222, 33223, 33224, 33225, 33226, 33227, 33235, 33236, 33237, 33238, 33239, 33240, 33241, 33242, 33243, 33244, 33245, 33246, 33247, 33248, 33249, 33261, 33264, 33265, 33985, 33995, 34002, 34009, 33794, 33795, 33796, 33797, 33798, 33799, 32702, 32703, 32704, 32706, 32707, 32708, 32709, 32710, 32711, 32712, 32713, 32714, 32715, 32716, 33547, 33548, 32717, 32720, 32721, 32722, 32723, 32724, 32725, 32726, 32727, 32728, 32729, 32732, 50094, 50095, 50096, 50097, 50098, 50099, 50100, 50101, 50102, 50103, 50104, 50105, 32738, 32739, 32740, 32749, 32750, 32751, 32752, 32753, 32755, 32757, 35876, 35877, 35878, 35879, 49980, 49984, 49989, 49994, 50161, 50025, 50026, 50027, 50028, 50029, 50031, 50059, 34509, 34510, 34511, 34512, 34513, 34514, 34516, 34517, 34518, 34519, 34520, 34521, 34523, 34530, 34531, 34532, 34533, 34534, 33365, 33366, 33367, 33368, 34398, 34402, 34403, 34404, 34419, 34422, 34423, 34424, 34425, 34426, 34427, 34429, 34432, 34433, 34434, 34440, 34442, 34443, 34446, 34448, 34450, 34451, 34453, 34456, 34499, 34553, 34599, 34604, 34638, 34669, 34693, 34728, 34766, 34768, 34772, 34787, 34808, 34941, 34949, 34972, 34979, 34987, 34999, 35004, 35015, 35017, 35019, 35021, 35026, 35029, 35034, 35036, 35041, 35043, 35045, 35052, 35057, 35059, 33369, 35061, 35063, 35065, 35081, 35089, 35093, 35095, 35114, 35119, 35121, 35123, 35125, 35127, 35129, 35131, 35136, 35138, 35140, 35142, 35144, 35155, 35181, 35186, 35191, 35211, 35213, 35215, 35222, 35224, 35232, 35234, 35236, 35238, 35240, 35248, 35259, 35268, 35279, 35281, 35283, 35285, 35287, 35289, 35291, 35296, 35298, 35300, 35302, 35304, 35320, 35322, 35324, 35326, 35328, 35330, 35332, 35334, 35336, 35338, 35340, 35342, 35344, 35346, 35348, 35350, 35352, 35354, 35356, 35358, 35360, 35362, 35364, 35366, 35368, 35370, 35372, 35373, 35376, 35378, 35380, 35382, 35384, 35386, 35391, 35393, 35395, 33987, 33986, 33988, 35398, 35400, 35402, 35404, 35406, 35408, 35410, 35412, 35414, 35416, 35418, 35420, 35422, 35424, 35426, 35428, 35430, 35432, 35434, 35436, 35438, 35440, 35442, 35444, 35447, 35449, 35451, 35453, 35455, 35457, 35459, 35461, 35463, 35465, 35466, 35468, 35470, 43835, 45575, 45577, 45871, 45873, 45875, 45877, 45879, 45884, 45889, 49847, 49851, 49852, 49853, 49857, 49858, 49859, 49863, 49864, 49865, 49869, 49870, 49871, 49875, 49876, 49877, 49881, 49882, 49883, 49887, 49888, 50021, 50033, 50035, 50037, 50039, 50129, 50131, 50133, 50169, 50179, 50340, 50387, 50390, 50406, 50450, 50452, 50454, 50471, 50473, 50491, 50615, 50667, 50672, 50674, 50679) GROUP BY states.metadata_id) AS anon_3 ON states.metadata_id = anon_3.max_metadata_id AND states.last_updated_ts = anon_3.max_last_updated LEFT OUTER JOIN state_attributes ON states.attributes_id = state_attributes.attributes_id \r\nWHERE states.last_updated_ts >= 1732708152.6401002e0 AND states.last_updated_ts < 1733831399.999999e0 AND states.metadata_id IN (222, 223, 224, 246, 248, 251, 50501, 50518, 50535, 50564, 50581, 50598, 31965, 31966, 31967, 31968, 31969, 235, 236, 237, 238, 239, 302, 303, 304, 305, 306, 307, 32006, 299, 300, 32141, 32199, 32134, 32204, 32208, 32209, 32210, 32214, 32215, 32216, 32220, 32221, 32222, 32226, 32227, 32228, 32232, 32233, 32234, 32238, 32239, 32240, 32244, 32245, 32081, 32085, 32086, 32087, 32091, 32092, 32093, 32097, 32098, 32099, 32103, 32104, 32105, 32109, 32110, 32111, 32115, 32116, 32117, 32121, 32122, 32146, 32150, 32151, 32152, 32156, 32157, 32158, 32162, 32163, 32164, 32168, 32169, 32170, 32174, 32175, 32176, 32180, 32181, 32182, 32186, 32187, 32030, 32034, 32035, 32036, 32040, 32041, 32042, 32046, 32047, 32048, 32052, 32053, 32054, 32058, 32059, 32060, 32064, 32065, 32066, 32070, 32071, 49788, 49792, 49793, 49794, 49798, 49799, 49800, 49804, 49805, 49806, 49810, 49811, 49812, 49816, 49817, 49818, 49822, 49823, 49824, 49828, 49829, 32307, 32308, 32310, 32371, 389, 49770, 391, 49772, 394, 395, 397, 10809, 10810, 34465, 10814, 10812, 10813, 10816, 10817, 10818, 42219, 42217, 42221, 42222, 49716, 42223, 10826, 10828, 10830, 45857, 10831, 10832, 10833, 10834, 42224, 45850, 10837, 10839, 10838, 10840, 10836, 10842, 10843, 10844, 50378, 10845, 10846, 49717, 49971, 42226, 10851, 42227, 49975, 10909, 10854, 10855, 42228, 42229, 10858, 10859, 42230, 10861, 42231, 10864, 34537, 42232, 10867, 49842, 50294, 10869, 10870, 42233, 42234, 10874, 49718, 10878, 10880, 10881, 42236, 10883, 10884, 10885, 49720, 49721, 10890, 10891, 10893, 50675, 50394, 10898, 42238, 49722, 49723, 50297, 10902, 10903, 10904, 10905, 42239, 49785, 42240, 10825, 42242, 10913, 45592, 10916, 45565, 50412, 10919, 42541, 10920, 10921, 45895, 10923, 42243, 10926, 10927, 49728, 49724, 42246, 10931, 10933, 42247, 42248, 42249, 42250, 10972, 49725, 49726, 10940, 42253, 49727, 10943, 42254, 10966, 10945, 10960, 49719, 10911, 10922, 42220, 45556, 10822, 10985, 10895, 34469, 10824, 34473, 10841, 34474, 10872, 10853, 34475, 10906, 10934, 10957, 34486, 34493, 34501, 34505, 10970, 34545, 10971, 34557, 10975, 34559, 34561, 34568, 45263, 45270, 45273, 45302, 45534, 45537, 45540, 45543, 45546, 45549, 45553, 45559, 45562, 45567, 45571, 45581, 45584, 45590, 45596, 10924, 45603, 45750, 45760, 10961, 11008, 10962, 42241, 10954, 10900, 45752, 10965, 10946, 45754, 10980, 45867, 45880, 45885, 10964, 10974, 45893, 49843, 45897, 42244, 45899, 45901, 45903, 45905, 45907, 45909, 45931, 45948, 45950, 45952, 45954, 45956, 45963, 45965, 45967, 45972, 45974, 45976, 45978, 45980, 45987, 45989, 45991, 45993, 45995, 45997, 45999, 46001, 46003, 46005, 46007, 46009, 46011, 46013, 46015, 46017, 46019, 46021, 46023, 46025, 46027, 46029, 46031, 46033, 46035, 46037, 46039, 46041, 46043, 46045, 46047, 46049, 46051, 46086, 46088, 46090, 46092, 46094, 46096, 46098, 46100, 49962, 49967, 46102, 46104, 50008, 50011, 50013, 50015, 50022, 50043, 50062, 50071, 50073, 50076, 50106, 50114, 50165, 50170, 50173, 50309, 50312, 50331, 50335, 50344, 50346, 50354, 50357, 50360, 50363, 50366, 50369, 50373, 50375, 50391, 50397, 50402, 50409, 50415, 50418, 50475, 50478, 50481, 50484, 50487, 50606, 50616, 50619, 50621, 50625, 50668, 21117, 21118, 34466, 21122, 21120, 21121, 21124, 21125, 21126, 42257, 42255, 42259, 42260, 49729, 42261, 21134, 21136, 21138, 45858, 21139, 21140, 21141, 21142, 42262, 45851, 21145, 21147, 21146, 21148, 21144, 21150, 21151, 21152, 50379, 21153, 21154, 49730, 49972, 42264, 21159, 42265, 49976, 21217, 21162, 21163, 42266, 42267, 21166, 21167, 42268, 21169, 42269, 21172, 34538, 42270, 21175, 49844, 50295, 21177, 21178, 42271, 42272, 21182, 49731, 21186, 21188, 21189, 42274, 21191, 21192, 21193, 49733, 49734, 21198, 21199, 21201, 50676, 50395, 21206, 42276, 49735, 49736, 50298, 21210, 21211, 21212, 21213, 42277, 49786, 42278, 21133, 42280, 21221, 45593, 21224, 45566, 50413, 21227, 42542, 21228, 21229, 45896, 21231, 42281, 21234, 21235, 49741, 49737, 42284, 21239, 21241, 42285, 42286, 42287, 42288, 21280, 49738, 49739, 21248, 42291, 49740, 21251, 42292, 21274, 21253, 21268, 49732, 21219, 21230, 42258, 45557, 21130, 21293, 21203, 34470, 21132, 34477, 21149, 34478, 21180, 21161, 34479, 21214, 21242, 21265, 34487, 34494, 34502, 34506, 21278, 34546, 21279, 34558, 21283, 34560, 34562, 34569, 45264, 45271, 45274, 45303, 45535, 45538, 45541, 45544, 45547, 45550, 45554, 45560, 45563, 45568, 45572, 45582, 45585, 45591, 45597, 21232, 45604, 45751, 45761, 21269, 21316, 21270, 42279, 21262, 21208, 45753, 21273, 21254, 45755, 21288, 45868, 45881, 45886, 21272, 21282, 45894, 49845, 45898, 42282, 45900, 45902, 45904, 45906, 45908, 45910, 45932, 45949, 45951, 45953, 45955, 45957, 45964, 45966, 45968, 45973, 45975, 45977, 45979, 45981, 45988, 45990, 45992, 45994, 45996, 45998, 46000, 46002, 46004, 46006, 46008, 46010, 46012, 46014, 46016, 46018, 46020, 46022, 46024, 46026, 46028, 46030, 46032, 46034, 46036, 46038, 46040, 46042, 46044, 46046, 46048, 46050, 46052, 46087, 46089, 46091, 46093, 46095, 46097, 46099, 46101, 49963, 49968, 46103, 46105, 50009, 50012, 50014, 50016, 50023, 50044, 50063, 50072, 50074, 50077, 50107, 50115, 50166, 50171, 50174, 50310, 50313, 50332, 50336, 50345, 50347, 50355, 50358, 50361, 50364, 50367, 50370, 50374, 50376, 50392, 50398, 50403, 50410, 50416, 50419, 50476, 50479, 50482, 50485, 50488, 50607, 50617, 50620, 50622, 50626, 50669, 31525, 31526, 31527, 31528, 31571, 49965, 31574, 31573, 31575, 50329, 31576, 31577, 31579, 31578, 31572, 31581, 31582, 31583, 31584, 31585, 31586, 31587, 31588, 49966, 31591, 31590, 31592, 50330, 31593, 31594, 31596, 31595, 31589, 31598, 31599, 31600, 31601, 31602, 31603, 31604, 31808, 31813, 31826, 31829, 31825, 371, 45941, 45942, 48118, 48119, 31763, 31764, 31774, 31775, 48075, 48076, 48105, 48106, 31769, 31770, 48048, 48049, 48134, 48135, 45918, 45919, 31758, 31759, 31784, 31785, 31786, 31787, 31788, 31789, 31790, 31791, 316, 317, 318, 323, 32611, 32612, 32615, 32616, 32617, 32618, 32619, 32620, 32621, 32623, 32627, 32629, 32631, 32633, 32634, 33374, 33382, 33383, 33384, 33395, 33396, 33397, 33398, 33399, 33400, 33402, 33408, 33410, 33409, 33411, 33415, 33420, 33421, 33422, 33427, 33429, 33430, 33431, 33436, 33439, 33442, 33443, 33444, 33451, 33452, 33453, 33460, 33461, 33462, 33469, 33472, 33473, 33474, 33475, 33476, 33478, 33484, 33486, 33487, 33488, 33489, 33493, 33495, 33496, 33497, 33498, 33502, 33504, 33505, 33506, 33507, 33511, 33513, 33514, 33516, 33520, 33523, 33003, 32975, 32979, 33146, 33147, 33148, 33149, 33150, 33151, 33152, 33153, 33154, 45842, 33102, 33105, 33106, 31922, 31927, 31932, 31937, 31942, 31947, 31948, 32906, 32910, 32938, 32942, 45763, 32995, 32996, 32997, 32998, 45612, 32988, 32989, 32990, 32991, 45766, 33004, 33005, 33006, 33007, 33012, 33013, 33014, 33011, 33172, 33173, 33174, 33175, 33176, 33177, 33178, 33179, 33180, 33181, 33182, 33183, 33184, 33185, 33186, 33187, 33188, 33189, 33190, 33191, 33192, 33193, 33194, 33195, 33160, 33161, 33162, 33163, 33164, 33165, 33166, 33167, 33113, 33114, 33115, 33116, 33117, 33118, 33119, 33120, 33121, 33122, 33123, 33124, 33125, 33126, 33127, 33128, 33129, 33130, 33131, 33216, 33217, 33218, 33219, 33220, 33221, 33222, 33223, 33224, 33225, 33226, 33227, 33235, 33236, 33237, 33238, 33239, 33240, 33241, 33242, 33243, 33244, 33245, 33246, 33247, 33248, 33249, 33261, 33264, 33265, 33985, 33995, 34002, 34009, 33794, 33795, 33796, 33797, 33798, 33799, 32702, 32703, 32704, 32706, 32707, 32708, 32709, 32710, 32711, 32712, 32713, 32714, 32715, 32716, 33547, 33548, 32717, 32720, 32721, 32722, 32723, 32724, 32725, 32726, 32727, 32728, 32729, 32732, 50094, 50095, 50096, 50097, 50098, 50099, 50100, 50101, 50102, 50103, 50104, 50105, 32738, 32739, 32740, 32749, 32750, 32751, 32752, 32753, 32755, 32757, 35876, 35877, 35878, 35879, 49980, 49984, 49989, 49994, 50161, 50025, 50026, 50027, 50028, 50029, 50031, 50059, 34509, 34510, 34511, 34512, 34513, 34514, 34516, 34517, 34518, 34519, 34520, 34521, 34523, 34530, 34531, 34532, 34533, 34534, 33365, 33366, 33367, 33368, 34398, 34402, 34403, 34404, 34419, 34422, 34423, 34424, 34425, 34426, 34427, 34429, 34432, 34433, 34434, 34440, 34442, 34443, 34446, 34448, 34450, 34451, 34453, 34456, 34499, 34553, 34599, 34604, 34638, 34669, 34693, 34728, 34766, 34768, 34772, 34787, 34808, 34941, 34949, 34972, 34979, 34987, 34999, 35004, 35015, 35017, 35019, 35021, 35026, 35029, 35034, 35036, 35041, 35043, 35045, 35052, 35057, 35059, 33369, 35061, 35063, 35065, 35081, 35089, 35093, 35095, 35114, 35119, 35121, 35123, 35125, 35127, 35129, 35131, 35136, 35138, 35140, 35142, 35144, 35155, 35181, 35186, 35191, 35211, 35213, 35215, 35222, 35224, 35232, 35234, 35236, 35238, 35240, 35248, 35259, 35268, 35279, 35281, 35283, 35285, 35287, 35289, 35291, 35296, 35298, 35300, 35302, 35304, 35320, 35322, 35324, 35326, 35328, 35330, 35332, 35334, 35336, 35338, 35340, 35342, 35344, 35346, 35348, 35350, 35352, 35354, 35356, 35358, 35360, 35362, 35364, 35366, 35368, 35370, 35372, 35373, 35376, 35378, 35380, 35382, 35384, 35386, 35391, 35393, 35395, 33987, 33986, 33988, 35398, 35400, 35402, 35404, 35406, 35408, 35410, 35412, 35414, 35416, 35418, 35420, 35422, 35424, 35426, 35428, 35430, 35432, 35434, 35436, 35438, 35440, 35442, 35444, 35447, 35449, 35451, 35453, 35455, 35457, 35459, 35461, 35463, 35465, 35466, 35468, 35470, 43835, 45575, 45577, 45871, 45873, 45875, 45877, 45879, 45884, 45889, 49847, 49851, 49852, 49853, 49857, 49858, 49859, 49863, 49864, 49865, 49869, 49870, 49871, 49875, 49876, 49877, 49881, 49882, 49883, 49887, 49888, 50021, 50033, 50035, 50037, 50039, 50129, 50131, 50133, 50169, 50179, 50340, 50387, 50390, 50406, 50450, 50452, 50454, 50471, 50473, 50491, 50615, 50667, 50672, 50674, 50679)) AS anon_2 UNION ALL SELECT anon_4.metadata_id AS metadata_id, anon_4.state AS state, anon_4.last_updated_ts AS last_updated_ts, anon_4.attributes AS attributes \r\nFROM (SELECT states.metadata_id AS metadata_id, states.state AS state, states.last_updated_ts AS last_updated_ts, CASE WHEN (state_attributes.shared_attrs IS NULL) THEN states.attributes ELSE state_attributes.shared_attrs END AS attributes \r\nFROM states LEFT OUTER JOIN state_attributes ON states.attributes_id = state_attributes.attributes_id \r\nWHERE (states.last_changed_ts = states.last_updated_ts OR states.last_changed_ts IS NULL) AND states.metadata_id IN (222, 223, 224, 246, 248, 251, 50501, 50518, 50535, 50564, 50581, 50598, 31965, 31966, 31967, 31968, 31969, 235, 236, 237, 238, 239, 302, 303, 304, 305, 306, 307, 32006, 299, 300, 32141, 32199, 32134, 32204, 32208, 32209, 32210, 32214, 32215, 32216, 32220, 32221, 32222, 32226, 32227, 32228, 32232, 32233, 32234, 32238, 32239, 32240, 32244, 32245, 32081, 32085, 32086, 32087, 32091, 32092, 32093, 32097, 32098, 32099, 32103, 32104, 32105, 32109, 32110, 32111, 32115, 32116, 32117, 32121, 32122, 32146, 32150, 32151, 32152, 32156, 32157, 32158, 32162, 32163, 32164, 32168, 32169, 32170, 32174, 32175, 32176, 32180, 32181, 32182, 32186, 32187, 32030, 32034, 32035, 32036, 32040, 32041, 32042, 32046, 32047, 32048, 32052, 32053, 32054, 32058, 32059, 32060, 32064, 32065, 32066, 32070, 32071, 49788, 49792, 49793, 49794, 49798, 49799, 49800, 49804, 49805, 49806, 49810, 49811, 49812, 49816, 49817, 49818, 49822, 49823, 49824, 49828, 49829, 32307, 32308, 32310, 32371, 389, 49770, 391, 49772, 394, 395, 397, 10809, 10810, 34465, 10814, 10812, 10813, 10816, 10817, 10818, 42219, 42217, 42221, 42222, 49716, 42223, 10826, 10828, 10830, 45857, 10831, 10832, 10833, 10834, 42224, 45850, 10837, 10839, 10838, 10840, 10836, 10842, 10843, 10844, 50378, 10845, 10846, 49717, 49971, 42226, 10851, 42227, 49975, 10909, 10854, 10855, 42228, 42229, 10858, 10859, 42230, 10861, 42231, 10864, 34537, 42232, 10867, 49842, 50294, 10869, 10870, 42233, 42234, 10874, 49718, 10878, 10880, 10881, 42236, 10883, 10884, 10885, 49720, 49721, 10890, 10891, 10893, 50675, 50394, 10898, 42238, 49722, 49723, 50297, 10902, 10903, 10904, 10905, 42239, 49785, 42240, 10825, 42242, 10913, 45592, 10916, 45565, 50412, 10919, 42541, 10920, 10921, 45895, 10923, 42243, 10926, 10927, 49728, 49724, 42246, 10931, 10933, 42247, 42248, 42249, 42250, 10972, 49725, 49726, 10940, 42253, 49727, 10943, 42254, 10966, 10945, 10960, 49719, 10911, 10922, 42220, 45556, 10822, 10985, 10895, 34469, 10824, 34473, 10841, 34474, 10872, 10853, 34475, 10906, 10934, 10957, 34486, 34493, 34501, 34505, 10970, 34545, 10971, 34557, 10975, 34559, 34561, 34568, 45263, 45270, 45273, 45302, 45534, 45537, 45540, 45543, 45546, 45549, 45553, 45559, 45562, 45567, 45571, 45581, 45584, 45590, 45596, 10924, 45603, 45750, 45760, 10961, 11008, 10962, 42241, 10954, 10900, 45752, 10965, 10946, 45754, 10980, 45867, 45880, 45885, 10964, 10974, 45893, 49843, 45897, 42244, 45899, 45901, 45903, 45905, 45907, 45909, 45931, 45948, 45950, 45952, 45954, 45956, 45963, 45965, 45967, 45972, 45974, 45976, 45978, 45980, 45987, 45989, 45991, 45993, 45995, 45997, 45999, 46001, 46003, 46005, 46007, 46009, 46011, 46013, 46015, 46017, 46019, 46021, 46023, 46025, 46027, 46029, 46031, 46033, 46035, 46037, 46039, 46041, 46043, 46045, 46047, 46049, 46051, 46086, 46088, 46090, 46092, 46094, 46096, 46098, 46100, 49962, 49967, 46102, 46104, 50008, 50011, 50013, 50015, 50022, 50043, 50062, 50071, 50073, 50076, 50106, 50114, 50165, 50170, 50173, 50309, 50312, 50331, 50335, 50344, 50346, 50354, 50357, 50360, 50363, 50366, 50369, 50373, 50375, 50391, 50397, 50402, 50409, 50415, 50418, 50475, 50478, 50481, 50484, 50487, 50606, 50616, 50619, 50621, 50625, 50668, 21117, 21118, 34466, 21122, 21120, 21121, 21124, 21125, 21126, 42257, 42255, 42259, 42260, 49729, 42261, 21134, 21136, 21138, 45858, 21139, 21140, 21141, 21142, 42262, 45851, 21145, 21147, 21146, 21148, 21144, 21150, 21151, 21152, 50379, 21153, 21154, 49730, 49972, 42264, 21159, 42265, 49976, 21217, 21162, 21163, 42266, 42267, 21166, 21167, 42268, 21169, 42269, 21172, 34538, 42270, 21175, 49844, 50295, 21177, 21178, 42271, 42272, 21182, 49731, 21186, 21188, 21189, 42274, 21191, 21192, 21193, 49733, 49734, 21198, 21199, 21201, 50676, 50395, 21206, 42276, 49735, 49736, 50298, 21210, 21211, 21212, 21213, 42277, 49786, 42278, 21133, 42280, 21221, 45593, 21224, 45566, 50413, 21227, 42542, 21228, 21229, 45896, 21231, 42281, 21234, 21235, 49741, 49737, 42284, 21239, 21241, 42285, 42286, 42287, 42288, 21280, 49738, 49739, 21248, 42291, 49740, 21251, 42292, 21274, 21253, 21268, 49732, 21219, 21230, 42258, 45557, 21130, 21293, 21203, 34470, 21132, 34477, 21149, 34478, 21180, 21161, 34479, 21214, 21242, 21265, 34487, 34494, 34502, 34506, 21278, 34546, 21279, 34558, 21283, 34560, 34562, 34569, 45264, 45271, 45274, 45303, 45535, 45538, 45541, 45544, 45547, 45550, 45554, 45560, 45563, 45568, 45572, 45582, 45585, 45591, 45597, 21232, 45604, 45751, 45761, 21269, 21316, 21270, 42279, 21262, 21208, 45753, 21273, 21254, 45755, 21288, 45868, 45881, 45886, 21272, 21282, 45894, 49845, 45898, 42282, 45900, 45902, 45904, 45906, 45908, 45910, 45932, 45949, 45951, 45953, 45955, 45957, 45964, 45966, 45968, 45973, 45975, 45977, 45979, 45981, 45988, 45990, 45992, 45994, 45996, 45998, 46000, 46002, 46004, 46006, 46008, 46010, 46012, 46014, 46016, 46018, 46020, 46022, 46024, 46026, 46028, 46030, 46032, 46034, 46036, 46038, 46040, 46042, 46044, 46046, 46048, 46050, 46052, 46087, 46089, 46091, 46093, 46095, 46097, 46099, 46101, 49963, 49968, 46103, 46105, 50009, 50012, 50014, 50016, 50023, 50044, 50063, 50072, 50074, 50077, 50107, 50115, 50166, 50171, 50174, 50310, 50313, 50332, 50336, 50345, 50347, 50355, 50358, 50361, 50364, 50367, 50370, 50374, 50376, 50392, 50398, 50403, 50410, 50416, 50419, 50476, 50479, 50482, 50485, 50488, 50607, 50617, 50620, 50622, 50626, 50669, 31525, 31526, 31527, 31528, 31571, 49965, 31574, 31573, 31575, 50329, 31576, 31577, 31579, 31578, 31572, 31581, 31582, 31583, 31584, 31585, 31586, 31587, 31588, 49966, 31591, 31590, 31592, 50330, 31593, 31594, 31596, 31595, 31589, 31598, 31599, 31600, 31601, 31602, 31603, 31604, 31808, 31813, 31826, 31829, 31825, 371, 45941, 45942, 48118, 48119, 31763, 31764, 31774, 31775, 48075, 48076, 48105, 48106, 31769, 31770, 48048, 48049, 48134, 48135, 45918, 45919, 31758, 31759, 31784, 31785, 31786, 31787, 31788, 31789, 31790, 31791, 316, 317, 318, 323, 32611, 32612, 32615, 32616, 32617, 32618, 32619, 32620, 32621, 32623, 32627, 32629, 32631, 32633, 32634, 33374, 33382, 33383, 33384, 33395, 33396, 33397, 33398, 33399, 33400, 33402, 33408, 33410, 33409, 33411, 33415, 33420, 33421, 33422, 33427, 33429, 33430, 33431, 33436, 33439, 33442, 33443, 33444, 33451, 33452, 33453, 33460, 33461, 33462, 33469, 33472, 33473, 33474, 33475, 33476, 33478, 33484, 33486, 33487, 33488, 33489, 33493, 33495, 33496, 33497, 33498, 33502, 33504, 33505, 33506, 33507, 33511, 33513, 33514, 33516, 33520, 33523, 33003, 32975, 32979, 33146, 33147, 33148, 33149, 33150, 33151, 33152, 33153, 33154, 45842, 33102, 33105, 33106, 31922, 31927, 31932, 31937, 31942, 31947, 31948, 32906, 32910, 32938, 32942, 45763, 32995, 32996, 32997, 32998, 45612, 32988, 32989, 32990, 32991, 45766, 33004, 33005, 33006, 33007, 33012, 33013, 33014, 33011, 33172, 33173, 33174, 33175, 33176, 33177, 33178, 33179, 33180, 33181, 33182, 33183, 33184, 33185, 33186, 33187, 33188, 33189, 33190, 33191, 33192, 33193, 33194, 33195, 33160, 33161, 33162, 33163, 33164, 33165, 33166, 33167, 33113, 33114, 33115, 33116, 33117, 33118, 33119, 33120, 33121, 33122, 33123, 33124, 33125, 33126, 33127, 33128, 33129, 33130, 33131, 33216, 33217, 33218, 33219, 33220, 33221, 33222, 33223, 33224, 33225, 33226, 33227, 33235, 33236, 33237, 33238, 33239, 33240, 33241, 33242, 33243, 33244, 33245, 33246, 33247, 33248, 33249, 33261, 33264, 33265, 33985, 33995, 34002, 34009, 33794, 33795, 33796, 33797, 33798, 33799, 32702, 32703, 32704, 32706, 32707, 32708, 32709, 32710, 32711, 32712, 32713, 32714, 32715, 32716, 33547, 33548, 32717, 32720, 32721, 32722, 32723, 32724, 32725, 32726, 32727, 32728, 32729, 32732, 50094, 50095, 50096, 50097, 50098, 50099, 50100, 50101, 50102, 50103, 50104, 50105, 32738, 32739, 32740, 32749, 32750, 32751, 32752, 32753, 32755, 32757, 35876, 35877, 35878, 35879, 49980, 49984, 49989, 49994, 50161, 50025, 50026, 50027, 50028, 50029, 50031, 50059, 34509, 34510, 34511, 34512, 34513, 34514, 34516, 34517, 34518, 34519, 34520, 34521, 34523, 34530, 34531, 34532, 34533, 34534, 33365, 33366, 33367, 33368, 34398, 34402, 34403, 34404, 34419, 34422, 34423, 34424, 34425, 34426, 34427, 34429, 34432, 34433, 34434, 34440, 34442, 34443, 34446, 34448, 34450, 34451, 34453, 34456, 34499, 34553, 34599, 34604, 34638, 34669, 34693, 34728, 34766, 34768, 34772, 34787, 34808, 34941, 34949, 34972, 34979, 34987, 34999, 35004, 35015, 35017, 35019, 35021, 35026, 35029, 35034, 35036, 35041, 35043, 35045, 35052, 35057, 35059, 33369, 35061, 35063, 35065, 35081, 35089, 35093, 35095, 35114, 35119, 35121, 35123, 35125, 35127, 35129, 35131, 35136, 35138, 35140, 35142, 35144, 35155, 35181, 35186, 35191, 35211, 35213, 35215, 35222, 35224, 35232, 35234, 35236, 35238, 35240, 35248, 35259, 35268, 35279, 35281, 35283, 35285, 35287, 35289, 35291, 35296, 35298, 35300, 35302, 35304, 35320, 35322, 35324, 35326, 35328, 35330, 35332, 35334, 35336, 35338, 35340, 35342, 35344, 35346, 35348, 35350, 35352, 35354, 35356, 35358, 35360, 35362, 35364, 35366, 35368, 35370, 35372, 35373, 35376, 35378, 35380, 35382, 35384, 35386, 35391, 35393, 35395, 33987, 33986, 33988, 35398, 35400, 35402, 35404, 35406, 35408, 35410, 35412, 35414, 35416, 35418, 35420, 35422, 35424, 35426, 35428, 35430, 35432, 35434, 35436, 35438, 35440, 35442, 35444, 35447, 35449, 35451, 35453, 35455, 35457, 35459, 35461, 35463, 35465, 35466, 35468, 35470, 43835, 45575, 45577, 45871, 45873, 45875, 45877, 45879, 45884, 45889, 49847, 49851, 49852, 49853, 49857, 49858, 49859, 49863, 49864, 49865, 49869, 49870, 49871, 49875, 49876, 49877, 49881, 49882, 49883, 49887, 49888, 50021, 50033, 50035, 50037, 50039, 50129, 50131, 50133, 50169, 50179, 50340, 50387, 50390, 50406, 50450, 50452, 50454, 50471, 50473, 50491, 50615, 50667, 50672, 50674, 50679) AND states.last_updated_ts > 1733831399.999999e0 AND states.last_updated_ts < 1733831700.0e0) AS anon_4) AS anon_1 ORDER BY anon_1.metadata_id, anon_1.last_updated_ts\r\nProgress: 0.000\r\n*************************** 2. row ***************************\r\n      Id: 68\r\n    User: root\r\n    Host: 172.31.0.1:43558\r\n      db: NULL\r\n Command: Query\r\n    Time: 0\r\n   State: starting\r\n    Info: show full processlist\r\nProgress: 0.000\r\n*************************** 3. row ***************************\r\n      Id: 975\r\n    User: homeassistant\r\n    Host: 172.31.0.1:50608\r\n      db: ha_db\r\n Command: Sleep\r\n    Time: 45\r\n   State: \r\n    Info: NULL\r\nProgress: 0.000\r\n*************************** 4. row ***************************\r\n      Id: 976\r\n    User: homeassistant\r\n    Host: 172.31.0.1:49240\r\n      db: ha_db\r\n Command: Query\r\n    Time: 848\r\n   State: Creating sort index\r\n    Info: SELECT anon_1.metadata_id, anon_1.state, anon_1.last_updated_ts, anon_1.attributes \r\nFROM (SELECT anon_2.metadata_id AS metadata_id, anon_2.state AS state, anon_2.last_updated_ts AS last_updated_ts, anon_2.attributes AS attributes \r\nFROM (SELECT states.metadata_id AS metadata_id, states.state AS state, 0 AS last_updated_ts, CASE WHEN (state_attributes.shared_attrs IS NULL) THEN states.attributes ELSE state_attributes.shared_attrs END AS attributes \r\nFROM states INNER JOIN (SELECT states.metadata_id AS max_metadata_id, max(states.last_updated_ts) AS max_last_updated \r\nFROM states \r\nWHERE states.last_updated_ts >= 1732708152.6401002e0 AND states.last_updated_ts < 1733830799.999999e0 AND states.metadata_id IN (224, 223, 222, 50501, 50518, 50535, 50564, 50581, 50598, 246, 248, 251, 32307, 32308, 32310, 32371, 31965, 31966, 31967, 31968, 31969, 32199, 32141, 32134, 32081, 32085, 32086, 32087, 32091, 32092, 32093, 32097, 32098, 32099, 32103, 32104, 32105, 32109, 32110, 32111, 32115, 32116, 32117, 32121, 32122, 32146, 32150, 32151, 32152, 32156, 32157, 32158, 32162, 32163, 32164, 32168, 32169, 32170, 32174, 32175, 32176, 32180, 32181, 32182, 32186, 32187, 32204, 32208, 32209, 32210, 32214, 32215, 32216, 32220, 32221, 32222, 32226, 32227, 32228, 32232, 32233, 32234, 32238, 32239, 32240, 32244, 32245, 32030, 32034, 32035, 32036, 32040, 32041, 32042, 32046, 32047, 32048, 32052, 32053, 32054, 32058, 32059, 32060, 32064, 32065, 32066, 32070, 32071, 49788, 49792, 49793, 49794, 49798, 49799, 49800, 49804, 49805, 49806, 49810, 49811, 49812, 49816, 49817, 49818, 49822, 49823, 49824, 49828, 49829, 31826, 31813, 31808, 31829, 31825, 316, 317, 318, 323, 45941, 45942, 48118, 48119, 31763, 31764, 31774, 31775, 48075, 48076, 48105, 48106, 31769, 31770, 48048, 48049, 48134, 48135, 45918, 45919, 31758, 31759, 31784, 31785, 31786, 31787, 31788, 31789, 31790, 31791, 32006, 299, 300, 371, 302, 303, 304, 305, 306, 307, 32611, 32612, 32615, 32616, 32617, 32618, 32619, 32620, 32621, 32623, 32627, 32629, 32631, 32633, 32634, 389, 49770, 391, 49772, 394, 395, 397, 10809, 10810, 34465, 10814, 10812, 10813, 10816, 10817, 10818, 42219, 42217, 42221, 42222, 49716, 42223, 10826, 10828, 10830, 45857, 10831, 10832, 10833, 10834, 42224, 45850, 10837, 10839, 10838, 10961, 10840, 10836, 10842, 10843, 10844, 50378, 10845, 10846, 49717, 49971, 42226, 10851, 42227, 49975, 10909, 10854, 10855, 42228, 42229, 10858, 10859, 42230, 10861, 42231, 10864, 42232, 10867, 49842, 50294, 10869, 10870, 42233, 42234, 10874, 49718, 10878, 10880, 10881, 42236, 10883, 10884, 10885, 49720, 49721, 10890, 10891, 10893, 50675, 10954, 10960, 50394, 10898, 42238, 49722, 49723, 50297, 10902, 10903, 10904, 10905, 42239, 49785, 42240, 10825, 42242, 10913, 45592, 10916, 45565, 50412, 10919, 42541, 10920, 10921, 45895, 10923, 42243, 10926, 10927, 49728, 49724, 42246, 10931, 10933, 42247, 42248, 42249, 42250, 10972, 49725, 49726, 10940, 42253, 49727, 10943, 42254, 10966, 10945, 49719, 10911, 10922, 42220, 45556, 10822, 10985, 10895, 34469, 10824, 34473, 10841, 34474, 10872, 10853, 34475, 10906, 10934, 10957, 34486, 34493, 34501, 34505, 10970, 34537, 34545, 10971, 34557, 10975, 34559, 34561, 34568, 45263, 45270, 45273, 45302, 45534, 45537, 45540, 45543, 45546, 45549, 45553, 45559, 45562, 45567, 45571, 45581, 45584, 45590, 45596, 10924, 45603, 45750, 45760, 11008, 10962, 42241, 10900, 45752, 10965, 10946, 45754, 10980, 45867, 45880, 45885, 10964, 10974, 45893, 49843, 45897, 42244, 45899, 45901, 45903, 45905, 45907, 45909, 45931, 45948, 45950, 45952, 45954, 45956, 45963, 45965, 45967, 45972, 45974, 45976, 45978, 45980, 45987, 45989, 45991, 45993, 45995, 45997, 45999, 46001, 46003, 46005, 46007, 46009, 46011, 46013, 46015, 46017, 46019, 46021, 46023, 46025, 46027, 46029, 46031, 46033, 46035, 46037, 46039, 46041, 46043, 46045, 46047, 46049, 46051, 46086, 46088, 46090, 46092, 46094, 46096, 46098, 46100, 49962, 49967, 46102, 46104, 50008, 50011, 50013, 50015, 50022, 50043, 50062, 50071, 50073, 50076, 50106, 50114, 50165, 50170, 50173, 50309, 50312, 50331, 50335, 50344, 50346, 50354, 50357, 50360, 50363, 50366, 50369, 50373, 50375, 50391, 50397, 50402, 50409, 50415, 50418, 50475, 50478, 50481, 50484, 50487, 50606, 50616, 50619, 50621, 50625, 50668, 21117, 21118, 34466, 21122, 21120, 21121, 21124, 21125, 21126, 42257, 42255, 42259, 42260, 49729, 42261, 21134, 21136, 21138, 45858, 21139, 21140, 21141, 21142, 42262, 45851, 21145, 21147, 21146, 21269, 21148, 21144, 21150, 21151, 21152, 50379, 21153, 21154, 49730, 49972, 42264, 21159, 42265, 49976, 21217, 21162, 21163, 42266, 42267, 21166, 21167, 42268, 21169, 42269, 21172, 42270, 21175, 49844, 50295, 21177, 21178, 42271, 42272, 21182, 49731, 21186, 21188, 21189, 42274, 21191, 21192, 21193, 49733, 49734, 21198, 21199, 21201, 50676, 21262, 21268, 50395, 21206, 42276, 49735, 49736, 50298, 21210, 21211, 21212, 21213, 42277, 49786, 42278, 21133, 42280, 21221, 45593, 21224, 45566, 50413, 21227, 42542, 21228, 21229, 45896, 21231, 42281, 21234, 21235, 49741, 49737, 42284, 21239, 21241, 42285, 42286, 42287, 42288, 21280, 49738, 49739, 21248, 42291, 49740, 21251, 42292, 21274, 21253, 49732, 21219, 21230, 42258, 45557, 21130, 21293, 21203, 34470, 21132, 34477, 21149, 34478, 21180, 21161, 34479, 21214, 21242, 21265, 34487, 34494, 34502, 34506, 21278, 34538, 34546, 21279, 34558, 21283, 34560, 34562, 34569, 45264, 45271, 45274, 45303, 45535, 45538, 45541, 45544, 45547, 45550, 45554, 45560, 45563, 45568, 45572, 45582, 45585, 45591, 45597, 21232, 45604, 45751, 45761, 21316, 21270, 42279, 21208, 45753, 21273, 21254, 45755, 21288, 45868, 45881, 45886, 21272, 21282, 45894, 49845, 45898, 42282, 45900, 45902, 45904, 45906, 45908, 45910, 45932, 45949, 45951, 45953, 45955, 45957, 45964, 45966, 45968, 45973, 45975, 45977, 45979, 45981, 45988, 45990, 45992, 45994, 45996, 45998, 46000, 46002, 46004, 46006, 46008, 46010, 46012, 46014, 46016, 46018, 46020, 46022, 46024, 46026, 46028, 46030, 46032, 46034, 46036, 46038, 46040, 46042, 46044, 46046, 46048, 46050, 46052, 46087, 46089, 46091, 46093, 46095, 46097, 46099, 46101, 49963, 49968, 46103, 46105, 50009, 50012, 50014, 50016, 50023, 50044, 50063, 50072, 50074, 50077, 50107, 50115, 50166, 50171, 50174, 50310, 50313, 50332, 50336, 50345, 50347, 50355, 50358, 50361, 50364, 50367, 50370, 50374, 50376, 50392, 50398, 50403, 50410, 50416, 50419, 50476, 50479, 50482, 50485, 50488, 50607, 50617, 50620, 50622, 50626, 50669, 31525, 31526, 31527, 31528, 31571, 49965, 31574, 31573, 31575, 50329, 31576, 31577, 31579, 31578, 31572, 31581, 31582, 31583, 31584, 31585, 31586, 31587, 31588, 49966, 31591, 31590, 31592, 50330, 31593, 31594, 31596, 31595, 31589, 31598, 31599, 31600, 31601, 31602, 31603, 31604, 235, 236, 237, 238, 239, 32906, 32910, 32938, 32942, 32975, 32979, 33003, 45612, 32988, 32989, 32990, 32991, 45763, 32995, 32996, 32997, 32998, 45766, 33004, 33005, 33006, 33007, 33011, 33012, 33013, 33014, 33172, 33173, 33174, 33175, 33176, 33177, 33178, 33179, 33180, 33181, 33182, 33183, 33184, 33185, 33186, 33187, 33188, 33189, 33190, 33191, 33192, 33193, 33194, 33195, 33113, 33114, 33115, 33116, 33117, 33118, 33119, 33120, 33121, 33122, 33123, 33124, 33125, 33126, 33127, 33128, 33129, 33130, 33131, 33146, 33147, 33148, 33149, 33150, 33151, 33152, 33153, 33154, 33160, 33161, 33162, 33163, 33164, 33165, 33166, 33167, 33216, 33217, 33218, 33219, 33220, 33221, 33222, 33223, 33224, 33225, 33226, 33227, 33235, 33236, 33237, 33238, 33239, 33240, 33241, 33242, 33243, 33244, 33245, 33246, 33247, 33248, 33249, 33102, 33105, 33106, 33261, 33264, 33265, 45842, 31922, 31927, 31932, 31937, 31942, 31947, 31948, 33374, 33382, 33383, 33384, 33395, 33396, 33397, 33398, 33399, 33400, 33402, 33408, 33410, 33409, 33411, 33415, 33420, 33421, 33422, 33427, 33429, 33430, 33431, 33436, 33439, 33442, 33443, 33444, 33451, 33452, 33453, 33460, 33461, 33462, 33469, 33472, 33473, 33474, 33475, 33476, 33478, 33484, 33486, 33487, 33488, 33489, 33493, 33495, 33496, 33497, 33498, 33502, 33504, 33505, 33506, 33507, 33511, 33513, 33514, 33516, 33520, 33523, 33794, 33795, 33796, 33797, 33798, 33799, 33985, 33995, 34002, 34009, 33547, 33548, 32702, 32703, 32704, 32706, 32707, 32708, 32709, 32710, 32711, 32712, 32713, 32714, 32715, 32716, 32717, 32720, 32721, 32722, 32723, 32724, 32725, 32726, 32727, 32728, 32729, 32732, 32738, 32739, 32740, 32749, 32750, 32751, 32752, 32753, 32755, 32757, 35876, 35877, 35878, 35879, 49980, 49984, 49989, 49994, 50161, 50094, 50095, 50096, 50097, 50098, 50099, 50100, 50101, 50102, 50103, 50104, 50105, 50025, 50026, 50027, 50028, 50029, 50031, 50059, 33365, 33366, 33367, 33368, 34398, 34402, 34403, 34404, 34419, 34422, 34423, 34424, 34425, 34426, 34427, 34429, 34432, 34433, 34434, 34440, 34442, 34443, 34446, 34448, 34450, 34451, 34453, 34456, 34499, 34509, 34510, 34511, 34512, 34513, 34514, 34516, 34517, 34518, 34519, 34520, 34521, 34523, 34530, 34531, 34532, 34533, 34534, 34553, 34599, 34604, 34638, 34669, 34693, 34728, 34766, 34768, 34772, 34787, 34808, 34941, 34949, 34972, 34979, 34987, 34999, 35004, 35015, 35017, 35019, 35021, 35026, 35029, 35034, 35036, 35041, 35043, 35045, 35052, 35057, 35059, 33369, 35061, 35063, 35065, 35081, 35089, 35093, 35095, 35114, 35119, 35121, 35123, 35125, 35127, 35129, 35131, 35136, 35138, 35140, 35142, 35144, 35155, 35181, 35186, 35191, 35211, 35213, 35215, 35222, 35224, 35232, 35234, 35236, 35238, 35240, 35248, 35259, 35268, 35279, 35281, 35283, 35285, 35287, 35289, 35291, 35296, 35298, 35300, 35302, 35304, 35320, 35322, 35324, 35326, 35328, 35330, 35332, 35334, 35336, 35338, 35340, 35342, 35344, 35346, 35348, 35350, 35352, 35354, 35356, 35358, 35360, 35362, 35364, 35366, 35368, 35370, 35372, 35373, 35376, 35378, 35380, 35382, 35384, 35386, 35391, 35393, 35395, 33987, 33986, 33988, 35398, 35400, 35402, 35404, 35406, 35408, 35410, 35412, 35414, 35416, 35418, 35420, 35422, 35424, 35426, 35428, 35430, 35432, 35434, 35436, 35438, 35440, 35442, 35444, 35447, 35449, 35451, 35453, 35455, 35457, 35459, 35461, 35463, 35465, 35466, 35468, 35470, 43835, 45575, 45577, 45871, 45873, 45875, 45877, 45879, 45884, 45889, 49847, 49851, 49852, 49853, 49857, 49858, 49859, 49863, 49864, 49865, 49869, 49870, 49871, 49875, 49876, 49877, 49881, 49882, 49883, 49887, 49888, 50021, 50033, 50035, 50037, 50039, 50129, 50131, 50133, 50169, 50179, 50340, 50387, 50390, 50406, 50450, 50452, 50454, 50471, 50473, 50491, 50615, 50667, 50672, 50674, 50679) GROUP BY states.metadata_id) AS anon_3 ON states.metadata_id = anon_3.max_metadata_id AND states.last_updated_ts = anon_3.max_last_updated LEFT OUTER JOIN state_attributes ON states.attributes_id = state_attributes.attributes_id \r\nWHERE states.last_updated_ts >= 1732708152.6401002e0 AND states.last_updated_ts < 1733830799.999999e0 AND states.metadata_id IN (224, 223, 222, 50501, 50518, 50535, 50564, 50581, 50598, 246, 248, 251, 32307, 32308, 32310, 32371, 31965, 31966, 31967, 31968, 31969, 32199, 32141, 32134, 32081, 32085, 32086, 32087, 32091, 32092, 32093, 32097, 32098, 32099, 32103, 32104, 32105, 32109, 32110, 32111, 32115, 32116, 32117, 32121, 32122, 32146, 32150, 32151, 32152, 32156, 32157, 32158, 32162, 32163, 32164, 32168, 32169, 32170, 32174, 32175, 32176, 32180, 32181, 32182, 32186, 32187, 32204, 32208, 32209, 32210, 32214, 32215, 32216, 32220, 32221, 32222, 32226, 32227, 32228, 32232, 32233, 32234, 32238, 32239, 32240, 32244, 32245, 32030, 32034, 32035, 32036, 32040, 32041, 32042, 32046, 32047, 32048, 32052, 32053, 32054, 32058, 32059, 32060, 32064, 32065, 32066, 32070, 32071, 49788, 49792, 49793, 49794, 49798, 49799, 49800, 49804, 49805, 49806, 49810, 49811, 49812, 49816, 49817, 49818, 49822, 49823, 49824, 49828, 49829, 31826, 31813, 31808, 31829, 31825, 316, 317, 318, 323, 45941, 45942, 48118, 48119, 31763, 31764, 31774, 31775, 48075, 48076, 48105, 48106, 31769, 31770, 48048, 48049, 48134, 48135, 45918, 45919, 31758, 31759, 31784, 31785, 31786, 31787, 31788, 31789, 31790, 31791, 32006, 299, 300, 371, 302, 303, 304, 305, 306, 307, 32611, 32612, 32615, 32616, 32617, 32618, 32619, 32620, 32621, 32623, 32627, 32629, 32631, 32633, 32634, 389, 49770, 391, 49772, 394, 395, 397, 10809, 10810, 34465, 10814, 10812, 10813, 10816, 10817, 10818, 42219, 42217, 42221, 42222, 49716, 42223, 10826, 10828, 10830, 45857, 10831, 10832, 10833, 10834, 42224, 45850, 10837, 10839, 10838, 10961, 10840, 10836, 10842, 10843, 10844, 50378, 10845, 10846, 49717, 49971, 42226, 10851, 42227, 49975, 10909, 10854, 10855, 42228, 42229, 10858, 10859, 42230, 10861, 42231, 10864, 42232, 10867, 49842, 50294, 10869, 10870, 42233, 42234, 10874, 49718, 10878, 10880, 10881, 42236, 10883, 10884, 10885, 49720, 49721, 10890, 10891, 10893, 50675, 10954, 10960, 50394, 10898, 42238, 49722, 49723, 50297, 10902, 10903, 10904, 10905, 42239, 49785, 42240, 10825, 42242, 10913, 45592, 10916, 45565, 50412, 10919, 42541, 10920, 10921, 45895, 10923, 42243, 10926, 10927, 49728, 49724, 42246, 10931, 10933, 42247, 42248, 42249, 42250, 10972, 49725, 49726, 10940, 42253, 49727, 10943, 42254, 10966, 10945, 49719, 10911, 10922, 42220, 45556, 10822, 10985, 10895, 34469, 10824, 34473, 10841, 34474, 10872, 10853, 34475, 10906, 10934, 10957, 34486, 34493, 34501, 34505, 10970, 34537, 34545, 10971, 34557, 10975, 34559, 34561, 34568, 45263, 45270, 45273, 45302, 45534, 45537, 45540, 45543, 45546, 45549, 45553, 45559, 45562, 45567, 45571, 45581, 45584, 45590, 45596, 10924, 45603, 45750, 45760, 11008, 10962, 42241, 10900, 45752, 10965, 10946, 45754, 10980, 45867, 45880, 45885, 10964, 10974, 45893, 49843, 45897, 42244, 45899, 45901, 45903, 45905, 45907, 45909, 45931, 45948, 45950, 45952, 45954, 45956, 45963, 45965, 45967, 45972, 45974, 45976, 45978, 45980, 45987, 45989, 45991, 45993, 45995, 45997, 45999, 46001, 46003, 46005, 46007, 46009, 46011, 46013, 46015, 46017, 46019, 46021, 46023, 46025, 46027, 46029, 46031, 46033, 46035, 46037, 46039, 46041, 46043, 46045, 46047, 46049, 46051, 46086, 46088, 46090, 46092, 46094, 46096, 46098, 46100, 49962, 49967, 46102, 46104, 50008, 50011, 50013, 50015, 50022, 50043, 50062, 50071, 50073, 50076, 50106, 50114, 50165, 50170, 50173, 50309, 50312, 50331, 50335, 50344, 50346, 50354, 50357, 50360, 50363, 50366, 50369, 50373, 50375, 50391, 50397, 50402, 50409, 50415, 50418, 50475, 50478, 50481, 50484, 50487, 50606, 50616, 50619, 50621, 50625, 50668, 21117, 21118, 34466, 21122, 21120, 21121, 21124, 21125, 21126, 42257, 42255, 42259, 42260, 49729, 42261, 21134, 21136, 21138, 45858, 21139, 21140, 21141, 21142, 42262, 45851, 21145, 21147, 21146, 21269, 21148, 21144, 21150, 21151, 21152, 50379, 21153, 21154, 49730, 49972, 42264, 21159, 42265, 49976, 21217, 21162, 21163, 42266, 42267, 21166, 21167, 42268, 21169, 42269, 21172, 42270, 21175, 49844, 50295, 21177, 21178, 42271, 42272, 21182, 49731, 21186, 21188, 21189, 42274, 21191, 21192, 21193, 49733, 49734, 21198, 21199, 21201, 50676, 21262, 21268, 50395, 21206, 42276, 49735, 49736, 50298, 21210, 21211, 21212, 21213, 42277, 49786, 42278, 21133, 42280, 21221, 45593, 21224, 45566, 50413, 21227, 42542, 21228, 21229, 45896, 21231, 42281, 21234, 21235, 49741, 49737, 42284, 21239, 21241, 42285, 42286, 42287, 42288, 21280, 49738, 49739, 21248, 42291, 49740, 21251, 42292, 21274, 21253, 49732, 21219, 21230, 42258, 45557, 21130, 21293, 21203, 34470, 21132, 34477, 21149, 34478, 21180, 21161, 34479, 21214, 21242, 21265, 34487, 34494, 34502, 34506, 21278, 34538, 34546, 21279, 34558, 21283, 34560, 34562, 34569, 45264, 45271, 45274, 45303, 45535, 45538, 45541, 45544, 45547, 45550, 45554, 45560, 45563, 45568, 45572, 45582, 45585, 45591, 45597, 21232, 45604, 45751, 45761, 21316, 21270, 42279, 21208, 45753, 21273, 21254, 45755, 21288, 45868, 45881, 45886, 21272, 21282, 45894, 49845, 45898, 42282, 45900, 45902, 45904, 45906, 45908, 45910, 45932, 45949, 45951, 45953, 45955, 45957, 45964, 45966, 45968, 45973, 45975, 45977, 45979, 45981, 45988, 45990, 45992, 45994, 45996, 45998, 46000, 46002, 46004, 46006, 46008, 46010, 46012, 46014, 46016, 46018, 46020, 46022, 46024, 46026, 46028, 46030, 46032, 46034, 46036, 46038, 46040, 46042, 46044, 46046, 46048, 46050, 46052, 46087, 46089, 46091, 46093, 46095, 46097, 46099, 46101, 49963, 49968, 46103, 46105, 50009, 50012, 50014, 50016, 50023, 50044, 50063, 50072, 50074, 50077, 50107, 50115, 50166, 50171, 50174, 50310, 50313, 50332, 50336, 50345, 50347, 50355, 50358, 50361, 50364, 50367, 50370, 50374, 50376, 50392, 50398, 50403, 50410, 50416, 50419, 50476, 50479, 50482, 50485, 50488, 50607, 50617, 50620, 50622, 50626, 50669, 31525, 31526, 31527, 31528, 31571, 49965, 31574, 31573, 31575, 50329, 31576, 31577, 31579, 31578, 31572, 31581, 31582, 31583, 31584, 31585, 31586, 31587, 31588, 49966, 31591, 31590, 31592, 50330, 31593, 31594, 31596, 31595, 31589, 31598, 31599, 31600, 31601, 31602, 31603, 31604, 235, 236, 237, 238, 239, 32906, 32910, 32938, 32942, 32975, 32979, 33003, 45612, 32988, 32989, 32990, 32991, 45763, 32995, 32996, 32997, 32998, 45766, 33004, 33005, 33006, 33007, 33011, 33012, 33013, 33014, 33172, 33173, 33174, 33175, 33176, 33177, 33178, 33179, 33180, 33181, 33182, 33183, 33184, 33185, 33186, 33187, 33188, 33189, 33190, 33191, 33192, 33193, 33194, 33195, 33113, 33114, 33115, 33116, 33117, 33118, 33119, 33120, 33121, 33122, 33123, 33124, 33125, 33126, 33127, 33128, 33129, 33130, 33131, 33146, 33147, 33148, 33149, 33150, 33151, 33152, 33153, 33154, 33160, 33161, 33162, 33163, 33164, 33165, 33166, 33167, 33216, 33217, 33218, 33219, 33220, 33221, 33222, 33223, 33224, 33225, 33226, 33227, 33235, 33236, 33237, 33238, 33239, 33240, 33241, 33242, 33243, 33244, 33245, 33246, 33247, 33248, 33249, 33102, 33105, 33106, 33261, 33264, 33265, 45842, 31922, 31927, 31932, 31937, 31942, 31947, 31948, 33374, 33382, 33383, 33384, 33395, 33396, 33397, 33398, 33399, 33400, 33402, 33408, 33410, 33409, 33411, 33415, 33420, 33421, 33422, 33427, 33429, 33430, 33431, 33436, 33439, 33442, 33443, 33444, 33451, 33452, 33453, 33460, 33461, 33462, 33469, 33472, 33473, 33474, 33475, 33476, 33478, 33484, 33486, 33487, 33488, 33489, 33493, 33495, 33496, 33497, 33498, 33502, 33504, 33505, 33506, 33507, 33511, 33513, 33514, 33516, 33520, 33523, 33794, 33795, 33796, 33797, 33798, 33799, 33985, 33995, 34002, 34009, 33547, 33548, 32702, 32703, 32704, 32706, 32707, 32708, 32709, 32710, 32711, 32712, 32713, 32714, 32715, 32716, 32717, 32720, 32721, 32722, 32723, 32724, 32725, 32726, 32727, 32728, 32729, 32732, 32738, 32739, 32740, 32749, 32750, 32751, 32752, 32753, 32755, 32757, 35876, 35877, 35878, 35879, 49980, 49984, 49989, 49994, 50161, 50094, 50095, 50096, 50097, 50098, 50099, 50100, 50101, 50102, 50103, 50104, 50105, 50025, 50026, 50027, 50028, 50029, 50031, 50059, 33365, 33366, 33367, 33368, 34398, 34402, 34403, 34404, 34419, 34422, 34423, 34424, 34425, 34426, 34427, 34429, 34432, 34433, 34434, 34440, 34442, 34443, 34446, 34448, 34450, 34451, 34453, 34456, 34499, 34509, 34510, 34511, 34512, 34513, 34514, 34516, 34517, 34518, 34519, 34520, 34521, 34523, 34530, 34531, 34532, 34533, 34534, 34553, 34599, 34604, 34638, 34669, 34693, 34728, 34766, 34768, 34772, 34787, 34808, 34941, 34949, 34972, 34979, 34987, 34999, 35004, 35015, 35017, 35019, 35021, 35026, 35029, 35034, 35036, 35041, 35043, 35045, 35052, 35057, 35059, 33369, 35061, 35063, 35065, 35081, 35089, 35093, 35095, 35114, 35119, 35121, 35123, 35125, 35127, 35129, 35131, 35136, 35138, 35140, 35142, 35144, 35155, 35181, 35186, 35191, 35211, 35213, 35215, 35222, 35224, 35232, 35234, 35236, 35238, 35240, 35248, 35259, 35268, 35279, 35281, 35283, 35285, 35287, 35289, 35291, 35296, 35298, 35300, 35302, 35304, 35320, 35322, 35324, 35326, 35328, 35330, 35332, 35334, 35336, 35338, 35340, 35342, 35344, 35346, 35348, 35350, 35352, 35354, 35356, 35358, 35360, 35362, 35364, 35366, 35368, 35370, 35372, 35373, 35376, 35378, 35380, 35382, 35384, 35386, 35391, 35393, 35395, 33987, 33986, 33988, 35398, 35400, 35402, 35404, 35406, 35408, 35410, 35412, 35414, 35416, 35418, 35420, 35422, 35424, 35426, 35428, 35430, 35432, 35434, 35436, 35438, 35440, 35442, 35444, 35447, 35449, 35451, 35453, 35455, 35457, 35459, 35461, 35463, 35465, 35466, 35468, 35470, 43835, 45575, 45577, 45871, 45873, 45875, 45877, 45879, 45884, 45889, 49847, 49851, 49852, 49853, 49857, 49858, 49859, 49863, 49864, 49865, 49869, 49870, 49871, 49875, 49876, 49877, 49881, 49882, 49883, 49887, 49888, 50021, 50033, 50035, 50037, 50039, 50129, 50131, 50133, 50169, 50179, 50340, 50387, 50390, 50406, 50450, 50452, 50454, 50471, 50473, 50491, 50615, 50667, 50672, 50674, 50679)) AS anon_2 UNION ALL SELECT anon_4.metadata_id AS metadata_id, anon_4.state AS state, anon_4.last_updated_ts AS last_updated_ts, anon_4.attributes AS attributes \r\nFROM (SELECT states.metadata_id AS metadata_id, states.state AS state, states.last_updated_ts AS last_updated_ts, CASE WHEN (state_attributes.shared_attrs IS NULL) THEN states.attributes ELSE state_attributes.shared_attrs END AS attributes \r\nFROM states LEFT OUTER JOIN state_attributes ON states.attributes_id = state_attributes.attributes_id \r\nWHERE (states.last_changed_ts = states.last_updated_ts OR states.last_changed_ts IS NULL) AND states.metadata_id IN (224, 223, 222, 50501, 50518, 50535, 50564, 50581, 50598, 246, 248, 251, 32307, 32308, 32310, 32371, 31965, 31966, 31967, 31968, 31969, 32199, 32141, 32134, 32081, 32085, 32086, 32087, 32091, 32092, 32093, 32097, 32098, 32099, 32103, 32104, 32105, 32109, 32110, 32111, 32115, 32116, 32117, 32121, 32122, 32146, 32150, 32151, 32152, 32156, 32157, 32158, 32162, 32163, 32164, 32168, 32169, 32170, 32174, 32175, 32176, 32180, 32181, 32182, 32186, 32187, 32204, 32208, 32209, 32210, 32214, 32215, 32216, 32220, 32221, 32222, 32226, 32227, 32228, 32232, 32233, 32234, 32238, 32239, 32240, 32244, 32245, 32030, 32034, 32035, 32036, 32040, 32041, 32042, 32046, 32047, 32048, 32052, 32053, 32054, 32058, 32059, 32060, 32064, 32065, 32066, 32070, 32071, 49788, 49792, 49793, 49794, 49798, 49799, 49800, 49804, 49805, 49806, 49810, 49811, 49812, 49816, 49817, 49818, 49822, 49823, 49824, 49828, 49829, 31826, 31813, 31808, 31829, 31825, 316, 317, 318, 323, 45941, 45942, 48118, 48119, 31763, 31764, 31774, 31775, 48075, 48076, 48105, 48106, 31769, 31770, 48048, 48049, 48134, 48135, 45918, 45919, 31758, 31759, 31784, 31785, 31786, 31787, 31788, 31789, 31790, 31791, 32006, 299, 300, 371, 302, 303, 304, 305, 306, 307, 32611, 32612, 32615, 32616, 32617, 32618, 32619, 32620, 32621, 32623, 32627, 32629, 32631, 32633, 32634, 389, 49770, 391, 49772, 394, 395, 397, 10809, 10810, 34465, 10814, 10812, 10813, 10816, 10817, 10818, 42219, 42217, 42221, 42222, 49716, 42223, 10826, 10828, 10830, 45857, 10831, 10832, 10833, 10834, 42224, 45850, 10837, 10839, 10838, 10961, 10840, 10836, 10842, 10843, 10844, 50378, 10845, 10846, 49717, 49971, 42226, 10851, 42227, 49975, 10909, 10854, 10855, 42228, 42229, 10858, 10859, 42230, 10861, 42231, 10864, 42232, 10867, 49842, 50294, 10869, 10870, 42233, 42234, 10874, 49718, 10878, 10880, 10881, 42236, 10883, 10884, 10885, 49720, 49721, 10890, 10891, 10893, 50675, 10954, 10960, 50394, 10898, 42238, 49722, 49723, 50297, 10902, 10903, 10904, 10905, 42239, 49785, 42240, 10825, 42242, 10913, 45592, 10916, 45565, 50412, 10919, 42541, 10920, 10921, 45895, 10923, 42243, 10926, 10927, 49728, 49724, 42246, 10931, 10933, 42247, 42248, 42249, 42250, 10972, 49725, 49726, 10940, 42253, 49727, 10943, 42254, 10966, 10945, 49719, 10911, 10922, 42220, 45556, 10822, 10985, 10895, 34469, 10824, 34473, 10841, 34474, 10872, 10853, 34475, 10906, 10934, 10957, 34486, 34493, 34501, 34505, 10970, 34537, 34545, 10971, 34557, 10975, 34559, 34561, 34568, 45263, 45270, 45273, 45302, 45534, 45537, 45540, 45543, 45546, 45549, 45553, 45559, 45562, 45567, 45571, 45581, 45584, 45590, 45596, 10924, 45603, 45750, 45760, 11008, 10962, 42241, 10900, 45752, 10965, 10946, 45754, 10980, 45867, 45880, 45885, 10964, 10974, 45893, 49843, 45897, 42244, 45899, 45901, 45903, 45905, 45907, 45909, 45931, 45948, 45950, 45952, 45954, 45956, 45963, 45965, 45967, 45972, 45974, 45976, 45978, 45980, 45987, 45989, 45991, 45993, 45995, 45997, 45999, 46001, 46003, 46005, 46007, 46009, 46011, 46013, 46015, 46017, 46019, 46021, 46023, 46025, 46027, 46029, 46031, 46033, 46035, 46037, 46039, 46041, 46043, 46045, 46047, 46049, 46051, 46086, 46088, 46090, 46092, 46094, 46096, 46098, 46100, 49962, 49967, 46102, 46104, 50008, 50011, 50013, 50015, 50022, 50043, 50062, 50071, 50073, 50076, 50106, 50114, 50165, 50170, 50173, 50309, 50312, 50331, 50335, 50344, 50346, 50354, 50357, 50360, 50363, 50366, 50369, 50373, 50375, 50391, 50397, 50402, 50409, 50415, 50418, 50475, 50478, 50481, 50484, 50487, 50606, 50616, 50619, 50621, 50625, 50668, 21117, 21118, 34466, 21122, 21120, 21121, 21124, 21125, 21126, 42257, 42255, 42259, 42260, 49729, 42261, 21134, 21136, 21138, 45858, 21139, 21140, 21141, 21142, 42262, 45851, 21145, 21147, 21146, 21269, 21148, 21144, 21150, 21151, 21152, 50379, 21153, 21154, 49730, 49972, 42264, 21159, 42265, 49976, 21217, 21162, 21163, 42266, 42267, 21166, 21167, 42268, 21169, 42269, 21172, 42270, 21175, 49844, 50295, 21177, 21178, 42271, 42272, 21182, 49731, 21186, 21188, 21189, 42274, 21191, 21192, 21193, 49733, 49734, 21198, 21199, 21201, 50676, 21262, 21268, 50395, 21206, 42276, 49735, 49736, 50298, 21210, 21211, 21212, 21213, 42277, 49786, 42278, 21133, 42280, 21221, 45593, 21224, 45566, 50413, 21227, 42542, 21228, 21229, 45896, 21231, 42281, 21234, 21235, 49741, 49737, 42284, 21239, 21241, 42285, 42286, 42287, 42288, 21280, 49738, 49739, 21248, 42291, 49740, 21251, 42292, 21274, 21253, 49732, 21219, 21230, 42258, 45557, 21130, 21293, 21203, 34470, 21132, 34477, 21149, 34478, 21180, 21161, 34479, 21214, 21242, 21265, 34487, 34494, 34502, 34506, 21278, 34538, 34546, 21279, 34558, 21283, 34560, 34562, 34569, 45264, 45271, 45274, 45303, 45535, 45538, 45541, 45544, 45547, 45550, 45554, 45560, 45563, 45568, 45572, 45582, 45585, 45591, 45597, 21232, 45604, 45751, 45761, 21316, 21270, 42279, 21208, 45753, 21273, 21254, 45755, 21288, 45868, 45881, 45886, 21272, 21282, 45894, 49845, 45898, 42282, 45900, 45902, 45904, 45906, 45908, 45910, 45932, 45949, 45951, 45953, 45955, 45957, 45964, 45966, 45968, 45973, 45975, 45977, 45979, 45981, 45988, 45990, 45992, 45994, 45996, 45998, 46000, 46002, 46004, 46006, 46008, 46010, 46012, 46014, 46016, 46018, 46020, 46022, 46024, 46026, 46028, 46030, 46032, 46034, 46036, 46038, 46040, 46042, 46044, 46046, 46048, 46050, 46052, 46087, 46089, 46091, 46093, 46095, 46097, 46099, 46101, 49963, 49968, 46103, 46105, 50009, 50012, 50014, 50016, 50023, 50044, 50063, 50072, 50074, 50077, 50107, 50115, 50166, 50171, 50174, 50310, 50313, 50332, 50336, 50345, 50347, 50355, 50358, 50361, 50364, 50367, 50370, 50374, 50376, 50392, 50398, 50403, 50410, 50416, 50419, 50476, 50479, 50482, 50485, 50488, 50607, 50617, 50620, 50622, 50626, 50669, 31525, 31526, 31527, 31528, 31571, 49965, 31574, 31573, 31575, 50329, 31576, 31577, 31579, 31578, 31572, 31581, 31582, 31583, 31584, 31585, 31586, 31587, 31588, 49966, 31591, 31590, 31592, 50330, 31593, 31594, 31596, 31595, 31589, 31598, 31599, 31600, 31601, 31602, 31603, 31604, 235, 236, 237, 238, 239, 32906, 32910, 32938, 32942, 32975, 32979, 33003, 45612, 32988, 32989, 32990, 32991, 45763, 32995, 32996, 32997, 32998, 45766, 33004, 33005, 33006, 33007, 33011, 33012, 33013, 33014, 33172, 33173, 33174, 33175, 33176, 33177, 33178, 33179, 33180, 33181, 33182, 33183, 33184, 33185, 33186, 33187, 33188, 33189, 33190, 33191, 33192, 33193, 33194, 33195, 33113, 33114, 33115, 33116, 33117, 33118, 33119, 33120, 33121, 33122, 33123, 33124, 33125, 33126, 33127, 33128, 33129, 33130, 33131, 33146, 33147, 33148, 33149, 33150, 33151, 33152, 33153, 33154, 33160, 33161, 33162, 33163, 33164, 33165, 33166, 33167, 33216, 33217, 33218, 33219, 33220, 33221, 33222, 33223, 33224, 33225, 33226, 33227, 33235, 33236, 33237, 33238, 33239, 33240, 33241, 33242, 33243, 33244, 33245, 33246, 33247, 33248, 33249, 33102, 33105, 33106, 33261, 33264, 33265, 45842, 31922, 31927, 31932, 31937, 31942, 31947, 31948, 33374, 33382, 33383, 33384, 33395, 33396, 33397, 33398, 33399, 33400, 33402, 33408, 33410, 33409, 33411, 33415, 33420, 33421, 33422, 33427, 33429, 33430, 33431, 33436, 33439, 33442, 33443, 33444, 33451, 33452, 33453, 33460, 33461, 33462, 33469, 33472, 33473, 33474, 33475, 33476, 33478, 33484, 33486, 33487, 33488, 33489, 33493, 33495, 33496, 33497, 33498, 33502, 33504, 33505, 33506, 33507, 33511, 33513, 33514, 33516, 33520, 33523, 33794, 33795, 33796, 33797, 33798, 33799, 33985, 33995, 34002, 34009, 33547, 33548, 32702, 32703, 32704, 32706, 32707, 32708, 32709, 32710, 32711, 32712, 32713, 32714, 32715, 32716, 32717, 32720, 32721, 32722, 32723, 32724, 32725, 32726, 32727, 32728, 32729, 32732, 32738, 32739, 32740, 32749, 32750, 32751, 32752, 32753, 32755, 32757, 35876, 35877, 35878, 35879, 49980, 49984, 49989, 49994, 50161, 50094, 50095, 50096, 50097, 50098, 50099, 50100, 50101, 50102, 50103, 50104, 50105, 50025, 50026, 50027, 50028, 50029, 50031, 50059, 33365, 33366, 33367, 33368, 34398, 34402, 34403, 34404, 34419, 34422, 34423, 34424, 34425, 34426, 34427, 34429, 34432, 34433, 34434, 34440, 34442, 34443, 34446, 34448, 34450, 34451, 34453, 34456, 34499, 34509, 34510, 34511, 34512, 34513, 34514, 34516, 34517, 34518, 34519, 34520, 34521, 34523, 34530, 34531, 34532, 34533, 34534, 34553, 34599, 34604, 34638, 34669, 34693, 34728, 34766, 34768, 34772, 34787, 34808, 34941, 34949, 34972, 34979, 34987, 34999, 35004, 35015, 35017, 35019, 35021, 35026, 35029, 35034, 35036, 35041, 35043, 35045, 35052, 35057, 35059, 33369, 35061, 35063, 35065, 35081, 35089, 35093, 35095, 35114, 35119, 35121, 35123, 35125, 35127, 35129, 35131, 35136, 35138, 35140, 35142, 35144, 35155, 35181, 35186, 35191, 35211, 35213, 35215, 35222, 35224, 35232, 35234, 35236, 35238, 35240, 35248, 35259, 35268, 35279, 35281, 35283, 35285, 35287, 35289, 35291, 35296, 35298, 35300, 35302, 35304, 35320, 35322, 35324, 35326, 35328, 35330, 35332, 35334, 35336, 35338, 35340, 35342, 35344, 35346, 35348, 35350, 35352, 35354, 35356, 35358, 35360, 35362, 35364, 35366, 35368, 35370, 35372, 35373, 35376, 35378, 35380, 35382, 35384, 35386, 35391, 35393, 35395, 33987, 33986, 33988, 35398, 35400, 35402, 35404, 35406, 35408, 35410, 35412, 35414, 35416, 35418, 35420, 35422, 35424, 35426, 35428, 35430, 35432, 35434, 35436, 35438, 35440, 35442, 35444, 35447, 35449, 35451, 35453, 35455, 35457, 35459, 35461, 35463, 35465, 35466, 35468, 35470, 43835, 45575, 45577, 45871, 45873, 45875, 45877, 45879, 45884, 45889, 49847, 49851, 49852, 49853, 49857, 49858, 49859, 49863, 49864, 49865, 49869, 49870, 49871, 49875, 49876, 49877, 49881, 49882, 49883, 49887, 49888, 50021, 50033, 50035, 50037, 50039, 50129, 50131, 50133, 50169, 50179, 50340, 50387, 50390, 50406, 50450, 50452, 50454, 50471, 50473, 50491, 50615, 50667, 50672, 50674, 50679) AND states.last_updated_ts > 1733830799.999999e0 AND states.last_updated_ts < 1733831100.0e0) AS anon_4) AS anon_1 ORDER BY anon_1.metadata_id, anon_1.last_updated_ts\r\nProgress: 0.000\r\n*************************** 5. row ***************************\r\n      Id: 977\r\n    User: homeassistant\r\n    Host: 172.31.0.1:49244\r\n      db: ha_db\r\n Command: Sleep\r\n    Time: 45\r\n   State: \r\n    Info: NULL\r\nProgress: 0.000\r\n5 rows in set (0.00 sec)\r\n\r\nERROR: \r\nNo query specified\r\n\r\nmysql> \r\n```\nI'm traveling this week so I can't take a look at the moment.\r\n\r\nIf you post some explains of those it might give a clue about why its selecting so many rows\r\n\r\nhttps://dev.mysql.com/doc/refman/8.4/en/explain.html\nStack Traces from murdered queries.\r\n\r\n```omeassistant  | [SQL: SELECT anon_1.metadata_id, anon_1.state, anon_1.last_updated_ts, anon_1.attributes\r\nhomeassistant  | FROM (SELECT anon_2.metadata_id AS metadata_id, anon_2.state AS state, anon_2.last_updated_ts AS last_updated_ts, anon_2.attributes AS attributes\r\nhomeassistant  | FROM (SELECT states.metadata_id AS metadata_id, states.state AS state, %s AS last_updated_ts, CASE WHEN (state_attributes.shared_attrs IS NULL) THEN states.attributes ELSE state_attributes.shared_attrs END AS attributes\r\nhomeassistant  | FROM states INNER JOIN (SELECT states.metadata_id AS max_metadata_id, max(states.last_updated_ts) AS max_last_updated\r\nhomeassistant  | FROM states\r\nhomeassistant  | WHERE states.last_updated_ts >= %s AND states.last_updated_ts < %s AND states.metadata_id IN (%s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s) GROUP BY states.metadata_id) AS anon_3 ON states.metadata_id = anon_3.max_metadata_id AND states.last_updated_ts = anon_3.max_last_updated LEFT OUTER JOIN state_attributes ON states.attributes_id = state_attributes.attributes_id\r\nhomeassistant  | WHERE states.last_updated_ts >= %s AND states.last_updated_ts < %s AND states.metadata_id IN (%s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s)) AS anon_2 UNION ALL SELECT anon_4.metadata_id AS metadata_id, anon_4.state AS state, anon_4.last_updated_ts AS last_updated_ts, anon_4.attributes AS attributes\r\nhomeassistant  | FROM (SELECT states.metadata_id AS metadata_id, states.state AS state, states.last_updated_ts AS last_updated_ts, CASE WHEN (state_attributes.shared_attrs IS NULL) THEN states.attributes ELSE state_attributes.shared_attrs END AS attributes\r\nhomeassistant  | FROM states LEFT OUTER JOIN state_attributes ON states.attributes_id = state_attributes.attributes_id\r\nhomeassistant  | WHERE (states.last_changed_ts = states.last_updated_ts OR states.last_changed_ts IS NULL) AND states.metadata_id IN (%s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s) AND states.last_updated_ts > %s AND states.last_updated_ts < %s) AS anon_4) AS anon_1 ORDER BY anon_1.metadata_id, anon_1.last_updated_ts]\r\nhomeassistant  | [parameters: (0, 1732708152.6401002, 1733830799.999999, 224, 223, 222, 50501, 50518, 50535, 50564, 50581, 50598, 246, 248, 251, 32307, 32308, 32310, 32371, 31965, 31966, 31967, 31968, 31969, 32199, 32141, 32134, 32081, 32085, 32086, 32087, 32091, 32092, 32093, 32097, 32098, 32099, 32103, 32104, 32105, 32109, 32110, 32111, 32115, 32116, 32117, 32121, 32122, 32146, 32150 ... 4092 parameters truncated ... 45884, 45889, 49847, 49851, 49852, 49853, 49857, 49858, 49859, 49863, 49864, 49865, 49869, 49870, 49871, 49875, 49876, 49877, 49881, 49882, 49883, 49887, 49888, 50021, 50033, 50035, 50037, 50039, 50129, 50131, 50133, 50169, 50179, 50340, 50387, 50390, 50406, 50450, 50452, 50454, 50471, 50473, 50491, 50615, 50667, 50672, 50674, 50679, 1733830799.999999, 1733831100.0)]\r\nhomeassistant  | (Background on this error at: https://sqlalche.me/e/20/e3q8)\r\nhomeassistant  | 2024-12-10 15:29:03.316 ERROR (Recorder) [homeassistant.components.recorder.util] Error executing query: Can't reconnect until invalid transaction is rolled back.  Please rollback() fully before proceeding (Background on this error at: https://sqlalche.me/e/20/8s2b)\r\nhomeassistant  | 2024-12-10 15:29:03.454 ERROR (Recorder) [homeassistant.components.recorder.util] Error executing query: Can't reconnect until invalid transaction is rolled back.  Please rollback() fully before proceeding (Background on this error at: https://sqlalche.me/e/20/8s2b)\r\nhomeassistant  | 2024-12-10 15:29:03.505 ERROR (Recorder) [homeassistant.helpers.recorder] Error executing query\r\nhomeassistant  | Traceback (most recent call last):\r\nhomeassistant  |   File \"/usr/src/homeassistant/homeassistant/helpers/recorder.py\", line 101, in session_scope\r\nhomeassistant  |     yield session\r\nhomeassistant  |   File \"/usr/src/homeassistant/homeassistant/components/recorder/statistics.py\", line 484, in compile_missing_statistics\r\nhomeassistant  |     modified_statistic_ids = _compile_statistics(\r\nhomeassistant  |         instance, session, start, end >= last_period\r\nhomeassistant  |     )\r\nhomeassistant  |   File \"/usr/src/homeassistant/homeassistant/components/recorder/statistics.py\", line 566, in _compile_statistics\r\nhomeassistant  |     compiled: PlatformCompiledStatistics = platform_compile_statistics(\r\nhomeassistant  |                                            ~~~~~~~~~~~~~~~~~~~~~~~~~~~^\r\nhomeassistant  |         instance.hass, session, start, end\r\nhomeassistant  |         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\nhomeassistant  |     )\r\nhomeassistant  |     ^\r\nhomeassistant  |   File \"/usr/src/homeassistant/homeassistant/components/sensor/recorder.py\", line 436, in compile_statistics\r\nhomeassistant  |     _history_list = history.get_full_significant_states_with_session(\r\nhomeassistant  |         hass,\r\nhomeassistant  |     ...<3 lines>...\r\nhomeassistant  |         entity_ids=entities_significant_history,\r\nhomeassistant  |     )\r\nhomeassistant  |   File \"/usr/src/homeassistant/homeassistant/components/recorder/history/__init__.py\", line 55, in get_full_significant_states_with_session\r\nhomeassistant  |     return _target(\r\nhomeassistant  |         hass,\r\nhomeassistant  |     ...<7 lines>...\r\nhomeassistant  |         no_attributes,\r\nhomeassistant  |     )\r\nhomeassistant  |   File \"/usr/src/homeassistant/homeassistant/components/recorder/history/modern.py\", line 306, in get_full_significant_states_with_session\r\nhomeassistant  |     get_significant_states_with_session(\r\nhomeassistant  |     ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^\r\nhomeassistant  |         hass=hass,\r\nhomeassistant  |         ^^^^^^^^^^\r\nhomeassistant  |     ...<8 lines>...\r\nhomeassistant  |         no_attributes=no_attributes,\r\nhomeassistant  |         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\nhomeassistant  |     ),\r\nhomeassistant  |     ^\r\nhomeassistant  |   File \"/usr/src/homeassistant/homeassistant/components/recorder/history/modern.py\", line 278, in get_significant_states_with_session\r\nhomeassistant  |     execute_stmt_lambda_element(session, stmt, None, end_time, orm_rows=False),\r\nhomeassistant  |     ~~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\nhomeassistant  |   File \"/usr/src/homeassistant/homeassistant/components/recorder/util.py\", line 197, in execute_stmt_lambda_element\r\nhomeassistant  |     executed = session.connection().execute(stmt)\r\nhomeassistant  |   File \"/usr/local/lib/python3.13/site-packages/sqlalchemy/engine/base.py\", line 1418, in execute\r\nhomeassistant  |     return meth(\r\nhomeassistant  |         self,\r\nhomeassistant  |         distilled_parameters,\r\nhomeassistant  |         execution_options or NO_OPTIONS,\r\nhomeassistant  |     )\r\nhomeassistant  |   File \"/usr/local/lib/python3.13/site-packages/sqlalchemy/sql/lambdas.py\", line 603, in _execute_on_connection\r\nhomeassistant  |     return connection._execute_clauseelement(\r\nhomeassistant  |            ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^\r\nhomeassistant  |         self, distilled_params, execution_options\r\nhomeassistant  |         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\nhomeassistant  |     )\r\nhomeassistant  |     ^\r\nhomeassistant  |   File \"/usr/local/lib/python3.13/site-packages/sqlalchemy/engine/base.py\", line 1640, in _execute_clauseelement\r\nhomeassistant  |     ret = self._execute_context(\r\nhomeassistant  |         dialect,\r\nhomeassistant  |     ...<8 lines>...\r\nhomeassistant  |         cache_hit=cache_hit,\r\nhomeassistant  |     )\r\nhomeassistant  |   File \"/usr/local/lib/python3.13/site-packages/sqlalchemy/engine/base.py\", line 1813, in _execute_context\r\nhomeassistant  |     conn = self._revalidate_connection()\r\nhomeassistant  |   File \"/usr/local/lib/python3.13/site-packages/sqlalchemy/engine/base.py\", line 677, in _revalidate_connection\r\nhomeassistant  |     self._invalid_transaction()\r\nhomeassistant  |     ~~~~~~~~~~~~~~~~~~~~~~~~~^^\r\nhomeassistant  |   File \"/usr/local/lib/python3.13/site-packages/sqlalchemy/engine/base.py\", line 667, in _invalid_transaction\r\nhomeassistant  |     raise exc.PendingRollbackError(\r\nhomeassistant  |     ...<4 lines>...\r\nhomeassistant  |     )\r\nhomeassistant  | sqlalchemy.exc.PendingRollbackError: Can't reconnect until invalid transaction is rolled back.  Please rollback() fully before proceeding (Background on this error at: https://sqlalche.me/e/20/8s2b)\r\nhomeassistant  | 2024-12-10 15:29:03.557 ERROR (Recorder) [homeassistant.components.recorder.core] SQLAlchemyError error processing task CompileMissingStatisticsTask()\r\nhomeassistant  | Traceback (most recent call last):\r\nhomeassistant  |   File \"/usr/src/homeassistant/homeassistant/components/recorder/core.py\", line 882, in _process_one_task_or_event_or_recover\r\nhomeassistant  |     task.run(self)\r\nhomeassistant  |     ~~~~~~~~^^^^^^\r\nhomeassistant  |   File \"/usr/src/homeassistant/homeassistant/components/recorder/tasks.py\", line 182, in run\r\nhomeassistant  |     if statistics.compile_missing_statistics(instance):\r\nhomeassistant  |        ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^\r\nhomeassistant  |   File \"/usr/src/homeassistant/homeassistant/components/recorder/util.py\", line 689, in wrapper\r\nhomeassistant  |     return job(*args, **kwargs)\r\nhomeassistant  |   File \"/usr/src/homeassistant/homeassistant/components/recorder/statistics.py\", line 484, in compile_missing_statistics\r\nhomeassistant  |     modified_statistic_ids = _compile_statistics(\r\nhomeassistant  |         instance, session, start, end >= last_period\r\nhomeassistant  |     )\r\nhomeassistant  |   File \"/usr/src/homeassistant/homeassistant/components/recorder/statistics.py\", line 566, in _compile_statistics\r\nhomeassistant  |     compiled: PlatformCompiledStatistics = platform_compile_statistics(\r\nhomeassistant  |                                            ~~~~~~~~~~~~~~~~~~~~~~~~~~~^\r\nhomeassistant  |         instance.hass, session, start, end\r\nhomeassistant  |         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\nhomeassistant  |     )\r\nhomeassistant  |     ^\r\nhomeassistant  |   File \"/usr/src/homeassistant/homeassistant/components/sensor/recorder.py\", line 436, in compile_statistics\r\nhomeassistant  |     _history_list = history.get_full_significant_states_with_session(\r\nhomeassistant  |         hass,\r\nhomeassistant  |     ...<3 lines>...\r\nhomeassistant  |         entity_ids=entities_significant_history,\r\nhomeassistant  |     )\r\nhomeassistant  |   File \"/usr/src/homeassistant/homeassistant/components/recorder/history/__init__.py\", line 55, in get_full_significant_states_with_session\r\nhomeassistant  |     return _target(\r\nhomeassistant  |         hass,\r\nhomeassistant  |     ...<7 lines>...\r\nhomeassistant  |         no_attributes,\r\nhomeassistant  |     )\r\nhomeassistant  |   File \"/usr/src/homeassistant/homeassistant/components/recorder/history/modern.py\", line 306, in get_full_significant_states_with_session\r\nhomeassistant  |     get_significant_states_with_session(\r\nhomeassistant  |     ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^\r\nhomeassistant  |         hass=hass,\r\nhomeassistant  |         ^^^^^^^^^^\r\nhomeassistant  |     ...<8 lines>...\r\nhomeassistant  |         no_attributes=no_attributes,\r\nhomeassistant  |         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\nhomeassistant  |     ),\r\nhomeassistant  |     ^\r\nhomeassistant  |   File \"/usr/src/homeassistant/homeassistant/components/recorder/history/modern.py\", line 278, in get_significant_states_with_session\r\nhomeassistant  |     execute_stmt_lambda_element(session, stmt, None, end_time, orm_rows=False),\r\nhomeassistant  |     ~~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\nhomeassistant  |   File \"/usr/src/homeassistant/homeassistant/components/recorder/util.py\", line 197, in execute_stmt_lambda_element\r\nhomeassistant  |     executed = session.connection().execute(stmt)\r\nhomeassistant  |   File \"/usr/local/lib/python3.13/site-packages/sqlalchemy/engine/base.py\", line 1418, in execute\r\nhomeassistant  |     return meth(\r\nhomeassistant  |         self,\r\nhomeassistant  |         distilled_parameters,\r\nhomeassistant  |         execution_options or NO_OPTIONS,\r\nhomeassistant  |     )\r\nhomeassistant  |   File \"/usr/local/lib/python3.13/site-packages/sqlalchemy/sql/lambdas.py\", line 603, in _execute_on_connection\r\nhomeassistant  |     return connection._execute_clauseelement(\r\nhomeassistant  |            ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^\r\nhomeassistant  |         self, distilled_params, execution_options\r\nhomeassistant  |         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\nhomeassistant  |     )\r\nhomeassistant  |     ^\r\nhomeassistant  |   File \"/usr/local/lib/python3.13/site-packages/sqlalchemy/engine/base.py\", line 1640, in _execute_clauseelement\r\nhomeassistant  |     ret = self._execute_context(\r\nhomeassistant  |         dialect,\r\nhomeassistant  |     ...<8 lines>...\r\nhomeassistant  |         cache_hit=cache_hit,\r\nhomeassistant  |     )\r\nhomeassistant  |   File \"/usr/local/lib/python3.13/site-packages/sqlalchemy/engine/base.py\", line 1813, in _execute_context\r\nhomeassistant  |     conn = self._revalidate_connection()\r\nhomeassistant  |   File \"/usr/local/lib/python3.13/site-packages/sqlalchemy/engine/base.py\", line 677, in _revalidate_connection\r\nhomeassistant  |     self._invalid_transaction()\r\nhomeassistant  |     ~~~~~~~~~~~~~~~~~~~~~~~~~^^\r\nhomeassistant  |   File \"/usr/local/lib/python3.13/site-packages/sqlalchemy/engine/base.py\", line 667, in _invalid_transaction\r\nhomeassistant  |     raise exc.PendingRollbackError(\r\nhomeassistant  |     ...<4 lines>...\r\nhomeassistant  |     )\r\nhomeassistant  | sqlalchemy.exc.PendingRollbackError: Can't reconnect until invalid transaction is rolled back.  Please rollback() fully before proceeding (Background on this error at: https://sqlalche.me/e/20/8s2b)\r\n```\n> I'm traveling this week so I can't take a look at the moment.\r\n> \r\n> If you post some explains of those it might give a clue about why its selecting so many rows\r\n> \r\n> https://dev.mysql.com/doc/refman/8.4/en/explain.html\r\n\r\nNP!  Just vomiting up info hope to help get it resolved :D \n```+------+-------------+------------------+--------+-----------------------------------------------------------------+---------------------------------------+---------+-------------------------------------------------------+---------+------------------------------------+\r\n| id   | select_type | table            | type   | possible_keys                                                   | key                                   | key_len | ref                                                   | rows    | Extra                              |\r\n+------+-------------+------------------+--------+-----------------------------------------------------------------+---------------------------------------+---------+-------------------------------------------------------+---------+------------------------------------+\r\n|    1 | PRIMARY     | <derived2>       | ALL    | NULL                                                            | NULL                                  | NULL    | NULL                                                  | 5245201 | Using filesort                     |\r\n|    2 | DERIVED     | <derived8>       | ALL    | distinct_key                                                    | NULL                                  | NULL    | NULL                                                  | 1395    |                                    |\r\n|    2 | DERIVED     | states           | ref    | ix_states_last_updated_ts,ix_states_metadata_id_last_updated_ts | ix_states_metadata_id_last_updated_ts | 9       | tvc_0._col_1                                          | 376     | Using index condition              |\r\n|    2 | DERIVED     | state_attributes | eq_ref | PRIMARY                                                         | PRIMARY                               | 8       | ha_db.states.attributes_id                            | 1       | Using where                        |\r\n|    2 | DERIVED     | <derived4>       | ref    | key0                                                            | key0                                  | 18      | ha_db.states.metadata_id,ha_db.states.last_updated_ts | 10      |                                    |\r\n|    8 | DERIVED     | NULL             | NULL   | NULL                                                            | NULL                                  | NULL    | NULL                                                  | NULL    | No tables used                     |\r\n|    4 | DERIVED     | <derived10>      | ALL    | distinct_key                                                    | NULL                                  | NULL    | NULL                                                  | 1395    | Using temporary; Using filesort    |\r\n|    4 | DERIVED     | states           | ref    | ix_states_last_updated_ts,ix_states_metadata_id_last_updated_ts | ix_states_metadata_id_last_updated_ts | 9       | tvc_0._col_1                                          | 376     | Using where; Using index           |\r\n|   10 | DERIVED     | NULL             | NULL   | NULL                                                            | NULL                                  | NULL    | NULL                                                  | NULL    | No tables used                     |\r\n|    5 | UNION       | states           | range  | ix_states_last_updated_ts,ix_states_metadata_id_last_updated_ts | ix_states_last_updated_ts             | 9       | NULL                                                  | 1       | Using index condition; Using where |\r\n|    5 | UNION       | state_attributes | eq_ref | PRIMARY                                                         | PRIMARY                               | 8       | ha_db.states.attributes_id                            | 1       | Using where                        |\r\n|    5 | UNION       | <derived12>      | eq_ref | distinct_key                                                    | distinct_key                          | 4       | ha_db.states.metadata_id                              | 1       | Using where                        |\r\n|   12 | DERIVED     | NULL             | NULL   | NULL                                                            | NULL                                  | NULL    | NULL                                                  | NULL    | No tables used                     |\r\n+------+-------------+------------------+--------+-----------------------------------------------------------------+---------------------------------------+---------+-------------------------------------------------------+---------+------------------------------------+\r\n```\nI have the same problem on 2024.12.2. [https://community.home-assistant.io/t/creating-sort-index-on-mariadb-and-statistics-not-updating/808387/2](url). I've been stuck for 24 hours now on a 24gb database. Almost like the case after the 2024.8 database upgrade snafoo.\r\nSo massive bump on this.\nSame problem here. Postgresql is getting choked by these SELECTs. Seems to have started with 2024.12.\r\n\r\n```\r\n~$ psql -A -c 'select * from pg_stat_activity ;'\r\ndatid|datname|pid|leader_pid|usesysid|usename|application_name|client_addr|client_hostname|client_port|backend_start|xact_start|query_start|state_change|wait_event_type|wait_event|state|backend_xid|backend_xmin|query_id|query|backend_type\r\n\r\n16597|hass|2698008||16386|hass||127.0.0.1||38968|2024-12-11 12:19:22.602254+00|2024-12-11 12:20:33.796924+00|2024-12-11 12:20:33.822763+00|2024-12-11 12:20:33.822765+00|IO|DataFileRead|active||49508101||SELECT anon_1.metadata_id, anon_1.state, anon_1.last_updated_ts, anon_1.last_changed_ts, anon_1.attributes \r\nFROM (SELECT anon_2.metadata_id AS metadata_id, anon_2.state AS state, anon_2.last_updated_ts AS last_updated_ts, anon_2.last_changed_ts AS last_changed_ts, anon_2.attributes AS attributes \r\nFROM (SELECT states.metadata_id AS metadata_id, states.state AS state, 0 AS last_updated_ts, 0 AS last_changed_ts, CASE WHEN (state_attributes.shared_attrs IS NULL) THEN states.attributes ELSE state_attributes.shared_attrs END AS attributes \r\nFROM states JOIN (SELECT states.metadata_id AS max_metadata_id, max(states.last_updated_ts) AS max_last_updated \r\nFROM states \r\nWHERE states.last_updated_ts >= 1668568337.475832 AND states.last_updated_ts < 1733899499.999999 AND states.metadata_id IN (2169, 2170, 485, 661, 672, 673, 753, 754, 755, 756, 759, 450, 463, 483, 2003, 2004, 2007, 2008, 2009, 2000, 2001, 1968, 627, 569, 570, 571, 572, 573, 574, 591, 592, 593, 634, 643, 1559, 1537, 1546, 1741, 1742, 1743, 1745, 1751, 1753, 1756, 1757, 1758, 1759, 1760, 1761, 421, 2, 7, 20, 12, 2118, 2120, 2135, 2137, 494, 502, 511, 549, 554, 561, 566, 929, 935, 1313, 1314, 1315, 608) GROUP BY states.metadata_id) AS anon_3 ON states.metadata_id = anon_3.max_metadata_id AND states.last_updated_ts = anon_3.max_last_updated LEFT OUTER JOIN state_attributes ON states.attributes_id = state_attributes.attributes_id \r\nWHERE states.last_updated_ts >= 1668568337.475832 AND states.last_updated_ts < 1733899499.999999 AND states.metadata_id IN (2169, 2170, 485, 661, 672, 673, 753, 754, 755, 756, 759, 450, 463, 483, 2003, 2004, 2007, 2008, 2009, 2000, 2001, 1968, 627, 569, 570, 571, 572, 573, 574, 591, 592, 593, 634, 643, 1559, 1537, 1546, 1741, 1742, 1743, 1745, 1751, 1753, 1756, 1757, 1758, 1759, 1760, 1761, 421, 2, 7, 20, 12, 2118, 2120, 2135, 2137, 494, 502, 511, 549, 554, 561, 566, 929, 935, 1313, 1314, 1315, 608)) AS anon_2 UNION ALL SELECT anon_4.metadata_id AS metadata_id, anon_4.state AS state, anon_4.last_updated_ts AS last_updated_ts, anon_4.last_changed_ts AS last_changed_ts, anon_4.attributes AS attributes \r\nFROM (SELECT states.metadata_id AS metadata_id, states.state AS state, states.last_updated_ts AS last_updated_ts, states.last_changed_ts AS last_changed_ts, CASE WHEN (state_attributes.shared_attrs IS NULL) THEN states.attributes ELSE state_attributes.shared_attrs END AS attributes \r\nFROM states LEFT OUTER JOIN state_attributes ON states.attributes_id = state_attributes.attributes_id \r\nWHERE states.metadata_id IN (2169, 2170, 485, 661, 672, 673, 753, 754, 755, 756, 759, 450, 463, 483, 2003, 2004, 2007, 2008, 2009, 2000, 2001, 1968, 627, 569, 570, 571, 572, 573, 574, 591, 592, 593, 634, 643, 1559, 1537, 1546, 1741, 1742, 1743, 1745, 1751, 1753, 1756, 1757, 1758, 1759, 1760, 1761, 421, 2, 7, 20, 12, 2118, 2120, 2135, 2137, 494, 502, 511, 549, 554, 561, 566, 929, 935, 1313, 1314, 1315, 608) AND states.last_updated_ts > 1733899499.999999 AND states.last_updated_ts < 1733899800.0) AS anon_4) AS anon_1 ORDER BY anon_1.metadata_id, anon_1.last_updated_ts|client backend`\r\n```\r\n\r\nHere's an explain analyze from Postgres:\r\n                                                               \r\n> QUERY PLAN                                                                                                                                                                                                                                                                        \r\n> ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------\r\n\r\n>  Sort  (cost=7294986.81..7294986.83 rows=9 width=572) (actual time=106296.257..111217.361 rows=395 loops=1)\r\n>    Sort Key: \"*SELECT* 1\".metadata_id, ((0)::double precision)\r\n>    Sort Method: quicksort  Memory: 110kB\r\n>    ->  Append  (cost=7292978.19..7294986.67 rows=9 width=572) (actual time=106294.162..111217.134 rows=395 loops=1)\r\n>          ->  Subquery Scan on \"*SELECT* 1\"  (cost=7292978.19..7294844.21 rows=1 width=62) (actual time=106294.162..111215.900 rows=71 loops=1)\r\n>                ->  Nested Loop Left Join  (cost=7292978.19..7294844.19 rows=1 width=54) (actual time=106294.159..111215.890 rows=71 loops=1)\r\n>                      ->  Nested Loop  (cost=7292977.76..7294836.80 rows=1 width=54) (actual time=106293.475..111214.851 rows=71 loops=1)\r\n>                            ->  Finalize GroupAggregate  (cost=7292977.01..7293078.80 rows=200 width=16) (actual time=106293.425..111214.607 rows=71 loops=1)\r\n>                                  Group Key: states_1.metadata_id\r\n>                                  ->  Gather Merge  (cost=7292977.01..7293072.80 rows=800 width=16) (actual time=106293.394..111214.544 rows=355 loops=1)\r\n>                                        Workers Planned: 4\r\n>                                        Workers Launched: 4\r\n>                                        ->  Sort  (cost=7291976.95..7291977.45 rows=200 width=16) (actual time=106190.916..106190.923 rows=71 loops=5)\r\n>                                              Sort Key: states_1.metadata_id\r\n>                                              Sort Method: quicksort  Memory: 27kB\r\n>                                              Worker 0:  Sort Method: quicksort  Memory: 27kB\r\n>                                              Worker 1:  Sort Method: quicksort  Memory: 27kB\r\n>                                              Worker 2:  Sort Method: quicksort  Memory: 27kB\r\n>                                              Worker 3:  Sort Method: quicksort  Memory: 27kB\r\n>                                              ->  Partial HashAggregate  (cost=7291967.31..7291969.31 rows=200 width=16) (actual time=106190.844..106190.859 rows=71 loops=5)\r\n>                                                    Group Key: states_1.metadata_id\r\n>                                                    Batches: 1  Memory Usage: 40kB\r\n>                                                    Worker 0:  Batches: 1  Memory Usage: 40kB\r\n>                                                    Worker 1:  Batches: 1  Memory Usage: 40kB\r\n>                                                    Worker 2:  Batches: 1  Memory Usage: 40kB\r\n>                                                    Worker 3:  Batches: 1  Memory Usage: 40kB\r\n>                                                    ->  Parallel Seq Scan on states states_1  (cost=0.18..7147716.66 rows=28850129 width=16) (actual time=464.436..104908.228 rows=6480979 loops=5)\r\n>                                                          Filter: ((last_updated_ts >= '1668568337.475832'::double precision) AND (last_updated_ts < '1733899499.999999'::double precision) AND (metadata_id = ANY ('{2169,2170,485,661,672,673,753,754,755,756,759,450,463,483,2003,2004,2007,2008,2009,2000,2001,1968,627,569,570,571,572,573,574,591,592,593,634,643,1559,1537,1546,1741,1742,1743,1745,1751,1753,1756,1757,1758,1759,1760,1761,421,2,7,20,12,2118,2120,2135,2137,494,502,511,549,554,561,566,929,935,1313,1314,1315,608}'::bigint[])))\r\n>                                                          Rows Removed by Filter: 64233791\r\n>                            ->  Index Scan using ix_states_last_updated_ts on states  (cost=0.75..8.78 rows=1 width=62) (actual time=0.003..0.003 rows=1 loops=71)\r\n>                                  Index Cond: ((last_updated_ts = (max(states_1.last_updated_ts))) AND (last_updated_ts >= '1668568337.475832'::double precision) AND (last_updated_ts < '1733899499.999999'::double precision))\r\n>                                  Filter: ((metadata_id = states_1.metadata_id) AND (metadata_id = ANY ('{2169,2170,485,661,672,673,753,754,755,756,759,450,463,483,2003,2004,2007,2008,2009,2000,2001,1968,627,569,570,571,572,573,574,591,592,593,634,643,1559,1537,1546,1741,1742,1743,1745,1751,1753,1756,1757,1758,1759,1760,1761,421,2,7,20,12,2118,2120,2135,2137,494,502,511,549,554,561,566,929,935,1313,1314,1315,608}'::bigint[])))\r\n>                      ->  Index Scan using state_attributes_pkey on state_attributes  (cost=0.43..7.39 rows=1 width=255) (actual time=0.014..0.014 rows=1 loops=71)\r\n>                            Index Cond: (attributes_id = states.attributes_id)\r\n>          ->  Nested Loop Left Join  (cost=1.19..142.42 rows=8 width=62) (actual time=0.028..1.209 rows=324 loops=1)\r\n>                ->  Index Scan using ix_states_last_updated_ts on states states_2  (cost=0.75..74.80 rows=8 width=70) (actual time=0.018..0.737 rows=324 loops=1)\r\n>                      Index Cond: ((last_updated_ts > '1733899499.999999'::double precision) AND (last_updated_ts < '1733899800'::double precision))\r\n>                      Filter: (metadata_id = ANY ('{2169,2170,485,661,672,673,753,754,755,756,759,450,463,483,2003,2004,2007,2008,2009,2000,2001,1968,627,569,570,571,572,573,574,591,592,593,634,643,1559,1537,1546,1741,1742,1743,1745,1751,1753,1756,1757,1758,1759,1760,1761,421,2,7,20,12,2118,2120,2135,2137,494,502,511,549,554,561,566,929,935,1313,1314,1315,608}'::bigint[]))\r\n>                      Rows Removed by Filter: 1713\r\n>                ->  Index Scan using state_attributes_pkey on state_attributes state_attributes_1  (cost=0.43..8.45 rows=1 width=255) (actual time=0.001..0.001 rows=1 loops=324)\r\n>                      Index Cond: (attributes_id = states_2.attributes_id)\r\n>  Planning Time: 0.777 ms\r\n>  JIT:\r\n>    Functions: 71\r\n>    Options: Inlining true, Optimization true, Expressions true, Deforming true\r\n>    Timing: Generation 12.758 ms, Inlining 441.125 ms, Optimization 1096.428 ms, Emission 632.528 ms, Total 2182.839 ms\r\n>  Execution Time: 111219.685 ms\r\n> (47 rows)\r\n> \r\n\nas a stop gap i've added `max_statement_time = 600` to my mariadb.conf.  Kills any query running for more than 10m.  Not great, but appears to unblock things.\r\n\r\nThe pattern is interesting, every 30min is when it gets stuck.\r\n\r\n```root@donnager:~# hadc logs homeassistant | egrep \"Error executing compile statistics\"\r\nhomeassistant  | 2024-12-11 01:01:47.496 WARNING (Recorder) [homeassistant.components.recorder.util] Error executing compile statistics: (MySQLdb.OperationalError) (1969, 'Query execution was interrupted (max_statement_time exceeded)')\r\nhomeassistant  | 2024-12-11 01:31:52.475 WARNING (Recorder) [homeassistant.components.recorder.util] Error executing compile statistics: (MySQLdb.OperationalError) (1969, 'Query execution was interrupted (max_statement_time exceeded)')\r\nhomeassistant  | 2024-12-11 02:01:58.216 WARNING (Recorder) [homeassistant.components.recorder.util] Error executing compile statistics: (MySQLdb.OperationalError) (1969, 'Query execution was interrupted (max_statement_time exceeded)')\r\nhomeassistant  | 2024-12-11 02:32:05.135 WARNING (Recorder) [homeassistant.components.recorder.util] Error executing compile statistics: (MySQLdb.OperationalError) (1969, 'Query execution was interrupted (max_statement_time exceeded)')\r\nhomeassistant  | 2024-12-11 03:02:11.138 WARNING (Recorder) [homeassistant.components.recorder.util] Error executing compile statistics: (MySQLdb.OperationalError) (1969, 'Query execution was interrupted (max_statement_time exceeded)')\r\nhomeassistant  | 2024-12-11 03:32:16.489 WARNING (Recorder) [homeassistant.components.recorder.util] Error executing compile statistics: (MySQLdb.OperationalError) (1969, 'Query execution was interrupted (max_statement_time exceeded)')\r\nhomeassistant  | 2024-12-11 04:02:22.932 WARNING (Recorder) [homeassistant.components.recorder.util] Error executing compile statistics: (MySQLdb.OperationalError) (1969, 'Query execution was interrupted (max_statement_time exceeded)')\r\nhomeassistant  | 2024-12-11 04:32:29.468 WARNING (Recorder) [homeassistant.components.recorder.util] Error executing compile statistics: (MySQLdb.OperationalError) (1969, 'Query execution was interrupted (max_statement_time exceeded)')\r\nhomeassistant  | 2024-12-11 05:02:38.035 WARNING (Recorder) [homeassistant.components.recorder.util] Error executing compile statistics: (MySQLdb.OperationalError) (1969, 'Query execution was interrupted (max_statement_time exceeded)')\r\nhomeassistant  | 2024-12-11 05:32:43.452 WARNING (Recorder) [homeassistant.components.recorder.util] Error executing compile statistics: (MySQLdb.OperationalError) (1969, 'Query execution was interrupted (max_statement_time exceeded)')\r\nhomeassistant  | 2024-12-11 06:02:52.965 WARNING (Recorder) [homeassistant.components.recorder.util] Error executing compile statistics: (MySQLdb.OperationalError) (1969, 'Query execution was interrupted (max_statement_time exceeded)')\r\nhomeassistant  | 2024-12-11 06:32:58.990 WARNING (Recorder) [homeassistant.components.recorder.util] Error executing compile statistics: (MySQLdb.OperationalError) (1969, 'Query execution was interrupted (max_statement_time exceeded)')\r\nhomeassistant  | 2024-12-11 07:03:09.276 WARNING (Recorder) [homeassistant.components.recorder.util] Error executing compile statistics: (MySQLdb.OperationalError) (1969, 'Query execution was interrupted (max_statement_time exceeded)')\r\nhomeassistant  | 2024-12-11 07:33:14.342 WARNING (Recorder) [homeassistant.components.recorder.util] Error executing compile statistics: (MySQLdb.OperationalError) (1969, 'Query execution was interrupted (max_statement_time exceeded)')\r\nhomeassistant  | 2024-12-11 08:03:20.446 WARNING (Recorder) [homeassistant.components.recorder.util] Error executing compile statistics: (MySQLdb.OperationalError) (1969, 'Query execution was interrupted (max_statement_time exceeded)')\r\nhomeassistant  | 2024-12-11 08:33:26.123 WARNING (Recorder) [homeassistant.components.recorder.util] Error executing compile statistics: (MySQLdb.OperationalError) (1969, 'Query execution was interrupted (max_statement_time exceeded)')\r\nhomeassistant  | 2024-12-11 09:03:35.520 WARNING (Recorder) [homeassistant.components.recorder.util] Error executing compile statistics: (MySQLdb.OperationalError) (1969, 'Query execution was interrupted (max_statement_time exceeded)')\r\nhomeassistant  | 2024-12-11 09:33:46.294 WARNING (Recorder) [homeassistant.components.recorder.util] Error executing compile statistics: (MySQLdb.OperationalError) (1969, 'Query execution was interrupted (max_statement_time exceeded)')\r\nhomeassistant  | 2024-12-11 10:03:57.440 WARNING (Recorder) [homeassistant.components.recorder.util] Error executing compile statistics: (MySQLdb.OperationalError) (1969, 'Query execution was interrupted (max_statement_time exceeded)')\r\nhomeassistant  | 2024-12-11 10:34:09.224 WARNING (Recorder) [homeassistant.components.recorder.util] Error executing compile statistics: (MySQLdb.OperationalError) (1969, 'Query execution was interrupted (max_statement_time exceeded)')\r\nroot@donnager:~# hadc logs homeassistant | egrep \"Error executing compile statistics\" | wc -l\r\n20\r\n```\nI'm gonna try this MariaDB setting. Fun thing, when I killed the long-running create index process sort of pushes all missing grafs, one after one they fill upp with data. Energy though is completely broken, it seems to have tried to summarize mny consumtion this year into one bar.\nCan you pls advice, where to find this DB setting?\r\nI think i got the same issue, RPi5 nvme drive and latest HA version\nSame issue here since the update, 150G postgres database. Its doing something heavy over and over and over again.\r\n![Screenshot 2024-12-12 at 11 32 55](https://github.com/user-attachments/assets/dd3eca68-8fe3-4b2d-809b-0940755eac12)\r\n\n> Can you pls advice, where to find this DB setting? I think i got the same issue, RPi5 nvme drive and latest HA version\r\n\r\nI my case I run MariaDB and use phpMyAdmin as management. The max statement time setting can be found under Variables. \r\n![image](https://github.com/user-attachments/assets/f39f175b-cebe-4747-8163-ab1140bd2d97)\r\n\r\nSetting this to 600 seems to have stopped the long running \"Creat Sort Index\" tasks for me but the task soon restarts and statistics aren't getting updated at the moment.\r\n\nI think what happened is that the query to find the start time state is now selecting a significantly larger time block after the bug fix in #131702.  The problem is that the query to get the func.max can only be optimized away to use the index with MySQL or PostgreSQL when it\u2019s a selecting a single value/entity. With the larger time window it has to potentially look at millions of rows.\n\nWe might be able to better optimize that query by doing recursive query for the start time state instead.  Unfortunately I don\u2019t thin it will be a simple fix as it will take a long time to work out query that performs well with all supported database engines.\n\nI\u2019ll need an sql dump of an affected postgresql and MySQL database along with a log of the slow query to be able to tune each one\r\n\r\nIf anyone is willing to share my gdrive is bdraco@gmail.com or my Dropbox is nick@koston.org\n> I\u2019ll need an sql dump of an affected postgresql and MySQL database along with a log of the slow query to be able to tune each one\r\n> \r\n> If anyone is willing to share my gdrive is [bdraco@gmail.com](mailto:bdraco@gmail.com) or my Dropbox is [nick@koston.org](mailto:nick@koston.org)\r\n\r\nI can assist with whatever can aid in a solution. As things stand right now I'm lacking core HA functionality.\r\nI'm exporting the database right now but I'm unsure how to \"log the query\". Do you need the select command that is running?\n> > I\u2019ll need an sql dump of an affected postgresql and MySQL database along with a log of the slow query to be able to tune each one\n> \n> > \n> \n> > If anyone is willing to share my gdrive is [bdraco@gmail.com](mailto:bdraco@gmail.com) or my Dropbox is [nick@koston.org](mailto:nick@koston.org)\n> \n> \n> \n> I can assist with whatever can aid in a solution. As things stand right now I'm lacking core HA functionality.\n> \n> I'm exporting the database right now but I'm unsure how to \"log the query\". Do you need the select command that is running?\n\nYes the select command is the query I'm looking for \n> > > I\u2019ll need an sql dump of an affected postgresql and MySQL database along with a log of the slow query to be able to tune each one\r\n> > \r\n> > \r\n> > > \r\n> > \r\n> > \r\n> > > If anyone is willing to share my gdrive is [bdraco@gmail.com](mailto:bdraco@gmail.com) or my Dropbox is [nick@koston.org](mailto:nick@koston.org)\r\n> > \r\n> > \r\n> > I can assist with whatever can aid in a solution. As things stand right now I'm lacking core HA functionality.\r\n> > I'm exporting the database right now but I'm unsure how to \"log the query\". Do you need the select command that is running?\r\n> \r\n> Yes the select command is the query I'm looking for\r\n\r\nSELECT anon_1.metadata_id, anon_1.state, anon_1.last_updated_ts, anon_1.attributes FROM (SELECT anon_2.metadata_id AS metadata_id, anon_2.state AS state, anon_2.last_updated_ts AS last_updated_ts, anon_2.attributes AS attributes FROM (SELECT states.metadata_id AS metadata_id, states.state AS state, 0 AS last_updated_ts, CASE WHEN (state_attributes.shared_attrs IS NULL) THEN states.attributes ELSE state_attributes.shared_attrs END AS attributes FROM states INNER JOIN (SELECT states.metadata_id AS max_metadata_id, max(states.last_updated_ts) AS max_last_updated FROM states WHERE states.last_updated_ts >= 1731219794.579708e0 AND states.last_updated_ts < 1733999399.999999e0 AND states.metadata_id IN (301, 6280, 7616, 10297, 11317, 11738, 11745, 488, 492, 493, 83, 6499, 7871, 10571, 496, 314, 6487, 14138, 6574, 10650, 64, 336, 338, 40, 43, 339, 2027, 2021, 8732, 340, 7868, 7939, 345, 346, 347, 348, 1424, 351, 8507, 14, 354, 2090, 8679, 13989, 1581, 6316, 355, 2, 10555, 81, 337, 1186, 6414, 6227, 344, 87, 353, 357, 358, 1457, 1197, 1844, 6366, 6472, 1381, 7875, 8390, 10330, 10688, 12065, 12170, 13611, 343, 6488, 14139, 6575, 10651, 53, 359, 361, 75, 55, 362, 2028, 2022, 8733, 363, 7869, 7940, 368, 369, 370, 371, 1425, 374, 8508, 33, 377, 2091, 8680, 13990, 1582, 6317, 378, 80, 10556, 20, 360, 1187, 6415, 6228, 367, 56, 376, 380, 381, 1456, 1198, 1845, 6367, 6473, 1365, 7876, 8391, 10331, 10689, 12066, 12171, 13612, 366, 6241, 6242, 6243, 8436, 8437, 8438, 10541, 8467, 8439, 8440, 8441, 10542, 8468, 421, 422, 423, 7595, 2264, 2266, 2289, 2290, 2291, 2292, 2293, 2294, 2295, 2075, 2238, 7926, 7928, 6468, 6470, 417, 419, 8682, 12153, 12154, 14120, 14121, 14556, 15815, 15816, 15823, 15824, 16037, 16038, 14150, 14151, 14826, 14827, 16208, 16209, 16210, 16211, 16212, 16201, 16222, 16202, 16203, 16204, 16205, 16206, 16207, 16217, 16218, 16219, 16220, 16221, 16225, 16226, 16227, 16228, 16229, 16563, 16564, 16565, 16566, 16567, 13981, 13669, 13677, 13668, 7246, 7245, 7247, 7243, 16271, 16272, 16273, 16270, 16028, 16029, 16027, 16031, 16032, 16030, 16233, 16234, 16232, 16267, 16268, 16269, 16266, 16236, 16237, 16238, 16235, 15905, 15906, 14919, 15904, 15879, 15880, 15884, 15924, 15878, 15881, 15883, 15882, 15885, 16069, 792, 16070, 791, 15961, 15962, 15963, 15960, 16042, 12682, 16043, 757, 16044, 16045, 16055, 6236, 16056, 16072, 16067, 748, 16068, 746, 13889, 11350, 13890, 11351, 16061, 749, 16062, 747, 7143, 7142, 775, 774, 776, 10267, 10268, 10269, 10264, 10311, 10265, 10266, 10270, 10271, 10272, 8420, 8422, 8421, 6630, 6631, 6632, 6633, 6634, 16263, 1799, 882, 884, 885, 883, 874, 8172, 7877, 7494, 16533, 16538, 16535, 16536, 16537, 16511, 16512, 1995, 1997, 10370, 7900, 666, 668, 664, 658, 670, 674, 672, 680, 11374, 688, 692, 712, 708, 706, 694, 710, 655, 716, 700, 662, 676, 660, 698, 656, 6304, 8600, 8602, 13833, 10014, 16494, 16496, 6392, 6398, 6308, 11358, 11256, 888, 11141, 2097, 2095, 2098, 2105, 2104, 1042, 1043, 1044, 724, 722, 1064, 1116, 1118, 1120, 342, 365, 356, 379, 341, 364, 78, 34, 350, 373, 1448, 1447, 1528, 1524, 1526, 1523, 1879, 1880, 1537, 1539, 1906, 1907, 1350, 1301, 1061, 1543, 1544, 1972, 1974, 1556, 1545, 1983, 2020, 1559, 1546, 1549, 1551, 1547, 1554, 1555, 1552, 1564, 1565, 1250, 1346, 349, 372, 1709, 1708, 1740, 1739, 1750, 1751, 2083, 2084, 2085, 2086, 2087, 2088, 6412, 6413, 6486, 6518, 6519, 6520, 6521, 6524, 6525, 6530, 6531, 6576, 6577, 6642, 6643, 6644, 6645, 1226, 1213, 6652, 6653, 6656, 6657, 6664, 6665, 6666, 6667, 6673, 6674, 6679, 6680, 6721, 6722, 6750, 6751, 6752, 6753, 6767, 6768, 6841, 6842, 6853, 6854, 6856, 6857, 6858, 6859, 6860, 6861, 6862, 6863, 6877, 6878, 6962, 6963, 7026, 7027, 7065, 7066, 7091, 7092, 7112, 7113, 7411, 7412, 7564, 7565, 7793, 7794, 7795, 7796, 7812, 7813, 7837, 7838, 7839, 7840, 7841, 7842, 7843, 7844, 7846, 7847, 7854, 7855, 7864, 7865, 8023, 8042, 8043, 8070, 8071, 8081, 8082, 8118, 8119, 8221, 8222, 8226, 8227, 8241, 8242, 8262, 8263, 8264, 8265, 8275, 8276, 8337, 8338, 8382, 8383, 8442, 8443, 8454, 8455, 8721, 8722, 8728, 8729, 10133, 10134, 10135, 10136, 10137, 10138, 10143, 10144, 10201, 10202, 10324, 10325, 10366, 10367, 10382, 10383, 10505, 10506, 10507, 10508, 10511, 10512, 10514, 10515, 10516, 10517, 10530, 10531, 10558, 10559, 10560, 10561, 10575, 10576, 10598, 10599, 10657, 10658, 10659, 10660, 1748, 1747, 11399, 11400, 11985, 11986, 11992, 11993, 11994, 11995, 11996, 11997, 12014, 12015, 12016, 12017, 12095, 12096, 12097, 12098, 12099, 12100, 11837, 11838, 11839, 11840, 11841, 11842, 12107, 12108, 12109, 12110, 12111, 12112, 12141, 12142, 12143, 12144, 12145, 12146, 12149, 12150, 12151, 12175, 12176, 12177, 12178, 12181, 12182, 12135, 12136, 12137, 12138, 12139, 12140, 11425, 11426, 11427, 11428, 11429, 12587, 12588, 12609, 12610, 12611, 12612, 12613, 12614, 12615, 12616, 12626, 12627, 12628, 12629, 12630, 12631, 12632, 12633, 12634, 12635, 12636, 12637, 12639, 12640, 12641, 12642, 12643, 12644, 10967, 10968, 10969, 10970, 10971, 10972, 12645, 12646, 12647, 12648, 12649, 12650, 12651, 12652, 12653, 12654, 12655, 12656, 12657, 12658, 12659, 12660, 12661, 12662, 10984, 10985, 10986, 10987, 10988, 10989, 12663, 12664, 12665, 12666, 12667, 12668, 10955, 10956, 10957, 10958, 10959, 10960, 10940, 10941, 10942, 10943, 10944, 10945, 12685, 12686, 12687, 12688, 12689, 12690, 12704, 12705, 12706, 12707, 12708, 12709, 12710, 12711, 12712, 12713, 12714, 12715, 12716, 12717, 12718, 12719, 12720, 12721, 12722, 12723, 12724, 12725, 12726, 12727, 12728, 12729, 12730, 12731, 12732, 12733, 12734, 12735, 12736, 12737, 12738, 12739, 11782, 11783, 11784, 11785, 11786, 11787, 11477, 11478, 11479, 11480, 11481, 11482, 12740, 12741, 12742, 12743, 12744, 12745, 12751, 12752, 12753, 12754, 12755, 12756, 12757, 12758, 12759, 12760, 12761, 12762, 12765, 12766, 12767, 12768, 12769, 11579, 11580, 11581, 11582, 11583, 11584, 12771, 12772, 12773, 12774, 12775, 12776, 12777, 12778, 12779, 12780, 12781, 12782, 12786, 12787, 12788, 12789, 12790, 12791, 11758, 11759, 11760, 11761, 11762, 11763, 12792, 12793, 12794, 12795, 12796, 12797, 11788, 11789, 11790, 11791, 11792, 11793, 10946, 10947, 10948, 10949, 10950, 10951, 12798, 12799, 12800, 12801, 12802, 12803, 12804, 12805, 12806, 12807, 12808, 12809, 12810, 12811, 12812, 12813, 12814, 12815, 12818, 12819, 12820, 12821, 12822, 12823, 12835, 12836, 12837, 12838, 12839, 12840, 12846, 12847, 12155, 12156, 12157, 12158, 12159, 12848, 12849, 12850, 12851, 12852, 12853, 12854, 12855, 12857, 12858, 12859, 12860, 12861, 12862, 12863, 12864, 12865, 12866, 12867, 12868, 12869, 12870, 12871, 12872, 12873, 12874, 12875, 12876, 12877, 12878, 12879, 12880, 12881, 12882, 12883, 12884, 12885, 12886, 12887, 12888, 12889, 12890, 12891, 12892, 12894, 12895, 12896, 12897, 12898, 12899, 12906, 12907, 12908, 12909, 12910, 12911, 12915, 12916, 12917, 12918, 12919, 12920, 12921, 12922, 12923, 12924, 12925, 12926, 12931, 12932, 12933, 12934, 12935, 12936, 12161, 12162, 12163, 12164, 12165, 12950, 12951, 12952, 12953, 12954, 12955, 12956, 12829, 12830, 12831, 12832, 12833, 12834, 12962, 12963, 12964, 12965, 12966, 12967, 12968, 12969, 12970, 12971, 12972, 12973, 12974, 12975, 12976, 12977, 12978, 12979, 10931, 10932, 10933, 10934, 10935, 10936, 12981, 12982, 12983, 12984, 12985, 12986, 12987, 12988, 12989, 12990, 12991, 12992, 10925, 10926, 10927, 10928, 10929, 10930, 12996, 12997, 12998, 12999, 13000, 13001, 13002, 13004, 13005, 13006, 13007, 13008, 13009, 13010, 13011, 13012, 13013, 13014, 13015, 13016, 13017, 13018, 13019, 13020, 13021, 12022, 12023, 12024, 12025, 12026, 13030, 13031, 13032, 13033, 13034, 13035, 13037, 13038, 13039, 13040, 13041, 13042, 13043, 13044, 13045, 13046, 13047, 13048, 12669, 12670, 12671, 12672, 12673, 12674, 13053, 13054, 13055, 13056, 13057, 13058, 13070, 13071, 13072, 13073, 13074, 13075, 13089, 13090, 13091, 13092, 13093, 13094, 11847, 11848, 11849, 11850, 11851, 11852, 11752, 11753, 11754, 11755, 11756, 11757, 13115, 13116, 13117, 13118, 13119, 13120, 13121, 13122, 13123, 13124, 13125, 13126, 13127, 13128, 13129, 13130, 13131, 13132, 13133, 13134, 13135, 13136, 13137, 13138, 13139, 13140, 13141, 13142, 13143, 13144, 13145, 13146, 13147, 13148, 13149, 13150, 13153, 13154, 13155, 12089, 12090, 12091, 12092, 12093, 12094, 13162, 13163, 13164, 13165, 13166, 13167, 13170, 13171, 13172, 13173, 13174, 13175, 13177, 13178, 13179, 13180, 13181, 13182, 13184, 13185, 13186, 13187, 13188, 13189, 13191, 13192, 13193, 13194, 13195, 13196, 13222, 13223, 13224, 13225, 13226, 13227, 13239, 13240, 13241, 13242, 13243, 13253, 13254, 13255, 13256, 13257, 13258, 13264, 13265, 13266, 13267, 13268, 13269, 13270, 13271, 13272, 13273, 13274, 13275, 13277, 13278, 13279, 13280, 13281, 13282, 13288, 13289, 13290, 13291, 13292, 13293, 13299, 13300, 13301, 13302, 13303, 13304, 13305, 13306, 13307, 13308, 13309, 13310, 13312, 13313, 13314, 13315, 13316, 13317, 13323, 13324, 13325, 13326, 13327, 13328, 13337, 13338, 13339, 13340, 13341, 13342, 13343, 13344, 13345, 13346, 13347, 13348, 12101, 12102, 12103, 12104, 12105, 12106, 13351, 13352, 13353, 13354, 13355, 13356, 12038, 12039, 12040, 12041, 12042, 12043, 13373, 13374, 13375, 13376, 13377, 13378, 13379, 13380, 13381, 13382, 13383, 13384, 13385, 13386, 13387, 13388, 13389, 13390, 13391, 13392, 13393, 13394, 13395, 13396, 13397, 13398, 13399, 13400, 13401, 13403, 12047, 12048, 12049, 12050, 12051, 13584, 13585, 13586, 13587, 13588, 13589, 13590, 13591, 13592, 13593, 13594, 13077, 13078, 13079, 13080, 13082, 13083, 13084, 13085, 13086, 13087, 13620, 13621, 13622, 13623, 13624, 13625, 13626, 13627, 13628, 13629, 13630, 13631, 13632, 13633, 13634, 13635, 13636, 13637, 13638, 13639, 13640, 13641, 13642, 13643, 13644, 13645, 13646, 13647, 13648, 13649, 13650, 13651, 13652, 13653, 13654, 13655, 13656, 13657, 13708, 13709, 13710, 13711, 13712, 13735, 13736, 13737, 13738, 13739, 13740, 13741, 13742, 13743, 13749, 13750, 13751, 13752, 13753, 13754, 13755, 13756, 13757, 13758, 13759, 13760, 13762, 13763, 13764, 13793, 13794, 13799, 13816, 13817, 13840, 13841, 13846, 13863, 13864, 13869, 13870, 13871, 13872, 13873, 13874, 13884, 13885, 13886, 13887, 13905, 13906, 13907, 13908, 13909, 13910, 13915, 13916, 13917, 13918, 13919, 13921, 13922, 13923, 13924, 13925, 13928, 13929, 13930, 13931, 13932, 13933, 13935, 13936, 13939, 13940, 13944, 13945, 13946, 13947, 13948, 13949, 13950, 13951, 13953, 13954, 13955, 13956, 13957, 13958, 13959, 13960, 13961, 13962, 13963, 13964, 12675, 12676, 12677, 12678, 12679, 12680, 13966, 13967, 13968, 13969, 13970, 13998, 13999, 14000, 14001, 14003, 14004, 14005, 14006, 14007, 14008, 14011, 14012, 14013, 14014, 14015, 14016, 14018, 14019, 14020, 14021, 14022, 14023, 14024, 14025, 14026, 14027, 14028, 14037, 14038, 14039, 14040, 14041, 14042, 14043, 14044, 14045, 14046, 14047, 14048, 14049, 14055, 14056, 14057, 14058, 14062, 14063, 14064, 14065, 14066, 14067, 14068, 14069, 14070, 14071, 14072, 14073, 14074, 14075, 14076, 14077, 14078, 14079, 14080, 14081, 14082, 14083, 14084, 14085, 14086, 14087, 14088, 14089, 14090, 14091, 14093, 14094, 14095, 14096, 14097, 14098, 14099, 14100, 14101, 14102, 14111, 14112, 14142, 14143, 14144, 14145, 14152, 14153, 14154, 14155, 14156, 14157, 14158, 14159, 14161, 14162, 14163, 14164, 14165, 14166, 14167, 14168, 14169, 14170, 14171, 14172, 14175, 14176, 14177, 14178, 14181, 14182, 14183, 14184, 14185, 14186, 14187, 14188, 14189, 14190, 14191, 14192, 14193, 14194, 14201, 14202, 14203, 14204, 14206, 14207, 14208, 14209, 14210, 14211, 14212, 14213, 14214, 14215, 14216, 14217, 14218, 14219, 14220, 14221, 14222, 14223, 14225, 14226, 14227, 14228, 14229, 14230, 14235, 14236, 14237, 14238, 14239, 14244, 14245, 14246, 14247, 14248, 14249, 14250, 14251, 14252, 14253, 14254, 14255, 14258, 14259, 14260, 14263, 14264, 14265, 14266, 14267, 14268, 14271, 14272, 14273, 14274, 14276, 14277, 14278, 14279, 14280, 14281, 14282, 14283, 14284, 14285, 14286, 14287, 14288, 14289, 14290, 14291, 14292, 14293, 14294, 14295, 14296, 14297, 12681, 12683, 12684, 14300, 14301, 14302, 14303, 14304, 14305, 14307, 14308, 14309, 14322, 14323, 14324, 14325, 14326, 14327, 14328, 14329, 14330, 14331, 14332, 14333, 14345, 14346, 14347, 14348, 14349, 14350, 14351, 14352, 14353, 14354, 14355, 14356, 14357, 14358, 14359, 14360, 14361, 14362, 14363, 14364, 14365, 14366, 14367, 14375, 14376, 14377, 14378, 14379, 14380, 14381, 14382, 14383, 14384, 14385, 14386, 14387, 14388, 14389, 14390, 14395, 14396, 14397, 14398, 14399, 14400, 14401, 14403, 14404, 14405, 14406, 14407, 14408, 14410, 14411, 14412, 14414, 14415, 14416, 14417, 14418, 14419, 14420, 14421, 14422, 14423, 14424, 14425, 14426, 14427, 14428, 14429, 14430, 14431, 14432, 14433, 14434, 14435, 14436, 14437, 14438, 14439, 14441, 14442, 14443, 14444, 14445, 14446, 14447, 14448, 14449, 14450, 14451, 14452, 14453, 14454, 14455, 14456, 14457, 14458, 14462, 14463, 14464, 14465, 14466, 14467, 14469, 14470, 14471, 14472, 14473, 14474, 14475, 14476, 14477, 14478, 14479, 14480, 14481, 14482, 14483, 14484, 14485, 14486, 14487, 14488, 14489, 14490, 14496, 14497, 14498, 14499, 14500, 14506, 14507, 14508, 14509, 14510, 14511, 14513, 14514, 14515, 14516, 14517, 14518, 14519, 14520, 14521, 14545, 14546, 14551, 14552, 14553, 14554, 14561, 14562, 14563, 14564, 14580, 14581, 14593, 14594, 14595, 14596, 14597, 14598, 14599, 14600, 14601, 14602, 14603, 14604, 14605, 13744, 13745, 13746, 13747, 13748, 14606, 14607, 14608, 14609, 14610, 14611, 14620, 14621, 14622, 14623, 14624, 14630, 14629, 14632, 14633, 14631, 14638, 14639, 14640, 14641, 14642, 14643, 14646, 14647, 14648, 14649, 14650, 14651, 14652, 14653, 14654, 14655, 14656, 14657, 14658, 14659, 14660, 14661, 14662, 14663, 14664, 14665, 14666, 14667, 14668, 14669, 14670, 14671, 14672, 14673, 14674, 14675, 12824, 12825, 12826, 12827, 12828, 14677, 14678, 14679, 14680, 14681, 14682, 14683, 14684, 14685, 14686, 14687, 14688, 14689, 14691, 14692, 14693, 14695, 14696, 14697, 14698, 14699, 14700, 14701, 14702, 14704, 14705, 14706, 14708, 14709, 14710, 14711, 14712, 14713, 14714, 14715, 14716, 14717, 14718, 14719, 14720, 14721, 14722, 14723, 14724, 14725, 14726, 14727, 14728, 14729, 14730, 14731, 14732, 14733, 14734, 14735, 14736, 14737, 14738, 14739, 14740, 14741, 14742, 14743, 14744, 14745, 14746, 14747, 14748, 14749, 14750, 14751, 14752, 14753, 14754, 14755, 14756, 14757, 14758, 14759, 14760, 14761, 14762, 14763, 14764, 14765, 14766, 14767, 14768, 14769, 14770, 14771, 14772, 14773, 14774, 14775, 14776, 14777, 14778, 14779, 14780, 14781, 14782, 14783, 14784, 14785, 14786, 14787, 14788, 14789, 14790, 14791, 14792, 14793, 14794, 14795, 14797, 14798, 14799, 14801, 14802, 14803, 14804, 14805, 14806, 14807, 14808, 14810, 14811, 14812, 14813, 14814, 14815, 14817, 14818, 14819, 14820, 14821, 14822, 14832, 14833, 14834, 14835, 14836, 14837, 14838, 14839, 14840, 14841, 14842, 14843, 14845, 14846, 14847, 14853, 14854, 14855, 14856, 14857, 14858, 14861, 14862, 14863, 14864, 14865, 14867, 14868, 14869, 14870, 14871, 11979, 11980, 11981, 12029, 12030, 12031, 14885, 14886, 14887, 14888, 14889, 14890, 14891, 14892, 14893, 14894, 14895, 14897, 14898, 14899, 14900, 14901, 14903, 14904, 14905, 14906, 14907, 14908, 14910, 14911, 14912, 14913, 14914, 14915, 14916, 14917, 14918, 14920, 14921, 14927, 14928, 14929, 14930, 14931, 14932, 14933, 14934, 14935, 14936, 14937, 14938, 14939, 14941, 14942, 14945, 14946, 14947, 14948, 14950, 14951, 14953, 14954, 14955, 14956, 14957, 14960, 14961, 14962, 14963, 14964, 14965, 14966, 14967, 14968, 14969, 14970, 14971, 14972, 14973, 14974, 14975, 14976, 14977, 14978, 14979, 14980, 14981, 14982, 14983, 14984, 14985, 14986, 14987, 14988, 14992, 14993, 14994, 14995, 14996, 14997, 14998, 14999, 15000, 15001, 15002, 15003, 15004, 15005, 15011, 15012, 15013, 15014, 15015, 15016, 15018, 15019, 15020, 15021, 15022, 15023, 15024, 15025, 15026, 15027, 15028, 15029, 15034, 15035, 15036, 15037, 15038, 15039, 15041, 15042, 15043, 15044, 15045, 15046, 15047, 15048, 15055, 15056, 15057, 15058, 15059, 15060, 15062, 15063, 15064, 15065, 15066, 15067, 15068, 15069, 15070, 15071, 15074, 15075, 15076, 15077, 15078, 15079, 15080, 15081, 15082, 15083, 15084, 15085, 15086, 15087, 15088, 15089, 15090, 15093, 15094, 15095, 15096, 15097, 15098, 15099, 15100, 15101, 15102, 15103, 15104, 15105, 15106, 15107, 15108, 15109, 15111, 15112, 15113, 15114, 15115, 15116, 15117, 15118, 15119, 15120, 15121, 15122, 15123, 15124, 15125, 15126, 15127, 15128, 15129, 15130, 15131, 15132, 15133, 15134, 15135, 15136, 15137, 15138, 15139, 15140, 15141, 15142, 15143, 15144, 15145, 15146, 15147, 15148, 15149, 15150, 15151, 15152, 15153, 15154, 15155, 15156, 15157, 15160, 15161, 15162, 15163, 15164, 15165, 15166, 15167, 15168, 15169, 15170, 15171, 15172, 15173, 15174, 15175, 15176, 15177, 15178, 15179, 15180, 15181, 15182, 15183, 15184, 15185, 15186, 15187, 15189, 15190, 15191, 15192, 15193, 15198, 15199, 15200, 15201, 15202, 15204, 15205, 15206, 15208, 15209, 15210, 15211, 15213, 15214, 15215, 15217, 15218, 15219, 15221, 15222, 15223, 15225, 15226, 15227, 15229, 15230, 15231, 15233, 15234, 15235, 15237, 15238, 15239, 15241, 15242, 15243, 15245, 15246, 15247, 15249, 15250, 15251, 15253, 15254, 15255, 15257, 15258, 15259, 15260, 15261, 15262, 15263, 15264, 15266, 15267, 15268, 15270, 15271, 15272, 15273, 15274, 15275, 15276, 15277, 15278, 15279, 15280, 15281, 15282, 15283, 15285, 15286, 15287, 15289, 15290, 15291, 15293, 15294, 15295, 15297, 15298, 15299, 15301, 15302, 15303, 15305, 15306, 15307, 15309, 15310, 15311, 15313, 15314, 15315, 15317, 15318, 15319, 15321, 15322, 15323, 15325, 15326, 15327, 15329, 15330, 15331, 15333, 15334, 15335, 15336, 15337, 15338, 15339, 15340, 15342, 15343, 15344, 15346, 15347, 15348, 15350, 15351, 15352, 15354, 15355, 15356, 15358, 15359, 15360, 15362, 15363, 15364, 15366, 15367, 15368, 15370, 15371, 15372, 15374, 15375, 15376, 15377, 15378, 15379, 15380, 15381, 15382, 15384, 15385, 15386, 15388, 15389, 15390, 15391, 15392, 15393, 15394, 15395, 15397, 15398, 15399, 15401, 15402, 15403, 15405, 15406, 15407, 15408, 15409, 15410, 15411, 15412, 15413, 15415, 15416, 15417, 15419, 15420, 15421, 15423, 15424, 15425, 15427, 15428, 15429, 15431, 15432, 15433, 15435, 15436, 15437, 15439, 15440, 15441, 15443, 15444, 15445, 15447, 15448, 15449, 15451, 15452, 15453, 15455, 15456, 15457, 15459, 15460, 15461, 15463, 15464, 15465, 15467, 15468, 15469, 15471, 15472, 15473, 15475, 15476, 15477, 15479, 15480, 15481, 15483, 15484, 15485, 15487, 15488, 15489, 15490, 15491, 15492, 15493, 15494, 15496, 15497, 15498, 15500, 15501, 15502, 15504, 15505, 15506, 15508, 15509, 15510, 15512, 15513, 15514, 15516, 15517, 15518, 15520, 15521, 15522, 15524, 15525, 15526, 15528, 15529, 15530, 15532, 15533, 15534, 15536, 15537, 15538, 15540, 15541, 15542, 15544, 15545, 15546, 15548, 15549, 15550, 15552, 15553, 15554, 15555, 15556, 15557, 15558, 15559, 15560, 15561, 15562, 15563, 15564, 15566, 15567, 15568, 15569, 15570, 15571, 15572, 15573, 15574, 15575, 15576, 15577, 15578, 15579, 11465, 11466, 11467, 11468, 11469, 15580, 15581, 15582, 15583, 15584, 15586, 15587, 15588, 15590, 15591, 15592, 15594, 15595, 15596, 15598, 15599, 15600, 15602, 15603, 15604, 15606, 15607, 15608, 15610, 15611, 15612, 15614, 15615, 15616, 15618, 15619, 15620, 15622, 15623, 15624, 15626, 15627, 15628, 15630, 15631, 15632, 15634, 15635, 15636, 15638, 15639, 15640, 15642, 15643, 15644, 15646, 15647, 15648, 15650, 15651, 15652, 15654, 15655, 15656, 15657, 15658, 15659, 15660, 15661, 15663, 15664, 15665, 15667, 15668, 15669, 15671, 15672, 15673, 15675, 15676, 15677, 15679, 15680, 15681, 15683, 15684, 15685, 15687, 15688, 15689, 15691, 15692, 15693, 15695, 15696, 15697, 15699, 15700, 15701, 15703, 15704, 15705, 15707, 15708, 15709, 15711, 15712, 15713, 15715, 15716, 15717, 15719, 15720, 15721, 15723, 15724, 15725, 15727, 15728, 15729, 15730, 15731, 15732, 15733, 15734, 15736, 15737, 15738, 15740, 15741, 15742, 15744, 15745, 15746, 15748, 15749, 15750, 15751, 15752, 15753, 15754, 15755, 15757, 15758, 15759, 15762, 15763, 15764, 15765, 15766, 15767, 15772, 15773, 15777, 15778, 11729, 11730, 11731, 11732, 11733, 11734, 15794, 15795, 15837, 15838, 15839, 15840, 15841, 15842, 15843, 15844, 15845, 15849, 15850, 15851, 15852, 15853, 15854, 15855, 15856, 15857, 15858, 15859, 15860, 15861, 15862, 15863, 15866, 15867, 15868, 15869, 15870, 15889, 15890, 15891, 15892, 15893, 15894, 15895, 15896, 15897, 15898, 15899, 15900, 15901, 15902, 15903, 15907, 15908, 15909, 15910, 15911, 15912, 15921, 15922, 15923, 15925, 15926, 15927, 15928, 15929, 15930, 15931, 15933, 15934, 15935, 15936, 15937, 15938, 15939, 15948, 15949, 15950, 15951, 15952, 15953, 15954, 15955, 15956, 15957, 15958, 15959, 15964, 15965, 15966, 15967, 15969, 15970, 15971, 15973, 15974, 15975, 15991, 15992, 15993, 15999, 16007, 16008, 16009, 16010, 16011, 16012, 16013, 16014, 16015, 16016, 16021, 16022, 16074, 16075, 16078, 16079, 16085, 16086, 16090, 16091, 16241, 16242, 16583, 16584, 16585, 16586, 16587, 16588, 16589, 16590, 16591, 16592, 16593, 16594, 16595, 16557, 2327) GROUP BY states.metadata_id) AS anon_3 ON states.metadata_id = anon_3.max_metadata_id AND states.last_updated_ts = anon_3.max_last_updated LEFT OUTER JOIN state_attributes ON states.attributes_id = state_attributes.attributes_id WHERE states.last_updated_ts >= 1731219794.579708e0 AND states.last_updated_ts < 1733999399.999999e0 AND states.metadata_id IN (301, 6280, 7616, 10297, 11317, 11738, 11745, 488, 492, 493, 83, 6499, 7871, 10571, 496, 314, 6487, 14138, 6574, 10650, 64, 336, 338, 40, 43, 339, 2027, 2021, 8732, 340, 7868, 7939, 345, 346, 347, 348, 1424, 351, 8507, 14, 354, 2090, 8679, 13989, 1581, 6316, 355, 2, 10555, 81, 337, 1186, 6414, 6227, 344, 87, 353, 357, 358, 1457, 1197, 1844, 6366, 6472, 1381, 7875, 8390, 10330, 10688, 12065, 12170, 13611, 343, 6488, 14139, 6575, 10651, 53, 359, 361, 75, 55, 362, 2028, 2022, 8733, 363, 7869, 7940, 368, 369, 370, 371, 1425, 374, 8508, 33, 377, 2091, 8680, 13990, 1582, 6317, 378, 80, 10556, 20, 360, 1187, 6415, 6228, 367, 56, 376, 380, 381, 1456, 1198, 1845, 6367, 6473, 1365, 7876, 8391, 10331, 10689, 12066, 12171, 13612, 366, 6241, 6242, 6243, 8436, 8437, 8438, 10541, 8467, 8439, 8440, 8441, 10542, 8468, 421, 422, 423, 7595, 2264, 2266, 2289, 2290, 2291, 2292, 2293, 2294, 2295, 2075, 2238, 7926, 7928, 6468, 6470, 417, 419, 8682, 12153, 12154, 14120, 14121, 14556, 15815, 15816, 15823, 15824, 16037, 16038, 14150, 14151, 14826, 14827, 16208, 16209, 16210, 16211, 16212, 16201, 16222, 16202, 16203, 16204, 16205, 16206, 16207, 16217, 16218, 16219, 16220, 16221, 16225, 16226, 16227, 16228, 16229, 16563, 16564, 16565, 16566, 16567, 13981, 13669, 13677, 13668, 7246, 7245, 7247, 7243, 16271, 16272, 16273, 16270, 16028, 16029, 16027, 16031, 16032, 16030, 16233, 16234, 16232, 16267, 16268, 16269, 16266, 16236, 16237, 16238, 16235, 15905, 15906, 14919, 15904, 15879, 15880, 15884, 15924, 15878, 15881, 15883, 15882, 15885, 16069, 792, 16070, 791, 15961, 15962, 15963, 15960, 16042, 12682, 16043, 757, 16044, 16045, 16055, 6236, 16056, 16072, 16067, 748, 16068, 746, 13889, 11350, 13890, 11351, 16061, 749, 16062, 747, 7143, 7142, 775, 774, 776, 10267, 10268, 10269, 10264, 10311, 10265, 10266, 10270, 10271, 10272, 8420, 8422, 8421, 6630, 6631, 6632, 6633, 6634, 16263, 1799, 882, 884, 885, 883, 874, 8172, 7877, 7494, 16533, 16538, 16535, 16536, 16537, 16511, 16512, 1995, 1997, 10370, 7900, 666, 668, 664, 658, 670, 674, 672, 680, 11374, 688, 692, 712, 708, 706, 694, 710, 655, 716, 700, 662, 676, 660, 698, 656, 6304, 8600, 8602, 13833, 10014, 16494, 16496, 6392, 6398, 6308, 11358, 11256, 888, 11141, 2097, 2095, 2098, 2105, 2104, 1042, 1043, 1044, 724, 722, 1064, 1116, 1118, 1120, 342, 365, 356, 379, 341, 364, 78, 34, 350, 373, 1448, 1447, 1528, 1524, 1526, 1523, 1879, 1880, 1537, 1539, 1906, 1907, 1350, 1301, 1061, 1543, 1544, 1972, 1974, 1556, 1545, 1983, 2020, 1559, 1546, 1549, 1551, 1547, 1554, 1555, 1552, 1564, 1565, 1250, 1346, 349, 372, 1709, 1708, 1740, 1739, 1750, 1751, 2083, 2084, 2085, 2086, 2087, 2088, 6412, 6413, 6486, 6518, 6519, 6520, 6521, 6524, 6525, 6530, 6531, 6576, 6577, 6642, 6643, 6644, 6645, 1226, 1213, 6652, 6653, 6656, 6657, 6664, 6665, 6666, 6667, 6673, 6674, 6679, 6680, 6721, 6722, 6750, 6751, 6752, 6753, 6767, 6768, 6841, 6842, 6853, 6854, 6856, 6857, 6858, 6859, 6860, 6861, 6862, 6863, 6877, 6878, 6962, 6963, 7026, 7027, 7065, 7066, 7091, 7092, 7112, 7113, 7411, 7412, 7564, 7565, 7793, 7794, 7795, 7796, 7812, 7813, 7837, 7838, 7839, 7840, 7841, 7842, 7843, 7844, 7846, 7847, 7854, 7855, 7864, 7865, 8023, 8042, 8043, 8070, 8071, 8081, 8082, 8118, 8119, 8221, 8222, 8226, 8227, 8241, 8242, 8262, 8263, 8264, 8265, 8275, 8276, 8337, 8338, 8382, 8383, 8442, 8443, 8454, 8455, 8721, 8722, 8728, 8729, 10133, 10134, 10135, 10136, 10137, 10138, 10143, 10144, 10201, 10202, 10324, 10325, 10366, 10367, 10382, 10383, 10505, 10506, 10507, 10508, 10511, 10512, 10514, 10515, 10516, 10517, 10530, 10531, 10558, 10559, 10560, 10561, 10575, 10576, 10598, 10599, 10657, 10658, 10659, 10660, 1748, 1747, 11399, 11400, 11985, 11986, 11992, 11993, 11994, 11995, 11996, 11997, 12014, 12015, 12016, 12017, 12095, 12096, 12097, 12098, 12099, 12100, 11837, 11838, 11839, 11840, 11841, 11842, 12107, 12108, 12109, 12110, 12111, 12112, 12141, 12142, 12143, 12144, 12145, 12146, 12149, 12150, 12151, 12175, 12176, 12177, 12178, 12181, 12182, 12135, 12136, 12137, 12138, 12139, 12140, 11425, 11426, 11427, 11428, 11429, 12587, 12588, 12609, 12610, 12611, 12612, 12613, 12614, 12615, 12616, 12626, 12627, 12628, 12629, 12630, 12631, 12632, 12633, 12634, 12635, 12636, 12637, 12639, 12640, 12641, 12642, 12643, 12644, 10967, 10968, 10969, 10970, 10971, 10972, 12645, 12646, 12647, 12648, 12649, 12650, 12651, 12652, 12653, 12654, 12655, 12656, 12657, 12658, 12659, 12660, 12661, 12662, 10984, 10985, 10986, 10987, 10988, 10989, 12663, 12664, 12665, 12666, 12667, 12668, 10955, 10956, 10957, 10958, 10959, 10960, 10940, 10941, 10942, 10943, 10944, 10945, 12685, 12686, 12687, 12688, 12689, 12690, 12704, 12705, 12706, 12707, 12708, 12709, 12710, 12711, 12712, 12713, 12714, 12715, 12716, 12717, 12718, 12719, 12720, 12721, 12722, 12723, 12724, 12725, 12726, 12727, 12728, 12729, 12730, 12731, 12732, 12733, 12734, 12735, 12736, 12737, 12738, 12739, 11782, 11783, 11784, 11785, 11786, 11787, 11477, 11478, 11479, 11480, 11481, 11482, 12740, 12741, 12742, 12743, 12744, 12745, 12751, 12752, 12753, 12754, 12755, 12756, 12757, 12758, 12759, 12760, 12761, 12762, 12765, 12766, 12767, 12768, 12769, 11579, 11580, 11581, 11582, 11583, 11584, 12771, 12772, 12773, 12774, 12775, 12776, 12777, 12778, 12779, 12780, 12781, 12782, 12786, 12787, 12788, 12789, 12790, 12791, 11758, 11759, 11760, 11761, 11762, 11763, 12792, 12793, 12794, 12795, 12796, 12797, 11788, 11789, 11790, 11791, 11792, 11793, 10946, 10947, 10948, 10949, 10950, 10951, 12798, 12799, 12800, 12801, 12802, 12803, 12804, 12805, 12806, 12807, 12808, 12809, 12810, 12811, 12812, 12813, 12814, 12815, 12818, 12819, 12820, 12821, 12822, 12823, 12835, 12836, 12837, 12838, 12839, 12840, 12846, 12847, 12155, 12156, 12157, 12158, 12159, 12848, 12849, 12850, 12851, 12852, 12853, 12854, 12855, 12857, 12858, 12859, 12860, 12861, 12862, 12863, 12864, 12865, 12866, 12867, 12868, 12869, 12870, 12871, 12872, 12873, 12874, 12875, 12876, 12877, 12878, 12879, 12880, 12881, 12882, 12883, 12884, 12885, 12886, 12887, 12888, 12889, 12890, 12891, 12892, 12894, 12895, 12896, 12897, 12898, 12899, 12906, 12907, 12908, 12909, 12910, 12911, 12915, 12916, 12917, 12918, 12919, 12920, 12921, 12922, 12923, 12924, 12925, 12926, 12931, 12932, 12933, 12934, 12935, 12936, 12161, 12162, 12163, 12164, 12165, 12950, 12951, 12952, 12953, 12954, 12955, 12956, 12829, 12830, 12831, 12832, 12833, 12834, 12962, 12963, 12964, 12965, 12966, 12967, 12968, 12969, 12970, 12971, 12972, 12973, 12974, 12975, 12976, 12977, 12978, 12979, 10931, 10932, 10933, 10934, 10935, 10936, 12981, 12982, 12983, 12984, 12985, 12986, 12987, 12988, 12989, 12990, 12991, 12992, 10925, 10926, 10927, 10928, 10929, 10930, 12996, 12997, 12998, 12999, 13000, 13001, 13002, 13004, 13005, 13006, 13007, 13008, 13009, 13010, 13011, 13012, 13013, 13014, 13015, 13016, 13017, 13018, 13019, 13020, 13021, 12022, 12023, 12024, 12025, 12026, 13030, 13031, 13032, 13033, 13034, 13035, 13037, 13038, 13039, 13040, 13041, 13042, 13043, 13044, 13045, 13046, 13047, 13048, 12669, 12670, 12671, 12672, 12673, 12674, 13053, 13054, 13055, 13056, 13057, 13058, 13070, 13071, 13072, 13073, 13074, 13075, 13089, 13090, 13091, 13092, 13093, 13094, 11847, 11848, 11849, 11850, 11851, 11852, 11752, 11753, 11754, 11755, 11756, 11757, 13115, 13116, 13117, 13118, 13119, 13120, 13121, 13122, 13123, 13124, 13125, 13126, 13127, 13128, 13129, 13130, 13131, 13132, 13133, 13134, 13135, 13136, 13137, 13138, 13139, 13140, 13141, 13142, 13143, 13144, 13145, 13146, 13147, 13148, 13149, 13150, 13153, 13154, 13155, 12089, 12090, 12091, 12092, 12093, 12094, 13162, 13163, 13164, 13165, 13166, 13167, 13170, 13171, 13172, 13173, 13174, 13175, 13177, 13178, 13179, 13180, 13181, 13182, 13184, 13185, 13186, 13187, 13188, 13189, 13191, 13192, 13193, 13194, 13195, 13196, 13222, 13223, 13224, 13225, 13226, 13227, 13239, 13240, 13241, 13242, 13243, 13253, 13254, 13255, 13256, 13257, 13258, 13264, 13265, 13266, 13267, 13268, 13269, 13270, 13271, 13272, 13273, 13274, 13275, 13277, 13278, 13279, 13280, 13281, 13282, 13288, 13289, 13290, 13291, 13292, 13293, 13299, 13300, 13301, 13302, 13303, 13304, 13305, 13306, 13307, 13308, 13309, 13310, 13312, 13313, 13314, 13315, 13316, 13317, 13323, 13324, 13325, 13326, 13327, 13328, 13337, 13338, 13339, 13340, 13341, 13342, 13343, 13344, 13345, 13346, 13347, 13348, 12101, 12102, 12103, 12104, 12105, 12106, 13351, 13352, 13353, 13354, 13355, 13356, 12038, 12039, 12040, 12041, 12042, 12043, 13373, 13374, 13375, 13376, 13377, 13378, 13379, 13380, 13381, 13382, 13383, 13384, 13385, 13386, 13387, 13388, 13389, 13390, 13391, 13392, 13393, 13394, 13395, 13396, 13397, 13398, 13399, 13400, 13401, 13403, 12047, 12048, 12049, 12050, 12051, 13584, 13585, 13586, 13587, 13588, 13589, 13590, 13591, 13592, 13593, 13594, 13077, 13078, 13079, 13080, 13082, 13083, 13084, 13085, 13086, 13087, 13620, 13621, 13622, 13623, 13624, 13625, 13626, 13627, 13628, 13629, 13630, 13631, 13632, 13633, 13634, 13635, 13636, 13637, 13638, 13639, 13640, 13641, 13642, 13643, 13644, 13645, 13646, 13647, 13648, 13649, 13650, 13651, 13652, 13653, 13654, 13655, 13656, 13657, 13708, 13709, 13710, 13711, 13712, 13735, 13736, 13737, 13738, 13739, 13740, 13741, 13742, 13743, 13749, 13750, 13751, 13752, 13753, 13754, 13755, 13756, 13757, 13758, 13759, 13760, 13762, 13763, 13764, 13793, 13794, 13799, 13816, 13817, 13840, 13841, 13846, 13863, 13864, 13869, 13870, 13871, 13872, 13873, 13874, 13884, 13885, 13886, 13887, 13905, 13906, 13907, 13908, 13909, 13910, 13915, 13916, 13917, 13918, 13919, 13921, 13922, 13923, 13924, 13925, 13928, 13929, 13930, 13931, 13932, 13933, 13935, 13936, 13939, 13940, 13944, 13945, 13946, 13947, 13948, 13949, 13950, 13951, 13953, 13954, 13955, 13956, 13957, 13958, 13959, 13960, 13961, 13962, 13963, 13964, 12675, 12676, 12677, 12678, 12679, 12680, 13966, 13967, 13968, 13969, 13970, 13998, 13999, 14000, 14001, 14003, 14004, 14005, 14006, 14007, 14008, 14011, 14012, 14013, 14014, 14015, 14016, 14018, 14019, 14020, 14021, 14022, 14023, 14024, 14025, 14026, 14027, 14028, 14037, 14038, 14039, 14040, 14041, 14042, 14043, 14044, 14045, 14046, 14047, 14048, 14049, 14055, 14056, 14057, 14058, 14062, 14063, 14064, 14065, 14066, 14067, 14068, 14069, 14070, 14071, 14072, 14073, 14074, 14075, 14076, 14077, 14078, 14079, 14080, 14081, 14082, 14083, 14084, 14085, 14086, 14087, 14088, 14089, 14090, 14091, 14093, 14094, 14095, 14096, 14097, 14098, 14099, 14100, 14101, 14102, 14111, 14112, 14142, 14143, 14144, 14145, 14152, 14153, 14154, 14155, 14156, 14157, 14158, 14159, 14161, 14162, 14163, 14164, 14165, 14166, 14167, 14168, 14169, 14170, 14171, 14172, 14175, 14176, 14177, 14178, 14181, 14182, 14183, 14184, 14185, 14186, 14187, 14188, 14189, 14190, 14191, 14192, 14193, 14194, 14201, 14202, 14203, 14204, 14206, 14207, 14208, 14209, 14210, 14211, 14212, 14213, 14214, 14215, 14216, 14217, 14218, 14219, 14220, 14221, 14222, 14223, 14225, 14226, 14227, 14228, 14229, 14230, 14235, 14236, 14237, 14238, 14239, 14244, 14245, 14246, 14247, 14248, 14249, 14250, 14251, 14252, 14253, 14254, 14255, 14258, 14259, 14260, 14263, 14264, 14265, 14266, 14267, 14268, 14271, 14272, 14273, 14274, 14276, 14277, 14278, 14279, 14280, 14281, 14282, 14283, 14284, 14285, 14286, 14287, 14288, 14289, 14290, 14291, 14292, 14293, 14294, 14295, 14296, 14297, 12681, 12683, 12684, 14300, 14301, 14302, 14303, 14304, 14305, 14307, 14308, 14309, 14322, 14323, 14324, 14325, 14326, 14327, 14328, 14329, 14330, 14331, 14332, 14333, 14345, 14346, 14347, 14348, 14349, 14350, 14351, 14352, 14353, 14354, 14355, 14356, 14357, 14358, 14359, 14360, 14361, 14362, 14363, 14364, 14365, 14366, 14367, 14375, 14376, 14377, 14378, 14379, 14380, 14381, 14382, 14383, 14384, 14385, 14386, 14387, 14388, 14389, 14390, 14395, 14396, 14397, 14398, 14399, 14400, 14401, 14403, 14404, 14405, 14406, 14407, 14408, 14410, 14411, 14412, 14414, 14415, 14416, 14417, 14418, 14419, 14420, 14421, 14422, 14423, 14424, 14425, 14426, 14427, 14428, 14429, 14430, 14431, 14432, 14433, 14434, 14435, 14436, 14437, 14438, 14439, 14441, 14442, 14443, 14444, 14445, 14446, 14447, 14448, 14449, 14450, 14451, 14452, 14453, 14454, 14455, 14456, 14457, 14458, 14462, 14463, 14464, 14465, 14466, 14467, 14469, 14470, 14471, 14472, 14473, 14474, 14475, 14476, 14477, 14478, 14479, 14480, 14481, 14482, 14483, 14484, 14485, 14486, 14487, 14488, 14489, 14490, 14496, 14497, 14498, 14499, 14500, 14506, 14507, 14508, 14509, 14510, 14511, 14513, 14514, 14515, 14516, 14517, 14518, 14519, 14520, 14521, 14545, 14546, 14551, 14552, 14553, 14554, 14561, 14562, 14563, 14564, 14580, 14581, 14593, 14594, 14595, 14596, 14597, 14598, 14599, 14600, 14601, 14602, 14603, 14604, 14605, 13744, 13745, 13746, 13747, 13748, 14606, 14607, 14608, 14609, 14610, 14611, 14620, 14621, 14622, 14623, 14624, 14630, 14629, 14632, 14633, 14631, 14638, 14639, 14640, 14641, 14642, 14643, 14646, 14647, 14648, 14649, 14650, 14651, 14652, 14653, 14654, 14655, 14656, 14657, 14658, 14659, 14660, 14661, 14662, 14663, 14664, 14665, 14666, 14667, 14668, 14669, 14670, 14671, 14672, 14673, 14674, 14675, 12824, 12825, 12826, 12827, 12828, 14677, 14678, 14679, 14680, 14681, 14682, 14683, 14684, 14685, 14686, 14687, 14688, 14689, 14691, 14692, 14693, 14695, 14696, 14697, 14698, 14699, 14700, 14701, 14702, 14704, 14705, 14706, 14708, 14709, 14710, 14711, 14712, 14713, 14714, 14715, 14716, 14717, 14718, 14719, 14720, 14721, 14722, 14723, 14724, 14725, 14726, 14727, 14728, 14729, 14730, 14731, 14732, 14733, 14734, 14735, 14736, 14737, 14738, 14739, 14740, 14741, 14742, 14743, 14744, 14745, 14746, 14747, 14748, 14749, 14750, 14751, 14752, 14753, 14754, 14755, 14756, 14757, 14758, 14759, 14760, 14761, 14762, 14763, 14764, 14765, 14766, 14767, 14768, 14769, 14770, 14771, 14772, 14773, 14774, 14775, 14776, 14777, 14778, 14779, 14780, 14781, 14782, 14783, 14784, 14785, 14786, 14787, 14788, 14789, 14790, 14791, 14792, 14793, 14794, 14795, 14797, 14798, 14799, 14801, 14802, 14803, 14804, 14805, 14806, 14807, 14808, 14810, 14811, 14812, 14813, 14814, 14815, 14817, 14818, 14819, 14820, 14821, 14822, 14832, 14833, 14834, 14835, 14836, 14837, 14838, 14839, 14840, 14841, 14842, 14843, 14845, 14846, 14847, 14853, 14854, 14855, 14856, 14857, 14858, 14861, 14862, 14863, 14864, 14865, 14867, 14868, 14869, 14870, 14871, 11979, 11980, 11981, 12029, 12030, 12031, 14885, 14886, 14887, 14888, 14889, 14890, 14891, 14892, 14893, 14894, 14895, 14897, 14898, 14899, 14900, 14901, 14903, 14904, 14905, 14906, 14907, 14908, 14910, 14911, 14912, 14913, 14914, 14915, 14916, 14917, 14918, 14920, 14921, 14927, 14928, 14929, 14930, 14931, 14932, 14933, 14934, 14935, 14936, 14937, 14938, 14939, 14941, 14942, 14945, 14946, 14947, 14948, 14950, 14951, 14953, 14954, 14955, 14956, 14957, 14960, 14961, 14962, 14963, 14964, 14965, 14966, 14967, 14968, 14969, 14970, 14971, 14972, 14973, 14974, 14975, 14976, 14977, 14978, 14979, 14980, 14981, 14982, 14983, 14984, 14985, 14986, 14987, 14988, 14992, 14993, 14994, 14995, 14996, 14997, 14998, 14999, 15000, 15001, 15002, 15003, 15004, 15005, 15011, 15012, 15013, 15014, 15015, 15016, 15018, 15019, 15020, 15021, 15022, 15023, 15024, 15025, 15026, 15027, 15028, 15029, 15034, 15035, 15036, 15037, 15038, 15039, 15041, 15042, 15043, 15044, 15045, 15046, 15047, 15048, 15055, 15056, 15057, 15058, 15059, 15060, 15062, 15063, 15064, 15065, 15066, 15067, 15068, 15069, 15070, 15071, 15074, 15075, 15076, 15077, 15078, 15079, 15080, 15081, 15082, 15083, 15084, 15085, 15086, 15087, 15088, 15089, 15090, 15093, 15094, 15095, 15096, 15097, 15098, 15099, 15100, 15101, 15102, 15103, 15104, 15105, 15106, 15107, 15108, 15109, 15111, 15112, 15113, 15114, 15115, 15116, 15117, 15118, 15119, 15120, 15121, 15122, 15123, 15124, 15125, 15126, 15127, 15128, 15129, 15130, 15131, 15132, 15133, 15134, 15135, 15136, 15137, 15138, 15139, 15140, 15141, 15142, 15143, 15144, 15145, 15146, 15147, 15148, 15149, 15150, 15151, 15152, 15153, 15154, 15155, 15156, 15157, 15160, 15161, 15162, 15163, 15164, 15165, 15166, 15167, 15168, 15169, 15170, 15171, 15172, 15173, 15174, 15175, 15176, 15177, 15178, 15179, 15180, 15181, 15182, 15183, 15184, 15185, 15186, 15187, 15189, 15190, 15191, 15192, 15193, 15198, 15199, 15200, 15201, 15202, 15204, 15205, 15206, 15208, 15209, 15210, 15211, 15213, 15214, 15215, 15217, 15218, 15219, 15221, 15222, 15223, 15225, 15226, 15227, 15229, 15230, 15231, 15233, 15234, 15235, 15237, 15238, 15239, 15241, 15242, 15243, 15245, 15246, 15247, 15249, 15250, 15251, 15253, 15254, 15255, 15257, 15258, 15259, 15260, 15261, 15262, 15263, 15264, 15266, 15267, 15268, 15270, 15271, 15272, 15273, 15274, 15275, 15276, 15277, 15278, 15279, 15280, 15281, 15282, 15283, 15285, 15286, 15287, 15289, 15290, 15291, 15293, 15294, 15295, 15297, 15298, 15299, 15301, 15302, 15303, 15305, 15306, 15307, 15309, 15310, 15311, 15313, 15314, 15315, 15317, 15318, 15319, 15321, 15322, 15323, 15325, 15326, 15327, 15329, 15330, 15331, 15333, 15334, 15335, 15336, 15337, 15338, 15339, 15340, 15342, 15343, 15344, 15346, 15347, 15348, 15350, 15351, 15352, 15354, 15355, 15356, 15358, 15359, 15360, 15362, 15363, 15364, 15366, 15367, 15368, 15370, 15371, 15372, 15374, 15375, 15376, 15377, 15378, 15379, 15380, 15381, 15382, 15384, 15385, 15386, 15388, 15389, 15390, 15391, 15392, 15393, 15394, 15395, 15397, 15398, 15399, 15401, 15402, 15403, 15405, 15406, 15407, 15408, 15409, 15410, 15411, 15412, 15413, 15415, 15416, 15417, 15419, 15420, 15421, 15423, 15424, 15425, 15427, 15428, 15429, 15431, 15432, 15433, 15435, 15436, 15437, 15439, 15440, 15441, 15443, 15444, 15445, 15447, 15448, 15449, 15451, 15452, 15453, 15455, 15456, 15457, 15459, 15460, 15461, 15463, 15464, 15465, 15467, 15468, 15469, 15471, 15472, 15473, 15475, 15476, 15477, 15479, 15480, 15481, 15483, 15484, 15485, 15487, 15488, 15489, 15490, 15491, 15492, 15493, 15494, 15496, 15497, 15498, 15500, 15501, 15502, 15504, 15505, 15506, 15508, 15509, 15510, 15512, 15513, 15514, 15516, 15517, 15518, 15520, 15521, 15522, 15524, 15525, 15526, 15528, 15529, 15530, 15532, 15533, 15534, 15536, 15537, 15538, 15540, 15541, 15542, 15544, 15545, 15546, 15548, 15549, 15550, 15552, 15553, 15554, 15555, 15556, 15557, 15558, 15559, 15560, 15561, 15562, 15563, 15564, 15566, 15567, 15568, 15569, 15570, 15571, 15572, 15573, 15574, 15575, 15576, 15577, 15578, 15579, 11465, 11466, 11467, 11468, 11469, 15580, 15581, 15582, 15583, 15584, 15586, 15587, 15588, 15590, 15591, 15592, 15594, 15595, 15596, 15598, 15599, 15600, 15602, 15603, 15604, 15606, 15607, 15608, 15610, 15611, 15612, 15614, 15615, 15616, 15618, 15619, 15620, 15622, 15623, 15624, 15626, 15627, 15628, 15630, 15631, 15632, 15634, 15635, 15636, 15638, 15639, 15640, 15642, 15643, 15644, 15646, 15647, 15648, 15650, 15651, 15652, 15654, 15655, 15656, 15657, 15658, 15659, 15660, 15661, 15663, 15664, 15665, 15667, 15668, 15669, 15671, 15672, 15673, 15675, 15676, 15677, 15679, 15680, 15681, 15683, 15684, 15685, 15687, 15688, 15689, 15691, 15692, 15693, 15695, 15696, 15697, 15699, 15700, 15701, 15703, 15704, 15705, 15707, 15708, 15709, 15711, 15712, 15713, 15715, 15716, 15717, 15719, 15720, 15721, 15723, 15724, 15725, 15727, 15728, 15729, 15730, 15731, 15732, 15733, 15734, 15736, 15737, 15738, 15740, 15741, 15742, 15744, 15745, 15746, 15748, 15749, 15750, 15751, 15752, 15753, 15754, 15755, 15757, 15758, 15759, 15762, 15763, 15764, 15765, 15766, 15767, 15772, 15773, 15777, 15778, 11729, 11730, 11731, 11732, 11733, 11734, 15794, 15795, 15837, 15838, 15839, 15840, 15841, 15842, 15843, 15844, 15845, 15849, 15850, 15851, 15852, 15853, 15854, 15855, 15856, 15857, 15858, 15859, 15860, 15861, 15862, 15863, 15866, 15867, 15868, 15869, 15870, 15889, 15890, 15891, 15892, 15893, 15894, 15895, 15896, 15897, 15898, 15899, 15900, 15901, 15902, 15903, 15907, 15908, 15909, 15910, 15911, 15912, 15921, 15922, 15923, 15925, 15926, 15927, 15928, 15929, 15930, 15931, 15933, 15934, 15935, 15936, 15937, 15938, 15939, 15948, 15949, 15950, 15951, 15952, 15953, 15954, 15955, 15956, 15957, 15958, 15959, 15964, 15965, 15966, 15967, 15969, 15970, 15971, 15973, 15974, 15975, 15991, 15992, 15993, 15999, 16007, 16008, 16009, 16010, 16011, 16012, 16013, 16014, 16015, 16016, 16021, 16022, 16074, 16075, 16078, 16079, 16085, 16086, 16090, 16091, 16241, 16242, 16583, 16584, 16585, 16586, 16587, 16588, 16589, 16590, 16591, 16592, 16593, 16594, 16595, 16557, 2327)) AS anon_2 UNION ALL SELECT anon_4.metadata_id AS metadata_id, anon_4.state AS state, anon_4.last_updated_ts AS last_updated_ts, anon_4.attributes AS attributes FROM (SELECT states.metadata_id AS metadata_id, states.state AS state, states.last_updated_ts AS last_updated_ts, CASE WHEN (state_attributes.shared_attrs IS NULL) THEN states.attributes ELSE state_attributes.shared_attrs END AS attributes FROM states LEFT OUTER JOIN state_attributes ON states.attributes_id = state_attributes.attributes_id WHERE (states.last_changed_ts = states.last_updated_ts OR states.last_changed_ts IS NULL) AND states.metadata_id IN (301, 6280, 7616, 10297, 11317, 11738, 11745, 488, 492, 493, 83, 6499, 7871, 10571, 496, 314, 6487, 14138, 6574, 10650, 64, 336, 338, 40, 43, 339, 2027, 2021, 8732, 340, 7868, 7939, 345, 346, 347, 348, 1424, 351, 8507, 14, 354, 2090, 8679, 13989, 1581, 6316, 355, 2, 10555, 81, 337, 1186, 6414, 6227, 344, 87, 353, 357, 358, 1457, 1197, 1844, 6366, 6472, 1381, 7875, 8390, 10330, 10688, 12065, 12170, 13611, 343, 6488, 14139, 6575, 10651, 53, 359, 361, 75, 55, 362, 2028, 2022, 8733, 363, 7869, 7940, 368, 369, 370, 371, 1425, 374, 8508, 33, 377, 2091, 8680, 13990, 1582, 6317, 378, 80, 10556, 20, 360, 1187, 6415, 6228, 367, 56, 376, 380, 381, 1456, 1198, 1845, 6367, 6473, 1365, 7876, 8391, 10331, 10689, 12066, 12171, 13612, 366, 6241, 6242, 6243, 8436, 8437, 8438, 10541, 8467, 8439, 8440, 8441, 10542, 8468, 421, 422, 423, 7595, 2264, 2266, 2289, 2290, 2291, 2292, 2293, 2294, 2295, 2075, 2238, 7926, 7928, 6468, 6470, 417, 419, 8682, 12153, 12154, 14120, 14121, 14556, 15815, 15816, 15823, 15824, 16037, 16038, 14150, 14151, 14826, 14827, 16208, 16209, 16210, 16211, 16212, 16201, 16222, 16202, 16203, 16204, 16205, 16206, 16207, 16217, 16218, 16219, 16220, 16221, 16225, 16226, 16227, 16228, 16229, 16563, 16564, 16565, 16566, 16567, 13981, 13669, 13677, 13668, 7246, 7245, 7247, 7243, 16271, 16272, 16273, 16270, 16028, 16029, 16027, 16031, 16032, 16030, 16233, 16234, 16232, 16267, 16268, 16269, 16266, 16236, 16237, 16238, 16235, 15905, 15906, 14919, 15904, 15879, 15880, 15884, 15924, 15878, 15881, 15883, 15882, 15885, 16069, 792, 16070, 791, 15961, 15962, 15963, 15960, 16042, 12682, 16043, 757, 16044, 16045, 16055, 6236, 16056, 16072, 16067, 748, 16068, 746, 13889, 11350, 13890, 11351, 16061, 749, 16062, 747, 7143, 7142, 775, 774, 776, 10267, 10268, 10269, 10264, 10311, 10265, 10266, 10270, 10271, 10272, 8420, 8422, 8421, 6630, 6631, 6632, 6633, 6634, 16263, 1799, 882, 884, 885, 883, 874, 8172, 7877, 7494, 16533, 16538, 16535, 16536, 16537, 16511, 16512, 1995, 1997, 10370, 7900, 666, 668, 664, 658, 670, 674, 672, 680, 11374, 688, 692, 712, 708, 706, 694, 710, 655, 716, 700, 662, 676, 660, 698, 656, 6304, 8600, 8602, 13833, 10014, 16494, 16496, 6392, 6398, 6308, 11358, 11256, 888, 11141, 2097, 2095, 2098, 2105, 2104, 1042, 1043, 1044, 724, 722, 1064, 1116, 1118, 1120, 342, 365, 356, 379, 341, 364, 78, 34, 350, 373, 1448, 1447, 1528, 1524, 1526, 1523, 1879, 1880, 1537, 1539, 1906, 1907, 1350, 1301, 1061, 1543, 1544, 1972, 1974, 1556, 1545, 1983, 2020, 1559, 1546, 1549, 1551, 1547, 1554, 1555, 1552, 1564, 1565, 1250, 1346, 349, 372, 1709, 1708, 1740, 1739, 1750, 1751, 2083, 2084, 2085, 2086, 2087, 2088, 6412, 6413, 6486, 6518, 6519, 6520, 6521, 6524, 6525, 6530, 6531, 6576, 6577, 6642, 6643, 6644, 6645, 1226, 1213, 6652, 6653, 6656, 6657, 6664, 6665, 6666, 6667, 6673, 6674, 6679, 6680, 6721, 6722, 6750, 6751, 6752, 6753, 6767, 6768, 6841, 6842, 6853, 6854, 6856, 6857, 6858, 6859, 6860, 6861, 6862, 6863, 6877, 6878, 6962, 6963, 7026, 7027, 7065, 7066, 7091, 7092, 7112, 7113, 7411, 7412, 7564, 7565, 7793, 7794, 7795, 7796, 7812, 7813, 7837, 7838, 7839, 7840, 7841, 7842, 7843, 7844, 7846, 7847, 7854, 7855, 7864, 7865, 8023, 8042, 8043, 8070, 8071, 8081, 8082, 8118, 8119, 8221, 8222, 8226, 8227, 8241, 8242, 8262, 8263, 8264, 8265, 8275, 8276, 8337, 8338, 8382, 8383, 8442, 8443, 8454, 8455, 8721, 8722, 8728, 8729, 10133, 10134, 10135, 10136, 10137, 10138, 10143, 10144, 10201, 10202, 10324, 10325, 10366, 10367, 10382, 10383, 10505, 10506, 10507, 10508, 10511, 10512, 10514, 10515, 10516, 10517, 10530, 10531, 10558, 10559, 10560, 10561, 10575, 10576, 10598, 10599, 10657, 10658, 10659, 10660, 1748, 1747, 11399, 11400, 11985, 11986, 11992, 11993, 11994, 11995, 11996, 11997, 12014, 12015, 12016, 12017, 12095, 12096, 12097, 12098, 12099, 12100, 11837, 11838, 11839, 11840, 11841, 11842, 12107, 12108, 12109, 12110, 12111, 12112, 12141, 12142, 12143, 12144, 12145, 12146, 12149, 12150, 12151, 12175, 12176, 12177, 12178, 12181, 12182, 12135, 12136, 12137, 12138, 12139, 12140, 11425, 11426, 11427, 11428, 11429, 12587, 12588, 12609, 12610, 12611, 12612, 12613, 12614, 12615, 12616, 12626, 12627, 12628, 12629, 12630, 12631, 12632, 12633, 12634, 12635, 12636, 12637, 12639, 12640, 12641, 12642, 12643, 12644, 10967, 10968, 10969, 10970, 10971, 10972, 12645, 12646, 12647, 12648, 12649, 12650, 12651, 12652, 12653, 12654, 12655, 12656, 12657, 12658, 12659, 12660, 12661, 12662, 10984, 10985, 10986, 10987, 10988, 10989, 12663, 12664, 12665, 12666, 12667, 12668, 10955, 10956, 10957, 10958, 10959, 10960, 10940, 10941, 10942, 10943, 10944, 10945, 12685, 12686, 12687, 12688, 12689, 12690, 12704, 12705, 12706, 12707, 12708, 12709, 12710, 12711, 12712, 12713, 12714, 12715, 12716, 12717, 12718, 12719, 12720, 12721, 12722, 12723, 12724, 12725, 12726, 12727, 12728, 12729, 12730, 12731, 12732, 12733, 12734, 12735, 12736, 12737, 12738, 12739, 11782, 11783, 11784, 11785, 11786, 11787, 11477, 11478, 11479, 11480, 11481, 11482, 12740, 12741, 12742, 12743, 12744, 12745, 12751, 12752, 12753, 12754, 12755, 12756, 12757, 12758, 12759, 12760, 12761, 12762, 12765, 12766, 12767, 12768, 12769, 11579, 11580, 11581, 11582, 11583, 11584, 12771, 12772, 12773, 12774, 12775, 12776, 12777, 12778, 12779, 12780, 12781, 12782, 12786, 12787, 12788, 12789, 12790, 12791, 11758, 11759, 11760, 11761, 11762, 11763, 12792, 12793, 12794, 12795, 12796, 12797, 11788, 11789, 11790, 11791, 11792, 11793, 10946, 10947, 10948, 10949, 10950, 10951, 12798, 12799, 12800, 12801, 12802, 12803, 12804, 12805, 12806, 12807, 12808, 12809, 12810, 12811, 12812, 12813, 12814, 12815, 12818, 12819, 12820, 12821, 12822, 12823, 12835, 12836, 12837, 12838, 12839, 12840, 12846, 12847, 12155, 12156, 12157, 12158, 12159, 12848, 12849, 12850, 12851, 12852, 12853, 12854, 12855, 12857, 12858, 12859, 12860, 12861, 12862, 12863, 12864, 12865, 12866, 12867, 12868, 12869, 12870, 12871, 12872, 12873, 12874, 12875, 12876, 12877, 12878, 12879, 12880, 12881, 12882, 12883, 12884, 12885, 12886, 12887, 12888, 12889, 12890, 12891, 12892, 12894, 12895, 12896, 12897, 12898, 12899, 12906, 12907, 12908, 12909, 12910, 12911, 12915, 12916, 12917, 12918, 12919, 12920, 12921, 12922, 12923, 12924, 12925, 12926, 12931, 12932, 12933, 12934, 12935, 12936, 12161, 12162, 12163, 12164, 12165, 12950, 12951, 12952, 12953, 12954, 12955, 12956, 12829, 12830, 12831, 12832, 12833, 12834, 12962, 12963, 12964, 12965, 12966, 12967, 12968, 12969, 12970, 12971, 12972, 12973, 12974, 12975, 12976, 12977, 12978, 12979, 10931, 10932, 10933, 10934, 10935, 10936, 12981, 12982, 12983, 12984, 12985, 12986, 12987, 12988, 12989, 12990, 12991, 12992, 10925, 10926, 10927, 10928, 10929, 10930, 12996, 12997, 12998, 12999, 13000, 13001, 13002, 13004, 13005, 13006, 13007, 13008, 13009, 13010, 13011, 13012, 13013, 13014, 13015, 13016, 13017, 13018, 13019, 13020, 13021, 12022, 12023, 12024, 12025, 12026, 13030, 13031, 13032, 13033, 13034, 13035, 13037, 13038, 13039, 13040, 13041, 13042, 13043, 13044, 13045, 13046, 13047, 13048, 12669, 12670, 12671, 12672, 12673, 12674, 13053, 13054, 13055, 13056, 13057, 13058, 13070, 13071, 13072, 13073, 13074, 13075, 13089, 13090, 13091, 13092, 13093, 13094, 11847, 11848, 11849, 11850, 11851, 11852, 11752, 11753, 11754, 11755, 11756, 11757, 13115, 13116, 13117, 13118, 13119, 13120, 13121, 13122, 13123, 13124, 13125, 13126, 13127, 13128, 13129, 13130, 13131, 13132, 13133, 13134, 13135, 13136, 13137, 13138, 13139, 13140, 13141, 13142, 13143, 13144, 13145, 13146, 13147, 13148, 13149, 13150, 13153, 13154, 13155, 12089, 12090, 12091, 12092, 12093, 12094, 13162, 13163, 13164, 13165, 13166, 13167, 13170, 13171, 13172, 13173, 13174, 13175, 13177, 13178, 13179, 13180, 13181, 13182, 13184, 13185, 13186, 13187, 13188, 13189, 13191, 13192, 13193, 13194, 13195, 13196, 13222, 13223, 13224, 13225, 13226, 13227, 13239, 13240, 13241, 13242, 13243, 13253, 13254, 13255, 13256, 13257, 13258, 13264, 13265, 13266, 13267, 13268, 13269, 13270, 13271, 13272, 13273, 13274, 13275, 13277, 13278, 13279, 13280, 13281, 13282, 13288, 13289, 13290, 13291, 13292, 13293, 13299, 13300, 13301, 13302, 13303, 13304, 13305, 13306, 13307, 13308, 13309, 13310, 13312, 13313, 13314, 13315, 13316, 13317, 13323, 13324, 13325, 13326, 13327, 13328, 13337, 13338, 13339, 13340, 13341, 13342, 13343, 13344, 13345, 13346, 13347, 13348, 12101, 12102, 12103, 12104, 12105, 12106, 13351, 13352, 13353, 13354, 13355, 13356, 12038, 12039, 12040, 12041, 12042, 12043, 13373, 13374, 13375, 13376, 13377, 13378, 13379, 13380, 13381, 13382, 13383, 13384, 13385, 13386, 13387, 13388, 13389, 13390, 13391, 13392, 13393, 13394, 13395, 13396, 13397, 13398, 13399, 13400, 13401, 13403, 12047, 12048, 12049, 12050, 12051, 13584, 13585, 13586, 13587, 13588, 13589, 13590, 13591, 13592, 13593, 13594, 13077, 13078, 13079, 13080, 13082, 13083, 13084, 13085, 13086, 13087, 13620, 13621, 13622, 13623, 13624, 13625, 13626, 13627, 13628, 13629, 13630, 13631, 13632, 13633, 13634, 13635, 13636, 13637, 13638, 13639, 13640, 13641, 13642, 13643, 13644, 13645, 13646, 13647, 13648, 13649, 13650, 13651, 13652, 13653, 13654, 13655, 13656, 13657, 13708, 13709, 13710, 13711, 13712, 13735, 13736, 13737, 13738, 13739, 13740, 13741, 13742, 13743, 13749, 13750, 13751, 13752, 13753, 13754, 13755, 13756, 13757, 13758, 13759, 13760, 13762, 13763, 13764, 13793, 13794, 13799, 13816, 13817, 13840, 13841, 13846, 13863, 13864, 13869, 13870, 13871, 13872, 13873, 13874, 13884, 13885, 13886, 13887, 13905, 13906, 13907, 13908, 13909, 13910, 13915, 13916, 13917, 13918, 13919, 13921, 13922, 13923, 13924, 13925, 13928, 13929, 13930, 13931, 13932, 13933, 13935, 13936, 13939, 13940, 13944, 13945, 13946, 13947, 13948, 13949, 13950, 13951, 13953, 13954, 13955, 13956, 13957, 13958, 13959, 13960, 13961, 13962, 13963, 13964, 12675, 12676, 12677, 12678, 12679, 12680, 13966, 13967, 13968, 13969, 13970, 13998, 13999, 14000, 14001, 14003, 14004, 14005, 14006, 14007, 14008, 14011, 14012, 14013, 14014, 14015, 14016, 14018, 14019, 14020, 14021, 14022, 14023, 14024, 14025, 14026, 14027, 14028, 14037, 14038, 14039, 14040, 14041, 14042, 14043, 14044, 14045, 14046, 14047, 14048, 14049, 14055, 14056, 14057, 14058, 14062, 14063, 14064, 14065, 14066, 14067, 14068, 14069, 14070, 14071, 14072, 14073, 14074, 14075, 14076, 14077, 14078, 14079, 14080, 14081, 14082, 14083, 14084, 14085, 14086, 14087, 14088, 14089, 14090, 14091, 14093, 14094, 14095, 14096, 14097, 14098, 14099, 14100, 14101, 14102, 14111, 14112, 14142, 14143, 14144, 14145, 14152, 14153, 14154, 14155, 14156, 14157, 14158, 14159, 14161, 14162, 14163, 14164, 14165, 14166, 14167, 14168, 14169, 14170, 14171, 14172, 14175, 14176, 14177, 14178, 14181, 14182, 14183, 14184, 14185, 14186, 14187, 14188, 14189, 14190, 14191, 14192, 14193, 14194, 14201, 14202, 14203, 14204, 14206, 14207, 14208, 14209, 14210, 14211, 14212, 14213, 14214, 14215, 14216, 14217, 14218, 14219, 14220, 14221, 14222, 14223, 14225, 14226, 14227, 14228, 14229, 14230, 14235, 14236, 14237, 14238, 14239, 14244, 14245, 14246, 14247, 14248, 14249, 14250, 14251, 14252, 14253, 14254, 14255, 14258, 14259, 14260, 14263, 14264, 14265, 14266, 14267, 14268, 14271, 14272, 14273, 14274, 14276, 14277, 14278, 14279, 14280, 14281, 14282, 14283, 14284, 14285, 14286, 14287, 14288, 14289, 14290, 14291, 14292, 14293, 14294, 14295, 14296, 14297, 12681, 12683, 12684, 14300, 14301, 14302, 14303, 14304, 14305, 14307, 14308, 14309, 14322, 14323, 14324, 14325, 14326, 14327, 14328, 14329, 14330, 14331, 14332, 14333, 14345, 14346, 14347, 14348, 14349, 14350, 14351, 14352, 14353, 14354, 14355, 14356, 14357, 14358, 14359, 14360, 14361, 14362, 14363, 14364, 14365, 14366, 14367, 14375, 14376, 14377, 14378, 14379, 14380, 14381, 14382, 14383, 14384, 14385, 14386, 14387, 14388, 14389, 14390, 14395, 14396, 14397, 14398, 14399, 14400, 14401, 14403, 14404, 14405, 14406, 14407, 14408, 14410, 14411, 14412, 14414, 14415, 14416, 14417, 14418, 14419, 14420, 14421, 14422, 14423, 14424, 14425, 14426, 14427, 14428, 14429, 14430, 14431, 14432, 14433, 14434, 14435, 14436, 14437, 14438, 14439, 14441, 14442, 14443, 14444, 14445, 14446, 14447, 14448, 14449, 14450, 14451, 14452, 14453, 14454, 14455, 14456, 14457, 14458, 14462, 14463, 14464, 14465, 14466, 14467, 14469, 14470, 14471, 14472, 14473, 14474, 14475, 14476, 14477, 14478, 14479, 14480, 14481, 14482, 14483, 14484, 14485, 14486, 14487, 14488, 14489, 14490, 14496, 14497, 14498, 14499, 14500, 14506, 14507, 14508, 14509, 14510, 14511, 14513, 14514, 14515, 14516, 14517, 14518, 14519, 14520, 14521, 14545, 14546, 14551, 14552, 14553, 14554, 14561, 14562, 14563, 14564, 14580, 14581, 14593, 14594, 14595, 14596, 14597, 14598, 14599, 14600, 14601, 14602, 14603, 14604, 14605, 13744, 13745, 13746, 13747, 13748, 14606, 14607, 14608, 14609, 14610, 14611, 14620, 14621, 14622, 14623, 14624, 14630, 14629, 14632, 14633, 14631, 14638, 14639, 14640, 14641, 14642, 14643, 14646, 14647, 14648, 14649, 14650, 14651, 14652, 14653, 14654, 14655, 14656, 14657, 14658, 14659, 14660, 14661, 14662, 14663, 14664, 14665, 14666, 14667, 14668, 14669, 14670, 14671, 14672, 14673, 14674, 14675, 12824, 12825, 12826, 12827, 12828, 14677, 14678, 14679, 14680, 14681, 14682, 14683, 14684, 14685, 14686, 14687, 14688, 14689, 14691, 14692, 14693, 14695, 14696, 14697, 14698, 14699, 14700, 14701, 14702, 14704, 14705, 14706, 14708, 14709, 14710, 14711, 14712, 14713, 14714, 14715, 14716, 14717, 14718, 14719, 14720, 14721, 14722, 14723, 14724, 14725, 14726, 14727, 14728, 14729, 14730, 14731, 14732, 14733, 14734, 14735, 14736, 14737, 14738, 14739, 14740, 14741, 14742, 14743, 14744, 14745, 14746, 14747, 14748, 14749, 14750, 14751, 14752, 14753, 14754, 14755, 14756, 14757, 14758, 14759, 14760, 14761, 14762, 14763, 14764, 14765, 14766, 14767, 14768, 14769, 14770, 14771, 14772, 14773, 14774, 14775, 14776, 14777, 14778, 14779, 14780, 14781, 14782, 14783, 14784, 14785, 14786, 14787, 14788, 14789, 14790, 14791, 14792, 14793, 14794, 14795, 14797, 14798, 14799, 14801, 14802, 14803, 14804, 14805, 14806, 14807, 14808, 14810, 14811, 14812, 14813, 14814, 14815, 14817, 14818, 14819, 14820, 14821, 14822, 14832, 14833, 14834, 14835, 14836, 14837, 14838, 14839, 14840, 14841, 14842, 14843, 14845, 14846, 14847, 14853, 14854, 14855, 14856, 14857, 14858, 14861, 14862, 14863, 14864, 14865, 14867, 14868, 14869, 14870, 14871, 11979, 11980, 11981, 12029, 12030, 12031, 14885, 14886, 14887, 14888, 14889, 14890, 14891, 14892, 14893, 14894, 14895, 14897, 14898, 14899, 14900, 14901, 14903, 14904, 14905, 14906, 14907, 14908, 14910, 14911, 14912, 14913, 14914, 14915, 14916, 14917, 14918, 14920, 14921, 14927, 14928, 14929, 14930, 14931, 14932, 14933, 14934, 14935, 14936, 14937, 14938, 14939, 14941, 14942, 14945, 14946, 14947, 14948, 14950, 14951, 14953, 14954, 14955, 14956, 14957, 14960, 14961, 14962, 14963, 14964, 14965, 14966, 14967, 14968, 14969, 14970, 14971, 14972, 14973, 14974, 14975, 14976, 14977, 14978, 14979, 14980, 14981, 14982, 14983, 14984, 14985, 14986, 14987, 14988, 14992, 14993, 14994, 14995, 14996, 14997, 14998, 14999, 15000, 15001, 15002, 15003, 15004, 15005, 15011, 15012, 15013, 15014, 15015, 15016, 15018, 15019, 15020, 15021, 15022, 15023, 15024, 15025, 15026, 15027, 15028, 15029, 15034, 15035, 15036, 15037, 15038, 15039, 15041, 15042, 15043, 15044, 15045, 15046, 15047, 15048, 15055, 15056, 15057, 15058, 15059, 15060, 15062, 15063, 15064, 15065, 15066, 15067, 15068, 15069, 15070, 15071, 15074, 15075, 15076, 15077, 15078, 15079, 15080, 15081, 15082, 15083, 15084, 15085, 15086, 15087, 15088, 15089, 15090, 15093, 15094, 15095, 15096, 15097, 15098, 15099, 15100, 15101, 15102, 15103, 15104, 15105, 15106, 15107, 15108, 15109, 15111, 15112, 15113, 15114, 15115, 15116, 15117, 15118, 15119, 15120, 15121, 15122, 15123, 15124, 15125, 15126, 15127, 15128, 15129, 15130, 15131, 15132, 15133, 15134, 15135, 15136, 15137, 15138, 15139, 15140, 15141, 15142, 15143, 15144, 15145, 15146, 15147, 15148, 15149, 15150, 15151, 15152, 15153, 15154, 15155, 15156, 15157, 15160, 15161, 15162, 15163, 15164, 15165, 15166, 15167, 15168, 15169, 15170, 15171, 15172, 15173, 15174, 15175, 15176, 15177, 15178, 15179, 15180, 15181, 15182, 15183, 15184, 15185, 15186, 15187, 15189, 15190, 15191, 15192, 15193, 15198, 15199, 15200, 15201, 15202, 15204, 15205, 15206, 15208, 15209, 15210, 15211, 15213, 15214, 15215, 15217, 15218, 15219, 15221, 15222, 15223, 15225, 15226, 15227, 15229, 15230, 15231, 15233, 15234, 15235, 15237, 15238, 15239, 15241, 15242, 15243, 15245, 15246, 15247, 15249, 15250, 15251, 15253, 15254, 15255, 15257, 15258, 15259, 15260, 15261, 15262, 15263, 15264, 15266, 15267, 15268, 15270, 15271, 15272, 15273, 15274, 15275, 15276, 15277, 15278, 15279, 15280, 15281, 15282, 15283, 15285, 15286, 15287, 15289, 15290, 15291, 15293, 15294, 15295, 15297, 15298, 15299, 15301, 15302, 15303, 15305, 15306, 15307, 15309, 15310, 15311, 15313, 15314, 15315, 15317, 15318, 15319, 15321, 15322, 15323, 15325, 15326, 15327, 15329, 15330, 15331, 15333, 15334, 15335, 15336, 15337, 15338, 15339, 15340, 15342, 15343, 15344, 15346, 15347, 15348, 15350, 15351, 15352, 15354, 15355, 15356, 15358, 15359, 15360, 15362, 15363, 15364, 15366, 15367, 15368, 15370, 15371, 15372, 15374, 15375, 15376, 15377, 15378, 15379, 15380, 15381, 15382, 15384, 15385, 15386, 15388, 15389, 15390, 15391, 15392, 15393, 15394, 15395, 15397, 15398, 15399, 15401, 15402, 15403, 15405, 15406, 15407, 15408, 15409, 15410, 15411, 15412, 15413, 15415, 15416, 15417, 15419, 15420, 15421, 15423, 15424, 15425, 15427, 15428, 15429, 15431, 15432, 15433, 15435, 15436, 15437, 15439, 15440, 15441, 15443, 15444, 15445, 15447, 15448, 15449, 15451, 15452, 15453, 15455, 15456, 15457, 15459, 15460, 15461, 15463, 15464, 15465, 15467, 15468, 15469, 15471, 15472, 15473, 15475, 15476, 15477, 15479, 15480, 15481, 15483, 15484, 15485, 15487, 15488, 15489, 15490, 15491, 15492, 15493, 15494, 15496, 15497, 15498, 15500, 15501, 15502, 15504, 15505, 15506, 15508, 15509, 15510, 15512, 15513, 15514, 15516, 15517, 15518, 15520, 15521, 15522, 15524, 15525, 15526, 15528, 15529, 15530, 15532, 15533, 15534, 15536, 15537, 15538, 15540, 15541, 15542, 15544, 15545, 15546, 15548, 15549, 15550, 15552, 15553, 15554, 15555, 15556, 15557, 15558, 15559, 15560, 15561, 15562, 15563, 15564, 15566, 15567, 15568, 15569, 15570, 15571, 15572, 15573, 15574, 15575, 15576, 15577, 15578, 15579, 11465, 11466, 11467, 11468, 11469, 15580, 15581, 15582, 15583, 15584, 15586, 15587, 15588, 15590, 15591, 15592, 15594, 15595, 15596, 15598, 15599, 15600, 15602, 15603, 15604, 15606, 15607, 15608, 15610, 15611, 15612, 15614, 15615, 15616, 15618, 15619, 15620, 15622, 15623, 15624, 15626, 15627, 15628, 15630, 15631, 15632, 15634, 15635, 15636, 15638, 15639, 15640, 15642, 15643, 15644, 15646, 15647, 15648, 15650, 15651, 15652, 15654, 15655, 15656, 15657, 15658, 15659, 15660, 15661, 15663, 15664, 15665, 15667, 15668, 15669, 15671, 15672, 15673, 15675, 15676, 15677, 15679, 15680, 15681, 15683, 15684, 15685, 15687, 15688, 15689, 15691, 15692, 15693, 15695, 15696, 15697, 15699, 15700, 15701, 15703, 15704, 15705, 15707, 15708, 15709, 15711, 15712, 15713, 15715, 15716, 15717, 15719, 15720, 15721, 15723, 15724, 15725, 15727, 15728, 15729, 15730, 15731, 15732, 15733, 15734, 15736, 15737, 15738, 15740, 15741, 15742, 15744, 15745, 15746, 15748, 15749, 15750, 15751, 15752, 15753, 15754, 15755, 15757, 15758, 15759, 15762, 15763, 15764, 15765, 15766, 15767, 15772, 15773, 15777, 15778, 11729, 11730, 11731, 11732, 11733, 11734, 15794, 15795, 15837, 15838, 15839, 15840, 15841, 15842, 15843, 15844, 15845, 15849, 15850, 15851, 15852, 15853, 15854, 15855, 15856, 15857, 15858, 15859, 15860, 15861, 15862, 15863, 15866, 15867, 15868, 15869, 15870, 15889, 15890, 15891, 15892, 15893, 15894, 15895, 15896, 15897, 15898, 15899, 15900, 15901, 15902, 15903, 15907, 15908, 15909, 15910, 15911, 15912, 15921, 15922, 15923, 15925, 15926, 15927, 15928, 15929, 15930, 15931, 15933, 15934, 15935, 15936, 15937, 15938, 15939, 15948, 15949, 15950, 15951, 15952, 15953, 15954, 15955, 15956, 15957, 15958, 15959, 15964, 15965, 15966, 15967, 15969, 15970, 15971, 15973, 15974, 15975, 15991, 15992, 15993, 15999, 16007, 16008, 16009, 16010, 16011, 16012, 16013, 16014, 16015, 16016, 16021, 16022, 16074, 16075, 16078, 16079, 16085, 16086, 16090, 16091, 16241, 16242, 16583, 16584, 16585, 16586, 16587, 16588, 16589, 16590, 16591, 16592, 16593, 16594, 16595, 16557, 2327) AND states.last_updated_ts > 1733999399.999999e0 AND states.last_updated_ts < 1733999700.0e0) AS anon_4) AS anon_1 ORDER BY anon_1.metadata_id, anon_1.last_updated_ts\r\n\nI have similar issue, but with 7GB SQLite. My issue is increased CPU usage for ~25 sec every 5 minutes. It starts happening from  2024.12.0b2.  2024.12.0b1 was good. Can someone confirm, that  2024.12.0b1 is still good, while  2024.12.0b2 is where it starts happening?\r\nAlso it only happening when shelly integration is enabled (it has quite noisy shelly em3 pro power usage sensors)\r\nAlso can I trace SQLite slowness and confirm, that we have same issue?\r\n\r\n![image](https://github.com/user-attachments/assets/ae5a2b53-96e9-4414-8c58-9610edce6418)\r\n\nI  have  2024,12,1 and its faulty, if ithis issue is HW related , dont know yet, I will try the official power supply on the next days, if this doesnt make any difference, i will go back from SSD to an SD card. \r\nIn any case I didnt notice cpu peaks like in your graph\nHow do you see the SQL DB  size?\n> [nikplas](/nikplas)\r\n\r\nIf you use default sqlite then it's a file: \\config\\home-assistant_v2.db\nThanks to those who have provided databases for testing so far.  Once I have a few more to validate optimizations, I'll start working on a solution.  I'll wait until Monday to give everyone a chance to send them in and work with what I have.  If you want to be sure your case is considered please be sure to get it to be before Monday.\nAlso don't forget to send in the query it's stuck on with the database as I'll need to validate  a rewritten query against the one that was being run once we have a solution \n@bdraco any way I could determine query in SQLite?\r\nAnd either way would my SQLite db file be useful? :-)\n> @bdraco any way I could determine query in SQLite?\n> \n> And either way would my SQLite db file be useful? :-)\n\nYou can turn on debug logging for `sqlalchemy` even info level is probably enough. \n\nAnd yes it would be useful \n> Thanks to those who have provided databases for testing so far. Once I have a few more to validate optimizations, I'll start working on a solution. I'll wait until Monday to give everyone a chance to send them in and work with what I have. If you want to be sure your case is considered please be sure to get it to be before Monday.\r\n\r\nI've sent you an e-mail with a download link to my PSQL dump.\nI've been busy with the dreaded \"OnCall Rotation\" this week kind of lost track of this issue - do you need a mysql dump/query set? or are you good?\n> I've been busy with the dreaded \"OnCall Rotation\" this week kind of lost track of this issue - do you need a mysql dump/query set? or are you good?\n\nYes. Still could use a few more test databases to make sure whatever optimizations I work on next week are effective. \nSent a GDrive share with the db dump and the slow.log - you can all see my original slow/killed queries above.\r\n\r\nFrom:\r\n```mysql> select version();\r\n+----------------------------+\r\n| version()                  |\r\n+----------------------------+\r\n| 11.6.2-MariaDB-ubu2404-log |\r\n+----------------------------+\r\n1 row in set (0.00 sec)\r\n```\nsame as #132525 \nIf you are using postgresql and have held off sending in data for testing and optimization, please try to do it soon as I'm starting working on this and don't want postgresql users left in the cold because I didn't have enough data to optimize for all the possible cases.\nIt looks like we are hitting some internal optimization limit in MySQL/MariaDB\r\n\r\nAs soon as we get over 999 metadata_ids\r\n\r\n\r\n<1000 is fine\r\n\r\n```\r\n+------+-------------+--------+-------+-----------------------------------------------------------------+---------------------------------------+---------+------+------+---------------------------------------+\r\n| id   | select_type | table  | type  | possible_keys                                                   | key                                   | key_len | ref  | rows | Extra                                 |\r\n+------+-------------+--------+-------+-----------------------------------------------------------------+---------------------------------------+---------+------+------+---------------------------------------+\r\n|    1 | SIMPLE      | states | range | ix_states_last_updated_ts,ix_states_metadata_id_last_updated_ts | ix_states_metadata_id_last_updated_ts | 18      | NULL | 999  | Using where; Using index for group-by |\r\n+------+-------------+--------+-------+-----------------------------------------------------------------+---------------------------------------+---------+------+------+---------------------------------------+\r\n1 row in set (0.010 sec)\r\n```\r\n\r\n\r\nwhere-as >=1000, the query optimizes completely differently \r\n\r\n```\r\n+------+-------------+------------+------+-----------------------------------------------------------------+---------------------------------------+---------+--------------+------+---------------------------------+\r\n| id   | select_type | table      | type | possible_keys                                                   | key                                   | key_len | ref          | rows | Extra                           |\r\n+------+-------------+------------+------+-----------------------------------------------------------------+---------------------------------------+---------+--------------+------+---------------------------------+\r\n|    1 | PRIMARY     | <derived3> | ALL  | distinct_key                                                    | NULL                                  | NULL    | NULL         | 1396 | Using temporary; Using filesort |\r\n|    1 | PRIMARY     | states     | ref  | ix_states_last_updated_ts,ix_states_metadata_id_last_updated_ts | ix_states_metadata_id_last_updated_ts | 9       | tvc_0._col_1 | 558  | Using where; Using index        |\r\n|    3 | DERIVED     | NULL       | NULL | NULL                                                            | NULL                                  | NULL    | NULL         | NULL | No tables used                  |\r\n+------+-------------+------------+------+-----------------------------------------------------------------+---------------------------------------+---------+--------------+------+---------------------------------+\r\n```\r\n\r\n\r\nThis is the problem query\r\n```sql\r\nSELECT states.metadata_id          AS max_metadata_id,\r\n       Max(states.last_updated_ts) AS max_last_updated\r\nFROM   states\r\nWHERE  states.last_updated_ts >= 1732708152.6401002e0\r\n       AND states.last_updated_ts < 1734107999.999999e0\r\n       AND states.metadata_id IN ( 222, 223, 224, 50501,\r\n                                   50518, 50535, 50564, 50581,\r\n                                   50598, 389, 49770, 391,\r\n                                   49772, 394, 395, 397,\r\n                                   32307, 32308, 32310, 32371,\r\n                                   235, 236, 237, 238,\r\n                                   239, 299, 300, 31826,\r\n                                   31808, 31813, 31825, 31829,\r\n                                   302, 303, 304, 305,\r\n                                   306, 307, 371, 246,\r\n                                   248, 251, 31965, 31966,\r\n                                   31967, 31968, 31969, 10809,\r\n                                   10810, 34465, 10813, 10812,\r\n                                   10814, 10816, 10817, 10818,\r\n                                   42219, 42217, 42221, 42222,\r\n                                   49716, 42223, 10826, 10828,\r\n                                   10830, 45857, 10832, 10831,\r\n                                   10833, 10834, 42224, 45850,\r\n                                   10837, 10839, 10838, 10840,\r\n                                   10836, 10842, 10843, 10844,\r\n                                   50378, 10845, 10846, 49717,\r\n                                   49971, 42226, 10851, 42227,\r\n                                   10909, 49975, 10854, 10855,\r\n                                   42228, 42229, 10858, 10859,\r\n                                   10861, 42230, 42231, 10864,\r\n                                   42232, 34537, 10867, 49842,\r\n                                   50294, 10869, 10870, 42233,\r\n                                   42234, 10874, 49718, 10878,\r\n                                   10880, 10881, 42236, 10883,\r\n                                   10884, 10885, 49720, 49721,\r\n                                   10890, 10891, 10893, 50675,\r\n                                   50394, 10898, 42238, 49722,\r\n                                   49723, 50297, 10902, 10903,\r\n                                   10904, 10905, 42239, 49785,\r\n                                   42240, 10825, 42242, 10913,\r\n                                   45592, 10916, 45565, 50412,\r\n                                   42541, 10919, 10920, 10921,\r\n                                   45895, 10923, 42243, 10926,\r\n                                   10927, 49728, 49724, 10931,\r\n                                   42246, 10933, 42247, 42248,\r\n                                   42249, 42250, 10972, 49725,\r\n                                   49726, 10940, 49727, 42253,\r\n                                   10943, 42254, 10945, 10960,\r\n                                   49719, 10911, 10922, 42220,\r\n                                   45556, 10822, 10985, 10895,\r\n                                   34469, 10824, 34473, 10841,\r\n                                   34474, 10872, 10853, 34475,\r\n                                   10906, 10934, 10957, 34486,\r\n                                   34493, 34501, 34505, 10970,\r\n                                   34545, 10971, 34557, 10975,\r\n                                   34559, 34561, 34568, 45263,\r\n                                   45270, 45273, 45302, 45534,\r\n                                   45537, 45540, 45543, 45546,\r\n                                   45549, 45553, 45559, 45562,\r\n                                   45567, 45571, 45581, 45584,\r\n                                   45590, 45596, 10924, 45603,\r\n                                   45750, 45760, 10961, 11008,\r\n                                   10962, 42241, 10954, 10900,\r\n                                   45752, 10965, 10946, 45754,\r\n                                   10980, 10966, 45867, 45880,\r\n                                   45885, 10964, 10974, 45893,\r\n                                   49843, 45897, 42244, 45899,\r\n                                   45901, 45903, 45905, 45907,\r\n                                   45909, 45931, 45948, 45950,\r\n                                   45952, 45954, 45956, 45963,\r\n                                   45965, 45967, 45972, 45974,\r\n                                   45976, 45978, 45980, 45987,\r\n                                   45989, 45991, 45993, 45995,\r\n                                   45997, 45999, 46001, 46003,\r\n                                   46005, 46007, 46009, 46011,\r\n                                   46013, 46015, 46017, 46019,\r\n                                   46021, 46023, 46025, 46027,\r\n                                   46029, 46031, 46033, 46035,\r\n                                   46037, 46039, 46041, 46043,\r\n                                   46045, 46047, 46049, 46051,\r\n                                   46086, 46088, 46090, 46092,\r\n                                   46094, 46096, 46098, 46100,\r\n                                   49962, 49967, 46102, 46104,\r\n                                   50008, 50011, 50013, 50015,\r\n                                   50022, 50043, 50062, 50071,\r\n                                   50073, 50076, 50106, 50114,\r\n                                   50165, 50170, 50173, 50309,\r\n                                   50312, 50331, 50335, 50344,\r\n                                   50346, 50354, 50357, 50360,\r\n                                   50363, 50366, 50369, 50373,\r\n                                   50375, 50391, 50397, 50402,\r\n                                   50409, 50415, 50418, 50475,\r\n                                   50478, 50481, 50484, 50487,\r\n                                   50606, 50616, 50619, 50621,\r\n                                   50625, 50668, 21117, 21118,\r\n                                   34466, 21121, 21120, 21122,\r\n                                   21124, 21125, 21126, 42257,\r\n                                   42255, 42259, 42260, 49729,\r\n                                   42261, 21134, 21136, 21138,\r\n                                   45858, 21140, 21139, 21141,\r\n                                   21142, 42262, 45851, 21145,\r\n                                   21147, 21146, 21148, 21144,\r\n                                   21150, 21151, 21152, 50379,\r\n                                   21153, 21154, 49730, 49972,\r\n                                   42264, 21159, 42265, 21217,\r\n                                   49976, 21162, 21163, 42266,\r\n                                   42267, 21166, 21167, 21169,\r\n                                   42268, 42269, 21172, 42270,\r\n                                   34538, 21175, 49844, 50295,\r\n                                   21177, 21178, 42271, 42272,\r\n                                   21182, 49731, 21186, 21188,\r\n                                   21189, 42274, 21191, 21192,\r\n                                   21193, 49733, 49734, 21198,\r\n                                   21199, 21201, 50676, 50395,\r\n                                   21206, 42276, 49735, 49736,\r\n                                   50298, 21210, 21211, 21212,\r\n                                   21213, 42277, 49786, 42278,\r\n                                   21133, 42280, 21221, 45593,\r\n                                   21224, 45566, 50413, 42542,\r\n                                   21227, 21228, 21229, 45896,\r\n                                   21231, 42281, 21234, 21235,\r\n                                   49741, 49737, 21239, 42284,\r\n                                   21241, 42285, 42286, 42287,\r\n                                   42288, 21280, 49738, 49739,\r\n                                   21248, 49740, 42291, 21251,\r\n                                   42292, 21253, 21268, 49732,\r\n                                   21219, 21230, 42258, 45557,\r\n                                   21130, 21293, 21203, 34470,\r\n                                   21132, 34477, 21149, 34478,\r\n                                   21180, 21161, 34479, 21214,\r\n                                   21242, 21265, 34487, 34494,\r\n                                   34502, 34506, 21278, 34546,\r\n                                   21279, 34558, 21283, 34560,\r\n                                   34562, 34569, 45264, 45271,\r\n                                   45274, 45303, 45535, 45538,\r\n                                   45541, 45544, 45547, 45550,\r\n                                   45554, 45560, 45563, 45568,\r\n                                   45572, 45582, 45585, 45591,\r\n                                   45597, 21232, 45604, 45751,\r\n                                   45761, 21269, 21316, 21270,\r\n                                   42279, 21262, 21208, 45753,\r\n                                   21273, 21254, 45755, 21288,\r\n                                   21274, 45868, 45881, 45886,\r\n                                   21272, 21282, 45894, 49845,\r\n                                   45898, 42282, 45900, 45902,\r\n                                   45904, 45906, 45908, 45910,\r\n                                   45932, 45949, 45951, 45953,\r\n                                   45955, 45957, 45964, 45966,\r\n                                   45968, 45973, 45975, 45977,\r\n                                   45979, 45981, 45988, 45990,\r\n                                   45992, 45994, 45996, 45998,\r\n                                   46000, 46002, 46004, 46006,\r\n                                   46008, 46010, 46012, 46014,\r\n                                   46016, 46018, 46020, 46022,\r\n                                   46024, 46026, 46028, 46030,\r\n                                   46032, 46034, 46036, 46038,\r\n                                   46040, 46042, 46044, 46046,\r\n                                   46048, 46050, 46052, 46087,\r\n                                   46089, 46091, 46093, 46095,\r\n                                   46097, 46099, 46101, 49963,\r\n                                   49968, 46103, 46105, 50009,\r\n                                   50012, 50014, 50016, 50023,\r\n                                   50044, 50063, 50072, 50074,\r\n                                   50077, 50107, 50115, 50166,\r\n                                   50171, 50174, 50310, 50313,\r\n                                   50332, 50336, 50345, 50347,\r\n                                   50355, 50358, 50361, 50364,\r\n                                   50367, 50370, 50374, 50376,\r\n                                   50392, 50398, 50403, 50410,\r\n                                   50416, 50419, 50476, 50479,\r\n                                   50482, 50485, 50488, 50607,\r\n                                   50617, 50620, 50622, 50626,\r\n                                   50669, 31525, 31526, 31527,\r\n                                   31528, 31571, 49965, 31574,\r\n                                   31573, 31575, 50329, 31576,\r\n                                   31577, 31579, 31578, 31572,\r\n                                   31581, 31582, 31583, 31584,\r\n                                   31585, 31586, 31587, 31588,\r\n                                   49966, 31591, 31590, 31592,\r\n                                   50330, 31593, 31594, 31596,\r\n                                   31595, 31589, 31598, 31599,\r\n                                   31600, 31601, 31602, 31603,\r\n                                   31604, 32146, 32150, 32151,\r\n                                   32152, 32156, 32157, 32158,\r\n                                   32162, 32163, 32164, 32168,\r\n                                   32169, 32170, 32174, 32175,\r\n                                   32176, 32180, 32181, 32182,\r\n                                   32186, 32187, 32199, 32134,\r\n                                   32030, 32034, 32035, 32036,\r\n                                   32040, 32041, 32042, 32046,\r\n                                   32047, 32048, 32052, 32053,\r\n                                   32054, 32058, 32059, 32060,\r\n                                   32064, 32065, 32066, 32070,\r\n                                   32071, 49788, 49792, 49793,\r\n                                   49794, 49798, 49799, 49800,\r\n                                   49804, 49805, 49806, 49810,\r\n                                   49811, 49812, 49816, 49817,\r\n                                   49818, 49822, 49823, 49824,\r\n                                   49828, 49829, 32081, 32085,\r\n                                   32086, 32087, 32091, 32092,\r\n                                   32093, 32097, 32098, 32099,\r\n                                   32103, 32104, 32105, 32109,\r\n                                   32110, 32111, 32115, 32116,\r\n                                   32117, 32121, 32122, 32141,\r\n                                   32204, 32208, 32209, 32210,\r\n                                   32214, 32215, 32216, 32220,\r\n                                   32221, 32222, 32226, 32227,\r\n                                   32228, 32232, 32233, 32234,\r\n                                   32238, 32239, 32240, 32244,\r\n                                   32245, 316, 317, 318,\r\n                                   323, 31922, 31927, 31932,\r\n                                   31937, 31942, 31947, 31948,\r\n                                   45941, 45942, 48118, 48119,\r\n                                   31763, 31764, 31774, 31775,\r\n                                   48075, 48076, 48105, 48106,\r\n                                   31769, 31770, 48048, 48049,\r\n                                   48134, 48135, 45918, 45919,\r\n                                   31758, 31759, 31784, 31785,\r\n                                   31786, 31787, 31788, 31789,\r\n                                   31790, 31791, 32906, 32910,\r\n                                   32938, 32942, 32975, 32979,\r\n                                   45612, 32988, 32989, 32990,\r\n                                   32991, 33003, 45763, 32995,\r\n                                   32996, 32997, 32998, 45766,\r\n                                   33004, 33005, 33006, 33007,\r\n                                   33012, 33013, 33014, 33011,\r\n                                   45842, 33146, 33147, 33148,\r\n                                   33149, 33150, 33151, 33152,\r\n                                   33153, 33154, 33113, 33114,\r\n                                   33115, 33116, 33117, 33118,\r\n                                   33119, 33120, 33121, 33122,\r\n                                   33123, 33124, 33125, 33126,\r\n                                   33127, 33128, 33129, 33130,\r\n                                   33131, 33160, 33161, 33162,\r\n                                   33163, 33164, 33165, 33166,\r\n                                   33167, 33235, 33236, 33237,\r\n                                   33238, 33239, 33240, 33241,\r\n                                   33242, 33243, 33244, 33245,\r\n                                   33246, 33247, 33248, 33249,\r\n                                   33172, 33173, 33174, 33175,\r\n                                   33176, 33177, 33178, 33179,\r\n                                   33180, 33181, 33182, 33183,\r\n                                   33184, 33185, 33186, 33187,\r\n                                   33188, 33189, 33190, 33191,\r\n                                   33192, 33193, 33194, 33195,\r\n                                   33216, 33217, 33218, 33219,\r\n                                   33220, 33221, 33222, 33223,\r\n                                   33224, 33225, 33226, 33227,\r\n                                   33261, 33264, 33265, 33102,\r\n                                   33105, 33106, 32702, 32703,\r\n                                   32704, 32706, 32707, 32708,\r\n                                   32709, 32710, 32711, 32712,\r\n                                   32713, 32714, 32715, 32716,\r\n                                   32717, 32720, 32721, 32722,\r\n                                   32723, 32724, 32725, 32726,\r\n                                   32727, 32728, 32729, 32732,\r\n                                   32738, 32739, 32740, 32749,\r\n                                   32750, 32751, 32752, 32753,\r\n                                   32755, 32757, 35876, 35877,\r\n                                   35878, 35879, 49980, 33374,\r\n                                   33382, 33383, 33384, 33395,\r\n                                   33396, 33397, 33398, 33399,\r\n                                   33400, 33402, 33408, 33410,\r\n                                   33409, 33411, 33415, 33420,\r\n                                   33421, 33422, 33427, 33429,\r\n                                   33430, 33431, 33436, 33439,\r\n                                   33442, 33443, 33444, 33451,\r\n                                   33452, 33453, 33460, 33461,\r\n                                   33462, 33469, 33472, 33473,\r\n                                   33474, 33475, 33476, 33478,\r\n                                   33484, 33486, 33487, 33488,\r\n                                   33489, 33493, 33495, 33496,\r\n                                   33497, 33498, 33502, 33504,\r\n                                   33505, 33506, 33507, 33511,\r\n                                   33513, 33514, 33516, 33520,\r\n                                   33523, 49984, 50094, 50095,\r\n                                   50096, 50097, 50098, 50099,\r\n                                   50100, 50101, 50102, 50103,\r\n                                   50104, 50105, 33547, 33548,\r\n                                   34949, 49989, 33794, 33795,\r\n                                   33796, 33797, 33798, 33799,\r\n                                   33985, 33995, 34002, 34009,\r\n                                   49994, 50161, 50025, 50026,\r\n                                   50027, 50028, 50029, 50031,\r\n                                   50059, 33365, 33366, 33367,\r\n                                   33368, 34398, 34402, 34403,\r\n                                   34404, 34419, 34422, 34423,\r\n                                   34424, 34425, 34426, 34427,\r\n                                   34429, 34432, 34433, 34434,\r\n                                   34440, 34442, 34443, 34446,\r\n                                   34448, 34450, 34451, 34453,\r\n                                   34456, 34499, 34509, 34510,\r\n                                   34511, 34512, 34513, 34514,\r\n                                   34516, 34517, 34518, 34519,\r\n                                   34520, 34521, 34523, 34530,\r\n                                   34531, 34532, 34533, 34534,\r\n                                   34553, 32611, 32612, 32615,\r\n                                   32616, 32617, 32618, 32619,\r\n                                   32620, 32621, 32623, 32627,\r\n                                   32629, 32631, 32633, 32634,\r\n                                   34599, 34604, 34638, 34669,\r\n                                   34693, 34728, 34766, 34768,\r\n                                   34772, 34787, 34808, 34941,\r\n                                   34972, 34979, 34987, 34999,\r\n                                   35004, 35015, 35017, 35019,\r\n                                   35021, 35026, 35029, 35034,\r\n                                   35036, 35041, 35043, 35045,\r\n                                   35052, 35057, 35059, 33369,\r\n                                   35061, 35063, 35065, 35081,\r\n                                   35089, 35093, 35095, 35114,\r\n                                   35119, 35121, 35123, 35125,\r\n                                   35127, 35129, 35131, 35136,\r\n                                   35138, 35140, 35142, 35144,\r\n                                   35155, 35181, 35186, 35191,\r\n                                   35211, 35213, 35215, 35222,\r\n                                   35224, 35232, 35234, 35236,\r\n                                   35238, 35240, 35248, 35259,\r\n                                   35268, 35279, 35281, 35283,\r\n                                   35285, 35287, 35289, 35291,\r\n                                   35296, 35298, 35300, 35302,\r\n                                   35304, 35320, 35322, 35324,\r\n                                   35326, 35328, 35330, 35332,\r\n                                   35334, 35336, 35338, 35340,\r\n                                   35342, 35344, 35346, 35348,\r\n                                   35350, 35352, 35354, 35356,\r\n                                   35358, 35360, 35362, 35364,\r\n                                   35366, 35368, 35370, 35372,\r\n                                   35373, 32006, 35376, 35378,\r\n                                   35380, 35382, 35384, 35386,\r\n                                   35391, 35393, 35395, 33987,\r\n                                   33986, 33988, 35398, 35400,\r\n                                   35402, 35404, 35406, 35408,\r\n                                   35410, 35412, 35414, 35416,\r\n                                   35418, 35420, 35422, 35424,\r\n                                   35426, 35428, 35430, 35432,\r\n                                   35434, 35436, 35438, 35440,\r\n                                   35442, 35444, 35447, 35449,\r\n                                   35451, 35453, 35455, 35457,\r\n                                   35459, 35461, 35463, 35465,\r\n                                   35466, 35468, 35470, 43835,\r\n                                   45575, 45577, 45871, 45873,\r\n                                   45875, 45877, 45879, 45884,\r\n                                   45889, 49847, 49851, 49852,\r\n                                   49853, 49857, 49858, 49859,\r\n                                   49863, 49864, 49865, 49869,\r\n                                   49870, 49871, 49875, 49876,\r\n                                   49877, 49881, 49882, 49883,\r\n                                   49887, 49888, 50021, 50033,\r\n                                   50035, 50037, 50039, 50129,\r\n                                   50131, 50133, 50169, 50179,\r\n                                   50340, 50387, 50390, 50406,\r\n                                   50450, 50452, 50454, 50471,\r\n                                   50473, 50491, 50615, 50667,\r\n                                   50672, 50674, 50679, 50704 )\r\nGROUP  BY states.metadata_id \r\n```\r\n\nThis doesn't seem to be documented anywhere in MySQL\r\nhttps://dev.mysql.com/doc/refman/8.4/en/group-by-optimization.html\r\n\nLooks like we will need to do a deep dive in the MySQL and MariaDB source code\nThis is the optimizer result in >= 1000\r\n```\r\nMariaDB [hass_132865_rocky]>  select * from information_schema.optimizer_trace\\G\r\n*************************** 1. row ***************************\r\n                            QUERY: explain SELECT states.metadata_id          AS max_metadata_id,\r\n       Max(states.last_updated_ts) AS max_last_updated\r\nFROM   states\r\nWHERE  states.last_updated_ts >= 1732708152.6401002e0\r\n       AND states.last_updated_ts < 1734107999.999999e0\r\n       AND states.metadata_id IN ( 222, 223, 224, 50501,\r\n                                   50518, 50535, 50564, 50581,\r\n                                   50598, 389, 49770, 391,\r\n                                   49772, 394, 395, 397,\r\n                                   32307, 32308, 32310, 32371,\r\n                                   235, 236, 237, 238,\r\n                                   239, 299, 300, 31826,\r\n                                   31808, 31813, 31825, 31829,\r\n                                   302, 303, 304, 305,\r\n                                   306, 307, 371, 246,\r\n                                   248, 251, 31965, 31966,\r\n                                   31967, 31968, 31969, 10809,\r\n                                   10810, 34465, 10813, 10812,\r\n                                   10814, 10816, 10817, 10818,\r\n                                   42219, 42217, 42221, 42222,\r\n                                   49716, 42223, 10826, 10828,\r\n                                   10830, 45857, 10832, 10831,\r\n                                   10833, 10834, 42224, 45850,\r\n                                   10837, 10839, 10838, 10840,\r\n                                   10836, 10842, 10843, 10844,\r\n                                   50378, 10845, 10846, 49717,\r\n                                   49971, 42226, 10851, 42227,\r\n                                   10909, 49975, 10854, 10855,\r\n                                   42228, 42229, 10858, 10859,\r\n                                   10861, 42230, 42231, 10864,\r\n                                   42232, 34537, 10867, 49842,\r\n                                   50294, 10869, 10870, 42233,\r\n                                   42234, 10874, 49718, 10878,\r\n                                   10880, 10881, 42236, 10883,\r\n                                   10884, 10885, 49720, 49721,\r\n                                   10890, 10891, 10893, 50675,\r\n                                   50394, 10898, 42238, 49722,\r\n                                   49723, 50297, 10902, 10903,\r\n                                   10904, 10905, 42239, 49785,\r\n                                   42240, 10825, 42242, 10913,\r\n                                   45592, 10916, 45565, 50412,\r\n                                   42541, 10919, 10920, 10921,\r\n                                   45895, 10923, 42243, 10926,\r\n                                   10927, 49728, 49724, 10931,\r\n                                   42246, 10933, 42247, 42248,\r\n                                   42249, 42250, 10972, 49725,\r\n                                   49726, 10940, 49727, 42253,\r\n                                   10943, 42254, 10945, 10960,\r\n                                   49719, 10911, 10922, 42220,\r\n                                   45556, 10822, 10985, 10895,\r\n                                   34469, 10824, 34473, 10841,\r\n                                   34474, 10872, 10853, 34475,\r\n                                   10906, 10934, 10957, 34486,\r\n                                   34493, 34501, 34505, 10970,\r\n                                   34545, 10971, 34557, 10975,\r\n                                   34559, 34561, 34568, 45263,\r\n                                   45270, 45273, 45302, 45534,\r\n                                   45537, 45540, 45543, 45546,\r\n                                   45549, 45553, 45559, 45562,\r\n                                   45567, 45571, 45581, 45584,\r\n                                   45590, 45596, 10924, 45603,\r\n                                   45750, 45760, 10961, 11008,\r\n                                   10962, 42241, 10954, 10900,\r\n                                   45752, 10965, 10946, 45754,\r\n                                   10980, 10966, 45867, 45880,\r\n                                   45885, 10964, 10974, 45893,\r\n                                   49843, 45897, 42244, 45899,\r\n                                   45901, 45903, 45905, 45907,\r\n                                   45909, 45931, 45948, 45950,\r\n                                   45952, 45954, 45956, 45963,\r\n                                   45965, 45967, 45972, 45974,\r\n                                   45976, 45978, 45980, 45987,\r\n                                   45989, 45991, 45993, 45995,\r\n                                   45997, 45999, 46001, 46003,\r\n                                   46005, 46007, 46009, 46011,\r\n                                   46013, 46015, 46017, 46019,\r\n                                   46021, 46023, 46025, 46027,\r\n                                   46029, 46031, 46033, 46035,\r\n                                   46037, 46039, 46041, 46043,\r\n                                   46045, 46047, 46049, 46051,\r\n                                   46086, 46088, 46090, 46092,\r\n                                   46094, 46096, 46098, 46100,\r\n                                   49962, 49967, 46102, 46104,\r\n                                   50008, 50011, 50013, 50015,\r\n                                   50022, 50043, 50062, 50071,\r\n                                   50073, 50076, 50106, 50114,\r\n                                   50165, 50170, 50173, 50309,\r\n                                   50312, 50331, 50335, 50344,\r\n                                   50346, 50354, 50357, 50360,\r\n                                   50363, 50366, 50369, 50373,\r\n                                   50375, 50391, 50397, 50402,\r\n                                   50409, 50415, 50418, 50475,\r\n                                   50478, 50481, 50484, 50487,\r\n                                   50606, 50616, 50619, 50621,\r\n                                   50625, 50668, 21117, 21118,\r\n                                   34466, 21121, 21120, 21122,\r\n                                   21124, 21125, 21126, 42257,\r\n                                   42255, 42259, 42260, 49729,\r\n                                   42261, 21134, 21136, 21138,\r\n                                   45858, 21140, 21139, 21141,\r\n                                   21142, 42262, 45851, 21145,\r\n                                   21147, 21146, 21148, 21144,\r\n                                   21150, 21151, 21152, 50379,\r\n                                   21153, 21154, 49730, 49972,\r\n                                   42264, 21159, 42265, 21217,\r\n                                   49976, 21162, 21163, 42266,\r\n                                   42267, 21166, 21167, 21169,\r\n                                   42268, 42269, 21172, 42270,\r\n                                   34538, 21175, 49844, 50295,\r\n                                   21177, 21178, 42271, 42272,\r\n                                   21182, 49731, 21186, 21188,\r\n                                   21189, 42274, 21191, 21192,\r\n                                   21193, 49733, 49734, 21198,\r\n                                   21199, 21201, 50676, 50395,\r\n                                   21206, 42276, 49735, 49736,\r\n                                   50298, 21210, 21211, 21212,\r\n                                   21213, 42277, 49786, 42278,\r\n                                   21133, 42280, 21221, 45593,\r\n                                   21224, 45566, 50413, 42542,\r\n                                   21227, 21228, 21229, 45896,\r\n                                   21231, 42281, 21234, 21235,\r\n                                   49741, 49737, 21239, 42284,\r\n                                   21241, 42285, 42286, 42287,\r\n                                   42288, 21280, 49738, 49739,\r\n                                   21248, 49740, 42291, 21251,\r\n                                   42292, 21253, 21268, 49732,\r\n                                   21219, 21230, 42258, 45557,\r\n                                   21130, 21293, 21203, 34470,\r\n                                   21132, 34477, 21149, 34478,\r\n                                   21180, 21161, 34479, 21214,\r\n                                   21242, 21265, 34487, 34494,\r\n                                   34502, 34506, 21278, 34546,\r\n                                   21279, 34558, 21283, 34560,\r\n                                   34562, 34569, 45264, 45271,\r\n                                   45274, 45303, 45535, 45538,\r\n                                   45541, 45544, 45547, 45550,\r\n                                   45554, 45560, 45563, 45568,\r\n                                   45572, 45582, 45585, 45591,\r\n                                   45597, 21232, 45604, 45751,\r\n                                   45761, 21269, 21316, 21270,\r\n                                   42279, 21262, 21208, 45753,\r\n                                   21273, 21254, 45755, 21288,\r\n                                   21274, 45868, 45881, 45886,\r\n                                   21272, 21282, 45894, 49845,\r\n                                   45898, 42282, 45900, 45902,\r\n                                   45904, 45906, 45908, 45910,\r\n                                   45932, 45949, 45951, 45953,\r\n                                   45955, 45957, 45964, 45966,\r\n                                   45968, 45973, 45975, 45977,\r\n                                   45979, 45981, 45988, 45990,\r\n                                   45992, 45994, 45996, 45998,\r\n                                   46000, 46002, 46004, 46006,\r\n                                   46008, 46010, 46012, 46014,\r\n                                   46016, 46018, 46020, 46022,\r\n                                   46024, 46026, 46028, 46030,\r\n                                   46032, 46034, 46036, 46038,\r\n                                   46040, 46042, 46044, 46046,\r\n                                   46048, 46050, 46052, 46087,\r\n                                   46089, 46091, 46093, 46095,\r\n                                   46097, 46099, 46101, 49963,\r\n                                   49968, 46103, 46105, 50009,\r\n                                   50012, 50014, 50016, 50023,\r\n                                   50044, 50063, 50072, 50074,\r\n                                   50077, 50107, 50115, 50166,\r\n                                   50171, 50174, 50310, 50313,\r\n                                   50332, 50336, 50345, 50347,\r\n                                   50355, 50358, 50361, 50364,\r\n                                   50367, 50370, 50374, 50376,\r\n                                   50392, 50398, 50403, 50410,\r\n                                   50416, 50419, 50476, 50479,\r\n                                   50482, 50485, 50488, 50607,\r\n                                   50617, 50620, 50622, 50626,\r\n                                   50669, 31525, 31526, 31527,\r\n                                   31528, 31571, 49965, 31574,\r\n                                   31573, 31575, 50329, 31576,\r\n                                   31577, 31579, 31578, 31572,\r\n                                   31581, 31582, 31583, 31584,\r\n                                   31585, 31586, 31587, 31588,\r\n                                   49966, 31591, 31590, 31592,\r\n                                   50330, 31593, 31594, 31596,\r\n                                   31595, 31589, 31598, 31599,\r\n                                   31600, 31601, 31602, 31603,\r\n                                   31604, 32146, 32150, 32151,\r\n                                   32152, 32156, 32157, 32158,\r\n                                   32162, 32163, 32164, 32168,\r\n                                   32169, 32170, 32174, 32175,\r\n                                   32176, 32180, 32181, 32182,\r\n                                   32186, 32187, 32199, 32134,\r\n                                   32030, 32034, 32035, 32036,\r\n                                   32040, 32041, 32042, 32046,\r\n                                   32047, 32048, 32052, 32053,\r\n                                   32054, 32058, 32059, 32060,\r\n                                   32064, 32065, 32066, 32070,\r\n                                   32071, 49788, 49792, 49793,\r\n                                   49794, 49798, 49799, 49800,\r\n                                   49804, 49805, 49806, 49810,\r\n                                   49811, 49812, 49816, 49817,\r\n                                   49818, 49822, 49823, 49824,\r\n                                   49828, 49829, 32081, 32085,\r\n                                   32086, 32087, 32091, 32092,\r\n                                   32093, 32097, 32098, 32099,\r\n                                   32103, 32104, 32105, 32109,\r\n                                   32110, 32111, 32115, 32116,\r\n                                   32117, 32121, 32122, 32141,\r\n                                   32204, 32208, 32209, 32210,\r\n                                   32214, 32215, 32216, 32220,\r\n                                   32221, 32222, 32226, 32227,\r\n                                   32228, 32232, 32233, 32234,\r\n                                   32238, 32239, 32240, 32244,\r\n                                   32245, 316, 317, 318,\r\n                                   323, 31922, 31927, 31932,\r\n                                   31937, 31942, 31947, 31948,\r\n                                   45941, 45942, 48118, 48119,\r\n                                   31763, 31764, 31774, 31775,\r\n                                   48075, 48076, 48105, 48106,\r\n                                   31769, 31770, 48048, 48049,\r\n                                   48134, 48135, 45918, 45919,\r\n                                   31758, 31759, 31784, 31785,\r\n                                   31786, 31787, 31788, 31789,\r\n                                   31790, 31791, 32906, 32910,\r\n                                   32938, 32942, 32975, 32979,\r\n                                   45612, 32988, 32989, 32990,\r\n                                   32991, 33003, 45763, 32995,\r\n                                   32996, 32997, 32998, 45766,\r\n                                   33004, 33005, 33006, 33007,\r\n                                   33012, 33013, 33014, 33011,\r\n                                   45842, 33146, 33147, 33148,\r\n                                   33149, 33150, 33151, 33152,\r\n                                   33153, 33154, 33113, 33114,\r\n                                   33115, 33116, 33117, 33118,\r\n                                   33119, 33120, 33121, 33122,\r\n                                   33123, 33124, 33125, 33126,\r\n                                   33127, 33128, 33129, 33130,\r\n                                   33131, 33160, 33161, 33162,\r\n                                   33163, 33164, 33165, 33166,\r\n                                   33167, 33235, 33236, 33237,\r\n                                   33238, 33239, 33240, 33241,\r\n                                   33242, 33243, 33244, 33245,\r\n                                   33246, 33247, 33248, 33249,\r\n                                   33172, 33173, 33174, 33175,\r\n                                   33176, 33177, 33178, 33179,\r\n                                   33180, 33181, 33182, 33183,\r\n                                   33184, 33185, 33186, 33187,\r\n                                   33188, 33189, 33190, 33191,\r\n                                   33192, 33193, 33194, 33195,\r\n                                   33216, 33217, 33218, 33219,\r\n                                   33220, 33221, 33222, 33223,\r\n                                   33224, 33225, 33226, 33227,\r\n                                   33261, 33264, 33265, 33102,\r\n                                   33105, 33106, 32702, 32703,\r\n                                   32704, 32706, 32707, 32708,\r\n                                   32709, 32710, 32711, 32712,\r\n                                   32713, 32714, 32715, 32716,\r\n                                   32717, 32720, 32721, 32722,\r\n                                   32723, 32724, 32725, 32726,\r\n                                   32727, 32728, 32729, 32732,\r\n                                   32738, 32739, 32740, 32749,\r\n                                   32750, 32751, 32752, 32753,\r\n                                   32755, 32757, 35876, 35877,\r\n                                   35878, 35879, 49980, 33374,\r\n                                   33382, 33383, 33384, 33395,\r\n                                   33396, 33397, 33398, 33399,\r\n                                   33400, 33402, 33408, 33410,\r\n                                   33409, 33411, 33415, 33420,\r\n                                   33421, 33422, 33427, 33429,\r\n                                   33430, 33431, 33436, 33439,\r\n                                   33442, 33443, 33444, 33451,\r\n                                   33452, 33453, 33460, 33461,\r\n                                   33462, 33469, 33472, 33473,\r\n                                   33474, 33475, 33476, 33478,\r\n                                   33484, 33486, 33487, 33488,\r\n                                   33489, 33493, 33495, 33496,\r\n                                   33497, 33498, 33502, 33504,\r\n                                   33505, 33506, 33507, 33511,\r\n                                   33513, 33514, 33516, 33520,\r\n                                   33523, 49984, 50094, 50095,\r\n                                   50096, 50097, 50098, 50099,\r\n                                   50100, 50101, 50102, 50103,\r\n                                   50104, 50105, 33547, 33548,\r\n                                   34949, 49989, 33794, 33795,\r\n                                   33796, 33797, 33798, 33799,\r\n                                   33985, 33995, 34002, 34009,\r\n                                   49994, 50161, 50025, 50026,\r\n                                   50027, 50028, 50029, 50031,\r\n                                   50059, 33365, 33366, 33367,\r\n                                   33368, 34398, 34402, 34403,\r\n                                   34404, 34419, 34422, 34423,\r\n                                   34424, 34425, 34426, 34427,\r\n                                   34429, 34432, 34433, 34434,\r\n                                   34440, 34442, 34443, 34446,\r\n                                   34448, 34450, 34451, 34453,\r\n                                   34456, 34499, 34509, 34510,\r\n                                   34511, 34512, 34513, 34514,\r\n                                   34516, 34517, 34518, 34519,\r\n                                   34520, 34521, 34523, 34530,\r\n                                   34531, 34532, 34533, 34534,\r\n                                   34553, 32611, 32612, 32615,\r\n                                   32616, 32617, 32618, 32619,\r\n                                   32620, 32621, 32623, 32627,\r\n                                   32629, 32631, 32633, 32634,\r\n                                   34599, 34604, 34638, 34669,\r\n                                   34693, 34728, 34766, 34768,\r\n                                   34772, 34787, 34808, 34941,\r\n                                   34972, 34979, 34987, 34999,\r\n                                   35004, 35015, 35017, 35019,\r\n                                   35021, 35026, 35029, 35034,\r\n                                   35036, 35041, 35043, 35045,\r\n                                   35052, 35057, 35059, 33369,\r\n                                   35061, 35063, 35065, 35081,\r\n                                   35089, 35093, 35095, 35114,\r\n                                   35119, 35121, 35123, 35125,\r\n                                   35127, 35129, 35131, 35136,\r\n                                   35138, 35140, 35142, 35144,\r\n                                   35155, 35181, 35186, 35191,\r\n                                   35211, 35213, 35215, 35222,\r\n                                   35224, 35232, 35234, 35236,\r\n                                   35238, 35240, 35248, 35259,\r\n                                   35268, 35279, 35281, 35283,\r\n                                   35285, 35287, 35289, 35291,\r\n                                   35296, 35298, 35300, 35302,\r\n                                   35304, 35320, 35322, 35324,\r\n                                   35326, 35328, 35330, 35332,\r\n                                   35334, 35336, 35338, 35340,\r\n                                   35342, 35344, 35346, 35348,\r\n                                   35350, 35352, 35354, 35356,\r\n                                   35358, 35360, 35362, 35364,\r\n                                   35366, 35368, 35370, 35372,\r\n                                   35373, 32006, 35376, 35378,\r\n                                   35380, 35382, 35384, 35386,\r\n                                   35391, 35393, 35395, 33987,\r\n                                   33986, 33988, 35398, 35400,\r\n                                   35402, 35404, 35406, 35408,\r\n                                   35410, 35412, 35414, 35416,\r\n                                   35418, 35420, 35422, 35424,\r\n                                   35426, 35428, 35430, 35432,\r\n                                   35434, 35436, 35438, 35440,\r\n                                   35442, 35444, 35447, 35449,\r\n                                   35451, 35453, 35455, 35457,\r\n                                   35459, 35461, 35463, 35465,\r\n                                   35466, 35468, 35470, 43835,\r\n                                   45575, 45577, 45871, 45873,\r\n                                   45875, 45877, 45879, 45884,\r\n                                   45889, 49847, 49851, 49852,\r\n                                   49853, 49857, 49858, 49859,\r\n                                   49863, 49864, 49865, 49869,\r\n                                   49870, 49871, 49875, 49876,\r\n                                   49877, 49881, 49882, 49883,\r\n                                   49887, 49888, 50021, 50033,\r\n                                   50035, 50037, 50039, 50129,\r\n                                   50131, 50133, 50169, 50179,\r\n                                   50340, 50387, 50390, 50406,\r\n                                   50450, 50452, 50454, 50471,\r\n                                   50473, 50491, 50615, 50667,\r\n                                   50672, 50674, 50679, 50704 )\r\nGROUP  BY states.metadata_id\r\n                            TRACE: {\r\n  \"steps\": [\r\n    {\r\n      \"join_preparation\": {\r\n        \"select_id\": 1,\r\n        \"steps\": [\r\n          {\r\n            \"expanded_query\": \"select states.metadata_id AS max_metadata_id,max(states.last_updated_ts) AS max_last_updated from states where states.last_updated_ts >= 1732708152.6401002e0 and states.last_updated_ts < 1734107999.999999e0 and states.metadata_id in (222,223,224,50501,50518,50535,50564,50581,50598,389,49770,391,49772,394,395,397,32307,32308,32310,32371,235,236,237,238,239,299,300,31826,31808,31813,31825,31829,302,303,304,305,306,307,371,246,248,251,31965,31966,31967,31968,31969,10809,10810,34465,10813,10812,10814,10816,10817,10818,42219,42217,42221,42222,49716,42223,10826,10828,10830,45857,10832,10831,10833,10834,42224,45850,10837,10839,10838,10840,10836,10842,10843,10844,50378,10845,10846,49717,49971,42226,10851,42227,10909,49975,10854,10855,42228,42229,10858,10859,10861,42230,42231,10864,42232,34537,10867,49842,50294,10869,10870,42233,42234,10874,49718,10878,10880,10881,42236,10883,10884,10885,49720,49721,10890,10891,10893,50675,50394,10898,42238,49722,49723,50297,10902,10903,10904,10905,42239,49785,42240,10825,42242,10913,45592,10916,45565,50412,42541,10919,10920,10921,45895,10923,42243,10926,10927,49728,49724,10931,42246,10933,42247,42248,42249,42250,10972,49725,49726,10940,49727,42253,10943,42254,10945,10960,49719,10911,10922,42220,45556,10822,10985,10895,34469,10824,34473,10841,34474,10872,10853,34475,10906,10934,10957,34486,34493,34501,34505,10970,34545,10971,34557,10975,34559,34561,34568,45263,45270,45273,45302,45534,45537,45540,45543,45546,45549,45553,45559,45562,45567,45571,45581,45584,45590,45596,10924,45603,45750,45760,10961,11008,10962,42241,10954,10900,45752,10965,10946,45754,10980,10966,45867,45880,45885,10964,10974,45893,49843,45897,42244,45899,45901,45903,45905,45907,45909,45931,45948,45950,45952,45954,45956,45963,45965,45967,45972,45974,45976,45978,45980,45987,45989,45991,45993,45995,45997,45999,46001,46003,46005,46007,46009,46011,46013,46015,46017,46019,46021,46023,46025,46027,46029,46031,46033,46035,46037,46039,46041,46043,46045,46047,46049,46051,46086,46088,46090,46092,46094,46096,46098,46100,49962,49967,46102,46104,50008,50011,50013,50015,50022,50043,50062,50071,50073,50076,50106,50114,50165,50170,50173,50309,50312,50331,50335,50344,50346,50354,50357,50360,50363,50366,50369,50373,50375,50391,50397,50402,50409,50415,50418,50475,50478,50481,50484,50487,50606,50616,50619,50621,50625,50668,21117,21118,34466,21121,21120,21122,21124,21125,21126,42257,42255,42259,42260,49729,42261,21134,21136,21138,45858,21140,21139,21141,21142,42262,45851,21145,21147,21146,21148,21144,21150,21151,21152,50379,21153,21154,49730,49972,42264,21159,42265,21217,49976,21162,21163,42266,42267,21166,21167,21169,42268,42269,21172,42270,34538,21175,49844,50295,21177,21178,42271,42272,21182,49731,21186,21188,21189,42274,21191,21192,21193,49733,49734,21198,21199,21201,50676,50395,21206,42276,49735,49736,50298,21210,21211,21212,21213,42277,49786,42278,21133,42280,21221,45593,21224,45566,50413,42542,21227,21228,21229,45896,21231,42281,21234,21235,49741,49737,21239,42284,21241,42285,42286,42287,42288,21280,49738,49739,21248,49740,42291,21251,42292,21253,21268,49732,21219,21230,42258,45557,21130,21293,21203,34470,21132,34477,21149,34478,21180,21161,34479,21214,21242,21265,34487,34494,34502,34506,21278,34546,21279,34558,21283,34560,34562,34569,45264,45271,45274,45303,45535,45538,45541,45544,45547,45550,45554,45560,45563,45568,45572,45582,45585,45591,45597,21232,45604,45751,45761,21269,21316,21270,42279,21262,21208,45753,21273,21254,45755,21288,21274,45868,45881,45886,21272,21282,45894,49845,45898,42282,45900,45902,45904,45906,45908,45910,45932,45949,45951,45953,45955,45957,45964,45966,45968,45973,45975,45977,45979,45981,45988,45990,45992,45994,45996,45998,46000,46002,46004,46006,46008,46010,46012,46014,46016,46018,46020,46022,46024,46026,46028,46030,46032,46034,46036,46038,46040,46042,46044,46046,46048,46050,46052,46087,46089,46091,46093,46095,46097,46099,46101,49963,49968,46103,46105,50009,50012,50014,50016,50023,50044,50063,50072,50074,50077,50107,50115,50166,50171,50174,50310,50313,50332,50336,50345,50347,50355,50358,50361,50364,50367,50370,50374,50376,50392,50398,50403,50410,50416,50419,50476,50479,50482,50485,50488,50607,50617,50620,50622,50626,50669,31525,31526,31527,31528,31571,49965,31574,31573,31575,50329,31576,31577,31579,31578,31572,31581,31582,31583,31584,31585,31586,31587,31588,49966,31591,31590,31592,50330,31593,31594,31596,31595,31589,31598,31599,31600,31601,31602,31603,31604,32146,32150,32151,32152,32156,32157,32158,32162,32163,32164,32168,32169,32170,32174,32175,32176,32180,32181,32182,32186,32187,32199,32134,32030,32034,32035,32036,32040,32041,32042,32046,32047,32048,32052,32053,32054,32058,32059,32060,32064,32065,32066,32070,32071,49788,49792,49793,49794,49798,49799,49800,49804,49805,49806,49810,49811,49812,49816,49817,49818,49822,49823,49824,49828,49829,32081,32085,32086,32087,32091,32092,32093,32097,32098,32099,32103,32104,32105,32109,32110,32111,32115,32116,32117,32121,32122,32141,32204,32208,32209,32210,32214,32215,32216,32220,32221,32222,32226,32227,32228,32232,32233,32234,32238,32239,32240,32244,32245,316,317,318,323,31922,31927,31932,31937,31942,31947,31948,45941,45942,48118,48119,31763,31764,31774,31775,48075,48076,48105,48106,31769,31770,48048,48049,48134,48135,45918,45919,31758,31759,31784,31785,31786,31787,31788,31789,31790,31791,32906,32910,32938,32942,32975,32979,45612,32988,32989,32990,32991,33003,45763,32995,32996,32997,32998,45766,33004,33005,33006,33007,33012,33013,33014,33011,45842,33146,33147,33148,33149,33150,33151,33152,33153,33154,33113,33114,33115,33116,33117,33118,33119,33120,33121,33122,33123,33124,33125,33126,33127,33128,33129,33130,33131,33160,33161,33162,33163,33164,33165,33166,33167,33235,33236,33237,33238,33239,33240,33241,33242,33243,33244,33245,33246,33247,33248,33249,33172,33173,33174,33175,33176,33177,33178,33179,33180,33181,33182,33183,33184,33185,33186,33187,33188,33189,33190,33191,33192,33193,33194,33195,33216,33217,33218,33219,33220,33221,33222,33223,33224,33225,33226,33227,33261,33264,33265,33102,33105,33106,32702,32703,32704,32706,32707,32708,32709,32710,32711,32712,32713,32714,32715,32716,32717,32720,32721,32722,32723,32724,32725,32726,32727,32728,32729,32732,32738,32739,32740,32749,32750,32751,32752,32753,32755,32757,35876,35877,35878,35879,49980,33374,33382,33383,33384,33395,33396,33397,33398,33399,33400,33402,33408,33410,33409,33411,33415,33420,33421,33422,33427,33429,33430,33431,33436,33439,33442,33443,33444,33451,33452,33453,33460,33461,33462,33469,33472,33473,33474,33475,33476,33478,33484,33486,33487,33488,33489,33493,33495,33496,33497,33498,33502,33504,33505,33506,33507,33511,33513,33514,33516,33520,33523,49984,50094,50095,50096,50097,50098,50099,50100,50101,50102,50103,50104,50105,33547,33548,34949,49989,33794,33795,33796,33797,33798,33799,33985,33995,34002,34009,49994,50161,50025,50026,50027,50028,50029,50031,50059,33365,33366,33367,33368,34398,34402,34403,34404,34419,34422,34423,34424,34425,34426,34427,34429,34432,34433,34434,34440,34442,34443,34446,34448,34450,34451,34453,34456,34499,34509,34510,34511,34512,34513,34514,34516,34517,34518,34519,34520,34521,34523,34530,34531,34532,34533,34534,34553,32611,32612,32615,32616,32617,32618,32619,32620,32621,32623,32627,32629,32631,32633,32634,34599,34604,34638,34669,34693,34728,34766,34768,34772,34787,34808,34941,34972,34979,34987,34999,35004,35015,35017,35019,35021,35026,35029,35034,35036,35041,35043,35045,35052,35057,35059,33369,35061,35063,35065,35081,35089,35093,35095,35114,35119,35121,35123,35125,35127,35129,35131,35136,35138,35140,35142,35144,35155,35181,35186,35191,35211,35213,35215,35222,35224,35232,35234,35236,35238,35240,35248,35259,35268,35279,35281,35283,35285,35287,35289,35291,35296,35298,35300,35302,35304,35320,35322,35324,35326,35328,35330,35332,35334,35336,35338,35340,35342,35344,35346,35348,35350,35352,35354,35356,35358,35360,35362,35364,35366,35368,35370,35372,35373,32006,35376,35378,35380,35382,35384,35386,35391,35393,35395,33987,33986,33988,35398,35400,35402,35404,35406,35408,35410,35412,35414,35416,35418,35420,35422,35424,35426,35428,35430,35432,35434,35436,35438,35440,35442,35444,35447,35449,35451,35453,35455,35457,35459,35461,35463,35465,35466,35468,35470,43835,45575,45577,45871,45873,45875,45877,45879,45884,45889,49847,49851,49852,49853,49857,49858,49859,49863,49864,49865,49869,49870,49871,49875,49876,49877,49881,49882,49883,49887,49888,50021,50033,50035,50037,50039,50129,50131,50133,50169,50179,50340,50387,50390,50406,50450,50452,50454,50471,50473,50491,50615,50667,50672,50674,50679,50704) group by states.metadata_id\"\r\n          }\r\n        ]\r\n      }\r\n    },\r\n    {\r\n      \"join_optimization\": {\r\n        \"select_id\": 1,\r\n        \"steps\": [\r\n          {\r\n            \"in_to_subquery_conversion\": {\r\n              \"item\": \"states.metadata_id in (222,223,224,50501,50518,50535,50564,50581,50598,389,49770,391,49772,394,395,397,32307,32308,32310,32371,235,236,237,238,239,299,300,31826,31808,31813,31825,31829,302,303,304,305,306,307,371,246,248,251,31965,31966,31967,31968,31969,10809,10810,34465,10813,10812,10814,10816,10817,10818,42219,42217,42221,42222,49716,42223,10826,10828,10830,45857,10832,10831,10833,10834,42224,45850,10837,10839,10838,10840,10836,10842,10843,10844,50378,10845,10846,49717,49971,42226,10851,42227,10909,49975,10854,10855,42228,42229,10858,10859,10861,42230,42231,10864,42232,34537,10867,49842,50294,10869,10870,42233,42234,10874,49718,10878,10880,10881,42236,10883,10884,10885,49720,49721,10890,10891,10893,50675,50394,10898,42238,49722,49723,50297,10902,10903,10904,10905,42239,49785,42240,10825,42242,10913,45592,10916,45565,50412,42541,10919,10920,10921,45895,10923,42243,10926,10927,49728,49724,10931,42246,10933,42247,42248,42249,42250,10972,49725,49726,10940,49727,42253,10943,42254,10945,10960,49719,10911,10922,42220,45556,10822,10985,10895,34469,10824,34473,10841,34474,10872,10853,34475,10906,10934,10957,34486,34493,34501,34505,10970,34545,10971,34557,10975,34559,34561,34568,45263,45270,45273,45302,45534,45537,45540,45543,45546,45549,45553,45559,45562,45567,45571,45581,45584,45590,45596,10924,45603,45750,45760,10961,11008,10962,42241,10954,10900,45752,10965,10946,45754,10980,10966,45867,45880,45885,10964,10974,45893,49843,45897,42244,45899,45901,45903,45905,45907,45909,45931,45948,45950,45952,45954,45956,45963,45965,45967,45972,45974,45976,45978,45980,45987,45989,45991,45993,45995,45997,45999,46001,46003,46005,46007,46009,46011,46013,46015,46017,46019,46021,46023,46025,46027,46029,46031,46033,46035,46037,46039,46041,46043,46045,46047,46049,46051,46086,46088,46090,46092,46094,46096,46098,46100,49962,49967,46102,46104,50008,50011,50013,50015,50022,50043,50062,50071,50073,50076,50106,50114,50165,50170,50173,50309,50312,50331,50335,50344,50346,50354,50357,50360,50363,50366,50369,50373,50375,50391,50397,50402,50409,50415,50418,50475,50478,50481,50484,50487,50606,50616,50619,50621,50625,50668,21117,21118,34466,21121,21120,21122,21124,21125,21126,42257,42255,42259,42260,49729,42261,21134,21136,21138,45858,21140,21139,21141,21142,42262,45851,21145,21147,21146,21148,21144,21150,21151,21152,50379,21153,21154,49730,49972,42264,21159,42265,21217,49976,21162,21163,42266,42267,21166,21167,21169,42268,42269,21172,42270,34538,21175,49844,50295,21177,21178,42271,42272,21182,49731,21186,21188,21189,42274,21191,21192,21193,49733,49734,21198,21199,21201,50676,50395,21206,42276,49735,49736,50298,21210,21211,21212,21213,42277,49786,42278,21133,42280,21221,45593,21224,45566,50413,42542,21227,21228,21229,45896,21231,42281,21234,21235,49741,49737,21239,42284,21241,42285,42286,42287,42288,21280,49738,49739,21248,49740,42291,21251,42292,21253,21268,49732,21219,21230,42258,45557,21130,21293,21203,34470,21132,34477,21149,34478,21180,21161,34479,21214,21242,21265,34487,34494,34502,34506,21278,34546,21279,34558,21283,34560,34562,34569,45264,45271,45274,45303,45535,45538,45541,45544,45547,45550,45554,45560,45563,45568,45572,45582,45585,45591,45597,21232,45604,45751,45761,21269,21316,21270,42279,21262,21208,45753,21273,21254,45755,21288,21274,45868,45881,45886,21272,21282,45894,49845,45898,42282,45900,45902,45904,45906,45908,45910,45932,45949,45951,45953,45955,45957,45964,45966,45968,45973,45975,45977,45979,45981,45988,45990,45992,45994,45996,45998,46000,46002,46004,46006,46008,46010,46012,46014,46016,46018,46020,46022,46024,46026,46028,46030,46032,46034,46036,46038,46040,46042,46044,46046,46048,46050,46052,46087,46089,46091,46093,46095,46097,46099,46101,49963,49968,46103,46105,50009,50012,50014,50016,50023,50044,50063,50072,50074,50077,50107,50115,50166,50171,50174,50310,50313,50332,50336,50345,50347,50355,50358,50361,50364,50367,50370,50374,50376,50392,50398,50403,50410,50416,50419,50476,50479,50482,50485,50488,50607,50617,50620,50622,50626,50669,31525,31526,31527,31528,31571,49965,31574,31573,31575,50329,31576,31577,31579,31578,31572,31581,31582,31583,31584,31585,31586,31587,31588,49966,31591,31590,31592,50330,31593,31594,31596,31595,31589,31598,31599,31600,31601,31602,31603,31604,32146,32150,32151,32152,32156,32157,32158,32162,32163,32164,32168,32169,32170,32174,32175,32176,32180,32181,32182,32186,32187,32199,32134,32030,32034,32035,32036,32040,32041,32042,32046,32047,32048,32052,32053,32054,32058,32059,32060,32064,32065,32066,32070,32071,49788,49792,49793,49794,49798,49799,49800,49804,49805,49806,49810,49811,49812,49816,49817,49818,49822,49823,49824,49828,49829,32081,32085,32086,32087,32091,32092,32093,32097,32098,32099,32103,32104,32105,32109,32110,32111,32115,32116,32117,32121,32122,32141,32204,32208,32209,32210,32214,32215,32216,32220,32221,32222,32226,32227,32228,32232,32233,32234,32238,32239,32240,32244,32245,316,317,318,323,31922,31927,31932,31937,31942,31947,31948,45941,45942,48118,48119,31763,31764,31774,31775,48075,48076,48105,48106,31769,31770,48048,48049,48134,48135,45918,45919,31758,31759,31784,31785,31786,31787,31788,31789,31790,31791,32906,32910,32938,32942,32975,32979,45612,32988,32989,32990,32991,33003,45763,32995,32996,32997,32998,45766,33004,33005,33006,33007,33012,33013,33014,33011,45842,33146,33147,33148,33149,33150,33151,33152,33153,33154,33113,33114,33115,33116,33117,33118,33119,33120,33121,33122,33123,33124,33125,33126,33127,33128,33129,33130,33131,33160,33161,33162,33163,33164,33165,33166,33167,33235,33236,33237,33238,33239,33240,33241,33242,33243,33244,33245,33246,33247,33248,33249,33172,33173,33174,33175,33176,33177,33178,33179,33180,33181,33182,33183,33184,33185,33186,33187,33188,33189,33190,33191,33192,33193,33194,33195,33216,33217,33218,33219,33220,33221,33222,33223,33224,33225,33226,33227,33261,33264,33265,33102,33105,33106,32702,32703,32704,32706,32707,32708,32709,32710,32711,32712,32713,32714,32715,32716,32717,32720,32721,32722,32723,32724,32725,32726,32727,32728,32729,32732,32738,32739,32740,32749,32750,32751,32752,32753,32755,32757,35876,35877,35878,35879,49980,33374,33382,33383,33384,33395,33396,33397,33398,33399,33400,33402,33408,33410,33409,33411,33415,33420,33421,33422,33427,33429,33430,33431,33436,33439,33442,33443,33444,33451,33452,33453,33460,33461,33462,33469,33472,33473,33474,33475,33476,33478,33484,33486,33487,33488,33489,33493,33495,33496,33497,33498,33502,33504,33505,33506,33507,33511,33513,33514,33516,33520,33523,49984,50094,50095,50096,50097,50098,50099,50100,50101,50102,50103,50104,50105,33547,33548,34949,49989,33794,33795,33796,33797,33798,33799,33985,33995,34002,34009,49994,50161,50025,50026,50027,50028,50029,50031,50059,33365,33366,33367,33368,34398,34402,34403,34404,34419,34422,34423,34424,34425,34426,34427,34429,34432,34433,34434,34440,34442,34443,34446,34448,34450,34451,34453,34456,34499,34509,34510,34511,34512,34513,34514,34516,34517,34518,34519,34520,34521,34523,34530,34531,34532,34533,34534,34553,32611,32612,32615,32616,32617,32618,32619,32620,32621,32623,32627,32629,32631,32633,32634,34599,34604,34638,34669,34693,34728,34766,34768,34772,34787,34808,34941,34972,34979,34987,34999,35004,35015,35017,35019,35021,35026,35029,35034,35036,35041,35043,35045,35052,35057,35059,33369,35061,35063,35065,35081,35089,35093,35095,35114,35119,35121,35123,35125,35127,35129,35131,35136,35138,35140,35142,35144,35155,35181,35186,35191,35211,35213,35215,35222,35224,35232,35234,35236,35238,35240,35248,35259,35268,35279,35281,35283,35285,35287,35289,35291,35296,35298,35300,35302,35304,35320,35322,35324,35326,35328,35330,35332,35334,35336,35338,35340,35342,35344,35346,35348,35350,35352,35354,35356,35358,35360,35362,35364,35366,35368,35370,35372,35373,32006,35376,35378,35380,35382,35384,35386,35391,35393,35395,33987,33986,33988,35398,35400,35402,35404,35406,35408,35410,35412,35414,35416,35418,35420,35422,35424,35426,35428,35430,35432,35434,35436,35438,35440,35442,35444,35447,35449,35451,35453,35455,35457,35459,35461,35463,35465,35466,35468,35470,43835,45575,45577,45871,45873,45875,45877,45879,45884,45889,49847,49851,49852,49853,49857,49858,49859,49863,49864,49865,49869,49870,49871,49875,49876,49877,49881,49882,49883,49887,49888,50021,50033,50035,50037,50039,50129,50131,50133,50169,50179,50340,50387,50390,50406,50450,50452,50454,50471,50473,50491,50615,50667,50672,50674,50679,50704)\",\r\n              \"conversion\": [\r\n                {\r\n                  \"join_preparation\": {\r\n                    \"select_id\": 2,\r\n                    \"steps\": [\r\n                      {\r\n                        \"derived\": {\r\n                          \"table\": \"tvc_0\",\r\n                          \"select_id\": 3,\r\n                          \"algorithm\": \"materialized\"\r\n                        }\r\n                      },\r\n                      {\r\n                        \"transformation\": {\r\n                          \"select_id\": 2,\r\n                          \"from\": \"IN (SELECT)\",\r\n                          \"to\": \"semijoin\",\r\n                          \"chosen\": true\r\n                        }\r\n                      },\r\n                      {\r\n                        \"expanded_query\": \"/* select#2 */ select tvc_0._col_1 from (values (222),(223),(224),(50501),(50518),(50535),(50564),(50581),(50598),(389),(49770),(391),(49772),(394),(395),(397),(32307),(32308),(32310),(32371),(235),(236),(237),(238),(239),(299),(300),(31826),(31808),(31813),(31825),(31829),(302),(303),(304),(305),(306),(307),(371),(246),(248),(251),(31965),(31966),(31967),(31968),(31969),(10809),(10810),(34465),(10813),(10812),(10814),(10816),(10817),(10818),(42219),(42217),(42221),(42222),(49716),(42223),(10826),(10828),(10830),(45857),(10832),(10831),(10833),(10834),(42224),(45850),(10837),(10839),(10838),(10840),(10836),(10842),(10843),(10844),(50378),(10845),(10846),(49717),(49971),(42226),(10851),(42227),(10909),(49975),(10854),(10855),(42228),(42229),(10858),(10859),(10861),(42230),(42231),(10864),(42232),(34537),(10867),(49842),(50294),(10869),(10870),(42233),(42234),(10874),(49718),(10878),(10880),(10881),(42236),(10883),(10884),(10885),(49720),(49721),(10890),(10891),(10893),(50675),(50394),(10898),(42238),(49722),(49723),(50297),(10902),(10903),(10904),(10905),(42239),(49785),(42240),(10825),(42242),(10913),(45592),(10916),(45565),(50412),(42541),(10919),(10920),(10921),(45895),(10923),(42243),(10926),(10927),(49728),(49724),(10931),(42246),(10933),(42247),(42248),(42249),(42250),(10972),(49725),(49726),(10940),(49727),(42253),(10943),(42254),(10945),(10960),(49719),(10911),(10922),(42220),(45556),(10822),(10985),(10895),(34469),(10824),(34473),(10841),(34474),(10872),(10853),(34475),(10906),(10934),(10957),(34486),(34493),(34501),(34505),(10970),(34545),(10971),(34557),(10975),(34559),(34561),(34568),(45263),(45270),(45273),(45302),(45534),(45537),(45540),(45543),(45546),(45549),(45553),(45559),(45562),(45567),(45571),(45581),(45584),(45590),(45596),(10924),(45603),(45750),(45760),(10961),(11008),(10962),(42241),(10954),(10900),(45752),(10965),(10946),(45754),(10980),(10966),(45867),(45880),(45885),(10964),(10974),(45893),(49843),(45897),(42244),(45899),(45901),(45903),(45905),(45907),(45909),(45931),(45948),(45950),(45952),(45954),(45956),(45963),(45965),(45967),(45972),(45974),(45976),(45978),(45980),(45987),(45989),(45991),(45993),(45995),(45997),(45999),(46001),(46003),(46005),(46007),(46009),(46011),(46013),(46015),(46017),(46019),(46021),(46023),(46025),(46027),(46029),(46031),(46033),(46035),(46037),(46039),(46041),(46043),(46045),(46047),(46049),(46051),(46086),(46088),(46090),(46092),(46094),(46096),(46098),(46100),(49962),(49967),(46102),(46104),(50008),(50011),(50013),(50015),(50022),(50043),(50062),(50071),(50073),(50076),(50106),(50114),(50165),(50170),(50173),(50309),(50312),(50331),(50335),(50344),(50346),(50354),(50357),(50360),(50363),(50366),(50369),(50373),(50375),(50391),(50397),(50402),(50409),(50415),(50418),(50475),(50478),(50481),(50484),(50487),(50606),(50616),(50619),(50621),(50625),(50668),(21117),(21118),(34466),(21121),(21120),(21122),(21124),(21125),(21126),(42257),(42255),(42259),(42260),(49729),(42261),(21134),(21136),(21138),(45858),(21140),(21139),(21141),(21142),(42262),(45851),(21145),(21147),(21146),(21148),(21144),(21150),(21151),(21152),(50379),(21153),(21154),(49730),(49972),(42264),(21159),(42265),(21217),(49976),(21162),(21163),(42266),(42267),(21166),(21167),(21169),(42268),(42269),(21172),(42270),(34538),(21175),(49844),(50295),(21177),(21178),(42271),(42272),(21182),(49731),(21186),(21188),(21189),(42274),(21191),(21192),(21193),(49733),(49734),(21198),(21199),(21201),(50676),(50395),(21206),(42276),(49735),(49736),(50298),(21210),(21211),(21212),(21213),(42277),(49786),(42278),(21133),(42280),(21221),(45593),(21224),(45566),(50413),(42542),(21227),(21228),(21229),(45896),(21231),(42281),(21234),(21235),(49741),(49737),(21239),(42284),(21241),(42285),(42286),(42287),(42288),(21280),(49738),(49739),(21248),(49740),(42291),(21251),(42292),(21253),(21268),(49732),(21219),(21230),(42258),(45557),(21130),(21293),(21203),(34470),(21132),(34477),(21149),(34478),(21180),(21161),(34479),(21214),(21242),(21265),(34487),(34494),(34502),(34506),(21278),(34546),(21279),(34558),(21283),(34560),(34562),(34569),(45264),(45271),(45274),(45303),(45535),(45538),(45541),(45544),(45547),(45550),(45554),(45560),(45563),(45568),(45572),(45582),(45585),(45591),(45597),(21232),(45604),(45751),(45761),(21269),(21316),(21270),(42279),(21262),(21208),(45753),(21273),(21254),(45755),(21288),(21274),(45868),(45881),(45886),(21272),(21282),(45894),(49845),(45898),(42282),(45900),(45902),(45904),(45906),(45908),(45910),(45932),(45949),(45951),(45953),(45955),(45957),(45964),(45966),(45968),(45973),(45975),(45977),(45979),(45981),(45988),(45990),(45992),(45994),(45996),(45998),(46000),(46002),(46004),(46006),(46008),(46010),(46012),(46014),(46016),(46018),(46020),(46022),(46024),(46026),(46028),(46030),(46032),(46034),(46036),(46038),(46040),(46042),(46044),(46046),(46048),(46050),(46052),(46087),(46089),(46091),(46093),(46095),(46097),(46099),(46101),(49963),(49968),(46103),(46105),(50009),(50012),(50014),(50016),(50023),(50044),(50063),(50072),(50074),(50077),(50107),(50115),(50166),(50171),(50174),(50310),(50313),(50332),(50336),(50345),(50347),(50355),(50358),(50361),(50364),(50367),(50370),(50374),(50376),(50392),(50398),(50403),(50410),(50416),(50419),(50476),(50479),(50482),(50485),(50488),(50607),(50617),(50620),(50622),(50626),(50669),(31525),(31526),(31527),(31528),(31571),(49965),(31574),(31573),(31575),(50329),(31576),(31577),(31579),(31578),(31572),(31581),(31582),(31583),(31584),(31585),(31586),(31587),(31588),(49966),(31591),(31590),(31592),(50330),(31593),(31594),(31596),(31595),(31589),(31598),(31599),(31600),(31601),(31602),(31603),(31604),(32146),(32150),(32151),(32152),(32156),(32157),(32158),(32162),(32163),(32164),(32168),(32169),(32170),(32174),(32175),(32176),(32180),(32181),(32182),(32186),(32187),(32199),(32134),(32030),(32034),(32035),(32036),(32040),(32041),(32042),(32046),(32047),(32048),(32052),(32053),(32054),(32058),(32059),(32060),(32064),(32065),(32066),(32070),(32071),(49788),(49792),(49793),(49794),(49798),(49799),(49800),(49804),(49805),(49806),(49810),(49811),(49812),(49816),(49817),(49818),(49822),(49823),(49824),(49828),(49829),(32081),(32085),(32086),(32087),(32091),(32092),(32093),(32097),(32098),(32099),(32103),(32104),(32105),(32109),(32110),(32111),(32115),(32116),(32117),(32121),(32122),(32141),(32204),(32208),(32209),(32210),(32214),(32215),(32216),(32220),(32221),(32222),(32226),(32227),(32228),(32232),(32233),(32234),(32238),(32239),(32240),(32244),(32245),(316),(317),(318),(323),(31922),(31927),(31932),(31937),(31942),(31947),(31948),(45941),(45942),(48118),(48119),(31763),(31764),(31774),(31775),(48075),(48076),(48105),(48106),(31769),(31770),(48048),(48049),(48134),(48135),(45918),(45919),(31758),(31759),(31784),(31785),(31786),(31787),(31788),(31789),(31790),(31791),(32906),(32910),(32938),(32942),(32975),(32979),(45612),(32988),(32989),(32990),(32991),(33003),(45763),(32995),(32996),(32997),(32998),(45766),(33004),(33005),(33006),(33007),(33012),(33013),(33014),(33011),(45842),(33146),(33147),(33148),(33149),(33150),(33151),(33152),(33153),(33154),(33113),(33114),(33115),(33116),(33117),(33118),(33119),(33120),(33121),(33122),(33123),(33124),(33125),(33126),(33127),(33128),(33129),(33130),(33131),(33160),(33161),(33162),(33163),(33164),(33165),(33166),(33167),(33235),(33236),(33237),(33238),(33239),(33240),(33241),(33242),(33243),(33244),(33245),(33246),(33247),(33248),(33249),(33172),(33173),(33174),(33175),(33176),(33177),(33178),(33179),(33180),(33181),(33182),(33183),(33184),(33185),(33186),(33187),(33188),(33189),(33190),(33191),(33192),(33193),(33194),(33195),(33216),(33217),(33218),(33219),(33220),(33221),(33222),(33223),(33224),(33225),(33226),(33227),(33261),(33264),(33265),(33102),(33105),(33106),(32702),(32703),(32704),(32706),(32707),(32708),(32709),(32710),(32711),(32712),(32713),(32714),(32715),(32716),(32717),(32720),(32721),(32722),(32723),(32724),(32725),(32726),(32727),(32728),(32729),(32732),(32738),(32739),(32740),(32749),(32750),(32751),(32752),(32753),(32755),(32757),(35876),(35877),(35878),(35879),(49980),(33374),(33382),(33383),(33384),(33395),(33396),(33397),(33398),(33399),(33400),(33402),(33408),(33410),(33409),(33411),(33415),(33420),(33421),(33422),(33427),(33429),(33430),(33431),(33436),(33439),(33442),(33443),(33444),(33451),(33452),(33453),(33460),(33461),(33462),(33469),(33472),(33473),(33474),(33475),(33476),(33478),(33484),(33486),(33487),(33488),(33489),(33493),(33495),(33496),(33497),(33498),(33502),(33504),(33505),(33506),(33507),(33511),(33513),(33514),(33516),(33520),(33523),(49984),(50094),(50095),(50096),(50097),(50098),(50099),(50100),(50101),(50102),(50103),(50104),(50105),(33547),(33548),(34949),(49989),(33794),(33795),(33796),(33797),(33798),(33799),(33985),(33995),(34002),(34009),(49994),(50161),(50025),(50026),(50027),(50028),(50029),(50031),(50059),(33365),(33366),(33367),(33368),(34398),(34402),(34403),(34404),(34419),(34422),(34423),(34424),(34425),(34426),(34427),(34429),(34432),(34433),(34434),(34440),(34442),(34443),(34446),(34448),(34450),(34451),(34453),(34456),(34499),(34509),(34510),(34511),(34512),(34513),(34514),(34516),(34517),(34518),(34519),(34520),(34521),(34523),(34530),(34531),(34532),(34533),(34534),(34553),(32611),(32612),(32615),(32616),(32617),(32618),(32619),(32620),(32621),(32623),(32627),(32629),(32631),(32633),(32634),(34599),(34604),(34638),(34669),(34693),(34728),(34766),(34768),(34772),(34787),(34808),(34941),(34972),(34979),(34987),(34999),(35004),(35015),(35017),(35019),(35021),(35026),(35029),(35034),(35036),(35041),(35043),(35045),(35052),(35057),(35059),(33369),(35061),(35063),(35065),(35081),(35089),(35093),(35095),(35114),(35119),(35121),(35123),(35125),(35127),(35129),(35131),(35136),(35138),(35140),(35142),(35144),(35155),(35181),(35186),(35191),(35211),(35213),(35215),(35222),(35224),(35232),(35234),(35236),(35238),(35240),(35248),(35259),(35268),(35279),(35281),(35283),(35285),(35287),(35289),(35291),(35296),(35298),(35300),(35302),(35304),(35320),(35322),(35324),(35326),(35328),(35330),(35332),(35334),(35336),(35338),(35340),(35342),(35344),(35346),(35348),(35350),(35352),(35354),(35356),(35358),(35360),(35362),(35364),(35366),(35368),(35370),(35372),(35373),(32006),(35376),(35378),(35380),(35382),(35384),(35386),(35391),(35393),(35395),(33987),(33986),(33988),(35398),(35400),(35402),(35404),(35406),(35408),(35410),(35412),(35414),(35416),(35418),(35420),(35422),(35424),(35426),(35428),(35430),(35432),(35434),(35436),(35438),(35440),(35442),(35444),(35447),(35449),(35451),(35453),(35455),(35457),(35459),(35461),(35463),(35465),(35466),(35468),(35470),(43835),(45575),(45577),(45871),(45873),(45875),(45877),(45879),(45884),(45889),(49847),(49851),(49852),(49853),(49857),(49858),(49859),(49863),(49864),(49865),(49869),(49870),(49871),(49875),(49876),(49877),(49881),(49882),(49883),(49887),(49888),(50021),(50033),(50035),(50037),(50039),(50129),(50131),(50133),(50169),(50179),(50340),(50387),(50390),(50406),(50450),(50452),(50454),(50471),(50473),(50491),(50615),(50667),(50672),(50674),(50679),(50704)) tvc_0\"\r\n                      }\r\n                    ]\r\n                  }\r\n                }\r\n              ]\r\n            }\r\n          },\r\n          {\r\n            \"transformation\": {\r\n              \"select_id\": 2,\r\n              \"from\": \"IN (SELECT)\",\r\n              \"to\": \"materialization\",\r\n              \"sjm_scan_allowed\": true,\r\n              \"possible\": true\r\n            }\r\n          },\r\n          {\r\n            \"transformation\": {\r\n              \"select_id\": 2,\r\n              \"from\": \"IN (SELECT)\",\r\n              \"to\": \"semijoin\",\r\n              \"converted_to_semi_join\": true\r\n            }\r\n          },\r\n          {\r\n            \"condition_processing\": {\r\n              \"condition\": \"WHERE\",\r\n              \"original_condition\": \"states.last_updated_ts >= 1732708152.6401002e0 and states.last_updated_ts < 1734107999.999999e0 and 1 and states.metadata_id = tvc_0._col_1\",\r\n              \"steps\": [\r\n                {\r\n                  \"transformation\": \"equality_propagation\",\r\n                  \"resulting_condition\": \"states.last_updated_ts >= 1732708152.6401002e0 and states.last_updated_ts < 1734107999.999999e0 and 1 and states.metadata_id = tvc_0._col_1\"\r\n                },\r\n                {\r\n                  \"transformation\": \"constant_propagation\",\r\n                  \"resulting_condition\": \"states.last_updated_ts >= 1732708152.6401002e0 and states.last_updated_ts < 1734107999.999999e0 and 1 and states.metadata_id = tvc_0._col_1\"\r\n                },\r\n                {\r\n                  \"transformation\": \"trivial_condition_removal\",\r\n                  \"resulting_condition\": \"states.last_updated_ts >= 1732708152.6401002e0 and states.last_updated_ts < 1734107999.999999e0 and states.metadata_id = tvc_0._col_1\"\r\n                }\r\n              ]\r\n            }\r\n          },\r\n          {\r\n            \"table_dependencies\": [\r\n              {\r\n                \"table\": \"states\",\r\n                \"row_may_be_null\": false,\r\n                \"map_bit\": 0,\r\n                \"depends_on_map_bits\": []\r\n              },\r\n              {\r\n                \"table\": \"<derived3>\",\r\n                \"row_may_be_null\": false,\r\n                \"map_bit\": 1,\r\n                \"depends_on_map_bits\": []\r\n              }\r\n            ]\r\n          },\r\n          {\r\n            \"ref_optimizer_key_uses\": [\r\n              {\r\n                \"table\": \"states\",\r\n                \"index\": \"ix_states_metadata_id_last_updated_ts\",\r\n                \"field\": \"metadata_id\",\r\n                \"equals\": \"tvc_0._col_1\",\r\n                \"null_rejecting\": true\r\n              },\r\n              {\r\n                \"table\": \"<derived3>\",\r\n                \"index\": \"distinct_key\",\r\n                \"field\": \"_col_1\",\r\n                \"equals\": \"states.metadata_id\",\r\n                \"null_rejecting\": true\r\n              },\r\n              {\r\n                \"table\": \"<derived3>\",\r\n                \"index\": \"key1\",\r\n                \"field\": \"_col_1\",\r\n                \"equals\": \"states.metadata_id\",\r\n                \"null_rejecting\": true\r\n              }\r\n            ]\r\n          },\r\n          {\r\n            \"rows_estimation\": [\r\n              {\r\n                \"table\": \"states\",\r\n                \"range_analysis\": {\r\n                  \"table_scan\": {\r\n                    \"rows\": 34802007,\r\n                    \"cost\": 5870.448962\r\n                  },\r\n                  \"potential_range_indexes\": [\r\n                    {\r\n                      \"index\": \"PRIMARY\",\r\n                      \"usable\": false,\r\n                      \"cause\": \"not applicable\"\r\n                    },\r\n                    {\r\n                      \"index\": \"ix_states_last_updated_ts\",\r\n                      \"usable\": true,\r\n                      \"key_parts\": [\"last_updated_ts\", \"state_id\"]\r\n                    },\r\n                    {\r\n                      \"index\": \"ix_states_context_id_bin\",\r\n                      \"usable\": false,\r\n                      \"cause\": \"not applicable\"\r\n                    },\r\n                    {\r\n                      \"index\": \"ix_states_metadata_id_last_updated_ts\",\r\n                      \"usable\": true,\r\n                      \"key_parts\": [\"metadata_id\", \"last_updated_ts\", \"state_id\"]\r\n                    },\r\n                    {\r\n                      \"index\": \"ix_states_old_state_id\",\r\n                      \"usable\": false,\r\n                      \"cause\": \"not applicable\"\r\n                    },\r\n                    {\r\n                      \"index\": \"ix_states_attributes_id\",\r\n                      \"usable\": false,\r\n                      \"cause\": \"not applicable\"\r\n                    }\r\n                  ],\r\n                  \"best_covering_index_scan\": {\r\n                    \"index\": \"ix_states_metadata_id_last_updated_ts\",\r\n                    \"cost\": 5167.88395,\r\n                    \"chosen\": true\r\n                  },\r\n                  \"setup_range_conditions\": [],\r\n                  \"analyzing_range_alternatives\": {\r\n                    \"range_scan_alternatives\": [\r\n                      {\r\n                        \"index\": \"ix_states_last_updated_ts\",\r\n                        \"ranges\": [\r\n                          \"(1732708152.6401002) <= (last_updated_ts) < (1734107999.999999)\"\r\n                        ],\r\n                        \"rowid_ordered\": false,\r\n                        \"using_mrr\": false,\r\n                        \"index_only\": false,\r\n                        \"rows\": 34802007,\r\n                        \"cost\": 34804.33004,\r\n                        \"chosen\": false,\r\n                        \"cause\": \"cost\"\r\n                      }\r\n                    ],\r\n                    \"analyzing_roworder_intersect\": {\r\n                      \"cause\": \"too few roworder scans\"\r\n                    },\r\n                    \"analyzing_index_merge_union\": []\r\n                  },\r\n                  \"group_index_range\": {\r\n                    \"chosen\": false,\r\n                    \"cause\": \"not single_table\"\r\n                  }\r\n                }\r\n              },\r\n              {\r\n                \"selectivity_for_indexes\": [\r\n                  {\r\n                    \"index_name\": \"ix_states_last_updated_ts\",\r\n                    \"selectivity_from_index\": 1\r\n                  }\r\n                ],\r\n                \"selectivity_for_columns\": [],\r\n                \"cond_selectivity\": 1\r\n              },\r\n              {\r\n                \"table\": \"<derived3>\",\r\n                \"table_scan\": {\r\n                  \"rows\": 1396,\r\n                  \"read_cost\": 0.024449438,\r\n                  \"read_and_compare_cost\": 0.072379702\r\n                }\r\n              }\r\n            ]\r\n          },\r\n          {\r\n            \"semijoin_table_pullout\": {\r\n              \"pulled_out_tables\": [\"tvc_0\"]\r\n            }\r\n          },\r\n          {\r\n            \"considered_execution_plans\": [\r\n              {\r\n                \"plan_prefix\": \"\",\r\n                \"get_costs_for_tables\": [\r\n                  {\r\n                    \"best_access_path\": {\r\n                      \"table\": \"<derived3>\",\r\n                      \"plan_details\": {\r\n                        \"record_count\": 1\r\n                      },\r\n                      \"considered_access_paths\": [\r\n                        {\r\n                          \"access_type\": \"scan\",\r\n                          \"rows\": 1396,\r\n                          \"rows_after_filter\": 1396,\r\n                          \"rows_out\": 1396,\r\n                          \"cost\": 0.072379702,\r\n                          \"index_only\": false,\r\n                          \"chosen\": true\r\n                        }\r\n                      ],\r\n                      \"chosen_access_method\": {\r\n                        \"type\": \"scan\",\r\n                        \"rows_read\": 1396,\r\n                        \"rows_out\": 1396,\r\n                        \"cost\": 0.072379702,\r\n                        \"uses_join_buffering\": false\r\n                      }\r\n                    }\r\n                  },\r\n                  {\r\n                    \"best_access_path\": {\r\n                      \"table\": \"states\",\r\n                      \"plan_details\": {\r\n                        \"record_count\": 1\r\n                      },\r\n                      \"considered_access_paths\": [\r\n                        {\r\n                          \"access_type\": \"scan\",\r\n                          \"rows\": 34802007,\r\n                          \"rows_after_filter\": 34802007,\r\n                          \"rows_out\": 34802007,\r\n                          \"cost\": 5167.88395,\r\n                          \"index_only\": true,\r\n                          \"chosen\": true,\r\n                          \"use_tmp_table\": true\r\n                        }\r\n                      ],\r\n                      \"chosen_access_method\": {\r\n                        \"type\": \"scan\",\r\n                        \"rows_read\": 34802007,\r\n                        \"rows_out\": 34802007,\r\n                        \"cost\": 5167.88395,\r\n                        \"uses_join_buffering\": false\r\n                      }\r\n                    }\r\n                  }\r\n                ]\r\n              },\r\n              {\r\n                \"plan_prefix\": \"\",\r\n                \"table\": \"<derived3>\",\r\n                \"rows_for_plan\": 1396,\r\n                \"cost_for_plan\": 0.072379702,\r\n                \"semijoin_strategy_choice\": [],\r\n                \"rest_of_plan\": [\r\n                  {\r\n                    \"plan_prefix\": \"<derived3>\",\r\n                    \"get_costs_for_tables\": [\r\n                      {\r\n                        \"best_access_path\": {\r\n                          \"table\": \"states\",\r\n                          \"plan_details\": {\r\n                            \"record_count\": 1396\r\n                          },\r\n                          \"considered_access_paths\": [\r\n                            {\r\n                              \"access_type\": \"ref\",\r\n                              \"index\": \"ix_states_metadata_id_last_updated_ts\",\r\n                              \"rows\": 558,\r\n                              \"cost\": 117.7539262,\r\n                              \"chosen\": true\r\n                            },\r\n                            {\r\n                              \"type\": \"scan\",\r\n                              \"chosen\": false,\r\n                              \"cause\": \"cost\"\r\n                            }\r\n                          ],\r\n                          \"chosen_access_method\": {\r\n                            \"type\": \"ref\",\r\n                            \"rows_read\": 558,\r\n                            \"rows_out\": 558,\r\n                            \"cost\": 117.7539262,\r\n                            \"uses_join_buffering\": false\r\n                          }\r\n                        }\r\n                      }\r\n                    ]\r\n                  },\r\n                  {\r\n                    \"plan_prefix\": \"<derived3>\",\r\n                    \"table\": \"states\",\r\n                    \"rows_for_plan\": 778968,\r\n                    \"cost_for_plan\": 117.8263059,\r\n                    \"semijoin_strategy_choice\": [],\r\n                    \"cost_for_sorting\": 530.0209546\r\n                  }\r\n                ]\r\n              },\r\n              {\r\n                \"plan_prefix\": \"\",\r\n                \"table\": \"states\",\r\n                \"rows_for_plan\": 34802007,\r\n                \"cost_for_plan\": 5167.88395,\r\n                \"semijoin_strategy_choice\": [],\r\n                \"pruned_by_cost\": true,\r\n                \"current_cost\": 5167.88395,\r\n                \"best_cost\": 647.8472605\r\n              }\r\n            ]\r\n          },\r\n          {\r\n            \"best_join_order\": [\"<derived3>\", \"states\"],\r\n            \"rows\": 778968,\r\n            \"cost\": 647.8472605\r\n          },\r\n          {\r\n            \"substitute_best_equal\": {\r\n              \"condition\": \"WHERE\",\r\n              \"resulting_condition\": \"states.last_updated_ts >= 1732708152.6401002e0 and states.last_updated_ts < 1734107999.999999e0 and states.metadata_id = tvc_0._col_1\"\r\n            }\r\n          },\r\n          {\r\n            \"attaching_conditions_to_tables\": {\r\n              \"attached_conditions_computation\": [],\r\n              \"attached_conditions_summary\": [\r\n                {\r\n                  \"table\": \"<derived3>\",\r\n                  \"attached_condition\": null\r\n                },\r\n                {\r\n                  \"table\": \"states\",\r\n                  \"attached_condition\": \"states.last_updated_ts >= 1732708152.6401002e0 and states.last_updated_ts < 1734107999.999999e0 and states.metadata_id = tvc_0._col_1\"\r\n                }\r\n              ]\r\n            }\r\n          },\r\n          {\r\n            \"make_join_readinfo\": []\r\n          },\r\n          {\r\n            \"prepare_sum_aggregators\": {\r\n              \"function\": \"max(states.last_updated_ts)\",\r\n              \"aggregator_type\": \"simple\"\r\n            }\r\n          }\r\n        ]\r\n      }\r\n    },\r\n    {\r\n      \"join_execution\": {\r\n        \"select_id\": 1,\r\n        \"steps\": []\r\n      }\r\n    }\r\n  ]\r\n}\r\nMISSING_BYTES_BEYOND_MAX_MEM_SIZE: 0\r\n          INSUFFICIENT_PRIVILEGES: 0\r\n1 row in set (0.009 sec)\r\n\r\n```\nHere is < 1000\r\n[opt_less_than_1000 (1).txt](https://github.com/user-attachments/files/18136569/opt_less_than_1000.1.txt)\r\n\r\n\r\n\n>=1000\r\n\r\ndoesn't choose `group_index_range` because \r\n\r\n```\r\n                  \"group_index_range\": {\r\n                    \"chosen\": false,\r\n                    \"cause\": \"not single_table\"\r\n                  }\r\n```\nPostgresql likely has a different optimizer issue\nThe solution for MySQL is to break up the query in 999 or less and than combine the result.\r\n\r\nPostgresql doesn't support \"skip scan\" or [\"loose index scan\"](https://wiki.postgresql.org/wiki/Loose_indexscan)s so we need to use a different query for postgresql to use a recursive query instead .. which is going to make the solution here quite complex as we need branching based on the db engine\r\n\nA lateral join will work for postgresql\r\nsomething like:\r\n```sql\r\nSELECT     known_metadata_id,\r\n           last_updated_ts\r\nFROM       unnest('{2169, 2170, 485, 661, 672, 673, 753, 754, 755, 756, 759, 450, 463, 483, 2003, 2004, 2007, 2008, 2009, 2000, 2001, 1968, 627, 569, 570, 571, 572, 573, 574, 591, 592, 593, 634, 643, 1559, 1537, 1546, 1741, 1742, 1743, 1745, 1751, 1753, 1756, 1757, 1758, 1759, 1760, 1761, 421, 2, 7, 20, 12, 2118, 2120, 2135, 2137, 494, 502, 511, 549, 554, 561, 566, 929, 935, 1313, 1314, 1315, 608}'::int[]) known_metadata_id\r\nCROSS JOIN lateral\r\n           (\r\n                  SELECT max(inner_states.last_updated_ts) AS last_updated_ts\r\n                  FROM   states inner_states\r\n                  WHERE  inner_states.last_updated_ts >= 1668568337.475832\r\n                  AND    inner_states.last_updated_ts < 1733899499.999999\r\n                  AND    inner_states.metadata_id = known_metadata_id ) AS start_time_states\r\n```\nFor MySQL/MariaDB/sqlite: limit to 999 metadata_ids https://github.com/home-assistant/core/issues/132865#issuecomment-2543160459 and than combine the results in Python (dict merge is cheap)\r\nFor Postgresql, use a lateral join: https://github.com/home-assistant/core/issues/132865#issuecomment-2543307753\r\n\r\nNow making that all work in sqlalchemy is likely going to be an nightmare\nShould look something like this for postgresql\r\n\r\n```\r\nSELECT \r\n  anon_1.metadata_id, \r\n  anon_1.state, \r\n  anon_1.last_updated_ts, \r\n  anon_1.last_changed_ts, \r\n  anon_1.attributes \r\nFROM \r\n  (\r\n    SELECT \r\n      anon_2.metadata_id AS metadata_id, \r\n      anon_2.state AS state, \r\n      anon_2.last_updated_ts AS last_updated_ts, \r\n      anon_2.last_changed_ts AS last_changed_ts, \r\n      anon_2.attributes AS attributes \r\n    FROM \r\n      (\r\n        SELECT \r\n          states.metadata_id AS metadata_id, \r\n          states.state AS state, \r\n          0 AS last_updated_ts, \r\n          0 AS last_changed_ts, \r\n          CASE WHEN (\r\n            state_attributes.shared_attrs IS NULL\r\n          ) THEN states.attributes ELSE state_attributes.shared_attrs END AS attributes \r\n        FROM \r\n          states \r\n          JOIN (\r\n            SELECT \r\n              known_metadata_id as max_metadata_id, \r\n              last_updated_ts as max_last_updated \r\n            FROM \r\n              unnest(\r\n                '{2169, 2170, 485, 661, 672, 673, 753, 754, 755, 756, 759, 450, 463, 483, 2003, 2004, 2007, 2008, 2009, 2000, 2001, 1968, 627, 569, 570, 571, 572, 573, 574, 591, 592, 593, 634, 643, 1559, 1537, 1546, 1741, 1742, 1743, 1745, 1751, 1753, 1756, 1757, 1758, 1759, 1760, 1761, 421, 2, 7, 20, 12, 2118, 2120, 2135, 2137, 494, 502, 511, 549, 554, 561, 566, 929, 935, 1313, 1314, 1315, 608}' :: int[]\r\n              ) known_metadata_id CROSS \r\n              JOIN LATERAL (\r\n                SELECT \r\n                  Max(inner_states.last_updated_ts) as last_updated_ts \r\n                FROM \r\n                  states inner_states \r\n                WHERE \r\n                  inner_states.last_updated_ts >= 1668568337.475832 \r\n                  AND inner_states.last_updated_ts < 1733899499.999999 \r\n                  AND inner_states.metadata_id = known_metadata_id\r\n              ) as start_time_states\r\n          ) AS anon_3 ON states.metadata_id = anon_3.max_metadata_id \r\n          AND states.last_updated_ts = anon_3.max_last_updated \r\n          LEFT OUTER JOIN state_attributes ON states.attributes_id = state_attributes.attributes_id \r\n        WHERE \r\n          states.last_updated_ts >= 1668568337.475832 \r\n          AND states.last_updated_ts < 1733899499.999999 \r\n          AND states.metadata_id IN (\r\n            2169, 2170, 485, 661, 672, 673, 753, 754, \r\n            755, 756, 759, 450, 463, 483, 2003, 2004, \r\n            2007, 2008, 2009, 2000, 2001, 1968, \r\n            627, 569, 570, 571, 572, 573, 574, 591, \r\n            592, 593, 634, 643, 1559, 1537, 1546, \r\n            1741, 1742, 1743, 1745, 1751, 1753, \r\n            1756, 1757, 1758, 1759, 1760, 1761, \r\n            421, 2, 7, 20, 12, 2118, 2120, 2135, 2137, \r\n            494, 502, 511, 549, 554, 561, 566, 929, \r\n            935, 1313, 1314, 1315, 608\r\n          )\r\n      ) AS anon_2 \r\n    UNION ALL \r\n    SELECT \r\n      anon_4.metadata_id AS metadata_id, \r\n      anon_4.state AS state, \r\n      anon_4.last_updated_ts AS last_updated_ts, \r\n      anon_4.last_changed_ts AS last_changed_ts, \r\n      anon_4.attributes AS attributes \r\n    FROM \r\n      (\r\n        SELECT \r\n          states.metadata_id AS metadata_id, \r\n          states.state AS state, \r\n          states.last_updated_ts AS last_updated_ts, \r\n          states.last_changed_ts AS last_changed_ts, \r\n          CASE WHEN (\r\n            state_attributes.shared_attrs IS NULL\r\n          ) THEN states.attributes ELSE state_attributes.shared_attrs END AS attributes \r\n        FROM \r\n          states \r\n          LEFT OUTER JOIN state_attributes ON states.attributes_id = state_attributes.attributes_id \r\n        WHERE \r\n          states.metadata_id IN (\r\n            2169, 2170, 485, 661, 672, 673, 753, 754, \r\n            755, 756, 759, 450, 463, 483, 2003, 2004, \r\n            2007, 2008, 2009, 2000, 2001, 1968, \r\n            627, 569, 570, 571, 572, 573, 574, 591, \r\n            592, 593, 634, 643, 1559, 1537, 1546, \r\n            1741, 1742, 1743, 1745, 1751, 1753, \r\n            1756, 1757, 1758, 1759, 1760, 1761, \r\n            421, 2, 7, 20, 12, 2118, 2120, 2135, 2137, \r\n            494, 502, 511, 549, 554, 561, 566, 929, \r\n            935, 1313, 1314, 1315, 608\r\n          ) \r\n          AND states.last_updated_ts > 1733899499.999999 \r\n          AND states.last_updated_ts < 1733899800.0\r\n      ) AS anon_4\r\n  ) AS anon_1 \r\nORDER BY \r\n  anon_1.metadata_id, \r\n  anon_1.last_updated_ts\r\n```", "created_at": "2024-12-14T19:43:48Z"}
{"repo": "home-assistant/core", "pull_number": 133226, "instance_id": "home-assistant__core-133226", "issue_numbers": ["129663"], "base_commit": "ff1df757b157c912eeee993fdd0347686b11ffec", "patch": "diff --git a/homeassistant/components/enigma2/config_flow.py b/homeassistant/components/enigma2/config_flow.py\nindex e9502a0f7cd87a..b0649a8368d5d5 100644\n--- a/homeassistant/components/enigma2/config_flow.py\n+++ b/homeassistant/components/enigma2/config_flow.py\n@@ -133,7 +133,8 @@ async def validate_user_input(\n         except Exception:  # noqa: BLE001\n             errors = {\"base\": \"unknown\"}\n         else:\n-            await self.async_set_unique_id(about[\"info\"][\"ifaces\"][0][\"mac\"])\n+            unique_id = about[\"info\"][\"ifaces\"][0][\"mac\"] or self.unique_id\n+            await self.async_set_unique_id(unique_id)\n             self._abort_if_unique_id_configured()\n \n         return errors\ndiff --git a/homeassistant/components/enigma2/coordinator.py b/homeassistant/components/enigma2/coordinator.py\nindex a35e74f582f280..d5bbf2c0ce58c5 100644\n--- a/homeassistant/components/enigma2/coordinator.py\n+++ b/homeassistant/components/enigma2/coordinator.py\n@@ -35,6 +35,7 @@ class Enigma2UpdateCoordinator(DataUpdateCoordinator[OpenWebIfStatus]):\n     \"\"\"The Enigma2 data update coordinator.\"\"\"\n \n     device: OpenWebIfDevice\n+    unique_id: str | None\n \n     def __init__(self, hass: HomeAssistant, config_entry: ConfigEntry) -> None:\n         \"\"\"Initialize the Enigma2 data update coordinator.\"\"\"\n@@ -64,6 +65,10 @@ def __init__(self, hass: HomeAssistant, config_entry: ConfigEntry) -> None:\n             name=config_entry.data[CONF_HOST],\n         )\n \n+        # set the unique ID for the entities to the config entry unique ID\n+        # for devices that don't report a MAC address\n+        self.unique_id = config_entry.unique_id\n+\n     async def _async_setup(self) -> None:\n         \"\"\"Provide needed data to the device info.\"\"\"\n \n@@ -71,16 +76,20 @@ async def _async_setup(self) -> None:\n         self.device.mac_address = about[\"info\"][\"ifaces\"][0][\"mac\"]\n         self.device_info[\"model\"] = about[\"info\"][\"model\"]\n         self.device_info[\"manufacturer\"] = about[\"info\"][\"brand\"]\n-        self.device_info[ATTR_IDENTIFIERS] = {\n-            (DOMAIN, format_mac(iface[\"mac\"]))\n-            for iface in about[\"info\"][\"ifaces\"]\n-            if \"mac\" in iface and iface[\"mac\"] is not None\n-        }\n-        self.device_info[ATTR_CONNECTIONS] = {\n-            (CONNECTION_NETWORK_MAC, format_mac(iface[\"mac\"]))\n-            for iface in about[\"info\"][\"ifaces\"]\n-            if \"mac\" in iface and iface[\"mac\"] is not None\n-        }\n+        if self.device.mac_address is not None:\n+            self.device_info[ATTR_IDENTIFIERS] = {\n+                (DOMAIN, format_mac(iface[\"mac\"]))\n+                for iface in about[\"info\"][\"ifaces\"]\n+                if \"mac\" in iface and iface[\"mac\"] is not None\n+            }\n+            self.device_info[ATTR_CONNECTIONS] = {\n+                (CONNECTION_NETWORK_MAC, format_mac(iface[\"mac\"]))\n+                for iface in about[\"info\"][\"ifaces\"]\n+                if \"mac\" in iface and iface[\"mac\"] is not None\n+            }\n+            self.unique_id = self.device.mac_address\n+        elif self.unique_id is not None:\n+            self.device_info[ATTR_IDENTIFIERS] = {(DOMAIN, self.unique_id)}\n \n     async def _async_update_data(self) -> OpenWebIfStatus:\n         await self.device.update()\ndiff --git a/homeassistant/components/enigma2/media_player.py b/homeassistant/components/enigma2/media_player.py\nindex 8287e055814037..ee0de15c3fb7f7 100644\n--- a/homeassistant/components/enigma2/media_player.py\n+++ b/homeassistant/components/enigma2/media_player.py\n@@ -4,7 +4,6 @@\n \n import contextlib\n from logging import getLogger\n-from typing import cast\n \n from aiohttp.client_exceptions import ServerDisconnectedError\n from openwebif.enums import PowerState, RemoteControlCodes, SetVolumeOption\n@@ -15,7 +14,6 @@\n     MediaPlayerState,\n     MediaType,\n )\n-from homeassistant.config_entries import ConfigEntry\n from homeassistant.core import HomeAssistant, callback\n from homeassistant.helpers.entity_platform import AddEntitiesCallback\n from homeassistant.helpers.update_coordinator import CoordinatorEntity\n@@ -65,10 +63,7 @@ def __init__(self, coordinator: Enigma2UpdateCoordinator) -> None:\n \n         super().__init__(coordinator)\n \n-        self._attr_unique_id = (\n-            coordinator.device.mac_address\n-            or cast(ConfigEntry, coordinator.config_entry).entry_id\n-        )\n+        self._attr_unique_id = coordinator.unique_id\n \n         self._attr_device_info = coordinator.device_info\n \n", "test_patch": "diff --git a/tests/components/enigma2/test_init.py b/tests/components/enigma2/test_init.py\nindex ab19c2ce51a988..d12f96d4b0f0d1 100644\n--- a/tests/components/enigma2/test_init.py\n+++ b/tests/components/enigma2/test_init.py\n@@ -5,23 +5,37 @@\n from homeassistant.components.enigma2.const import DOMAIN\n from homeassistant.config_entries import ConfigEntryState\n from homeassistant.core import HomeAssistant\n+from homeassistant.helpers import device_registry as dr\n \n from .conftest import TEST_REQUIRED, MockDevice\n \n from tests.common import MockConfigEntry\n \n \n+async def test_device_without_mac_address(\n+    hass: HomeAssistant, device_registry: dr.DeviceRegistry\n+) -> None:\n+    \"\"\"Test that a device gets successfully registered when the device doesn't report a MAC address.\"\"\"\n+    mock_device = MockDevice()\n+    mock_device.mac_address = None\n+    with patch(\n+        \"homeassistant.components.enigma2.coordinator.OpenWebIfDevice.__new__\",\n+        return_value=mock_device,\n+    ):\n+        entry = MockConfigEntry(\n+            domain=DOMAIN, data=TEST_REQUIRED, title=\"name\", unique_id=\"123456\"\n+        )\n+        entry.add_to_hass(hass)\n+        await hass.config_entries.async_setup(entry.entry_id)\n+        await hass.async_block_till_done()\n+        assert device_registry.async_get_device({(DOMAIN, entry.unique_id)}) is not None\n+\n+\n async def test_unload_entry(hass: HomeAssistant) -> None:\n     \"\"\"Test successful unload of entry.\"\"\"\n-    with (\n-        patch(\n-            \"homeassistant.components.enigma2.coordinator.OpenWebIfDevice.__new__\",\n-            return_value=MockDevice(),\n-        ),\n-        patch(\n-            \"homeassistant.components.enigma2.media_player.async_setup_entry\",\n-            return_value=True,\n-        ),\n+    with patch(\n+        \"homeassistant.components.enigma2.coordinator.OpenWebIfDevice.__new__\",\n+        return_value=MockDevice(),\n     ):\n         entry = MockConfigEntry(domain=DOMAIN, data=TEST_REQUIRED, title=\"name\")\n         entry.add_to_hass(hass)\n", "problem_statement": "Enigma2 (Openwebif): Not adding entity with invalid device info\n### The problem\r\n\r\nHello, I have a problem with enigma2 integration in my Home Assistant OS (based on Raspberry Pi 4B). I'm not able to see any devices from enigma2. I have Zgemma H11s and I have installed Openatv 7.5. All I see when reloading extension is:\r\n\r\n_enigma2: Not adding entity with invalid device info: Invalid device info {'configuration_url': 'http://192.168.1.16', 'connections': set(), 'identifiers': set(), 'manufacturer': 'Zgemma', 'model': 'H11.S', 'name': '192.168.1.16'} for 'enigma2' config entry: device info must include at least one of identifiers or connections_\r\n\r\nI don't have any additional configuration in YAML config. Could this be related to _null_ MAC address in response of api/about endpoint from Zgemma device?\r\nI also tried defining explicitly mac_address in YAML config but nothing's changed :(\r\n\r\nLooking forward to any hints :)\r\n\r\n### What version of Home Assistant Core has the issue?\r\n\r\n2024.10.4\r\n\r\n### What was the last working version of Home Assistant Core?\r\n\r\n_No response_\r\n\r\n### What type of installation are you running?\r\n\r\nHome Assistant OS\r\n\r\n### Integration causing the issue\r\n\r\nEnigma2 (OpenWebif)\r\n\r\n### Link to integration documentation on our website\r\n\r\nhttps://www.home-assistant.io/integrations/enigma2\r\n\r\n### Diagnostics information\r\n\r\n2024-11-02 01:18:49.597 DEBUG (MainThread) [openwebif.api] Got 200 from: http://192.168.1.16/api/about\r\n2024-11-02 01:18:49.612 DEBUG (MainThread) [openwebif.api] Got 200 from: http://192.168.1.16/api/statusinfo\r\n2024-11-02 01:18:49.626 DEBUG (MainThread) [openwebif.api] Got 200 from: http://192.168.1.16/api/bouquets\r\n2024-11-02 01:18:49.744 DEBUG (MainThread) [openwebif.api] Got 200 from: http://192.168.1.16/api/epgnow?bRef=1:7:1:0:0:0:0:0:0:0:FROM+BOUQUET+%22userbouquet.Nasze.tv%22+ORDER+BY+bouquet\r\n2024-11-02 01:18:49.758 DEBUG (MainThread) [homeassistant.components.enigma2] Finished fetching enigma2 data in 0.160 seconds (success: True)\r\n2024-11-02 01:18:49.760 ERROR (MainThread) [homeassistant.components.media_player] enigma2: Not adding entity with invalid device info: Invalid device info {'configuration_url': 'http://192.168.1.16', 'connections': set(), 'identifiers': set(), 'manufacturer': 'Zgemma', 'model': 'H11.S', 'name': '192.168.1.16'} for 'enigma2' config entry: device info must include at least one of identifiers or connections\r\n\r\n### Example YAML snippet\r\n\r\n_No response_\r\n\r\n### Anything in the logs that might be useful for us?\r\n\r\n_No response_\r\n\r\n### Additional information\r\n\r\n_No response_\n", "hints_text": "\nHey there @autinerd, mind taking a look at this issue as it has been labeled with an integration (`enigma2`) you are listed as a [code owner](https://github.com/home-assistant/core/blob/dev/CODEOWNERS#L416) for? Thanks!\n\n<details>\n<summary>Code owner commands</summary>\n\n\nCode owners of `enigma2` can trigger bot actions by commenting:\n\n- `@home-assistant close` Closes the issue.\n- `@home-assistant rename Awesome new title` Renames the issue.\n- `@home-assistant reopen` Reopen the issue.\n- `@home-assistant unassign enigma2` Removes the current integration label and assignees on the issue, add the integration domain after the command.\n- `@home-assistant add-label needs-more-information` Add a label (needs-more-information, problem in dependency, problem in custom component) to the issue.\n- `@home-assistant remove-label needs-more-information` Remove a label (needs-more-information, problem in dependency, problem in custom component) on the issue.\n\n</details>\n\n\n<sub><sup>(message by CodeOwnersMention)</sup></sub>\n\n---\n\n[enigma2 documentation](https://www.home-assistant.io/integrations/enigma2)\n[enigma2 source](https://github.com/home-assistant/core/tree/dev/homeassistant/components/enigma2)\n<sub><sup>(message by IssueLinks)</sup></sub>\nHi, if you don't mind I would like to check what the cause of the problem is, that there is apparently no MAC address.\r\n\r\nCould you connect via SSH or telnet to your device, run `python` and run this code?\r\n\r\n```python\r\nimport netifaces as ni\r\nfrom os import listdir\r\nifaces = listdir(\"/sys/class/net\")\r\nprint(f\"interfaces: {ifaces}\")\r\nfor iface in ifaces:\r\n    addresses = ni.ifaddresses(iface)\r\n    if ni.AF_LINK in addresses:\r\n        print(f\"{iface}: {addresses[ni.AF_LINK]}\")\r\n```\r\n\r\nThis lists the interfaces and the MAC addresses using the same ways how Enigma2 gets the information.\r\n\r\nCan you see something like this printed:\r\n\r\n```\r\ninterfaces: ['eth0', 'lo']\r\n```\r\n\r\n```\r\neth0: [{'addr': '90:98:64:xx:xx:xx', 'broadcast': 'ff:ff:ff:ff:ff:ff'}]\r\nlo: [{'addr': '00:00:00:00:00:00', 'peer': '00:00:00:00:00:00'}]\r\n```\nHi @autinerd, thank you for your answer. Here is what was printed after executing script on my Zgemma:\r\n\r\n_interfaces: ['lo', 'eth0']\r\nlo: [{'addr': '00:00:00:00:00:00', 'peer': '00:00:00:00:00:00'}]\r\neth0: [{'addr': '00:17:9a:28:2d:00', 'broadcast': 'ff:ff:ff:ff:ff:ff'}]_\nHmm, interesting. I installed OpenATV 7.5 on my box (but I have a Gigablue) and everything works.\r\n\r\nDoes it show the MAC address in OpenWebIf? `http://<your box address>/#boxinfo` when you scroll all the way down\r\n\r\nAnd it says `\"mac\": null,` in the ifaces section of `http://<box address>/api/about`?\nNo, MAC address in _/#boxinfo_ is empty:\r\n<img width=\"804\" alt=\"obraz\" src=\"https://github.com/user-attachments/assets/bb16ed20-b1c9-48bb-a597-bdef979b4702\">\r\n\r\nAnd in /api/about response in info > ifaces > 0  > there is also `mac:\tnull`\nOkay, thanks. Can you give me the exact version of OpenATV and OpenWebIf? (OpenATV can be found on the same page, something like `openATV 7.5.20241101 (2024-10-31)` and OpenWebIf can be found on `/#about`, something like `Build: 2.2.0-git197+1e04a110+1e04a113b3-r0`\nYes, sure.\r\n`openATV 7.5.20241030 (2024-10-29)`\r\n\r\nWhen it comes to OpenWebif I don't see detailed version, just `2.2.0` (screenshot)\r\n![obraz](https://github.com/user-attachments/assets/f339e38d-7766-4b9d-a01b-1b9893775e06)\r\n\n@autinerd Alright, on mobile version of OpenWebif I found more detailed info :D\r\n\r\n2.2.0-git197+1e04a110+1e04a113b3-r0\n@autinerd I modified source code by hardcoded my MAC address to `about[\"info\"][\"ifaces\"][0][\"mac\"]`, uploaded code as custom component and I was able to load addon without any problems. So now I'm sure this issue is caused by null MAC in `/api/about` endpoint.\n@JakNo Please tell me where you entered the MAC ??\r\nthank you\n> @JakNo Please tell me where you entered the MAC ?? thank you\r\n\r\n@AdamWitek77 I added new line `about[\"info\"][\"ifaces\"][0][\"mac\"] = \"your_mac_address\"` under the line 70 here https://github.com/home-assistant/core/blob/dev/homeassistant/components/enigma2/coordinator.py#L70\n@JakNo I cannot find this file on my home assistant server. Can you tell me how to find it? I am a beginner user. The server is installed as a container on QNAP", "created_at": "2024-12-14T19:21:45Z"}
{"repo": "home-assistant/core", "pull_number": 133205, "instance_id": "home-assistant__core-133205", "issue_numbers": ["132993"], "base_commit": "980b8a91e62c449fab558318573fa756818875a6", "patch": "diff --git a/homeassistant/components/incomfort/manifest.json b/homeassistant/components/incomfort/manifest.json\nindex 40c93012eefcbc..f404f33b970a9d 100644\n--- a/homeassistant/components/incomfort/manifest.json\n+++ b/homeassistant/components/incomfort/manifest.json\n@@ -6,5 +6,5 @@\n   \"documentation\": \"https://www.home-assistant.io/integrations/incomfort\",\n   \"iot_class\": \"local_polling\",\n   \"loggers\": [\"incomfortclient\"],\n-  \"requirements\": [\"incomfort-client==0.6.3-1\"]\n+  \"requirements\": [\"incomfort-client==0.6.4\"]\n }\ndiff --git a/requirements_all.txt b/requirements_all.txt\nindex 0f24315caf15c1..d1eae1f2881b34 100644\n--- a/requirements_all.txt\n+++ b/requirements_all.txt\n@@ -1197,7 +1197,7 @@ ihcsdk==2.8.5\n imgw_pib==1.0.6\n \n # homeassistant.components.incomfort\n-incomfort-client==0.6.3-1\n+incomfort-client==0.6.4\n \n # homeassistant.components.influxdb\n influxdb-client==1.24.0\n", "test_patch": "diff --git a/requirements_test_all.txt b/requirements_test_all.txt\nindex d6e9685d8d7fdf..5650bcf4e3d401 100644\n--- a/requirements_test_all.txt\n+++ b/requirements_test_all.txt\n@@ -1011,7 +1011,7 @@ ifaddr==0.2.0\n imgw_pib==1.0.6\n \n # homeassistant.components.incomfort\n-incomfort-client==0.6.3-1\n+incomfort-client==0.6.4\n \n # homeassistant.components.influxdb\n influxdb-client==1.24.0\n", "problem_statement": "Changing temperature has no effect in Intergas InComfort/Intouch Lan2RF gateway\n### The problem\n\nWhen adjusting the target temperature through the climate entity, the change is not actually applied to the setpoint temperature of the thermostat and the climate entity immediately reverts to the previously set temperature. Changing the setpoint temperature through the gateway's web interface works like intended.\r\n\r\nA few things seem notable to me, but I'm not sure if they're actually signifcant:\r\n\r\n- I have only one heater but the gateway registers two heaters, namely one with the invalid 000W00000 serial number and one with the actual serial number. This persists after multiple factory resets and attempts to remove and re-add the heater.\r\n- Some of the URL's in the log contain `{self._heater._heater_idx}` as a literal string, which seems odd to me, but maybe that's substituted for the actual heater index later in the process.\r\n- The response on that last call in the log contains the invalid serial number and node number 110, as opposed to the earlier call in the log of which the response contains the correct serial number and node number 100.\r\n\r\nThe log is attached below (with serial numbers redacted).\n\n### What version of Home Assistant Core has the issue?\n\ncore-2024.5.5\n\n### What was the last working version of Home Assistant Core?\n\n_No response_\n\n### What type of installation are you running?\n\nHome Assistant Container\n\n### Integration causing the issue\n\nInComfort\n\n### Link to integration documentation on our website\n\nhttps://www.home-assistant.io/integrations/incomfort/\n\n### Diagnostics information\n\n_No response_\n\n### Example YAML snippet\n\n_No response_\n\n### Anything in the logs that might be useful for us?\n\n```txt\n2024-12-12 07:38:35.849 DEBUG (MainThread) [incomfortclient] Gateway(hostname=192.168.2.150) instantiated.\r\n2024-12-12 07:38:35.849 DEBUG (MainThread) [incomfortclient] _get(url=heaterlist.json, auth=REDACTED)\r\n2024-12-12 07:38:38.785 DEBUG (MainThread) [incomfortclient] _get(url=heaterlist.json): response = {'heaterlist': ['000W00000', '2XXXDXXX25', None, None, None, None, None, None]}\r\n2024-12-12 07:38:38.785 DEBUG (MainThread) [incomfortclient] Heater(serial_no=2XXXDXXX25) instantiated.\r\n2024-12-12 07:38:38.785 DEBUG (MainThread) [incomfortclient] Gateway(192.168.2.150).heaters() = ['000W00000', '2XXXDXXX25', None, None, None, None, None, None]\r\n2024-12-12 07:38:38.785 DEBUG (MainThread) [incomfortclient] _get(url=data.json?heater=1, auth=REDACTED)\r\n2024-12-12 07:38:39.396 DEBUG (MainThread) [incomfortclient] _get(url=data.json?heater=1): response = {'nodenr': 100, 'ch_temp_lsb': 204, 'ch_temp_msb': 18, 'tap_temp_lsb': 9, 'tap_temp_msb': 11, 'ch_pressure_lsb': 190, 'ch_pressure_msb': 0, 'room_temp_1_lsb': 112, 'room_temp_1_msb': 7, 'room_temp_set_1_lsb': 158, 'room_temp_set_1_msb': 7, 'room_temp_2_lsb': 255, 'room_temp_2_msb': 127, 'room_temp_set_2_lsb': 255, 'room_temp_set_2_msb': 127, 'displ_code': 0, 'IO': 10, ... , 'room_set_ovr_1_msb': 7, 'room_set_ovr_1_lsb': 158, 'room_set_ovr_2_msb': 0, 'room_set_ovr_2_lsb': 0, 'rf_message_rssi': 33, 'rfstatus_cntr': 0}\r\n2024-12-12 07:38:39.396 DEBUG (MainThread) [incomfortclient] Heater(2XXXDXXX25).status() = {'display_code': 0, 'display_text': 'opentherm', 'fault_code': None, 'is_burning': True, 'is_failed': False, 'is_pumping': True, 'is_tapping': False, 'heater_temp': 48.12, 'tap_temp': 28.25, 'pressure': 1.9, 'serial_no': '2XXXDXXX25', 'nodenr': 100, 'rf_message_rssi': 33, 'rfstatus_cntr': 0}\r\n2024-12-12 07:38:45.478 DEBUG (MainThread) [incomfortclient] Room(room_no=1) instantiated.\r\n2024-12-12 07:38:45.481 DEBUG (MainThread) [incomfortclient] Room(1).status() = {'room_temp': 19.04, 'setpoint': 19.5, 'override': 19.5}\r\n2024-12-12 07:39:45.240 DEBUG (MainThread) [incomfortclient] _get(url=data.json?heater=1, auth=REDACTED)\r\n2024-12-12 07:39:45.373 DEBUG (MainThread) [incomfortclient] _get(url=data.json?heater=1): response = {'nodenr': 100, 'ch_temp_lsb': 240, 'ch_temp_msb': 18, 'tap_temp_lsb': 57, 'tap_temp_msb': 11, 'ch_pressure_lsb': 191, 'ch_pressure_msb': 0, 'room_temp_1_lsb': 112, 'room_temp_1_msb': 7, 'room_temp_set_1_lsb': 158, 'room_temp_set_1_msb': 7, 'room_temp_2_lsb': 255, 'room_temp_2_msb': 127, 'room_temp_set_2_lsb': 255, 'room_temp_set_2_msb': 127, 'displ_code': 0, 'IO': 10, ... , 'room_set_ovr_1_msb': 7, 'room_set_ovr_1_lsb': 158, 'room_set_ovr_2_msb': 0, 'room_set_ovr_2_lsb': 0, 'rf_message_rssi': 34, 'rfstatus_cntr': 0}\r\n2024-12-12 07:39:45.374 DEBUG (MainThread) [incomfortclient] Heater(2XXXDXXX25).status() = {'display_code': 0, 'display_text': 'opentherm', 'fault_code': None, 'is_burning': True, 'is_failed': False, 'is_pumping': True, 'is_tapping': False, 'heater_temp': 48.48, 'tap_temp': 28.73, 'pressure': 1.91, 'serial_no': '2XXXDXXX25', 'nodenr': 100, 'rf_message_rssi': 34, 'rfstatus_cntr': 0}\r\n2024-12-12 07:39:45.379 DEBUG (MainThread) [incomfortclient] Room(1).status() = {'room_temp': 19.04, 'setpoint': 19.5, 'override': 19.5}\r\n2024-12-12 07:40:21.756 DEBUG (MainThread) [incomfortclient] Room(1).set_override(setpoint=17.5)\r\n2024-12-12 07:40:21.756 DEBUG (MainThread) [incomfortclient] _get(url=data.json?heater={self._heater._heater_idx}&thermostat=0&setpoint=125, auth=REDACTED)\r\n2024-12-12 07:40:21.988 DEBUG (MainThread) [incomfortclient] _get(url=data.json?heater={self._heater._heater_idx}&thermostat=0&setpoint=125): response = {'nodenr': 110, 'ch_temp_lsb': 0, 'ch_temp_msb': 0, 'tap_temp_lsb': 0, 'tap_temp_msb': 0, 'ch_pressure_lsb': 0, 'ch_pressure_msb': 0, 'room_temp_1_lsb': 0, 'room_temp_1_msb': 0, 'room_temp_set_1_lsb': 0, 'room_temp_set_1_msb': 0, 'room_temp_2_lsb': 0, 'room_temp_2_msb': 0, 'room_temp_set_2_lsb': 0, 'room_temp_set_2_msb': 0, 'displ_code': 0, 'IO': 0, 'serial_year': 0, 'serial_month': 0, 'serial_line': 0, 'serial_sn1': 0, 'serial_sn2': 0, 'serial_sn3': 0, 'room_set_ovr_1_msb': 0, 'room_set_ovr_1_lsb': 0, 'room_set_ovr_2_msb': 0, 'room_set_ovr_2_lsb': 0, 'rf_message_rssi': 0, 'rfstatus_cntr': 255}\n```\n\n\n### Additional information\n\n_No response_\n", "hints_text": "\nHey there @jbouwh, mind taking a look at this issue as it has been labeled with an integration (`incomfort`) you are listed as a [code owner](https://github.com/home-assistant/core/blob/dev/CODEOWNERS#L699) for? Thanks!\n\n<details>\n<summary>Code owner commands</summary>\n\n\nCode owners of `incomfort` can trigger bot actions by commenting:\n\n- `@home-assistant close` Closes the issue.\n- `@home-assistant rename Awesome new title` Renames the issue.\n- `@home-assistant reopen` Reopen the issue.\n- `@home-assistant unassign incomfort` Removes the current integration label and assignees on the issue, add the integration domain after the command.\n- `@home-assistant add-label needs-more-information` Add a label (needs-more-information, problem in dependency, problem in custom component) to the issue.\n- `@home-assistant remove-label needs-more-information` Remove a label (needs-more-information, problem in dependency, problem in custom component) on the issue.\n\n</details>\n\n\n<sub><sup>(message by CodeOwnersMention)</sup></sub>\n\n---\n\n[incomfort documentation](https://www.home-assistant.io/integrations/incomfort)\n[incomfort source](https://github.com/home-assistant/core/tree/dev/homeassistant/components/incomfort)\n<sub><sup>(message by IssueLinks)</sup></sub>\nHeater list in the gateway web interface:\r\n![image](https://github.com/user-attachments/assets/917f8427-3d0d-4003-a8a0-2d0e3b9ad6cd)\r\n\r\nInvalid heater 0:\r\n![image](https://github.com/user-attachments/assets/a9d36f63-c8d0-4b33-a8dc-da39f9ab9ff4)\r\n\r\nCorrect heater 1:\r\n![image](https://github.com/user-attachments/assets/5e1f9942-158c-4db6-917d-f0304013c094)\r\n\r\n\nThis is what I see:\r\n![afbeelding](https://github.com/user-attachments/assets/916af83c-4286-41c0-ac34-fdd33f39f7cf)\r\n\r\nSo in my gateway the first entry holds the heater and thermostat.\r\n\r\nWhen I change temperature, the thermostat is lighting up with the new temperature.\r\n\r\nDId this integration work before? Did you try to restart your RF gateway?\nYes, I see. It's the other way around for me.\r\n\r\nBoth the issue and the order of the heaters persists after rebooting the gateway, after a factory reset and after removing/re-adding the heater via the app.\r\nThe heater, gateway and thermostat are all new, the issue was there from the beginning.\r\n\r\nI can change the temperature through the gateway web interface successfully, just not through the integration.\r\n\r\nDoes it seem odd to you as well that the log shows the `data.json?heater={self._heater._heater_idx}&thermostat=0&setpoint=125` call has a response containing the node number of the invalid heater instead of the correct one?\nhttps://github.com/jbouwh/incomfort-client/blob/f5d0cc929df006ca034169788621fc0a0893212f/incomfortclient/__init__.py#L382-L396\r\n\r\nThe `room_no` is used to calculate the thermostat_id. I have to look what is happening when I update my setpoint.\nI think there is a missing f-string marker. That will probably default the heater to be `0`, but in your case that will not work.\r\nThis needs to be fix in the library.", "created_at": "2024-12-14T14:17:57Z"}
{"repo": "home-assistant/core", "pull_number": 133191, "instance_id": "home-assistant__core-133191", "issue_numbers": ["132321"], "base_commit": "165ca5140c408927cdeb14eeab44a20845dddffe", "patch": "diff --git a/homeassistant/components/lifx/manifest.json b/homeassistant/components/lifx/manifest.json\nindex c7d8a27a1c7134..2e16eb2082b672 100644\n--- a/homeassistant/components/lifx/manifest.json\n+++ b/homeassistant/components/lifx/manifest.json\n@@ -23,6 +23,7 @@\n       \"LIFX Ceiling\",\n       \"LIFX Clean\",\n       \"LIFX Color\",\n+      \"LIFX Colour\",\n       \"LIFX DLCOL\",\n       \"LIFX Dlight\",\n       \"LIFX DLWW\",\n@@ -35,12 +36,14 @@\n       \"LIFX Neon\",\n       \"LIFX Nightvision\",\n       \"LIFX PAR38\",\n+      \"LIFX Permanent Outdoor\",\n       \"LIFX Pls\",\n       \"LIFX Plus\",\n       \"LIFX Round\",\n       \"LIFX Square\",\n       \"LIFX String\",\n       \"LIFX Tile\",\n+      \"LIFX Tube\",\n       \"LIFX White\",\n       \"LIFX Z\"\n     ]\n@@ -48,7 +51,7 @@\n   \"iot_class\": \"local_polling\",\n   \"loggers\": [\"aiolifx\", \"aiolifx_effects\", \"bitstring\"],\n   \"requirements\": [\n-    \"aiolifx==1.1.1\",\n+    \"aiolifx==1.1.2\",\n     \"aiolifx-effects==0.3.2\",\n     \"aiolifx-themes==0.5.5\"\n   ]\ndiff --git a/homeassistant/generated/zeroconf.py b/homeassistant/generated/zeroconf.py\nindex e5b50841d11c75..2c914c2d240982 100644\n--- a/homeassistant/generated/zeroconf.py\n+++ b/homeassistant/generated/zeroconf.py\n@@ -92,6 +92,10 @@\n         \"always_discover\": True,\n         \"domain\": \"lifx\",\n     },\n+    \"LIFX Colour\": {\n+        \"always_discover\": True,\n+        \"domain\": \"lifx\",\n+    },\n     \"LIFX DLCOL\": {\n         \"always_discover\": True,\n         \"domain\": \"lifx\",\n@@ -140,6 +144,10 @@\n         \"always_discover\": True,\n         \"domain\": \"lifx\",\n     },\n+    \"LIFX Permanent Outdoor\": {\n+        \"always_discover\": True,\n+        \"domain\": \"lifx\",\n+    },\n     \"LIFX Pls\": {\n         \"always_discover\": True,\n         \"domain\": \"lifx\",\n@@ -164,6 +172,10 @@\n         \"always_discover\": True,\n         \"domain\": \"lifx\",\n     },\n+    \"LIFX Tube\": {\n+        \"always_discover\": True,\n+        \"domain\": \"lifx\",\n+    },\n     \"LIFX White\": {\n         \"always_discover\": True,\n         \"domain\": \"lifx\",\ndiff --git a/requirements_all.txt b/requirements_all.txt\nindex 1e271ff1d576a5..6ed977b2fdbe3a 100644\n--- a/requirements_all.txt\n+++ b/requirements_all.txt\n@@ -286,7 +286,7 @@ aiolifx-effects==0.3.2\n aiolifx-themes==0.5.5\n \n # homeassistant.components.lifx\n-aiolifx==1.1.1\n+aiolifx==1.1.2\n \n # homeassistant.components.lookin\n aiolookin==1.0.0\n", "test_patch": "diff --git a/requirements_test_all.txt b/requirements_test_all.txt\nindex 95d610361d9df8..6a8dd4304a0f70 100644\n--- a/requirements_test_all.txt\n+++ b/requirements_test_all.txt\n@@ -268,7 +268,7 @@ aiolifx-effects==0.3.2\n aiolifx-themes==0.5.5\n \n # homeassistant.components.lifx\n-aiolifx==1.1.1\n+aiolifx==1.1.2\n \n # homeassistant.components.lookin\n aiolookin==1.0.0\n", "problem_statement": "LIFX Outdoor Permanent Lights\n> I recently purchased the LIFX Outdoor Permanent Lights (SKU: LFXSL50-30/LED) from Home Depot and added them to Home Assistant a few days ago. However, I'm encountering an issue where only the power and color setting functions work, while effects and themes do not.\r\n> \r\n> For instance, the following code in the developer tools doesn't produce any results:\r\n> \r\n> service: lifx.effect_morph\r\n> target:\r\n>   entity_id: light.front_yard_upper_peak\r\n> data:\r\n>   speed: 3\r\n>   power_on: true\r\n>   theme: holly\r\n> \r\n> I've also tried selecting effects from the UI, but they still don't work. Power on/off and color setting functions are working fine.\r\n> \r\n> Additionally, the logs don't show any errors. It would be great if these features could be fixed or maybe I'm doing something wrong... :) Let me know how I can help, I'm not a coder, but happy to capture any info/test in order to resolve this.\r\n> \r\n> \r\n\r\n_Originally posted by @xspyboyx in https://github.com/home-assistant/core/issues/129626#issuecomment-2510309919_\r\n            \n", "hints_text": "Split into a new issue.\n[lifx documentation](https://www.home-assistant.io/integrations/lifx)\n[lifx source](https://github.com/home-assistant/core/tree/dev/homeassistant/components/lifx)\nGreat thank you! I can't wait to test this. I appreciate all your work!", "created_at": "2024-12-14T08:04:01Z"}
{"repo": "home-assistant/core", "pull_number": 133183, "instance_id": "home-assistant__core-133183", "issue_numbers": ["131418"], "base_commit": "165ca5140c408927cdeb14eeab44a20845dddffe", "patch": "diff --git a/homeassistant/components/starlink/manifest.json b/homeassistant/components/starlink/manifest.json\nindex 070cbf1b44c22d..15bad3ebc2e920 100644\n--- a/homeassistant/components/starlink/manifest.json\n+++ b/homeassistant/components/starlink/manifest.json\n@@ -5,5 +5,5 @@\n   \"config_flow\": true,\n   \"documentation\": \"https://www.home-assistant.io/integrations/starlink\",\n   \"iot_class\": \"local_polling\",\n-  \"requirements\": [\"starlink-grpc-core==1.2.0\"]\n+  \"requirements\": [\"starlink-grpc-core==1.2.2\"]\n }\ndiff --git a/requirements_all.txt b/requirements_all.txt\nindex 1e271ff1d576a5..e8e86b5eeabf47 100644\n--- a/requirements_all.txt\n+++ b/requirements_all.txt\n@@ -2745,7 +2745,7 @@ starline==0.1.5\n starlingbank==3.2\n \n # homeassistant.components.starlink\n-starlink-grpc-core==1.2.0\n+starlink-grpc-core==1.2.2\n \n # homeassistant.components.statsd\n statsd==3.2.1\n", "test_patch": "diff --git a/requirements_test_all.txt b/requirements_test_all.txt\nindex 95d610361d9df8..1c673d27c622ff 100644\n--- a/requirements_test_all.txt\n+++ b/requirements_test_all.txt\n@@ -2200,7 +2200,7 @@ srpenergy==1.3.6\n starline==0.1.5\n \n # homeassistant.components.starlink\n-starlink-grpc-core==1.2.0\n+starlink-grpc-core==1.2.2\n \n # homeassistant.components.statsd\n statsd==3.2.1\n", "problem_statement": "Starlink ping is always zero\n### The problem\n\nThe ping (latency) sensor for Starlink always reports zero. I would expect it to show the ping statistics, matching the official app.\r\n\r\nWorth noting this also appeared to happen with the old HACS version (I changed to the new one because I thought it might fix it).\n\n### What version of Home Assistant Core has the issue?\n\ncore-2024.11.3\n\n### What was the last working version of Home Assistant Core?\n\n_No response_\n\n### What type of installation are you running?\n\nHome Assistant OS\n\n### Integration causing the issue\n\nStarlink\n\n### Link to integration documentation on our website\n\nhttps://www.home-assistant.io/integrations/starlink\n\n### Diagnostics information\n\n[config_entry-starlink-01JDDEAVSNCYSFE6J1JQRS9DB4.json](https://github.com/user-attachments/files/17882691/config_entry-starlink-01JDDEAVSNCYSFE6J1JQRS9DB4.json)\r\n\n\n### Example YAML snippet\n\n```yaml\nN/A\n```\n\n\n### Anything in the logs that might be useful for us?\n\n```txt\nNone, unfortunately.\n```\n\n\n### Additional information\n\nIf it's relevant, this is an original (circular) gen 1 dish, not using the in-box router.\n", "hints_text": "\nHey there @boswelja, mind taking a look at this issue as it has been labeled with an integration (`starlink`) you are listed as a [code owner](https://github.com/home-assistant/core/blob/dev/CODEOWNERS#L1412) for? Thanks!\n\n<details>\n<summary>Code owner commands</summary>\n\n\nCode owners of `starlink` can trigger bot actions by commenting:\n\n- `@home-assistant close` Closes the issue.\n- `@home-assistant rename Awesome new title` Renames the issue.\n- `@home-assistant reopen` Reopen the issue.\n- `@home-assistant unassign starlink` Removes the current integration label and assignees on the issue, add the integration domain after the command.\n- `@home-assistant add-label needs-more-information` Add a label (needs-more-information, problem in dependency, problem in custom component) to the issue.\n- `@home-assistant remove-label needs-more-information` Remove a label (needs-more-information, problem in dependency, problem in custom component) on the issue.\n\n</details>\n\n\n<sub><sup>(message by CodeOwnersMention)</sup></sub>\n\n---\n\n[starlink documentation](https://www.home-assistant.io/integrations/starlink)\n[starlink source](https://github.com/home-assistant/core/tree/dev/homeassistant/components/starlink)\n<sub><sup>(message by IssueLinks)</sup></sub>\nIt looks like your Starlink is reporting 0.0 for ping when the integration is querying it - I'm not sure there's much we can do about that, especially since Starlink doesn't actually have a public API.\r\nIt's also possible the field name changed recently and the underlying library is missing it for some reason, in which case checking it outside of Home Assistant and reporting details at https://github.com/sparky8512/starlink-grpc-tools might help\nThis happened to me also after a recent Starlink update. Ping is always 0ms.\r\n\r\nI notified the latest ping value in the official Starlink App is also missing, so looks like this is an issue on the Starlink side.\r\n\r\nI\u2019ve opened an issue on starlink-grpc-tools also.\n\n[https://github.com/sparky8512/starlink-grpc-tools/issues/100](https://github.com/sparky8512/starlink-grpc-tools/issues/100)\r\n\r\nStarlink version 2024.11.13.mr45845.2\r\nHA Core 2024.11.2\nLooks like a new release is out for starlink-grpc-tools that fixes this: https://github.com/sparky8512/starlink-grpc-tools/releases/tag/v1.2.1\nAny chance of getting this in a point release soon? starlink-grpc-tools has been updated, but I'm not sure what needs to happen next in order to get this into Home Assistant. \r\nHappy to help with testing if needed.\nJust a version bump in the starlink manifest.json and rerunning hassfest is the bare minimum for a PR. It should be tested too, but I don't have access to hardware", "created_at": "2024-12-14T02:34:15Z"}
{"repo": "home-assistant/core", "pull_number": 133159, "instance_id": "home-assistant__core-133159", "issue_numbers": ["132469"], "base_commit": "a812b594aac3f274b9ba660b7d778e62d8b9d389", "patch": "diff --git a/homeassistant/components/python_script/__init__.py b/homeassistant/components/python_script/__init__.py\nindex 70e9c5b0d29a78..af7732780293d9 100644\n--- a/homeassistant/components/python_script/__init__.py\n+++ b/homeassistant/components/python_script/__init__.py\n@@ -1,5 +1,6 @@\n \"\"\"Component to allow running Python scripts.\"\"\"\n \n+from collections.abc import Mapping, Sequence\n import datetime\n import glob\n import logging\n@@ -7,6 +8,7 @@\n import operator\n import os\n import time\n+import types\n from typing import Any\n \n from RestrictedPython import (\n@@ -167,6 +169,20 @@ def python_script_service_handler(call: ServiceCall) -> ServiceResponse:\n }\n \n \n+def guarded_import(\n+    name: str,\n+    globals: Mapping[str, object] | None = None,\n+    locals: Mapping[str, object] | None = None,\n+    fromlist: Sequence[str] = (),\n+    level: int = 0,\n+) -> types.ModuleType:\n+    \"\"\"Guard imports.\"\"\"\n+    # Allow import of _strptime needed by datetime.datetime.strptime\n+    if name == \"_strptime\":\n+        return __import__(name, globals, locals, fromlist, level)\n+    raise ScriptError(f\"Not allowed to import {name}\")\n+\n+\n def guarded_inplacevar(op: str, target: Any, operand: Any) -> Any:\n     \"\"\"Implement augmented-assign (+=, -=, etc.) operators for restricted code.\n \n@@ -232,6 +248,7 @@ def protected_getattr(obj, name, default=None):\n         return getattr(obj, name, default)\n \n     extra_builtins = {\n+        \"__import__\": guarded_import,\n         \"datetime\": datetime,\n         \"sorted\": sorted,\n         \"time\": TimeWrapper(),\n", "test_patch": "diff --git a/tests/components/python_script/test_init.py b/tests/components/python_script/test_init.py\nindex c4dc00c448aaee..2d151b4b81e6ac 100644\n--- a/tests/components/python_script/test_init.py\n+++ b/tests/components/python_script/test_init.py\n@@ -688,3 +688,27 @@ async def test_prohibited_augmented_assignment_operations(\n     hass.async_add_executor_job(execute, hass, \"aug_assign_prohibited.py\", case, {})\n     await hass.async_block_till_done(wait_background_tasks=True)\n     assert error in caplog.text\n+\n+\n+async def test_import_allow_strptime(\n+    hass: HomeAssistant, caplog: pytest.LogCaptureFixture\n+) -> None:\n+    \"\"\"Test calling datetime.datetime.strptime works.\"\"\"\n+    source = \"\"\"\n+test_date = datetime.datetime.strptime('2024-04-01', '%Y-%m-%d')\n+logger.info(f'Date {test_date}')\n+    \"\"\"\n+    hass.async_add_executor_job(execute, hass, \"test.py\", source, {})\n+    await hass.async_block_till_done(wait_background_tasks=True)\n+    assert \"Error executing script: Not allowed to import _strptime\" not in caplog.text\n+    assert \"Date 2024-04-01 00:00:00\" in caplog.text\n+\n+\n+async def test_no_other_imports_allowed(\n+    hass: HomeAssistant, caplog: pytest.LogCaptureFixture\n+) -> None:\n+    \"\"\"Test imports are not allowed.\"\"\"\n+    source = \"import sys\"\n+    hass.async_add_executor_job(execute, hass, \"test.py\", source, {})\n+    await hass.async_block_till_done(wait_background_tasks=True)\n+    assert \"Error executing script: Not allowed to import sys\" in caplog.text\n", "problem_statement": "Python Scripts : strptime no longer works\n### The problem\r\n\r\nConverting string to datetime using strptime now produces error `Error executing script (KeyError): '__import__' when running the script.)`\r\nexample:\r\n`bookingdate = datetime.datetime.strptime(\"2024-04-01\", \"%Y-%m-%d\")`\r\n\r\n### What version of Home Assistant Core has the issue?\r\n\r\n2024.12.0\r\n2024.12.1\r\n2024.12.2\r\n\r\n### What was the last working version of Home Assistant Core?\r\n\r\n2024.11.x\r\n\r\n### What type of installation are you running?\r\n\r\nHome Assistant OS\r\n\r\n### Integration causing the issue\r\n\r\nPython Scripts\r\n\r\n### Link to integration documentation on our website\r\n\r\n_No response_\r\n\r\n### Diagnostics information\r\n\r\n_No response_\r\n\r\n### Example YAML snippet\r\n\r\n_No response_\r\n\r\n### Anything in the logs that might be useful for us?\r\n\r\n_No response_\r\n\r\n### Additional information\r\n\r\n_No response_\n", "hints_text": "I think you might need to import datetime first instead of using directly.\n[pyscript documentation](https://www.home-assistant.io/integrations/pyscript)\n[pyscript source](https://github.com/home-assistant/core/tree/dev/homeassistant/components/pyscript)\n> I think you might need to import datetime first instead of using directly.\r\n\r\nThank you for the response.\r\n\r\nIn 2024.11.x \r\n`datetime.datetime.strptime(\"2024-04-01\", \"%Y-%m-%d\")` worked correctly without import\r\n\r\nin 2024.12.0 if I try  \r\n`datetime.datetime.strptime(\"2024-04-01\", \"%Y-%m-%d\")` causes \" __import__'\" error\r\nJust adding `from datetime import datetime` causes \"__import__ not found\" error\r\nJust adding `import datetime` causes \"__import__ not found\" error\r\n\r\nWhat has changed and what am I missing?\n> I think you might need to import datetime first instead of using directly.\r\n\r\nAlso this issue with integration:Python Scripts not pyscript? \n[python_script documentation](https://www.home-assistant.io/integrations/python_script)\n[python_script source](https://github.com/home-assistant/core/tree/dev/homeassistant/components/python_script)\nNothing changed in the source code and it should work like you had it before so no idea right now actually. \nI would need to test myself to see where it goes wrong. \n> Nothing changed in the source code and it should work like you had it before so no idea right now actually. I would need to test myself to see where it goes wrong.\r\n\r\nFurther thoughts:-\r\n`today = datetime.datetime.now() `works ok so the datetime module is accessiable but not the strptime function.\nOn the off chance anybody else might be experiencing an issue with strptime I have found that:-\r\n`dt_util.parse_datetime(\"2024-05-01\")`  and\r\n`datetime.datetime.fromisoformat(\"2024-05-01\")`  both seem to work as long as your date is in the YY-mm-dd format. Not all my dates are however.\nIn case it helps anyone: I ran into a very similar issue with `datetime.datetime.strptime('14:00:00', '%H:%M:%S').time()` in my python script under 2024.12. Since I was using it only to get a time object, I was able to replace it with calling `datetime.time(14, 0, 0)` directly.\r\n\r\nThis issue helped me identify the problematic call and try alternatives, so thank you! (The specific error I was experiencing was `Error executing script (KeyError): '__import__'` when running the script.)\nI have also run to the same issue. I\u2019m using python_script heavily and several logics rely on strptime function. So I\u2019m looking forward to the resolution.\r\nI don\u2019t have the competance and time to fix but I would be happy to help by testing or any other way if needed.\nI have the same issue since 2024.12.\r\n\r\ncan not use datetime.datetime.strptime anymore. Thanks to @MisterRadish, I got a workaround working based on datetime.datetime.fromisoformat\nSo I gave this a test now on both `dev` and `2024.12.0` and I seem to have no issue at all.\r\nTest script:\r\n```python\r\nbookingdate = datetime.datetime.strptime(\"2024-04-01\", \"%Y-%m-%d\")\r\nlogger.info(f\"Date {bookingdate}\")\r\n```\r\n\r\nOutput:\r\n```\r\n2024-12-11 18:50:46.671 INFO (SyncWorker_5) [homeassistant.components.python_script] Executing testing.py: {}\r\n2024-12-11 18:50:46.672 INFO (SyncWorker_5) [homeassistant.components.python_script.testing.py] Date 2024-04-01 00:00:00\r\n2024-12-11 18:50:46.672 DEBUG (SyncWorker_5) [homeassistant.components.python_script] Output of python_script: `testing.py`:\r\n{}\r\n```\r\n\r\nOn dev we are still on py3.12 so I wonder if there is something that has changed here between the python versions that might have an impact.\n> On dev we are still on py3.12 so I wonder if there is something that has changed here between the python versions that might have an impact.\r\n\r\nYup -  the move to python 3.13 in 2024.12.0 could be the cause\nI can at least at this stage confirm that py3.13 is the cause of the issue", "created_at": "2024-12-13T16:06:56Z"}
{"repo": "home-assistant/core", "pull_number": 133125, "instance_id": "home-assistant__core-133125", "issue_numbers": ["132347"], "base_commit": "c0f6535d1105b7cbf00970ce0dade7cbcf597ab3", "patch": "diff --git a/homeassistant/components/nibe_heatpump/manifest.json b/homeassistant/components/nibe_heatpump/manifest.json\nindex 407cdfcfd57ee8..049ba905f04e70 100644\n--- a/homeassistant/components/nibe_heatpump/manifest.json\n+++ b/homeassistant/components/nibe_heatpump/manifest.json\n@@ -5,5 +5,5 @@\n   \"config_flow\": true,\n   \"documentation\": \"https://www.home-assistant.io/integrations/nibe_heatpump\",\n   \"iot_class\": \"local_polling\",\n-  \"requirements\": [\"nibe==2.13.0\"]\n+  \"requirements\": [\"nibe==2.14.0\"]\n }\ndiff --git a/requirements_all.txt b/requirements_all.txt\nindex 66dfa359577aef..3c2df95f57f238 100644\n--- a/requirements_all.txt\n+++ b/requirements_all.txt\n@@ -1462,7 +1462,7 @@ nextcord==2.6.0\n nextdns==4.0.0\n \n # homeassistant.components.nibe_heatpump\n-nibe==2.13.0\n+nibe==2.14.0\n \n # homeassistant.components.nice_go\n nice-go==0.3.10\n", "test_patch": "diff --git a/requirements_test_all.txt b/requirements_test_all.txt\nindex 5e0705b735848f..53be7b9893c850 100644\n--- a/requirements_test_all.txt\n+++ b/requirements_test_all.txt\n@@ -1225,7 +1225,7 @@ nextcord==2.6.0\n nextdns==4.0.0\n \n # homeassistant.components.nibe_heatpump\n-nibe==2.13.0\n+nibe==2.14.0\n \n # homeassistant.components.nice_go\n nice-go==0.3.10\n", "problem_statement": "Error when changing climate offset with Nibe integration since 2024.12\n### The problem\n\nI have the following automation:\r\n```\r\nalias: Adjust Heating Offset at 6 AM and 7 AM Based on Temperature\r\ntriggers:\r\n  - at: \"06:00:00\"\r\n    trigger: time\r\nactions:\r\n  - action: number.set_value\r\n    data:\r\n      value: \"0\"\r\n    target:\r\n      entity_id: number.heating_offset_climate_system_1_40031_2\r\n  - delay: \"01:00:00\"\r\n  - condition: numeric_state\r\n    entity_id: sensor.room_average_temp_clim_system_1_bt50_30117\r\n    below: 21.5\r\n  - target:\r\n      entity_id: number.heating_offset_climate_system_1_40031_2\r\n    data:\r\n      value: \"1\"\r\n    action: number.set_value\r\nmode: single\r\n```\r\n\r\nThis worked fine, but since the most recent upgrade of HA, I'm now getting this error:\r\n```\r\nError: Unable to avoid copy while creating an array as requested. If using `np.array(obj, copy=False)` replace it with `np.asarray(obj)` to allow a copy when needed (no behavior change in NumPy 1.x). For more details, see https://numpy.org/devdocs/numpy_2_0_migration_guide.html#adapting-to-changes-in-the-copy-keyword.\r\nResult:\r\nparams:\r\n  domain: number\r\n  service: set_value\r\n  service_data:\r\n    value: '0'\r\n    entity_id:\r\n      - number.heating_offset_climate_system_1_40031_2\r\n  target:\r\n    entity_id:\r\n      - number.heating_offset_climate_system_1_40031_2\r\nrunning_script: false\r\n```\r\nI tried recreating the failing step, but not giving me any improvements. When trying the same script with the MyUplink integration it works fine, but I'd rather not rely on a cloud service to perform this action. Any idea what might be going wrong here? This worked fine until I upgraded to 2024.12\n\n### What version of Home Assistant Core has the issue?\n\n2024.12\n\n### What was the last working version of Home Assistant Core?\n\n2024.11\n\n### What type of installation are you running?\n\nHome Assistant OS\n\n### Integration causing the issue\n\nnibe heatpump\n\n### Link to integration documentation on our website\n\nhttps://www.home-assistant.io/integrations/nibe_heatpump/\n\n### Diagnostics information\n\n_No response_\n\n### Example YAML snippet\n\n_No response_\n\n### Anything in the logs that might be useful for us?\n\n```txt\nLogger: homeassistant.helpers.script.websocket_api_script\r\nSource: helpers/script.py:526\r\nFirst occurred: 8:54:48 AM (2 occurrences)\r\nLast logged: 8:55:12 AM\r\n\r\nwebsocket_api script: Error executing script. Unexpected error for call_service at pos 1: Unable to avoid copy while creating an array as requested. If using `np.array(obj, copy=False)` replace it with `np.asarray(obj)` to allow a copy when needed (no behavior change in NumPy 1.x). For more details, see https://numpy.org/devdocs/numpy_2_0_migration_guide.html#adapting-to-changes-in-the-copy-keyword.\r\nTraceback (most recent call last):\r\n  File \"/usr/src/homeassistant/homeassistant/helpers/script.py\", line 526, in _async_step\r\n    await getattr(self, handler)()\r\n  File \"/usr/src/homeassistant/homeassistant/helpers/script.py\", line 764, in _async_call_service_step\r\n    response_data = await self._async_run_long_action(\r\n                    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n    ...<9 lines>...\r\n    )\r\n    ^\r\n  File \"/usr/src/homeassistant/homeassistant/helpers/script.py\", line 727, in _async_run_long_action\r\n    return await long_task\r\n           ^^^^^^^^^^^^^^^\r\n  File \"/usr/src/homeassistant/homeassistant/core.py\", line 2802, in async_call\r\n    response_data = await coro\r\n                    ^^^^^^^^^^\r\n  File \"/usr/src/homeassistant/homeassistant/core.py\", line 2845, in _execute_service\r\n    return await target(service_call)\r\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/src/homeassistant/homeassistant/helpers/service.py\", line 1007, in entity_service_call\r\n    single_response = await _handle_entity_call(\r\n                      ^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n        hass, entity, func, data, call.context\r\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n    )\r\n    ^\r\n  File \"/usr/src/homeassistant/homeassistant/helpers/service.py\", line 1079, in _handle_entity_call\r\n    result = await task\r\n             ^^^^^^^^^^\r\n  File \"/usr/src/homeassistant/homeassistant/components/number/__init__.py\", line 122, in async_set_value\r\n    await entity.async_set_native_value(native_value)\r\n  File \"/usr/src/homeassistant/homeassistant/components/nibe_heatpump/number.py\", line 77, in async_set_native_value\r\n    await self._async_write_coil(value)\r\n  File \"/usr/src/homeassistant/homeassistant/components/nibe_heatpump/entity.py\", line 44, in _async_write_coil\r\n    await self.coordinator.async_write_coil(self._coil, value)\r\n  File \"/usr/src/homeassistant/homeassistant/components/nibe_heatpump/coordinator.py\", line 132, in async_write_coil\r\n    await self.connection.write_coil(data)\r\n  File \"/usr/local/lib/python3.13/site-packages/tenacity/asyncio/__init__.py\", line 189, in async_wrapped\r\n    return await copy(fn, *args, **kwargs)\r\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/local/lib/python3.13/site-packages/tenacity/asyncio/__init__.py\", line 111, in __call__\r\n    do = await self.iter(retry_state=retry_state)\r\n         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/local/lib/python3.13/site-packages/tenacity/asyncio/__init__.py\", line 153, in iter\r\n    result = await action(retry_state)\r\n             ^^^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/local/lib/python3.13/site-packages/tenacity/_utils.py\", line 99, in inner\r\n    return call(*args, **kwargs)\r\n  File \"/usr/local/lib/python3.13/site-packages/tenacity/__init__.py\", line 398, in <lambda>\r\n    self._add_action_func(lambda rs: rs.outcome.result())\r\n                                     ~~~~~~~~~~~~~~~~~^^\r\n  File \"/usr/local/lib/python3.13/concurrent/futures/_base.py\", line 449, in result\r\n    return self.__get_result()\r\n           ~~~~~~~~~~~~~~~~~^^\r\n  File \"/usr/local/lib/python3.13/concurrent/futures/_base.py\", line 401, in __get_result\r\n    raise self._exception\r\n  File \"/usr/local/lib/python3.13/site-packages/tenacity/asyncio/__init__.py\", line 114, in __call__\r\n    result = await fn(*args, **kwargs)\r\n             ^^^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/local/lib/python3.13/site-packages/nibe/connection/modbus.py\", line 142, in write_coil\r\n    result = await self._client.write_registers(\r\n             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n    ...<3 lines>...\r\n    )\r\n    ^\r\n  File \"/usr/local/lib/python3.13/site-packages/async_modbus/core.py\", line 233, in write_registers\r\n    request = self.protocol.write_multiple_registers(\r\n        slave_id, starting_address, values\r\n    )\r\n  File \"/usr/local/lib/python3.13/site-packages/umodbus/client/tcp.py\", line 223, in write_multiple_registers\r\n    return _create_request_adu(slave_id, function.request_pdu)\r\n                                         ^^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/local/lib/python3.13/site-packages/async_modbus/umodbus_numpy.py\", line 130, in request_pdu_registers\r\n    return pack_16bits(self.function_code, self.starting_address, self._values)\r\n  File \"/usr/local/lib/python3.13/site-packages/async_modbus/umodbus_numpy.py\", line 46, in pack_16bits\r\n    values = numpy.array(values, dtype=dtype, copy=False)\r\nValueError: Unable to avoid copy while creating an array as requested.\r\nIf using `np.array(obj, copy=False)` replace it with `np.asarray(obj)` to allow a copy when needed (no behavior change in NumPy 1.x).\r\nFor more details, see https://numpy.org/devdocs/numpy_2_0_migration_guide.html#adapting-to-changes-in-the-copy-keyword.\n```\n\n\n### Additional information\n\n_No response_\n", "hints_text": "\nHey there @elupus, mind taking a look at this issue as it has been labeled with an integration (`nibe_heatpump`) you are listed as a [code owner](https://github.com/home-assistant/core/blob/dev/CODEOWNERS#L1001) for? Thanks!\n\n<details>\n<summary>Code owner commands</summary>\n\n\nCode owners of `nibe_heatpump` can trigger bot actions by commenting:\n\n- `@home-assistant close` Closes the issue.\n- `@home-assistant rename Awesome new title` Renames the issue.\n- `@home-assistant reopen` Reopen the issue.\n- `@home-assistant unassign nibe_heatpump` Removes the current integration label and assignees on the issue, add the integration domain after the command.\n- `@home-assistant add-label needs-more-information` Add a label (needs-more-information, problem in dependency, problem in custom component) to the issue.\n- `@home-assistant remove-label needs-more-information` Remove a label (needs-more-information, problem in dependency, problem in custom component) on the issue.\n\n</details>\n\n\n<sub><sup>(message by CodeOwnersMention)</sup></sub>\n\n---\n\n[nibe_heatpump documentation](https://www.home-assistant.io/integrations/nibe_heatpump)\n[nibe_heatpump source](https://github.com/home-assistant/core/tree/dev/homeassistant/components/nibe_heatpump)\n<sub><sup>(message by IssueLinks)</sup></sub>\nLooks like numpy upgrade casued issues with the nibe integration. Ouch\nI have the exact same Issue , when I try move the slider for climate offset i get :\r\n\"Failed to perform the action number/set_value. Unable to avoid copy while creating an array as requested. If using `np.array(obj, copy=False)` replace it with `np.asarray(obj)` to allow a copy when needed (no behavior change in NumPy 1.x). For more details, see https://numpy.org/devdocs/numpy_2_0_migration_guide.html#adapting-to-changes-in-the-copy-keyword.\"\nHave the same problem. Read from NIBE works, but write doesnt.\n+1, having the same issue after upgrade to Core 2024.12.0\nIts a upstream incompatibility in async_modbus. So needs to be solved there. I should think its an easy fix, but unsure how quickly it can be released even if somebody would provide a fix.\r\n\r\nIve reported the issue upstream. But if someone has the time to look at a fix, that would speed it along \nWhen I try and change any numerical value eg a slider I get the following message: \r\n\r\n![image](https://github.com/user-attachments/assets/0152737b-3290-424c-90ae-dbdee5524567)\r\n\r\nI assume that might be with the updated python in this latest release. I am on 2024.21.1\nThe same problem with every Nibe Integration switch\r\n<img width=\"491\" alt=\"image\" src=\"https://github.com/user-attachments/assets/160130c7-a9e8-40ed-9654-2034d9982df1\">\r\n\nSame issue here. \nsame here\nI have the same problem \ud83d\ude22\nEverybody using modbus will have same issue. No need in reporting me too here. Just add a +1 or thumbs up on the top issue instead. This just causes notification spam.\r\n\r\nIt wont be solved until somebody sits down and fixes the issue in the upstream library https://github.com/tiagocoutinho/async_modbus/issues/15 or replaces that library with something else in the nibe library. At the moment i dont have the time to look at it.\nsould be fixed: https://github.com/tiagocoutinho/async_modbus/issues/15\n> sould be fixed: [tiagocoutinho/async_modbus#15](https://github.com/tiagocoutinho/async_modbus/issues/15)\r\n\r\nNow we just need a new release of asymc_modbus, bump the dependency in nibe library and then bump dependency in HA\nI've asked the dev from async_modbus to release, and he released 0.2.2 which contains the fix. So that's the first step.\nSame issue here, updating to HA core 2024.12.2 did not fix it.\r\nWhen is this modbus fix integrated in a HA release?\nNo, it is not yet fixed. A couple of minutes ago the nibe package was also released. The next step is for elupus to update that dependency and that should be merged into HA. I think 2024.12.3 will contain the fix.\nAnybody can provide a pull request to bump the library.\nI'm not a HA developer just someone who uses HA as a user. I have no idea how to do a pull request etc. does that mean i have to build and deploy my own HA? No thank you , i wouldnt know where to start. It's complicated enough as it is without me rolling my own.\r\n", "created_at": "2024-12-13T10:36:24Z"}
{"repo": "home-assistant/core", "pull_number": 133085, "instance_id": "home-assistant__core-133085", "issue_numbers": ["133075"], "base_commit": "bf9788b9c4724b46a0289342d6122477df2d883e", "patch": "diff --git a/homeassistant/components/evohome/manifest.json b/homeassistant/components/evohome/manifest.json\nindex da3d197f6aa324..22edadad7f45fe 100644\n--- a/homeassistant/components/evohome/manifest.json\n+++ b/homeassistant/components/evohome/manifest.json\n@@ -6,5 +6,5 @@\n   \"iot_class\": \"cloud_polling\",\n   \"loggers\": [\"evohomeasync\", \"evohomeasync2\"],\n   \"quality_scale\": \"legacy\",\n-  \"requirements\": [\"evohome-async==0.4.20\"]\n+  \"requirements\": [\"evohome-async==0.4.21\"]\n }\ndiff --git a/requirements_all.txt b/requirements_all.txt\nindex 8f4705e878e980..ba3a0cfd5b99d5 100644\n--- a/requirements_all.txt\n+++ b/requirements_all.txt\n@@ -879,7 +879,7 @@ eufylife-ble-client==0.1.8\n # evdev==1.6.1\n \n # homeassistant.components.evohome\n-evohome-async==0.4.20\n+evohome-async==0.4.21\n \n # homeassistant.components.bryant_evolution\n evolutionhttp==0.0.18\n", "test_patch": "diff --git a/requirements_test_all.txt b/requirements_test_all.txt\nindex 3a88a5a2d413ed..e9695743f32d10 100644\n--- a/requirements_test_all.txt\n+++ b/requirements_test_all.txt\n@@ -745,7 +745,7 @@ eternalegypt==0.0.16\n eufylife-ble-client==0.1.8\n \n # homeassistant.components.evohome\n-evohome-async==0.4.20\n+evohome-async==0.4.21\n \n # homeassistant.components.bryant_evolution\n evolutionhttp==0.0.18\n", "problem_statement": "EvoHome API URL Cert changed, needs update\n### The problem\r\n\r\nSince recently, it appears that Resideo (formerly Honeywell), has renewed their SSL Certificate only for the name \"tccna.resideo.com\", and now no longer secures \"tccna.honeywell.com\".\r\n\r\nThis results in errors authenticating the \"evohome\" integration to the configured URL \"https://tccna.honeywell.com\" in the code (in the files \"/usr/local/lib/python3.13/site-packages/evohomeasync/broker.py\" and \"/usr/local/lib/python3.13/site-packages/evohomeasync2/const.py\".\r\n\r\nChanging the URL_HOST from \"https://tccna.honeywell.com\" to \"https://tccna.resideo.com\" in these files on the HA container makes the integration work again, but only until the next update ofcourse ;)\r\n\r\nI think Resideo wants everyone to drop the Honeywell name, and only use the Resideo name, so the integration should reflect that.\r\n\r\n### What version of Home Assistant Core has the issue?\r\n\r\ncore-2024.12.2\r\n\r\n### What was the last working version of Home Assistant Core?\r\n\r\n_No response_\r\n\r\n### What type of installation are you running?\r\n\r\nHome Assistant Container\r\n\r\n### Integration causing the issue\r\n\r\nevohome\r\n\r\n### Link to integration documentation on our website\r\n\r\nhttps://www.home-assistant.io/integrations/evohome/\r\n\r\n### Diagnostics information\r\n\r\n_No response_\r\n\r\n### Example YAML snippet\r\n\r\n_No response_\r\n\r\n### Anything in the logs that might be useful for us?\r\n\r\n```\r\n2024-12-12 20:00:02.547 ERROR (MainThread) [homeassistant.components.evohome.helpers] Failed to authenticate with the vendor's server. Check your username and password. NB: Some special password characters that work correctly via the website will not work via the web API. Message is: Cannot connect to host tccna.honeywell.com:443 ssl:True [SSLCertVerificationError: (1, \"[SSL: CERTIFICATE_VERIFY_FAILED] certificate verify failed: Hostname mismatch, certificate is not valid for 'tccna.honeywell.com'. (_ssl.c:1020)\")]\r\n2024-12-12 20:00:02.550 ERROR (MainThread) [homeassistant.setup] Setup failed for 'evohome': Integration failed to initialize.\r\n```\r\n\r\n### Additional information\r\n\r\n```\r\n# nmap --script ssl-cert -p 443 tccna.honeywell.com\r\nStarting Nmap 7.94 ( https://nmap.org ) at 2024-12-12 20:54 CET\r\nNmap scan report for tccna.honeywell.com (20.62.73.190)\r\nHost is up (0.093s latency).\r\nrDNS record for 20.62.73.190: mytotalconnectcomfort.com\r\n\r\nPORT    STATE SERVICE\r\n443/tcp open  https\r\n| ssl-cert: Subject: commonName=TCCNA.resideo.com/organizationName=Resideo Technologies, Inc./stateOrProvinceName=Arizona/countryName=US\r\n| Subject Alternative Name: DNS:TCCNA.resideo.com, DNS:TCCEU.resideo.com, DNS:TCCAP.resideo.com, DNS:TCCNAS.resideo.com, DNS:TCCEUS.resideo.com, DNS:TCCAPS.resideo.com\r\n| Issuer: commonName=DigiCert SHA2 High Assurance Server CA/organizationName=DigiCert Inc/countryName=US\r\n| Public Key type: rsa\r\n| Public Key bits: 2048\r\n| Signature Algorithm: sha256WithRSAEncryption\r\n| Not valid before: 2024-11-20T00:00:00\r\n| Not valid after:  2025-12-21T23:59:59\r\n| MD5:   55e8:dfa8:9930:9655:e915:9e8b:b14b:f89f\r\n|_SHA-1: eb9d:5c72:4253:8ed7:cfd0:92e7:4f9c:10fc:88c6:1852\r\n\r\nNmap done: 1 IP address (1 host up) scanned in 7.27 seconds\r\n```\n", "hints_text": "\nHey there @zxdavb, mind taking a look at this issue as it has been labeled with an integration (`evohome`) you are listed as a [code owner](https://github.com/home-assistant/core/blob/dev/CODEOWNERS#L448) for? Thanks!\n\n<details>\n<summary>Code owner commands</summary>\n\n\nCode owners of `evohome` can trigger bot actions by commenting:\n\n- `@home-assistant close` Closes the issue.\n- `@home-assistant rename Awesome new title` Renames the issue.\n- `@home-assistant reopen` Reopen the issue.\n- `@home-assistant unassign evohome` Removes the current integration label and assignees on the issue, add the integration domain after the command.\n- `@home-assistant add-label needs-more-information` Add a label (needs-more-information, problem in dependency, problem in custom component) to the issue.\n- `@home-assistant remove-label needs-more-information` Remove a label (needs-more-information, problem in dependency, problem in custom component) on the issue.\n\n</details>\n\n\n<sub><sup>(message by CodeOwnersMention)</sup></sub>\n\n---\n\n[evohome documentation](https://www.home-assistant.io/integrations/evohome)\n[evohome source](https://github.com/home-assistant/core/tree/dev/homeassistant/components/evohome)\n<sub><sup>(message by IssueLinks)</sup></sub>", "created_at": "2024-12-12T21:47:16Z"}
{"repo": "home-assistant/core", "pull_number": 133076, "instance_id": "home-assistant__core-133076", "issue_numbers": ["132805"], "base_commit": "bf9788b9c4724b46a0289342d6122477df2d883e", "patch": "diff --git a/homeassistant/components/suez_water/manifest.json b/homeassistant/components/suez_water/manifest.json\nindex 240be0f37bd20f..7e720a86afd9b7 100644\n--- a/homeassistant/components/suez_water/manifest.json\n+++ b/homeassistant/components/suez_water/manifest.json\n@@ -6,5 +6,5 @@\n   \"documentation\": \"https://www.home-assistant.io/integrations/suez_water\",\n   \"iot_class\": \"cloud_polling\",\n   \"loggers\": [\"pysuez\", \"regex\"],\n-  \"requirements\": [\"pysuezV2==1.3.2\"]\n+  \"requirements\": [\"pysuezV2==1.3.5\"]\n }\ndiff --git a/requirements_all.txt b/requirements_all.txt\nindex 8f4705e878e980..f19e88b074331f 100644\n--- a/requirements_all.txt\n+++ b/requirements_all.txt\n@@ -2301,7 +2301,7 @@ pysqueezebox==0.10.0\n pystiebeleltron==0.0.1.dev2\n \n # homeassistant.components.suez_water\n-pysuezV2==1.3.2\n+pysuezV2==1.3.5\n \n # homeassistant.components.switchbee\n pyswitchbee==1.8.3\n", "test_patch": "diff --git a/requirements_test_all.txt b/requirements_test_all.txt\nindex 3a88a5a2d413ed..9037cfd4d2bcff 100644\n--- a/requirements_test_all.txt\n+++ b/requirements_test_all.txt\n@@ -1864,7 +1864,7 @@ pyspeex-noise==1.0.2\n pysqueezebox==0.10.0\n \n # homeassistant.components.suez_water\n-pysuezV2==1.3.2\n+pysuezV2==1.3.5\n \n # homeassistant.components.switchbee\n pyswitchbee==1.8.3\n", "problem_statement": "Suez water isn't refreshed\n### The problem\n\nSuez water data is not refreshed each 12 hours.\r\nFirst time access (on integration reload) is OK.\r\n\n\n### What version of Home Assistant Core has the issue?\n\ncore-2024.12.1\n\n### What was the last working version of Home Assistant Core?\n\n_No response_\n\n### What type of installation are you running?\n\nHome Assistant Container\n\n### Integration causing the issue\n\nsuez_water\n\n### Link to integration documentation on our website\n\n_No response_\n\n### Diagnostics information\n\n_No response_\n\n### Example YAML snippet\n\n_No response_\n\n### Anything in the logs that might be useful for us?\n\n```txt\n2024-12-10 06:27:31.805 ERROR (MainThread) [homeassistant.core] Error requesting suez_water data: 200, message='Attempt to decode JSON with unexpected mimetype: text/html; charset=utf-8', url='https://eau-agglodebrive.toutsurmoneau.fr/mon-compte-en-ligne/je-me-connecte?targetUrl=/mon-compte-en-ligne/tableau-de-bord'\n```\n\n\n### Additional information\n\n_No response_\n", "hints_text": "\nHey there @ooii, @jb101010-2, mind taking a look at this issue as it has been labeled with an integration (`suez_water`) you are listed as a [code owner](https://github.com/home-assistant/core/blob/dev/CODEOWNERS#L1435) for? Thanks!\n\n<details>\n<summary>Code owner commands</summary>\n\n\nCode owners of `suez_water` can trigger bot actions by commenting:\n\n- `@home-assistant close` Closes the issue.\n- `@home-assistant rename Awesome new title` Renames the issue.\n- `@home-assistant reopen` Reopen the issue.\n- `@home-assistant unassign suez_water` Removes the current integration label and assignees on the issue, add the integration domain after the command.\n- `@home-assistant add-label needs-more-information` Add a label (needs-more-information, problem in dependency, problem in custom component) to the issue.\n- `@home-assistant remove-label needs-more-information` Remove a label (needs-more-information, problem in dependency, problem in custom component) on the issue.\n\n</details>\n\n\n<sub><sup>(message by CodeOwnersMention)</sup></sub>\n\n---\n\n[suez_water documentation](https://www.home-assistant.io/integrations/suez_water)\n[suez_water source](https://github.com/home-assistant/core/tree/dev/homeassistant/components/suez_water)\n<sub><sup>(message by IssueLinks)</sup></sub>\nHi,\r\nI'll try to have a look at it.\r\n\r\nIn the meantime can you add a bit more information:\r\n- when logging into your account is it working ? \r\n- can you access the consumption page ?\r\n- did it fail multiple times or just once ?\r\n\r\nThanks for the information\n> when logging into your account is it working ? \r\n\r\nyes\r\n\r\n> can you access the consumption page ?\r\n\r\nyes (https://eau-agglodebrive.toutsurmoneau.fr/mon-compte-en-ligne/historique-de-consommation-tr)\r\n\r\n> did it fail multiple times or just once ? \r\n\r\nI have enabled the integration 2 days ago. So I needed to reload integration 2 times.\r\nI was using HACS integration before with success. The old integration has been removed.\r\n\r\nThanks for your support !\r\n\nI try reproducing the issue, by making more frequent requests but it did not fail.\r\nCan you activate integration logs and post the result ? (you might want to redact meter id).\r\n\r\n> I have enabled the integration 2 days ago. So I needed to reload integration 2 times. I was using HACS integration before with success. The old integration has been removed.\r\n\r\nI did not know an HACS integration existed, I'll have to look if we can work together.\r\n\r\nCan you point me which integration you mention so I can check if something is done differently that might explain the error you're experiencing\r\n\r\n\nIntegration log has been enabled now. We need to wait minimum 12 hours :)\r\n\r\nHACS integration link : https://github.com/laurent-martin/hass_int_toutsurmoneau\r\n\n> Integration log has been enabled now. We need to wait minimum 12 hours :)\r\n\r\nOuch, I'll need to make it configurable to help in case like this \ud83d\ude04 \r\n\r\n> HACS integration link : https://github.com/laurent-martin/hass_int_toutsurmoneau\r\n\r\nThanks I'll have a look and try contacting the owner to see if he wants to work with me\r\n\r\n\nIn order to help debugging this issue:\r\nIs it possible for you to try calling the lib manually in a python environment ?\r\n\r\nIf possible execute the version available at [fix_update-error](https://github.com/jb101010-2/pySuez/tree/fix_update-error), I have added logging option, and the ability to set the url which seems to differ in your configuration\nOK, I was finally able to reproduce the error.\nNo need to run anything if you haven't.\n\nNot completely clear for now but it would seem that the session expire and suez redirect the request with an invalid status code.\n\nI'll keep investigating and I'll get back to you as soon as possible.\nThanks @jb101010-2 ! Let me know if I can (easily) test something !\nHi,\r\nI get the same error on 'Suez toutsurmoneau' (data are OK on the website side).\r\n![image](https://github.com/user-attachments/assets/c273f063-a270-4296-ac80-39abe97b51ed)\r\n", "created_at": "2024-12-12T19:50:13Z"}
{"repo": "home-assistant/core", "pull_number": 133064, "instance_id": "home-assistant__core-133064", "issue_numbers": ["110058"], "base_commit": "0726809228789d3b1846f080dd0e10dd747ca60c", "patch": "diff --git a/homeassistant/components/lametric/manifest.json b/homeassistant/components/lametric/manifest.json\nindex b930192caf0bdc..5a066d015f22ac 100644\n--- a/homeassistant/components/lametric/manifest.json\n+++ b/homeassistant/components/lametric/manifest.json\n@@ -13,7 +13,7 @@\n   \"integration_type\": \"device\",\n   \"iot_class\": \"local_polling\",\n   \"loggers\": [\"demetriek\"],\n-  \"requirements\": [\"demetriek==1.0.0\"],\n+  \"requirements\": [\"demetriek==1.1.0\"],\n   \"ssdp\": [\n     {\n       \"deviceType\": \"urn:schemas-upnp-org:device:LaMetric:1\"\ndiff --git a/homeassistant/components/lametric/number.py b/homeassistant/components/lametric/number.py\nindex cea9debb04bdc9..1025e04a4a8c16 100644\n--- a/homeassistant/components/lametric/number.py\n+++ b/homeassistant/components/lametric/number.py\n@@ -25,6 +25,7 @@ class LaMetricNumberEntityDescription(NumberEntityDescription):\n     \"\"\"Class describing LaMetric number entities.\"\"\"\n \n     value_fn: Callable[[Device], int | None]\n+    has_fn: Callable[[Device], bool] = lambda device: True\n     set_value_fn: Callable[[LaMetricDevice, float], Awaitable[Any]]\n \n \n@@ -49,7 +50,8 @@ class LaMetricNumberEntityDescription(NumberEntityDescription):\n         native_step=1,\n         native_min_value=0,\n         native_max_value=100,\n-        value_fn=lambda device: device.audio.volume,\n+        has_fn=lambda device: bool(device.audio),\n+        value_fn=lambda device: device.audio.volume if device.audio else 0,\n         set_value_fn=lambda api, volume: api.audio(volume=int(volume)),\n     ),\n ]\ndiff --git a/homeassistant/components/lametric/switch.py b/homeassistant/components/lametric/switch.py\nindex 9689bb7b802e79..3aabfaf17e12aa 100644\n--- a/homeassistant/components/lametric/switch.py\n+++ b/homeassistant/components/lametric/switch.py\n@@ -25,6 +25,7 @@ class LaMetricSwitchEntityDescription(SwitchEntityDescription):\n     \"\"\"Class describing LaMetric switch entities.\"\"\"\n \n     available_fn: Callable[[Device], bool] = lambda device: True\n+    has_fn: Callable[[Device], bool] = lambda device: True\n     is_on_fn: Callable[[Device], bool]\n     set_fn: Callable[[LaMetricDevice, bool], Awaitable[Any]]\n \n@@ -34,8 +35,11 @@ class LaMetricSwitchEntityDescription(SwitchEntityDescription):\n         key=\"bluetooth\",\n         translation_key=\"bluetooth\",\n         entity_category=EntityCategory.CONFIG,\n-        available_fn=lambda device: device.bluetooth.available,\n-        is_on_fn=lambda device: device.bluetooth.active,\n+        available_fn=lambda device: bool(\n+            device.bluetooth and device.bluetooth.available\n+        ),\n+        has_fn=lambda device: bool(device.bluetooth),\n+        is_on_fn=lambda device: bool(device.bluetooth and device.bluetooth.active),\n         set_fn=lambda api, active: api.bluetooth(active=active),\n     ),\n ]\n@@ -54,6 +58,7 @@ async def async_setup_entry(\n             description=description,\n         )\n         for description in SWITCHES\n+        if description.has_fn(coordinator.data)\n     )\n \n \ndiff --git a/requirements_all.txt b/requirements_all.txt\nindex ee253d174df613..030c7c8675650e 100644\n--- a/requirements_all.txt\n+++ b/requirements_all.txt\n@@ -747,7 +747,7 @@ defusedxml==0.7.1\n deluge-client==1.10.2\n \n # homeassistant.components.lametric\n-demetriek==1.0.0\n+demetriek==1.1.0\n \n # homeassistant.components.denonavr\n denonavr==1.0.1\n", "test_patch": "diff --git a/requirements_test_all.txt b/requirements_test_all.txt\nindex 65290d4b3085db..847cee8541ab78 100644\n--- a/requirements_test_all.txt\n+++ b/requirements_test_all.txt\n@@ -637,7 +637,7 @@ defusedxml==0.7.1\n deluge-client==1.10.2\n \n # homeassistant.components.lametric\n-demetriek==1.0.0\n+demetriek==1.1.0\n \n # homeassistant.components.denonavr\n denonavr==1.0.1\ndiff --git a/tests/components/lametric/snapshots/test_diagnostics.ambr b/tests/components/lametric/snapshots/test_diagnostics.ambr\nindex 15b35576ad49d9..7517cfe035e8d7 100644\n--- a/tests/components/lametric/snapshots/test_diagnostics.ambr\n+++ b/tests/components/lametric/snapshots/test_diagnostics.ambr\n@@ -26,6 +26,7 @@\n       'brightness_mode': 'auto',\n       'display_type': 'mixed',\n       'height': 8,\n+      'on': None,\n       'screensaver': dict({\n         'enabled': False,\n       }),\n", "problem_statement": "Lametric Integration Stopped Working with Sky\n### The problem\n\nLametric Sky, a product from Lametric, was working till sometime in the past few months.  It is API based like Lametric Time, which does work, but does not implement a few of the features that time does.  Notably, sound (which initially caused HA to not be able to work with Sky) and Bluetooth, and has only color screen without monochrome like Time.  \r\n\r\nAlready working integration with Sky stopped working.  It looks like the values not presented by Sky are required by the integration - not sure if this was a change to HA or a change to Sky.  I tried recreating API keys and removing and re-adding the device to HA.  After removing, I cannot add it back in at all, getting errors in the log.\r\n\r\nUsing manual method to add the Sky device - originally when it was added it was manual, as well.\n\n### What version of Home Assistant Core has the issue?\n\nCore-2024.1.6\n\n### What was the last working version of Home Assistant Core?\n\n_No response_\n\n### What type of installation are you running?\n\nHome Assistant OS\n\n### Integration causing the issue\n\nLametric\n\n### Link to integration documentation on our website\n\nhttps://www.home-assistant.io/integrations/lametric\n\n### Diagnostics information\n\n_No response_\n\n### Example YAML snippet\n\n_No response_\n\n### Anything in the logs that might be useful for us?\n\n```txt\nLogger: homeassistant.components.lametric\r\nSource: components/lametric/config_flow.py:142\r\nIntegration: LaMetric (documentation, issues)\r\nFirst occurred: 4:15:55 AM (2 occurrences)\r\nLast logged: 5:02:14 PM\r\n\r\nUnexpected error occurred\r\nTraceback (most recent call last):\r\n  File \"/usr/src/homeassistant/homeassistant/components/lametric/config_flow.py\", line 142, in async_step_manual_entry\r\n    return await self._async_step_create_entry(\r\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/src/homeassistant/homeassistant/components/lametric/config_flow.py\", line 243, in _async_step_create_entry\r\n    device = await lametric.device()\r\n             ^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/local/lib/python3.11/site-packages/demetriek/device.py\", line 123, in device\r\n    return Device.parse_obj(response)\r\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/local/lib/python3.11/site-packages/pydantic/main.py\", line 526, in parse_obj\r\n    return cls(**obj)\r\n           ^^^^^^^^^^\r\n  File \"/usr/local/lib/python3.11/site-packages/pydantic/main.py\", line 341, in __init__\r\n    raise validation_error\r\npydantic.error_wrappers.ValidationError: 7 validation errors for Device\r\naudio -> volume\r\n  field required (type=value_error.missing)\r\nbluetooth -> name\r\n  field required (type=value_error.missing)\r\nbluetooth -> active\r\n  field required (type=value_error.missing)\r\nbluetooth -> discoverable\r\n  field required (type=value_error.missing)\r\nbluetooth -> pairable\r\n  field required (type=value_error.missing)\r\nbluetooth -> address\r\n  field required (type=value_error.missing)\r\ndisplay -> type\r\n  value is not a valid enumeration member; permitted: 'color', 'grayscale', 'mixed', 'monochrome' (type=type_error.enum; enum_values=[<DisplayType.COLOR: 'color'>, <DisplayType.GRAYSCALE: 'grayscale'>, <DisplayType.MIXED: 'mixed'>, <DisplayType.MONOCHROME: 'monochrome'>])\n```\n\n\n### Additional information\n\nUnfortunately, I can\u2019t add the device in order to get further diagnostics info.  Happy to grab anything else needed.\n", "hints_text": "\nHey there @robbiet480, @frenck, @bachya, mind taking a look at this issue as it has been labeled with an integration (`lametric`) you are listed as a [code owner](https://github.com/home-assistant/core/blob/dev/CODEOWNERS#L708) for? Thanks!\n\n<details>\n<summary>Code owner commands</summary>\n\n\nCode owners of `lametric` can trigger bot actions by commenting:\n\n- `@home-assistant close` Closes the issue.\n- `@home-assistant rename Awesome new title` Renames the issue.\n- `@home-assistant reopen` Reopen the issue.\n- `@home-assistant unassign lametric` Removes the current integration label and assignees on the issue, add the integration domain after the command.\n- `@home-assistant add-label needs-more-information` Add a label (needs-more-information, problem in dependency, problem in custom component) to the issue.\n- `@home-assistant remove-label needs-more-information` Remove a label (needs-more-information, problem in dependency, problem in custom component) on the issue.\n\n</details>\n\n\n<sub><sup>(message by CodeOwnersMention)</sup></sub>\n\n---\n\n[lametric documentation](https://www.home-assistant.io/integrations/lametric)\n[lametric source](https://github.com/home-assistant/core/tree/dev/homeassistant/components/lametric)\n<sub><sup>(message by IssueLinks)</sup></sub>\nI have the same problem, the problem started with SKY firmware version v3.0.20.\nSame issue with v3.0.20\nStill the same issue with sky v3.1.0 and ha 2024.6.2\nLaMetric has provided an upstream PR to address this. I'll try to do my best to get it into Home Assistant 2024.7 (and order a Sky myself to test).\r\n\r\n../Frenck\nThanks @frenck for willing to do this. If i can help with testing or something, let me know.\nHappy to test too, as I have a Sky. \nHi @frenck,\n\nDo you got any update for us?\n\nThanks!\n@frenck \r\n\r\ncan you help us out please?\nAny update on the LaMetric PR?\r\nhttps://github.com/frenck/python-demetriek/pull/720\nThere hasn't been any activity on this issue recently. Due to the high number of incoming GitHub notifications, we have to clean some of the old issues, as many of them have already been resolved with the latest updates.\nPlease make sure to update to the latest Home Assistant version and check if that solves the issue. Let us know if that works for you by adding a comment \ud83d\udc4d\nThis issue has now been marked as stale and will be closed if no further activity occurs. Thank you for your contributions.\nNot resolved with lastest HA version", "created_at": "2024-12-12T16:50:05Z"}
{"repo": "home-assistant/core", "pull_number": 133016, "instance_id": "home-assistant__core-133016", "issue_numbers": ["133007"], "base_commit": "d49b1b2d6b23a5e1730076b1bb8787cc8734ea3a", "patch": "diff --git a/homeassistant/components/myuplink/number.py b/homeassistant/components/myuplink/number.py\nindex b05ab5d46c9697..3d336953396d9a 100644\n--- a/homeassistant/components/myuplink/number.py\n+++ b/homeassistant/components/myuplink/number.py\n@@ -110,13 +110,16 @@ def __init__(\n         # Internal properties\n         self.point_id = device_point.parameter_id\n         self._attr_name = device_point.parameter_name\n+        _scale = float(device_point.scale_value if device_point.scale_value else 1.0)\n         self._attr_native_min_value = (\n-            device_point.raw[\"minValue\"] if device_point.raw[\"minValue\"] else -30000\n-        ) * float(device_point.raw.get(\"scaleValue\", 1))\n+            device_point.min_value if device_point.min_value else -30000\n+        ) * _scale\n         self._attr_native_max_value = (\n-            device_point.raw[\"maxValue\"] if device_point.raw[\"maxValue\"] else 30000\n-        ) * float(device_point.raw.get(\"scaleValue\", 1))\n-        self._attr_step_value = device_point.raw.get(\"stepValue\", 20)\n+            device_point.max_value if device_point.max_value else 30000\n+        ) * _scale\n+        self._attr_native_step = (\n+            device_point.step_value if device_point.step_value else 1.0\n+        ) * _scale\n         if entity_description is not None:\n             self.entity_description = entity_description\n \n", "test_patch": "diff --git a/tests/components/myuplink/fixtures/device_points_nibe_f730.json b/tests/components/myuplink/fixtures/device_points_nibe_f730.json\nindex aaccdec530abae..0a61ab05f2132c 100644\n--- a/tests/components/myuplink/fixtures/device_points_nibe_f730.json\n+++ b/tests/components/myuplink/fixtures/device_points_nibe_f730.json\n@@ -1091,5 +1091,22 @@\n     \"enumValues\": [],\n     \"scaleValue\": \"1\",\n     \"zoneId\": null\n+  },\n+  {\n+    \"category\": \"F730 CU 3x400V\",\n+    \"parameterId\": \"47398\",\n+    \"parameterName\": \"Room sensor set point value heating climate system 1\",\n+    \"parameterUnit\": \"\u00b0C\",\n+    \"writable\": true,\n+    \"timestamp\": \"2024-12-11T13:23:12+00:00\",\n+    \"value\": 14.5,\n+    \"strVal\": \"14.5\u00b0C\",\n+    \"smartHomeCategories\": [],\n+    \"minValue\": 50.0,\n+    \"maxValue\": 350.0,\n+    \"stepValue\": 5.0,\n+    \"enumValues\": [],\n+    \"scaleValue\": \"0.1\",\n+    \"zoneId\": null\n   }\n ]\ndiff --git a/tests/components/myuplink/snapshots/test_diagnostics.ambr b/tests/components/myuplink/snapshots/test_diagnostics.ambr\nindex 71b33c58a87194..6fe6becff11b97 100644\n--- a/tests/components/myuplink/snapshots/test_diagnostics.ambr\n+++ b/tests/components/myuplink/snapshots/test_diagnostics.ambr\n@@ -1152,6 +1152,23 @@\n                     \"enumValues\": [],\n                     \"scaleValue\": \"1\",\n                     \"zoneId\": null\n+                  },\n+                  {\n+                    \"category\": \"F730 CU 3x400V\",\n+                    \"parameterId\": \"47398\",\n+                    \"parameterName\": \"Room sensor set point value heating climate system 1\",\n+                    \"parameterUnit\": \"\u00b0C\",\n+                    \"writable\": true,\n+                    \"timestamp\": \"2024-12-11T13:23:12+00:00\",\n+                    \"value\": 14.5,\n+                    \"strVal\": \"14.5\u00b0C\",\n+                    \"smartHomeCategories\": [],\n+                    \"minValue\": 50.0,\n+                    \"maxValue\": 350.0,\n+                    \"stepValue\": 5.0,\n+                    \"enumValues\": [],\n+                    \"scaleValue\": \"0.1\",\n+                    \"zoneId\": null\n                   }\n                 ]\n   \n@@ -2297,6 +2314,23 @@\n                     \"enumValues\": [],\n                     \"scaleValue\": \"1\",\n                     \"zoneId\": null\n+                  },\n+                  {\n+                    \"category\": \"F730 CU 3x400V\",\n+                    \"parameterId\": \"47398\",\n+                    \"parameterName\": \"Room sensor set point value heating climate system 1\",\n+                    \"parameterUnit\": \"\u00b0C\",\n+                    \"writable\": true,\n+                    \"timestamp\": \"2024-12-11T13:23:12+00:00\",\n+                    \"value\": 14.5,\n+                    \"strVal\": \"14.5\u00b0C\",\n+                    \"smartHomeCategories\": [],\n+                    \"minValue\": 50.0,\n+                    \"maxValue\": 350.0,\n+                    \"stepValue\": 5.0,\n+                    \"enumValues\": [],\n+                    \"scaleValue\": \"0.1\",\n+                    \"zoneId\": null\n                   }\n                 ]\n   \ndiff --git a/tests/components/myuplink/snapshots/test_number.ambr b/tests/components/myuplink/snapshots/test_number.ambr\nindex db1a8e0949faee..c47d3c60295692 100644\n--- a/tests/components/myuplink/snapshots/test_number.ambr\n+++ b/tests/components/myuplink/snapshots/test_number.ambr\n@@ -8,7 +8,7 @@\n       'max': 3000.0,\n       'min': -3000.0,\n       'mode': <NumberMode.AUTO: 'auto'>,\n-      'step': 1.0,\n+      'step': 0.1,\n     }),\n     'config_entry_id': <ANY>,\n     'device_class': None,\n@@ -44,7 +44,7 @@\n       'max': 3000.0,\n       'min': -3000.0,\n       'mode': <NumberMode.AUTO: 'auto'>,\n-      'step': 1.0,\n+      'step': 0.1,\n       'unit_of_measurement': 'DM',\n     }),\n     'context': <ANY>,\n@@ -64,7 +64,7 @@\n       'max': 3000.0,\n       'min': -3000.0,\n       'mode': <NumberMode.AUTO: 'auto'>,\n-      'step': 1.0,\n+      'step': 0.1,\n     }),\n     'config_entry_id': <ANY>,\n     'device_class': None,\n@@ -100,7 +100,7 @@\n       'max': 3000.0,\n       'min': -3000.0,\n       'mode': <NumberMode.AUTO: 'auto'>,\n-      'step': 1.0,\n+      'step': 0.1,\n       'unit_of_measurement': 'DM',\n     }),\n     'context': <ANY>,\n@@ -221,6 +221,116 @@\n     'state': '1.0',\n   })\n # ---\n+# name: test_number_states[platforms0][number.gotham_city_room_sensor_set_point_value_heating_climate_system_1-entry]\n+  EntityRegistryEntrySnapshot({\n+    'aliases': set({\n+    }),\n+    'area_id': None,\n+    'capabilities': dict({\n+      'max': 35.0,\n+      'min': 5.0,\n+      'mode': <NumberMode.AUTO: 'auto'>,\n+      'step': 0.5,\n+    }),\n+    'config_entry_id': <ANY>,\n+    'device_class': None,\n+    'device_id': <ANY>,\n+    'disabled_by': None,\n+    'domain': 'number',\n+    'entity_category': None,\n+    'entity_id': 'number.gotham_city_room_sensor_set_point_value_heating_climate_system_1',\n+    'has_entity_name': True,\n+    'hidden_by': None,\n+    'icon': None,\n+    'id': <ANY>,\n+    'labels': set({\n+    }),\n+    'name': None,\n+    'options': dict({\n+    }),\n+    'original_device_class': None,\n+    'original_icon': None,\n+    'original_name': 'Room sensor set point value heating climate system 1',\n+    'platform': 'myuplink',\n+    'previous_unique_id': None,\n+    'supported_features': 0,\n+    'translation_key': None,\n+    'unique_id': 'robin-r-1234-20240201-123456-aa-bb-cc-dd-ee-ff-47398',\n+    'unit_of_measurement': None,\n+  })\n+# ---\n+# name: test_number_states[platforms0][number.gotham_city_room_sensor_set_point_value_heating_climate_system_1-state]\n+  StateSnapshot({\n+    'attributes': ReadOnlyDict({\n+      'friendly_name': 'Gotham City Room sensor set point value heating climate system 1',\n+      'max': 35.0,\n+      'min': 5.0,\n+      'mode': <NumberMode.AUTO: 'auto'>,\n+      'step': 0.5,\n+    }),\n+    'context': <ANY>,\n+    'entity_id': 'number.gotham_city_room_sensor_set_point_value_heating_climate_system_1',\n+    'last_changed': <ANY>,\n+    'last_reported': <ANY>,\n+    'last_updated': <ANY>,\n+    'state': '14.5',\n+  })\n+# ---\n+# name: test_number_states[platforms0][number.gotham_city_room_sensor_set_point_value_heating_climate_system_1_2-entry]\n+  EntityRegistryEntrySnapshot({\n+    'aliases': set({\n+    }),\n+    'area_id': None,\n+    'capabilities': dict({\n+      'max': 35.0,\n+      'min': 5.0,\n+      'mode': <NumberMode.AUTO: 'auto'>,\n+      'step': 0.5,\n+    }),\n+    'config_entry_id': <ANY>,\n+    'device_class': None,\n+    'device_id': <ANY>,\n+    'disabled_by': None,\n+    'domain': 'number',\n+    'entity_category': None,\n+    'entity_id': 'number.gotham_city_room_sensor_set_point_value_heating_climate_system_1_2',\n+    'has_entity_name': True,\n+    'hidden_by': None,\n+    'icon': None,\n+    'id': <ANY>,\n+    'labels': set({\n+    }),\n+    'name': None,\n+    'options': dict({\n+    }),\n+    'original_device_class': None,\n+    'original_icon': None,\n+    'original_name': 'Room sensor set point value heating climate system 1',\n+    'platform': 'myuplink',\n+    'previous_unique_id': None,\n+    'supported_features': 0,\n+    'translation_key': None,\n+    'unique_id': 'batman-r-1234-20240201-123456-aa-bb-cc-dd-ee-ff-47398',\n+    'unit_of_measurement': None,\n+  })\n+# ---\n+# name: test_number_states[platforms0][number.gotham_city_room_sensor_set_point_value_heating_climate_system_1_2-state]\n+  StateSnapshot({\n+    'attributes': ReadOnlyDict({\n+      'friendly_name': 'Gotham City Room sensor set point value heating climate system 1',\n+      'max': 35.0,\n+      'min': 5.0,\n+      'mode': <NumberMode.AUTO: 'auto'>,\n+      'step': 0.5,\n+    }),\n+    'context': <ANY>,\n+    'entity_id': 'number.gotham_city_room_sensor_set_point_value_heating_climate_system_1_2',\n+    'last_changed': <ANY>,\n+    'last_reported': <ANY>,\n+    'last_updated': <ANY>,\n+    'state': '14.5',\n+  })\n+# ---\n # name: test_number_states[platforms0][number.gotham_city_start_diff_additional_heat-entry]\n   EntityRegistryEntrySnapshot({\n     'aliases': set({\n@@ -230,7 +340,7 @@\n       'max': 2000.0,\n       'min': 100.0,\n       'mode': <NumberMode.AUTO: 'auto'>,\n-      'step': 1.0,\n+      'step': 10.0,\n     }),\n     'config_entry_id': <ANY>,\n     'device_class': None,\n@@ -266,7 +376,7 @@\n       'max': 2000.0,\n       'min': 100.0,\n       'mode': <NumberMode.AUTO: 'auto'>,\n-      'step': 1.0,\n+      'step': 10.0,\n       'unit_of_measurement': 'DM',\n     }),\n     'context': <ANY>,\n@@ -286,7 +396,7 @@\n       'max': 2000.0,\n       'min': 100.0,\n       'mode': <NumberMode.AUTO: 'auto'>,\n-      'step': 1.0,\n+      'step': 10.0,\n     }),\n     'config_entry_id': <ANY>,\n     'device_class': None,\n@@ -322,7 +432,7 @@\n       'max': 2000.0,\n       'min': 100.0,\n       'mode': <NumberMode.AUTO: 'auto'>,\n-      'step': 1.0,\n+      'step': 10.0,\n       'unit_of_measurement': 'DM',\n     }),\n     'context': <ANY>,\n", "problem_statement": "NIBE F2040: step size for room sensor set point wrong\n### The problem\n\nI have a NIBE F2040 ASHP and SMO20. In #131583 the `47398 - Room sensor set point value heating climate system 1` key was added, allowing me to adjust the heating set point from HA.\r\n\r\nHowever the HA only allows steps of 1 degree, where it should be 0.5 degree (which can be done via the physical panel or uplink web interface).\r\n\r\nThe relevant part of the diagnostic output is\r\n\r\n```json\r\n                {\r\n                  \"category\": \"SMO 20\",\r\n                  \"parameterId\": \"47398\",\r\n                  \"parameterName\": \"Room sensor set point value heating climate system 1\",\r\n                  \"parameterUnit\": \"\\u00b0C\",\r\n                  \"writable\": true,\r\n                  \"timestamp\": \"2024-12-11T13:23:12+00:00\",\r\n                  \"value\": 14.5,\r\n                  \"strVal\": \"14.5\\u00b0C\",\r\n                  \"smartHomeCategories\": [],\r\n                  \"minValue\": 50.0,\r\n                  \"maxValue\": 350.0,\r\n                  \"stepValue\": 5.0,\r\n                  \"enumValues\": [],\r\n                  \"scaleValue\": \"0.1\",\r\n                  \"zoneId\": null\r\n                },\r\n```\r\nThat is after having set to a .5 value from the uplink web interface.\n\n### What version of Home Assistant Core has the issue?\n\ncore-2024.12.2\n\n### What was the last working version of Home Assistant Core?\n\n_No response_\n\n### What type of installation are you running?\n\nHome Assistant OS\n\n### Integration causing the issue\n\nmyuplink\n\n### Link to integration documentation on our website\n\nhttps://www.home-assistant.io/integrations/myuplink\n\n### Diagnostics information\n\n_No response_\n\n### Example YAML snippet\n\n_No response_\n\n### Anything in the logs that might be useful for us?\n\n_No response_\n\n### Additional information\n\nThere is a diagnostic file on #131583 let me know if you need a new one.\n", "hints_text": "", "created_at": "2024-12-12T09:33:38Z"}
{"repo": "home-assistant/core", "pull_number": 132962, "instance_id": "home-assistant__core-132962", "issue_numbers": ["132720"], "base_commit": "ff1df757b157c912eeee993fdd0347686b11ffec", "patch": "diff --git a/homeassistant/components/husqvarna_automower/manifest.json b/homeassistant/components/husqvarna_automower/manifest.json\nindex 0f35e60c219ed9..02e87a3a772819 100644\n--- a/homeassistant/components/husqvarna_automower/manifest.json\n+++ b/homeassistant/components/husqvarna_automower/manifest.json\n@@ -8,5 +8,5 @@\n   \"iot_class\": \"cloud_push\",\n   \"loggers\": [\"aioautomower\"],\n   \"quality_scale\": \"silver\",\n-  \"requirements\": [\"aioautomower==2024.10.3\"]\n+  \"requirements\": [\"aioautomower==2024.12.0\"]\n }\ndiff --git a/requirements_all.txt b/requirements_all.txt\nindex 54e80820491ad1..4ae86b07a0c4fd 100644\n--- a/requirements_all.txt\n+++ b/requirements_all.txt\n@@ -201,7 +201,7 @@ aioaseko==1.0.0\n aioasuswrt==1.4.0\n \n # homeassistant.components.husqvarna_automower\n-aioautomower==2024.10.3\n+aioautomower==2024.12.0\n \n # homeassistant.components.azure_devops\n aioazuredevops==2.2.1\n", "test_patch": "diff --git a/requirements_test_all.txt b/requirements_test_all.txt\nindex d4c1efeda157a8..d3f31adacd6c83 100644\n--- a/requirements_test_all.txt\n+++ b/requirements_test_all.txt\n@@ -189,7 +189,7 @@ aioaseko==1.0.0\n aioasuswrt==1.4.0\n \n # homeassistant.components.husqvarna_automower\n-aioautomower==2024.10.3\n+aioautomower==2024.12.0\n \n # homeassistant.components.azure_devops\n aioazuredevops==2.2.1\ndiff --git a/tests/components/husqvarna_automower/snapshots/test_diagnostics.ambr b/tests/components/husqvarna_automower/snapshots/test_diagnostics.ambr\nindex ce9fc9ac01aa28..2dab82451a6e98 100644\n--- a/tests/components/husqvarna_automower/snapshots/test_diagnostics.ambr\n+++ b/tests/components/husqvarna_automower/snapshots/test_diagnostics.ambr\n@@ -71,9 +71,7 @@\n       'activity': 'parked_in_cs',\n       'error_code': 0,\n       'error_datetime': None,\n-      'error_datetime_naive': None,\n       'error_key': None,\n-      'error_timestamp': 0,\n       'inactive_reason': 'none',\n       'is_error_confirmable': False,\n       'mode': 'main_area',\n@@ -82,9 +80,7 @@\n       'work_area_name': 'Front lawn',\n     }),\n     'planner': dict({\n-      'next_start': 1685991600000,\n       'next_start_datetime': '2023-06-05T19:00:00+02:00',\n-      'next_start_datetime_naive': '2023-06-05T19:00:00',\n       'override': dict({\n         'action': 'not_active',\n       }),\n@@ -141,7 +137,6 @@\n         'cutting_height': 50,\n         'enabled': False,\n         'last_time_completed': '2024-08-12T05:07:49+02:00',\n-        'last_time_completed_naive': '2024-08-12T05:07:49',\n         'name': 'my_lawn',\n         'progress': 20,\n       }),\n@@ -149,7 +144,6 @@\n         'cutting_height': 50,\n         'enabled': True,\n         'last_time_completed': '2024-08-12T07:54:29+02:00',\n-        'last_time_completed_naive': '2024-08-12T07:54:29',\n         'name': 'Front lawn',\n         'progress': 40,\n       }),\n@@ -157,7 +151,6 @@\n         'cutting_height': 25,\n         'enabled': True,\n         'last_time_completed': None,\n-        'last_time_completed_naive': None,\n         'name': 'Back lawn',\n         'progress': None,\n       }),\n", "problem_statement": "Upcoming change to Husqvarna Developer Portal\n### The problem\n\nHi i just received this mail from Husqvarna.\r\n\"Dear User of Husqvarna Group Developer Portal.\r\n\r\nWe want to inform you that we will launch our new IoT-backend in March 2025. Our current solution has grown old and earned its retirement.\r\n\r\n\r\n\r\nThis will be a breaking change for those who are using our current solution, and you will need to change your apps according to the below information.\r\n\r\n\r\n\r\nThe updated solution will be available from 20th December 2024. We will simultaneously run both solutions until 28th February 2025. After this the current version will be removed and only the updated version will be running.\r\n\r\nPlease see the new event format here: [Event-format-V2]\r\n\r\n(https://public-eur.mkt.dynamics.com/api/orgs/5b59be55-dc59-45da-831f-215cb122a901/r/Cgrfbq3L90GLQow2NKvTrAAAAAA?target=%7B%22TargetUrl%22%3A%22https%253A%252F%252Fapp.qa-developer-portal.dss.husqvarnagroup.net%252Fapis%252Fautomower-connect-api%253Ftab%253Dwebsocket%2520v2%22%2C%22RedirectOptions%22%3A%7B%225%22%3Anull%2C%221%22%3Anull%2C%222%22%3A%7B%22utm_medium%22%3A%22email%22%2C%22utm_term%22%3A%22N%2FA%22%2C%22utm_source%22%3A%22Customer%20Insights%20-%20Journey%22%2C%22utm_campaign%22%3A%22Central_AMC%2BOpenAPI%20User%20Notification%20Dec24_Consumer%22%7D%7D%7D&digest=05XOX0x1GkZqb64OndvgNN0wUpY7nXE3G%2Fg2HYulnTY%3D&secretVersion=7c13c22c20aa46a1b2fc8b71fde4d19a) \r\nand change your apps accordingly.\r\n\r\n\r\nFor questions please reach out to: feedback@developer.husqvarnagroup.cloud\"\r\n\n\n### What version of Home Assistant Core has the issue?\n\nFuture\n\n### What was the last working version of Home Assistant Core?\n\nCurrent\n\n### What type of installation are you running?\n\nHome Assistant Supervised\n\n### Integration causing the issue\n\nhomeassistant/components/husqvarna_automower\n\n### Link to integration documentation on our website\n\nhttps://www.home-assistant.io/integrations/husqvarna_automower/\n\n### Diagnostics information\n\n_No response_\n\n### Example YAML snippet\n\n_No response_\n\n### Anything in the logs that might be useful for us?\n\n_No response_\n\n### Additional information\n\n_No response_\n", "hints_text": "\nHey there @thomas55555, mind taking a look at this issue as it has been labeled with an integration (`husqvarna_automower`) you are listed as a [code owner](https://github.com/home-assistant/core/blob/dev/CODEOWNERS#L662) for? Thanks!\n\n<details>\n<summary>Code owner commands</summary>\n\n\nCode owners of `husqvarna_automower` can trigger bot actions by commenting:\n\n- `@home-assistant close` Closes the issue.\n- `@home-assistant rename Awesome new title` Renames the issue.\n- `@home-assistant reopen` Reopen the issue.\n- `@home-assistant unassign husqvarna_automower` Removes the current integration label and assignees on the issue, add the integration domain after the command.\n- `@home-assistant add-label needs-more-information` Add a label (needs-more-information, problem in dependency, problem in custom component) to the issue.\n- `@home-assistant remove-label needs-more-information` Remove a label (needs-more-information, problem in dependency, problem in custom component) on the issue.\n\n</details>\n\n\n<sub><sup>(message by CodeOwnersMention)</sup></sub>\n\n---\n\n[husqvarna_automower documentation](https://www.home-assistant.io/integrations/husqvarna_automower)\n[husqvarna_automower source](https://github.com/home-assistant/core/tree/dev/homeassistant/components/husqvarna_automower)\n<sub><sup>(message by IssueLinks)</sup></sub>\nNot really an issue, as it is not happend, yet.\r\nI've prepared it, but my mower is offline. I could implement in in the beta which is released on December 25th.\r\nAre you able to test the HA beta there?\nHi!\r\nThanks for the quick response!\r\nI just wanted to raise your attention to this since it's news to me and\r\nit's always nice to have lots of time to fix it instead of at the last\r\nminute. :)\r\n\r\nMy mover is offline too and since there is snow in the garden this time a\r\nyear my possibilities to test are not the best :(.\r\nLater in say mars-april i could probably bring mine online a little early\r\nin the season and test the beta with it. Would that help?\r\n\r\n\r\nOn Mon, Dec 9, 2024 at 9:52\u202fPM Thomas55555 ***@***.***> wrote:\r\n\r\n> Not really an issue, as it is not happend, yet.\r\n> I've prepared it, but my mower is offline. I could implement in in the\r\n> beta which is released on December 25th.\r\n> Are you able to test the HA beta there?\r\n>\r\n> \u2014\r\n> Reply to this email directly, view it on GitHub\r\n> <https://github.com/home-assistant/core/issues/132720#issuecomment-2529421573>,\r\n> or unsubscribe\r\n> <https://github.com/notifications/unsubscribe-auth/AWEGRCUA3I6HWP2F6QUHQAD2EX7IRAVCNFSM6AAAAABTI6WMXOVHI2DSMVQWIX3LMV43OSLTON2WKQ3PNVWWK3TUHMZDKMRZGQZDCNJXGM>\r\n> .\r\n> You are receiving this because you authored the thread.Message ID:\r\n> ***@***.***>\r\n>\r\n\r\n\r\n-- \r\nMvH Bj\u00f6rn Hagberg\r\n\nNot really. As the old v1 part already stops working at the end of December. But I can release it anyway. This shouldn't break anything.", "created_at": "2024-12-11T19:31:59Z"}
{"repo": "home-assistant/core", "pull_number": 132913, "instance_id": "home-assistant__core-132913", "issue_numbers": ["131548"], "base_commit": "dc8b7cfede78891d44c86c16a454582116cea9ed", "patch": "diff --git a/homeassistant/components/fritzbox_callmonitor/base.py b/homeassistant/components/fritzbox_callmonitor/base.py\nindex 2816880a1b243e..3c8714624e7351 100644\n--- a/homeassistant/components/fritzbox_callmonitor/base.py\n+++ b/homeassistant/components/fritzbox_callmonitor/base.py\n@@ -3,6 +3,7 @@\n from __future__ import annotations\n \n from contextlib import suppress\n+from dataclasses import dataclass\n from datetime import timedelta\n import logging\n import re\n@@ -19,12 +20,33 @@\n MIN_TIME_PHONEBOOK_UPDATE = timedelta(hours=6)\n \n \n+@dataclass\n+class Contact:\n+    \"\"\"Store details for one phonebook contact.\"\"\"\n+\n+    name: str\n+    numbers: list[str]\n+    vip: bool\n+\n+    def __init__(\n+        self, name: str, numbers: list[str] | None = None, category: str | None = None\n+    ) -> None:\n+        \"\"\"Initialize the class.\"\"\"\n+        self.name = name\n+        self.numbers = [re.sub(REGEX_NUMBER, \"\", nr) for nr in numbers or ()]\n+        self.vip = category == \"1\"\n+\n+\n+unknown_contact = Contact(UNKNOWN_NAME)\n+\n+\n class FritzBoxPhonebook:\n     \"\"\"Connects to a FritzBox router and downloads its phone book.\"\"\"\n \n     fph: FritzPhonebook\n     phonebook_dict: dict[str, list[str]]\n-    number_dict: dict[str, str]\n+    contacts: list[Contact]\n+    number_dict: dict[str, Contact]\n \n     def __init__(\n         self,\n@@ -56,27 +78,27 @@ def update_phonebook(self) -> None:\n         if self.phonebook_id is None:\n             return\n \n-        self.phonebook_dict = self.fph.get_all_names(self.phonebook_id)\n-        self.number_dict = {\n-            re.sub(REGEX_NUMBER, \"\", nr): name\n-            for name, nrs in self.phonebook_dict.items()\n-            for nr in nrs\n-        }\n+        self.fph.get_all_name_numbers(self.phonebook_id)\n+        self.contacts = [\n+            Contact(c.name, c.numbers, getattr(c, \"category\", None))\n+            for c in self.fph.phonebook.contacts\n+        ]\n+        self.number_dict = {nr: c for c in self.contacts for nr in c.numbers}\n         _LOGGER.debug(\"Fritz!Box phone book successfully updated\")\n \n     def get_phonebook_ids(self) -> list[int]:\n         \"\"\"Return list of phonebook ids.\"\"\"\n         return self.fph.phonebook_ids  # type: ignore[no-any-return]\n \n-    def get_name(self, number: str) -> str:\n-        \"\"\"Return a name for a given phone number.\"\"\"\n+    def get_contact(self, number: str) -> Contact:\n+        \"\"\"Return a contact for a given phone number.\"\"\"\n         number = re.sub(REGEX_NUMBER, \"\", str(number))\n \n         with suppress(KeyError):\n             return self.number_dict[number]\n \n         if not self.prefixes:\n-            return UNKNOWN_NAME\n+            return unknown_contact\n \n         for prefix in self.prefixes:\n             with suppress(KeyError):\n@@ -84,4 +106,4 @@ def get_name(self, number: str) -> str:\n             with suppress(KeyError):\n                 return self.number_dict[prefix + number.lstrip(\"0\")]\n \n-        return UNKNOWN_NAME\n+        return unknown_contact\ndiff --git a/homeassistant/components/fritzbox_callmonitor/sensor.py b/homeassistant/components/fritzbox_callmonitor/sensor.py\nindex 668369c35a7ed6..df18ae5702a314 100644\n--- a/homeassistant/components/fritzbox_callmonitor/sensor.py\n+++ b/homeassistant/components/fritzbox_callmonitor/sensor.py\n@@ -20,7 +20,7 @@\n from homeassistant.helpers.entity_platform import AddEntitiesCallback\n \n from . import FritzBoxCallMonitorConfigEntry\n-from .base import FritzBoxPhonebook\n+from .base import Contact, FritzBoxPhonebook\n from .const import (\n     ATTR_PREFIXES,\n     CONF_PHONEBOOK,\n@@ -96,7 +96,7 @@ def __init__(\n         self._host = host\n         self._port = port\n         self._monitor: FritzBoxCallMonitor | None = None\n-        self._attributes: dict[str, str | list[str]] = {}\n+        self._attributes: dict[str, str | list[str] | bool] = {}\n \n         self._attr_translation_placeholders = {\"phonebook_name\": phonebook_name}\n         self._attr_unique_id = unique_id\n@@ -152,20 +152,20 @@ def set_state(self, state: CallState) -> None:\n         \"\"\"Set the state.\"\"\"\n         self._attr_native_value = state\n \n-    def set_attributes(self, attributes: Mapping[str, str]) -> None:\n+    def set_attributes(self, attributes: Mapping[str, str | bool]) -> None:\n         \"\"\"Set the state attributes.\"\"\"\n         self._attributes = {**attributes}\n \n     @property\n-    def extra_state_attributes(self) -> dict[str, str | list[str]]:\n+    def extra_state_attributes(self) -> dict[str, str | list[str] | bool]:\n         \"\"\"Return the state attributes.\"\"\"\n         if self._prefixes:\n             self._attributes[ATTR_PREFIXES] = self._prefixes\n         return self._attributes\n \n-    def number_to_name(self, number: str) -> str:\n-        \"\"\"Return a name for a given phone number.\"\"\"\n-        return self._fritzbox_phonebook.get_name(number)\n+    def number_to_contact(self, number: str) -> Contact:\n+        \"\"\"Return a contact for a given phone number.\"\"\"\n+        return self._fritzbox_phonebook.get_contact(number)\n \n     def update(self) -> None:\n         \"\"\"Update the phonebook if it is defined.\"\"\"\n@@ -225,35 +225,42 @@ def _parse(self, event: str) -> None:\n         df_in = \"%d.%m.%y %H:%M:%S\"\n         df_out = \"%Y-%m-%dT%H:%M:%S\"\n         isotime = datetime.strptime(line[0], df_in).strftime(df_out)\n+        att: dict[str, str | bool]\n         if line[1] == FritzState.RING:\n             self._sensor.set_state(CallState.RINGING)\n+            contact = self._sensor.number_to_contact(line[3])\n             att = {\n                 \"type\": \"incoming\",\n                 \"from\": line[3],\n                 \"to\": line[4],\n                 \"device\": line[5],\n                 \"initiated\": isotime,\n-                \"from_name\": self._sensor.number_to_name(line[3]),\n+                \"from_name\": contact.name,\n+                \"vip\": contact.vip,\n             }\n             self._sensor.set_attributes(att)\n         elif line[1] == FritzState.CALL:\n             self._sensor.set_state(CallState.DIALING)\n+            contact = self._sensor.number_to_contact(line[5])\n             att = {\n                 \"type\": \"outgoing\",\n                 \"from\": line[4],\n                 \"to\": line[5],\n                 \"device\": line[6],\n                 \"initiated\": isotime,\n-                \"to_name\": self._sensor.number_to_name(line[5]),\n+                \"to_name\": contact.name,\n+                \"vip\": contact.vip,\n             }\n             self._sensor.set_attributes(att)\n         elif line[1] == FritzState.CONNECT:\n             self._sensor.set_state(CallState.TALKING)\n+            contact = self._sensor.number_to_contact(line[4])\n             att = {\n                 \"with\": line[4],\n                 \"device\": line[3],\n                 \"accepted\": isotime,\n-                \"with_name\": self._sensor.number_to_name(line[4]),\n+                \"with_name\": contact.name,\n+                \"vip\": contact.vip,\n             }\n             self._sensor.set_attributes(att)\n         elif line[1] == FritzState.DISCONNECT:\ndiff --git a/homeassistant/components/fritzbox_callmonitor/strings.json b/homeassistant/components/fritzbox_callmonitor/strings.json\nindex e935549035c755..437b218a8e23c2 100644\n--- a/homeassistant/components/fritzbox_callmonitor/strings.json\n+++ b/homeassistant/components/fritzbox_callmonitor/strings.json\n@@ -78,7 +78,8 @@\n           \"accepted\": { \"name\": \"Accepted\" },\n           \"with_name\": { \"name\": \"With name\" },\n           \"duration\": { \"name\": \"Duration\" },\n-          \"closed\": { \"name\": \"Closed\" }\n+          \"closed\": { \"name\": \"Closed\" },\n+          \"vip\": { \"name\": \"Important\" }\n         }\n       }\n     }\n", "test_patch": "", "problem_statement": "Extend telephone book search result\n### The problem\n\nIs there an option to get from telephone book if caller is important (wichtig in DE) ? \n\n### What version of Home Assistant Core has the issue?\n\n2024.11.2\n\n### What was the last working version of Home Assistant Core?\n\n_No response_\n\n### What type of installation are you running?\n\nHome Assistant Core\n\n### Integration causing the issue\n\nfritzbox_callmonitor\n\n### Link to integration documentation on our website\n\nhttps://www.home-assistant.io/integrations/fritzbox_callmonitor#examples\n\n### Diagnostics information\n\nnone\n\n### Example YAML snippet\n\n```yaml\nnone\n```\n\n\n### Anything in the logs that might be useful for us?\n\n```txt\nnone\n```\n\n\n### Additional information\n\n![fritz](https://github.com/user-attachments/assets/e739cd79-9a33-41c9-ba93-daa4de78a63c)\r\n\n", "hints_text": "\nHey there @cdce8p, mind taking a look at this issue as it has been labeled with an integration (`fritzbox_callmonitor`) you are listed as a [code owner](https://github.com/home-assistant/core/blob/dev/CODEOWNERS#L505) for? Thanks!\n\n<details>\n<summary>Code owner commands</summary>\n\n\nCode owners of `fritzbox_callmonitor` can trigger bot actions by commenting:\n\n- `@home-assistant close` Closes the issue.\n- `@home-assistant rename Awesome new title` Renames the issue.\n- `@home-assistant reopen` Reopen the issue.\n- `@home-assistant unassign fritzbox_callmonitor` Removes the current integration label and assignees on the issue, add the integration domain after the command.\n- `@home-assistant add-label needs-more-information` Add a label (needs-more-information, problem in dependency, problem in custom component) to the issue.\n- `@home-assistant remove-label needs-more-information` Remove a label (needs-more-information, problem in dependency, problem in custom component) on the issue.\n\n</details>\n\n\n<sub><sup>(message by CodeOwnersMention)</sup></sub>\n\n---\n\n[fritzbox_callmonitor documentation](https://www.home-assistant.io/integrations/fritzbox_callmonitor)\n[fritzbox_callmonitor source](https://github.com/home-assistant/core/tree/dev/homeassistant/components/fritzbox_callmonitor)\n<sub><sup>(message by IssueLinks)</sup></sub>", "created_at": "2024-12-11T11:07:34Z"}
{"repo": "home-assistant/core", "pull_number": 132779, "instance_id": "home-assistant__core-132779", "issue_numbers": ["130857"], "base_commit": "25d092c8eb1c4fe115ccf55f7fa3adcba4631d01", "patch": "diff --git a/homeassistant/components/hydrawise/__init__.py b/homeassistant/components/hydrawise/__init__.py\nindex 9e402cd49326c..ea5a5801e69e5 100644\n--- a/homeassistant/components/hydrawise/__init__.py\n+++ b/homeassistant/components/hydrawise/__init__.py\n@@ -7,7 +7,7 @@\n from homeassistant.core import HomeAssistant\n from homeassistant.exceptions import ConfigEntryAuthFailed\n \n-from .const import DOMAIN\n+from .const import APP_ID, DOMAIN\n from .coordinator import (\n     HydrawiseMainDataUpdateCoordinator,\n     HydrawiseUpdateCoordinators,\n@@ -30,7 +30,8 @@ async def async_setup_entry(hass: HomeAssistant, config_entry: ConfigEntry) -> b\n         raise ConfigEntryAuthFailed\n \n     hydrawise = client.Hydrawise(\n-        auth.Auth(config_entry.data[CONF_USERNAME], config_entry.data[CONF_PASSWORD])\n+        auth.Auth(config_entry.data[CONF_USERNAME], config_entry.data[CONF_PASSWORD]),\n+        app_id=APP_ID,\n     )\n \n     main_coordinator = HydrawiseMainDataUpdateCoordinator(hass, hydrawise)\ndiff --git a/homeassistant/components/hydrawise/config_flow.py b/homeassistant/components/hydrawise/config_flow.py\nindex 419927d6d4226..5af32af3951d6 100644\n--- a/homeassistant/components/hydrawise/config_flow.py\n+++ b/homeassistant/components/hydrawise/config_flow.py\n@@ -13,7 +13,7 @@\n from homeassistant.config_entries import SOURCE_REAUTH, ConfigFlow, ConfigFlowResult\n from homeassistant.const import CONF_PASSWORD, CONF_USERNAME\n \n-from .const import DOMAIN, LOGGER\n+from .const import APP_ID, DOMAIN, LOGGER\n \n \n class HydrawiseConfigFlow(ConfigFlow, domain=DOMAIN):\n@@ -39,7 +39,7 @@ async def _create_or_update_entry(\n             return on_failure(\"timeout_connect\")\n \n         try:\n-            api = client.Hydrawise(auth)\n+            api = client.Hydrawise(auth, app_id=APP_ID)\n             # Don't fetch zones because we don't need them yet.\n             user = await api.get_user(fetch_zones=False)\n         except TimeoutError:\ndiff --git a/homeassistant/components/hydrawise/const.py b/homeassistant/components/hydrawise/const.py\nindex 6d846dd612702..beaf450a5867d 100644\n--- a/homeassistant/components/hydrawise/const.py\n+++ b/homeassistant/components/hydrawise/const.py\n@@ -3,8 +3,12 @@\n from datetime import timedelta\n import logging\n \n+from homeassistant.const import __version__ as HA_VERSION\n+\n LOGGER = logging.getLogger(__package__)\n \n+APP_ID = f\"homeassistant-{HA_VERSION}\"\n+\n DOMAIN = \"hydrawise\"\n DEFAULT_WATERING_TIME = timedelta(minutes=15)\n \n", "test_patch": "", "problem_statement": "Hydrawise still giving error 429 - too many poll requests\n### The problem\n\nthe problem was already https://github.com/home-assistant/core/issues/130131 and tried to be fixed but the issue still persists. \r\n\r\n<img width=\"522\" alt=\"image\" src=\"https://github.com/user-attachments/assets/0efd559d-916a-42b0-b4e2-a133bda79f09\">\r\n\n\n### What version of Home Assistant Core has the issue?\n\n2024.11.2\n\n### What was the last working version of Home Assistant Core?\n\n_No response_\n\n### What type of installation are you running?\n\nHome Assistant OS\n\n### Integration causing the issue\n\nHydrawise\n\n### Link to integration documentation on our website\n\nhttps://www.home-assistant.io/integrations/hydrawise/\n\n### Diagnostics information\n\n2024-11-18 08:18:58.845 ERROR (MainThread) [homeassistant.components.hydrawise] Unexpected error fetching hydrawise data\r\nTraceback (most recent call last):\r\n  File \"/usr/local/lib/python3.12/site-packages/gql/transport/aiohttp.py\", line 319, in raise_response_error\r\n    resp.raise_for_status()\r\n  File \"/usr/local/lib/python3.12/site-packages/aiohttp/client_reqrep.py\", line 1158, in raise_for_status\r\n    raise ClientResponseError(\r\naiohttp.client_exceptions.ClientResponseError: 429, message='Too Many Requests', url='https://app.hydrawise.com/api/v2/graph'\r\n\r\nThe above exception was the direct cause of the following exception:\r\n\r\nTraceback (most recent call last):\r\n  File \"/usr/src/homeassistant/homeassistant/helpers/update_coordinator.py\", line 382, in _async_refresh\r\n    self.data = await self._async_update_data()\r\n                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/src/homeassistant/homeassistant/components/hydrawise/coordinator.py\", line 62, in _async_update_data\r\n    data = HydrawiseData(user=await self.api.get_user(fetch_zones=False))\r\n                              ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/local/lib/python3.12/site-packages/pydrawise/client.py\", line 109, in get_user\r\n    result = await self._query(\r\n             ^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/local/lib/python3.12/site-packages/pydrawise/client.py\", line 88, in _query\r\n    return await session.execute(dsl_gql(DSLQuery(selector)))\r\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/local/lib/python3.12/site-packages/gql/client.py\", line 1628, in execute\r\n    result = await self._execute(\r\n             ^^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/local/lib/python3.12/site-packages/gql/client.py\", line 1537, in _execute\r\n    result = await self.transport.execute(\r\n             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/local/lib/python3.12/site-packages/gql/transport/aiohttp.py\", line 341, in execute\r\n    await raise_response_error(resp, \"Not a JSON answer\")\r\n  File \"/usr/local/lib/python3.12/site-packages/gql/transport/aiohttp.py\", line 321, in raise_response_error\r\n    raise TransportServerError(str(e), e.status) from e\r\ngql.transport.exceptions.TransportServerError: 429, message='Too Many Requests', url='https://app.hydrawise.com/api/v2/graph'\n\n### Example YAML snippet\n\n_No response_\n\n### Anything in the logs that might be useful for us?\n\n_No response_\n\n### Additional information\n\n_No response_\n", "hints_text": "\nHey there @dknowles2, @thomaskistler, @ptcryan, mind taking a look at this issue as it has been labeled with an integration (`hydrawise`) you are listed as a [code owner](https://github.com/home-assistant/core/blob/dev/CODEOWNERS#L670) for? Thanks!\n\n<details>\n<summary>Code owner commands</summary>\n\n\nCode owners of `hydrawise` can trigger bot actions by commenting:\n\n- `@home-assistant close` Closes the issue.\n- `@home-assistant rename Awesome new title` Renames the issue.\n- `@home-assistant reopen` Reopen the issue.\n- `@home-assistant unassign hydrawise` Removes the current integration label and assignees on the issue, add the integration domain after the command.\n- `@home-assistant add-label needs-more-information` Add a label (needs-more-information, problem in dependency, problem in custom component) to the issue.\n- `@home-assistant remove-label needs-more-information` Remove a label (needs-more-information, problem in dependency, problem in custom component) on the issue.\n\n</details>\n\n\n<sub><sup>(message by CodeOwnersMention)</sup></sub>\n\n---\n\n[hydrawise documentation](https://www.home-assistant.io/integrations/hydrawise)\n[hydrawise source](https://github.com/home-assistant/core/tree/dev/homeassistant/components/hydrawise)\n<sub><sup>(message by IssueLinks)</sup></sub>\n@dknowles2 I see there is already this PR https://github.com/home-assistant/core/pull/130759 which has been merged 2 days ago. Will the new 5 minute polling interval also affect sensors which check the irrigation zone status? Is there a chance to keep these on a shorter update schedule?\nNo, it seems we are being aggressively throttled by the Hydrawise API. We may be able to get away with something shorter than 5 minutes, but I erred on the side of caution to make sure that the integration is at least working.\r\n\r\nI've reached out to Hydrawise support to see what we can do to relieve the throttling. FWIW I've determined how they're differentiating their web app's traffic from ours (which incidentally also polls at a 1 minute interval), but I don't want to be antagonistic and end up in a MyQ-style situation where they start blocking us entirely.\r\n\r\nIn any case, this will be resolved with the next point-release. There are other workarounds mentioned in https://github.com/home-assistant/core/issues/130131 if this is still a blocking issue for you.\n@home-assistant close\nAt the moment not critical as winter is approaching and haven't used my sprinklers.\n> No, it seems we are being aggressively throttled by the Hydrawise API. We may be able to get away with something shorter than 5 minutes, but I erred on the side of caution to make sure that the integration is at least working.\r\n> \r\n> I've reached out to Hydrawise support to see what we can do to relieve the throttling. FWIW I've determined how they're differentiating their web app's traffic from ours (which incidentally also polls at a 1 minute interval), but I don't want to be antagonistic and end up in a MyQ-style situation where they start blocking us entirely.\r\n> \r\n> In any case, this will be resolved with the next point-release. There are other workarounds mentioned in #130131 if this is still a blocking issue for you.\r\n\r\nThanks David.  Hopefully the planned resolution takes advantage of the REST API nextpoll returned data that advises the calling system the amount to delay to meet the API rate limiting requirement.  Thanks again for your work to date for this integration.", "created_at": "2024-12-10T02:36:21Z"}
{"repo": "home-assistant/core", "pull_number": 132759, "instance_id": "home-assistant__core-132759", "issue_numbers": ["125350"], "base_commit": "b139af9a9c8ed581f18b25e7bc79c2df998583f7", "patch": "diff --git a/homeassistant/components/daikin/manifest.json b/homeassistant/components/daikin/manifest.json\nindex f6e9cb78efbccb..f794d97a9ba468 100644\n--- a/homeassistant/components/daikin/manifest.json\n+++ b/homeassistant/components/daikin/manifest.json\n@@ -6,6 +6,6 @@\n   \"documentation\": \"https://www.home-assistant.io/integrations/daikin\",\n   \"iot_class\": \"local_polling\",\n   \"loggers\": [\"pydaikin\"],\n-  \"requirements\": [\"pydaikin==2.13.7\"],\n+  \"requirements\": [\"pydaikin==2.13.8\"],\n   \"zeroconf\": [\"_dkapi._tcp.local.\"]\n }\ndiff --git a/requirements_all.txt b/requirements_all.txt\nindex 87baa60f52a061..30cbc5991b01c9 100644\n--- a/requirements_all.txt\n+++ b/requirements_all.txt\n@@ -1835,7 +1835,7 @@ pycsspeechtts==1.0.8\n # pycups==2.0.4\n \n # homeassistant.components.daikin\n-pydaikin==2.13.7\n+pydaikin==2.13.8\n \n # homeassistant.components.danfoss_air\n pydanfossair==0.1.0\n", "test_patch": "diff --git a/requirements_test_all.txt b/requirements_test_all.txt\nindex a2b73f7e272921..51b4062beb35b0 100644\n--- a/requirements_test_all.txt\n+++ b/requirements_test_all.txt\n@@ -1488,7 +1488,7 @@ pycountry==24.6.1\n pycsspeechtts==1.0.8\n \n # homeassistant.components.daikin\n-pydaikin==2.13.7\n+pydaikin==2.13.8\n \n # homeassistant.components.deako\n pydeako==0.6.0\n", "problem_statement": "Daikin Integration - Bad Parsing problems since last version of integration\n### The problem\r\n\r\nRecently I did an update of home assistant after one month. So i've upgraded from 2024.7.3 to 2024.9.0.\r\n\r\nThe integration is used with an old style never upgraded system connectivity module which shows as firmware 1.0.31.\r\n\r\nI've 3 same identical internal units (FTXM35N2V1B), one is connected to a dual split external unit. the other 2 are connected to a 3 split external unit (3MXM-M).\r\n\r\nImmediately I noticed something weird with the integration as it was failing to setup randomly, after several times reloading the integration it would  be able to initialize but still it continued to show weird problems with the sensors even if the basic HVAC functionality was working.\r\n\r\nCalling the various api manually from a browser seems perfectly normal but the extension seems to have serious issues (seems i just used 6000kwh today for example if i look at the energy tab).\r\n\r\nAdditionally the HVAC never goes in \"idle\" on home assistant even if it is effectively so when it reaches its setpoint.\r\n\r\nThis seems to be caused by the fact sensor seems to be unreliable and continue randomly zeroing out:\r\n\r\n![image](https://github.com/user-attachments/assets/587c5ace-f18f-4469-a918-3dd45a47bb90)\r\n\r\n\r\nIn the system log i've also a lot of errors spamming it (which i post in the other section)\r\n\r\n\r\n### What version of Home Assistant Core has the issue?\r\n\r\ncore-2024.9.0\r\n\r\n### What was the last working version of Home Assistant Core?\r\n\r\ncore-2024.7.3\r\n\r\n### What type of installation are you running?\r\n\r\nHome Assistant OS\r\n\r\n### Integration causing the issue\r\n\r\ndaikin\r\n\r\n### Link to integration documentation on our website\r\n\r\nhttps://www.home-assistant.io/integrations/daikin\r\n\r\n### Diagnostics information\r\n\r\n[home-assistant_daikin_2024-09-05T16-17-16.025Z.log.zip](https://github.com/user-attachments/files/16897497/home-assistant_daikin_2024-09-05T16-17-16.025Z.log.zip)\r\nThis is a running diagnostic from some minutes while not doing anything.\r\n\r\n### Example YAML snippet\r\n\r\n_No response_\r\n\r\n### Anything in the logs that might be useful for us?\r\n\r\n```txt\r\nLogger: pydaikin.power\r\nSource: components/daikin/sensor.py:104\r\nFirst occurred: September 4, 2024 at 23:27:37 (2252 occurrences)\r\nLast logged: 18:14:13\r\n\r\nImpossible energy consumption measure of heat\r\n```\r\n\r\n```\r\nLogger: pydaikin.daikin_base\r\nSource: components/daikin/__init__.py:116\r\nFirst occurred: September 4, 2024 at 21:33:07 (1683 occurrences)\r\nLast logged: 18:14:25\r\n\r\nException in TaskGroup: Response payload is not completed: <ContentLengthError: 400, message='Not enough data for satisfy content length header.'>\r\nException in TaskGroup: missing 'ret' field in response\r\nException in TaskGroup: Cannot connect to host 192.168.10.142:80 ssl:default [Connect call failed ('192.168.10.142', 80)]\r\n```\r\n\r\n```\r\nLogger: homeassistant.helpers.entity\r\nSource: helpers/entity.py:942\r\nFirst occurred: September 4, 2024 at 21:34:07 (642 occurrences)\r\nLast logged: 18:13:13\r\n\r\nUpdate for sensor.daikinap16999_inside_temperature fails\r\nUpdate for sensor.daikinap58951_inside_temperature fails\r\nUpdate for climate.daikinap16999 fails\r\nUpdate for climate.daikinap58951 fails\r\nUpdate for climate.daikinap36563 fails\r\nTraceback (most recent call last):\r\n  File \"/usr/local/lib/python3.12/site-packages/aiohttp/client_proto.py\", line 94, in connection_lost\r\n    uncompleted = self._parser.feed_eof()\r\n                  ^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"aiohttp/_http_parser.pyx\", line 516, in aiohttp._http_parser.HttpParser.feed_eof\r\naiohttp.http_exceptions.ContentLengthError: 400, message:\r\n  Not enough data for satisfy content length header.\r\n\r\nThe above exception was the direct cause of the following exception:\r\n\r\nTraceback (most recent call last):\r\n  File \"/usr/src/homeassistant/homeassistant/helpers/entity.py\", line 942, in async_update_ha_state\r\n    await self.async_device_update()\r\n  File \"/usr/src/homeassistant/homeassistant/helpers/entity.py\", line 1300, in async_device_update\r\n    await self.async_update()\r\n  File \"/usr/src/homeassistant/homeassistant/components/daikin/sensor.py\", line 198, in async_update\r\n    await self._api.async_update()\r\n  File \"/usr/src/homeassistant/homeassistant/components/daikin/__init__.py\", line 116, in async_update\r\n    await self.device.update_status()\r\n  File \"/usr/local/lib/python3.12/site-packages/pydaikin/daikin_base.py\", line 204, in update_status\r\n    self.values.update_by_resource(resource, task.result())\r\n                                             ^^^^^^^^^^^^^\r\n  File \"/usr/local/lib/python3.12/site-packages/tenacity/asyncio/__init__.py\", line 189, in async_wrapped\r\n    return await copy(fn, *args, **kwargs)\r\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/local/lib/python3.12/site-packages/tenacity/asyncio/__init__.py\", line 111, in __call__\r\n    do = await self.iter(retry_state=retry_state)\r\n         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/local/lib/python3.12/site-packages/tenacity/asyncio/__init__.py\", line 153, in iter\r\n    result = await action(retry_state)\r\n             ^^^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/local/lib/python3.12/site-packages/tenacity/_utils.py\", line 99, in inner\r\n    return call(*args, **kwargs)\r\n           ^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/local/lib/python3.12/site-packages/tenacity/__init__.py\", line 398, in <lambda>\r\n    self._add_action_func(lambda rs: rs.outcome.result())\r\n                                     ^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/local/lib/python3.12/concurrent/futures/_base.py\", line 449, in result\r\n    return self.__get_result()\r\n           ^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/local/lib/python3.12/concurrent/futures/_base.py\", line 401, in __get_result\r\n    raise self._exception\r\n  File \"/usr/local/lib/python3.12/site-packages/tenacity/asyncio/__init__.py\", line 114, in __call__\r\n    result = await fn(*args, **kwargs)\r\n             ^^^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/local/lib/python3.12/site-packages/pydaikin/daikin_base.py\", line 180, in _get_resource\r\n    return self.parse_response(await response.text())\r\n                               ^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/local/lib/python3.12/site-packages/aiohttp/client_reqrep.py\", line 1176, in text\r\n    await self.read()\r\n  File \"/usr/local/lib/python3.12/site-packages/aiohttp/client_reqrep.py\", line 1134, in read\r\n    self._body = await self.content.read()\r\n                 ^^^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/local/lib/python3.12/site-packages/aiohttp/streams.py\", line 383, in read\r\n    block = await self.readany()\r\n            ^^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/local/lib/python3.12/site-packages/aiohttp/streams.py\", line 405, in readany\r\n    await self._wait(\"readany\")\r\n  File \"/usr/local/lib/python3.12/site-packages/aiohttp/streams.py\", line 312, in _wait\r\n    await waiter\r\naiohttp.client_exceptions.ClientPayloadError: Response payload is not completed: <ContentLengthError: 400, message='Not enough data for satisfy content length header.'>\r\n```\r\n```\r\n\r\nLogger: homeassistant\r\nSource: components/daikin/sensor.py:130\r\nFirst occurred: September 4, 2024 at 21:35:10 (44 occurrences)\r\nLast logged: 17:26:24\r\n\r\nError doing job: Task exception was never retrieved (None)\r\nTraceback (most recent call last):\r\n  File \"/usr/src/homeassistant/homeassistant/helpers/entity_platform.py\", line 1047, in _async_update_entity_states\r\n    await asyncio.gather(*tasks)\r\n  File \"/usr/src/homeassistant/homeassistant/helpers/entity.py\", line 960, in async_update_ha_state\r\n    self._async_write_ha_state()\r\n  File \"/usr/src/homeassistant/homeassistant/helpers/entity.py\", line 1130, in _async_write_ha_state\r\n    self.__async_calculate_state()\r\n  File \"/usr/src/homeassistant/homeassistant/helpers/entity.py\", line 1067, in __async_calculate_state\r\n    state = self._stringify_state(available)\r\n            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/src/homeassistant/homeassistant/helpers/entity.py\", line 1011, in _stringify_state\r\n    if (state := self.state) is None:\r\n                 ^^^^^^^^^^\r\n  File \"/usr/src/homeassistant/homeassistant/components/sensor/__init__.py\", line 542, in state\r\n    value = self.native_value\r\n            ^^^^^^^^^^^^^^^^^\r\n  File \"/usr/src/homeassistant/homeassistant/components/daikin/sensor.py\", line 194, in native_value\r\n    return self.entity_description.value_func(self._api.device)\r\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/src/homeassistant/homeassistant/components/daikin/sensor.py\", line 130, in <lambda>\r\n    value_func=lambda device: round(device.today_total_energy_consumption, 2),\r\n                              ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\nTypeError: type NoneType doesn't define __round__ method\r\n```\r\n\r\n```\r\nLogger: aiohttp.server\r\nSource: /usr/local/lib/python3.12/site-packages/aiohttp/web_protocol.py:433\r\nFirst occurred: 13:43:25 (2 occurrences)\r\nLast logged: 13:43:32\r\n\r\nError handling request\r\nTraceback (most recent call last):\r\n  File \"/usr/local/lib/python3.12/site-packages/aiohttp/web_protocol.py\", line 362, in data_received\r\n    messages, upgraded, tail = self._request_parser.feed_data(data)\r\n                               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"aiohttp/_http_parser.pyx\", line 563, in aiohttp._http_parser.HttpParser.feed_data\r\naiohttp.http_exceptions.BadStatusLine: 400, message:\r\n  Invalid method encountered:\r\n\r\n    b'\\x16\\x03\\x01'\r\n      ^\r\n```\r\n```\r\n\r\n\r\n### Additional information\r\n\r\n_No response_\n", "hints_text": "\nHey there @fredrike, mind taking a look at this issue as it has been labeled with an integration (`daikin`) you are listed as a [code owner](https://github.com/home-assistant/core/blob/dev/CODEOWNERS#L291) for? Thanks!\n\n<details>\n<summary>Code owner commands</summary>\n\n\nCode owners of `daikin` can trigger bot actions by commenting:\n\n- `@home-assistant close` Closes the issue.\n- `@home-assistant rename Awesome new title` Renames the issue.\n- `@home-assistant reopen` Reopen the issue.\n- `@home-assistant unassign daikin` Removes the current integration label and assignees on the issue, add the integration domain after the command.\n- `@home-assistant add-label needs-more-information` Add a label (needs-more-information, problem in dependency, problem in custom component) to the issue.\n- `@home-assistant remove-label needs-more-information` Remove a label (needs-more-information, problem in dependency, problem in custom component) on the issue.\n\n</details>\n\n\n<sub><sup>(message by CodeOwnersMention)</sup></sub>\n\n---\n\n[daikin documentation](https://www.home-assistant.io/integrations/daikin)\n[daikin source](https://github.com/home-assistant/core/tree/dev/homeassistant/components/daikin)\n<sub><sup>(message by IssueLinks)</sup></sub>\nThere hasn't been any activity on this issue recently. Due to the high number of incoming GitHub notifications, we have to clean some of the old issues, as many of them have already been resolved with the latest updates.\nPlease make sure to update to the latest Home Assistant version and check if that solves the issue. Let us know if that works for you by adding a comment \ud83d\udc4d\nThis issue has now been marked as stale and will be closed if no further activity occurs. Thank you for your contributions.\nthe problem is still present and is caused by the underlying library, it has patches but were not applied yet.\n@weltall sorry for neglecting your PR, I've accepted it now and a new version is published to pypi (https://pypi.org/project/pydaikin/2.13.8/). Will you create a bump-version pr for ha?", "created_at": "2024-12-09T20:55:53Z"}
{"repo": "home-assistant/core", "pull_number": 132717, "instance_id": "home-assistant__core-132717", "issue_numbers": ["132674"], "base_commit": "72de5d0fa34c4cc799384081d781b761c69d96dc", "patch": "diff --git a/homeassistant/components/nordpool/entity.py b/homeassistant/components/nordpool/entity.py\nindex 32240aad12cc8f..ec3264cd2e3f18 100644\n--- a/homeassistant/components/nordpool/entity.py\n+++ b/homeassistant/components/nordpool/entity.py\n@@ -2,7 +2,7 @@\n \n from __future__ import annotations\n \n-from homeassistant.helpers.device_registry import DeviceInfo\n+from homeassistant.helpers.device_registry import DeviceEntryType, DeviceInfo\n from homeassistant.helpers.entity import EntityDescription\n from homeassistant.helpers.update_coordinator import CoordinatorEntity\n \n@@ -29,4 +29,5 @@ def __init__(\n         self._attr_device_info = DeviceInfo(\n             identifiers={(DOMAIN, area)},\n             name=f\"Nord Pool {area}\",\n+            entry_type=DeviceEntryType.SERVICE,\n         )\n", "test_patch": "", "problem_statement": "Nord Pool: Configurations should show up with service, not device\n### The problem\n\nCurrently the new Nord Pool integration shows up with a device:\r\n\r\n![Screenshot 2024-12-09 10 04 39](https://github.com/user-attachments/assets/2f1aa124-ad9a-43c0-b46c-815ab039d080)\r\n\r\nIt should show up as a service instead, like Electricity Maps, Sun, weather integrations, etc.:\r\n\r\n![Screenshot 2024-12-09 10 05 07](https://github.com/user-attachments/assets/87098ef6-21c0-4a15-97ad-fa5d4138fa41)\r\n\r\nBesides that: Really cool integration!\r\nAs the day-ahead prices are determined around 13:00 MET it would be awesome to have those available for the next day at that point. Currently there is just the sensor for the next hour so there is no way to plan the next day based on that, for example when to charge a battery system at the lowest price. But I assume that is on your list anyhow. ;-)\r\n\n\n### What version of Home Assistant Core has the issue?\n\n2024.12.1\n\n### What was the last working version of Home Assistant Core?\n\n_No response_\n\n### What type of installation are you running?\n\nHome Assistant OS\n\n### Integration causing the issue\n\nNord Pool\n\n### Link to integration documentation on our website\n\nhttps://www.home-assistant.io/integrations/nordpool\n\n### Diagnostics information\n\n_No response_\n\n### Example YAML snippet\n\n_No response_\n\n### Anything in the logs that might be useful for us?\n\n_No response_\n\n### Additional information\n\n_No response_\n", "hints_text": "\nHey there @gjohansson-st, mind taking a look at this issue as it has been labeled with an integration (`nordpool`) you are listed as a [code owner](https://github.com/home-assistant/core/blob/dev/CODEOWNERS#L1017) for? Thanks!\n\n<details>\n<summary>Code owner commands</summary>\n\n\nCode owners of `nordpool` can trigger bot actions by commenting:\n\n- `@home-assistant close` Closes the issue.\n- `@home-assistant rename Awesome new title` Renames the issue.\n- `@home-assistant reopen` Reopen the issue.\n- `@home-assistant unassign nordpool` Removes the current integration label and assignees on the issue, add the integration domain after the command.\n- `@home-assistant add-label needs-more-information` Add a label (needs-more-information, problem in dependency, problem in custom component) to the issue.\n- `@home-assistant remove-label needs-more-information` Remove a label (needs-more-information, problem in dependency, problem in custom component) on the issue.\n\n</details>\n\n\n<sub><sup>(message by CodeOwnersMention)</sup></sub>\n\n---\n\n[nordpool documentation](https://www.home-assistant.io/integrations/nordpool)\n[nordpool source](https://github.com/home-assistant/core/tree/dev/homeassistant/components/nordpool)\n<sub><sup>(message by IssueLinks)</sup></sub>", "created_at": "2024-12-09T14:15:39Z"}
{"repo": "home-assistant/core", "pull_number": 132630, "instance_id": "home-assistant__core-132630", "issue_numbers": ["132453"], "base_commit": "d32e69dcb6dd295da5c44204d92216c5b0624d38", "patch": "diff --git a/homeassistant/components/zha/manifest.json b/homeassistant/components/zha/manifest.json\nindex 1fbbd83bb9c00..3a301be9b02f2 100644\n--- a/homeassistant/components/zha/manifest.json\n+++ b/homeassistant/components/zha/manifest.json\n@@ -21,7 +21,7 @@\n     \"zha\",\n     \"universal_silabs_flasher\"\n   ],\n-  \"requirements\": [\"universal-silabs-flasher==0.0.25\", \"zha==0.0.41\"],\n+  \"requirements\": [\"universal-silabs-flasher==0.0.25\", \"zha==0.0.42\"],\n   \"usb\": [\n     {\n       \"vid\": \"10C4\",\ndiff --git a/requirements_all.txt b/requirements_all.txt\nindex fcd28e2bc1a72..ed6b402bdad51 100644\n--- a/requirements_all.txt\n+++ b/requirements_all.txt\n@@ -3081,7 +3081,7 @@ zeroconf==0.136.2\n zeversolar==0.3.2\n \n # homeassistant.components.zha\n-zha==0.0.41\n+zha==0.0.42\n \n # homeassistant.components.zhong_hong\n zhong-hong-hvac==1.0.13\n", "test_patch": "diff --git a/requirements_test_all.txt b/requirements_test_all.txt\nindex 4d06bbf79dd8c..22afad0180314 100644\n--- a/requirements_test_all.txt\n+++ b/requirements_test_all.txt\n@@ -2467,7 +2467,7 @@ zeroconf==0.136.2\n zeversolar==0.3.2\n \n # homeassistant.components.zha\n-zha==0.0.41\n+zha==0.0.42\n \n # homeassistant.components.zwave_js\n zwave-js-server-python==0.60.0\n", "problem_statement": "After Core 2024.12.0 Update - Zigbee Won't Work\n### The problem\n\nAfter updating to Core Update 2024.12.0, ZHA will not initialize.  I had to roll back to 2024.11.3 and everything came back up.\n\n### What version of Home Assistant Core has the issue?\n\n2024.12.0\n\n### What was the last working version of Home Assistant Core?\n\n2024.11.3\n\n### What type of installation are you running?\n\nHome Assistant OS\n\n### Integration causing the issue\n\nZHA\n\n### Link to integration documentation on our website\n\n_No response_\n\n### Diagnostics information\n\n_No response_\n\n### Example YAML snippet\n\n_No response_\n\n### Anything in the logs that might be useful for us?\n\n```txt\n2024-12-05 15:32:42.136 DEBUG (MainThread) [zigpy.quirks.registry] Checking quirks for Silicon Labs EZSP (84:b4:db:ff:fe:96:72:0a)\r\n2024-12-05 15:32:42.136 DEBUG (MainThread) [zigpy.quirks.registry] Considering <class 'zhaquirks.xbee.xbee_io.XBeeSensor'>\r\n2024-12-05 15:32:42.136 DEBUG (MainThread) [zigpy.quirks] Fail because endpoint list mismatch: {232, 230} {1, 2}\r\n2024-12-05 15:32:42.136 DEBUG (MainThread) [zigpy.quirks.registry] Considering <class 'zhaquirks.xbee.xbee3_io.XBee3Sensor'>\r\n2024-12-05 15:32:42.136 DEBUG (MainThread) [zigpy.quirks] Fail because endpoint list mismatch: {232, 230} {1, 2}\r\n2024-12-05 15:32:42.136 DEBUG (MainThread) [zigpy.quirks.registry] Considering <class 'zhaquirks.tuya.ts0201.MoesTemperatureHumidtySensorWithScreen'>\r\n2024-12-05 15:32:42.136 DEBUG (MainThread) [zigpy.quirks] Fail because endpoint list mismatch: {1} {1, 2}\r\n2024-12-05 15:32:42.136 DEBUG (MainThread) [zigpy.quirks.registry] Considering <class 'zhaquirks.smartthings.tag_v4.SmartThingsTagV4'>\r\n2024-12-05 15:32:42.136 DEBUG (MainThread) [zigpy.quirks] Fail because endpoint list mismatch: {1} {1, 2}\r\n2024-12-05 15:32:42.136 DEBUG (MainThread) [zigpy.quirks.registry] Considering <class 'zhaquirks.smartthings.multi.SmartthingsMultiPurposeSensor'>\r\n2024-12-05 15:32:42.136 DEBUG (MainThread) [zigpy.quirks] Fail because endpoint list mismatch: {1} {1, 2}\r\n2024-12-05 15:32:42.136 DEBUG (MainThread) [zigpy.quirks.registry] Considering <class 'zhaquirks.netvox.z308e3ed.Z308E3ED'>\r\n2024-12-05 15:32:42.136 DEBUG (MainThread) [zigpy.quirks] Fail because endpoint list mismatch: {1} {1, 2}\r\n2024-12-05 15:32:42.136 DEBUG (MainThread) [zigpy.quirks.registry] Considering <class 'zhaquirks.gledopto.soposhgu10.SoposhGU10'>\r\n2024-12-05 15:32:42.136 DEBUG (MainThread) [zigpy.quirks] Fail because endpoint list mismatch: {11, 13} {1, 2}\r\n2024-12-05 15:32:42.136 DEBUG (MainThread) [zigpy.quirks.registry] Checking quirks for Jasco Products 43084 (08:6b:d7:ff:fe:47:1d:c9)\r\n2024-12-05 15:32:42.136 DEBUG (MainThread) [zigpy.quirks.registry] Considering <class 'zhaquirks.xbee.xbee_io.XBeeSensor'>\r\n2024-12-05 15:32:42.136 DEBUG (MainThread) [zigpy.quirks] Fail because endpoint list mismatch: {232, 230} {1, 2, 242}\r\n2024-12-05 15:32:42.136 DEBUG (MainThread) [zigpy.quirks.registry] Considering <class 'zhaquirks.xbee.xbee3_io.XBee3Sensor'>\r\n2024-12-05 15:32:42.136 DEBUG (MainThread) [zigpy.quirks] Fail because endpoint list mismatch: {232, 230} {1, 2, 242}\r\n2024-12-05 15:32:42.136 DEBUG (MainThread) [zigpy.quirks.registry] Considering <class 'zhaquirks.tuya.ts0201.MoesTemperatureHumidtySensorWithScreen'>\r\n2024-12-05 15:32:42.136 DEBUG (MainThread) [zigpy.quirks] Fail because endpoint list mismatch: {1} {1, 2, 242}\r\n2024-12-05 15:32:42.136 DEBUG (MainThread) [zigpy.quirks.registry] Considering <class 'zhaquirks.smartthings.tag_v4.SmartThingsTagV4'>\r\n2024-12-05 15:32:42.136 DEBUG (MainThread) [zigpy.quirks] Fail because endpoint list mismatch: {1} {1, 2, 242}\r\n2024-12-05 15:32:42.137 DEBUG (MainThread) [zigpy.quirks.registry] Considering <class 'zhaquirks.smartthings.multi.SmartthingsMultiPurposeSensor'>\r\n2024-12-05 15:32:42.137 DEBUG (MainThread) [zigpy.quirks] Fail because endpoint list mismatch: {1} {1, 2, 242}\r\n2024-12-05 15:32:42.137 DEBUG (MainThread) [zigpy.quirks.registry] Considering <class 'zhaquirks.netvox.z308e3ed.Z308E3ED'>\r\n2024-12-05 15:32:42.137 DEBUG (MainThread) [zigpy.quirks] Fail because endpoint list mismatch: {1} {1, 2, 242}\r\n2024-12-05 15:32:42.137 DEBUG (MainThread) [zigpy.quirks.registry] Considering <class 'zhaquirks.gledopto.soposhgu10.SoposhGU10'>\r\n2024-12-05 15:32:42.137 DEBUG (MainThread) [zigpy.quirks] Fail because endpoint list mismatch: {11, 13} {1, 2, 242}\r\n2024-12-05 15:32:42.137 DEBUG (MainThread) [zigpy.quirks.registry] Checking quirks for SmartThings outletv4 (24:fd:5b:00:01:05:05:e7)\r\n2024-12-05 15:32:42.137 DEBUG (MainThread) [zigpy.quirks.registry] Considering <class 'zhaquirks.xbee.xbee_io.XBeeSensor'>\r\n2024-12-05 15:32:42.137 DEBUG (MainThread) [zigpy.quirks] Fail because endpoint list mismatch: {232, 230} {1}\r\n2024-12-05 15:32:42.137 DEBUG (MainThread) [zigpy.quirks.registry] Considering <class 'zhaquirks.xbee.xbee3_io.XBee3Sensor'>\r\n2024-12-05 15:32:42.137 DEBUG (MainThread) [zigpy.quirks] Fail because endpoint list mismatch: {232, 230} {1}\r\n2024-12-05 15:32:42.137 DEBUG (MainThread) [zigpy.quirks.registry] Considering <class 'zhaquirks.tuya.ts0201.MoesTemperatureHumidtySensorWithScreen'>\r\n2024-12-05 15:32:42.137 DEBUG (MainThread) [zigpy.quirks] Fail because device_type mismatch on at least one endpoint\r\n2024-12-05 15:32:42.137 DEBUG (MainThread) [zigpy.quirks.registry] Considering <class 'zhaquirks.smartthings.tag_v4.SmartThingsTagV4'>\r\n2024-12-05 15:32:42.137 DEBUG (MainThread) [zigpy.quirks] Fail because device_type mismatch on at least one endpoint\r\n2024-12-05 15:32:42.137 DEBUG (MainThread) [zigpy.quirks.registry] Considering <class 'zhaquirks.smartthings.multi.SmartthingsMultiPurposeSensor'>\r\n2024-12-05 15:32:42.137 DEBUG (MainThread) [zigpy.quirks] Fail because device_type mismatch on at least one endpoint\r\n2024-12-05 15:32:42.137 DEBUG (MainThread) [zigpy.quirks.registry] Considering <class 'zhaquirks.netvox.z308e3ed.Z308E3ED'>\r\n2024-12-05 15:32:42.137 DEBUG (MainThread) [zigpy.quirks] Fail because device_type mismatch on at least one endpoint\r\n2024-12-05 15:32:42.137 DEBUG (MainThread) [zigpy.quirks.registry] Considering <class 'zhaquirks.gledopto.soposhgu10.SoposhGU10'>\r\n2024-12-05 15:32:42.137 DEBUG (MainThread) [zigpy.quirks] Fail because endpoint list mismatch: {11, 13} {1}\r\n2024-12-05 15:32:42.137 DEBUG (MainThread) [zigpy.quirks.registry] Checking quirks for innr SP 224 (90:fd:9f:ff:fe:61:7b:5f)\r\n2024-12-05 15:32:42.137 DEBUG (MainThread) [zigpy.quirks.registry] Considering <class 'zhaquirks.xbee.xbee_io.XBeeSensor'>\r\n2024-12-05 15:32:42.137 DEBUG (MainThread) [zigpy.quirks] Fail because endpoint list mismatch: {232, 230} {1, 242}\r\n2024-12-05 15:32:42.137 DEBUG (MainThread) [zigpy.quirks.registry] Considering <class 'zhaquirks.xbee.xbee3_io.XBee3Sensor'>\r\n2024-12-05 15:32:42.137 DEBUG (MainThread) [zigpy.quirks] Fail because endpoint list mismatch: {232, 230} {1, 242}\r\n2024-12-05 15:32:42.137 DEBUG (MainThread) [zigpy.quirks.registry] Considering <class 'zhaquirks.tuya.ts0201.MoesTemperatureHumidtySensorWithScreen'>\r\n2024-12-05 15:32:42.137 DEBUG (MainThread) [zigpy.quirks] Fail because endpoint list mismatch: {1} {1, 242}\r\n2024-12-05 15:32:42.137 DEBUG (MainThread) [zigpy.quirks.registry] Considering <class 'zhaquirks.smartthings.tag_v4.SmartThingsTagV4'>\r\n2024-12-05 15:32:42.137 DEBUG (MainThread) [zigpy.quirks] Fail because endpoint list mismatch: {1} {1, 242}\r\n2024-12-05 15:32:42.137 DEBUG (MainThread) [zigpy.quirks.registry] Considering <class 'zhaquirks.smartthings.multi.SmartthingsMultiPurposeSensor'>\r\n2024-12-05 15:32:42.137 DEBUG (MainThread) [zigpy.quirks] Fail because endpoint list mismatch: {1} {1, 242}\r\n2024-12-05 15:32:42.137 DEBUG (MainThread) [zigpy.quirks.registry] Considering <class 'zhaquirks.netvox.z308e3ed.Z308E3ED'>\r\n2024-12-05 15:32:42.137 DEBUG (MainThread) [zigpy.quirks] Fail because endpoint list mismatch: {1} {1, 242}\r\n2024-12-05 15:32:42.138 DEBUG (MainThread) [zigpy.quirks.registry] Considering <class 'zhaquirks.gledopto.soposhgu10.SoposhGU10'>\r\n2024-12-05 15:32:42.138 DEBUG (MainThread) [zigpy.quirks] Fail because endpoint list mismatch: {11, 13} {1, 242}\r\n2024-12-05 15:32:42.138 DEBUG (MainThread) [zigpy.quirks.registry] Checking quirks for innr SP 224 (90:fd:9f:ff:fe:66:87:1b)\r\n2024-12-05 15:32:42.138 DEBUG (MainThread) [zigpy.quirks.registry] Considering <class 'zhaquirks.xbee.xbee_io.XBeeSensor'>\r\n2024-12-05 15:32:42.138 DEBUG (MainThread) [zigpy.quirks] Fail because endpoint list mismatch: {232, 230} {1, 242}\r\n2024-12-05 15:32:42.138 DEBUG (MainThread) [zigpy.quirks.registry] Considering <class 'zhaquirks.xbee.xbee3_io.XBee3Sensor'>\r\n2024-12-05 15:32:42.138 DEBUG (MainThread) [zigpy.quirks] Fail because endpoint list mismatch: {232, 230} {1, 242}\r\n2024-12-05 15:32:42.138 DEBUG (MainThread) [zigpy.quirks.registry] Considering <class 'zhaquirks.tuya.ts0201.MoesTemperatureHumidtySensorWithScreen'>\r\n2024-12-05 15:32:42.138 DEBUG (MainThread) [zigpy.quirks] Fail because endpoint list mismatch: {1} {1, 242}\r\n2024-12-05 15:32:42.138 DEBUG (MainThread) [zigpy.quirks.registry] Considering <class 'zhaquirks.smartthings.tag_v4.SmartThingsTagV4'>\r\n2024-12-05 15:32:42.138 DEBUG (MainThread) [zigpy.quirks] Fail because endpoint list mismatch: {1} {1, 242}\r\n2024-12-05 15:32:42.138 DEBUG (MainThread) [zigpy.quirks.registry] Considering <class 'zhaquirks.smartthings.multi.SmartthingsMultiPurposeSensor'>\r\n2024-12-05 15:32:42.138 DEBUG (MainThread) [zigpy.quirks] Fail because endpoint list mismatch: {1} {1, 242}\r\n2024-12-05 15:32:42.138 DEBUG (MainThread) [zigpy.quirks.registry] Considering <class 'zhaquirks.netvox.z308e3ed.Z308E3ED'>\r\n2024-12-05 15:32:42.138 DEBUG (MainThread) [zigpy.quirks] Fail because endpoint list mismatch: {1} {1, 242}\r\n2024-12-05 15:32:42.138 DEBUG (MainThread) [zigpy.quirks.registry] Considering <class 'zhaquirks.gledopto.soposhgu10.SoposhGU10'>\r\n2024-12-05 15:32:42.138 DEBUG (MainThread) [zigpy.quirks] Fail because endpoint list mismatch: {11, 13} {1, 242}\r\n2024-12-05 15:32:42.138 DEBUG (Thread-229) [aiosqlite] executing functools.partial(<built-in method execute of sqlite3.Connection object at 0x7fb587cb09a0>, 'SELECT * FROM attributes_cache_v13', [])\r\n2024-12-05 15:32:42.139 DEBUG (Thread-229) [aiosqlite] operation functools.partial(<built-in method execute of sqlite3.Connection object at 0x7fb587cb09a0>, 'SELECT * FROM attributes_cache_v13', []) completed\r\n2024-12-05 15:32:42.140 DEBUG (Thread-229) [aiosqlite] executing functools.partial(<built-in method fetchmany of sqlite3.Cursor object at 0x7fb59594ea40>, 64)\r\n2024-12-05 15:32:42.149 DEBUG (Thread-229) [aiosqlite] operation functools.partial(<built-in method fetchmany of sqlite3.Cursor object at 0x7fb59594ea40>, 64) completed\n```\n\n\n### Additional information\n\nPlease let me know what I can do to get you the info you need to resolve issue.\n", "hints_text": "me too After updating to Core Update 2024.12.0  zigbee do not work and I've  \"error during setup of component stream\"\r\n\r\ncf(132168)\nSame here. ZHA failed to initialize. I rolled back to previous core version and it came back .\nHi Guys,  I had the same issue and possibly still do :-) I have removed (Deleted) all custom quirks and the system now starts without error and all the devices not requiring custom quirks appear to be functioning normally.  I'll introduce the quirks back and see what happens\n> Hi Guys, I had the same issue and possibly still do :-) I have removed (Deleted) all custom quirks and the system now starts without error and all the devices not requiring custom quirks appear to be functioning normally. I'll introduce the quirks back and see what happens\r\n\r\nI too have 1 custom quirk. I wonder if that is the main issue\nBetter just back it up somewhere and delete it and see what happens\nHi Guys my issue is to do with the Aqara FP1E custom quirk which I recently added.  The system boots ok with just 1 other quirk which is for a energy monitoring device.\nI too have the same quirk that I installed a couple weeks ago. Hope we can get a fix for this\nIt appears that this custom quirk is no longer required.  Having deleted it the Aqara FP1E still appears to be recognised by the zigbee integration.  All of the entities are there.  One assume HA doesn't like the duplication.  One to put away for future issues.\r\n\nThis must be new. I just install my fp1e and it had no exposed entities until I came across the custom quirks for it.  I will try what you did and see if it works. I'll just comment out my quirk for now\nObviously the fp1e must now be in the database, I didn't have to re install it just found it including entities\nAll working now. Thank you for the guidance\nI did roll back too and now things work again.\nHave the same issue, how can i remove the quirk?\r\nI see a couple of them in the Device Zigbee Info: zhaquirks\r\nDo i have to remove the devices?\nHave you added a custom quirk for the aqara FP1E ?  If you did I would start by removing just that one.\r\n\r\nUse file editor and go to config/custom_zha_quirks/ you should find your custom quirks in there select the quirk you want to remove, click on the 3 dots and select delete.  Its really the reverse of when you added the custom quirk in the first place.\nI don\u00b4t have this Aquara FP1E. I have a couple Power Outlet's, Radiator thermostat's, Temp Humi Sensors, Windows Sensores that's it.\r\nAnd i don't have the folder or file config/custom_zha_quirks/\r\nBut exacte the issue after update. Zigbee won't start.\r\nI install the backup from last night. With the 2024.11.2\nLooks like your issue is slightly different to ours.  If I were you I would try removing each of those devices in turn until you get a working system. You obviously have a working backup so you can always go back to that.  Hopefully by a process of elimination you will find the offending device  then you can  add that back in again.  Probably someone with more experience can guide you to another solution looking at logs etc.  I hope this helps.\nOk, thank you for the help.\n\nHey there @dmulcahey, @adminiuga, @puddly, @thejulianjes, mind taking a look at this issue as it has been labeled with an integration (`zha`) you are listed as a [code owner](https://github.com/home-assistant/core/blob/dev/CODEOWNERS#L1742) for? Thanks!\n\n<details>\n<summary>Code owner commands</summary>\n\n\nCode owners of `zha` can trigger bot actions by commenting:\n\n- `@home-assistant close` Closes the issue.\n- `@home-assistant rename Awesome new title` Renames the issue.\n- `@home-assistant reopen` Reopen the issue.\n- `@home-assistant unassign zha` Removes the current integration label and assignees on the issue, add the integration domain after the command.\n- `@home-assistant add-label needs-more-information` Add a label (needs-more-information, problem in dependency, problem in custom component) to the issue.\n- `@home-assistant remove-label needs-more-information` Remove a label (needs-more-information, problem in dependency, problem in custom component) on the issue.\n\n</details>\n\n\n<sub><sup>(message by CodeOwnersMention)</sup></sub>\n\n---\n\n[zha documentation](https://www.home-assistant.io/integrations/zha)\n[zha source](https://github.com/home-assistant/core/tree/dev/homeassistant/components/zha)\n<sub><sup>(message by IssueLinks)</sup></sub>\nThe logs in the initial issue aren't complete. There's nothing wrong in that log snippet.\r\n\r\nAlso note that installing custom quirks is only intended for development and basic testing. Always remove all custom quirks first before reporting any issues.\r\nIn this case, the Aqara FP1E quirk was merged upstream. As it's a v2 quirk, it'll conflict if the custom quirk is loaded at the same time. You should remove the custom quirk now.\nI'm having the same issue. \r\n\r\nI don't have quirks, the config/custom_zha_quirks/ folder, or the FP1E device mentioned. I installed 2024.12.0 and ZHA failed to setup, reverted back to 2024.11.3 and everything worked again. I even reverted back to 2024.11, deleted every ZigBee device, deleted the zigbee.db folder, turned off auto add new devices, rebooted, updated to 2024.12.0, and ZHA still didn't setup.\r\n\r\nI'm using a Aeotec Zi-Stick, 7 Aqara temperature sensors, 2 Aqara water leak sensors, 3 Aqara vibration sensors, and 2 Philips Hue plugs.\nDeleting `zigbee.db` manually is rarely a good idea. We need some logs to see what issue you're running into.\nZigbee.db has only had one line of code in it every time I've checked it. \n\n'utf-8' codec can't decode byte 0x94 in position 27: invalid start byte\nYeah, `db` stands for `database`. It's an SQLite database that you can't open in a text editor.\r\nIt has information for all your devices (e.g. signature), attribute cache, coordinator backups, group info, and more. It's crucial for ZHA to work correctly. If you've deleted it, restore a backup where it was still present.\nYeah, that's already been done, back to 2024.11.3, stable and fully functional.\n\nAny idea on why 2024.12 is having issues?\nLike I said, we need logs with an error to say anything about your issue.\r\nAlso, what coordinator are you using?\nI've the same issue since 2024.12.0 and 2024.12.1. Reverting back to 2024.11.3 resolves the issue. (HAOS 14.0)\r\nIn the UI this error message: \r\n![image](https://github.com/user-attachments/assets/d52b14e1-15db-4a5e-87b6-115bc2a61ea5)\r\nI'm using netsocket to SilverCrest Zigbee Gateway, EZSP protocol. Not using any custom quirks\r\n\r\nAttached the debuglog (zigpy/quirks/bellows. Mostly unfiltered. Hope it helps\r\n[home-assistant_zha_2024-12-07T10-33-55.313Z.log](https://github.com/user-attachments/files/18048038/home-assistant_zha_2024-12-07T10-33-55.313Z.log)\r\n\nSilverCrest Zigbee Gateway too !   same problem    look at https://github.com/home-assistant/core/issues/132168\r\n\r\nperhaps just a problem of version of python...   I'm waiting for confirmation...\n\r\n[home-assistant_zha_2024-12-07T11-05-32.431Z.log](https://github.com/user-attachments/files/18048577/home-assistant_zha_2024-12-07T11-05-32.431Z.log)\r\nSame SilverCrest Zigbee Gateway, and same issue.\r\n![zigbee](https://github.com/user-attachments/assets/c0a8ccea-d126-44a7-a4d3-1c359d918de8)\r\nSame issue with 2024.12.0 and 2024.12.1\n> SilverCrest Zigbee Gateway too ! same problem look at #132168\r\n> \r\n> perhaps just a problem of version of python... I'm waiting for confirmation...\r\nIssue #132168 seems unrelated to zigpy.\r\n\r\nUpload your debuglog in a post, this would help the developers....\r\n![image](https://github.com/user-attachments/assets/ba069d4a-a513-43b4-9020-a6e4ac603fdd)\r\n\nSame error with Silvercrest gateway on 2024.12.0 and just confirmed and captured debug logs on 2024.12.1, too. Rolling back to 2024.11.3 works fine again.\r\n\r\n\" Failed setup, will retry: <XncpCommandId.undefined_0x03e8: 1000> \"\r\n\r\n```\r\n2024-12-07 12:46:05.587 DEBUG (MainThread) [homeassistant.components.zha] Failed to set up ZHA\r\nTraceback (most recent call last):\r\n  File \"/usr/src/homeassistant/homeassistant/components/zha/__init__.py\", line 151, in async_setup_entry\r\n    await zha_gateway.async_initialize()\r\n  File \"/usr/local/lib/python3.13/site-packages/zha/application/gateway.py\", line 275, in async_initialize\r\n    await self._async_initialize()\r\n  File \"/usr/local/lib/python3.13/site-packages/zha/application/gateway.py\", line 258, in _async_initialize\r\n    await self.application_controller.startup(auto_form=True)\r\n  File \"/usr/local/lib/python3.13/site-packages/zigpy/application.py\", line 221, in startup\r\n    await self.initialize(auto_form=auto_form)\r\n  File \"/usr/local/lib/python3.13/site-packages/zigpy/application.py\", line 145, in initialize\r\n    await self.load_network_info(load_devices=False)\r\n  File \"/usr/local/lib/python3.13/site-packages/bellows/zigbee/application.py\", line 303, in load_network_info\r\n    flow_control = await self._ezsp.xncp_get_flow_control_type()\r\n                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/local/lib/python3.13/site-packages/bellows/ezsp/__init__.py\", line 705, in xncp_get_flow_control_type\r\n    rsp = await self.send_xncp_frame(xncp.GetFlowControlTypeReq())\r\n          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/local/lib/python3.13/site-packages/bellows/ezsp/__init__.py\", line 663, in send_xncp_frame\r\n    rsp_frame = xncp.XncpCommand.from_bytes(data)\r\n  File \"/usr/local/lib/python3.13/site-packages/bellows/ezsp/xncp.py\", line 70, in from_bytes\r\n    payload, rest = COMMANDS[command_id].deserialize(data)\r\n                    ~~~~~~~~^^^^^^^^^^^^\r\nKeyError: <XncpCommandId.undefined_0x03e8: 1000>\r\n```\r\n\r\n[home-assistant_zha_2024-12-07T12-45-50.516Z.log](https://github.com/user-attachments/files/18048367/home-assistant_zha_2024-12-07T12-45-50.516Z.log)\n2024-12-06 22:01:33.298 DEBUG (MainThread) [homeassistant.components.zha] Failed to set up ZHA\r\nTraceback (most recent call last):\r\n  File \"/usr/src/homeassistant/homeassistant/components/zha/__init__.py\", line 151, in async_setup_entry\r\n    await zha_gateway.async_initialize()\r\n  File \"/usr/local/lib/python3.13/site-packages/zha/application/gateway.py\", line 275, in async_initialize\r\n    await self._async_initialize()\r\n  File \"/usr/local/lib/python3.13/site-packages/zha/application/gateway.py\", line 258, in _async_initialize\r\n    await self.application_controller.startup(auto_form=True)\r\n  File \"/usr/local/lib/python3.13/site-packages/zigpy/application.py\", line 221, in startup\r\n    await self.initialize(auto_form=auto_form)\r\n  File \"/usr/local/lib/python3.13/site-packages/zigpy/application.py\", line 145, in initialize\r\n    await self.load_network_info(load_devices=False)\r\n  File \"/usr/local/lib/python3.13/site-packages/bellows/zigbee/application.py\", line 303, in load_network_info\r\n    flow_control = await self._ezsp.xncp_get_flow_control_type()\r\n                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/local/lib/python3.13/site-packages/bellows/ezsp/__init__.py\", line 705, in xncp_get_flow_control_type\r\n    rsp = await self.send_xncp_frame(xncp.GetFlowControlTypeReq())\r\n          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/local/lib/python3.13/site-packages/bellows/ezsp/__init__.py\", line 663, in send_xncp_frame\r\n    rsp_frame = xncp.XncpCommand.from_bytes(data)\r\n  File \"/usr/local/lib/python3.13/site-packages/bellows/ezsp/xncp.py\", line 70, in from_bytes\r\n    payload, rest = COMMANDS[command_id].deserialize(data)\r\n                    ~~~~~~~~^^^^^^^^^^^^\r\nKeyError: <XncpCommandId.undefined_0x03e8: 1000>\r\n2024-12-06 22:01:33.305 INFO (MainThread) [universal_silabs_flasher.flasher] Probing ApplicationType.GECKO_BOOTLOADER at 115200 baud\r\n2024-12-06 22:01:33.305 DEBUG (MainThread) [zigpy.serial] Opening a serial connection to '/dev/serial/by-id/usb-1a86_USB_Serial-if00-port0' (baudrate=115200, xonxoff=False, rtscts=False)\r\n2024-12-06 22:01:33.310 DEBUG (MainThread) [zigpy.serial] Connection made: SerialTransport(<_UnixSelectorEventLoop running=True closed=False debug=False>, <universal_silabs_flasher.gecko_bootloader.GeckoBootloaderProtocol object at 0x7fa34577f9d0>, Serial<id=0x7fa31e6ef070, open=True>(port='/dev/serial/by-id/usb-1a86_USB_Serial-if00-port0', baudrate=115200, bytesize=8, parity='N', stopbits=1, timeout=0, xonxoff=False, rtscts=False, dsrdtr=False))\r\n2024-12-06 22:01:33.310 DEBUG (MainThread) [universal_silabs_flasher.gecko_bootloader] Sending data b'\\n'\r\n2024-12-06 22:01:33.311 DEBUG (MainThread) [universal_silabs_flasher.gecko_bootloader] Sending data GeckoBootloaderOption.EBL_INFO\r\n2024-12-06 22:01:35.311 DEBUG (MainThread) [zigpy.serial] Waiting for serial port to close\r\n2024-12-06 22:01:35.312 DEBUG (MainThread) [zigpy.serial] Connection lost: None\r\n2024-12-06 22:01:35.312 INFO (MainThread) [universal_silabs_flasher.flasher] Probing ApplicationType.CPC at 460800 baud\r\n2024-12-06 22:01:35.312 DEBUG (MainThread) [zigpy.serial] Opening a serial connection to '/dev/serial/by-id/usb-1a86_USB_Serial-if00-port0' (baudrate=460800, xonxoff=False, rtscts=False)\r\n2024-12-06 22:01:35.315 DEBUG (MainThread) [zigpy.serial] Connection made: SerialTransport(<_UnixSelectorEventLoop running=True closed=False debug=False>, <universal_silabs_flasher.cpc.CPCProtocol object at 0x7fa3321355b0>, Serial<id=0x7fa336f088e0, open=True>(port='/dev/serial/by-id/usb-1a86_USB_Serial-if00-port0', baudrate=460800, bytesize=8, parity='N', stopbits=1, timeout=0, xonxoff=False, rtscts=False, dsrdtr=False))\r\n2024-12-06 22:01:35.315 DEBUG (MainThread) [universal_silabs_flasher.cpc] Sending frame CPCTransportFrame(endpoint=<EndpointId.SYSTEM: 0>, control=196, payload=UnnumberedFrame(command_id=<UnnumberedFrameCommandId.PROP_VALUE_GET: 2>, command_seq=0, payload=PropertyCommand(property_id=<PropertyId.SECONDARY_CPC_VERSION: 3>, value=b'')))\r\n2024-12-06 22:01:35.316 DEBUG (MainThread) [universal_silabs_flasher.cpc] Sending data b'\\x14\\x00\\n\\x00\\xc4U\\xd3\\x02\\x00\\x04\\x00\\x03\\x00\\x00\\x00\\xdb\\x12'\r\n2024-12-06 22:01:36.316 DEBUG (MainThread) [universal_silabs_flasher.cpc] Failed to send CPCTransportFrame(endpoint=<EndpointId.SYSTEM: 0>, control=196, payload=UnnumberedFrame(command_id=<UnnumberedFrameCommandId.PROP_VALUE_GET: 2>, command_seq=0, payload=PropertyCommand(property_id=<PropertyId.SECONDARY_CPC_VERSION: 3>, value=b''))), trying again in 0.10s (attempt 1 of 4)\r\n2024-12-06 22:01:36.417 DEBUG (MainThread) [universal_silabs_flasher.cpc] Sending frame CPCTransportFrame(endpoint=<EndpointId.SYSTEM: 0>, control=196, payload=UnnumberedFrame(command_id=<UnnumberedFrameCommandId.PROP_VALUE_GET: 2>, command_seq=0, payload=PropertyCommand(property_id=<PropertyId.SECONDARY_CPC_VERSION: 3>, value=b'')))\r\n2024-12-06 22:01:36.417 DEBUG (MainThread) [universal_silabs_flasher.cpc] Sending data b'\\x14\\x00\\n\\x00\\xc4U\\xd3\\x02\\x00\\x04\\x00\\x03\\x00\\x00\\x00\\xdb\\x12'\r\n2024-12-06 22:01:37.418 DEBUG (MainThread) [universal_silabs_flasher.cpc] Failed to send CPCTransportFrame(endpoint=<EndpointId.SYSTEM: 0>, control=196, payload=UnnumberedFrame(command_id=<UnnumberedFrameCommandId.PROP_VALUE_GET: 2>, command_seq=0, payload=PropertyCommand(property_id=<PropertyId.SECONDARY_CPC_VERSION: 3>, value=b''))), trying again in 0.10s (attempt 2 of 4)\r\n2024-12-06 22:01:37.519 DEBUG (MainThread) [universal_silabs_flasher.cpc] Sending frame CPCTransportFrame(endpoint=<EndpointId.SYSTEM: 0>, control=196, payload=UnnumberedFrame(command_id=<UnnumberedFrameCommandId.PROP_VALUE_GET: 2>, command_seq=0, payload=PropertyCommand(property_id=<PropertyId.SECONDARY_CPC_VERSION: 3>, value=b'')))\r\n2024-12-06 22:01:37.519 DEBUG (MainThread) [universal_silabs_flasher.cpc] Sending data b'\\x14\\x00\\n\\x00\\xc4U\\xd3\\x02\\x00\\x04\\x00\\x03\\x00\\x00\\x00\\xdb\\x12'\r\n2024-12-06 22:01:38.519 DEBUG (MainThread) [universal_silabs_flasher.cpc] Failed to send CPCTransportFrame(endpoint=<EndpointId.SYSTEM: 0>, control=196, payload=UnnumberedFrame(command_id=<UnnumberedFrameCommandId.PROP_VALUE_GET: 2>, command_seq=0, payload=PropertyCommand(property_id=<PropertyId.SECONDARY_CPC_VERSION: 3>, value=b''))), trying again in 0.10s (attempt 3 of 4)\r\n2024-12-06 22:01:38.620 DEBUG (MainThread) [universal_silabs_flasher.cpc] Sending frame CPCTransportFrame(endpoint=<EndpointId.SYSTEM: 0>, control=196, payload=UnnumberedFrame(command_id=<UnnumberedFrameCommandId.PROP_VALUE_GET: 2>, command_seq=0, payload=PropertyCommand(property_id=<PropertyId.SECONDARY_CPC_VERSION: 3>, value=b'')))\r\n2024-12-06 22:01:38.620 DEBUG (MainThread) [universal_silabs_flasher.cpc] Sending data b'\\x14\\x00\\n\\x00\\xc4U\\xd3\\x02\\x00\\x04\\x00\\x03\\x00\\x00\\x00\\xdb\\x12'\r\n2024-12-06 22:01:39.622 DEBUG (MainThread) [universal_silabs_flasher.cpc] Failed to send CPCTransportFrame(endpoint=<EndpointId.SYSTEM: 0>, control=196, payload=UnnumberedFrame(command_id=<UnnumberedFrameCommandId.PROP_VALUE_GET: 2>, command_seq=0, payload=PropertyCommand(property_id=<PropertyId.SECONDARY_CPC_VERSION: 3>, value=b''))), trying again in 0.10s (attempt 4 of 4)\r\n2024-12-06 22:01:39.622 DEBUG (MainThread) [zigpy.serial] Waiting for serial port to close\r\n2024-12-06 22:01:39.622 DEBUG (MainThread) [zigpy.serial] Connection lost: None\r\n2024-12-06 22:01:39.622 INFO (MainThread) [universal_silabs_flasher.flasher] Probing ApplicationType.CPC at 115200 baud\r\n2024-12-06 22:01:39.623 DEBUG (MainThread) [zigpy.serial] Opening a serial connection to '/dev/serial/by-id/usb-1a86_USB_Serial-if00-port0' (baudrate=115200, xonxoff=False, rtscts=False)\r\n2024-12-06 22:01:39.626 DEBUG (MainThread) [zigpy.serial] Connection made: SerialTransport(<_UnixSelectorEventLoop running=True closed=False debug=False>, <universal_silabs_flasher.cpc.CPCProtocol object at 0x7fa3321355b0>, Serial<id=0x7fa323a71cc0, open=True>(port='/dev/serial/by-id/usb-1a86_USB_Serial-if00-port0', baudrate=115200, bytesize=8, parity='N', stopbits=1, timeout=0, xonxoff=False, rtscts=False, dsrdtr=False))\r\n2024-12-06 22:01:39.626 DEBUG (MainThread) [universal_silabs_flasher.cpc] Sending frame CPCTransportFrame(endpoint=<EndpointId.SYSTEM: 0>, control=196, payload=UnnumberedFrame(command_id=<UnnumberedFrameCommandId.PROP_VALUE_GET: 2>, command_seq=0, payload=PropertyCommand(property_id=<PropertyId.SECONDARY_CPC_VERSION: 3>, value=b'')))\r\n2024-12-06 22:01:39.626 DEBUG (MainThread) [universal_silabs_flasher.cpc] Sending data b'\\x14\\x00\\n\\x00\\xc4U\\xd3\\x02\\x00\\x04\\x00\\x03\\x00\\x00\\x00\\xdb\\x12'\r\n2024-12-06 22:01:40.627 DEBUG (MainThread) [universal_silabs_flasher.cpc] Failed to send CPCTransportFrame(endpoint=<EndpointId.SYSTEM: 0>, control=196, payload=UnnumberedFrame(command_id=<UnnumberedFrameCommandId.PROP_VALUE_GET: 2>, command_seq=0, payload=PropertyCommand(property_id=<PropertyId.SECONDARY_CPC_VERSION: 3>, value=b''))), trying again in 0.10s (attempt 1 of 4)\r\n2024-12-06 22:01:40.727 DEBUG (MainThread) [universal_silabs_flasher.cpc] Sending frame CPCTransportFrame(endpoint=<EndpointId.SYSTEM: 0>, control=196, payload=UnnumberedFrame(command_id=<UnnumberedFrameCommandId.PROP_VALUE_GET: 2>, command_seq=0, payload=PropertyCommand(property_id=<PropertyId.SECONDARY_CPC_VERSION: 3>, value=b'')))\r\n2024-12-06 22:01:40.728 DEBUG (MainThread) [universal_silabs_flasher.cpc] Sending data b'\\x14\\x00\\n\\x00\\xc4U\\xd3\\x02\\x00\\x04\\x00\\x03\\x00\\x00\\x00\\xdb\\x12'\r\n2024-12-06 22:01:41.729 DEBUG (MainThread) [universal_silabs_flasher.cpc] Failed to send CPCTransportFrame(endpoint=<EndpointId.SYSTEM: 0>, control=196, payload=UnnumberedFrame(command_id=<UnnumberedFrameCommandId.PROP_VALUE_GET: 2>, command_seq=0, payload=PropertyCommand(property_id=<PropertyId.SECONDARY_CPC_VERSION: 3>, value=b''))), trying again in 0.10s (attempt 2 of 4)\r\n2024-12-06 22:01:41.830 DEBUG (MainThread) [universal_silabs_flasher.cpc] Sending frame CPCTransportFrame(endpoint=<EndpointId.SYSTEM: 0>, control=196, payload=UnnumberedFrame(command_id=<UnnumberedFrameCommandId.PROP_VALUE_GET: 2>, command_seq=0, payload=PropertyCommand(property_id=<PropertyId.SECONDARY_CPC_VERSION: 3>, value=b'')))\r\n2024-12-06 22:01:41.830 DEBUG (MainThread) [universal_silabs_flasher.cpc] Sending data b'\\x14\\x00\\n\\x00\\xc4U\\xd3\\x02\\x00\\x04\\x00\\x03\\x00\\x00\\x00\\xdb\\x12'\r\n2024-12-06 22:01:42.832 DEBUG (MainThread) [universal_silabs_flasher.cpc] Failed to send CPCTransportFrame(endpoint=<EndpointId.SYSTEM: 0>, control=196, payload=UnnumberedFrame(command_id=<UnnumberedFrameCommandId.PROP_VALUE_GET: 2>, command_seq=0, payload=PropertyCommand(property_id=<PropertyId.SECONDARY_CPC_VERSION: 3>, value=b''))), trying again in 0.10s (attempt 3 of 4)\r\n2024-12-06 22:01:42.932 DEBUG (MainThread) [universal_silabs_flasher.cpc] Sending frame CPCTransportFrame(endpoint=<EndpointId.SYSTEM: 0>, control=196, payload=UnnumberedFrame(command_id=<UnnumberedFrameCommandId.PROP_VALUE_GET: 2>, command_seq=0, payload=PropertyCommand(property_id=<PropertyId.SECONDARY_CPC_VERSION: 3>, value=b'')))\r\n2024-12-06 22:01:42.932 DEBUG (MainThread) [universal_silabs_flasher.cpc] Sending data b'\\x14\\x00\\n\\x00\\xc4U\\xd3\\x02\\x00\\x04\\x00\\x03\\x00\\x00\\x00\\xdb\\x12'\r\n2024-12-06 22:01:43.933 DEBUG (MainThread) [universal_silabs_flasher.cpc] Failed to send CPCTransportFrame(endpoint=<EndpointId.SYSTEM: 0>, control=196, payload=UnnumberedFrame(command_id=<UnnumberedFrameCommandId.PROP_VALUE_GET: 2>, command_seq=0, payload=PropertyCommand(property_id=<PropertyId.SECONDARY_CPC_VERSION: 3>, value=b''))), trying again in 0.10s (attempt 4 of 4)\r\n2024-12-06 22:01:43.934 DEBUG (MainThread) [zigpy.serial] Waiting for serial port to close\r\n2024-12-06 22:01:43.934 DEBUG (MainThread) [zigpy.serial] Connection lost: None\r\n2024-12-06 22:01:43.934 INFO (MainThread) [universal_silabs_flasher.flasher] Probing ApplicationType.CPC at 230400 baud\r\n2024-12-06 22:01:43.934 DEBUG (MainThread) [zigpy.serial] Opening a serial connection to '/dev/serial/by-id/usb-1a86_USB_Serial-if00-port0' (baudrate=230400, xonxoff=False, rtscts=False)\r\n2024-12-06 22:01:43.939 DEBUG (MainThread) [zigpy.serial] Connection made: SerialTransport(<_UnixSelectorEventLoop running=True closed=False debug=False>, <universal_silabs_flasher.cpc.CPCProtocol object at 0x7fa36fa73650>, Serial<id=0x7fa32aa03c40, open=True>(port='/dev/serial/by-id/usb-1a86_USB_Serial-if00-port0', baudrate=230400, bytesize=8, parity='N', stopbits=1, timeout=0, xonxoff=False, rtscts=False, dsrdtr=False))\r\n2024-12-06 22:01:43.939 DEBUG (MainThread) [universal_silabs_flasher.cpc] Sending frame CPCTransportFrame(endpoint=<EndpointId.SYSTEM: 0>, control=196, payload=UnnumberedFrame(command_id=<UnnumberedFrameCommandId.PROP_VALUE_GET: 2>, command_seq=0, payload=PropertyCommand(property_id=<PropertyId.SECONDARY_CPC_VERSION: 3>, value=b'')))\r\n2024-12-06 22:01:43.939 DEBUG (MainThread) [universal_silabs_flasher.cpc] Sending data b'\\x14\\x00\\n\\x00\\xc4U\\xd3\\x02\\x00\\x04\\x00\\x03\\x00\\x00\\x00\\xdb\\x12'\r\n2024-12-06 22:01:44.940 DEBUG (MainThread) [universal_silabs_flasher.cpc] Failed to send CPCTransportFrame(endpoint=<EndpointId.SYSTEM: 0>, control=196, payload=UnnumberedFrame(command_id=<UnnumberedFrameCommandId.PROP_VALUE_GET: 2>, command_seq=0, payload=PropertyCommand(property_id=<PropertyId.SECONDARY_CPC_VERSION: 3>, value=b''))), trying again in 0.10s (attempt 1 of 4)\r\n2024-12-06 22:01:45.040 DEBUG (MainThread) [universal_silabs_flasher.cpc] Sending frame CPCTransportFrame(endpoint=<EndpointId.SYSTEM: 0>, control=196, payload=UnnumberedFrame(command_id=<UnnumberedFrameCommandId.PROP_VALUE_GET: 2>, command_seq=0, payload=PropertyCommand(property_id=<PropertyId.SECONDARY_CPC_VERSION: 3>, value=b'')))\r\n2024-12-06 22:01:45.041 DEBUG (MainThread) [universal_silabs_flasher.cpc] Sending data b'\\x14\\x00\\n\\x00\\xc4U\\xd3\\x02\\x00\\x04\\x00\\x03\\x00\\x00\\x00\\xdb\\x12'\r\n2024-12-06 22:01:46.042 DEBUG (MainThread) [universal_silabs_flasher.cpc] Failed to send CPCTransportFrame(endpoint=<EndpointId.SYSTEM: 0>, control=196, payload=UnnumberedFrame(command_id=<UnnumberedFrameCommandId.PROP_VALUE_GET: 2>, command_seq=0, payload=PropertyCommand(property_id=<PropertyId.SECONDARY_CPC_VERSION: 3>, value=b''))), trying again in 0.10s (attempt 2 of 4)\r\n2024-12-06 22:01:46.142 DEBUG (MainThread) [universal_silabs_flasher.cpc] Sending frame CPCTransportFrame(endpoint=<EndpointId.SYSTEM: 0>, control=196, payload=UnnumberedFrame(command_id=<UnnumberedFrameCommandId.PROP_VALUE_GET: 2>, command_seq=0, payload=PropertyCommand(property_id=<PropertyId.SECONDARY_CPC_VERSION: 3>, value=b'')))\r\n2024-12-06 22:01:46.143 DEBUG (MainThread) [universal_silabs_flasher.cpc] Sending data b'\\x14\\x00\\n\\x00\\xc4U\\xd3\\x02\\x00\\x04\\x00\\x03\\x00\\x00\\x00\\xdb\\x12'\r\n2024-12-06 22:01:47.145 DEBUG (MainThread) [universal_silabs_flasher.cpc] Failed to send CPCTransportFrame(endpoint=<EndpointId.SYSTEM: 0>, control=196, payload=UnnumberedFrame(command_id=<UnnumberedFrameCommandId.PROP_VALUE_GET: 2>, command_seq=0, payload=PropertyCommand(property_id=<PropertyId.SECONDARY_CPC_VERSION: 3>, value=b''))), trying again in 0.10s (attempt 3 of 4)\r\n2024-12-06 22:01:47.245 DEBUG (MainThread) [universal_silabs_flasher.cpc] Sending frame CPCTransportFrame(endpoint=<EndpointId.SYSTEM: 0>, control=196, payload=UnnumberedFrame(command_id=<UnnumberedFrameCommandId.PROP_VALUE_GET: 2>, command_seq=0, payload=PropertyCommand(property_id=<PropertyId.SECONDARY_CPC_VERSION: 3>, value=b'')))\r\n2024-12-06 22:01:47.245 DEBUG (MainThread) [universal_silabs_flasher.cpc] Sending data b'\\x14\\x00\\n\\x00\\xc4U\\xd3\\x02\\x00\\x04\\x00\\x03\\x00\\x00\\x00\\xdb\\x12'\r\n2024-12-06 22:01:48.246 DEBUG (MainThread) [universal_silabs_flasher.cpc] Failed to send CPCTransportFrame(endpoint=<EndpointId.SYSTEM: 0>, control=196, payload=UnnumberedFrame(command_id=<UnnumberedFrameCommandId.PROP_VALUE_GET: 2>, command_seq=0, payload=PropertyCommand(property_id=<PropertyId.SECONDARY_CPC_VERSION: 3>, value=b''))), trying again in 0.10s (attempt 4 of 4)\r\n2024-12-06 22:01:48.246 DEBUG (MainThread) [zigpy.serial] Waiting for serial port to close\r\n2024-12-06 22:01:48.246 DEBUG (MainThread) [zigpy.serial] Connection lost: None\r\n2024-12-06 22:01:48.247 INFO (MainThread) [universal_silabs_flasher.flasher] Probing ApplicationType.EZSP at 115200 baud\r\n2024-12-06 22:01:48.247 DEBUG (MainThread) [zigpy.serial] Opening a serial connection to '/dev/serial/by-id/usb-1a86_USB_Serial-if00-port0' (baudrate=115200, xonxoff=True, rtscts=False)\r\n2024-12-06 22:01:48.251 DEBUG (MainThread) [zigpy.serial] Connection made: <bellows.ash.AshProtocol object at 0x7fa332135480>\r\n2024-12-06 22:01:48.251 DEBUG (MainThread) [bellows.ezsp] Resetting EZSP\r\n2024-12-06 22:01:48.252 DEBUG (MainThread) [bellows.uart] Resetting ASH\r\n2024-12-06 22:01:48.252 DEBUG (MainThread) [bellows.ash] Sending frame CANCEL + RstFrame() + FLAG\r\n2024-12-06 22:01:48.252 DEBUG (MainThread) [bellows.ash] Sending data  1ac038bc7e\r\n2024-12-06 22:01:49.353 DEBUG (MainThread) [bellows.ash] Received data 1ac1020b0a527e\r\n2024-12-06 22:01:49.353 DEBUG (MainThread) [bellows.ash] Received cancel byte, clearing buffer\r\n2024-12-06 22:01:49.353 DEBUG (MainThread) [bellows.ash] Received frame RStackFrame(version=2, reset_code=<NcpResetCode.RESET_SOFTWARE: 11>)\r\n2024-12-06 22:01:49.353 DEBUG (MainThread) [bellows.ezsp] Switching to EZSP protocol version 4\r\n2024-12-06 22:01:49.353 DEBUG (MainThread) [bellows.ezsp.protocol] Sending command  version: () {'desiredProtocolVersion': 4}\r\n2024-12-06 22:01:49.353 DEBUG (MainThread) [bellows.ash] Sending frame DataFrame(frm_num=0, re_tx=False, ack_num=0, ezsp_frame=b'\\x00\\x00\\x00\\x04') + FLAG\r\n2024-12-06 22:01:49.353 DEBUG (MainThread) [bellows.ash] Sending data  004221a850ed2c7e\r\n2024-12-06 22:01:49.361 DEBUG (MainThread) [bellows.ash] Received data 0142a1a85c2885d8fc557e\r\n2024-12-06 22:01:49.361 DEBUG (MainThread) [bellows.ash] Received frame DataFrame(frm_num=0, re_tx=0, ack_num=1, ezsp_frame=b'\\x00\\x80\\x00\\x08\\x02\\x90j')\r\n2024-12-06 22:01:49.361 DEBUG (MainThread) [bellows.ash] Sending frame AckFrame(res=0, ncp_ready=0, ack_num=1) + FLAG\r\n2024-12-06 22:01:49.361 DEBUG (MainThread) [bellows.ash] Sending data  8160597e\r\n2024-12-06 22:01:49.361 DEBUG (MainThread) [bellows.ezsp.protocol] Received command version: {'protocolVersion': 8, 'stackType': 2, 'stackVersion': 27280}\r\n2024-12-06 22:01:49.361 DEBUG (MainThread) [bellows.ash] Changing ACK timeout from 1.60 to 1.40\r\n2024-12-06 22:01:49.363 DEBUG (MainThread) [bellows.ezsp] Switching to EZSP protocol version 8\r\n2024-12-06 22:01:49.363 DEBUG (MainThread) [bellows.ezsp.protocol] Sending command  version: () {'desiredProtocolVersion': 8}\r\n2024-12-06 22:01:49.363 DEBUG (MainThread) [bellows.ash] Sending frame DataFrame(frm_num=1, re_tx=False, ack_num=1, ezsp_frame=b'\\x00\\x00\\x01\\x00\\x00\\x08') + FLAG\r\n2024-12-06 22:01:49.363 DEBUG (MainThread) [bellows.ash] Sending data  7d314221a9542a1d8cdf7e\r\n2024-12-06 22:01:49.371 DEBUG (MainThread) [bellows.ash] Received data 1242a1a9542a1db0c9fe5b8e7e\r\n2024-12-06 22:01:49.371 DEBUG (MainThread) [bellows.ash] Received frame DataFrame(frm_num=1, re_tx=0, ack_num=2, ezsp_frame=b'\\x00\\x80\\x01\\x00\\x00\\x08\\x02\\x90j')\r\n2024-12-06 22:01:49.371 DEBUG (MainThread) [bellows.ash] Sending frame AckFrame(res=0, ncp_ready=0, ack_num=2) + FLAG\r\n2024-12-06 22:01:49.371 DEBUG (MainThread) [bellows.ash] Sending data  82503a7e\r\n2024-12-06 22:01:49.371 DEBUG (MainThread) [bellows.ezsp.protocol] Received command version: {'protocolVersion': 8, 'stackType': 2, 'stackVersion': 27280}\r\n2024-12-06 22:01:49.373 DEBUG (MainThread) [bellows.ash] Changing ACK timeout from 1.40 to 1.23\r\n2024-12-06 22:01:49.374 DEBUG (MainThread) [bellows.ezsp] EZSP Stack Type: 2, Stack Version: 6a90, Protocol version: 8\r\n2024-12-06 22:01:49.374 DEBUG (MainThread) [bellows.ezsp] Sending XNCP frame: XncpCommand(command_id=<XncpCommandId.GET_SUPPORTED_FEATURES_REQ: 0>, status=<EmberStatus.SUCCESS: 0>, payload=GetSupportedFeaturesReq())\r\n2024-12-06 22:01:49.375 DEBUG (MainThread) [bellows.ezsp.protocol] Sending command  customFrame: (b'\\x00\\x00\\x00',) {}\r\n2024-12-06 22:01:49.375 DEBUG (MainThread) [bellows.ash] Sending frame DataFrame(frm_num=2, re_tx=False, ack_num=2, ezsp_frame=b'\\x01\\x00\\x01G\\x00\\x03\\x00\\x00\\x00') + FLAG\r\n2024-12-06 22:01:49.375 DEBUG (MainThread) [bellows.ash] Sending data  224321a97d332a16b25994e79e7e\r\n2024-12-06 22:01:49.385 DEBUG (MainThread) [bellows.ash] Received data 2343a1a97d332a15b21bbe7e\r\n2024-12-06 22:01:49.385 DEBUG (MainThread) [bellows.ash] Received frame DataFrame(frm_num=2, re_tx=0, ack_num=3, ezsp_frame=b'\\x01\\x80\\x01G\\x00\\x00\\x00')\r\n2024-12-06 22:01:49.385 DEBUG (MainThread) [bellows.ash] Sending frame AckFrame(res=0, ncp_ready=0, ack_num=3) + FLAG\r\n2024-12-06 22:01:49.385 DEBUG (MainThread) [bellows.ash] Sending data  83401b7e\r\n2024-12-06 22:01:49.385 DEBUG (MainThread) [bellows.ezsp.protocol] Received command customFrame: {'status': <EmberStatus.SUCCESS: 0>, 'reply': b''}\r\n2024-12-06 22:01:49.385 DEBUG (MainThread) [bellows.ash] Changing ACK timeout from 1.23 to 1.08\r\n2024-12-06 22:01:49.387 DEBUG (MainThread) [bellows.ezsp] XNCP features: 0\r\n2024-12-06 22:01:49.387 DEBUG (MainThread) [bellows.ezsp.protocol] Sending command  getMfgToken: () {'tokenId': <EzspMfgTokenId.MFG_STRING: 1>}\r\n2024-12-06 22:01:49.387 DEBUG (MainThread) [bellows.ash] Sending frame DataFrame(frm_num=3, re_tx=False, ack_num=3, ezsp_frame=b'\\x02\\x00\\x01\\x0b\\x00\\x01') + FLAG\r\n2024-12-06 22:01:49.387 DEBUG (MainThread) [bellows.ash] Sending data  334021a95f2a1468527e\r\n2024-12-06 22:01:49.397 DEBUG (MainThread) [bellows.ash] Received data 3440a1a95f2a05f735f12644c8266db663b1d8541231985ebf7e\r\n2024-12-06 22:01:49.397 DEBUG (MainThread) [bellows.ash] Received frame DataFrame(frm_num=3, re_tx=0, ack_num=4, ezsp_frame=b'\\x02\\x80\\x01\\x0b\\x00\\x10Elelabs\\xff\\xff\\xff\\xff\\xff\\xff\\xff\\xff\\xff')\r\n2024-12-06 22:01:49.397 DEBUG (MainThread) [bellows.ash] Sending frame AckFrame(res=0, ncp_ready=0, ack_num=4) + FLAG\r\n2024-12-06 22:01:49.398 DEBUG (MainThread) [bellows.ash] Sending data  8430fc7e\r\n2024-12-06 22:01:49.398 DEBUG (MainThread) [bellows.ezsp.protocol] Received command getMfgToken: {'tokenData': b'Elelabs\\xff\\xff\\xff\\xff\\xff\\xff\\xff\\xff\\xff'}\r\n2024-12-06 22:01:49.399 DEBUG (MainThread) [bellows.ash] Changing ACK timeout from 1.08 to 0.96\r\n2024-12-06 22:01:49.401 DEBUG (MainThread) [bellows.ezsp] Read manufacturing token MFG_STRING: b'Elelabs\\xff\\xff\\xff\\xff\\xff\\xff\\xff\\xff\\xff'\r\n2024-12-06 22:01:49.401 DEBUG (MainThread) [bellows.ezsp.protocol] Sending command  getMfgToken: () {'tokenId': <EzspMfgTokenId.MFG_BOARD_NAME: 2>}\r\n2024-12-06 22:01:49.401 DEBUG (MainThread) [bellows.ash] Sending frame DataFrame(frm_num=4, re_tx=False, ack_num=4, ezsp_frame=b'\\x03\\x00\\x01\\x0b\\x00\\x02') + FLAG\r\n2024-12-06 22:01:49.401 DEBUG (MainThread) [bellows.ash] Sending data  444121a95f2a1780b47e\r\n2024-12-06 22:01:49.413 DEBUG (MainThread) [bellows.ash] Received data 4541a1a95f2a05f715c17a149e676db663b1d85412319854c27e\r\n2024-12-06 22:01:49.413 DEBUG (MainThread) [bellows.ash] Received frame DataFrame(frm_num=4, re_tx=0, ack_num=5, ezsp_frame=b'\\x03\\x80\\x01\\x0b\\x00\\x10ELU0142\\xff\\xff\\xff\\xff\\xff\\xff\\xff\\xff\\xff')\r\n2024-12-06 22:01:49.413 DEBUG (MainThread) [bellows.ash] Sending frame AckFrame(res=0, ncp_ready=0, ack_num=5) + FLAG\r\n2024-12-06 22:01:49.413 DEBUG (MainThread) [bellows.ash] Sending data  8520dd7e\r\n2024-12-06 22:01:49.413 DEBUG (MainThread) [bellows.ezsp.protocol] Received command getMfgToken: {'tokenData': b'ELU0142\\xff\\xff\\xff\\xff\\xff\\xff\\xff\\xff\\xff'}\r\n2024-12-06 22:01:49.413 DEBUG (MainThread) [bellows.ash] Changing ACK timeout from 0.96 to 0.84\r\n2024-12-06 22:01:49.416 DEBUG (MainThread) [bellows.ezsp] Read manufacturing token MFG_BOARD_NAME: b'ELU0142\\xff\\xff\\xff\\xff\\xff\\xff\\xff\\xff\\xff'\r\n2024-12-06 22:01:49.416 DEBUG (MainThread) [bellows.ezsp.protocol] Sending command  getValue: () {'valueId': <EzspValueId.VALUE_VERSION_INFO: 17>}\r\n2024-12-06 22:01:49.416 DEBUG (MainThread) [bellows.ash] Sending frame DataFrame(frm_num=5, re_tx=False, ack_num=5, ezsp_frame=b'\\x04\\x00\\x01\\xaa\\x00\\x11') + FLAG\r\n2024-12-06 22:01:49.416 DEBUG (MainThread) [bellows.ash] Sending data  554621a9fe2a046f7d317e\r\n2024-12-06 22:01:49.425 DEBUG (MainThread) [bellows.ash] Received data 5646a1a9fe2a15b589954c2fa3553810757e\r\n2024-12-06 22:01:49.426 DEBUG (MainThread) [bellows.ash] Received frame DataFrame(frm_num=5, re_tx=0, ack_num=6, ezsp_frame=b'\\x04\\x80\\x01\\xaa\\x00\\x00\\x07\\xd0\\x01\\x06\\n\\t\\x00\\xaa')\r\n2024-12-06 22:01:49.426 DEBUG (MainThread) [bellows.ash] Sending frame AckFrame(res=0, ncp_ready=0, ack_num=6) + FLAG\r\n2024-12-06 22:01:49.426 DEBUG (MainThread) [bellows.ash] Sending data  8610be7e\r\n2024-12-06 22:01:49.426 DEBUG (MainThread) [bellows.ezsp.protocol] Received command getValue: {'status': <EzspStatus.SUCCESS: 0>, 'value': b'\\xd0\\x01\\x06\\n\\t\\x00\\xaa'}\r\n2024-12-06 22:01:49.427 DEBUG (MainThread) [bellows.ash] Changing ACK timeout from 0.84 to 0.74\r\n2024-12-06 22:01:49.428 DEBUG (MainThread) [bellows.ezsp] Sending XNCP frame: XncpCommand(command_id=<XncpCommandId.GET_BUILD_STRING_REQ: 3>, status=<EmberStatus.SUCCESS: 0>, payload=GetBuildStringReq())\r\n2024-12-06 22:01:49.429 DEBUG (MainThread) [bellows.ezsp.protocol] Sending command  customFrame: (b'\\x03\\x00\\x00',) {}\r\n2024-12-06 22:01:49.429 DEBUG (MainThread) [bellows.ash] Sending frame DataFrame(frm_num=6, re_tx=False, ack_num=6, ezsp_frame=b'\\x05\\x00\\x01G\\x00\\x03\\x03\\x00\\x00') + FLAG\r\n2024-12-06 22:01:49.429 DEBUG (MainThread) [bellows.ash] Sending data  664721a97d332a16b15994fd0e7e\r\n2024-12-06 22:01:49.437 DEBUG (MainThread) [bellows.ash] Received data 6747a1a97d332a15b35929ec7e\r\n2024-12-06 22:01:49.437 DEBUG (MainThread) [bellows.ash] Received frame DataFrame(frm_num=6, re_tx=0, ack_num=7, ezsp_frame=b'\\x05\\x80\\x01G\\x00\\x00\\x01\\x00')\r\n2024-12-06 22:01:49.437 DEBUG (MainThread) [bellows.ash] Sending frame AckFrame(res=0, ncp_ready=0, ack_num=7) + FLAG\r\n2024-12-06 22:01:49.437 DEBUG (MainThread) [bellows.ash] Sending data  87009f7e\r\n2024-12-06 22:01:49.437 DEBUG (MainThread) [bellows.ezsp.protocol] Received command customFrame: {'status': <EmberStatus.SUCCESS: 0>, 'reply': b'\\x00'}\r\n2024-12-06 22:01:49.438 DEBUG (MainThread) [bellows.ash] Changing ACK timeout from 0.74 to 0.65\r\n2024-12-06 22:01:49.440 DEBUG (MainThread) [zigpy.serial] Waiting for serial port to close\r\n2024-12-06 22:01:49.445 DEBUG (MainThread) [zigpy.serial] Connection lost: None\r\n2024-12-06 22:01:49.445 DEBUG (MainThread) [bellows.uart] Connection lost: None\r\n2024-12-06 22:01:49.448 DEBUG (MainThread) [universal_silabs_flasher.flasher] Probe result: ProbeResult(version='6.10.9.0 build 464' (6.10.9.0.464), continue_probing=False, baudrate=115200)\r\n2024-12-06 22:01:49.448 INFO (MainThread) [universal_silabs_flasher.flasher] Detected ApplicationType.EZSP, version '6.10.9.0 build 464' (6.10.9.0.464) at 115200 baudrate (bootloader baudrate None)\r\n2024-12-06 22:01:57.363 DEBUG (SyncWorker_4) [zhaquirks] Loading quirks module 'zhaquirks.adeo'\r\n2024-12-06 22:01:57.363 DEBUG (SyncWorker_4) [zhaquirks] Loading quirks module 'zhaquirks.adeo.color_controller'\r\n2024-12-06 22:01:57.363 DEBUG (SyncWorker_4) [zhaquirks] Loading quirks module 'zhaquirks.aduro'\r\n2024-12-06 22:01:57.364 DEBUG (SyncWorker_4) [zhaquirks] Loading quirks module 'zhaquirks.aduro.adurolightncc'\r\n2024-12-06 22:01:57.364 DEBUG (SyncWorker_4) [zhaquirks] Loading quirks module 'zhaquirks.aurora'\r\n2024-12-06 22:01:57.365 DEBUG (SyncWorker_4) [zhaquirks] Loading quirks module 'zhaquirks.aurora.aurora_dimmer'\r\n2024-12-06 22:01:57.365 DEBUG (SyncWorker_4) [zhaquirks] Loading quirks module 'zhaquirks.bitron'\r\n2024-12-06 22:01:57.365 DEBUG (SyncWorker_4) [zhaquirks] Loading quirks module 'zhaquirks.bitron.thermostat'\r\n2024-12-06 22:01:57.365 DEBUG (SyncWorker_4) [zhaquirks] Loading quirks module 'zhaquirks.bosch'\r\n2024-12-06 22:01:57.366 DEBUG (SyncWorker_4) [zhaquirks] Loading quirks module 'zhaquirks.bosch.isw_zdl1_wp11g'\r\n2024-12-06 22:01:57.366 DEBUG (SyncWorker_4) [zhaquirks] Loading quirks module 'zhaquirks.bosch.motion'\r\n2024-12-06 22:01:57.366 DEBUG (SyncWorker_4) [zhaquirks] Loading quirks module 'zhaquirks.centralite'\r\n2024-12-06 22:01:57.367 DEBUG (SyncWorker_4) [zhaquirks] Loading quirks module 'zhaquirks.centralite.cl_3130'\r\n2024-12-06 22:01:57.367 DEBUG (SyncWorker_4) [zhaquirks] Loading quirks module 'zhaquirks.centralite.cl_3157100'\r\n2024-12-06 22:01:57.367 DEBUG (SyncWorker_4) [zhaquirks] Loading quirks module 'zhaquirks.centralite.cl_3300S'\r\n2024-12-06 22:01:57.367 DEBUG (SyncWorker_4) [zhaquirks] Loading quirks module 'zhaquirks.centralite.cl_3305S'\r\n2024-12-06 22:01:57.367 DEBUG (SyncWorker_4) [zhaquirks] Loading quirks module 'zhaquirks.centralite.cl_3310S'\r\n2024-12-06 22:01:57.367 DEBUG (SyncWorker_4) [zhaquirks] Loading quirks module 'zhaquirks.centralite.cl_3321S'\r\n2024-12-06 22:01:57.367 DEBUG (SyncWorker_4) [zhaquirks] Loading quirks module 'zhaquirks.centralite.cl_3460L'\r\n2024-12-06 22:01:57.367 DEBUG (SyncWorker_4) [zhaquirks] Loading quirks module 'zhaquirks.centralite.ias'\r\n2024-12-06 22:01:57.367 DEBUG (SyncWorker_4) [zhaquirks] Loading quirks module 'zhaquirks.centralite.motion'\r\n2024-12-06 22:01:57.367 DEBUG (SyncWorker_4) [zhaquirks] Loading quirks module 'zhaquirks.centralite.motionandtemp'\r\n2024-12-06 22:01:57.367 DEBUG (SyncWorker_4) [zhaquirks] Loading quirks module 'zhaquirks.const'\r\n2024-12-06 22:01:57.368 DEBUG (SyncWorker_4) [zhaquirks] Loading quirks module 'zhaquirks.danfoss'\r\n2024-12-06 22:01:57.369 DEBUG (SyncWorker_4) [zhaquirks] Loading quirks module 'zhaquirks.danfoss.thermostat'\r\n2024-12-06 22:01:57.369 DEBUG (SyncWorker_4) [zhaquirks] Loading quirks module 'zhaquirks.develco'\r\n2024-12-06 22:01:57.369 DEBUG (SyncWorker_4) [zhaquirks] Loading quirks module 'zhaquirks.develco.air_quality'\r\n2024-12-06 22:01:57.369 DEBUG (SyncWorker_4) [zhaquirks] Loading quirks module 'zhaquirks.develco.heat_alarm'\r\n2024-12-06 22:01:57.369 DEBUG (SyncWorker_4) [zhaquirks] Loading quirks module 'zhaquirks.develco.motion'\r\n2024-12-06 22:01:57.369 DEBUG (SyncWorker_4) [zhaquirks] Loading quirks module 'zhaquirks.develco.open_close'\r\n2024-12-06 22:01:57.369 DEBUG (SyncWorker_4) [zhaquirks] Loading quirks module 'zhaquirks.develco.power_plug'\r\n2024-12-06 22:01:57.369 DEBUG (SyncWorker_4) [zhaquirks] Loading quirks module 'zhaquirks.develco.smoke_alarm'\r\n2024-12-06 22:01:57.370 DEBUG (SyncWorker_4) [zhaquirks] Loading quirks module 'zhaquirks.echostar'\r\n2024-12-06 22:01:57.370 DEBUG (SyncWorker_4) [zhaquirks] Loading quirks module 'zhaquirks.echostar.bell'\r\n2024-12-06 22:01:57.370 DEBUG (SyncWorker_4) [zhaquirks] Loading quirks module 'zhaquirks.ecolink'\r\n2024-12-06 22:01:57.371 DEBUG (SyncWorker_4) [zhaquirks] Loading quirks module 'zhaquirks.ecolink.contact'\r\n2024-12-06 22:01:57.371 DEBUG (SyncWorker_4) [zhaquirks] Loading quirks module 'zhaquirks.edpwithus'\r\n2024-12-06 22:01:57.371 DEBUG (SyncWorker_4) [zhaquirks] Loading quirks module 'zhaquirks.edpwithus.redy_plug'\r\n2024-12-06 22:01:57.371 DEBUG (SyncWorker_4) [zhaquirks] Loading quirks module 'zhaquirks.elko'\r\n2024-12-06 22:01:57.372 DEBUG (SyncWorker_4) [zhaquirks] Loading quirks module 'zhaquirks.elko.smart_super_thermostat'\r\n2024-12-06 22:01:57.372 DEBUG (SyncWorker_4) [zhaquirks] Loading quirks module 'zhaquirks.eurotronic'\r\n2024-12-06 22:01:57.372 DEBUG (SyncWorker_4) [zhaquirks] Loading quirks module 'zhaquirks.eurotronic.spzb0001'\r\n2024-12-06 22:01:57.373 DEBUG (SyncWorker_4) [zhaquirks] Loading quirks module 'zhaquirks.feibit'\r\n2024-12-06 22:01:57.373 DEBUG (SyncWorker_4) [zhaquirks] Loading quirks module 'zhaquirks.feibit.switch'\r\n2024-12-06 22:01:57.373 DEBUG (SyncWorker_4) [zhaquirks] Loading quirks module 'zhaquirks.gledopto'\r\n2024-12-06 22:01:57.373 DEBUG (SyncWorker_4) [zhaquirks] Loading quirks module 'zhaquirks.gledopto.glc009'\r\n2024-12-06 22:01:57.374 DEBUG (SyncWorker_4) [zhaquirks] Loading quirks module 'zhaquirks.gledopto.glc009p'\r\n2024-12-06 22:01:57.374 DEBUG (SyncWorker_4) [zhaquirks] Loading quirks module 'zhaquirks.gledopto.gls007z'\r\n2024-12-06 22:01:57.374 DEBUG (SyncWorker_4) [zhaquirks] Loading quirks module 'zhaquirks.gledopto.glsd_dimmer'\r\n2024-12-06 22:01:57.374 DEBUG (SyncWorker_4) [zhaquirks] Loading quirks module 'zhaquirks.gledopto.soposhgu10'\r\n2024-12-06 22:01:57.374 DEBUG (SyncWorker_4) [zhaquirks] Loading quirks module 'zhaquirks.heiman'\r\n2024-12-06 22:01:57.375 DEBUG (SyncWorker_4) [zhaquirks] Loading quirks module 'zhaquirks.heiman.smoke'\r\n2024-12-06 22:01:57.375 DEBUG (SyncWorker_4) [zhaquirks] Loading quirks module 'zhaquirks.hivehome'\r\n2024-12-06 22:01:57.375 DEBUG (SyncWorker_4) [zhaquirks] Loading quirks module 'zhaquirks.hivehome.mot003V0'\r\n2024-12-06 22:01:57.375 DEBUG (SyncWorker_4) [zhaquirks] Loading quirks module 'zhaquirks.hivehome.mot003V6'\r\n2024-12-06 22:01:57.376 DEBUG (SyncWorker_4) [zhaquirks] Loading quirks module 'zhaquirks.hzc'\r\n2024-12-06 22:01:57.376 DEBUG (SyncWorker_4) [zhaquirks] Loading quirks module 'zhaquirks.hzc.dimmerswitch'\r\n2024-12-06 22:01:57.376 DEBUG (SyncWorker_4) [zhaquirks] Loading quirks module 'zhaquirks.hzc.doubledimmerswitch'\r\n2024-12-06 22:01:57.376 DEBUG (SyncWorker_4) [zhaquirks] Loading quirks module 'zhaquirks.icasa'\r\n2024-12-06 22:01:57.377 DEBUG (SyncWorker_4) [zhaquirks] Loading quirks module 'zhaquirks.icasa.iczb_kpd12'\r\n2024-12-06 22:01:57.377 DEBUG (SyncWorker_4) [zhaquirks] Loading quirks module 'zhaquirks.icasa.iczb_kpd14s'\r\n2024-12-06 22:01:57.377 DEBUG (SyncWorker_4) [zhaquirks] Loading quirks module 'zhaquirks.icasa.iczb_kpd18s'\r\n2024-12-06 22:01:57.377 DEBUG (SyncWorker_4) [zhaquirks] Loading quirks module 'zhaquirks.ikea'\r\n2024-12-06 22:01:57.377 DEBUG (SyncWorker_4) [zhaquirks] Loading quirks module 'zhaquirks.ikea.blinds'\r\n2024-12-06 22:01:57.378 DEBUG (SyncWorker_4) [zhaquirks] Loading quirks module 'zhaquirks.ikea.cctlightzha'\r\n2024-12-06 22:01:57.378 DEBUG (SyncWorker_4) [zhaquirks] Loading quirks module 'zhaquirks.ikea.dimmer'\r\n2024-12-06 22:01:57.378 DEBUG (SyncWorker_4) [zhaquirks] Loading quirks module 'zhaquirks.ikea.fivebtnremote'\r\n2024-12-06 22:01:57.378 DEBUG (SyncWorker_4) [zhaquirks] Loading quirks module 'zhaquirks.ikea.fourbtnremote'\r\n2024-12-06 22:01:57.378 DEBUG (SyncWorker_4) [zhaquirks] Loading quirks module 'zhaquirks.ikea.motion'\r\n2024-12-06 22:01:57.378 DEBUG (SyncWorker_4) [zhaquirks] Loading quirks module 'zhaquirks.ikea.motionzha'\r\n2024-12-06 22:01:57.378 DEBUG (SyncWorker_4) [zhaquirks] Loading quirks module 'zhaquirks.ikea.opencloseremote'\r\n2024-12-06 22:01:57.378 DEBUG (SyncWorker_4) [zhaquirks] Loading quirks module 'zhaquirks.ikea.plug'\r\n2024-12-06 22:01:57.378 DEBUG (SyncWorker_4) [zhaquirks] Loading quirks module 'zhaquirks.ikea.shortcutbtn'\r\n2024-12-06 22:01:57.378 DEBUG (SyncWorker_4) [zhaquirks] Loading quirks module 'zhaquirks.ikea.somrigsmartbtn'\r\n2024-12-06 22:01:57.378 DEBUG (SyncWorker_4) [zhaquirks] Loading quirks module 'zhaquirks.ikea.starkvind'\r\n2024-12-06 22:01:57.378 DEBUG (SyncWorker_4) [zhaquirks] Loading quirks module 'zhaquirks.ikea.symfonisk'\r\n2024-12-06 22:01:57.378 DEBUG (SyncWorker_4) [zhaquirks] Loading quirks module 'zhaquirks.ikea.symfonisk2'\r\n2024-12-06 22:01:57.378 DEBUG (SyncWorker_4) [zhaquirks] Loading quirks module 'zhaquirks.ikea.twobtnremote'\r\n2024-12-06 22:01:57.378 DEBUG (SyncWorker_4) [zhaquirks] Loading quirks module 'zhaquirks.iluminize'\r\n2024-12-06 22:01:57.379 DEBUG (SyncWorker_4) [zhaquirks] Loading quirks module 'zhaquirks.iluminize.cct'\r\n2024-12-06 22:01:57.379 DEBUG (SyncWorker_4) [zhaquirks] Loading quirks module 'zhaquirks.iluminize.dim'\r\n2024-12-06 22:01:57.379 DEBUG (SyncWorker_4) [zhaquirks] Loading quirks module 'zhaquirks.imagic'\r\n2024-12-06 22:01:57.380 DEBUG (SyncWorker_4) [zhaquirks] Loading quirks module 'zhaquirks.imagic.gs1117s'\r\n2024-12-06 22:01:57.380 DEBUG (SyncWorker_4) [zhaquirks] Loading quirks module 'zhaquirks.imagic.im1116s'\r\n2024-12-06 22:01:57.381 DEBUG (SyncWorker_4) [zhaquirks] Loading quirks module 'zhaquirks.innr'\r\n2024-12-06 22:01:57.381 DEBUG (SyncWorker_4) [zhaquirks] Loading quirks module 'zhaquirks.innr.innr_sp120_plug'\r\n2024-12-06 22:01:57.381 DEBUG (SyncWorker_4) [zhaquirks] Loading quirks module 'zhaquirks.innr.innr_sp234_plug'\r\n2024-12-06 22:01:57.381 DEBUG (SyncWorker_4) [zhaquirks] Loading quirks module 'zhaquirks.innr.innr_sp240_plug'\r\n2024-12-06 22:01:57.381 DEBUG (SyncWorker_4) [zhaquirks] Loading quirks module 'zhaquirks.innr.rs228t'\r\n2024-12-06 22:01:57.382 DEBUG (SyncWorker_4) [zhaquirks] Loading quirks module 'zhaquirks.inovelli'\r\n2024-12-06 22:01:57.382 DEBUG (SyncWorker_4) [zhaquirks] Loading quirks module 'zhaquirks.inovelli.VZM31SN'\r\n2024-12-06 22:01:57.382 DEBUG (SyncWorker_4) [zhaquirks] Loading quirks module 'zhaquirks.inovelli.VZM35SN'\r\n2024-12-06 22:01:57.382 DEBUG (SyncWorker_4) [zhaquirks] Loading quirks module 'zhaquirks.inovelli.VZM36'\r\n2024-12-06 22:01:57.382 DEBUG (SyncWorker_4) [zhaquirks] Loading quirks module 'zhaquirks.inovelli.types'\r\n2024-12-06 22:01:57.383 DEBUG (SyncWorker_4) [zhaquirks] Loading quirks module 'zhaquirks.insta'\r\n2024-12-06 22:01:57.383 DEBUG (SyncWorker_4) [zhaquirks] Loading quirks module 'zhaquirks.insta.nexentro_pushbutton_interface'\r\n2024-12-06 22:01:57.383 DEBUG (SyncWorker_4) [zhaquirks] Loading quirks module 'zhaquirks.keenhome'\r\n2024-12-06 22:01:57.383 DEBUG (SyncWorker_4) [zhaquirks] Loading quirks module 'zhaquirks.keenhome.sv02612mp13'\r\n2024-12-06 22:01:57.383 DEBUG (SyncWorker_4) [zhaquirks] Loading quirks module 'zhaquirks.keenhome.weather'\r\n2024-12-06 22:01:57.384 DEBUG (SyncWorker_4) [zhaquirks] Loading quirks module 'zhaquirks.kof'\r\n2024-12-06 22:01:57.384 DEBUG (SyncWorker_4) [zhaquirks] Loading quirks module 'zhaquirks.kof.kof_mr101z'\r\n2024-12-06 22:01:57.384 DEBUG (SyncWorker_4) [zhaquirks] Loading quirks module 'zhaquirks.konke'\r\n2024-12-06 22:01:57.385 DEBUG (SyncWorker_4) [zhaquirks] Loading quirks module 'zhaquirks.konke.button'\r\n2024-12-06 22:01:57.385 DEBUG (SyncWorker_4) [zhaquirks] Loading quirks module 'zhaquirks.konke.magnet'\r\n2024-12-06 22:01:57.385 DEBUG (SyncWorker_4) [zhaquirks] Loading quirks module 'zhaquirks.konke.motion'\r\n2024-12-06 22:01:57.385 DEBUG (SyncWorker_4) [zhaquirks] Loading quirks module 'zhaquirks.konke.temp'\r\n2024-12-06 22:01:57.385 DEBUG (SyncWorker_4) [zhaquirks] Loading quirks module 'zhaquirks.lds'\r\n2024-12-06 22:01:57.385 DEBUG (SyncWorker_4) [zhaquirks] Loading quirks module 'zhaquirks.lds.cctswitch'\r\n2024-12-06 22:01:57.386 DEBUG (SyncWorker_4) [zhaquirks] Loading quirks module 'zhaquirks.ledvance'\r\n2024-12-06 22:01:57.386 DEBUG (SyncWorker_4) [zhaquirks] Loading quirks module 'zhaquirks.ledvance.a19rgbw'\r\n2024-12-06 22:01:57.386 DEBUG (SyncWorker_4) [zhaquirks] Loading quirks module 'zhaquirks.ledvance.flexrgbw'\r\n2024-12-06 22:01:57.386 DEBUG (SyncWorker_4) [zhaquirks] Loading quirks module 'zhaquirks.legrand'\r\n2024-12-06 22:01:57.387 DEBUG (SyncWorker_4) [zhaquirks] Loading quirks module 'zhaquirks.legrand.cable_outlet'\r\n2024-12-06 22:01:57.387 DEBUG (SyncWorker_4) [zhaquirks] Loading quirks module 'zhaquirks.legrand.dimmer'\r\n2024-12-06 22:01:57.387 DEBUG (SyncWorker_4) [zhaquirks] Loading quirks module 'zhaquirks.legrand.switch'\r\n2024-12-06 22:01:57.387 DEBUG (SyncWorker_4) [zhaquirks] Loading quirks module 'zhaquirks.lidl'\r\n2024-12-06 22:01:57.387 DEBUG (SyncWorker_4) [zhaquirks] Loading quirks module 'zhaquirks.lidl.TS0501A'\r\n2024-12-06 22:01:57.388 DEBUG (SyncWorker_4) [zhaquirks] Loading quirks module 'zhaquirks.lidl.cct'\r\n2024-12-06 22:01:57.388 DEBUG (SyncWorker_4) [zhaquirks] Loading quirks module 'zhaquirks.lidl.rgbcct'\r\n2024-12-06 22:01:57.388 DEBUG (SyncWorker_4) [zhaquirks] Loading quirks module 'zhaquirks.lidl.ts011f_plug'\r\n2024-12-06 22:01:57.388 DEBUG (SyncWorker_4) [zhaquirks] Loading quirks module 'zhaquirks.linkind'\r\n2024-12-06 22:01:57.388 DEBUG (SyncWorker_4) [zhaquirks] Loading quirks module 'zhaquirks.linkind.a001082'\r\n2024-12-06 22:01:57.388 DEBUG (SyncWorker_4) [zhaquirks] Loading quirks module 'zhaquirks.linkind.motion'\r\n2024-12-06 22:01:57.389 DEBUG (SyncWorker_4) [zhaquirks] Loading quirks module 'zhaquirks.linxura'\r\n2024-12-06 22:01:57.389 DEBUG (SyncWorker_4) [zhaquirks] Loading quirks module 'zhaquirks.linxura.button'\r\n2024-12-06 22:01:57.389 DEBUG (SyncWorker_4) [zhaquirks] Loading quirks module 'zhaquirks.lixee'\r\n2024-12-06 22:01:57.390 DEBUG (SyncWorker_4) [zhaquirks] Loading quirks module 'zhaquirks.lixee.zlinky'\r\n2024-12-06 22:01:57.390 DEBUG (SyncWorker_4) [zhaquirks] Loading quirks module 'zhaquirks.lutron'\r\n2024-12-06 22:01:57.390 DEBUG (SyncWorker_4) [zhaquirks] Loading quirks module 'zhaquirks.lutron.lzl4bwhl01remote'\r\n2024-12-06 22:01:57.390 DEBUG (SyncWorker_4) [zhaquirks] Loading quirks module 'zhaquirks.mli'\r\n2024-12-06 22:01:57.391 DEBUG (SyncWorker_4) [zhaquirks] Loading quirks module 'zhaquirks.mli.tint'\r\n2024-12-06 22:01:57.391 DEBUG (SyncWorker_4) [zhaquirks] Loading quirks module 'zhaquirks.mli.tintE14rgbcct'\r\n2024-12-06 22:01:57.391 DEBUG (SyncWorker_4) [zhaquirks] Loading quirks module 'zhaquirks.netvox'\r\n2024-12-06 22:01:57.391 DEBUG (SyncWorker_4) [zhaquirks] Loading quirks module 'zhaquirks.netvox.z308e3ed'\r\n2024-12-06 22:01:57.392 DEBUG (SyncWorker_4) [zhaquirks] Loading quirks module 'zhaquirks.nimly'\r\n2024-12-06 22:01:57.392 DEBUG (SyncWorker_4) [zhaquirks] Loading quirks module 'zhaquirks.nimly.lock'\r\n2024-12-06 22:01:57.392 DEBUG (SyncWorker_4) [zhaquirks] Loading quirks module 'zhaquirks.nodon'\r\n2024-12-06 22:01:57.392 DEBUG (SyncWorker_4) [zhaquirks] Loading quirks module 'zhaquirks.nodon.pilot_wire'\r\n2024-12-06 22:01:57.392 DEBUG (SyncWorker_4) [zhaquirks] Loading quirks module 'zhaquirks.nodon.switch'\r\n2024-12-06 22:01:57.393 DEBUG (SyncWorker_4) [zhaquirks] Loading quirks module 'zhaquirks.nue'\r\n2024-12-06 22:01:57.393 DEBUG (SyncWorker_4) [zhaquirks] Loading quirks module 'zhaquirks.nue.auwz02000'\r\n2024-12-06 22:01:57.393 DEBUG (SyncWorker_4) [zhaquirks] Loading quirks module 'zhaquirks.orvibo'\r\n2024-12-06 22:01:57.394 DEBUG (SyncWorker_4) [zhaquirks] Loading quirks module 'zhaquirks.orvibo.dimmer'\r\n2024-12-06 22:01:57.394 DEBUG (SyncWorker_4) [zhaquirks] Loading quirks module 'zhaquirks.orvibo.motion'\r\n2024-12-06 22:01:57.394 DEBUG (SyncWorker_4) [zhaquirks] Loading quirks module 'zhaquirks.osram'\r\n2024-12-06 22:01:57.394 DEBUG (SyncWorker_4) [zhaquirks] Loading quirks module 'zhaquirks.osram.a19rgbw'\r\n2024-12-06 22:01:57.394 DEBUG (SyncWorker_4) [zhaquirks] Loading quirks module 'zhaquirks.osram.cla60tw'\r\n2024-12-06 22:01:57.394 DEBUG (SyncWorker_4) [zhaquirks] Loading quirks module 'zhaquirks.osram.flexrgbw'\r\n2024-12-06 22:01:57.394 DEBUG (SyncWorker_4) [zhaquirks] Loading quirks module 'zhaquirks.osram.gardenpolesrgbw'\r\n2024-12-06 22:01:57.394 DEBUG (SyncWorker_4) [zhaquirks] Loading quirks module 'zhaquirks.osram.lightifyx4'\r\n2024-12-06 22:01:57.394 DEBUG (SyncWorker_4) [zhaquirks] Loading quirks module 'zhaquirks.osram.osramplug'\r\n2024-12-06 22:01:57.394 DEBUG (SyncWorker_4) [zhaquirks] Loading quirks module 'zhaquirks.osram.smartplusac05347'\r\n2024-12-06 22:01:57.395 DEBUG (SyncWorker_4) [zhaquirks] Loading quirks module 'zhaquirks.osram.switchmini'\r\n2024-12-06 22:01:57.395 DEBUG (SyncWorker_4) [zhaquirks] Loading quirks module 'zhaquirks.osram.tunablewhite'\r\n2024-12-06 22:01:57.395 DEBUG (SyncWorker_4) [zhaquirks] Loading quirks module 'zhaquirks.paulmann'\r\n2024-12-06 22:01:57.396 DEBUG (SyncWorker_4) [zhaquirks] Loading quirks module 'zhaquirks.paulmann.fourbtnremote'\r\n2024-12-06 22:01:57.396 DEBUG (SyncWorker_4) [zhaquirks] Loading quirks module 'zhaquirks.philio'\r\n2024-12-06 22:01:57.396 DEBUG (SyncWorker_4) [zhaquirks] Loading quirks module 'zhaquirks.philio.pst03a'\r\n2024-12-06 22:01:57.397 DEBUG (SyncWorker_4) [zhaquirks] Loading quirks module 'zhaquirks.philips'\r\n2024-12-06 22:01:57.397 DEBUG (SyncWorker_4) [zhaquirks] Loading quirks module 'zhaquirks.philips.motion'\r\n2024-12-06 22:01:57.397 DEBUG (SyncWorker_4) [zhaquirks] Loading quirks module 'zhaquirks.philips.rdm002'\r\n2024-12-06 22:01:57.397 DEBUG (SyncWorker_4) [zhaquirks] Loading quirks module 'zhaquirks.philips.rom001'\r\n2024-12-06 22:01:57.397 DEBUG (SyncWorker_4) [zhaquirks] Loading quirks module 'zhaquirks.philips.rwl022'\r\n2024-12-06 22:01:57.397 DEBUG (SyncWorker_4) [zhaquirks] Loading quirks module 'zhaquirks.philips.rwlfirstgen'\r\n2024-12-06 22:01:57.397 DEBUG (SyncWorker_4) [zhaquirks] Loading quirks module 'zhaquirks.philips.soc001'\r\n2024-12-06 22:01:57.397 DEBUG (SyncWorker_4) [zhaquirks] Loading quirks module 'zhaquirks.philips.wall_switch'\r\n2024-12-06 22:01:57.398 DEBUG (SyncWorker_4) [zhaquirks] Loading quirks module 'zhaquirks.plaid'\r\n2024-12-06 22:01:57.398 DEBUG (SyncWorker_4) [zhaquirks] Loading quirks module 'zhaquirks.plaid.soil'\r\n2024-12-06 22:01:57.398 DEBUG (SyncWorker_4) [zhaquirks] Loading quirks module 'zhaquirks.quirk_ids'\r\n2024-12-06 22:01:57.399 DEBUG (SyncWorker_4) [zhaquirks] Loading quirks module 'zhaquirks.salus'\r\n2024-12-06 22:01:57.399 DEBUG (SyncWorker_4) [zhaquirks] Loading quirks module 'zhaquirks.salus.sp600'\r\n2024-12-06 22:01:57.399 DEBUG (SyncWorker_4) [zhaquirks] Loading quirks module 'zhaquirks.samjin'\r\n2024-12-06 22:01:57.399 DEBUG (SyncWorker_4) [zhaquirks] Loading quirks module 'zhaquirks.samjin.button'\r\n2024-12-06 22:01:57.399 DEBUG (SyncWorker_4) [zhaquirks] Loading quirks module 'zhaquirks.samjin.multi'\r\n2024-12-06 22:01:57.399 DEBUG (SyncWorker_4) [zhaquirks] Loading quirks module 'zhaquirks.samjin.multi2'\r\n2024-12-06 22:01:57.400 DEBUG (SyncWorker_4) [zhaquirks] Loading quirks module 'zhaquirks.schneider'\r\n2024-12-06 22:01:57.400 DEBUG (SyncWorker_4) [zhaquirks] Loading quirks module 'zhaquirks.schneider.outlet'\r\n2024-12-06 22:01:57.400 DEBUG (SyncWorker_4) [zhaquirks] Loading quirks module 'zhaquirks.schneiderelectric'\r\n2024-12-06 22:01:57.401 DEBUG (SyncWorker_4) [zhaquirks] Loading quirks module 'zhaquirks.schneiderelectric.dimmers'\r\n2024-12-06 22:01:57.401 DEBUG (SyncWorker_4) [zhaquirks] Loading quirks module 'zhaquirks.schneiderelectric.shutters'\r\n2024-12-06 22:01:57.401 DEBUG (SyncWorker_4) [zhaquirks] Loading quirks module 'zhaquirks.schneiderelectric.thermostat'\r\n2024-12-06 22:01:57.401 DEBUG (SyncWorker_4) [zhaquirks] Loading quirks module 'zhaquirks.sengled'\r\n2024-12-06 22:01:57.402 DEBUG (SyncWorker_4) [zhaquirks] Loading quirks module 'zhaquirks.sengled.e1e_g7f'\r\n2024-12-06 22:01:57.402 DEBUG (SyncWorker_4) [zhaquirks] Loading quirks module 'zhaquirks.sercomm'\r\n2024-12-06 22:01:57.402 DEBUG (SyncWorker_4) [zhaquirks] Loading quirks module 'zhaquirks.sercomm.contact_sensor'\r\n2024-12-06 22:01:57.402 DEBUG (SyncWorker_4) [zhaquirks] Loading quirks module 'zhaquirks.sercomm.flood_sensor'\r\n2024-12-06 22:01:57.403 DEBUG (SyncWorker_4) [zhaquirks] Loading quirks module 'zhaquirks.siglis'\r\n2024-12-06 22:01:57.403 DEBUG (SyncWorker_4) [zhaquirks] Loading quirks module 'zhaquirks.siglis.zigfred'\r\n2024-12-06 22:01:57.403 DEBUG (SyncWorker_4) [zhaquirks] Loading quirks module 'zhaquirks.sinope'\r\n2024-12-06 22:01:57.403 DEBUG (SyncWorker_4) [zhaquirks] Loading quirks module 'zhaquirks.sinope.light'\r\n2024-12-06 22:01:57.403 DEBUG (SyncWorker_4) [zhaquirks] Loading quirks module 'zhaquirks.sinope.sensor'\r\n2024-12-06 22:01:57.403 DEBUG (SyncWorker_4) [zhaquirks] Loading quirks module 'zhaquirks.sinope.switch'\r\n2024-12-06 22:01:57.403 DEBUG (SyncWorker_4) [zhaquirks] Loading quirks module 'zhaquirks.sinope.thermostat'\r\n2024-12-06 22:01:57.404 DEBUG (SyncWorker_4) [zhaquirks] Loading quirks module 'zhaquirks.smartthings'\r\n2024-12-06 22:01:57.404 DEBUG (SyncWorker_4) [zhaquirks] Loading quirks module 'zhaquirks.smartthings.moisturev4'\r\n2024-12-06 22:01:57.404 DEBUG (SyncWorker_4) [zhaquirks] Loading quirks module 'zhaquirks.smartthings.motion'\r\n2024-12-06 22:01:57.404 DEBUG (SyncWorker_4) [zhaquirks] Loading quirks module 'zhaquirks.smartthings.multi'\r\n2024-12-06 22:01:57.404 DEBUG (SyncWorker_4) [zhaquirks] Loading quirks module 'zhaquirks.smartthings.multiv4'\r\n2024-12-06 22:01:57.404 DEBUG (SyncWorker_4) [zhaquirks] Loading quirks module 'zhaquirks.smartthings.pgc313'\r\n2024-12-06 22:01:57.404 DEBUG (SyncWorker_4) [zhaquirks] Loading quirks module 'zhaquirks.smartthings.pgc314'\r\n2024-12-06 22:01:57.404 DEBUG (SyncWorker_4) [zhaquirks] Loading quirks module 'zhaquirks.smartthings.tag_v4'\r\n2024-12-06 22:01:57.404 DEBUG (SyncWorker_4) [zhaquirks] Loading quirks module 'zhaquirks.smartwings'\r\n2024-12-06 22:01:57.405 DEBUG (SyncWorker_4) [zhaquirks] Loading quirks module 'zhaquirks.smartwings.wm25lz'\r\n2024-12-06 22:01:57.406 DEBUG (SyncWorker_4) [zhaquirks] Loading quirks module 'zhaquirks.sonoff'\r\n2024-12-06 22:01:57.406 DEBUG (SyncWorker_4) [zhaquirks] Loading quirks module 'zhaquirks.sonoff.button'\r\n2024-12-06 22:01:57.406 DEBUG (SyncWorker_4) [zhaquirks] Loading quirks module 'zhaquirks.sonoff.snzb06p'\r\n2024-12-06 22:01:57.406 DEBUG (SyncWorker_4) [zhaquirks] Loading quirks module 'zhaquirks.sonoff.swv'\r\n2024-12-06 22:01:57.406 DEBUG (SyncWorker_4) [zhaquirks] Loading quirks module 'zhaquirks.sonoff.trvzb'\r\n2024-12-06 22:01:57.406 DEBUG (SyncWorker_4) [zhaquirks] Loading quirks module 'zhaquirks.sonoff.zbminir2'\r\n2024-12-06 22:01:57.407 DEBUG (SyncWorker_4) [zhaquirks] Loading quirks module 'zhaquirks.sourcingandcreation'\r\n2024-12-06 22:01:57.407 DEBUG (SyncWorker_4) [zhaquirks] Loading quirks module 'zhaquirks.sourcingandcreation.smart_button'\r\n2024-12-06 22:01:57.407 DEBUG (SyncWorker_4) [zhaquirks] Loading quirks module 'zhaquirks.terncy'\r\n2024-12-06 22:01:57.408 DEBUG (SyncWorker_4) [zhaquirks] Loading quirks module 'zhaquirks.terncy.cl001'\r\n2024-12-06 22:01:57.408 DEBUG (SyncWorker_4) [zhaquirks] Loading quirks module 'zhaquirks.terncy.pp01'\r\n2024-12-06 22:01:57.408 DEBUG (SyncWorker_4) [zhaquirks] Loading quirks module 'zhaquirks.terncy.sd01'\r\n2024-12-06 22:01:57.408 DEBUG (SyncWorker_4) [zhaquirks] Loading quirks module 'zhaquirks.texasinstruments'\r\n2024-12-06 22:01:57.408 DEBUG (SyncWorker_4) [zhaquirks] Loading quirks module 'zhaquirks.texasinstruments.router'\r\n2024-12-06 22:01:57.409 DEBUG (SyncWorker_4) [zhaquirks] Loading quirks module 'zhaquirks.thirdreality'\r\n2024-12-06 22:01:57.409 DEBUG (SyncWorker_4) [zhaquirks] Loading quirks module 'zhaquirks.thirdreality.button'\r\n2024-12-06 22:01:57.409 DEBUG (SyncWorker_4) [zhaquirks] Loading quirks module 'zhaquirks.thirdreality.motion_sensor'\r\n2024-12-06 22:01:57.409 DEBUG (SyncWorker_4) [zhaquirks] Loading quirks module 'zhaquirks.thirdreality.night_light'\r\n2024-12-06 22:01:57.409 DEBUG (SyncWorker_4) [zhaquirks] Loading quirks module 'zhaquirks.thirdreality.plug'\r\n2024-12-06 22:01:57.409 DEBUG (SyncWorker_4) [zhaquirks] Loading quirks module 'zhaquirks.thirdreality.switch'\r\n2024-12-06 22:01:57.409 DEBUG (SyncWorker_4) [zhaquirks] Loading quirks module 'zhaquirks.thirdreality.vibrate'\r\n2024-12-06 22:01:57.409 DEBUG (SyncWorker_4) [zhaquirks] Loading quirks module 'zhaquirks.thirdreality.water_leak_sensor'\r\n2024-12-06 22:01:57.409 DEBUG (SyncWorker_4) [zhaquirks] Loading quirks module 'zhaquirks.trust'\r\n2024-12-06 22:01:57.410 DEBUG (SyncWorker_4) [zhaquirks] Loading quirks module 'zhaquirks.trust.zpir8000'\r\n2024-12-06 22:01:57.411 DEBUG (SyncWorker_4) [zhaquirks] Loading quirks module 'zhaquirks.tuya'\r\n2024-12-06 22:01:57.411 DEBUG (SyncWorker_4) [zhaquirks] Loading quirks module 'zhaquirks.tuya.air'\r\n2024-12-06 22:01:57.411 DEBUG (SyncWorker_4) [zhaquirks] Loading quirks module 'zhaquirks.tuya.air.ts0601_air_quality'\r\n2024-12-06 22:01:57.411 DEBUG (SyncWorker_4) [zhaquirks] Loading quirks module 'zhaquirks.tuya.air.ts0601_smart_air'\r\n2024-12-06 22:01:57.412 DEBUG (SyncWorker_4) [zhaquirks] Loading quirks module 'zhaquirks.tuya.builder'\r\n2024-12-06 22:01:57.412 DEBUG (SyncWorker_4) [zhaquirks] Loading quirks module 'zhaquirks.tuya.mcu'\r\n2024-12-06 22:01:57.412 DEBUG (SyncWorker_4) [zhaquirks] Loading quirks module 'zhaquirks.tuya.sm0202_motion'\r\n2024-12-06 22:01:57.412 DEBUG (SyncWorker_4) [zhaquirks] Loading quirks module 'zhaquirks.tuya.ts0001_fingerbot'\r\n2024-12-06 22:01:57.412 DEBUG (SyncWorker_4) [zhaquirks] Loading quirks module 'zhaquirks.tuya.ts000f_switch'\r\n2024-12-06 22:01:57.412 DEBUG (SyncWorker_4) [zhaquirks] Loading quirks module 'zhaquirks.tuya.ts000x'\r\n2024-12-06 22:01:57.412 DEBUG (SyncWorker_4) [zhaquirks] Loading quirks module 'zhaquirks.tuya.ts001x'\r\n2024-12-06 22:01:57.413 DEBUG (SyncWorker_4) [zhaquirks] Loading quirks module 'zhaquirks.tuya.ts0021'\r\n2024-12-06 22:01:57.413 DEBUG (SyncWorker_4) [zhaquirks] Loading quirks module 'zhaquirks.tuya.ts0041'\r\n2024-12-06 22:01:57.413 DEBUG (SyncWorker_4) [zhaquirks] Loading quirks module 'zhaquirks.tuya.ts0042'\r\n2024-12-06 22:01:57.413 DEBUG (SyncWorker_4) [zhaquirks] Loading quirks module 'zhaquirks.tuya.ts0043'\r\n2024-12-06 22:01:57.413 DEBUG (SyncWorker_4) [zhaquirks] Loading quirks module 'zhaquirks.tuya.ts0044'\r\n2024-12-06 22:01:57.413 DEBUG (SyncWorker_4) [zhaquirks] Loading quirks module 'zhaquirks.tuya.ts0046'\r\n2024-12-06 22:01:57.413 DEBUG (SyncWorker_4) [zhaquirks] Loading quirks module 'zhaquirks.tuya.ts004f'\r\n2024-12-06 22:01:57.413 DEBUG (SyncWorker_4) [zhaquirks] Loading quirks module 'zhaquirks.tuya.ts011f_plug'\r\n2024-12-06 22:01:57.413 DEBUG (SyncWorker_4) [zhaquirks] Loading quirks module 'zhaquirks.tuya.ts011f_switch'\r\n2024-12-06 22:01:57.413 DEBUG (SyncWorker_4) [zhaquirks] Loading quirks module 'zhaquirks.tuya.ts0121_plug'\r\n2024-12-06 22:01:57.413 DEBUG (SyncWorker_4) [zhaquirks] Loading quirks module 'zhaquirks.tuya.ts0201'\r\n2024-12-06 22:01:57.413 DEBUG (SyncWorker_4) [zhaquirks] Loading quirks module 'zhaquirks.tuya.ts0205'\r\n2024-12-06 22:01:57.413 DEBUG (SyncWorker_4) [zhaquirks] Loading quirks module 'zhaquirks.tuya.ts0210'\r\n2024-12-06 22:01:57.413 DEBUG (SyncWorker_4) [zhaquirks] Loading quirks module 'zhaquirks.tuya.ts0211'\r\n2024-12-06 22:01:57.413 DEBUG (SyncWorker_4) [zhaquirks] Loading quirks module 'zhaquirks.tuya.ts0501_fan_switch'\r\n2024-12-06 22:01:57.413 DEBUG (SyncWorker_4) [zhaquirks] Loading quirks module 'zhaquirks.tuya.ts0501b'\r\n2024-12-06 22:01:57.413 DEBUG (SyncWorker_4) [zhaquirks] Loading quirks module 'zhaquirks.tuya.ts0501bs'\r\n2024-12-06 22:01:57.413 DEBUG (SyncWorker_4) [zhaquirks] Loading quirks module 'zhaquirks.tuya.ts0601_co'\r\n2024-12-06 22:01:57.413 DEBUG (SyncWorker_4) [zhaquirks] Loading quirks module 'zhaquirks.tuya.ts0601_cover'\r\n2024-12-06 22:01:57.413 DEBUG (SyncWorker_4) [zhaquirks] Loading quirks module 'zhaquirks.tuya.ts0601_dimmer'\r\n2024-12-06 22:01:57.413 DEBUG (SyncWorker_4) [zhaquirks] Loading quirks module 'zhaquirks.tuya.ts0601_din_power'\r\n2024-12-06 22:01:57.413 DEBUG (SyncWorker_4) [zhaquirks] Loading quirks module 'zhaquirks.tuya.ts0601_electric_heating'\r\n2024-12-06 22:01:57.413 DEBUG (SyncWorker_4) [zhaquirks] Loading quirks module 'zhaquirks.tuya.ts0601_garage'\r\n2024-12-06 22:01:57.413 DEBUG (SyncWorker_4) [zhaquirks] Loading quirks module 'zhaquirks.tuya.ts0601_gas'\r\n2024-12-06 22:01:57.413 DEBUG (SyncWorker_4) [zhaquirks] Loading quirks module 'zhaquirks.tuya.ts0601_haozee'\r\n2024-12-06 22:01:57.413 DEBUG (SyncWorker_4) [zhaquirks] Loading quirks module 'zhaquirks.tuya.ts0601_illuminance'\r\n2024-12-06 22:01:57.413 DEBUG (SyncWorker_4) [zhaquirks] Loading quirks module 'zhaquirks.tuya.ts0601_motion'\r\n2024-12-06 22:01:57.413 DEBUG (SyncWorker_4) [zhaquirks] Loading quirks module 'zhaquirks.tuya.ts0601_rcbo'\r\n2024-12-06 22:01:57.413 DEBUG (SyncWorker_4) [zhaquirks] Loading quirks module 'zhaquirks.tuya.ts0601_sensor'\r\n2024-12-06 22:01:57.413 DEBUG (SyncWorker_4) [zhaquirks] Loading quirks module 'zhaquirks.tuya.ts0601_siren'\r\n2024-12-06 22:01:57.413 DEBUG (SyncWorker_4) [zhaquirks] Loading quirks module 'zhaquirks.tuya.ts0601_smoke'\r\n2024-12-06 22:01:57.414 DEBUG (SyncWorker_4) [zhaquirks] Loading quirks module 'zhaquirks.tuya.ts0601_switch'\r\n2024-12-06 22:01:57.414 DEBUG (SyncWorker_4) [zhaquirks] Loading quirks module 'zhaquirks.tuya.ts0601_trv'\r\n2024-12-06 22:01:57.414 DEBUG (SyncWorker_4) [zhaquirks] Loading quirks module 'zhaquirks.tuya.ts0601_trv_sas'\r\n2024-12-06 22:01:57.414 DEBUG (SyncWorker_4) [zhaquirks] Loading quirks module 'zhaquirks.tuya.ts0601_valve'\r\n2024-12-06 22:01:57.414 DEBUG (SyncWorker_4) [zhaquirks] Loading quirks module 'zhaquirks.tuya.ts110e'\r\n2024-12-06 22:01:57.414 DEBUG (SyncWorker_4) [zhaquirks] Loading quirks module 'zhaquirks.tuya.ts1201'\r\n2024-12-06 22:01:57.414 DEBUG (SyncWorker_4) [zhaquirks] Loading quirks module 'zhaquirks.tuya.ts130f'\r\n2024-12-06 22:01:57.414 DEBUG (SyncWorker_4) [zhaquirks] Loading quirks module 'zhaquirks.tuya.ts601_door'\r\n2024-12-06 22:01:57.414 DEBUG (SyncWorker_4) [zhaquirks] Loading quirks module 'zhaquirks.tuya.ty0201'\r\n2024-12-06 22:01:57.414 DEBUG (SyncWorker_4) [zhaquirks] Loading quirks module 'zhaquirks.universalelectronics'\r\n2024-12-06 22:01:57.415 DEBUG (SyncWorker_4) [zhaquirks] Loading quirks module 'zhaquirks.universalelectronics.contact_sensor'\r\n2024-12-06 22:01:57.416 DEBUG (SyncWorker_4) [zhaquirks] Loading quirks module 'zhaquirks.visonic'\r\n2024-12-06 22:01:57.417 DEBUG (SyncWorker_4) [zhaquirks] Loading quirks module 'zhaquirks.visonic.mct340'\r\n2024-12-06 22:01:57.417 DEBUG (SyncWorker_4) [zhaquirks] Loading quirks module 'zhaquirks.waxman'\r\n2024-12-06 22:01:57.418 DEBUG (SyncWorker_4) [zhaquirks] Loading quirks module 'zhaquirks.waxman.leaksmart'\r\n2024-12-06 22:01:57.421 DEBUG (SyncWorker_4) [zhaquirks] Loading quirks module 'zhaquirks.xbee'\r\n2024-12-06 22:01:57.421 DEBUG (SyncWorker_4) [zhaquirks] Loading quirks module 'zhaquirks.xbee.types'\r\n2024-12-06 22:01:57.421 DEBUG (SyncWorker_4) [zhaquirks] Loading quirks module 'zhaquirks.xbee.xbee3_io'\r\n2024-12-06 22:01:57.421 DEBUG (SyncWorker_4) [zhaquirks] Loading quirks module 'zhaquirks.xbee.xbee_io'\r\n2024-12-06 22:01:57.422 DEBUG (SyncWorker_4) [zhaquirks] Loading quirks module 'zhaquirks.xiaomi'\r\n2024-12-06 22:01:57.422 DEBUG (SyncWorker_4) [zhaquirks] Loading quirks module 'zhaquirks.xiaomi.aqara'\r\n2024-12-06 22:01:57.422 DEBUG (SyncWorker_4) [zhaquirks] Loading quirks module 'zhaquirks.xiaomi.aqara.ctrl_ln'\r\n2024-12-06 22:01:57.422 DEBUG (SyncWorker_4) [zhaquirks] Loading quirks module 'zhaquirks.xiaomi.aqara.ctrl_neutral'\r\n2024-12-06 22:01:57.422 DEBUG (SyncWorker_4) [zhaquirks] Loading quirks module 'zhaquirks.xiaomi.aqara.cube'\r\n2024-12-06 22:01:57.422 DEBUG (SyncWorker_4) [zhaquirks] Loading quirks module 'zhaquirks.xiaomi.aqara.cube_aqgl01'\r\n2024-12-06 22:01:57.422 DEBUG (SyncWorker_4) [zhaquirks] Loading quirks module 'zhaquirks.xiaomi.aqara.driver_curtain_e1'\r\n2024-12-06 22:01:57.422 DEBUG (SyncWorker_4) [zhaquirks] Loading quirks module 'zhaquirks.xiaomi.aqara.feeder_acn001'\r\n2024-12-06 22:01:57.422 DEBUG (SyncWorker_4) [zhaquirks] Loading quirks module 'zhaquirks.xiaomi.aqara.illumination'\r\n2024-12-06 22:01:57.423 DEBUG (SyncWorker_4) [zhaquirks] Loading quirks module 'zhaquirks.xiaomi.aqara.light_acn'\r\n2024-12-06 22:01:57.423 DEBUG (SyncWorker_4) [zhaquirks] Loading quirks module 'zhaquirks.xiaomi.aqara.light_aqcn2'\r\n2024-12-06 22:01:57.423 DEBUG (SyncWorker_4) [zhaquirks] Loading quirks module 'zhaquirks.xiaomi.aqara.magnet_ac01'\r\n2024-12-06 22:01:57.423 DEBUG (SyncWorker_4) [zhaquirks] Loading quirks module 'zhaquirks.xiaomi.aqara.magnet_acn001'\r\n2024-12-06 22:01:57.423 DEBUG (SyncWorker_4) [zhaquirks] Loading quirks module 'zhaquirks.xiaomi.aqara.magnet_agl02'\r\n2024-12-06 22:01:57.423 DEBUG (SyncWorker_4) [zhaquirks] Loading quirks module 'zhaquirks.xiaomi.aqara.magnet_aq2'\r\n2024-12-06 22:01:57.423 DEBUG (SyncWorker_4) [zhaquirks] Loading quirks module 'zhaquirks.xiaomi.aqara.motion_ac01'\r\n2024-12-06 22:01:57.423 DEBUG (SyncWorker_4) [zhaquirks] Loading quirks module 'zhaquirks.xiaomi.aqara.motion_ac02'\r\n2024-12-06 22:01:57.423 DEBUG (SyncWorker_4) [zhaquirks] Loading quirks module 'zhaquirks.xiaomi.aqara.motion_acn001'\r\n2024-12-06 22:01:57.423 DEBUG (SyncWorker_4) [zhaquirks] Loading quirks module 'zhaquirks.xiaomi.aqara.motion_agl02'\r\n2024-12-06 22:01:57.423 DEBUG (SyncWorker_4) [zhaquirks] Loading quirks module 'zhaquirks.xiaomi.aqara.motion_agl04'\r\n2024-12-06 22:01:57.423 DEBUG (SyncWorker_4) [zhaquirks] Loading quirks module 'zhaquirks.xiaomi.aqara.motion_agl1'\r\n2024-12-06 22:01:57.423 DEBUG (SyncWorker_4) [zhaquirks] Loading quirks module 'zhaquirks.xiaomi.aqara.motion_aq2'\r\n2024-12-06 22:01:57.423 DEBUG (SyncWorker_4) [zhaquirks] Loading quirks module 'zhaquirks.xiaomi.aqara.motion_aq2b'\r\n2024-12-06 22:01:57.423 DEBUG (SyncWorker_4) [zhaquirks] Loading quirks module 'zhaquirks.xiaomi.aqara.opple_remote'\r\n2024-12-06 22:01:57.423 DEBUG (SyncWorker_4) [zhaquirks] Loading quirks module 'zhaquirks.xiaomi.aqara.opple_switch'\r\n2024-12-06 22:01:57.423 DEBUG (SyncWorker_4) [zhaquirks] Loading quirks module 'zhaquirks.xiaomi.aqara.plug'\r\n2024-12-06 22:01:57.423 DEBUG (SyncWorker_4) [zhaquirks] Loading quirks module 'zhaquirks.xiaomi.aqara.plug_eu'\r\n2024-12-06 22:01:57.423 DEBUG (SyncWorker_4) [zhaquirks] Loading quirks module 'zhaquirks.xiaomi.aqara.plug_maus01'\r\n2024-12-06 22:01:57.423 DEBUG (SyncWorker_4) [zhaquirks] Loading quirks module 'zhaquirks.xiaomi.aqara.relay_c2acn01'\r\n2024-12-06 22:01:57.423 DEBUG (SyncWorker_4) [zhaquirks] Loading quirks module 'zhaquirks.xiaomi.aqara.remote_b186acn01'\r\n2024-12-06 22:01:57.423 DEBUG (SyncWorker_4) [zhaquirks] Loading quirks module 'zhaquirks.xiaomi.aqara.remote_b286acn01'\r\n2024-12-06 22:01:57.423 DEBUG (SyncWorker_4) [zhaquirks] Loading quirks module 'zhaquirks.xiaomi.aqara.remote_e1'\r\n2024-12-06 22:01:57.423 DEBUG (SyncWorker_4) [zhaquirks] Loading quirks module 'zhaquirks.xiaomi.aqara.remote_h1'\r\n2024-12-06 22:01:57.423 DEBUG (SyncWorker_4) [zhaquirks] Loading quirks module 'zhaquirks.xiaomi.aqara.roller_curtain_e1'\r\n2024-12-06 22:01:57.423 DEBUG (SyncWorker_4) [zhaquirks] Loading quirks module 'zhaquirks.xiaomi.aqara.sensor_ht_agl02'\r\n2024-12-06 22:01:57.423 DEBUG (SyncWorker_4) [zhaquirks] Loading quirks module 'zhaquirks.xiaomi.aqara.sensor_switch_aq3'\r\n2024-12-06 22:01:57.423 DEBUG (SyncWorker_4) [zhaquirks] Loading quirks module 'zhaquirks.xiaomi.aqara.smoke'\r\n2024-12-06 22:01:57.423 DEBUG (SyncWorker_4) [zhaquirks] Loading quirks module 'zhaquirks.xiaomi.aqara.switch_acn047'\r\n2024-12-06 22:01:57.423 DEBUG (SyncWorker_4) [zhaquirks] Loading quirks module 'zhaquirks.xiaomi.aqara.switch_aq2'\r\n2024-12-06 22:01:57.424 DEBUG (SyncWorker_4) [zhaquirks] Loading quirks module 'zhaquirks.xiaomi.aqara.switch_h1_double'\r\n2024-12-06 22:01:57.424 DEBUG (SyncWorker_4) [zhaquirks] Loading quirks module 'zhaquirks.xiaomi.aqara.switch_h1_single'\r\n2024-12-06 22:01:57.424 DEBUG (SyncWorker_4) [zhaquirks] Loading quirks module 'zhaquirks.xiaomi.aqara.switch_t1'\r\n2024-12-06 22:01:57.424 DEBUG (SyncWorker_4) [zhaquirks] Loading quirks module 'zhaquirks.xiaomi.aqara.thermostat_agl001'\r\n2024-12-06 22:01:57.424 DEBUG (SyncWorker_4) [zhaquirks] Loading quirks module 'zhaquirks.xiaomi.aqara.tvoc'\r\n2024-12-06 22:01:57.424 DEBUG (SyncWorker_4) [zhaquirks] Loading quirks module 'zhaquirks.xiaomi.aqara.vibration_aq1'\r\n2024-12-06 22:01:57.424 DEBUG (SyncWorker_4) [zhaquirks] Loading quirks module 'zhaquirks.xiaomi.aqara.water_acn001'\r\n2024-12-06 22:01:57.424 DEBUG (SyncWorker_4) [zhaquirks] Loading quirks module 'zhaquirks.xiaomi.aqara.water_agl02'\r\n2024-12-06 22:01:57.424 DEBUG (SyncWorker_4) [zhaquirks] Loading quirks module 'zhaquirks.xiaomi.aqara.weather'\r\n2024-12-06 22:01:57.424 DEBUG (SyncWorker_4) [zhaquirks] Loading quirks module 'zhaquirks.xiaomi.aqara.wleak_aq1'\r\n2024-12-06 22:01:57.424 DEBUG (SyncWorker_4) [zhaquirks] Loading quirks module 'zhaquirks.xiaomi.mija'\r\n2024-12-06 22:01:57.425 DEBUG (SyncWorker_4) [zhaquirks] Loading quirks module 'zhaquirks.xiaomi.mija.motion'\r\n2024-12-06 22:01:57.425 DEBUG (SyncWorker_4) [zhaquirks] Loading quirks module 'zhaquirks.xiaomi.mija.sensor_ht'\r\n2024-12-06 22:01:57.425 DEBUG (SyncWorker_4) [zhaquirks] Loading quirks module 'zhaquirks.xiaomi.mija.sensor_magnet'\r\n2024-12-06 22:01:57.425 DEBUG (SyncWorker_4) [zhaquirks] Loading quirks module 'zhaquirks.xiaomi.mija.sensor_switch'\r\n2024-12-06 22:01:57.425 DEBUG (SyncWorker_4) [zhaquirks] Loading quirks module 'zhaquirks.xiaomi.mija.smoke'\r\n2024-12-06 22:01:57.425 DEBUG (SyncWorker_4) [zhaquirks] Loading quirks module 'zhaquirks.yale'\r\n2024-12-06 22:01:57.426 DEBUG (SyncWorker_4) [zhaquirks] Loading quirks module 'zhaquirks.yale.realliving'\r\n2024-12-06 22:01:57.427 DEBUG (SyncWorker_4) [zhaquirks] Loading quirks module 'zhaquirks.zbeacon'\r\n2024-12-06 22:01:57.428 DEBUG (SyncWorker_4) [zhaquirks] Loading quirks module 'zhaquirks.zbeacon.doorsensor'\r\n2024-12-06 22:01:57.428 DEBUG (SyncWorker_4) [zhaquirks] Loading quirks module 'zhaquirks.zen'\r\n2024-12-06 22:01:57.430 DEBUG (SyncWorker_4) [zhaquirks] Loading quirks module 'zhaquirks.zen.thermostat'\r\n2024-12-06 22:01:57.430 DEBUG (SyncWorker_4) [zhaquirks] Loading quirks module 'zhaquirks.zhongxing'\r\n2024-12-06 22:01:57.431 DEBUG (SyncWorker_4) [zhaquirks] Loading quirks module 'zhaquirks.zhongxing.motion'\r\n2024-12-06 22:01:57.432 DEBUG (MainThread) [zigpy.ota] Registering new OTA provider: Ledvance(url='https://api.update.ledvance.com/v1/zigbee/firmwares', manufacturer_ids=(4489, 4364))\r\n2024-12-06 22:01:57.432 DEBUG (MainThread) [zigpy.ota] Registering new OTA provider: Sonoff(url=None, manufacturer_ids=(4742,))\r\n2024-12-06 22:01:57.432 DEBUG (MainThread) [zigpy.ota] Registering new OTA provider: Inovelli(url=None, manufacturer_ids=(4655,))\r\n2024-12-06 22:01:57.432 DEBUG (MainThread) [zigpy.ota] Registering new OTA provider: ThirdReality(url=None, manufacturer_ids=(4659, 4877, 5127))\nThe Xncp related errors should hopefully be fixed in the next patch release: 2024.12.2.\nThat's good to hear that a fix is coming. I am having the same issue with `XncpCommandId.undefined` on my Silvercrest gateway on 2024.12.1. Rollback solived it for now.", "created_at": "2024-12-08T18:06:00Z"}
{"repo": "home-assistant/core", "pull_number": 132625, "instance_id": "home-assistant__core-132625", "issue_numbers": ["113395"], "base_commit": "d32e69dcb6dd295da5c44204d92216c5b0624d38", "patch": "diff --git a/homeassistant/components/plex/server.py b/homeassistant/components/plex/server.py\nindex 0716b3606af7bf..eab1d086d4cac6 100644\n--- a/homeassistant/components/plex/server.py\n+++ b/homeassistant/components/plex/server.py\n@@ -425,9 +425,7 @@ def connect_to_resource(resource):\n                 client = resource.connect(timeout=3)\n                 _LOGGER.debug(\"Resource connection successful to plex.tv: %s\", client)\n             except NotFound:\n-                _LOGGER.error(\n-                    \"Resource connection failed to plex.tv: %s\", resource.name\n-                )\n+                _LOGGER.info(\"Resource connection failed to plex.tv: %s\", resource.name)\n             else:\n                 client.proxyThroughServer(value=False, server=self._plex_server)\n                 self._client_device_cache[client.machineIdentifier] = client\n", "test_patch": "", "problem_statement": "Random Errors with Plex Integration, trying to connect to a iPad at port 32500 \"Resource connection failed to plex.tv: iPad\"\n### The problem\n\nHi!\r\n\r\nRandomly in my homeassistant.log I have errors about the Plex integration, trying to connect to one of my iPads on port 32500 and giving read time out errors or [Errno 111] Connection refused.\r\n\r\n\n\n### What version of Home Assistant Core has the issue?\n\ncore-2024.3.0\n\n### What was the last working version of Home Assistant Core?\n\n_No response_\n\n### What type of installation are you running?\n\nHome Assistant OS\n\n### Integration causing the issue\n\nPlex\n\n### Link to integration documentation on our website\n\nhttps://www.home-assistant.io/integrations/plex/\n\n### Diagnostics information\n\n[home-assistant_plex_2024-03-14T08-26-47.798Z.log](https://github.com/home-assistant/core/files/14599588/home-assistant_plex_2024-03-14T08-26-47.798Z.log)\r\n\n\n### Example YAML snippet\n\n```yaml\nNo yaml snippet, this error is random\n```\n\n\n### Anything in the logs that might be useful for us?\n\n```txt\n2024-03-14 09:12:40.233 DEBUG (SyncWorker_61) [plexapi] GET https://192-168-0-5.47dcfd4dbe1d4cbaae581045ab6faeaf.plex.direct:32400/clients\r\n2024-03-14 09:12:40.378 DEBUG (SyncWorker_61) [plexapi] GET https://192-168-0-5.47dcfd4dbe1d4cbaae581045ab6faeaf.plex.direct:32400/status/sessions\r\n2024-03-14 09:12:40.381 DEBUG (SyncWorker_61) [plexapi] GET https://plex.tv/api/v2/resources?includeHttps=1&includeRelay=1 \r\n2024-03-14 09:12:40.672 DEBUG (SyncWorker_61) [homeassistant.components.plex.server] Current available clients from plex.tv: [<MyPlexResource:https://plex.tv/api/:iPad>]\r\n2024-03-14 09:12:40.674 DEBUG (SyncWorker_22) [plexapi] Testing 2 resource connections..\r\n2024-03-14 09:12:40.675 DEBUG (Thread-14 (_connect)) [plexapi] GET http://192.168.1.126:32500/resources\r\n2024-03-14 09:12:40.680 DEBUG (Thread-15 (_connect)) [plexapi] GET http://192.168.1.126:32500/resources\r\n2024-03-14 09:12:40.693 ERROR (Thread-14 (_connect)) [plexapi] http://192.168.1.126:32500: HTTPConnectionPool(host='192.168.1.126', port=32500): Max retries exceeded with url: /resources (Caused by NewConnectionError('<urllib3.connection.HTTPConnection object at 0x7f838e35d7f0>: Failed to establish a new connection: [Errno 111] Connection refused'))\r\n2024-03-14 09:12:40.694 ERROR (Thread-15 (_connect)) [plexapi] http://192.168.1.126:32500: HTTPConnectionPool(host='192.168.1.126', port=32500): Max retries exceeded with url: /resources (Caused by NewConnectionError('<urllib3.connection.HTTPConnection object at 0x7f839ad00620>: Failed to establish a new connection: [Errno 111] Connection refused'))\r\n2024-03-14 09:12:40.731 DEBUG (SyncWorker_22) [plexapi] Resource connection ERR (0s): http://192.168.1.126:32500?X-Plex-Token=\r\n2024-03-14 09:12:40.731 DEBUG (SyncWorker_22) [plexapi] Resource connection ERR (0s): http://192.168.1.126:32500?X-Plex-Token=\r\n2024-03-14 09:12:40.731 ERROR (SyncWorker_22) [homeassistant.components.plex.server] Resource connection failed to plex.tv: iPad\r\n2024-03-14 09:12:43.734 DEBUG (MainThread) [homeassistant.components.plex.sensor] Refreshing sensor [sensor-de732f34d8ef2efe09f4d0684d7030f7314eea74]\n```\n\n\n### Additional information\n\nThe ip address 192.168.1.126 is one of my iPads, this error occours only with this iPad, I use also another iPad, two iPhones and one Apple TV where I use the Plex Player. The Plex Media Server is up to date.\n", "hints_text": "\nHey there @jjlawren, mind taking a look at this issue as it has been labeled with an integration (`plex`) you are listed as a [code owner](https://github.com/home-assistant/core/blob/dev/CODEOWNERS#L1006) for? Thanks!\n\n<details>\n<summary>Code owner commands</summary>\n\n\nCode owners of `plex` can trigger bot actions by commenting:\n\n- `@home-assistant close` Closes the issue.\n- `@home-assistant rename Awesome new title` Renames the issue.\n- `@home-assistant reopen` Reopen the issue.\n- `@home-assistant unassign plex` Removes the current integration label and assignees on the issue, add the integration domain after the command.\n- `@home-assistant add-label needs-more-information` Add a label (needs-more-information, problem in dependency, problem in custom component) to the issue.\n- `@home-assistant remove-label needs-more-information` Remove a label (needs-more-information, problem in dependency, problem in custom component) on the issue.\n\n</details>\n\n\n<sub><sup>(message by CodeOwnersMention)</sup></sub>\n\n---\n\n[plex documentation](https://www.home-assistant.io/integrations/plex)\n[plex source](https://github.com/home-assistant/core/tree/dev/homeassistant/components/plex)\n<sub><sup>(message by IssueLinks)</sup></sub>\nThese are attempts to connect to the Plex app API on clients. It may fail if the Plex app is closed or for a variety of network reasons. These are not truly errors and can probably be downgraded to a less scary log level.\n> These are attempts to connect to the Plex app API on clients. It may fail if the Plex app is closed or for a variety of network reasons. These are not truly errors and can probably be downgraded to a less scary log level.\r\n\r\nHi, thanks for the reply. Mmm ok I understand, but how come it happens only for that specific iPad, and not for the other iPad or two iPhones and Apple TV?\r\n\r\nIn the mean time I got a new type of error:\r\n\r\n`2024-03-15 13:09:00.222 ERROR (Thread-13 (_connect)) [plexapi] http://192.168.1.126:32500: child index out of range\r\n2024-03-15 13:09:00.222 ERROR (Thread-12 (_connect)) [plexapi] http://192.168.1.126:32500: child index out of range\r\n`\nThere hasn't been any activity on this issue recently. Due to the high number of incoming GitHub notifications, we have to clean some of the old issues, as many of them have already been resolved with the latest updates.\nPlease make sure to update to the latest Home Assistant version and check if that solves the issue. Let us know if that works for you by adding a comment \ud83d\udc4d\nThis issue has now been marked as stale and will be closed if no further activity occurs. Thank you for your contributions.", "created_at": "2024-12-08T16:21:01Z"}
{"repo": "home-assistant/core", "pull_number": 132615, "instance_id": "home-assistant__core-132615", "issue_numbers": ["132539"], "base_commit": "a8713af8b8f226a691754d513fbb6b8906a2228a", "patch": "diff --git a/homeassistant/components/husqvarna_automower/config_flow.py b/homeassistant/components/husqvarna_automower/config_flow.py\nindex 4da3bd14089175..7efed529453b47 100644\n--- a/homeassistant/components/husqvarna_automower/config_flow.py\n+++ b/homeassistant/components/husqvarna_automower/config_flow.py\n@@ -53,10 +53,10 @@ async def async_oauth_create_entry(self, data: dict[str, Any]) -> ConfigFlowResu\n         tz = await dt_util.async_get_time_zone(str(dt_util.DEFAULT_TIME_ZONE))\n         automower_api = AutomowerSession(AsyncConfigFlowAuth(websession, token), tz)\n         try:\n-            data = await automower_api.get_status()\n+            status_data = await automower_api.get_status()\n         except Exception:  # noqa: BLE001\n             return self.async_abort(reason=\"unknown\")\n-        if data == {}:\n+        if status_data == {}:\n             return self.async_abort(reason=\"no_mower_connected\")\n \n         structured_token = structure_token(token[CONF_ACCESS_TOKEN])\n", "test_patch": "", "problem_statement": "Husqvarna Automower Failed to set up\n### The problem\r\n\r\nFailed to set up connection to Husqvarna Automower\r\n\r\n### What version of Home Assistant Core has the issue?\r\n\r\ncore-2024.12.1\r\n\r\n### What was the last working version of Home Assistant Core?\r\n\r\n_No response_\r\n\r\n### What type of installation are you running?\r\n\r\nHome Assistant OS\r\n\r\n### Integration causing the issue\r\n\r\nHusqvarna Automower\r\n\r\n### Link to integration documentation on our website\r\n\r\nhttps://www.home-assistant.io/integrations/husqvarna_automower/\r\n\r\n### Diagnostics information\r\n\r\nNo devices or entities\r\n\r\nFailed to set up:\r\nCheck the logs\r\n\r\n### Example YAML snippet\r\n\r\n_No response_\r\n\r\n### Anything in the logs that might be useful for us?\r\n\r\n```txt\r\nRegistratore: homeassistant.config_entries\r\nFonte: config_entries.py:640\r\nPrima occorrenza: 09:41:13 (2 occorrenze)\r\nUltimo accesso: 09:41:56\r\n\r\nError setting up entry Husqvarna Automower of Valerio Luca Trombetta for husqvarna_automower\r\nTraceback (most recent call last):\r\n  File \"/usr/src/homeassistant/homeassistant/config_entries.py\", line 640, in __async_setup_with_context\r\n    result = await component.async_setup_entry(hass, self)\r\n             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/src/homeassistant/homeassistant/components/husqvarna_automower/__init__.py\", line 44, in async_setup_entry\r\n    await config_entry_oauth2_flow.async_get_config_entry_implementation(\r\n        hass, entry\r\n    )\r\n  File \"/usr/src/homeassistant/homeassistant/helpers/config_entry_oauth2_flow.py\", line 428, in async_get_config_entry_implementation\r\n    implementation = implementations.get(config_entry.data[\"auth_implementation\"])\r\n                                         ~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^\r\nKeyError: 'auth_implementation'\r\n\r\n\r\nRegistratore: homeassistant\r\nFonte: config_entries.py:537\r\nPrima occorrenza: 09:41:14 (3 occorrenze)\r\nUltimo accesso: 09:45:47\r\n\r\nError doing job: Task exception was never retrieved (None)\r\nTraceback (most recent call last):\r\n  File \"/usr/src/homeassistant/homeassistant/helpers/json.py\", line 87, in json_encoder_default\r\n    raise TypeError\r\nTypeError\r\n\r\nThe above exception was the direct cause of the following exception:\r\n\r\nTraceback (most recent call last):\r\n  File \"/usr/src/homeassistant/homeassistant/helpers/storage.py\", line 516, in _async_callback_delayed_write\r\n    await self._async_handle_write_data()\r\n  File \"/usr/src/homeassistant/homeassistant/helpers/storage.py\", line 541, in _async_handle_write_data\r\n    await self._async_write_data(self.path, data)\r\n  File \"/usr/src/homeassistant/homeassistant/helpers/storage.py\", line 546, in _async_write_data\r\n    await self.hass.async_add_executor_job(self._write_data, self.path, data)\r\n  File \"/usr/local/lib/python3.13/concurrent/futures/thread.py\", line 58, in run\r\n    result = self.fn(*self.args, **self.kwargs)\r\n  File \"/usr/src/homeassistant/homeassistant/helpers/storage.py\", line 553, in _write_data\r\n    data[\"data\"] = data.pop(\"data_func\")()\r\n                   ~~~~~~~~~~~~~~~~~~~~~^^\r\n  File \"/usr/src/homeassistant/homeassistant/config_entries.py\", line 2432, in _data_to_save\r\n    \"entries\": [entry.as_storage_fragment for entry in self._entries.values()]  # type: ignore[misc]\r\n                ^^^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"src/propcache/_helpers_c.pyx\", line 80, in propcache._helpers_c.cached_property.__get__\r\n  File \"/usr/src/homeassistant/homeassistant/config_entries.py\", line 537, in as_storage_fragment\r\n    return json_fragment(json_bytes_sorted(self.as_dict()))\r\n                         ~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^\r\nTypeError: Type is not JSON serializable: datetime.timedelta\r\n```\r\n\r\n\r\n### Additional information\r\n\r\n_No response_\n", "hints_text": "\nHey there @thomas55555, mind taking a look at this issue as it has been labeled with an integration (`husqvarna_automower`) you are listed as a [code owner](https://github.com/home-assistant/core/blob/dev/CODEOWNERS#L662) for? Thanks!\n\n<details>\n<summary>Code owner commands</summary>\n\n\nCode owners of `husqvarna_automower` can trigger bot actions by commenting:\n\n- `@home-assistant close` Closes the issue.\n- `@home-assistant rename Awesome new title` Renames the issue.\n- `@home-assistant reopen` Reopen the issue.\n- `@home-assistant unassign husqvarna_automower` Removes the current integration label and assignees on the issue, add the integration domain after the command.\n- `@home-assistant add-label needs-more-information` Add a label (needs-more-information, problem in dependency, problem in custom component) to the issue.\n- `@home-assistant remove-label needs-more-information` Remove a label (needs-more-information, problem in dependency, problem in custom component) on the issue.\n\n</details>\n\n\n<sub><sup>(message by CodeOwnersMention)</sup></sub>\n\n---\n\n[husqvarna_automower documentation](https://www.home-assistant.io/integrations/husqvarna_automower)\n[husqvarna_automower source](https://github.com/home-assistant/core/tree/dev/homeassistant/components/husqvarna_automower)\n<sub><sup>(message by IssueLinks)</sup></sub>\nHi. Are you already using this integration or did you tried to set it up the first time?\nI used the custom component, after removing it and restarting HA, I tried to add it with the official integration. Unfortunately, during the first setup, after giving approval from the Husquarna page, I end up with the error.\nI would rule out API, although I received the email that something will change next year.", "created_at": "2024-12-08T13:48:37Z"}
{"repo": "home-assistant/core", "pull_number": 132596, "instance_id": "home-assistant__core-132596", "issue_numbers": ["86922"], "base_commit": "a8713af8b8f226a691754d513fbb6b8906a2228a", "patch": "diff --git a/homeassistant/components/nederlandse_spoorwegen/manifest.json b/homeassistant/components/nederlandse_spoorwegen/manifest.json\nindex 8a8a20c453b72c..0ef9d8d86f3aef 100644\n--- a/homeassistant/components/nederlandse_spoorwegen/manifest.json\n+++ b/homeassistant/components/nederlandse_spoorwegen/manifest.json\n@@ -5,5 +5,5 @@\n   \"documentation\": \"https://www.home-assistant.io/integrations/nederlandse_spoorwegen\",\n   \"iot_class\": \"cloud_polling\",\n   \"quality_scale\": \"legacy\",\n-  \"requirements\": [\"nsapi==3.0.5\"]\n+  \"requirements\": [\"nsapi==3.1.2\"]\n }\ndiff --git a/requirements_all.txt b/requirements_all.txt\nindex fcd28e2bc1a72d..2011d1ce0b5a0e 100644\n--- a/requirements_all.txt\n+++ b/requirements_all.txt\n@@ -1478,7 +1478,7 @@ notifications-android-tv==0.1.5\n notify-events==1.0.4\n \n # homeassistant.components.nederlandse_spoorwegen\n-nsapi==3.0.5\n+nsapi==3.1.2\n \n # homeassistant.components.nsw_fuel_station\n nsw-fuel-api-client==1.1.0\n", "test_patch": "", "problem_statement": "Error on device update (KeyError: 'operatorName') - Please update Nederlandse Spoorwegen to 3.1.0\n### The problem\n\nDear,\r\n\r\nCould you update the plugin/component to 3.1.0 of Nederlandse Spoorwegen:\r\nhttps://github.com/aquatix/ns-api/releases/tag/v3.1.0\r\nhttps://github.com/aquatix/ns-api/issues/32\r\n\r\nThis fixes the issue i got now.\r\n\r\nThank you.\r\nKind regards.\r\nSander Lambrechts\n\n### What version of Home Assistant Core has the issue?\n\n2023.1.7\n\n### What was the last working version of Home Assistant Core?\n\n_No response_\n\n### What type of installation are you running?\n\nHome Assistant Container\n\n### Integration causing the issue\n\nNederlandse Spoorwegen\n\n### Link to integration documentation on our website\n\nhttps://www.home-assistant.io/integrations/nederlandse_spoorwegen/\n\n### Diagnostics information\n\n_No response_\n\n### Example YAML snippet\n\n_No response_\n\n### Anything in the logs that might be useful for us?\n\n```txt\n2023-01-29 23:29:59.785 ERROR (MainThread) [homeassistant.components.sensor] nederlandse_spoorwegen: Error on device update!\r\nTraceback (most recent call last):\r\n  File \"/usr/src/homeassistant/homeassistant/helpers/entity_platform.py\", line 503, in _async_add_entity\r\n    await entity.async_device_update(warning=False)\r\n  File \"/usr/src/homeassistant/homeassistant/helpers/entity.py\", line 729, in async_device_update\r\n    await task\r\n  File \"/usr/local/lib/python3.10/concurrent/futures/thread.py\", line 58, in run\r\n    result = self.fn(*self.args, **self.kwargs)\r\n  File \"/usr/src/homeassistant/homeassistant/util/__init__.py\", line 192, in wrapper\r\n    result = method(*args, **kwargs)\r\n  File \"/usr/src/homeassistant/homeassistant/components/nederlandse_spoorwegen/sensor.py\", line 243, in update\r\n    self._trips = self._nsapi.get_trips(\r\n  File \"/usr/local/lib/python3.10/site-packages/ns_api.py\", line 928, in get_trips\r\n    return self.parse_trips(raw_trips, requested_time)\r\n  File \"/usr/local/lib/python3.10/site-packages/ns_api.py\", line 839, in parse_trips\r\n    newtrip = Trip(trip, requested_time)\r\n  File \"/usr/local/lib/python3.10/site-packages/ns_api.py\", line 608, in __init__\r\n    trip_part = TripSubpart(part)\r\n  File \"/usr/local/lib/python3.10/site-packages/ns_api.py\", line 442, in __init__\r\n    self.transporter = part_dict['product']['operatorName']\r\nKeyError: 'operatorName'\n```\n\n\n### Additional information\n\n_No response_\n", "hints_text": "\nHey there @yarmom, mind taking a look at this issue as it has been labeled with an integration (`nederlandse_spoorwegen`) you are listed as a [code owner](https://github.com/home-assistant/core/blob/dev/CODEOWNERS#L767) for? Thanks!\n\n<details>\n<summary>Code owner commands</summary>\n\n\nCode owners of `nederlandse_spoorwegen` can trigger bot actions by commenting:\n\n- `@home-assistant close` Closes the issue.\n- `@home-assistant rename Awesome new title` Change the title of the issue.\n- `@home-assistant reopen` Reopen the issue.\n- `@home-assistant unassign nederlandse_spoorwegen` Removes the current integration label and assignees on the issue, add the integration domain after the command.\n\n</details>\n\n\n<sub><sup>(message by CodeOwnersMention)</sup></sub>\n\n---\n\n[nederlandse_spoorwegen documentation](https://www.home-assistant.io/integrations/nederlandse_spoorwegen)\n[nederlandse_spoorwegen source](https://github.com/home-assistant/core/tree/dev/homeassistant/components/nederlandse_spoorwegen)\n<sub><sup>(message by IssueLinks)</sup></sub>\nThere hasn't been any activity on this issue recently. Due to the high number of incoming GitHub notifications, we have to clean some of the old issues, as many of them have already been resolved with the latest updates.\nPlease make sure to update to the latest Home Assistant version and check if that solves the issue. Let us know if that works for you by adding a comment \ud83d\udc4d\nThis issue has now been marked as stale and will be closed if no further activity occurs. Thank you for your contributions.", "created_at": "2024-12-08T09:57:33Z"}
{"repo": "home-assistant/core", "pull_number": 132560, "instance_id": "home-assistant__core-132560", "issue_numbers": ["125086"], "base_commit": "b9002d0c64a766962a92445a124b94df2c137f92", "patch": "diff --git a/homeassistant/components/august/manifest.json b/homeassistant/components/august/manifest.json\nindex 96ed982e4ec9b7..99dbbc0ed9c8d7 100644\n--- a/homeassistant/components/august/manifest.json\n+++ b/homeassistant/components/august/manifest.json\n@@ -28,5 +28,5 @@\n   \"documentation\": \"https://www.home-assistant.io/integrations/august\",\n   \"iot_class\": \"cloud_push\",\n   \"loggers\": [\"pubnub\", \"yalexs\"],\n-  \"requirements\": [\"yalexs==8.10.0\", \"yalexs-ble==2.5.1\"]\n+  \"requirements\": [\"yalexs==8.10.0\", \"yalexs-ble==2.5.2\"]\n }\ndiff --git a/homeassistant/components/yale/manifest.json b/homeassistant/components/yale/manifest.json\nindex 50c2a0af457eb1..474ed36e90cfb9 100644\n--- a/homeassistant/components/yale/manifest.json\n+++ b/homeassistant/components/yale/manifest.json\n@@ -13,5 +13,5 @@\n   \"documentation\": \"https://www.home-assistant.io/integrations/yale\",\n   \"iot_class\": \"cloud_push\",\n   \"loggers\": [\"socketio\", \"engineio\", \"yalexs\"],\n-  \"requirements\": [\"yalexs==8.10.0\", \"yalexs-ble==2.5.1\"]\n+  \"requirements\": [\"yalexs==8.10.0\", \"yalexs-ble==2.5.2\"]\n }\ndiff --git a/homeassistant/components/yalexs_ble/manifest.json b/homeassistant/components/yalexs_ble/manifest.json\nindex c3d1a3d97f1437..95d28cd53721db 100644\n--- a/homeassistant/components/yalexs_ble/manifest.json\n+++ b/homeassistant/components/yalexs_ble/manifest.json\n@@ -12,5 +12,5 @@\n   \"dependencies\": [\"bluetooth_adapters\"],\n   \"documentation\": \"https://www.home-assistant.io/integrations/yalexs_ble\",\n   \"iot_class\": \"local_push\",\n-  \"requirements\": [\"yalexs-ble==2.5.1\"]\n+  \"requirements\": [\"yalexs-ble==2.5.2\"]\n }\ndiff --git a/requirements_all.txt b/requirements_all.txt\nindex 45ba64f6dc87dc..489a3aa43331a7 100644\n--- a/requirements_all.txt\n+++ b/requirements_all.txt\n@@ -3044,7 +3044,7 @@ yalesmartalarmclient==0.4.3\n # homeassistant.components.august\n # homeassistant.components.yale\n # homeassistant.components.yalexs_ble\n-yalexs-ble==2.5.1\n+yalexs-ble==2.5.2\n \n # homeassistant.components.august\n # homeassistant.components.yale\n", "test_patch": "diff --git a/requirements_test_all.txt b/requirements_test_all.txt\nindex f18e7e177a25fe..3b30f55b30c1f5 100644\n--- a/requirements_test_all.txt\n+++ b/requirements_test_all.txt\n@@ -2436,7 +2436,7 @@ yalesmartalarmclient==0.4.3\n # homeassistant.components.august\n # homeassistant.components.yale\n # homeassistant.components.yalexs_ble\n-yalexs-ble==2.5.1\n+yalexs-ble==2.5.2\n \n # homeassistant.components.august\n # homeassistant.components.yale\n", "problem_statement": "Yale Linus L2 stuck in initializing\n### The problem\n\nThe lock is stuck in 'initializing'. \r\n\r\nIt works great with the Yale Home (new in 2024.9.0b) and August Yale Home integration, and the Yale Access Bluetooth integration picked up the lock on bluetooth quickly, imported Offline_keys from the August integration and created new entities as it should.\r\n\r\nBut the lock continues a loop of 'initializing'.\r\n\r\nIt looks like the RSSI is -61, and the bluetooth integration doesn't appear to complain about connectivity?\r\n\r\nIs it simply because this lock is not (yet) supported?\r\n\r\nLogs from the yalexs_ble log:\r\n\r\n```\r\nThe above exception was the direct cause of the following exception:\r\n\r\nTraceback (most recent call last):\r\n  File \"/usr/local/lib/python3.12/site-packages/yalexs_ble/push.py\", line 1020, in _execute_deferred_update\r\n    await self._update()\r\n  File \"/usr/local/lib/python3.12/site-packages/yalexs_ble/push.py\", line 113, in _async_wrap_operation_lock\r\n    return await func(self, *args, **kwargs)\r\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/local/lib/python3.12/site-packages/yalexs_ble/push.py\", line 157, in _async_wrap_retry_bluetooth_connection_error\r\n    return await func(self, *args, **kwargs)\r\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/local/lib/python3.12/site-packages/yalexs_ble/push.py\", line 707, in _update\r\n    lock = await self._ensure_connected()\r\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/local/lib/python3.12/site-packages/yalexs_ble/push.py\", line 566, in _ensure_connected\r\n    await self._client.connect(max_attempts)\r\n  File \"/usr/local/lib/python3.12/site-packages/yalexs_ble/lock.py\", line 188, in connect\r\n    await self._setup_session()\r\n  File \"/usr/local/lib/python3.12/site-packages/yalexs_ble/lock.py\", line 246, in _setup_session\r\n    response = await self.secure_session.execute(\r\n               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/local/lib/python3.12/site-packages/yalexs_ble/session.py\", line 268, in execute\r\n    async with interrupt(\r\n  File \"/usr/local/lib/python3.12/site-packages/async_interrupt/__init__.py\", line 89, in __aexit__\r\n    raise self._exception(self._message) from exc_val\r\nyalexs_ble.session.DisconnectedError: Ford\u00f8r (B0:44:9C:13:03:39): Disconnected\r\n2024-09-02 15:50:41.099 ERROR (MainThread) [yalexs_ble.push] Ford\u00f8r (B0:44:9C:13:03:39): Disconnected while updating\r\nTraceback (most recent call last):\r\n  File \"/usr/local/lib/python3.12/site-packages/yalexs_ble/session.py\", line 271, in execute\r\n    return await self._write(command, command_name)\r\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/local/lib/python3.12/site-packages/yalexs_ble/session.py\", line 139, in _write\r\n    return await self._locked_write(command, command_name)\r\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/local/lib/python3.12/site-packages/yalexs_ble/session.py\", line 197, in _locked_write\r\n    result = await future\r\n             ^^^^^^^^^^^^\r\nasyncio.exceptions.CancelledError: Interrupted by interrupt context manager\r\n\r\nThe above exception was the direct cause of the following exception:\r\n\r\nTraceback (most recent call last):\r\n  File \"/usr/local/lib/python3.12/site-packages/yalexs_ble/push.py\", line 1020, in _execute_deferred_update\r\n    await self._update()\r\n  File \"/usr/local/lib/python3.12/site-packages/yalexs_ble/push.py\", line 113, in _async_wrap_operation_lock\r\n    return await func(self, *args, **kwargs)\r\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/local/lib/python3.12/site-packages/yalexs_ble/push.py\", line 157, in _async_wrap_retry_bluetooth_connection_error\r\n    return await func(self, *args, **kwargs)\r\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/local/lib/python3.12/site-packages/yalexs_ble/push.py\", line 707, in _update\r\n    lock = await self._ensure_connected()\r\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/local/lib/python3.12/site-packages/yalexs_ble/push.py\", line 566, in _ensure_connected\r\n    await self._client.connect(max_attempts)\r\n  File \"/usr/local/lib/python3.12/site-packages/yalexs_ble/lock.py\", line 188, in connect\r\n    await self._setup_session()\r\n  File \"/usr/local/lib/python3.12/site-packages/yalexs_ble/lock.py\", line 246, in _setup_session\r\n    response = await self.secure_session.execute(\r\n               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/local/lib/python3.12/site-packages/yalexs_ble/session.py\", line 268, in execute\r\n    async with interrupt(\r\n  File \"/usr/local/lib/python3.12/site-packages/async_interrupt/__init__.py\", line 89, in __aexit__\r\n    raise self._exception(self._message) from exc_val\r\nyalexs_ble.session.DisconnectedError: Ford\u00f8r (B0:44:9C:13:03:39): Disconnected\r\n```\r\n\r\nFrom bluetooth debug log:\r\n\r\n```\r\n2024-09-02 15:44:27.497 DEBUG (MainThread) [bleak_retry_connector] Ford\u00f8r (B0:44:9C:13:03:39) - B0:44:9C:13:03:39: Connection attempt: 1\r\n2024-09-02 15:44:33.603 DEBUG (MainThread) [homeassistant.components.bluetooth.manager] hci0 (00:1A:7D:DA:71:13) [connectable]: <BluetoothServiceInfoBleak name=LPOF1000XH address=B0:44:9C:13:03:39 rssi=-68 manufacturer_data={465: b'\\x00\\x009==\\xc4\\xb4\\x98\\x02\\x04\\xdd\\xban\\x1c\\xc3<~P'} service_data={} service_uuids=['00001800-0000-1000-8000-00805f9b34fb', '00001801-0000-1000-8000-00805f9b34fb', '0000180a-0000-1000-8000-00805f9b34fb', '0000fe24-0000-1000-8000-00805f9b34fb'] source=00:1A:7D:DA:71:13 connectable=True time=17880.019265021 tx_power=None> match: set()\r\n2024-09-02 15:44:34.597 DEBUG (MainThread) [bleak_retry_connector] Ford\u00f8r (B0:44:9C:13:03:39) - B0:44:9C:13:03:39: Connected after 1 attempts\r\n```\n\n### What version of Home Assistant Core has the issue?\n\ncore-2024.9.0b2\n\n### What was the last working version of Home Assistant Core?\n\n_No response_\n\n### What type of installation are you running?\n\nHome Assistant OS\n\n### Integration causing the issue\n\nyalexs_ble\n\n### Link to integration documentation on our website\n\nhttps://www.home-assistant.io/integrations/yalexs_ble\n\n### Diagnostics information\n\n_No response_\n\n### Example YAML snippet\n\n_No response_\n\n### Anything in the logs that might be useful for us?\n\n_No response_\n\n### Additional information\n\n_No response_\n", "hints_text": "\nHey there @bdraco, mind taking a look at this issue as it has been labeled with an integration (`yalexs_ble`) you are listed as a [code owner](https://github.com/home-assistant/core/blob/dev/CODEOWNERS#L1678) for? Thanks!\n\n<details>\n<summary>Code owner commands</summary>\n\n\nCode owners of `yalexs_ble` can trigger bot actions by commenting:\n\n- `@home-assistant close` Closes the issue.\n- `@home-assistant rename Awesome new title` Renames the issue.\n- `@home-assistant reopen` Reopen the issue.\n- `@home-assistant unassign yalexs_ble` Removes the current integration label and assignees on the issue, add the integration domain after the command.\n- `@home-assistant add-label needs-more-information` Add a label (needs-more-information, problem in dependency, problem in custom component) to the issue.\n- `@home-assistant remove-label needs-more-information` Remove a label (needs-more-information, problem in dependency, problem in custom component) on the issue.\n\n</details>\n\n\n<sub><sup>(message by CodeOwnersMention)</sup></sub>\n\n---\n\n[yalexs_ble documentation](https://www.home-assistant.io/integrations/yalexs_ble)\n[yalexs_ble source](https://github.com/home-assistant/core/tree/dev/homeassistant/components/yalexs_ble)\n<sub><sup>(message by IssueLinks)</sup></sub>\nThis isn't a regression in `yalexs_ble` since there aren't changes there for 2024.9.x.  I removed the milestone\nThe Linux L2 isn't tested with this integration https://www.home-assistant.io/integrations/yalexs_ble so it may not work.\r\n\r\nHowever most of the problem are usually due to the Bluetooth Adapter.\r\n\r\nThese locks seem to work best with this ESPHome Bluetooth proxy option:\r\nhttps://www.olimex.com/Products/IoT/ESP32/ESP32-POE-ISO-EA/open-source-hardware\r\nhttps://www.olimex.com/Products/IoT/ESP32/BOX-ESP32-POE-ISO/\r\n\nThere hasn't been any activity on this issue recently. Due to the high number of incoming GitHub notifications, we have to clean some of the old issues, as many of them have already been resolved with the latest updates.\nPlease make sure to update to the latest Home Assistant version and check if that solves the issue. Let us know if that works for you by adding a comment \ud83d\udc4d\nThis issue has now been marked as stale and will be closed if no further activity occurs. Thank you for your contributions.", "created_at": "2024-12-07T15:26:52Z"}
{"repo": "home-assistant/core", "pull_number": 132540, "instance_id": "home-assistant__core-132540", "issue_numbers": ["132518"], "base_commit": "35fa6e5121f512c6f1170ba51c8b68c43cee0449", "patch": "diff --git a/homeassistant/components/unifi/manifest.json b/homeassistant/components/unifi/manifest.json\nindex 66d0a53284b1ce..ce5735921537b5 100644\n--- a/homeassistant/components/unifi/manifest.json\n+++ b/homeassistant/components/unifi/manifest.json\n@@ -7,7 +7,7 @@\n   \"integration_type\": \"hub\",\n   \"iot_class\": \"local_push\",\n   \"loggers\": [\"aiounifi\"],\n-  \"requirements\": [\"aiounifi==80\"],\n+  \"requirements\": [\"aiounifi==81\"],\n   \"ssdp\": [\n     {\n       \"manufacturer\": \"Ubiquiti Networks\",\ndiff --git a/requirements_all.txt b/requirements_all.txt\nindex 6aa081a720e3e4..17b5fa08616c52 100644\n--- a/requirements_all.txt\n+++ b/requirements_all.txt\n@@ -399,7 +399,7 @@ aiotedee==0.2.20\n aiotractive==0.6.0\n \n # homeassistant.components.unifi\n-aiounifi==80\n+aiounifi==81\n \n # homeassistant.components.vlc_telnet\n aiovlc==0.5.1\n", "test_patch": "diff --git a/requirements_test_all.txt b/requirements_test_all.txt\nindex c479c95f7e99e1..4d9e6e5702d24e 100644\n--- a/requirements_test_all.txt\n+++ b/requirements_test_all.txt\n@@ -381,7 +381,7 @@ aiotedee==0.2.20\n aiotractive==0.6.0\n \n # homeassistant.components.unifi\n-aiounifi==80\n+aiounifi==81\n \n # homeassistant.components.vlc_telnet\n aiovlc==0.5.1\n", "problem_statement": "Exception on update Call https://x.x.x.x:443/proxy/network/v2/api/site/default/trafficrules received 401 Unauthorized\n### The problem\r\n\r\nThe Unify add-on suddenly is causing a log of logging errors in the system.\r\n\r\nException on update Call https://192.168.2.1:443/proxy/network/v2/api/site/default/trafficrules received 401 Unauthorized\r\n\r\n### What version of Home Assistant Core has the issue?\r\n\r\n2024.12.0 + 2024.12.1\r\n\r\n### What was the last working version of Home Assistant Core?\r\n\r\n2024.11.x\r\n\r\n### What type of installation are you running?\r\n\r\nHome Assistant OS\r\n\r\n### Integration causing the issue\r\n\r\nUniFi Network\r\n\r\n### Link to integration documentation on our website\r\n\r\n_No response_\r\n\r\n### Diagnostics information\r\n\r\n_No response_\r\n\r\n### Example YAML snippet\r\n\r\n_No response_\r\n\r\n### Anything in the logs that might be useful for us?\r\n\r\n```txt\r\nLogger: homeassistant.components.unifi\r\nBron: components/unifi/hub/entity_loader.py:94\r\nintegratie: UniFi Network ([documentatie](https://www.home-assistant.io/integrations/unifi), [problemen](https://github.com/home-assistant/core/issues?q=is%3Aissue+is%3Aopen+label%3A%22integration%3A+unifi%22))\r\nEerst voorgekomen: 22:21:00 (7 gebeurtenissen)\r\nLaatst gelogd: 22:22:00\r\n\r\nException on update Call https://x.x.x.x:443/proxy/network/v2/api/site/default/trafficrules received 401 Unauthorized\r\n```\r\n\r\n\r\n### Additional information\r\n\r\nHapped after upgrading to 2024.12. Before that it worked fine.\r\nRestarted my Unify router. Restarted HomeAssistant. Disabled and enabled te add-on. The issue remains. Al network devices to seem to be available. Only suddenly a lot of log errors.\n", "hints_text": "\nHey there @kane610, mind taking a look at this issue as it has been labeled with an integration (`unifi`) you are listed as a [code owner](https://github.com/home-assistant/core/blob/dev/CODEOWNERS#L1576) for? Thanks!\n\n<details>\n<summary>Code owner commands</summary>\n\n\nCode owners of `unifi` can trigger bot actions by commenting:\n\n- `@home-assistant close` Closes the issue.\n- `@home-assistant rename Awesome new title` Renames the issue.\n- `@home-assistant reopen` Reopen the issue.\n- `@home-assistant unassign unifi` Removes the current integration label and assignees on the issue, add the integration domain after the command.\n- `@home-assistant add-label needs-more-information` Add a label (needs-more-information, problem in dependency, problem in custom component) to the issue.\n- `@home-assistant remove-label needs-more-information` Remove a label (needs-more-information, problem in dependency, problem in custom component) on the issue.\n\n</details>\n\n\n<sub><sup>(message by CodeOwnersMention)</sup></sub>\n\n---\n\n[unifi documentation](https://www.home-assistant.io/integrations/unifi)\n[unifi source](https://github.com/home-assistant/core/tree/dev/homeassistant/components/unifi)\n<sub><sup>(message by IssueLinks)</sup></sub>", "created_at": "2024-12-07T08:47:03Z"}
{"repo": "home-assistant/core", "pull_number": 132531, "instance_id": "home-assistant__core-132531", "issue_numbers": ["132236"], "base_commit": "16484dcee5dbffd6f0d1497c33c6b9beea480905", "patch": "diff --git a/homeassistant/components/totalconnect/manifest.json b/homeassistant/components/totalconnect/manifest.json\nindex 87ec14621d9711..33306a7adbac24 100644\n--- a/homeassistant/components/totalconnect/manifest.json\n+++ b/homeassistant/components/totalconnect/manifest.json\n@@ -6,5 +6,5 @@\n   \"documentation\": \"https://www.home-assistant.io/integrations/totalconnect\",\n   \"iot_class\": \"cloud_polling\",\n   \"loggers\": [\"total_connect_client\"],\n-  \"requirements\": [\"total-connect-client==2024.5\"]\n+  \"requirements\": [\"total-connect-client==2024.12\"]\n }\ndiff --git a/homeassistant/components/totalconnect/quality_scale.yaml b/homeassistant/components/totalconnect/quality_scale.yaml\nindex e52011d7d48207..a8e5b60f7ee017 100644\n--- a/homeassistant/components/totalconnect/quality_scale.yaml\n+++ b/homeassistant/components/totalconnect/quality_scale.yaml\n@@ -10,7 +10,7 @@ rules:\n   entity-unique-id: done\n   has-entity-name: done\n   entity-event-setup: todo\n-  dependency-transparency: todo\n+  dependency-transparency: done\n   action-setup: todo\n   common-modules: done\n   docs-high-level-description: done\ndiff --git a/requirements_all.txt b/requirements_all.txt\nindex 4d114841761b32..b138126e1d54ec 100644\n--- a/requirements_all.txt\n+++ b/requirements_all.txt\n@@ -2861,7 +2861,7 @@ tololib==1.1.0\n toonapi==0.3.0\n \n # homeassistant.components.totalconnect\n-total-connect-client==2024.5\n+total-connect-client==2024.12\n \n # homeassistant.components.tplink_lte\n tp-connected==0.0.4\n", "test_patch": "diff --git a/requirements_test_all.txt b/requirements_test_all.txt\nindex 9c0d22b51ec87f..862b224b4e8385 100644\n--- a/requirements_test_all.txt\n+++ b/requirements_test_all.txt\n@@ -2280,7 +2280,7 @@ tololib==1.1.0\n toonapi==0.3.0\n \n # homeassistant.components.totalconnect\n-total-connect-client==2024.5\n+total-connect-client==2024.12\n \n # homeassistant.components.tplink_omada\n tplink-omada-client==1.4.3\n", "problem_statement": "Unable to log in and add TotalConnect integration\n### The problem\r\n\r\nWhen attempting to log in to TotalConnect I get an error `TypeError: 'NoneType' object is not subscriptable`. Digging in to the issue, the login process is failing. I confirmed I can log in to the UI client with the username and password provided so the account is active and working.\r\n\r\n### What version of Home Assistant Core has the issue?\r\n\r\ncore-2024.11.3\r\n\r\n### What was the last working version of Home Assistant Core?\r\n\r\ncore-2024.10.4\r\n\r\n### What type of installation are you running?\r\n\r\nHome Assistant Core\r\n\r\n### Integration causing the issue\r\n\r\nTotal Connect\r\n\r\n### Link to integration documentation on our website\r\n\r\nhttps://www.home-assistant.io/integrations/totalconnect/\r\n\r\n### Diagnostics information\r\n\r\n_No response_\r\n\r\n### Example YAML snippet\r\n\r\n```yaml\r\nlogger:\r\n  default: info\r\n  logs:\r\n    homeassistant.loader: warning\r\n    homeassistant.setup: warning\r\n    homeassistant.components.totalconnect: debug\r\n    total_connect_client: debug\r\n    zeep.transports: debug\r\n```\r\n\r\n\r\n### Anything in the logs that might be useful for us?\r\n\r\n```txt\r\nLogger: homeassistant.config_entries\r\nSource: config_entries.py:635\r\nFirst occurred: 21:57:14 (1 occurrences)\r\nLast logged: 21:57:14\r\n\r\nError setting up entry Total Connect for totalconnect\r\nTraceback (most recent call last):\r\n  File \"/srv/ha-2024.11.3/lib/python3.12/site-packages/homeassistant/config_entries.py\", line 635, in __async_setup_with_context\r\n    result = await component.async_setup_entry(hass, self)\r\n             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/srv/ha-2024.11.3/lib/python3.12/site-packages/homeassistant/components/totalconnect/__init__.py\", line 32, in async_setup_entry\r\n    client = await hass.async_add_executor_job(\r\n             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/local/lib/python3.12/concurrent/futures/thread.py\", line 58, in run\r\n    result = self.fn(*self.args, **self.kwargs)\r\n             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/srv/ha-2024.11.3/lib/python3.12/site-packages/total_connect_client/client.py\", line 96, in __init__\r\n    self.authenticate()\r\n  File \"/srv/ha-2024.11.3/lib/python3.12/site-packages/total_connect_client/client.py\", line 296, in authenticate\r\n    response = self.request(\r\n               ^^^^^^^^^^^^^\r\n  File \"/srv/ha-2024.11.3/lib/python3.12/site-packages/total_connect_client/client.py\", line 235, in request\r\n    self._raise_for_retry(response)\r\n  File \"/srv/ha-2024.11.3/lib/python3.12/site-packages/total_connect_client/client.py\", line 157, in _raise_for_retry\r\n    rc = _ResultCode.from_response(response)\r\n         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/srv/ha-2024.11.3/lib/python3.12/site-packages/total_connect_client/const.py\", line 151, in from_response\r\n    return _ResultCode(response_dict[\"ResultCode\"])\r\n                       ~~~~~~~~~~~~~^^^^^^^^^^^^^^\r\nTypeError: 'NoneType' object is not subscriptable\r\n```\r\n\r\n### Debug Details\r\n```txt\r\n2024-12-03 22:31:04.943 DEBUG (SyncWorker_13) [zeep.transports] Loading remote data from: https://rs.alarmnet.com/TC21api/tc2.asmx?WSDL\r\n2024-12-03 22:31:05.381 DEBUG (SyncWorker_13) [zeep.transports] Loading remote data from: http://schemas.xmlsoap.org/soap/encoding/\r\n2024-12-03 22:31:06.248 DEBUG (SyncWorker_13) [total_connect_client.client] sending API request LoginAndGetSessionDetails('[user]', '[pass]', '14588', '1.0.34')\r\n2024-12-03 22:31:06.257 DEBUG (SyncWorker_13) [zeep.transports] HTTP Post to https://rs.alarmnet.com/TC21api/tc2.asmx:\r\n<?xml version='1.0' encoding='utf-8'?>\r\n<soap-env:Envelope xmlns:soap-env=\"http://schemas.xmlsoap.org/soap/envelope/\"><soap-env:Body><ns0:LoginAndGetSessionDetails xmlns:ns0=\"https://services.alarmnet.com/TC2/\"><ns0:userName>[user]</ns0:userName><ns0:password>[pass]</ns0:password><ns0:ApplicationID>14588</ns0:ApplicationID><ns0:ApplicationVersion>1.0.34</ns0:ApplicationVersion></ns0:LoginAndGetSessionDetails></soap-env:Body></soap-env:Envelope>\r\n2024-12-03 22:31:06.341 DEBUG (SyncWorker_13) [zeep.transports] HTTP Response from https://rs.alarmnet.com/TC21api/tc2.asmx (status: 200):\r\n<?xml version=\"1.0\" encoding=\"utf-8\"?><soap:Envelope xmlns:soap=\"http://schemas.xmlsoap.org/soap/envelope/\" xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\" xmlns:xsd=\"http://www.w3.org/2001/XMLSchema\"><soap:Body><LoginAndGetSessionDetailsResponse xmlns=\"https://services.alarmnet.com/TC2/\" /></soap:Body></soap:Envelope>\r\n```\r\n\r\n\r\n### Additional information\r\n\r\nI removed my username and password from the debug details and replaced them with `[user]` and `[pass]` respectively. They are correctly formatted and work on the main Total Connect web interface. I'm not sure if they need to be escaped, but the password does contain the following special characters throughout: `-+=_#`. Ignore the difference in timestamps as the debug output was from my dev instance so I could step through the code.\r\n\r\nI did try downgrading my dev instance back to 2024.10.4 and the problem still presents itself so it's not necessarily an upgrade issue, more of the fact that restarting HA started the login process that fails with this error now.\r\n\r\nLooking at https://rs.alarmnet.com/TC21api/tc2.asmx?op=LoginAndGetSessionDetails there is a `LocaleCode` parameter that we're not passing but I'm not sure if that's required.\n", "hints_text": "\nHey there @austinmroczek, mind taking a look at this issue as it has been labeled with an integration (`totalconnect`) you are listed as a [code owner](https://github.com/home-assistant/core/blob/dev/CODEOWNERS#L1534) for? Thanks!\n\n<details>\n<summary>Code owner commands</summary>\n\n\nCode owners of `totalconnect` can trigger bot actions by commenting:\n\n- `@home-assistant close` Closes the issue.\n- `@home-assistant rename Awesome new title` Renames the issue.\n- `@home-assistant reopen` Reopen the issue.\n- `@home-assistant unassign totalconnect` Removes the current integration label and assignees on the issue, add the integration domain after the command.\n- `@home-assistant add-label needs-more-information` Add a label (needs-more-information, problem in dependency, problem in custom component) to the issue.\n- `@home-assistant remove-label needs-more-information` Remove a label (needs-more-information, problem in dependency, problem in custom component) on the issue.\n\n</details>\n\n\n<sub><sup>(message by CodeOwnersMention)</sup></sub>\n\n---\n\n[totalconnect documentation](https://www.home-assistant.io/integrations/totalconnect)\n[totalconnect source](https://github.com/home-assistant/core/tree/dev/homeassistant/components/totalconnect)\n<sub><sup>(message by IssueLinks)</sup></sub>\nI was hoping it would fix itself overnight... \nI saw in the logs that my system had the same error.  When I reloaded the integration just now, it is working.\r\n\r\nPer https://status.resideo.com the system was down last night / early today for maintenance, and users were reporting problems.  It did not specifically state issues with Total Connect 2.0, but in the past their status postings have been not been the most precise.   \r\n\r\nI know I need to update the documentation to include that status link, but other than that I don't think this is an HA bug. \nIn the total_connect_client package I will ensure a ServiceUnavailable exception is thrown, which will result in HA users seeing a log message with:\r\n\r\n```txt\r\n                Error connecting to TotalConnect or the service is unavailable.\r\n                Check https://status.resideo.com/ for outages.\r\n```\r\n\r\nThis message already appears in some other similar cases\r\n\nI noticed the same thing too - that I reloaded it this morning and it was working, so definitely not a HA/integration bug at its core. There may be an opportunity to handle the error like you mentioned, especially so it can trigger occasional restarts with HA to possibly auto-heal. It looks like there's retry logic in there that this managed to escape. Thanks for taking a look!\nIf you'd like to close this issue, feel free. If you'd like to use it for any work coming from it and would like it open, that's fine with me as well!\nI'll keep it open until fixed.  Thanks for reporting it.", "created_at": "2024-12-07T03:30:46Z"}
{"repo": "home-assistant/core", "pull_number": 132510, "instance_id": "home-assistant__core-132510", "issue_numbers": ["132408"], "base_commit": "49621aedb0a95c4ac0c0edc3aa28e9774b3cd294", "patch": "diff --git a/homeassistant/components/tado/manifest.json b/homeassistant/components/tado/manifest.json\nindex 652d51f02619b6..b0c00c888b7b6b 100644\n--- a/homeassistant/components/tado/manifest.json\n+++ b/homeassistant/components/tado/manifest.json\n@@ -14,5 +14,5 @@\n   },\n   \"iot_class\": \"cloud_polling\",\n   \"loggers\": [\"PyTado\"],\n-  \"requirements\": [\"python-tado==0.17.7\"]\n+  \"requirements\": [\"python-tado==0.17.6\"]\n }\ndiff --git a/requirements_all.txt b/requirements_all.txt\nindex 4185c4be60cef5..fbd865dab6d3b5 100644\n--- a/requirements_all.txt\n+++ b/requirements_all.txt\n@@ -2411,7 +2411,7 @@ python-smarttub==0.0.38\n python-songpal==0.16.2\n \n # homeassistant.components.tado\n-python-tado==0.17.7\n+python-tado==0.17.6\n \n # homeassistant.components.technove\n python-technove==1.3.1\n", "test_patch": "diff --git a/requirements_test_all.txt b/requirements_test_all.txt\nindex 46d84f17fe030a..839e0849a41e0f 100644\n--- a/requirements_test_all.txt\n+++ b/requirements_test_all.txt\n@@ -1935,7 +1935,7 @@ python-smarttub==0.0.38\n python-songpal==0.16.2\n \n # homeassistant.components.tado\n-python-tado==0.17.7\n+python-tado==0.17.6\n \n # homeassistant.components.technove\n python-technove==1.3.1\n", "problem_statement": "setting temperature via tado integration not working in 2024.12\n### The problem\r\n\r\nSince I installed Home Assistant Core Update 2024.12.0 I can't use HA to control my tado thermostats anymore, neither manually nor with scripts or automations. There are no errors, the target temperature just isn't set. \r\nThe attempt to set a new target temperature doesn't show up in the logbook at all, but changing HVAC modes is still working and when I set the temperature via the tado app, HA shows the new target temperature.\r\n\r\nI restored a backup for version 2024.11.3 and everything was working as intended, then I updated to 2024.12.0 again and the same problems manifested. Restored 2024.11.3 again, working again.\r\n\r\n### What version of Home Assistant Core has the issue?\r\n\r\ncore-2024.12.0\r\n\r\n### What was the last working version of Home Assistant Core?\r\n\r\ncore-2024.11.3\r\n\r\n### What type of installation are you running?\r\n\r\nHome Assistant OS\r\n\r\n### Integration causing the issue\r\n\r\ntado\r\n\r\n### Link to integration documentation on our website\r\n\r\nhttps://www.home-assistant.io/integrations/tado/\r\n\r\n### Diagnostics information\r\n\r\n_No response_\r\n\r\n### Example YAML snippet\r\n\r\n_No response_\r\n\r\n### Anything in the logs that might be useful for us?\r\n\r\n_No response_\r\n\r\n### Additional information\r\n\r\n_No response_\n", "hints_text": "\nHey there @chiefdragon, @erwindouna, mind taking a look at this issue as it has been labeled with an integration (`tado`) you are listed as a [code owner](https://github.com/home-assistant/core/blob/dev/CODEOWNERS#L1471) for? Thanks!\n\n<details>\n<summary>Code owner commands</summary>\n\n\nCode owners of `tado` can trigger bot actions by commenting:\n\n- `@home-assistant close` Closes the issue.\n- `@home-assistant rename Awesome new title` Renames the issue.\n- `@home-assistant reopen` Reopen the issue.\n- `@home-assistant unassign tado` Removes the current integration label and assignees on the issue, add the integration domain after the command.\n- `@home-assistant add-label needs-more-information` Add a label (needs-more-information, problem in dependency, problem in custom component) to the issue.\n- `@home-assistant remove-label needs-more-information` Remove a label (needs-more-information, problem in dependency, problem in custom component) on the issue.\n\n</details>\n\n\n<sub><sup>(message by CodeOwnersMention)</sup></sub>\n\n---\n\n[tado documentation](https://www.home-assistant.io/integrations/tado)\n[tado source](https://github.com/home-assistant/core/tree/dev/homeassistant/components/tado)\n<sub><sup>(message by IssueLinks)</sup></sub>\nI can confirm I have the same problem. Sensor data still comes in, but controlling doesn't work.\nSame here fwiw\nSame here.\nDo they happen to be Tado X devices?\nNot mine\nI also don't have X devices. My Tado hardware has been the same for months. Controlling it using the Tado app still works.\nNone of mine are Tado X either.\nJust as additional information: I use the dev integration on a Tardo X and that works fine. setting manually and resetting to automatic from HA works as expected.\nFor me it seems to be working fine when the the \"old\" tado devices.\r\nCan the reporter please check again and see if this has been a temporary issue on the side of tado? \n> Do they happen to be Tado X devices?\r\n\r\nMine are the older ones, v3 I believe?\nSame issue here. Only older-gen Tado devices that have been working well with HA for years, now can't control the temperature anymore. \nNo Tado X devices \nSame here using an white tado V3+. Tado app works, but home assistant seems in readonly mode. \nsame here .  Tado app works, but home assistant is in readonly mode.  it\u00b4s winter so please take care\n> For me it seems to be working fine when the the \"old\" tado devices. Can the reporter please check again and see if this has been a temporary issue on the side of tado?\r\n\r\nI just updated to 2024.12 again and the problem still persists, so I'm back to 2024.11, because I don't want to freeze. ;)\nSome additional information that might help: If I change the temperature on the thermostat card, it updates the temperature there (which is just a UI update). If I then click on more info, the original temperature is show again. If there's anything else I can do to debug, I'd be happy to help.\nhi team,\r\nI can confirm this problem still exists. it is not some temporary flux with Tado. I've also restored my backup from version 2024.11.03 and full functionality is back. \nRight now I cannot reproduce the issue. My production system hasn't been updated to 2024.12 yet, but on my test HA running 2024.12 and HA OS 14 it is working fine.\r\nHave you enabled debug logging on the integration page yet and then tried setting the temperature again? Is there anything showing up in the logs?\r\n\nThere are no errors in the log:\r\n```\r\n2024-12-06 13:18:50.795 DEBUG (SyncWorker_7) [homeassistant.components.tado.climate] Switching to HEAT for zone Living room (1) with temperature 19.3 \u00b0C and duration None using overlay NEXT_TIME_BLOCK\r\n2024-12-06 13:18:50.796 DEBUG (SyncWorker_7) [homeassistant.components.tado.tado_connector] Set overlay for zone 1: overlay_mode=NEXT_TIME_BLOCK, temp=19.3, duration=None, type=HEATING, mode=HEAT fan_speed=None swing=None fan_level=None vertical_swing=None horizontal_swing=None\r\n2024-12-06 13:18:50.827 DEBUG (SyncWorker_7) [homeassistant.components.tado.tado_connector] Updating zone 1\r\n2024-12-06 13:18:50.891 DEBUG (SyncWorker_7) [PyTado.zone] Processing data from zone 1\r\n2024-12-06 13:18:50.891 DEBUG (SyncWorker_7) [homeassistant.components.tado.tado_connector] Dispatching update to 772060 zone 1: <PyTado.zone.TadoZone object at 0x7fc9fac76850>\r\n```\nSame problem here. Can read temperature but not change it. If I use developer tools and use this as an action it gives an okay mark but doesn't do anything. Tado v3 (sorry don't know how to indent nicely)\r\n\r\naction:\r\n  tado.set_climate_timer\r\ntarget:\r\n  entity_id: climate.woonkamer\r\ndata:\r\n  temperature: 15\r\n  requested_overlay: NEXT_TIME_BLOCK\r\n\nCan this problem be caused by \"requested_overlay: NEXT_TIME_BLOCK\"?\r\nWhen I replaced it with a 30 min timer it worked again. However I also prefere the use the \"NEXT_TIME_BLOCK\" option again in the future .\r\n\r\naction:\r\n  tado.set_climate_timer\r\ntarget:\r\n  entity_id: climate.woonkamer\r\ndata:\r\n  temperature: 18\r\n  time_period: \"30\"\nI just checked with my production environment. All my Tado devices seem to react properly. I would require more thorough logging and precise device descriptions, to get a grasp on this.\nI upped the logging to debug, but not much else is shown. When I change the temp in HA, change is ignored and I get the following log lines:\r\n\r\n```\r\n2024-12-06 15:41:10.539 DEBUG (SyncWorker_16) [homeassistant.components.tado.climate] Switching to HEAT for zone Huiskamer (5) with temperature 19.6 \u00b0C and duration None using overlay NEXT_TIME_BLOCK\r\n2024-12-06 15:41:10.539 DEBUG (SyncWorker_16) [homeassistant.components.tado.tado_connector] Set overlay for zone 5: overlay_mode=NEXT_TIME_BLOCK, temp=19.6, duration=None, type=HEATING, mode=HEAT fan_speed=None swing=None fan_level=None vertical_swing=None horizontal_swing=None\r\n2024-12-06 15:41:10.584 DEBUG (SyncWorker_16) [homeassistant.components.tado.tado_connector] Updating zone 5\r\n2024-12-06 15:41:10.653 DEBUG (SyncWorker_16) [homeassistant.components.tado.tado_connector] Dispatching update to 449513 zone 5: <PyTado.zone.TadoZone object at 0x7f05c4e41450>\r\n```\r\n\r\nI can confirm what @TomasTack reported. When I try the MANUAL overlay via dev tools it works and gives the following log lines:\r\n\r\n```\r\n2024-12-06 15:43:53.746 DEBUG (SyncWorker_4) [homeassistant.components.tado.climate] Switching to HEAT for zone Huiskamer (5) with temperature 20.0 \u00b0C and duration None using overlay MANUAL\r\n2024-12-06 15:43:53.746 DEBUG (SyncWorker_4) [homeassistant.components.tado.tado_connector] Set overlay for zone 5: overlay_mode=MANUAL, temp=20.0, duration=None, type=HEATING, mode=HEAT fan_speed=None swing=None fan_level=None vertical_swing=None horizontal_swing=None\r\n2024-12-06 15:43:53.794 DEBUG (SyncWorker_4) [homeassistant.components.tado.tado_connector] Updating zone 5\r\n2024-12-06 15:43:53.859 DEBUG (SyncWorker_4) [homeassistant.components.tado.tado_connector] Dispatching update to 449513 zone 5: <PyTado.zone.TadoZone object at 0x7f05bf9151d0>\r\n```\r\n\nin 2024.11.3 it worked\r\nin HA 2024.12 Python moved to 3.13\r\ncan this be the case here tadosync ? https://github.com/erwindouna/python-tado/compare/v0.1.18...v0.1.19\r\n\r\njust a guess.\n> in 2024.11.3 it worked in HA 2024.12 Python moved to 3.13 can this be the case here tadosync ? [erwindouna/python-tado@v0.1.18...v0.1.19](https://github.com/erwindouna/python-tado/compare/v0.1.18...v0.1.19)\r\n> \r\n> just a guess.\r\n\r\nI think, this is not the version they're using. \r\nhttps://github.com/home-assistant/core/blob/dev/homeassistant/components/tado/manifest.json\r\n\r\nThe module in question is this here and with the last update there has been added quite a lot of code concerning TadoX.\r\nhttps://github.com/wmalgadey/PyTado/compare/0.17.6...0.17.7\r\n\r\nRight now, I cannot see the change that might cause such a random issue.\n> in 2024.11.3 it worked\n> in HA 2024.12 Python moved to 3.13\n> can this be the case here tadosync ? https://github.com/erwindouna/python-tado/compare/v0.1.18...v0.1.19\n> \n> just a guess.\n\nThis library is not implemented yet, so no.\nIt might be worth investigating to use PyTado 0.17.6. Is there someone we can downgrade to this version via a custom_component? That would greatly help .\n> It might be worth investigating to use PyTado 0.17.6. Is there someone we can downgrade to this version via a custom_component? That would greatly help .\r\n\r\nI am trying to reproduce the issue on my test rig with no success so far. But I might have found the root cause in 0.17.7 (see linked issue).\n> It might be worth investigating to use PyTado 0.17.6. Is there someone we can downgrade to this version via a custom_component? That would greatly help .\r\n\r\nBump python-tado to 0.17.7 ([@karlbeecken](https://github.com/karlbeecken) - [#129842](https://github.com/home-assistant/core/pull/129842))    \r\n\r\nlet me know howto downgrade PyTado 0.17.6 on HA 2024.12  i can test it on a vmware instance\nI've been having the issue since upgrading to 2024.12 - have just manually edited manifest,json and requirements_all.txt to downgrade PyTado to 0.17.6, ,and it seems to have worked.\n> > It might be worth investigating to use PyTado 0.17.6. Is there someone we can downgrade to this version via a custom_component? That would greatly help .\n> \n> Bump python-tado to 0.17.7 ([@karlbeecken](https://github.com/karlbeecken) - [#129842](https://github.com/home-assistant/core/pull/129842))    \n> \n> let me know howto downgrade PyTado 0.17.6 on HA 2024.12  i can test it on a vmware instance\n\nBasically copy paste the manifest.json in a custom_component folder. Something like: `custom_components/tado/manifest.json`.This will give an override of whatever comes next of Tado. That should fix the version to 0.17.6 if you updated this properly. Always restart your instance when you performed a file change.\n> I've been having the issue since upgrading to 2024.12 - have just manually edited manifest,json and requirements_all.txt to downgrade PyTado to 0.17.6, ,and it seems to have worked.\n\nThanks for testing and confirming! If we can find another users who can confirm this behaviour, whilst doing a downgrade, I will create a downgrade PR and ask Core Members to release in a patch version as soon as possible.", "created_at": "2024-12-06T18:30:57Z"}
{"repo": "home-assistant/core", "pull_number": 132508, "instance_id": "home-assistant__core-132508", "issue_numbers": ["132444"], "base_commit": "2117e35d53b1cf397a149ee9f45f3089f94d4bb4", "patch": "diff --git a/homeassistant/components/fibaro/climate.py b/homeassistant/components/fibaro/climate.py\nindex 2541781773c012..d5605e71c73053 100644\n--- a/homeassistant/components/fibaro/climate.py\n+++ b/homeassistant/components/fibaro/climate.py\n@@ -272,7 +272,9 @@ def hvac_mode(self) -> HVACMode | None:\n         if isinstance(fibaro_operation_mode, str):\n             with suppress(ValueError):\n                 return HVACMode(fibaro_operation_mode.lower())\n-        elif fibaro_operation_mode in OPMODES_HVAC:\n+            # when the mode cannot be instantiated a preset_mode is selected\n+            return HVACMode.AUTO\n+        if fibaro_operation_mode in OPMODES_HVAC:\n             return OPMODES_HVAC[fibaro_operation_mode]\n         return None\n \n@@ -280,8 +282,6 @@ def set_hvac_mode(self, hvac_mode: HVACMode) -> None:\n         \"\"\"Set new target operation mode.\"\"\"\n         if not self._op_mode_device:\n             return\n-        if self.preset_mode:\n-            return\n \n         if \"setOperatingMode\" in self._op_mode_device.fibaro_device.actions:\n             self._op_mode_device.action(\"setOperatingMode\", HA_OPMODES_HVAC[hvac_mode])\n", "test_patch": "diff --git a/tests/components/fibaro/conftest.py b/tests/components/fibaro/conftest.py\nindex 1976a8f310b2e6..583c44a41e6409 100644\n--- a/tests/components/fibaro/conftest.py\n+++ b/tests/components/fibaro/conftest.py\n@@ -129,6 +129,62 @@ def mock_light() -> Mock:\n     return light\n \n \n+@pytest.fixture\n+def mock_thermostat() -> Mock:\n+    \"\"\"Fixture for a thermostat.\"\"\"\n+    climate = Mock()\n+    climate.fibaro_id = 4\n+    climate.parent_fibaro_id = 0\n+    climate.name = \"Test climate\"\n+    climate.room_id = 1\n+    climate.dead = False\n+    climate.visible = True\n+    climate.enabled = True\n+    climate.type = \"com.fibaro.thermostatDanfoss\"\n+    climate.base_type = \"com.fibaro.device\"\n+    climate.properties = {\"manufacturer\": \"\"}\n+    climate.actions = {\"setThermostatMode\": 1}\n+    climate.supported_features = {}\n+    climate.has_supported_thermostat_modes = True\n+    climate.supported_thermostat_modes = [\"Off\", \"Heat\", \"CustomerSpecific\"]\n+    climate.has_operating_mode = False\n+    climate.has_thermostat_mode = True\n+    climate.thermostat_mode = \"CustomerSpecific\"\n+    value_mock = Mock()\n+    value_mock.has_value = True\n+    value_mock.int_value.return_value = 20\n+    climate.value = value_mock\n+    return climate\n+\n+\n+@pytest.fixture\n+def mock_thermostat_with_operating_mode() -> Mock:\n+    \"\"\"Fixture for a thermostat.\"\"\"\n+    climate = Mock()\n+    climate.fibaro_id = 4\n+    climate.parent_fibaro_id = 0\n+    climate.name = \"Test climate\"\n+    climate.room_id = 1\n+    climate.dead = False\n+    climate.visible = True\n+    climate.enabled = True\n+    climate.type = \"com.fibaro.thermostatDanfoss\"\n+    climate.base_type = \"com.fibaro.device\"\n+    climate.properties = {\"manufacturer\": \"\"}\n+    climate.actions = {\"setOperationMode\": 1}\n+    climate.supported_features = {}\n+    climate.has_supported_operating_modes = True\n+    climate.supported_operating_modes = [0, 1, 15]\n+    climate.has_operating_mode = True\n+    climate.operating_mode = 15\n+    climate.has_thermostat_mode = False\n+    value_mock = Mock()\n+    value_mock.has_value = True\n+    value_mock.int_value.return_value = 20\n+    climate.value = value_mock\n+    return climate\n+\n+\n @pytest.fixture\n def mock_config_entry(hass: HomeAssistant) -> MockConfigEntry:\n     \"\"\"Return the default mocked config entry.\"\"\"\ndiff --git a/tests/components/fibaro/test_climate.py b/tests/components/fibaro/test_climate.py\nnew file mode 100644\nindex 00000000000000..31022e19a0819a\n--- /dev/null\n+++ b/tests/components/fibaro/test_climate.py\n@@ -0,0 +1,134 @@\n+\"\"\"Test the Fibaro climate platform.\"\"\"\n+\n+from unittest.mock import Mock, patch\n+\n+from homeassistant.components.climate import ClimateEntityFeature, HVACMode\n+from homeassistant.const import Platform\n+from homeassistant.core import HomeAssistant\n+from homeassistant.helpers import entity_registry as er\n+\n+from .conftest import init_integration\n+\n+from tests.common import MockConfigEntry\n+\n+\n+async def test_climate_setup(\n+    hass: HomeAssistant,\n+    entity_registry: er.EntityRegistry,\n+    mock_fibaro_client: Mock,\n+    mock_config_entry: MockConfigEntry,\n+    mock_thermostat: Mock,\n+    mock_room: Mock,\n+) -> None:\n+    \"\"\"Test that the climate creates an entity.\"\"\"\n+\n+    # Arrange\n+    mock_fibaro_client.read_rooms.return_value = [mock_room]\n+    mock_fibaro_client.read_devices.return_value = [mock_thermostat]\n+\n+    with patch(\"homeassistant.components.fibaro.PLATFORMS\", [Platform.CLIMATE]):\n+        # Act\n+        await init_integration(hass, mock_config_entry)\n+        # Assert\n+        entry = entity_registry.async_get(\"climate.room_1_test_climate_4\")\n+        assert entry\n+        assert entry.unique_id == \"hc2_111111.4\"\n+        assert entry.original_name == \"Room 1 Test climate\"\n+        assert entry.supported_features == (\n+            ClimateEntityFeature.TURN_ON\n+            | ClimateEntityFeature.TURN_OFF\n+            | ClimateEntityFeature.PRESET_MODE\n+        )\n+\n+\n+async def test_hvac_mode_preset(\n+    hass: HomeAssistant,\n+    mock_fibaro_client: Mock,\n+    mock_config_entry: MockConfigEntry,\n+    mock_thermostat: Mock,\n+    mock_room: Mock,\n+) -> None:\n+    \"\"\"Test that the climate state is auto when a preset is selected.\"\"\"\n+\n+    # Arrange\n+    mock_fibaro_client.read_rooms.return_value = [mock_room]\n+    mock_fibaro_client.read_devices.return_value = [mock_thermostat]\n+\n+    with patch(\"homeassistant.components.fibaro.PLATFORMS\", [Platform.CLIMATE]):\n+        # Act\n+        await init_integration(hass, mock_config_entry)\n+        # Assert\n+        state = hass.states.get(\"climate.room_1_test_climate_4\")\n+        assert state.state == HVACMode.AUTO\n+        assert state.attributes[\"preset_mode\"] == \"CustomerSpecific\"\n+\n+\n+async def test_hvac_mode_heat(\n+    hass: HomeAssistant,\n+    mock_fibaro_client: Mock,\n+    mock_config_entry: MockConfigEntry,\n+    mock_thermostat: Mock,\n+    mock_room: Mock,\n+) -> None:\n+    \"\"\"Test that the preset mode is None if a hvac mode is active.\"\"\"\n+\n+    # Arrange\n+    mock_thermostat.thermostat_mode = \"Heat\"\n+    mock_fibaro_client.read_rooms.return_value = [mock_room]\n+    mock_fibaro_client.read_devices.return_value = [mock_thermostat]\n+\n+    with patch(\"homeassistant.components.fibaro.PLATFORMS\", [Platform.CLIMATE]):\n+        # Act\n+        await init_integration(hass, mock_config_entry)\n+        # Assert\n+        state = hass.states.get(\"climate.room_1_test_climate_4\")\n+        assert state.state == HVACMode.HEAT\n+        assert state.attributes[\"preset_mode\"] is None\n+\n+\n+async def test_set_hvac_mode(\n+    hass: HomeAssistant,\n+    mock_fibaro_client: Mock,\n+    mock_config_entry: MockConfigEntry,\n+    mock_thermostat: Mock,\n+    mock_room: Mock,\n+) -> None:\n+    \"\"\"Test that set_hvac_mode() works.\"\"\"\n+\n+    # Arrange\n+    mock_fibaro_client.read_rooms.return_value = [mock_room]\n+    mock_fibaro_client.read_devices.return_value = [mock_thermostat]\n+\n+    with patch(\"homeassistant.components.fibaro.PLATFORMS\", [Platform.CLIMATE]):\n+        # Act\n+        await init_integration(hass, mock_config_entry)\n+        await hass.services.async_call(\n+            \"climate\",\n+            \"set_hvac_mode\",\n+            {\"entity_id\": \"climate.room_1_test_climate_4\", \"hvac_mode\": HVACMode.HEAT},\n+            blocking=True,\n+        )\n+\n+        # Assert\n+        mock_thermostat.execute_action.assert_called_once()\n+\n+\n+async def test_hvac_mode_with_operation_mode_support(\n+    hass: HomeAssistant,\n+    mock_fibaro_client: Mock,\n+    mock_config_entry: MockConfigEntry,\n+    mock_thermostat_with_operating_mode: Mock,\n+    mock_room: Mock,\n+) -> None:\n+    \"\"\"Test that operating mode works.\"\"\"\n+\n+    # Arrange\n+    mock_fibaro_client.read_rooms.return_value = [mock_room]\n+    mock_fibaro_client.read_devices.return_value = [mock_thermostat_with_operating_mode]\n+\n+    with patch(\"homeassistant.components.fibaro.PLATFORMS\", [Platform.CLIMATE]):\n+        # Act\n+        await init_integration(hass, mock_config_entry)\n+        # Assert\n+        state = hass.states.get(\"climate.room_1_test_climate_4\")\n+        assert state.state == HVACMode.AUTO\n", "problem_statement": "Fibaro Heat Controller gets state \"Unknown\" and cannot be controlled in HA when set to \"Max\" by turning the physical knob or via Fibaro HC3\n### The problem\r\n\r\nI have \"Fibaro Heat Controllers\" thermostats connected to Fibaro HC3 and linked to HA via Fibaro integration.\r\nWhen setting Fibaro Heat Controller to \"Max\" by physically turning the knob or via Fibaro HC3, in HA it gets state \"Unknown\" and cannot be controlled in HA anymore (for example it is not possible to set back the mode to \"Heat\" or \"Off\" from HA).\r\nA message is displayed:\r\nFailed to perform the action climate/set_hvac_mode. expected HVACMode or one of 'off', 'heat', 'cool', 'heat_cool', 'auto', 'dry', 'fan_only' for dictionary value @ data['hvac_mode']\r\n\r\nWhen state is changed from \"Max\" to \"Heat\" or \"Off\" via physical knob or via HC3, then possibility to control via HA is regained.\r\n\r\n### What version of Home Assistant Core has the issue?\r\n\r\ncore-2024.12.0\r\n\r\n### What was the last working version of Home Assistant Core?\r\n\r\n_No response_\r\n\r\n### What type of installation are you running?\r\n\r\nHome Assistant OS\r\n\r\n### Integration causing the issue\r\n\r\nfibaro\r\n\r\n### Link to integration documentation on our website\r\n\r\nhttps://www.home-assistant.io/integrations/fibaro\r\n\r\n### Diagnostics information\r\n\r\n[home-assistant_fibaro_2024-12-06T00-39-29.308Z.log](https://github.com/user-attachments/files/18031261/home-assistant_fibaro_2024-12-06T00-39-29.308Z.log)\r\n\r\nWhen state \"Max\" is assigned via physical knob or Fibaro HC3 as shown on below screenshot:\r\n![image](https://github.com/user-attachments/assets/82e6a72e-d1e3-44c5-ab96-9bac2a869f2c)\r\n\r\n\r\nThen it ends up with below shown error message in HA and control via HA is not possible anymore:\r\n![image](https://github.com/user-attachments/assets/0577cd5e-6aaf-4897-a208-79d8ddbee9dd)\r\n\r\n\r\n\r\n\r\n### Example YAML snippet\r\n\r\n_No response_\r\n\r\n### Anything in the logs that might be useful for us?\r\n\r\n_No response_\r\n\r\n### Additional information\r\n\r\n_No response_\n", "hints_text": "\nHey there @rappenze, mind taking a look at this issue as it has been labeled with an integration (`fibaro`) you are listed as a [code owner](https://github.com/home-assistant/core/blob/dev/CODEOWNERS#L458) for? Thanks!\n\n<details>\n<summary>Code owner commands</summary>\n\n\nCode owners of `fibaro` can trigger bot actions by commenting:\n\n- `@home-assistant close` Closes the issue.\n- `@home-assistant rename Awesome new title` Renames the issue.\n- `@home-assistant reopen` Reopen the issue.\n- `@home-assistant unassign fibaro` Removes the current integration label and assignees on the issue, add the integration domain after the command.\n- `@home-assistant add-label needs-more-information` Add a label (needs-more-information, problem in dependency, problem in custom component) to the issue.\n- `@home-assistant remove-label needs-more-information` Remove a label (needs-more-information, problem in dependency, problem in custom component) on the issue.\n\n</details>\n\n\n<sub><sup>(message by CodeOwnersMention)</sup></sub>\n\n---\n\n[fibaro documentation](https://www.home-assistant.io/integrations/fibaro)\n[fibaro source](https://github.com/home-assistant/core/tree/dev/homeassistant/components/fibaro)\n<sub><sup>(message by IssueLinks)</sup></sub>\nThe implementation of a climate device in HA is not the same as in Fibaro. Therefore we do the best to map the features from Fibaro to HA.\r\n\r\n**HVAC mode and preset mode**\r\nHA has HVAC mode with a fix set of supported values, which are the ones you have seen in the error message: 'off', 'heat', 'cool', 'heat_cool', 'auto', 'dry', 'fan_only'. If Fibaro supports the same value, you can change to one of this modes by using the set_hvac_mode service. If you need to activate a different program, you need to use the set_preset_mode service. In the UI you see this two possibilities as Mode and Preset.\r\n\r\nSo this should answer why your button Max does not work, you need to call set_preset_mode instead of set_hvac_mode.\r\n\r\n**Current state**\r\nAlso the current states allowed in HA are limited to a fix value list: cooling, defrosting, drying, fan, heating, idle, off, preheating.\r\nSo if Fibaro reports one of this value it is shown, otherwise Unknown is shown as current mode.\r\n\r\nThis explains why you often see mode Unknown.\r\n\r\n**Your problems**\r\n- Max button: already explained above, use the service set_preset_mode instead of set_hvac_mode.\r\n- It cannot be controlled anymore in HA: What exactly does not work anymore in HA? Setting preset, setting mode, setting target temperature...? Does this work after you fix the Max button?\r\n- State unknown: If you can find out the possible values for thermostatOperatingState in Fibaro we can fix that by mapping the values from Fibaro to HA.\r\n\r\n**Additional information**\r\n- Is this a new problem in HA 2024.12 or was this problem existing before as well?\r\n- When you cannot find the thermostatOperatingState in Fibaro, you can get the different values through the API. Add here the json response from fibaro home center. Relevant is the output of http://<FIBARO_HOST>/api/devices/190 (you have to enter your fibaro credentials). The last number is your fibaro device id. The one reported in the logi s ID 190 so this should print you the needed information.\nHello, thank you for the clarifications and additional questions. Starting from the last point, I am adding here two json files generated as response from Fibaro: when state is set to \"Max\" (by turning physical knob to max) and when state is set to \"Heat\" (by turning physical knob a bit down).\r\n[190 when set to Heat.json](https://github.com/user-attachments/files/18040530/190.when.set.to.Heat.json)\r\n[190 when set to Max.json](https://github.com/user-attachments/files/18040531/190.when.set.to.Max.json)\r\n\nAnswering the other questions that you raised:\r\n\r\n- Is this a new problem in HA 2024.12 or was this problem existing before as well?\r\nThe problem was existing before as well.\r\n\r\n- It cannot be controlled anymore in HA: What exactly does not work anymore in HA? Setting preset, setting mode, setting target temperature...? Does this work after you fix the Max button?\r\nWhen the \"Max\" button is activated on Fibaro side (which happens when I turn physical knob of Fibaro Heat Controller to the maximum), then on HA side I am not able to perform any action for this thermostat via HA UI: not possible to change mode, not possible to set temperature etc..\r\nWhen the \"Max\" button is deactivated on Fibaro side (which happens when I turn down physical knob of Fibaro Heat Controller to be below maximum), then I am again able to control this thermostat via HA UI.\r\n\nMany thanks for your feedback.\r\n\r\nSo what I see from the additional information is that the current state like Off or Heating is not reported by Fibaro. So in the UI you should see the HVAC mode or preset mode I think.\r\n\r\nI guess that the problem we have is that the Fibaro climate entity currently set the HVACMode to None as soon as a preset is selected. This is most probably wrong, I think the HVACMode should report Auto in this case to signal that something else (like a preset mode) is responsible to control heating. As I do not have such a device unfortunately I cannot try that out. If we change that I think the problem with state \"Unknown\" (it will then show Auto or your preset mode) and also I think you should then still be able to control the device in HA.", "created_at": "2024-12-06T17:42:37Z"}
{"repo": "home-assistant/core", "pull_number": 132498, "instance_id": "home-assistant__core-132498", "issue_numbers": ["125191"], "base_commit": "35438f65e5a36564e63205963845f5f431e360ed", "patch": "diff --git a/homeassistant/components/google_tasks/todo.py b/homeassistant/components/google_tasks/todo.py\nindex 5196f89728d8f..86cb5e09300e9 100644\n--- a/homeassistant/components/google_tasks/todo.py\n+++ b/homeassistant/components/google_tasks/todo.py\n@@ -2,7 +2,7 @@\n \n from __future__ import annotations\n \n-from datetime import date, datetime, timedelta\n+from datetime import UTC, date, datetime, timedelta\n from typing import Any, cast\n \n from homeassistant.components.todo import (\n@@ -39,8 +39,10 @@ def _convert_todo_item(item: TodoItem) -> dict[str, str | None]:\n     else:\n         result[\"status\"] = TodoItemStatus.NEEDS_ACTION\n     if (due := item.due) is not None:\n-        # due API field is a timestamp string, but with only date resolution\n-        result[\"due\"] = dt_util.start_of_local_day(due).isoformat()\n+        # due API field is a timestamp string, but with only date resolution.\n+        # The time portion of the date is always discarded by the API, so we\n+        # always set to UTC.\n+        result[\"due\"] = dt_util.start_of_local_day(due).replace(tzinfo=UTC).isoformat()\n     else:\n         result[\"due\"] = None\n     result[\"notes\"] = item.description\n@@ -51,6 +53,8 @@ def _convert_api_item(item: dict[str, str]) -> TodoItem:\n     \"\"\"Convert tasks API items into a TodoItem.\"\"\"\n     due: date | None = None\n     if (due_str := item.get(\"due\")) is not None:\n+        # Due dates are returned always in UTC so we only need to\n+        # parse the date portion which will be interpreted as a a local date.\n         due = datetime.fromisoformat(due_str).date()\n     return TodoItem(\n         summary=item[\"title\"],\n", "test_patch": "diff --git a/tests/components/google_tasks/snapshots/test_todo.ambr b/tests/components/google_tasks/snapshots/test_todo.ambr\nindex 76611ba4a3192..f32441354fcf8 100644\n--- a/tests/components/google_tasks/snapshots/test_todo.ambr\n+++ b/tests/components/google_tasks/snapshots/test_todo.ambr\n@@ -15,7 +15,7 @@\n   )\n # ---\n # name: test_create_todo_list_item[due].1\n-  '{\"title\": \"Soda\", \"status\": \"needsAction\", \"due\": \"2023-11-18T00:00:00-08:00\", \"notes\": null}'\n+  '{\"title\": \"Soda\", \"status\": \"needsAction\", \"due\": \"2023-11-18T00:00:00+00:00\", \"notes\": null}'\n # ---\n # name: test_create_todo_list_item[summary]\n   tuple(\n@@ -137,7 +137,7 @@\n   )\n # ---\n # name: test_partial_update[due_date].1\n-  '{\"title\": \"Water\", \"status\": \"needsAction\", \"due\": \"2023-11-18T00:00:00-08:00\", \"notes\": null}'\n+  '{\"title\": \"Water\", \"status\": \"needsAction\", \"due\": \"2023-11-18T00:00:00+00:00\", \"notes\": null}'\n # ---\n # name: test_partial_update[empty_description]\n   tuple(\n@@ -166,6 +166,33 @@\n # name: test_partial_update_status[api_responses0].1\n   '{\"title\": \"Water\", \"status\": \"needsAction\", \"due\": null, \"notes\": null}'\n # ---\n+# name: test_update_due_date[api_responses0-America/Regina]\n+  tuple(\n+    'https://tasks.googleapis.com/tasks/v1/lists/task-list-id-1/tasks/some-task-id?alt=json',\n+    'PATCH',\n+  )\n+# ---\n+# name: test_update_due_date[api_responses0-America/Regina].1\n+  '{\"title\": \"Water\", \"status\": \"needsAction\", \"due\": \"2024-12-05T00:00:00+00:00\", \"notes\": null}'\n+# ---\n+# name: test_update_due_date[api_responses0-Asia/Tokyo]\n+  tuple(\n+    'https://tasks.googleapis.com/tasks/v1/lists/task-list-id-1/tasks/some-task-id?alt=json',\n+    'PATCH',\n+  )\n+# ---\n+# name: test_update_due_date[api_responses0-Asia/Tokyo].1\n+  '{\"title\": \"Water\", \"status\": \"needsAction\", \"due\": \"2024-12-05T00:00:00+00:00\", \"notes\": null}'\n+# ---\n+# name: test_update_due_date[api_responses0-UTC]\n+  tuple(\n+    'https://tasks.googleapis.com/tasks/v1/lists/task-list-id-1/tasks/some-task-id?alt=json',\n+    'PATCH',\n+  )\n+# ---\n+# name: test_update_due_date[api_responses0-UTC].1\n+  '{\"title\": \"Water\", \"status\": \"needsAction\", \"due\": \"2024-12-05T00:00:00+00:00\", \"notes\": null}'\n+# ---\n # name: test_update_todo_list_item[api_responses0]\n   tuple(\n     'https://tasks.googleapis.com/tasks/v1/lists/task-list-id-1/tasks/some-task-id?alt=json',\ndiff --git a/tests/components/google_tasks/test_todo.py b/tests/components/google_tasks/test_todo.py\nindex b0ee135d4a9bc..c5ecc0ca2cf28 100644\n--- a/tests/components/google_tasks/test_todo.py\n+++ b/tests/components/google_tasks/test_todo.py\n@@ -239,6 +239,7 @@ def mock_http_response(response_handler: list | Callable) -> Mock:\n         yield mock_response\n \n \n+@pytest.mark.parametrize(\"timezone\", [\"America/Regina\", \"UTC\", \"Asia/Tokyo\"])\n @pytest.mark.parametrize(\n     \"api_responses\",\n     [\n@@ -251,7 +252,7 @@ def mock_http_response(response_handler: list | Callable) -> Mock:\n                         \"title\": \"Task 1\",\n                         \"status\": \"needsAction\",\n                         \"position\": \"0000000000000001\",\n-                        \"due\": \"2023-11-18T00:00:00+00:00\",\n+                        \"due\": \"2023-11-18T00:00:00Z\",\n                     },\n                     {\n                         \"id\": \"task-2\",\n@@ -271,8 +272,10 @@ async def test_get_items(\n     integration_setup: Callable[[], Awaitable[bool]],\n     hass_ws_client: WebSocketGenerator,\n     ws_get_items: Callable[[], Awaitable[dict[str, str]]],\n+    timezone: str,\n ) -> None:\n     \"\"\"Test getting todo list items.\"\"\"\n+    await hass.config.async_set_time_zone(timezone)\n \n     assert await integration_setup()\n \n@@ -484,6 +487,39 @@ async def test_update_todo_list_item(\n     assert call.kwargs.get(\"body\") == snapshot\n \n \n+@pytest.mark.parametrize(\"timezone\", [\"America/Regina\", \"UTC\", \"Asia/Tokyo\"])\n+@pytest.mark.parametrize(\"api_responses\", [UPDATE_API_RESPONSES])\n+async def test_update_due_date(\n+    hass: HomeAssistant,\n+    setup_credentials: None,\n+    integration_setup: Callable[[], Awaitable[bool]],\n+    mock_http_response: Any,\n+    snapshot: SnapshotAssertion,\n+    timezone: str,\n+) -> None:\n+    \"\"\"Test for updating the due date of a To-do item and timezone.\"\"\"\n+    await hass.config.async_set_time_zone(timezone)\n+\n+    assert await integration_setup()\n+\n+    state = hass.states.get(\"todo.my_tasks\")\n+    assert state\n+    assert state.state == \"1\"\n+\n+    await hass.services.async_call(\n+        TODO_DOMAIN,\n+        TodoServices.UPDATE_ITEM,\n+        {ATTR_ITEM: \"some-task-id\", ATTR_DUE_DATE: \"2024-12-5\"},\n+        target={ATTR_ENTITY_ID: \"todo.my_tasks\"},\n+        blocking=True,\n+    )\n+    assert len(mock_http_response.call_args_list) == 4\n+    call = mock_http_response.call_args_list[2]\n+    assert call\n+    assert call.args == snapshot\n+    assert call.kwargs.get(\"body\") == snapshot\n+\n+\n @pytest.mark.parametrize(\n     \"api_responses\",\n     [\n", "problem_statement": "Editing a todo list item due date and saving causes date to be out by one day. Google Tasks Integration.\n### The problem\n\nWhen adding a todo item for google tasks and then saving a date.\r\nWhat will save is the day before the date selected.\n\n### What version of Home Assistant Core has the issue?\n\ncore-2024.8.3\n\n### What was the last working version of Home Assistant Core?\n\nunknown\n\n### What type of installation are you running?\n\nHome Assistant OS\n\n### Integration causing the issue\n\nGoogle Tasks\n\n### Link to integration documentation on our website\n\nhttps://www.home-assistant.io/integrations/google_tasks/\n\n### Diagnostics information\n\n_No response_\n\n### Example YAML snippet\n\n_No response_\n\n### Anything in the logs that might be useful for us?\n\n_No response_\n\n### Additional information\n\nSteps to reproduce the issue\r\n1) Create a new todo list item. Integration is google tasks.\r\n2) Edit and add a date.\r\n3) Save the date.\r\n4) Now the date will be the day before the one that was selected.\r\n\r\n\r\ndid a test and the call_service showed the correct date entered when saved. Set the date to 30/08/2024.\r\nIn the Todo list after saving it shows 29/08/2024.\r\n\r\nAlso if I set the date to say 31/08/2024 and save it. It will appear as 30/08/2024. If I then edit again and just save it and not change the date it will then show 29/08/2024.\r\n\r\n\r\nevent_type: call_service\r\ndata:\r\ndomain: todo\r\nservice: update_item\r\nservice_data:\r\nitem: T3BiUTE1OEdPb0QyTjhYZg\r\nrename: test\r\nstatus: needs_action\r\ndescription: null\r\ndue_date: \"2024-08-30\"\r\nentity_id:\r\n- todo.my_tasks\r\norigin: LOCAL\r\ntime_fired: \"2024-08-28T00:20:14.041365+00:00\"\r\ncontext:\r\nid: 01J6B5NEJS11A1DEPK6JBKNK7Q\r\nparent_id: null\r\nuser_id: 1a662c9ead9543a6aff0859ff9fb7b86\n", "hints_text": "\nHey there @allenporter, mind taking a look at this issue as it has been labeled with an integration (`google_tasks`) you are listed as a [code owner](https://github.com/home-assistant/core/blob/dev/CODEOWNERS#L562) for? Thanks!\n\n<details>\n<summary>Code owner commands</summary>\n\n\nCode owners of `google_tasks` can trigger bot actions by commenting:\n\n- `@home-assistant close` Closes the issue.\n- `@home-assistant rename Awesome new title` Renames the issue.\n- `@home-assistant reopen` Reopen the issue.\n- `@home-assistant unassign google_tasks` Removes the current integration label and assignees on the issue, add the integration domain after the command.\n- `@home-assistant add-label needs-more-information` Add a label (needs-more-information, problem in dependency, problem in custom component) to the issue.\n- `@home-assistant remove-label needs-more-information` Remove a label (needs-more-information, problem in dependency, problem in custom component) on the issue.\n\n</details>\n\n\n<sub><sup>(message by CodeOwnersMention)</sup></sub>\n\n---\n\n[google_tasks documentation](https://www.home-assistant.io/integrations/google_tasks)\n[google_tasks source](https://github.com/home-assistant/core/tree/dev/homeassistant/components/google_tasks)\n<sub><sup>(message by IssueLinks)</sup></sub>\nI am not able to reproduce this in the UI following the steps you said. I suspect this may be something related to timezones, but I can't tell.\r\n\r\n(1)  Can you tell me a little more simply the steps to reproduce with a service call? Your words don't appear to match the service call sent below. \r\n(2) Can you capture debug logs for Google Tasks? https://www.home-assistant.io/docs/configuration/troubleshooting/#debug-logs-and-diagnostics\r\n(3) What timezone is home assistant set to? \nI will be able to capture the logs tomorrow. \r\n\r\nI first logged the issue under frontend issues and the service call was suggested.\r\nhttps://github.com/home-assistant/frontend/issues/21803\r\n\r\nThe issue appears on my installation and on a friends.\r\n\r\nThe time zone is set to (GMT+10:30) Central Time -Adelaide.  \nThere hasn't been any activity on this issue recently. Due to the high number of incoming GitHub notifications, we have to clean some of the old issues, as many of them have already been resolved with the latest updates.\nPlease make sure to update to the latest Home Assistant version and check if that solves the issue. Let us know if that works for you by adding a comment \ud83d\udc4d\nThis issue has now been marked as stale and will be closed if no further activity occurs. Thank you for your contributions.\nProblem still exists for me on 2024.12\n@StefanSarzio see https://github.com/home-assistant/core/issues/125191#issuecomment-2333202413 and provide requested information. thanks!\nForgot to follow up on this one. Only logs on each save were:\r\n\r\n2024-12-06 18:23:55.306 DEBUG (MainThread) [homeassistant.components.google_tasks.coordinator] Finished fetching Google Tasks MTc5Nzc0ODY0ODI5MDU2NTI2MDI6MDow data in 0.463 seconds (success: True)\r\n\r\n2024-12-06 18:23:58.351 DEBUG (MainThread) [homeassistant.components.google_tasks.coordinator] Finished fetching Google Tasks MTc5Nzc0ODY0ODI5MDU2NTI2MDI6MDow data in 0.474 seconds (success: True)\r\n\r\nOn each save the date changes to the day before.\r\n\r\nDate is set to 10/12/2024\r\nSave task\r\nDate now is 09/12/2024\r\nSave task\r\nDate now is 08/12/2024\n1) Sorry, I cannot help here. I'm not the original poster and I don't quite get what I would have to do. I have the problem when creating to-do items manually from the HA web-interface. I add an entry by adding a title, then click + to add it. Then I select the new item and add a due date by clicking the small calendar icon on the right of the field. Then the text string for the correct date is shown in the text-field. Then I click save. Then in the overview the wrong date is shown. Also when opening the entry again it shows the wrong date in the text-field.\r\n(2) Done. The file is 45 MB in size and I'm not sure whether it contains any sensitive data. Also the file type is not supported for uploading: \"We don\u2019t support that file type.\r\n\r\nTry again with GIF, JPEG, JPG, MOV, MP4, PNG, SVG, WEBM, CPUPROFILE, CSV, DMP, DOCX, FODG, FODP, FODS, FODT, GZ, JSON, JSONC, LOG, MD, ODF, ODG, ODP, ODS, ODT, PATCH, PDF, PPTX, TGZ, TXT, XLS, XLSX or ZIP.\" \r\n(3) (GMT+01:00) Berlin\n> Forgot to follow up on this one. Only logs on each save were:\r\n\r\nok thanks, you're right google tasks is not configured correctly for debug logging.  I will try to reproduce this myself by changing my timezone.\r\n\r\nI think the issue is the timezone may be getting dropped in the round trip between google and home assistant so the timezone distance away from UTC is what may impact this. e.g. if you truncate my timezone at midnight i still get the same day, but not GMT+10 etc\nI was able to reproduce the issue, and have a fix that appears to work. Thank you for the report.", "created_at": "2024-12-06T15:34:56Z"}
{"repo": "home-assistant/core", "pull_number": 132493, "instance_id": "home-assistant__core-132493", "issue_numbers": ["128489"], "base_commit": "35438f65e5a36564e63205963845f5f431e360ed", "patch": "diff --git a/homeassistant/components/risco/manifest.json b/homeassistant/components/risco/manifest.json\nindex c226c1c590d569..149b8761589989 100644\n--- a/homeassistant/components/risco/manifest.json\n+++ b/homeassistant/components/risco/manifest.json\n@@ -6,5 +6,5 @@\n   \"documentation\": \"https://www.home-assistant.io/integrations/risco\",\n   \"iot_class\": \"local_push\",\n   \"loggers\": [\"pyrisco\"],\n-  \"requirements\": [\"pyrisco==0.6.4\"]\n+  \"requirements\": [\"pyrisco==0.6.5\"]\n }\ndiff --git a/requirements_all.txt b/requirements_all.txt\nindex 2fdfbea31ade18..4888a9c149b34f 100644\n--- a/requirements_all.txt\n+++ b/requirements_all.txt\n@@ -2203,7 +2203,7 @@ pyrecswitch==1.0.2\n pyrepetierng==0.1.0\n \n # homeassistant.components.risco\n-pyrisco==0.6.4\n+pyrisco==0.6.5\n \n # homeassistant.components.rituals_perfume_genie\n pyrituals==0.0.6\n", "test_patch": "diff --git a/requirements_test_all.txt b/requirements_test_all.txt\nindex ea5d92841fda91..d553c20a88ce96 100644\n--- a/requirements_test_all.txt\n+++ b/requirements_test_all.txt\n@@ -1778,7 +1778,7 @@ pyqwikswitch==0.93\n pyrainbird==6.0.1\n \n # homeassistant.components.risco\n-pyrisco==0.6.4\n+pyrisco==0.6.5\n \n # homeassistant.components.rituals_perfume_genie\n pyrituals==0.0.6\n", "problem_statement": "Risco integration not working \n### The problem\n\nRisco integration was working properly until few days ago. Since then, it is not able to finalise the initialisation, so all the entities are simply not available anymore.\r\nI also tried to remove and re-configure the integration but nothing changed.\r\nAttached the error code shown.\r\n![Screenshot_20241015_225539_Home Assistant](https://github.com/user-attachments/assets/2db1b8c3-78e8-4abe-aeec-0add67f58b12)\r\n\n\n### What version of Home Assistant Core has the issue?\n\ncore-2024.10.2\n\n### What was the last working version of Home Assistant Core?\n\n_No response_\n\n### What type of installation are you running?\n\nHome Assistant OS\n\n### Integration causing the issue\n\nRisco\n\n### Link to integration documentation on our website\n\nhttps://www.home-assistant.io/integrations/risco\n\n### Diagnostics information\n\n[home-assistant_risco_2024-10-15T21-27-37.448Z.log](https://github.com/user-attachments/files/17385307/home-assistant_risco_2024-10-15T21-27-37.448Z.log)\r\n\n\n### Example YAML snippet\n\n_No response_\n\n### Anything in the logs that might be useful for us?\n\n_No response_\n\n### Additional information\n\n_No response_\n", "hints_text": "\nHey there @onfreund, mind taking a look at this issue as it has been labeled with an integration (`risco`) you are listed as a [code owner](https://github.com/home-assistant/core/blob/dev/CODEOWNERS#L1230) for? Thanks!\n\n<details>\n<summary>Code owner commands</summary>\n\n\nCode owners of `risco` can trigger bot actions by commenting:\n\n- `@home-assistant close` Closes the issue.\n- `@home-assistant rename Awesome new title` Renames the issue.\n- `@home-assistant reopen` Reopen the issue.\n- `@home-assistant unassign risco` Removes the current integration label and assignees on the issue, add the integration domain after the command.\n- `@home-assistant add-label needs-more-information` Add a label (needs-more-information, problem in dependency, problem in custom component) to the issue.\n- `@home-assistant remove-label needs-more-information` Remove a label (needs-more-information, problem in dependency, problem in custom component) on the issue.\n\n</details>\n\n\n<sub><sup>(message by CodeOwnersMention)</sup></sub>\n\n---\n\n[risco documentation](https://www.home-assistant.io/integrations/risco)\n[risco source](https://github.com/home-assistant/core/tree/dev/homeassistant/components/risco)\n<sub><sup>(message by IssueLinks)</sup></sub>\nSame issue here since Risco updated their Cloud on 2024/10/14. \r\nRelates to Risco cloud integration (https://www.home-assistant.io/integrations/risco) pyrisco lib which talks to risco cloud via well known api urls.\r\n\r\n![image](https://github.com/user-attachments/assets/f33ba437-2edc-4645-9733-025241f4ce5a)\r\n\r\nAfter using Fiddler between ios/riscocloud app <> risco website i can confirm:\r\n* URL set on https://github.com/OnFreund/pyrisco/blob/master/pyrisco/cloud/risco_cloud.py are fine\r\n* difference exists on following request:\r\n  *  ControlPanel/GetState > \"fromControlPanel\" : false\" whereas current pyrisco set always fromControlPanel to true.\r\n \r\nwhich seems to fix the get_state() call.\r\n\r\nTrying to patch my local homeassistant with it.\nconfirmed: modifying following lines on the lib pyrisco solve this issue:\r\n\r\n```\r\nvi /var/lib/docker/overlay2/[your ha docker id]/merged/usr/local/lib/python3.12/site-packages/pyrisco/cloud/risco_cloud.py\r\n> line 57: add , from_control_panel=True\r\n> line 63: modify with: \"fromControlPanel\": from_control_panel,\r\n\r\n    async def _site_post(self, url, body, from_control_panel=True):\r\n        site_url = url % self._site_id\r\n        for i in range(NUM_RETRIES):\r\n            try:\r\n                site_body = {\r\n                    **body,\r\n                    \"fromControlPanel\": from_control_panel,\r\n                    \"sessionToken\": self._session_id,\r\n                }\r\n\r\n> line 134: add: , from_control_panel=False\r\n    async def get_state(self):\r\n        \"\"\"Get partitions and zones.\"\"\"\r\n        resp = await self._site_post(STATE_URL, {}, from_control_panel=False)\r\n        return Alarm(self, resp[\"state\"][\"status\"])\r\n```\r\n\r\nand alarm state comes back:\r\n\r\n![image](https://github.com/user-attachments/assets/8d585013-62b7-461f-898c-442a7ca1e9df)\r\n\r\nwill open an issue at pyrisco level\r\n\nsee:\r\n* https://github.com/OnFreund/pyrisco/issues/25\r\n* https://github.com/OnFreund/pyrisco/pull/26\r\n\nOk, thanks for digging into. Looking forward for an integration update\nThanks @agmckaybro!\r\nThe new pyrisco version is here: https://pypi.org/project/pyrisco/0.6.5/\nHere's the diff if you want to create a dependency bump PR for HA:\r\nhttps://github.com/OnFreund/pyrisco/compare/v0.6.4...v0.6.5\nCiao Guys, I'm ingnorant on that. What's next now? Will it be intermgrated in the next home assistant core update?", "created_at": "2024-12-06T15:13:51Z"}
{"repo": "home-assistant/core", "pull_number": 132474, "instance_id": "home-assistant__core-132474", "issue_numbers": ["132450"], "base_commit": "2eaf206562e5859bf8952dfb341b46269055117c", "patch": "diff --git a/homeassistant/components/samsungtv/manifest.json b/homeassistant/components/samsungtv/manifest.json\nindex 041e9b8fe9b3b..1a6b5ed5313ce 100644\n--- a/homeassistant/components/samsungtv/manifest.json\n+++ b/homeassistant/components/samsungtv/manifest.json\n@@ -37,7 +37,7 @@\n   \"requirements\": [\n     \"getmac==0.9.4\",\n     \"samsungctl[websocket]==0.7.1\",\n-    \"samsungtvws[async,encrypted]==2.7.1\",\n+    \"samsungtvws[async,encrypted]==2.7.2\",\n     \"wakeonlan==2.1.0\",\n     \"async-upnp-client==0.41.0\"\n   ],\ndiff --git a/requirements_all.txt b/requirements_all.txt\nindex b4a662e8d913f..bfc8a455e7b77 100644\n--- a/requirements_all.txt\n+++ b/requirements_all.txt\n@@ -2610,7 +2610,7 @@ rxv==0.7.0\n samsungctl[websocket]==0.7.1\n \n # homeassistant.components.samsungtv\n-samsungtvws[async,encrypted]==2.7.1\n+samsungtvws[async,encrypted]==2.7.2\n \n # homeassistant.components.sanix\n sanix==1.0.6\n", "test_patch": "diff --git a/requirements_test_all.txt b/requirements_test_all.txt\nindex 1710b83fe69a1..c8f64d4384cef 100644\n--- a/requirements_test_all.txt\n+++ b/requirements_test_all.txt\n@@ -2089,7 +2089,7 @@ rxv==0.7.0\n samsungctl[websocket]==0.7.1\n \n # homeassistant.components.samsungtv\n-samsungtvws[async,encrypted]==2.7.1\n+samsungtvws[async,encrypted]==2.7.2\n \n # homeassistant.components.sanix\n sanix==1.0.6\n", "problem_statement": " Samsung Smart TV not working in 2024.12.0\n### The problem\n\nWhen trying to upgrade to 2024.12.0, the status of the TV is unavailable. In 2024.11.3 it works fine.\n\n### What version of Home Assistant Core has the issue?\n\ncore-2024.12.0\n\n### What was the last working version of Home Assistant Core?\n\ncore-2024.11.3\n\n### What type of installation are you running?\n\nHome Assistant Container\n\n### Integration causing the issue\n\nSamsung Smart TV\n\n### Link to integration documentation on our website\n\nhttps://www.home-assistant.io/integrations/samsungtv\n\n### Diagnostics information\n\n[home-assistant_samsungtv_2024-12-06T03-31-39.959Z.log](https://github.com/user-attachments/files/18032407/home-assistant_samsungtv_2024-12-06T03-31-39.959Z.log)\r\n\n\n### Example YAML snippet\n\n_No response_\n\n### Anything in the logs that might be useful for us?\n\n_No response_\n\n### Additional information\n\n_No response_\n", "hints_text": "\nHey there @chemelli74, @epenet, mind taking a look at this issue as it has been labeled with an integration (`samsungtv`) you are listed as a [code owner](https://github.com/home-assistant/core/blob/dev/CODEOWNERS#L1280) for? Thanks!\n\n<details>\n<summary>Code owner commands</summary>\n\n\nCode owners of `samsungtv` can trigger bot actions by commenting:\n\n- `@home-assistant close` Closes the issue.\n- `@home-assistant rename Awesome new title` Renames the issue.\n- `@home-assistant reopen` Reopen the issue.\n- `@home-assistant unassign samsungtv` Removes the current integration label and assignees on the issue, add the integration domain after the command.\n- `@home-assistant add-label needs-more-information` Add a label (needs-more-information, problem in dependency, problem in custom component) to the issue.\n- `@home-assistant remove-label needs-more-information` Remove a label (needs-more-information, problem in dependency, problem in custom component) on the issue.\n\n</details>\n\n\n<sub><sup>(message by CodeOwnersMention)</sup></sub>\n\n---\n\n[samsungtv documentation](https://www.home-assistant.io/integrations/samsungtv)\n[samsungtv source](https://github.com/home-assistant/core/tree/dev/homeassistant/components/samsungtv)\n<sub><sup>(message by IssueLinks)</sup></sub>\nHello. I have the same thing!!! TV UE60H6200. For now I've rolled back...\nDo you have any errors in the logs? My television seems to show up like usual and I do not see any specific errors in the logs. \r\n\r\nfrom what I can see the smartthings integration has not seen any code changes for the last 2 months.\nHi, no there is no error in the logs, it's only what I have attached\nI also have no errors in the log, since the TV in the home assistant is always off (although in fact it is on).\nFound a double-negative in the library : https://github.com/xchwarze/samsung-tv-ws-api/pull/145", "created_at": "2024-12-06T10:16:56Z"}
{"repo": "home-assistant/core", "pull_number": 132472, "instance_id": "home-assistant__core-132472", "issue_numbers": ["132420"], "base_commit": "4b4c886438e3036a9ca09aee4b850465f91f809d", "patch": "diff --git a/homeassistant/components/tplink/manifest.json b/homeassistant/components/tplink/manifest.json\nindex 3f19f50cdb684..6ce46c0d48829 100644\n--- a/homeassistant/components/tplink/manifest.json\n+++ b/homeassistant/components/tplink/manifest.json\n@@ -300,5 +300,5 @@\n   \"documentation\": \"https://www.home-assistant.io/integrations/tplink\",\n   \"iot_class\": \"local_polling\",\n   \"loggers\": [\"kasa\"],\n-  \"requirements\": [\"python-kasa[speedups]==0.8.0\"]\n+  \"requirements\": [\"python-kasa[speedups]==0.8.1\"]\n }\ndiff --git a/requirements_all.txt b/requirements_all.txt\nindex dfdd11f26ce38..2fdfbea31ade1 100644\n--- a/requirements_all.txt\n+++ b/requirements_all.txt\n@@ -2362,7 +2362,7 @@ python-join-api==0.0.9\n python-juicenet==1.1.0\n \n # homeassistant.components.tplink\n-python-kasa[speedups]==0.8.0\n+python-kasa[speedups]==0.8.1\n \n # homeassistant.components.linkplay\n python-linkplay==0.0.20\n", "test_patch": "diff --git a/requirements_test_all.txt b/requirements_test_all.txt\nindex eba507b39e68b..ea5d92841fda9 100644\n--- a/requirements_test_all.txt\n+++ b/requirements_test_all.txt\n@@ -1892,7 +1892,7 @@ python-izone==1.2.9\n python-juicenet==1.1.0\n \n # homeassistant.components.tplink\n-python-kasa[speedups]==0.8.0\n+python-kasa[speedups]==0.8.1\n \n # homeassistant.components.linkplay\n python-linkplay==0.0.20\n", "problem_statement": "TP-Link Smart Home: C200 and C210 detected, but totally messed up entities\n### The problem\n\nC200 and C210 are detected with newest HA Core release, but the entities for them are totally messed up. For me three devices were discovered and named properly but when I click on the \"1 device\" link of each, I will land on the same device every time. Also the entities show for \"Camera Living Room\" (for example) are named \"Camera Kitchen\". When I reload the devices, it messes up even more. I don't know how I should explain that better.\r\n\r\nSee video: \r\n\r\nhttps://github.com/user-attachments/assets/86bc5969-e20a-4486-b195-789ab4c6cd45\r\n\r\n\n\n### What version of Home Assistant Core has the issue?\n\ncore-2024.12.0\n\n### What was the last working version of Home Assistant Core?\n\n_No response_\n\n### What type of installation are you running?\n\nHome Assistant OS\n\n### Integration causing the issue\n\nTP-Link Smart Home\n\n### Link to integration documentation on our website\n\nhttps://www.home-assistant.io/integrations/tplink\n\n### Diagnostics information\n\n_No response_\n\n### Example YAML snippet\n\n_No response_\n\n### Anything in the logs that might be useful for us?\n\n_No response_\n\n### Additional information\n\n_No response_\n", "hints_text": "\nHey there @rytilahti, @bdraco, @sdb9696, mind taking a look at this issue as it has been labeled with an integration (`tplink`) you are listed as a [code owner](https://github.com/home-assistant/core/blob/dev/CODEOWNERS#L1538) for? Thanks!\n\n<details>\n<summary>Code owner commands</summary>\n\n\nCode owners of `tplink` can trigger bot actions by commenting:\n\n- `@home-assistant close` Closes the issue.\n- `@home-assistant rename Awesome new title` Renames the issue.\n- `@home-assistant reopen` Reopen the issue.\n- `@home-assistant unassign tplink` Removes the current integration label and assignees on the issue, add the integration domain after the command.\n- `@home-assistant add-label needs-more-information` Add a label (needs-more-information, problem in dependency, problem in custom component) to the issue.\n- `@home-assistant remove-label needs-more-information` Remove a label (needs-more-information, problem in dependency, problem in custom component) on the issue.\n\n</details>\n\n\n<sub><sup>(message by CodeOwnersMention)</sup></sub>\n\n---\n\n[tplink documentation](https://www.home-assistant.io/integrations/tplink)\n[tplink source](https://github.com/home-assistant/core/tree/dev/homeassistant/components/tplink)\n<sub><sup>(message by IssueLinks)</sup></sub>\nSame problem here.\r\nI should add that I also have the custom integration \"Tapo: Cameras Control\" v. 5.8.5. There might be interference between the two?\n> Same problem here. I should add that I also have the custom integration \"Tapo: Cameras Control\" v. 5.8.5. There might be interference between the two?\r\n\r\nI have also installed Tapo: Cameras Control because it was the only integration supporting the C200 and C210 so far.\r\n\r\nIt seems to interfere, but how to fix that?\n@JurajNyiri is the code owner of the \"Tapo: Cameras Control\" integration, he might be able to shed some light...\r\n\nDiscovery is correct:\r\n![image](https://github.com/user-attachments/assets/ea956871-41a0-40fe-b04d-e459344fa296)\r\n\r\nAdding a camera (in this case \"Dachboden\" with .69 IP) first seems to be correct too:\r\n![image](https://github.com/user-attachments/assets/9838bf8b-b9ea-4324-b3fa-46c1ae773c10)\r\n\r\nBut then it is mapped on a false name:\r\n![image](https://github.com/user-attachments/assets/9f97e1fe-514a-4bed-891c-59fbfeab24bc)\r\n\r\nAlso when renaming it would like to rename the entities of \"Tapo: Cameras Control\" too.\r\n\nAll the cameras get mapped to a single device when adding to TP-Link Smart Home:\r\n\r\n![image](https://github.com/user-attachments/assets/a57aa24f-c4c4-42d0-b1b5-e444febee25a)\r\n\nHi, this is indeed a bug with the new camera support. Working on a fix now.", "created_at": "2024-12-06T09:51:42Z"}
{"repo": "home-assistant/core", "pull_number": 132457, "instance_id": "home-assistant__core-132457", "issue_numbers": ["132436"], "base_commit": "60fd9d50270472f75319ddb0294a93b98ef063e5", "patch": "diff --git a/homeassistant/components/nordpool/sensor.py b/homeassistant/components/nordpool/sensor.py\nindex e7e655a66572f..47617cc8e42cd 100644\n--- a/homeassistant/components/nordpool/sensor.py\n+++ b/homeassistant/components/nordpool/sensor.py\n@@ -27,7 +27,9 @@\n PARALLEL_UPDATES = 0\n \n \n-def get_prices(data: DeliveryPeriodData) -> dict[str, tuple[float, float, float]]:\n+def get_prices(\n+    data: DeliveryPeriodData,\n+) -> dict[str, tuple[float | None, float, float | None]]:\n     \"\"\"Return previous, current and next prices.\n \n     Output: {\"SE3\": (10.0, 10.5, 12.1)}\n@@ -39,6 +41,7 @@ def get_prices(data: DeliveryPeriodData) -> dict[str, tuple[float, float, float]\n     previous_time = current_time - timedelta(hours=1)\n     next_time = current_time + timedelta(hours=1)\n     price_data = data.entries\n+    LOGGER.debug(\"Price data: %s\", price_data)\n     for entry in price_data:\n         if entry.start <= current_time <= entry.end:\n             current_price_entries = entry.entry\n@@ -46,10 +49,20 @@ def get_prices(data: DeliveryPeriodData) -> dict[str, tuple[float, float, float]\n             last_price_entries = entry.entry\n         if entry.start <= next_time <= entry.end:\n             next_price_entries = entry.entry\n+    LOGGER.debug(\n+        \"Last price %s, current price %s, next price %s\",\n+        last_price_entries,\n+        current_price_entries,\n+        next_price_entries,\n+    )\n \n     result = {}\n     for area, price in current_price_entries.items():\n-        result[area] = (last_price_entries[area], price, next_price_entries[area])\n+        result[area] = (\n+            last_price_entries.get(area),\n+            price,\n+            next_price_entries.get(area),\n+        )\n     LOGGER.debug(\"Prices: %s\", result)\n     return result\n \n@@ -90,7 +103,7 @@ class NordpoolDefaultSensorEntityDescription(SensorEntityDescription):\n class NordpoolPricesSensorEntityDescription(SensorEntityDescription):\n     \"\"\"Describes Nord Pool prices sensor entity.\"\"\"\n \n-    value_fn: Callable[[tuple[float, float, float]], float | None]\n+    value_fn: Callable[[tuple[float | None, float, float | None]], float | None]\n \n \n @dataclass(frozen=True, kw_only=True)\n@@ -136,13 +149,13 @@ class NordpoolBlockPricesSensorEntityDescription(SensorEntityDescription):\n     NordpoolPricesSensorEntityDescription(\n         key=\"last_price\",\n         translation_key=\"last_price\",\n-        value_fn=lambda data: data[0] / 1000,\n+        value_fn=lambda data: data[0] / 1000 if data[0] else None,\n         suggested_display_precision=2,\n     ),\n     NordpoolPricesSensorEntityDescription(\n         key=\"next_price\",\n         translation_key=\"next_price\",\n-        value_fn=lambda data: data[2] / 1000,\n+        value_fn=lambda data: data[2] / 1000 if data[2] else None,\n         suggested_display_precision=2,\n     ),\n )\n", "test_patch": "", "problem_statement": "Nordpool: cannot setup for NL\n### The problem\r\n\r\nI tried the new NordPool integration ()\r\nBut it doesn't work, nothing is created.\r\n\r\nLogs shows:\r\n\r\n`\r\n-12-05 23:06:21.685 DEBUG (MainThread) [pynordpool.const] Retrieve prices from https://dataportal-api.nordpoolgroup.com/api/DayAheadPrices with params {'date': '2024-12-05', 'market': 'DayAhead', 'deliveryArea': 'NL', 'currency': 'EUR'}\r\n2024-12-05 23:06:21.685 DEBUG (MainThread) [pynordpool.const] Attempting get with path https://dataportal-api.nordpoolgroup.com/api/DayAheadPrices and parameters {'date': '2024-12-05', 'market': 'DayAhead', 'deliveryArea': 'NL', 'currency': 'EUR'}\r\n2024-12-05 23:06:21.772 DEBUG (MainThread) [pynordpool.const] Response {'method': 'GET', '_real_url': URL('https://dataportal-api.nordpoolgroup.com/api/DayAheadPrices?date=2024-12-05&market=DayAhead&deliveryArea=NL&currency=EUR'), '_url': URL('https://dataportal-api.nordpoolgroup.com/api/DayAheadPrices?date=2024-12-05&market=DayAhead&deliveryArea=NL&currency=EUR'), '_request_info': RequestInfo(url=URL('https://dataportal-api.nordpoolgroup.com/api/DayAheadPrices?date=2024-12-05&market=DayAhead&deliveryArea=NL&currency=EUR'), method='GET', headers=<CIMultiDictProxy('Host': 'dataportal-api.nordpoolgroup.com', 'User-Agent': 'HomeAssistant/2024.12.0 aiohttp/3.11.9 Python/3.13', 'Accept': '*/*', 'Accept-Encoding': 'gzip, deflate, br', 'Cookie': 'route=1733436054.379.172.200133|9898ac1b7e0bd8fc3874537f2a76b591')>, real_url=URL('https://dataportal-api.nordpoolgroup.com/api/DayAheadPrices?date=2024-12-05&market=DayAhead&deliveryArea=NL&currency=EUR')), '_timer': <aiohttp.helpers.TimerContext object at 0x7fec08cef580>, '_cache': {'headers': <CIMultiDictProxy('Date': 'Thu, 05 Dec 2024 22:06:21 GMT', 'Content-Type': 'application/json; charset=utf-8', 'Transfer-Encoding': 'chunked', 'Connection': 'keep-alive', 'Content-Encoding': 'br', 'Vary': 'Accept-Encoding', 'Request-Context': 'appId=cid-v1:ddfe5a25-b9d8-4f0e-b951-f04e01c2922f', 'Strict-Transport-Security': 'max-age=31536000')>}, '_traces': [], '_loop': <_UnixSelectorEventLoop running=True closed=False debug=False>, '_session': None, '_resolve_charset': <function ClientSession.<lambda> at 0x7fec80193e20>, '_closed': True, '_protocol': <aiohttp.client_proto.ResponseHandler object at 0x7fec0e0996d0>, '_connection': None, 'version': HttpVersion(major=1, minor=1), 'status': 200, 'reason': 'OK', '_headers': <CIMultiDictProxy('Date': 'Thu, 05 Dec 2024 22:06:21 GMT', 'Content-Type': 'application/json; charset=utf-8', 'Transfer-Encoding': 'chunked', 'Connection': 'keep-alive', 'Content-Encoding': 'br', 'Vary': 'Accept-Encoding', 'Request-Context': 'appId=cid-v1:ddfe5a25-b9d8-4f0e-b951-f04e01c2922f', 'Strict-Transport-Security': 'max-age=31536000')>, '_raw_headers': ((b'Date', b'Thu, 05 Dec 2024 22:06:21 GMT'), (b'Content-Type', b'application/json; charset=utf-8'), (b'Transfer-Encoding', b'chunked'), (b'Connection', b'keep-alive'), (b'Content-Encoding', b'br'), (b'Vary', b'Accept-Encoding'), (b'Request-Context', b'appId=cid-v1:ddfe5a25-b9d8-4f0e-b951-f04e01c2922f'), (b'Strict-Transport-Security', b'max-age=31536000')), 'content': <StreamReader 3390 bytes eof>, '_history': (), '_in_context': True}\r\n2024-12-05 23:06:21.773 DEBUG (MainThread) [pynordpool.const] Response status 200\r\n2024-12-05 23:06:21.777 DEBUG (MainThread) [homeassistant.components.nordpool] Next update at 2024-12-05 23:00:00+00:00\r\n2024-12-05 23:06:21.784 DEBUG (MainThread) [pynordpool.const] Retrieve prices from https://dataportal-api.nordpoolgroup.com/api/DayAheadPrices with params {'date': '2024-12-05', 'market': 'DayAhead', 'deliveryArea': 'NL', 'currency': 'EUR'}\r\n2024-12-05 23:06:21.784 DEBUG (MainThread) [pynordpool.const] Attempting get with path https://dataportal-api.nordpoolgroup.com/api/DayAheadPrices and parameters {'date': '2024-12-05', 'market': 'DayAhead', 'deliveryArea': 'NL', 'currency': 'EUR'}\r\n2024-12-05 23:06:21.798 DEBUG (MainThread) [pynordpool.const] Response {'method': 'GET', '_real_url': URL('https://dataportal-api.nordpoolgroup.com/api/DayAheadPrices?date=2024-12-05&market=DayAhead&deliveryArea=NL&currency=EUR'), '_url': URL('https://dataportal-api.nordpoolgroup.com/api/DayAheadPrices?date=2024-12-05&market=DayAhead&deliveryArea=NL&currency=EUR'), '_request_info': RequestInfo(url=URL('https://dataportal-api.nordpoolgroup.com/api/DayAheadPrices?date=2024-12-05&market=DayAhead&deliveryArea=NL&currency=EUR'), method='GET', headers=<CIMultiDictProxy('Host': 'dataportal-api.nordpoolgroup.com', 'User-Agent': 'HomeAssistant/2024.12.0 aiohttp/3.11.9 Python/3.13', 'Accept': '*/*', 'Accept-Encoding': 'gzip, deflate, br', 'Cookie': 'route=1733436054.379.172.200133|9898ac1b7e0bd8fc3874537f2a76b591')>, real_url=URL('https://dataportal-api.nordpoolgroup.com/api/DayAheadPrices?date=2024-12-05&market=DayAhead&deliveryArea=NL&currency=EUR')), '_timer': <aiohttp.helpers.TimerContext object at 0x7fec08f49340>, '_cache': {'headers': <CIMultiDictProxy('Date': 'Thu, 05 Dec 2024 22:06:21 GMT', 'Content-Type': 'application/json; charset=utf-8', 'Transfer-Encoding': 'chunked', 'Connection': 'keep-alive', 'Content-Encoding': 'br', 'Vary': 'Accept-Encoding', 'Request-Context': 'appId=cid-v1:ddfe5a25-b9d8-4f0e-b951-f04e01c2922f', 'Strict-Transport-Security': 'max-age=31536000')>}, '_traces': [], '_loop': <_UnixSelectorEventLoop running=True closed=False debug=False>, '_session': None, '_resolve_charset': <function ClientSession.<lambda> at 0x7fec80193e20>, '_closed': True, '_protocol': <aiohttp.client_proto.ResponseHandler object at 0x7fec0e0996d0>, '_connection': None, 'version': HttpVersion(major=1, minor=1), 'status': 200, 'reason': 'OK', '_headers': <CIMultiDictProxy('Date': 'Thu, 05 Dec 2024 22:06:21 GMT', 'Content-Type': 'application/json; charset=utf-8', 'Transfer-Encoding': 'chunked', 'Connection': 'keep-alive', 'Content-Encoding': 'br', 'Vary': 'Accept-Encoding', 'Request-Context': 'appId=cid-v1:ddfe5a25-b9d8-4f0e-b951-f04e01c2922f', 'Strict-Transport-Security': 'max-age=31536000')>, '_raw_headers': ((b'Date', b'Thu, 05 Dec 2024 22:06:21 GMT'), (b'Content-Type', b'application/json; charset=utf-8'), (b'Transfer-Encoding', b'chunked'), (b'Connection', b'keep-alive'), (b'Content-Encoding', b'br'), (b'Vary', b'Accept-Encoding'), (b'Request-Context', b'appId=cid-v1:ddfe5a25-b9d8-4f0e-b951-f04e01c2922f'), (b'Strict-Transport-Security', b'max-age=31536000')), 'content': <StreamReader 3390 bytes eof>, '_history': (), '_in_context': True}\r\n2024-12-05 23:06:21.801 DEBUG (MainThread) [pynordpool.const] Response status 200\r\n2024-12-05 23:06:21.802 DEBUG (MainThread) [homeassistant.components.nordpool] Manually updated nordpool data\r\n2024-12-05 23:06:21.804 ERROR (MainThread) [homeassistant.components.sensor] Error while setting up nordpool platform for sensor\r\nTraceback (most recent call last):\r\n  File \"/usr/src/homeassistant/homeassistant/helpers/entity_platform.py\", line 366, in _async_setup_platform\r\n    await asyncio.shield(awaitable)\r\n  File \"/usr/src/homeassistant/homeassistant/components/nordpool/sensor.py\", line 212, in async_setup_entry\r\n    for area in get_prices(entry.runtime_data.data):\r\n                ~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/src/homeassistant/homeassistant/components/nordpool/sensor.py\", line 52, in get_prices\r\n    result[area] = (last_price_entries[area], price, next_price_entries[area])\r\n                                                     ~~~~~~~~~~~~~~~~~~^^^^^^\r\nKeyError: 'NL'\r\n`\r\n\r\n<img width=\"966\" alt=\"Screenshot 2024-12-05 at 23 29 13\" src=\"https://github.com/user-attachments/assets/be16109c-fc31-44fb-a5e2-c053138c6fe8\">\r\n\r\n\r\n\r\n### What version of Home Assistant Core has the issue?\r\n\r\n2014.12\r\n\r\n### What was the last working version of Home Assistant Core?\r\n\r\n_No response_\r\n\r\n### What type of installation are you running?\r\n\r\nHome Assistant OS\r\n\r\n### Integration causing the issue\r\n\r\nnordpool\r\n\r\n### Link to integration documentation on our website\r\n\r\nhttps://www.home-assistant.io/integrations/nordpool\r\n\r\n### Diagnostics information\r\n\r\n_No response_\r\n\r\n### Example YAML snippet\r\n\r\n_No response_\r\n\r\n### Anything in the logs that might be useful for us?\r\n\r\n_No response_\r\n\r\n### Additional information\r\n\r\n_No response_\n", "hints_text": "\nHey there @gjohansson-st, mind taking a look at this issue as it has been labeled with an integration (`nordpool`) you are listed as a [code owner](https://github.com/home-assistant/core/blob/dev/CODEOWNERS#L1017) for? Thanks!\n\n<details>\n<summary>Code owner commands</summary>\n\n\nCode owners of `nordpool` can trigger bot actions by commenting:\n\n- `@home-assistant close` Closes the issue.\n- `@home-assistant rename Awesome new title` Renames the issue.\n- `@home-assistant reopen` Reopen the issue.\n- `@home-assistant unassign nordpool` Removes the current integration label and assignees on the issue, add the integration domain after the command.\n- `@home-assistant add-label needs-more-information` Add a label (needs-more-information, problem in dependency, problem in custom component) to the issue.\n- `@home-assistant remove-label needs-more-information` Remove a label (needs-more-information, problem in dependency, problem in custom component) on the issue.\n\n</details>\n\n\n<sub><sup>(message by CodeOwnersMention)</sup></sub>\n\n---\n\n[nordpool documentation](https://www.home-assistant.io/integrations/nordpool)\n[nordpool source](https://github.com/home-assistant/core/tree/dev/homeassistant/components/nordpool)\n<sub><sup>(message by IssueLinks)</sup></sub>\nI have the same issue with SE3\r\n\r\nI Previously had [this custom component ](https://github.com/custom-components/nordpool) installed, but i completely removed it and restarted HA before adding this new integration, so SHOULD not be related, byt maybe it left some garbage somewhere?\r\n\r\n```\r\nLogger: homeassistant.components.sensor\r\nK\u00e4lla: helpers/entity_platform.py:366\r\nintegration: Sensor (dokumentation, \u00e4renden)\r\nIntr\u00e4ffade f\u00f6rst: 00:12:37 (5 h\u00e4ndelser)\r\nSenast loggade: 00:15:44\r\n\r\nError while setting up nordpool platform for sensor\r\nTraceback (most recent call last):\r\n  File \"/usr/src/homeassistant/homeassistant/helpers/entity_platform.py\", line 366, in _async_setup_platform\r\n    await asyncio.shield(awaitable)\r\n  File \"/usr/src/homeassistant/homeassistant/components/nordpool/sensor.py\", line 212, in async_setup_entry\r\n    for area in get_prices(entry.runtime_data.data):\r\n                ~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/src/homeassistant/homeassistant/components/nordpool/sensor.py\", line 52, in get_prices\r\n    result[area] = (last_price_entries[area], price, next_price_entries[area])\r\n                    ~~~~~~~~~~~~~~~~~~^^^^^^\r\nKeyError: 'SE3'\r\n```", "created_at": "2024-12-06T06:47:47Z"}
{"repo": "home-assistant/core", "pull_number": 132364, "instance_id": "home-assistant__core-132364", "issue_numbers": ["132360"], "base_commit": "52e6afdcca500da9fc2601bb29decdc181ab6a4d", "patch": "diff --git a/homeassistant/components/utility_meter/__init__.py b/homeassistant/components/utility_meter/__init__.py\nindex c6a8635f831c4..aac31e085a038 100644\n--- a/homeassistant/components/utility_meter/__init__.py\n+++ b/homeassistant/components/utility_meter/__init__.py\n@@ -1,9 +1,9 @@\n \"\"\"Support for tracking consumption over given periods of time.\"\"\"\n \n-from datetime import timedelta\n+from datetime import datetime, timedelta\n import logging\n \n-from croniter import croniter\n+from cronsim import CronSim, CronSimError\n import voluptuous as vol\n \n from homeassistant.components.select import DOMAIN as SELECT_DOMAIN\n@@ -47,9 +47,12 @@\n \n def validate_cron_pattern(pattern):\n     \"\"\"Check that the pattern is well-formed.\"\"\"\n-    if croniter.is_valid(pattern):\n-        return pattern\n-    raise vol.Invalid(\"Invalid pattern\")\n+    try:\n+        CronSim(pattern, datetime(2020, 1, 1))  # any date will do\n+    except CronSimError as err:\n+        _LOGGER.error(\"Invalid cron pattern %s: %s\", pattern, err)\n+        raise vol.Invalid(\"Invalid pattern\") from err\n+    return pattern\n \n \n def period_or_cron(config):\ndiff --git a/homeassistant/components/utility_meter/manifest.json b/homeassistant/components/utility_meter/manifest.json\nindex 31a2d4e958406..5167c51469dd5 100644\n--- a/homeassistant/components/utility_meter/manifest.json\n+++ b/homeassistant/components/utility_meter/manifest.json\n@@ -6,7 +6,6 @@\n   \"documentation\": \"https://www.home-assistant.io/integrations/utility_meter\",\n   \"integration_type\": \"helper\",\n   \"iot_class\": \"local_push\",\n-  \"loggers\": [\"croniter\"],\n   \"quality_scale\": \"internal\",\n   \"requirements\": [\"cronsim==2.6\"]\n }\n", "test_patch": "", "problem_statement": "Integration utility_meter caused error: No module named 'croniter'\n### The problem\r\n\r\nSince I recreated my Python venv to update to Python 3.13 and installed Home Assistant 2024.12 the utility meter fails because the croniter module is missing\r\n\r\n### What version of Home Assistant Core has the issue?\r\n\r\n2024.12.0\r\n\r\n### What was the last working version of Home Assistant Core?\r\n\r\n2024.11\r\n\r\n### What type of installation are you running?\r\n\r\nHome Assistant Core\r\n\r\n### Integration causing the issue\r\n\r\nUtility meter\r\n\r\n### Link to integration documentation on our website\r\n\r\nhttps://www.home-assistant.io/integrations/utility_meter\r\n\r\n### Diagnostics information\r\n\r\n_No response_\r\n\r\n### Example YAML snippet\r\n\r\n```yaml\r\nutility_meter:\r\n  energie_quotidienne:\r\n    source: sensor.index_base\r\n    cycle: daily\r\n  energie_mensuelle:\r\n    source: sensor.index_base\r\n    cycle: monthly\r\n```\r\n\r\n\r\n### Anything in the logs that might be useful for us?\r\n\r\n```txt\r\n2024-12-05 09:55:30.700 ERROR (MainThread) [homeassistant.config] Setup of package 'conso_electrique' at packages/conso_electrique.yaml, line 1 failed: Integration utility_meter caused error: No module named 'croniter'\r\n2024-12-05 09:57:12.411 ERROR (MainThread) [homeassistant.config] Setup of package 'conso_electrique' at packages/conso_electrique.yaml, line 1 failed: Integration utility_meter caused error: No module named 'croniter'\r\n2024-12-05 10:13:03.168 ERROR (MainThread) [homeassistant.config] Setup of package 'conso_electrique' at packages/conso_electrique.yaml, line 1 failed: Integration utility_meter caused error: No module named 'croniter'\r\n```\r\n\r\n\r\n### Additional information\r\n\r\n_No response_\n", "hints_text": "\nHey there @dgomes, mind taking a look at this issue as it has been labeled with an integration (`utility_meter`) you are listed as a [code owner](https://github.com/home-assistant/core/blob/dev/CODEOWNERS#L1599) for? Thanks!\n\n<details>\n<summary>Code owner commands</summary>\n\n\nCode owners of `utility_meter` can trigger bot actions by commenting:\n\n- `@home-assistant close` Closes the issue.\n- `@home-assistant rename Awesome new title` Renames the issue.\n- `@home-assistant reopen` Reopen the issue.\n- `@home-assistant unassign utility_meter` Removes the current integration label and assignees on the issue, add the integration domain after the command.\n- `@home-assistant add-label needs-more-information` Add a label (needs-more-information, problem in dependency, problem in custom component) to the issue.\n- `@home-assistant remove-label needs-more-information` Remove a label (needs-more-information, problem in dependency, problem in custom component) on the issue.\n\n</details>\n\n\n<sub><sup>(message by CodeOwnersMention)</sup></sub>\n\n---\n\n[utility_meter documentation](https://www.home-assistant.io/integrations/utility_meter)\n[utility_meter source](https://github.com/home-assistant/core/tree/dev/homeassistant/components/utility_meter)\n<sub><sup>(message by IssueLinks)</sup></sub>", "created_at": "2024-12-05T10:59:11Z"}
{"repo": "home-assistant/core", "pull_number": 132339, "instance_id": "home-assistant__core-132339", "issue_numbers": ["132298", "132298"], "base_commit": "5137b06ee7b5e797ef0ac6170466cfdd622d4ea6", "patch": "diff --git a/homeassistant/components/tesla_fleet/const.py b/homeassistant/components/tesla_fleet/const.py\nindex 53e34092326e96..c70cc3291f7d53 100644\n--- a/homeassistant/components/tesla_fleet/const.py\n+++ b/homeassistant/components/tesla_fleet/const.py\n@@ -21,6 +21,7 @@\n     Scope.OPENID,\n     Scope.OFFLINE_ACCESS,\n     Scope.VEHICLE_DEVICE_DATA,\n+    Scope.VEHICLE_LOCATION,\n     Scope.VEHICLE_CMDS,\n     Scope.VEHICLE_CHARGING_CMDS,\n     Scope.ENERGY_DEVICE_DATA,\ndiff --git a/homeassistant/components/tesla_fleet/manifest.json b/homeassistant/components/tesla_fleet/manifest.json\nindex f27929032d7b33..95062a8f856c7c 100644\n--- a/homeassistant/components/tesla_fleet/manifest.json\n+++ b/homeassistant/components/tesla_fleet/manifest.json\n@@ -7,5 +7,5 @@\n   \"documentation\": \"https://www.home-assistant.io/integrations/tesla_fleet\",\n   \"iot_class\": \"cloud_polling\",\n   \"loggers\": [\"tesla-fleet-api\"],\n-  \"requirements\": [\"tesla-fleet-api==0.8.4\"]\n+  \"requirements\": [\"tesla-fleet-api==0.8.5\"]\n }\ndiff --git a/homeassistant/components/teslemetry/manifest.json b/homeassistant/components/teslemetry/manifest.json\nindex fc82dea6445ae0..3736d76bf36010 100644\n--- a/homeassistant/components/teslemetry/manifest.json\n+++ b/homeassistant/components/teslemetry/manifest.json\n@@ -6,5 +6,5 @@\n   \"documentation\": \"https://www.home-assistant.io/integrations/teslemetry\",\n   \"iot_class\": \"cloud_polling\",\n   \"loggers\": [\"tesla-fleet-api\"],\n-  \"requirements\": [\"tesla-fleet-api==0.8.4\", \"teslemetry-stream==0.4.2\"]\n+  \"requirements\": [\"tesla-fleet-api==0.8.5\", \"teslemetry-stream==0.4.2\"]\n }\ndiff --git a/homeassistant/components/tessie/manifest.json b/homeassistant/components/tessie/manifest.json\nindex cab9f4c706df19..2b8ae924fe3a66 100644\n--- a/homeassistant/components/tessie/manifest.json\n+++ b/homeassistant/components/tessie/manifest.json\n@@ -6,5 +6,5 @@\n   \"documentation\": \"https://www.home-assistant.io/integrations/tessie\",\n   \"iot_class\": \"cloud_polling\",\n   \"loggers\": [\"tessie\", \"tesla-fleet-api\"],\n-  \"requirements\": [\"tessie-api==0.1.1\", \"tesla-fleet-api==0.8.4\"]\n+  \"requirements\": [\"tessie-api==0.1.1\", \"tesla-fleet-api==0.8.5\"]\n }\ndiff --git a/requirements_all.txt b/requirements_all.txt\nindex 5fe9f3950da883..b57fa636d74915 100644\n--- a/requirements_all.txt\n+++ b/requirements_all.txt\n@@ -2810,7 +2810,7 @@ temperusb==1.6.1\n # homeassistant.components.tesla_fleet\n # homeassistant.components.teslemetry\n # homeassistant.components.tessie\n-tesla-fleet-api==0.8.4\n+tesla-fleet-api==0.8.5\n \n # homeassistant.components.powerwall\n tesla-powerwall==0.5.2\n", "test_patch": "diff --git a/requirements_test_all.txt b/requirements_test_all.txt\nindex 3c3ca8625c438e..b3674c6de57f2e 100644\n--- a/requirements_test_all.txt\n+++ b/requirements_test_all.txt\n@@ -2241,7 +2241,7 @@ temperusb==1.6.1\n # homeassistant.components.tesla_fleet\n # homeassistant.components.teslemetry\n # homeassistant.components.tessie\n-tesla-fleet-api==0.8.4\n+tesla-fleet-api==0.8.5\n \n # homeassistant.components.powerwall\n tesla-powerwall==0.5.2\ndiff --git a/tests/components/tesla_fleet/snapshots/test_diagnostics.ambr b/tests/components/tesla_fleet/snapshots/test_diagnostics.ambr\nindex eb8c57910a4905..cdb24b1d2b59ba 100644\n--- a/tests/components/tesla_fleet/snapshots/test_diagnostics.ambr\n+++ b/tests/components/tesla_fleet/snapshots/test_diagnostics.ambr\n@@ -165,6 +165,7 @@\n       'openid',\n       'offline_access',\n       'vehicle_device_data',\n+      'vehicle_location',\n       'vehicle_cmds',\n       'vehicle_charging_cmds',\n       'energy_device_data',\n", "problem_statement": "ValueError: 'vehicle_location' is not a valid Scope\n### The problem\r\n\r\nIntermittently, after rebooting home assistant all possible sensors associated with the Tesla Fleet integration show as `UNAVAILABLE`; including the respective Tesla Powerwall sensors that were also detected (I have 2 Powerwalls).  The entire integration fails to setup/start.  The following error is causing this issue:\r\n\r\n```\r\n2024-12-04 10:26:51.164 ERROR (MainThread) [homeassistant.config_entries] Error setting up entry b224dcf5-566b-4847-af90-1c4b51e5dc3b for tesla_fleet\r\nTraceback (most recent call last):\r\n  File \"/usr/src/homeassistant/homeassistant/config_entries.py\", line 635, in __async_setup_with_context\r\n    result = await component.async_setup_entry(hass, self)\r\n             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/src/homeassistant/homeassistant/components/tesla_fleet/__init__.py\", line 68, in async_setup_entry\r\n    scopes: list[Scope] = [Scope(s) for s in token[\"scp\"]]\r\n                           ^^^^^^^^\r\n  File \"/usr/local/lib/python3.12/enum.py\", line 757, in __call__\r\n    return cls.__new__(cls, value)\r\n           ^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/local/lib/python3.12/enum.py\", line 1171, in __new__\r\n    raise ve_exc\r\nValueError: 'vehicle_location' is not a valid Scope\r\n```\r\n\r\nThings I've tried that didn't make any difference:\r\n- Reload integration.\r\n- Unable to click `Wake` sensor from this integration since it is unavailable also.\r\n\r\nI think it might have something to do with my car not being accessible during reboot (such as when the car is parked inside a basement parking garage).  However, I don't understand why my Powerwall sensors that also provided by this integration are also `unavailable`.  Both of my Powerwalls are located at home with a great network/Internet connection.  **Please note, while this is occuring, I have to rely on the _other_ Home Assistant Powerwall integration (native Powerwall integration); which is always reliable.**\r\n\r\nIs there a conflict between the official Tesla Fleet integration and the official Test Powerwall integration?  I noticed that every time I add the Tesla Fleet integration to Home Assistant, it isn't able to add the `Status` sensor shown below.  \r\n\r\n![image](https://github.com/user-attachments/assets/8c972f5d-6574-4f5f-b549-0ff3d8c3dc7c)\r\n\r\nI have to reboot for the `Status` sensor above to be added to the integration.  Also, after rebooting (to add `Status` shown above), the integration doesn't retrieve the friendly name of the device `Tesla Model Y`.  Instead of displaying `Tesla Model Y` it displays:\r\n`Unnamed device`.  I have to manually change this to `Tesla Model Y` each time.\r\n\r\n![image](https://github.com/user-attachments/assets/357803fd-4313-415f-8727-7747178e4cb7)\r\n\r\n\r\n### What version of Home Assistant Core has the issue?\r\n\r\nCore-2024.11.3\r\n\r\n### What was the last working version of Home Assistant Core?\r\n\r\n_No response_\r\n\r\n### What type of installation are you running?\r\n\r\nHome Assistant OS\r\n\r\n### Integration causing the issue\r\n\r\nTesla Fleet\r\n\r\n### Link to integration documentation on our website\r\n\r\nhttps://www.home-assistant.io/integrations/tesla_fleet/\r\n\r\n### Diagnostics information\r\n\r\nUnable to retrieve diagnostic data.  The current condition of the integration doesnt provide a way to retrieve/download diagnostics data file.\r\n\r\n### Example YAML snippet\r\n\r\n_No response_\r\n\r\n### Anything in the logs that might be useful for us?\r\n\r\n_No response_\r\n\r\n### Additional information\r\n\r\n_No response_\nValueError: 'vehicle_location' is not a valid Scope\n### The problem\r\n\r\nIntermittently, after rebooting home assistant all possible sensors associated with the Tesla Fleet integration show as `UNAVAILABLE`; including the respective Tesla Powerwall sensors that were also detected (I have 2 Powerwalls).  The entire integration fails to setup/start.  The following error is causing this issue:\r\n\r\n```\r\n2024-12-04 10:26:51.164 ERROR (MainThread) [homeassistant.config_entries] Error setting up entry b224dcf5-566b-4847-af90-1c4b51e5dc3b for tesla_fleet\r\nTraceback (most recent call last):\r\n  File \"/usr/src/homeassistant/homeassistant/config_entries.py\", line 635, in __async_setup_with_context\r\n    result = await component.async_setup_entry(hass, self)\r\n             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/src/homeassistant/homeassistant/components/tesla_fleet/__init__.py\", line 68, in async_setup_entry\r\n    scopes: list[Scope] = [Scope(s) for s in token[\"scp\"]]\r\n                           ^^^^^^^^\r\n  File \"/usr/local/lib/python3.12/enum.py\", line 757, in __call__\r\n    return cls.__new__(cls, value)\r\n           ^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/local/lib/python3.12/enum.py\", line 1171, in __new__\r\n    raise ve_exc\r\nValueError: 'vehicle_location' is not a valid Scope\r\n```\r\n\r\nThings I've tried that didn't make any difference:\r\n- Reload integration.\r\n- Unable to click `Wake` sensor from this integration since it is unavailable also.\r\n\r\nI think it might have something to do with my car not being accessible during reboot (such as when the car is parked inside a basement parking garage).  However, I don't understand why my Powerwall sensors that also provided by this integration are also `unavailable`.  Both of my Powerwalls are located at home with a great network/Internet connection.  **Please note, while this is occuring, I have to rely on the _other_ Home Assistant Powerwall integration (native Powerwall integration); which is always reliable.**\r\n\r\nIs there a conflict between the official Tesla Fleet integration and the official Test Powerwall integration?  I noticed that every time I add the Tesla Fleet integration to Home Assistant, it isn't able to add the `Status` sensor shown below.  \r\n\r\n![image](https://github.com/user-attachments/assets/8c972f5d-6574-4f5f-b549-0ff3d8c3dc7c)\r\n\r\nI have to reboot for the `Status` sensor above to be added to the integration.  Also, after rebooting (to add `Status` shown above), the integration doesn't retrieve the friendly name of the device `Tesla Model Y`.  Instead of displaying `Tesla Model Y` it displays:\r\n`Unnamed device`.  I have to manually change this to `Tesla Model Y` each time.\r\n\r\n![image](https://github.com/user-attachments/assets/357803fd-4313-415f-8727-7747178e4cb7)\r\n\r\n\r\n### What version of Home Assistant Core has the issue?\r\n\r\nCore-2024.11.3\r\n\r\n### What was the last working version of Home Assistant Core?\r\n\r\n_No response_\r\n\r\n### What type of installation are you running?\r\n\r\nHome Assistant OS\r\n\r\n### Integration causing the issue\r\n\r\nTesla Fleet\r\n\r\n### Link to integration documentation on our website\r\n\r\nhttps://www.home-assistant.io/integrations/tesla_fleet/\r\n\r\n### Diagnostics information\r\n\r\nUnable to retrieve diagnostic data.  The current condition of the integration doesnt provide a way to retrieve/download diagnostics data file.\r\n\r\n### Example YAML snippet\r\n\r\n_No response_\r\n\r\n### Anything in the logs that might be useful for us?\r\n\r\n_No response_\r\n\r\n### Additional information\r\n\r\n_No response_\n", "hints_text": "\nHey there @bre77, mind taking a look at this issue as it has been labeled with an integration (`tesla_fleet`) you are listed as a [code owner](https://github.com/home-assistant/core/blob/dev/CODEOWNERS#L1496) for? Thanks!\n\n<details>\n<summary>Code owner commands</summary>\n\n\nCode owners of `tesla_fleet` can trigger bot actions by commenting:\n\n- `@home-assistant close` Closes the issue.\n- `@home-assistant rename Awesome new title` Renames the issue.\n- `@home-assistant reopen` Reopen the issue.\n- `@home-assistant unassign tesla_fleet` Removes the current integration label and assignees on the issue, add the integration domain after the command.\n- `@home-assistant add-label needs-more-information` Add a label (needs-more-information, problem in dependency, problem in custom component) to the issue.\n- `@home-assistant remove-label needs-more-information` Remove a label (needs-more-information, problem in dependency, problem in custom component) on the issue.\n\n</details>\n\n\n<sub><sup>(message by CodeOwnersMention)</sup></sub>\n\n---\n\n[tesla_fleet documentation](https://www.home-assistant.io/integrations/tesla_fleet)\n[tesla_fleet source](https://github.com/home-assistant/core/tree/dev/homeassistant/components/tesla_fleet)\n<sub><sup>(message by IssueLinks)</sup></sub>\nAre you using the built in OAuth credentials or created your own?\n\nIf you created your own did you perform your own Authentication flow or use the one in home Assistant?\n\nTesla recently added that scope so the underlying python library doesn't support it yet.\nIm using whatever is builtin to this Integration to login to tesla (identical to how I login to my Tesla account in a web browser).  I didnt create anything on my own.  I simply pointed the integration to my home assistant instance URL (that's reachable from anywhere in the world) and, it installed the integration.  However, I had to subsequently reboot in order to see the sensors provided by `Status` in the screenshot I provided above.\r\n\r\nLet me know if there is anything else I can provide.\n\nHey there @bre77, mind taking a look at this issue as it has been labeled with an integration (`tesla_fleet`) you are listed as a [code owner](https://github.com/home-assistant/core/blob/dev/CODEOWNERS#L1496) for? Thanks!\n\n<details>\n<summary>Code owner commands</summary>\n\n\nCode owners of `tesla_fleet` can trigger bot actions by commenting:\n\n- `@home-assistant close` Closes the issue.\n- `@home-assistant rename Awesome new title` Renames the issue.\n- `@home-assistant reopen` Reopen the issue.\n- `@home-assistant unassign tesla_fleet` Removes the current integration label and assignees on the issue, add the integration domain after the command.\n- `@home-assistant add-label needs-more-information` Add a label (needs-more-information, problem in dependency, problem in custom component) to the issue.\n- `@home-assistant remove-label needs-more-information` Remove a label (needs-more-information, problem in dependency, problem in custom component) on the issue.\n\n</details>\n\n\n<sub><sup>(message by CodeOwnersMention)</sup></sub>\n\n---\n\n[tesla_fleet documentation](https://www.home-assistant.io/integrations/tesla_fleet)\n[tesla_fleet source](https://github.com/home-assistant/core/tree/dev/homeassistant/components/tesla_fleet)\n<sub><sup>(message by IssueLinks)</sup></sub>\nAre you using the built in OAuth credentials or created your own?\n\nIf you created your own did you perform your own Authentication flow or use the one in home Assistant?\n\nTesla recently added that scope so the underlying python library doesn't support it yet.\nIm using whatever is builtin to this Integration to login to tesla (identical to how I login to my Tesla account in a web browser).  I didnt create anything on my own.  I simply pointed the integration to my home assistant instance URL (that's reachable from anywhere in the world) and, it installed the integration.  However, I had to subsequently reboot in order to see the sensors provided by `Status` in the screenshot I provided above.\r\n\r\nLet me know if there is anything else I can provide.", "created_at": "2024-12-05T07:33:33Z"}
{"repo": "home-assistant/core", "pull_number": 132287, "instance_id": "home-assistant__core-132287", "issue_numbers": ["127366"], "base_commit": "1e075cdac757115db8b2d0ae0444ea4a39112eca", "patch": "diff --git a/homeassistant/components/honeywell/__init__.py b/homeassistant/components/honeywell/__init__.py\nindex a8ee5975914c6..eb89ba2a6817d 100644\n--- a/homeassistant/components/honeywell/__init__.py\n+++ b/homeassistant/components/honeywell/__init__.py\n@@ -22,7 +22,7 @@\n )\n \n UPDATE_LOOP_SLEEP_TIME = 5\n-PLATFORMS = [Platform.CLIMATE, Platform.SENSOR, Platform.SWITCH]\n+PLATFORMS = [Platform.CLIMATE, Platform.HUMIDIFIER, Platform.SENSOR, Platform.SWITCH]\n \n MIGRATE_OPTIONS_KEYS = {CONF_COOL_AWAY_TEMPERATURE, CONF_HEAT_AWAY_TEMPERATURE}\n \ndiff --git a/homeassistant/components/honeywell/humidifier.py b/homeassistant/components/honeywell/humidifier.py\nnew file mode 100644\nindex 0000000000000..e94ba465c3028\n--- /dev/null\n+++ b/homeassistant/components/honeywell/humidifier.py\n@@ -0,0 +1,136 @@\n+\"\"\"Support for Honeywell (de)humidifiers.\"\"\"\n+\n+from __future__ import annotations\n+\n+from collections.abc import Callable\n+from dataclasses import dataclass\n+from typing import Any\n+\n+from aiosomecomfort.device import Device\n+\n+from homeassistant.components.humidifier import (\n+    HumidifierDeviceClass,\n+    HumidifierEntity,\n+    HumidifierEntityDescription,\n+)\n+from homeassistant.core import HomeAssistant\n+from homeassistant.helpers.device_registry import DeviceInfo\n+from homeassistant.helpers.entity_platform import AddEntitiesCallback\n+\n+from . import HoneywellConfigEntry\n+from .const import DOMAIN\n+\n+HUMIDIFIER_KEY = \"humidifier\"\n+DEHUMIDIFIER_KEY = \"dehumidifier\"\n+\n+\n+@dataclass(frozen=True, kw_only=True)\n+class HoneywellHumidifierEntityDescription(HumidifierEntityDescription):\n+    \"\"\"Describes a Honeywell humidifier entity.\"\"\"\n+\n+    current_humidity: Callable[[Device], Any]\n+    current_set_humidity: Callable[[Device], Any]\n+    max_humidity: Callable[[Device], Any]\n+    min_humidity: Callable[[Device], Any]\n+    set_humidity: Callable[[Device, Any], Any]\n+    mode: Callable[[Device], Any]\n+    off: Callable[[Device], Any]\n+    on: Callable[[Device], Any]\n+\n+\n+HUMIDIFIERS: dict[str, HoneywellHumidifierEntityDescription] = {\n+    \"Humidifier\": HoneywellHumidifierEntityDescription(\n+        key=HUMIDIFIER_KEY,\n+        translation_key=HUMIDIFIER_KEY,\n+        current_humidity=lambda device: device.current_humidity,\n+        set_humidity=lambda device, humidity: device.set_humidifier_setpoint(humidity),\n+        min_humidity=lambda device: device.humidifier_lower_limit,\n+        max_humidity=lambda device: device.humidifier_upper_limit,\n+        current_set_humidity=lambda device: device.humidifier_setpoint,\n+        mode=lambda device: device.humidifier_mode,\n+        off=lambda device: device.set_humidifier_off(),\n+        on=lambda device: device.set_humidifier_auto(),\n+        device_class=HumidifierDeviceClass.HUMIDIFIER,\n+    ),\n+    \"Dehumidifier\": HoneywellHumidifierEntityDescription(\n+        key=DEHUMIDIFIER_KEY,\n+        translation_key=DEHUMIDIFIER_KEY,\n+        current_humidity=lambda device: device.current_humidity,\n+        set_humidity=lambda device, humidity: device.set_dehumidifier_setpoint(\n+            humidity\n+        ),\n+        min_humidity=lambda device: device.dehumidifier_lower_limit,\n+        max_humidity=lambda device: device.dehumidifier_upper_limit,\n+        current_set_humidity=lambda device: device.dehumidifier_setpoint,\n+        mode=lambda device: device.dehumidifier_mode,\n+        off=lambda device: device.set_dehumidifier_off(),\n+        on=lambda device: device.set_dehumidifier_auto(),\n+        device_class=HumidifierDeviceClass.DEHUMIDIFIER,\n+    ),\n+}\n+\n+\n+async def async_setup_entry(\n+    hass: HomeAssistant,\n+    config_entry: HoneywellConfigEntry,\n+    async_add_entities: AddEntitiesCallback,\n+) -> None:\n+    \"\"\"Set up Honeywell (de)humidifier dynamically.\"\"\"\n+    data = config_entry.runtime_data\n+    entities: list = []\n+    for device in data.devices.values():\n+        if device.has_humidifier:\n+            entities.append(HoneywellHumidifier(device, HUMIDIFIERS[\"Humidifier\"]))\n+        if device.has_dehumidifier:\n+            entities.append(HoneywellHumidifier(device, HUMIDIFIERS[\"Dehumidifier\"]))\n+\n+    async_add_entities(entities)\n+\n+\n+class HoneywellHumidifier(HumidifierEntity):\n+    \"\"\"Representation of a Honeywell US (De)Humidifier.\"\"\"\n+\n+    entity_description: HoneywellHumidifierEntityDescription\n+    _attr_has_entity_name = True\n+\n+    def __init__(\n+        self, device: Device, description: HoneywellHumidifierEntityDescription\n+    ) -> None:\n+        \"\"\"Initialize the (De)Humidifier.\"\"\"\n+        self._device = device\n+        self.entity_description = description\n+        self._attr_unique_id = f\"{device.deviceid}_{description.key}\"\n+        self._attr_min_humidity = description.min_humidity(device)\n+        self._attr_max_humidity = description.max_humidity(device)\n+        self._attr_device_info = DeviceInfo(\n+            identifiers={(DOMAIN, device.deviceid)},\n+            name=device.name,\n+            manufacturer=\"Honeywell\",\n+        )\n+\n+    @property\n+    def is_on(self) -> bool:\n+        \"\"\"Return the device is on or off.\"\"\"\n+        return self.entity_description.mode(self._device) != 0\n+\n+    @property\n+    def target_humidity(self) -> int | None:\n+        \"\"\"Return the humidity we try to reach.\"\"\"\n+        return self.entity_description.current_set_humidity(self._device)\n+\n+    @property\n+    def current_humidity(self) -> int | None:\n+        \"\"\"Return the current humidity.\"\"\"\n+        return self.entity_description.current_humidity(self._device)\n+\n+    async def async_turn_on(self, **kwargs: Any) -> None:\n+        \"\"\"Turn the device on.\"\"\"\n+        await self.entity_description.on(self._device)\n+\n+    async def async_turn_off(self, **kwargs: Any) -> None:\n+        \"\"\"Turn the device off.\"\"\"\n+        await self.entity_description.off(self._device)\n+\n+    async def async_set_humidity(self, humidity: int) -> None:\n+        \"\"\"Set new target humidity.\"\"\"\n+        await self.entity_description.set_humidity(self._device, humidity)\ndiff --git a/homeassistant/components/honeywell/strings.json b/homeassistant/components/honeywell/strings.json\nindex a64f1a6fce06a..2538e7101a1b3 100644\n--- a/homeassistant/components/honeywell/strings.json\n+++ b/homeassistant/components/honeywell/strings.json\n@@ -61,6 +61,14 @@\n           }\n         }\n       }\n+    },\n+    \"humidifier\": {\n+      \"humidifier\": {\n+        \"name\": \"[%key:component::humidifier::title%]\"\n+      },\n+      \"dehumidifier\": {\n+        \"name\": \"[%key:component::humidifier::entity_component::dehumidifier::name%]\"\n+      }\n     }\n   },\n   \"exceptions\": {\n", "test_patch": "diff --git a/tests/components/honeywell/__init__.py b/tests/components/honeywell/__init__.py\nindex 98fcaa551bfd5..94022667e0ea8 100644\n--- a/tests/components/honeywell/__init__.py\n+++ b/tests/components/honeywell/__init__.py\n@@ -1,4 +1,4 @@\n-\"\"\"Tests for honeywell component.\"\"\"\n+\"\"\"Tests for Honeywell component.\"\"\"\n \n from unittest.mock import MagicMock\n \ndiff --git a/tests/components/honeywell/conftest.py b/tests/components/honeywell/conftest.py\nindex e48664db9aef0..dd3341aa75c95 100644\n--- a/tests/components/honeywell/conftest.py\n+++ b/tests/components/honeywell/conftest.py\n@@ -127,7 +127,16 @@ def device():\n     mock_device.refresh = AsyncMock()\n     mock_device.heat_away_temp = HEATAWAY\n     mock_device.cool_away_temp = COOLAWAY\n-\n+    mock_device.has_humidifier = False\n+    mock_device.has_dehumidifier = False\n+    mock_device.humidifier_upper_limit = 60\n+    mock_device.humidifier_lower_limit = 10\n+    mock_device.humidifier_setpoint = 20\n+    mock_device.dehumidifier_mode = 1\n+    mock_device.dehumidifier_upper_limit = 55\n+    mock_device.dehumidifier_lower_limit = 15\n+    mock_device.dehumidifier_setpoint = 30\n+    mock_device.dehumidifier_mode = 1\n     mock_device.raw_dr_data = {\"CoolSetpLimit\": None, \"HeatSetpLimit\": None}\n \n     return mock_device\n@@ -149,6 +158,8 @@ def device_with_outdoor_sensor():\n     mock_device.temperature_unit = \"C\"\n     mock_device.outdoor_temperature = OUTDOORTEMP\n     mock_device.outdoor_humidity = OUTDOORHUMIDITY\n+    mock_device.has_humidifier = False\n+    mock_device.has_dehumidifier = False\n     mock_device.raw_ui_data = {\n         \"SwitchOffAllowed\": True,\n         \"SwitchAutoAllowed\": True,\n@@ -188,6 +199,16 @@ def another_device():\n     mock_device.mac_address = \"macaddress1\"\n     mock_device.outdoor_temperature = None\n     mock_device.outdoor_humidity = None\n+    mock_device.has_humidifier = False\n+    mock_device.has_dehumidifier = False\n+    mock_device.humidifier_upper_limit = 60\n+    mock_device.humidifier_lower_limit = 10\n+    mock_device.humidifier_setpoint = 20\n+    mock_device.dehumidifier_mode = 1\n+    mock_device.dehumidifier_upper_limit = 55\n+    mock_device.dehumidifier_lower_limit = 15\n+    mock_device.dehumidifier_setpoint = 30\n+    mock_device.dehumidifier_mode = 1\n     mock_device.raw_ui_data = {\n         \"SwitchOffAllowed\": True,\n         \"SwitchAutoAllowed\": True,\ndiff --git a/tests/components/honeywell/snapshots/test_humidity.ambr b/tests/components/honeywell/snapshots/test_humidity.ambr\nnew file mode 100644\nindex 0000000000000..369167b8c1ea2\n--- /dev/null\n+++ b/tests/components/honeywell/snapshots/test_humidity.ambr\n@@ -0,0 +1,39 @@\n+# serializer version: 1\n+# name: test_static_attributes[dehumidifier]\n+  StateSnapshot({\n+    'attributes': ReadOnlyDict({\n+      'current_humidity': 50,\n+      'device_class': 'dehumidifier',\n+      'friendly_name': 'device1 Dehumidifier',\n+      'humidity': 30,\n+      'max_humidity': 55,\n+      'min_humidity': 15,\n+      'supported_features': <HumidifierEntityFeature: 0>,\n+    }),\n+    'context': <ANY>,\n+    'entity_id': 'humidifier.device1_dehumidifier',\n+    'last_changed': <ANY>,\n+    'last_reported': <ANY>,\n+    'last_updated': <ANY>,\n+    'state': 'on',\n+  })\n+# ---\n+# name: test_static_attributes[humidifier]\n+  StateSnapshot({\n+    'attributes': ReadOnlyDict({\n+      'current_humidity': 50,\n+      'device_class': 'humidifier',\n+      'friendly_name': 'device1 Humidifier',\n+      'humidity': 20,\n+      'max_humidity': 60,\n+      'min_humidity': 10,\n+      'supported_features': <HumidifierEntityFeature: 0>,\n+    }),\n+    'context': <ANY>,\n+    'entity_id': 'humidifier.device1_humidifier',\n+    'last_changed': <ANY>,\n+    'last_reported': <ANY>,\n+    'last_updated': <ANY>,\n+    'state': 'on',\n+  })\n+# ---\ndiff --git a/tests/components/honeywell/test_climate.py b/tests/components/honeywell/test_climate.py\nindex 73c5ff33dbcaf..57cdfaa9a23ee 100644\n--- a/tests/components/honeywell/test_climate.py\n+++ b/tests/components/honeywell/test_climate.py\n@@ -1,4 +1,4 @@\n-\"\"\"Test the Whirlpool Sixth Sense climate domain.\"\"\"\n+\"\"\"Test the Honeywell climate domain.\"\"\"\n \n import datetime\n from unittest.mock import MagicMock\ndiff --git a/tests/components/honeywell/test_humidity.py b/tests/components/honeywell/test_humidity.py\nnew file mode 100644\nindex 0000000000000..2e1f8cec6aa20\n--- /dev/null\n+++ b/tests/components/honeywell/test_humidity.py\n@@ -0,0 +1,110 @@\n+\"\"\"Test the Honeywell humidity domain.\"\"\"\n+\n+from unittest.mock import MagicMock\n+\n+from syrupy.assertion import SnapshotAssertion\n+\n+from homeassistant.components.humidifier import (\n+    ATTR_HUMIDITY,\n+    DOMAIN as HUMIDIFIER_DOMAIN,\n+    SERVICE_SET_HUMIDITY,\n+)\n+from homeassistant.const import ATTR_ENTITY_ID, SERVICE_TURN_OFF, SERVICE_TURN_ON\n+from homeassistant.core import HomeAssistant\n+from homeassistant.helpers import entity_registry as er\n+\n+from . import init_integration\n+\n+\n+async def test_humidifier_service_calls(\n+    hass: HomeAssistant, device: MagicMock, config_entry: MagicMock\n+) -> None:\n+    \"\"\"Test the setup of the climate entities when there are no additional options available.\"\"\"\n+    device.has_humidifier = True\n+    await init_integration(hass, config_entry)\n+    entity_id = f\"humidifier.{device.name}_humidifier\"\n+    assert hass.states.get(f\"humidifier.{device.name}_dehumidifier\") is None\n+\n+    await hass.services.async_call(\n+        HUMIDIFIER_DOMAIN,\n+        SERVICE_TURN_ON,\n+        {ATTR_ENTITY_ID: entity_id},\n+        blocking=True,\n+    )\n+    device.set_humidifier_auto.assert_called_once()\n+\n+    await hass.services.async_call(\n+        HUMIDIFIER_DOMAIN,\n+        SERVICE_TURN_OFF,\n+        {ATTR_ENTITY_ID: entity_id},\n+        blocking=True,\n+    )\n+    device.set_humidifier_off.assert_called_once()\n+\n+    await hass.services.async_call(\n+        HUMIDIFIER_DOMAIN,\n+        SERVICE_SET_HUMIDITY,\n+        {ATTR_ENTITY_ID: entity_id, ATTR_HUMIDITY: 40},\n+        blocking=True,\n+    )\n+    device.set_humidifier_setpoint.assert_called_once_with(40)\n+\n+\n+async def test_dehumidifier_service_calls(\n+    hass: HomeAssistant, device: MagicMock, config_entry: MagicMock\n+) -> None:\n+    \"\"\"Test the setup of the climate entities when there are no additional options available.\"\"\"\n+    device.has_dehumidifier = True\n+    await init_integration(hass, config_entry)\n+    entity_id = f\"humidifier.{device.name}_dehumidifier\"\n+    assert hass.states.get(f\"humidifier.{device.name}_humidifier\") is None\n+\n+    await hass.services.async_call(\n+        HUMIDIFIER_DOMAIN,\n+        SERVICE_TURN_ON,\n+        {ATTR_ENTITY_ID: entity_id},\n+        blocking=True,\n+    )\n+    device.set_dehumidifier_auto.assert_called_once()\n+\n+    await hass.services.async_call(\n+        HUMIDIFIER_DOMAIN,\n+        SERVICE_TURN_OFF,\n+        {ATTR_ENTITY_ID: entity_id},\n+        blocking=True,\n+    )\n+    device.set_dehumidifier_off.assert_called_once()\n+\n+    await hass.services.async_call(\n+        HUMIDIFIER_DOMAIN,\n+        SERVICE_SET_HUMIDITY,\n+        {ATTR_ENTITY_ID: entity_id, ATTR_HUMIDITY: 40},\n+        blocking=True,\n+    )\n+    device.set_dehumidifier_setpoint.assert_called_once_with(40)\n+\n+\n+async def test_static_attributes(\n+    hass: HomeAssistant,\n+    entity_registry: er.EntityRegistry,\n+    device: MagicMock,\n+    config_entry: MagicMock,\n+    snapshot: SnapshotAssertion,\n+) -> None:\n+    \"\"\"Test static humidifier attributes.\"\"\"\n+    device.has_dehumidifier = True\n+    device.has_humidifier = True\n+    await init_integration(hass, config_entry)\n+\n+    entity_id_dehumidifier = f\"humidifier.{device.name}_dehumidifier\"\n+    entity_id_humidifier = f\"humidifier.{device.name}_humidifier\"\n+    entry = entity_registry.async_get(entity_id_dehumidifier)\n+    assert entry\n+\n+    state = hass.states.get(entity_id_dehumidifier)\n+\n+    assert state == snapshot(name=\"dehumidifier\")\n+\n+    state = hass.states.get(entity_id_humidifier)\n+\n+    assert state == snapshot(name=\"humidifier\")\n", "problem_statement": "No humidity control?\n### The problem\n\nI have a humidifier hooked up to the Honeywell prestige thermostat (YTHX9421R5101WW) but it doesn't allow me to control the humidifier. Is this not included in this integration? Thanks. \n\n### What version of Home Assistant Core has the issue?\n\n2024.10.0\n\n### What was the last working version of Home Assistant Core?\n\n_No response_\n\n### What type of installation are you running?\n\nHome Assistant OS\n\n### Integration causing the issue\n\nHoneywell Total Connect Comfort (US)\n\n### Link to integration documentation on our website\n\nhttps://www.home-assistant.io/integrations/honeywell/\n\n### Diagnostics information\n\n_No response_\n\n### Example YAML snippet\n\n_No response_\n\n### Anything in the logs that might be useful for us?\n\n_No response_\n\n### Additional information\n\n_No response_\n", "hints_text": "\nHey there @rdfurman, @mkmer, mind taking a look at this issue as it has been labeled with an integration (`honeywell`) you are listed as a [code owner](https://github.com/home-assistant/core/blob/dev/CODEOWNERS#L642) for? Thanks!\n\n<details>\n<summary>Code owner commands</summary>\n\n\nCode owners of `honeywell` can trigger bot actions by commenting:\n\n- `@home-assistant close` Closes the issue.\n- `@home-assistant rename Awesome new title` Renames the issue.\n- `@home-assistant reopen` Reopen the issue.\n- `@home-assistant unassign honeywell` Removes the current integration label and assignees on the issue, add the integration domain after the command.\n- `@home-assistant add-label needs-more-information` Add a label (needs-more-information, problem in dependency, problem in custom component) to the issue.\n- `@home-assistant remove-label needs-more-information` Remove a label (needs-more-information, problem in dependency, problem in custom component) on the issue.\n\n</details>\n\n\n<sub><sup>(message by CodeOwnersMention)</sup></sub>\n\n---\n\n[honeywell documentation](https://www.home-assistant.io/integrations/honeywell)\n[honeywell source](https://github.com/home-assistant/core/tree/dev/homeassistant/components/honeywell)\n<sub><sup>(message by IssueLinks)</sup></sub>\nI have the same issue. Would like to be able to turn the humidifier off during peak hours for electricity. Thanks!\nI would also like to be able to control the Humidity on a th8321wf1001 thermostat.  Both the app and the website portal allow this to be viewed and changed as shown in the picture attached.\r\n\r\nthanks\r\n\r\n<img width=\"708\" alt=\"Humidity\" src=\"https://github.com/user-attachments/assets/2e845487-10d8-4f03-9b7c-a783e0fd7de6\">\r\n\nMy thermostat does not have this feature - I will need some endpoint details sniffed out from the browser.  If you can provide the message being sent when  you make the changes (via the browser developers debug screens) we can try to add this. \n> My thermostat does not have this feature - I will need some endpoint details sniffed out from the browser. If you can provide the message being sent when you make the changes (via the browser developers debug screens) we can try to add this.\r\n\r\nCan you show me what you need? I can grab those. Do I grab the info from the \"element\" screen of the developer tool? Thanks\nIn firefox -> view the web page in question, `ctrl->shft -> i` will bring up the developer pane.  \r\nSelect the network tab\r\nset your humidity and submit it (I assume submit is like the thermostat interface).\r\nYou should see a POST message in the pane.  Select the message, right side of pane will show details.  Select the Response and Reqeust tabs sharing the JSON values .  Also share the host/filename info found on the Headers tab.\r\nYou may want to xxx the `deviceid` if it's in the request/response messages.\r\n \r\nShould look something like:\r\nJSON:\r\n`{\"DeviceID\":xxxxxx,\"SystemSwitch\":null,\"HeatSetpoint\":67,\"CoolSetpoint\":null,\"HeatNextPeriod\":null,\"CoolNextPeriod\":null,\"StatusHeat\":1,\"StatusCool\":1,\"FanMode\":null}`\r\n\r\nHeaders something like this:\r\n```\r\nscheme\r\n\thttps\r\nhost\r\n\twww.mytotalconnectcomfort.com\r\nfilename\r\n\t/portal/Device/SubmitControlScreenChanges\r\n```\r\n\n> In firefox -> view the web page in question, `ctrl->shft -> i` will bring up the developer pane. Select the network tab set your humidity and submit it (I assume submit is like the thermostat interface). You should see a POST message in the pane. Select the message, right side of pane will show details. Select the Response and Reqeust tabs sharing the JSON values . Also share the host/filename info found on the Headers tab. You may want to xxx the `deviceid` if it's in the request/response messages.\r\n> \r\n> Should look something like: JSON: `{\"DeviceID\":xxxxxx,\"SystemSwitch\":null,\"HeatSetpoint\":67,\"CoolSetpoint\":null,\"HeatNextPeriod\":null,\"CoolNextPeriod\":null,\"StatusHeat\":1,\"StatusCool\":1,\"FanMode\":null}`\r\n> \r\n> Headers something like this:\r\n> \r\n> ```\r\n> scheme\r\n> \thttps\r\n> host\r\n> \twww.mytotalconnectcomfort.com\r\n> filename\r\n> \t/portal/Device/SubmitControlScreenChanges\r\n> ```\r\n\r\nHumidifier Request (This POST file popped up after I submitted the request to change humidity)  \r\nRequest:\r\n{\"Mode\":1,\"LowerLimit\":10,\"UpperLimit\":60,\"Setpoint\":45,\"DeadBand\":null,\"DeviceId\":xxxxx,\"IndoorHumidity\":48,\"IndoorHumidityAvailable\":true,\"IndoorHumidityValue\":\"48%\",\"SetpointValue\":\"45%\"}\r\nResponse: Nothing\r\n\r\nPOST /portal/Device/Menu/Humidifier HTTP/2\r\nHost: mytotalconnectcomfort.com\r\n\r\nHumidifier Confirmation ( This POST file popped up a few seconds after I hit the submit button, confirming the humidity change) \r\nRequest: Nothing\r\nResponse: {\"DeviceId\":xxx,\"UpperLimit\":60,\"LowerLimit\":10,\"Deadband\":null,\"Mode\":1,\"Setpoint\":45,\"IndoorHumidityAvailable\":false,\"IndoorHumidity\":0}\r\n\r\nPOST /portal/Device/Menu/Humidifier HTTP/2\r\nHost: mytotalconnectcomfort.com\r\n\nOff/Auto - please share the messages when these are set as well.\n> Off/Auto - please share the messages when these are set as well.\r\n\r\nOff:\r\nRequest:\r\n{\"Mode\":0,\"LowerLimit\":10,\"UpperLimit\":60,\"Setpoint\":50,\"DeadBand\":null,\"DeviceId\":xxxx,\"IndoorHumidity\":49,\"IndoorHumidityAvailable\":true,\"IndoorHumidityValue\":\"49%\",\"SetpointValue\":\"50%\"}\r\n\r\nResponse:\r\n{\"DeviceId\":xxxx,\"UpperLimit\":60,\"LowerLimit\":10,\"Deadband\":null,\"Mode\":0,\"Setpoint\":50,\"IndoorHumidityAvailable\":false,\"IndoorHumidity\":0}\r\n\r\n\r\nAuto:\r\nRequest:\r\n{\"Mode\":1,\"LowerLimit\":10,\"UpperLimit\":60,\"Setpoint\":50,\"DeadBand\":null,\"DeviceId\":xxxx,\"IndoorHumidity\":49,\"IndoorHumidityAvailable\":true,\"IndoorHumidityValue\":\"49%\",\"SetpointValue\":\"50%\"}\r\n\r\nResponse:\r\n{\"DeviceId\":xxxxxx,\"UpperLimit\":60,\"LowerLimit\":10,\"Deadband\":null,\"Mode\":1,\"Setpoint\":50,\"IndoorHumidityAvailable\":false,\"IndoorHumidity\":0}\nPlease open an issue here: \r\nhttps://github.com/mkmer/AIOSomecomfort/issues\r\n\r\nThis will help me document the changes to the API and ask your further questions outside of HA.  \r\nSince this type of \"question\" is a feature request, the HA issue will probably be closed at some point.\r\nPlease attach the discovered information above, and also observe the web page in developer mode and share any GET messages generated.  \r\nSomething is looking a bit fishy with the Response data - `IndorHumidityAvailable: false` yet the request has it set.  \r\nThanks", "created_at": "2024-12-04T18:20:17Z"}
{"repo": "home-assistant/core", "pull_number": 132262, "instance_id": "home-assistant__core-132262", "issue_numbers": ["125526"], "base_commit": "a417d3dcf8983b6de42d0ec74743a441c8c670eb", "patch": "diff --git a/homeassistant/components/starlink/coordinator.py b/homeassistant/components/starlink/coordinator.py\nindex a891941fb8e7ea..81ee56db3b4452 100644\n--- a/homeassistant/components/starlink/coordinator.py\n+++ b/homeassistant/components/starlink/coordinator.py\n@@ -14,8 +14,10 @@\n     GrpcError,\n     LocationDict,\n     ObstructionDict,\n+    PowerDict,\n     StatusDict,\n     get_sleep_config,\n+    history_stats,\n     location_data,\n     reboot,\n     set_sleep_config,\n@@ -39,6 +41,7 @@ class StarlinkData:\n     status: StatusDict\n     obstruction: ObstructionDict\n     alert: AlertDict\n+    consumption: PowerDict\n \n \n class StarlinkUpdateCoordinator(DataUpdateCoordinator[StarlinkData]):\n@@ -58,10 +61,11 @@ def __init__(self, hass: HomeAssistant, name: str, url: str) -> None:\n     def _get_starlink_data(self) -> StarlinkData:\n         \"\"\"Retrieve Starlink data.\"\"\"\n         channel_context = self.channel_context\n-        status = status_data(channel_context)\n         location = location_data(channel_context)\n         sleep = get_sleep_config(channel_context)\n-        return StarlinkData(location, sleep, *status)\n+        status, obstruction, alert = status_data(channel_context)\n+        statistics = history_stats(parse_samples=-1, context=channel_context)\n+        return StarlinkData(location, sleep, status, obstruction, alert, statistics[-1])\n \n     async def _async_update_data(self) -> StarlinkData:\n         async with asyncio.timeout(4):\ndiff --git a/homeassistant/components/starlink/sensor.py b/homeassistant/components/starlink/sensor.py\nindex 21f2400022cacb..4b33a7f433720c 100644\n--- a/homeassistant/components/starlink/sensor.py\n+++ b/homeassistant/components/starlink/sensor.py\n@@ -18,6 +18,8 @@\n     PERCENTAGE,\n     EntityCategory,\n     UnitOfDataRate,\n+    UnitOfEnergy,\n+    UnitOfPower,\n     UnitOfTime,\n )\n from homeassistant.core import HomeAssistant\n@@ -120,4 +122,18 @@ def native_value(self) -> StateType | datetime:\n         native_unit_of_measurement=PERCENTAGE,\n         value_fn=lambda data: data.status[\"pop_ping_drop_rate\"] * 100,\n     ),\n+    StarlinkSensorEntityDescription(\n+        key=\"power\",\n+        device_class=SensorDeviceClass.POWER,\n+        state_class=SensorStateClass.MEASUREMENT,\n+        native_unit_of_measurement=UnitOfPower.WATT,\n+        value_fn=lambda data: data.consumption[\"latest_power\"],\n+    ),\n+    StarlinkSensorEntityDescription(\n+        key=\"energy\",\n+        device_class=SensorDeviceClass.ENERGY,\n+        state_class=SensorStateClass.TOTAL_INCREASING,\n+        native_unit_of_measurement=UnitOfEnergy.KILO_WATT_HOUR,\n+        value_fn=lambda data: data.consumption[\"total_energy\"],\n+    ),\n )\n", "test_patch": "diff --git a/tests/components/starlink/fixtures/history_stats_success.json b/tests/components/starlink/fixtures/history_stats_success.json\nnew file mode 100644\nindex 00000000000000..5a228dd34af370\n--- /dev/null\n+++ b/tests/components/starlink/fixtures/history_stats_success.json\n@@ -0,0 +1,112 @@\n+[\n+  {\n+    \"samples\": 900,\n+    \"end_counter\": 119395\n+  },\n+  {\n+    \"total_ping_drop\": 2.4592087380588055,\n+    \"count_full_ping_drop\": 0,\n+    \"count_obstructed\": 0,\n+    \"total_obstructed_ping_drop\": 0,\n+    \"count_full_obstructed_ping_drop\": 0,\n+    \"count_unscheduled\": 0,\n+    \"total_unscheduled_ping_drop\": 0,\n+    \"count_full_unscheduled_ping_drop\": 0\n+  },\n+  {\n+    \"init_run_fragment\": 0,\n+    \"final_run_fragment\": 0,\n+    \"run_seconds[1,]\": [\n+      0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,\n+      0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,\n+      0, 0, 0, 0, 0, 0, 0, 0, 0, 0\n+    ],\n+    \"run_minutes[1,]\": [\n+      0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,\n+      0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,\n+      0, 0, 0, 0, 0, 0, 0, 0, 0, 0\n+    ]\n+  },\n+  {\n+    \"mean_all_ping_latency\": 31.55747121333472,\n+    \"deciles_all_ping_latency[]\": [\n+      21.005102157592773, 22.67989158630371, 25.310760498046875,\n+      26.85667610168457, 27.947458267211914, 29.192155838012695,\n+      31.26323890686035, 34.226768493652344, 38.54373550415039,\n+      42.308048248291016, 60.11151885986328\n+    ],\n+    \"mean_full_ping_latency\": 31.526783029284427,\n+    \"deciles_full_ping_latency[]\": [\n+      21.070240020751953, 22.841461181640625, 25.34041976928711,\n+      26.908039093017578, 27.947458267211914, 29.135879516601562,\n+      31.122955322265625, 34.1280403137207, 38.49388122558594,\n+      42.308048248291016, 60.11151885986328\n+    ],\n+    \"stdev_full_ping_latency\": 7.8141330200011785\n+  },\n+  {\n+    \"load_bucket_samples[]\": [738, 24, 39, 55, 7, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],\n+    \"load_bucket_min_latency[]\": [\n+      21.070240020751953,\n+      21.35713768005371,\n+      21.156545639038086,\n+      24.763751983642578,\n+      24.7109317779541,\n+      null,\n+      null,\n+      null,\n+      null,\n+      null,\n+      null,\n+      null,\n+      null,\n+      null,\n+      null\n+    ],\n+    \"load_bucket_median_latency[]\": [\n+      29.2450590133667,\n+      27.031108856201172,\n+      25.726211547851562,\n+      31.845806121826172,\n+      28.919479370117188,\n+      null,\n+      null,\n+      null,\n+      null,\n+      null,\n+      null,\n+      null,\n+      null,\n+      null,\n+      null\n+    ],\n+    \"load_bucket_max_latency[]\": [\n+      60.11151885986328,\n+      40.572628021240234,\n+      48.063961029052734,\n+      53.505126953125,\n+      38.7435302734375,\n+      null,\n+      null,\n+      null,\n+      null,\n+      null,\n+      null,\n+      null,\n+      null,\n+      null,\n+      null\n+    ]\n+  },\n+  {\n+    \"download_usage\": 72504227,\n+    \"upload_usage\": 5719755\n+  },\n+  {\n+    \"latest_power\": 27.54502296447754,\n+    \"mean_power\": 31.449254739549424,\n+    \"min_power\": 21.826229095458984,\n+    \"max_power\": 41.71160888671875,\n+    \"total_energy\": 0.007862313684887356\n+  }\n+]\ndiff --git a/tests/components/starlink/patchers.py b/tests/components/starlink/patchers.py\nindex f8179f07bedf8f..08e82548ef84aa 100644\n--- a/tests/components/starlink/patchers.py\n+++ b/tests/components/starlink/patchers.py\n@@ -24,6 +24,11 @@\n     return_value=json.loads(load_fixture(\"sleep_data_success.json\", \"starlink\")),\n )\n \n+HISTORY_STATS_SUCCESS_PATCHER = patch(\n+    \"homeassistant.components.starlink.coordinator.history_stats\",\n+    return_value=json.loads(load_fixture(\"history_stats_success.json\", \"starlink\")),\n+)\n+\n DEVICE_FOUND_PATCHER = patch(\n     \"homeassistant.components.starlink.config_flow.get_id\", return_value=\"some-valid-id\"\n )\ndiff --git a/tests/components/starlink/snapshots/test_diagnostics.ambr b/tests/components/starlink/snapshots/test_diagnostics.ambr\nindex 4c85ad84ca762b..c0b1b93085b1ca 100644\n--- a/tests/components/starlink/snapshots/test_diagnostics.ambr\n+++ b/tests/components/starlink/snapshots/test_diagnostics.ambr\n@@ -16,6 +16,13 @@\n       'alert_thermal_throttle': False,\n       'alert_unexpected_location': False,\n     }),\n+    'consumption': dict({\n+      'latest_power': 27.54502296447754,\n+      'max_power': 41.71160888671875,\n+      'mean_power': 31.449254739549424,\n+      'min_power': 21.826229095458984,\n+      'total_energy': 0.007862313684887356,\n+    }),\n     'location': dict({\n       'altitude': '**REDACTED**',\n       'latitude': '**REDACTED**',\ndiff --git a/tests/components/starlink/test_diagnostics.py b/tests/components/starlink/test_diagnostics.py\nindex c5876e5e9f2cd8..cd36dd0367e05f 100644\n--- a/tests/components/starlink/test_diagnostics.py\n+++ b/tests/components/starlink/test_diagnostics.py\n@@ -7,6 +7,7 @@\n from homeassistant.core import HomeAssistant\n \n from .patchers import (\n+    HISTORY_STATS_SUCCESS_PATCHER,\n     LOCATION_DATA_SUCCESS_PATCHER,\n     SLEEP_DATA_SUCCESS_PATCHER,\n     STATUS_DATA_SUCCESS_PATCHER,\n@@ -32,6 +33,7 @@ async def test_diagnostics(\n         STATUS_DATA_SUCCESS_PATCHER,\n         LOCATION_DATA_SUCCESS_PATCHER,\n         SLEEP_DATA_SUCCESS_PATCHER,\n+        HISTORY_STATS_SUCCESS_PATCHER,\n     ):\n         entry.add_to_hass(hass)\n \ndiff --git a/tests/components/starlink/test_init.py b/tests/components/starlink/test_init.py\nindex 62a1ee41236812..7e04c21562ab95 100644\n--- a/tests/components/starlink/test_init.py\n+++ b/tests/components/starlink/test_init.py\n@@ -6,6 +6,7 @@\n from homeassistant.core import HomeAssistant\n \n from .patchers import (\n+    HISTORY_STATS_SUCCESS_PATCHER,\n     LOCATION_DATA_SUCCESS_PATCHER,\n     SLEEP_DATA_SUCCESS_PATCHER,\n     STATUS_DATA_SUCCESS_PATCHER,\n@@ -25,6 +26,7 @@ async def test_successful_entry(hass: HomeAssistant) -> None:\n         STATUS_DATA_SUCCESS_PATCHER,\n         LOCATION_DATA_SUCCESS_PATCHER,\n         SLEEP_DATA_SUCCESS_PATCHER,\n+        HISTORY_STATS_SUCCESS_PATCHER,\n     ):\n         entry.add_to_hass(hass)\n \n@@ -46,6 +48,7 @@ async def test_unload_entry(hass: HomeAssistant) -> None:\n         STATUS_DATA_SUCCESS_PATCHER,\n         LOCATION_DATA_SUCCESS_PATCHER,\n         SLEEP_DATA_SUCCESS_PATCHER,\n+        HISTORY_STATS_SUCCESS_PATCHER,\n     ):\n         entry.add_to_hass(hass)\n \n", "problem_statement": "Add momentary power usage and total power usage for starlink\n### The problem\n\nHey,\r\n\r\nThe Starlink grpc API seems to also provide power data that is not used in the home assistant integration yet. It would be great to have two new sensors one showing the current power draw in W as reported from the API and a second one showing the accumulated energy used in kWh, so it can be added to the energy dashboard.\r\n\r\nMore information is available here https://www.reddit.com/r/Starlink/s/J4jizZ2Ro3\n\n### What version of Home Assistant Core has the issue?\n\ncore-2024.9.1\n\n### What was the last working version of Home Assistant Core?\n\n_No response_\n\n### What type of installation are you running?\n\nHome Assistant OS\n\n### Integration causing the issue\n\nStarlink\n\n### Link to integration documentation on our website\n\nhttps://www.home-assistant.io/integrations/starlink/\n\n### Diagnostics information\n\n_No response_\n\n### Example YAML snippet\n\n_No response_\n\n### Anything in the logs that might be useful for us?\n\n_No response_\n\n### Additional information\n\n_No response_\n", "hints_text": "\nHey there @boswelja, mind taking a look at this issue as it has been labeled with an integration (`starlink`) you are listed as a [code owner](https://github.com/home-assistant/core/blob/dev/CODEOWNERS#L1393) for? Thanks!\n\n<details>\n<summary>Code owner commands</summary>\n\n\nCode owners of `starlink` can trigger bot actions by commenting:\n\n- `@home-assistant close` Closes the issue.\n- `@home-assistant rename Awesome new title` Renames the issue.\n- `@home-assistant reopen` Reopen the issue.\n- `@home-assistant unassign starlink` Removes the current integration label and assignees on the issue, add the integration domain after the command.\n- `@home-assistant add-label needs-more-information` Add a label (needs-more-information, problem in dependency, problem in custom component) to the issue.\n- `@home-assistant remove-label needs-more-information` Remove a label (needs-more-information, problem in dependency, problem in custom component) on the issue.\n\n</details>\n\n\n<sub><sup>(message by CodeOwnersMention)</sup></sub>\n\n---\n\n[starlink documentation](https://www.home-assistant.io/integrations/starlink)\n[starlink source](https://github.com/home-assistant/core/tree/dev/homeassistant/components/starlink)\n<sub><sup>(message by IssueLinks)</sup></sub>\nHey @boswelja ,\r\n\r\nThank you for your great work on this integration in your free time! I totally understand that this is voluntary work, that you do, when you got some time off and motivation to work on the project.\r\nDid you already have some time to check my request to give me some feedback?\r\nDo you need any additional information on this topic from me?\nI didn't, since I no longer have starlink I cannot verify the presence or functionality of new data.\n\nSeems like it'd be relatively easy to add though, since iirc power entities are just sensors with a type and we already have a sensor platform in the integration\nhttps://github.com/sparky8512/starlink-grpc-tools/issues/94\n\nstarlink-grpc-tools has been updated to support power stats.\n\nimport starlink_grpc\nprint(starlink_grpc.get_history().power_in)\n\nIt should be pretty simple to create new sensor based on this data. \nI'm interested in having this new sensor data into HA\n> I didn't, since I no longer have starlink I cannot verify the presence or functionality of new data.\r\n> \r\n> Seems like it'd be relatively easy to add though, since iirc power entities are just sensors with a type and we already have a sensor platform in the integration\r\n\r\nI have a starlink Gen3 (the flat dish without motor) and could test the new features for you!\nHi @boswelja, what about something like this https://github.com/home-assistant/core/compare/dev...davidrapan:ha-core:starlink-consumption?\n> Hi @boswelja, what about something like this https://github.com/home-assistant/core/compare/dev...davidrapan:ha-core:starlink-consumption?\n\nPlease open a pull request, which makes tracking changes and reviews significantly easier \ud83d\ude42", "created_at": "2024-12-04T12:37:51Z"}
{"repo": "home-assistant/core", "pull_number": 132251, "instance_id": "home-assistant__core-132251", "issue_numbers": ["132242"], "base_commit": "2ebc229d8d0058af67d1e1fd455e12f0f50c0af1", "patch": "diff --git a/homeassistant/components/fyta/quality_scale.yaml b/homeassistant/components/fyta/quality_scale.yaml\nindex 97f62f884e7d36..0fbacd0e12e9fa 100644\n--- a/homeassistant/components/fyta/quality_scale.yaml\n+++ b/homeassistant/components/fyta/quality_scale.yaml\n@@ -53,8 +53,8 @@ rules:\n     status: exempt\n     comment: No noisy entities.\n   discovery:\n-    status: exempt\n-    comment: bug in hassfest\n+    status: done\n+    comment: DHCP\n   stale-devices: done\n   diagnostics: done\n   exception-translations: done\ndiff --git a/homeassistant/components/powerfox/quality_scale.yaml b/homeassistant/components/powerfox/quality_scale.yaml\nindex 5a14264940fc06..7e104b894ca95b 100644\n--- a/homeassistant/components/powerfox/quality_scale.yaml\n+++ b/homeassistant/components/powerfox/quality_scale.yaml\n@@ -57,9 +57,9 @@ rules:\n     comment: |\n       This integration is connecting to a cloud service.\n   discovery:\n-    status: exempt\n+    status: done\n     comment: |\n-      It can find poweropti devices via zeroconf, but will start a normal user flow.\n+      It can find poweropti devices via zeroconf, and will start a normal user flow.\n   docs-data-update: done\n   docs-examples: todo\n   docs-known-limitations: done\ndiff --git a/script/hassfest/quality_scale_validation/discovery.py b/script/hassfest/quality_scale_validation/discovery.py\nindex a4f01ce0269f54..d24005b63739d8 100644\n--- a/script/hassfest/quality_scale_validation/discovery.py\n+++ b/script/hassfest/quality_scale_validation/discovery.py\n@@ -7,23 +7,32 @@\n \n from script.hassfest.model import Integration\n \n-DISCOVERY_FUNCTIONS = [\n-    \"async_step_discovery\",\n+MANIFEST_KEYS = [\n+    \"bluetooth\",\n+    \"dhcp\",\n+    \"homekit\",\n+    \"mqtt\",\n+    \"ssdp\",\n+    \"usb\",\n+    \"zeroconf\",\n+]\n+CONFIG_FLOW_STEPS = {\n     \"async_step_bluetooth\",\n+    \"async_step_discovery\",\n+    \"async_step_dhcp\",\n     \"async_step_hassio\",\n     \"async_step_homekit\",\n     \"async_step_mqtt\",\n     \"async_step_ssdp\",\n-    \"async_step_zeroconf\",\n-    \"async_step_dhcp\",\n     \"async_step_usb\",\n-]\n+    \"async_step_zeroconf\",\n+}\n \n \n def _has_discovery_function(module: ast.Module) -> bool:\n     \"\"\"Test if the module defines at least one of the discovery functions.\"\"\"\n     return any(\n-        type(item) is ast.AsyncFunctionDef and item.name in DISCOVERY_FUNCTIONS\n+        type(item) is ast.AsyncFunctionDef and item.name in CONFIG_FLOW_STEPS\n         for item in ast.walk(module)\n     )\n \n@@ -35,11 +44,15 @@ def validate(integration: Integration) -> list[str] | None:\n     if not config_flow_file.exists():\n         return [\"Integration is missing config_flow.py\"]\n \n-    config_flow = ast.parse(config_flow_file.read_text())\n+    # Check manifest\n+    if any(key in integration.manifest for key in MANIFEST_KEYS):\n+        return None\n \n-    if not _has_discovery_function(config_flow):\n+    # Fallback => check config_flow step\n+    config_flow = ast.parse(config_flow_file.read_text())\n+    if not (_has_discovery_function(config_flow)):\n         return [\n-            f\"Integration is missing one of {DISCOVERY_FUNCTIONS} \"\n+            f\"Integration is missing one of {CONFIG_FLOW_STEPS} \"\n             f\"in {config_flow_file}\"\n         ]\n \n", "test_patch": "", "problem_statement": "Error in test for discovery of new quality scale\n### The problem\n\nIn `/script/hassfest/quality_scale_validation/discovery.py` it is only tested, if an integration has one of the defined `DISCOVERY_FUNCTIONS`. According to @joostlek it is possible, though, to only rely on the functions in the base class in certain circumstances, e.g. if you discover a device in the network but the integration itself does not connect to the device but a web portal. The test therefore produces false negatives. \r\nNot sure how test could be improved. Perhaps only testing against entry in manifest?\r\n\n\n### What version of Home Assistant Core has the issue?\n\n2024.11.3\n\n### What was the last working version of Home Assistant Core?\n\n_No response_\n\n### What type of installation are you running?\n\nHome Assistant OS\n\n### Integration causing the issue\n\n_No response_\n\n### Link to integration documentation on our website\n\n_No response_\n\n### Diagnostics information\n\n_No response_\n\n### Example YAML snippet\n\n_No response_\n\n### Anything in the logs that might be useful for us?\n\n_No response_\n\n### Additional information\n\n_No response_\n", "hints_text": "", "created_at": "2024-12-04T09:21:45Z"}
{"repo": "home-assistant/core", "pull_number": 132231, "instance_id": "home-assistant__core-132231", "issue_numbers": ["130516"], "base_commit": "ce11ac5ecd17144737322056b9e8a5382411c127", "patch": "diff --git a/homeassistant/components/switchbot_cloud/climate.py b/homeassistant/components/switchbot_cloud/climate.py\nindex cd60313f37ac7..7b1c3415a486b 100644\n--- a/homeassistant/components/switchbot_cloud/climate.py\n+++ b/homeassistant/components/switchbot_cloud/climate.py\n@@ -79,6 +79,8 @@ class SwitchBotCloudAirConditioner(SwitchBotCloudEntity, ClimateEntity):\n     _attr_hvac_mode = HVACMode.FAN_ONLY\n     _attr_temperature_unit = UnitOfTemperature.CELSIUS\n     _attr_target_temperature = 21\n+    _attr_target_temperature_step = 1\n+    _attr_precision = 1\n     _attr_name = None\n     _enable_turn_on_off_backwards_compatibility = False\n \n@@ -97,7 +99,7 @@ async def _do_send_command(\n         )\n         await self.send_api_command(\n             AirConditionerCommands.SET_ALL,\n-            parameters=f\"{new_temperature},{new_mode},{new_fan_speed},on\",\n+            parameters=f\"{int(new_temperature)},{new_mode},{new_fan_speed},on\",\n         )\n \n     async def async_set_hvac_mode(self, hvac_mode: HVACMode) -> None:\n", "test_patch": "", "problem_statement": "Switchbot cloud IR for airconditioners\n### The problem\n\nSince last update when i use switch bot to control my aircon units, when changing hvac mode, it no longer will switch to heat or cool, it always switches to cooling, no mather what mode i put it in.\n\n### What version of Home Assistant Core has the issue?\n\n2024.11.1\n\n### What was the last working version of Home Assistant Core?\n\n2024.10.X\n\n### What type of installation are you running?\n\nHome Assistant OS\n\n### Integration causing the issue\n\nSwitchbot Cloud\n\n### Link to integration documentation on our website\n\n_No response_\n\n### Diagnostics information\n\n_No response_\n\n### Example YAML snippet\n\n_No response_\n\n### Anything in the logs that might be useful for us?\n\n_No response_\n\n### Additional information\n\n_No response_\n", "hints_text": "\nHey there @seraphicrav, @laurence-presland, @gigatrappeur, mind taking a look at this issue as it has been labeled with an integration (`switchbot_cloud`) you are listed as a [code owner](https://github.com/home-assistant/core/blob/dev/CODEOWNERS#L1449) for? Thanks!\n\n<details>\n<summary>Code owner commands</summary>\n\n\nCode owners of `switchbot_cloud` can trigger bot actions by commenting:\n\n- `@home-assistant close` Closes the issue.\n- `@home-assistant rename Awesome new title` Renames the issue.\n- `@home-assistant reopen` Reopen the issue.\n- `@home-assistant unassign switchbot_cloud` Removes the current integration label and assignees on the issue, add the integration domain after the command.\n- `@home-assistant add-label needs-more-information` Add a label (needs-more-information, problem in dependency, problem in custom component) to the issue.\n- `@home-assistant remove-label needs-more-information` Remove a label (needs-more-information, problem in dependency, problem in custom component) on the issue.\n\n</details>\n\n\n<sub><sup>(message by CodeOwnersMention)</sup></sub>\n\n---\n\n[switchbot_cloud documentation](https://www.home-assistant.io/integrations/switchbot_cloud)\n[switchbot_cloud source](https://github.com/home-assistant/core/tree/dev/homeassistant/components/switchbot_cloud)\n<sub><sup>(message by IssueLinks)</sup></sub>\n@kristofvand Thanks for your feedback !\r\n\r\nI just checked with the the AC I have and was not able to reproduce your issue.\r\n\r\nWhat happens when you use the SwitchBot app, do you get the same behavior ?\nin the switchbot app, the integration in amazon or google it all works perfectly.\r\nWhen i select heat it heats, when i select cooling it cools\r\n\r\nIn HA when i select **any** hvac modus it always results in **cooling** mode (or auto, that it has the same symbol on the airco so i'm not sure, but since airco is in the wrong setting this means i get no heat)\r\n\r\nI just checked again and even setting the temperature setting does not work atm\nIf you want i could film my actions? Or if i need to send a log or something, Tell me where to find the log file.\nPretty much the same here as well.\n\nUsing HA to change the temperature or mode always results in a 25 degree setting and as mentioned cooling or auto mode. \n\nWhen using the SwitchBot app all commands are sent to the device properly.\n\nSeems like the commands aren't sent properly from HA to Switchbot Cloud or there is something wrong with the handling of the request at Switchbot.\nI got exactly the same issue. I noticed it only today.\r\nhome assistant can't switch to heat, only cooling.\r\nIn switchbot app, the switch to heat works perfectly.\r\n\r\nIt's very annoying for me cause we're entering the cold period in west Europe and if I have to let my AC on heat all day and night it's gonna cost me a fortune.\r\n\r\nI'm going to try rolling back HA core version for now and tell you if it works again.. \nRolled back to 2024.10.4, not working, units are still stuck to cooling mode.\r\nTried uninstalling switchbot integration and installing it again, still same issue.\r\n\r\nI wrote an email to switchbot support as the issue seems to be on their side in my opinion. \nok a bit of investigations : Switchbotcloud API seems to be broken.\r\n\r\nIn HA terminal use this command \r\n\r\ncurl -X POST \"https://api.switch-bot.com/v1.0/devices/YOUR DEVICE ID/commands\" \\\r\n-H \"Content-Type: application/json\" \\\r\n-H \"Authorization: Bearer YOUR TOKEN ID\" \\\r\n-d '{\r\n  \"command\": \"setAll\",\r\n  \"parameter\": \"heat,23,auto\",\r\n  \"commandType\": \"command\"\r\n}'\r\n\r\nInstantly, the AC goes to cooling mode instead of heat mode.\r\n\r\nThank you switchbot, great work !  \n@rpaillot Thanks for investigating the issue!\nStrange question, as it works properly from Japan, does it work if you send the request using a VPN in Japan?\n> Strange question, as it works properly from Japan, does it work if you send the request using a VPN in Japan?\r\n\r\nInteresting!\r\n should I use the VPN on my iPhone before using home assistant app or using a VPN inside home assistant box ?\n> > Strange question, as it works properly from Japan, does it work if you send the request using a VPN in Japan?\r\n> \r\n> Interesting! should I use the VPN on my iPhone before using home assistant app or using a VPN inside home assistant box ?\r\n\r\nShould be from the Home Assistant box as it is the server which does the requests.\nI have yet to try the VPN as its not so easy to setup.\r\n\r\nare you using a Toshiba AC btw ?\nI know I can't contribute much in terms of testing or coding but my air conditioners are from Bulex.\nOk mine is Toshiba.\r\n\r\ndefinitely SwitchBot API has an issue.\r\nI wrote to support@switch-bot.com\r\nMaybe you can do the same and they might go faster in fixing the issue \nWill do. I'll send a mail when I get home\n> are you using a Toshiba AC btw ?\r\n\r\nUsing Daikin\nI also have the same problem, using Daikin AC's.\r\nOn my Alexa integration stoped working also, but removing the switchbot skill from Alexa, and adding the skill again seems to resolve the issue.\r\nOn home assistant is still not working.\r\nI sent a ticket with this issue to swicthbot, waiting for a reply from them...\n> I also have the same problem, using Daikin AC's. On my Alexa integration stoped working also, but removing the switchbot skill from Alexa, and adding the skill again seems to resolve the issue. On home assistant is still not working. I sent a ticket with this issue to swicthbot, waiting for a reply from them...\r\n\r\nPlease send an email to support@switch-bot.com\r\n\r\nThey answered me and said they asked a technician but it's better if several people ask the support, they might take it more seriously. \nHello everyone,\r\nI have the same problem from france as you, Fujistsu air conditionner stay on cooling with home assistant.\r\nFrom switchbot application all is right\r\nI wrote to support@switch-bot.com yesterday, not response for now\nI just hope it\u2019s not a rule they decided to avoid too many API requests from Home assistant users\u2026\n> I also have the same problem, using Daikin AC's. On my Alexa integration stoped working also, but removing the switchbot skill from Alexa, and adding the skill again seems to resolve the issue. On home assistant is still not working. I sent a ticket with this issue to swicthbot, waiting for a reply from them...\r\n\r\nWondering something : isn\u2019t it possible to link Alexa to home assistant to get the skill ? \nyou can link alexa to HA and control it that way but sadly this does not work 100% of the time, i get time outs in alexa, same with google. Trough the interface it works but via a routine half the time, they do not get set and i neet to first manually click the airco in alexa or google again to set it manually before it works again using routines. Before in HA it always worked correctly it would be nice if the API was fixed and worked again as before. Or there was a better solution. I mailed switchbot, can only hope if everyone mails they fix it.\nWhat about using matter for the time being if you have a Matter compatible SwitchBot hub ?\nI don't\nGood idea but yeah I only have a switchbot hub mini which's not matter compatible.\r\n\r\nStill not working this morning, I'm starting to think about alternative to switchbot for controlling things with infrared... \nSome news : Heat seems to work again... but set temperature doesn't work (unknown error set temperature in HA)\r\n\nfor me it does nothing at all now, it does not even send any IR signal for the moment, only on/off works, changing modes or temperature does nothing (normally for each setting change the airco unit also beeps, now it does not, only when using the switch to turn it on and off, something must have changed though because last week even when it did not accept the correct setting it at least beeped).\nThe answer from switchbot, can someone who knows what is what (i just kow there is a problem but no idea about api's or developing) post an issue for switchbot on their github page.\r\n\r\n----\r\n\r\nDear Kristof\uff0c\r\n \r\nGood day!\r\n \r\nThanks for reaching out to us.\r\nWe are sorry to hear about the issue you're experiencing. We would love to help!\r\n \r\nHome Assistant is not officially supported, you will need to find what he needs on Github or other forums for API-related issues\r\nAccording to our developers, any issue related to the open API should be followed up on GitHub. Please kindly submit an issue on GitHub. Here is the link you can visit\r\n[Issues \u00b7 OpenWonderLabs/SwitchBotAPI](https://github.com/OpenWonderLabs/SwitchBotAPI/issues)\r\nIf you have already sent that, please be aware that developers will answer your question accordingly.\r\n \r\nAlso, this link\r\nhttps://github.com/OpenWonderLabs/SwitchBotAPI\r\nshould help you as well.\r\nPlease kindly understand that we don't commit to API maintenance and new feature development. So, any update or fixes of the open API would not be expected in the schedule.\r\n \r\nIf there is an update, our developers will take the initiative to publish it.\r\nThank you for your understanding in advance.\ud83e\udde1\ufe0f\r\n \r\nIf you have other questions or need more help, please don't hesitate to contact us!\r\nHave a nice day! \ud83d\ude0a\ufe0f\r\n \r\nBest Regards,\r\nJoyce\r\nSwitchBot Customer Happiness\r\n[www.switch-bot.com](http://www.switch-bot.com/)\nOk so basically they dont give a sh** after they created an issue one week before entering cold and minus 2 temp period in Europe.\r\n\r\nbye bye SwitchBot, throwing that thing in trash.\r\n\r\n\nWow, such a sad answer...\r\nAll issues in their Github are getting automatically closed because nobody answer to them...\nCan already see bug tickets stacking\r\n![Screenshot_20241121-185936](https://github.com/user-attachments/assets/e9930ae5-fa9c-4a25-822c-f470704b1d41)\r\n\nI hope the more people post they do listen\nI don\u2019t want to speak for them but this looks deliberate to save some API resources\nFor me it became obvious they screwed up the moment I noticed Alexa was not working and always powered A/C on cool mode. And what's funnier: you cannot switch it off again. I had to go find the damn remote.\n\nAt least HA still can power A/C on/off, but get API errors when trying to change HVAC or set temperature. And it keeps powering on cool mode too, so for us living in the north hemisphere this thing is broken right now.\n\nAnd my automations to get the bedroom nice & warm to sleep turned it into a fridge.\n\nThanks SwitchBort...\nWell it\u2019s a good reminder to find a new IR command unit that can works without a cloud API\u2026\r\nWhat do you think of the Broadlink RM Mini 3? \r\n \nHi everyone! I wrote mine to him..\n\n\nGood morning, I don't want to ask for support or explanations. I understood by reading on various forums that you have no intention of supporting Home Assistant with the APIs making your Hubs unusable. So I'm writing to you only to tell you that like me thousands and thousands of people will throw your products in the garbage and change with one of the many alternatives now on the market... too bad! I have already placed the order.. Greetings Switchbot!\nHi there!\r\nJust updated do the latest version of [ha-switchbot-remote](https://github.com/KiraPC/ha-switchbot-remote) on my home assistant, and my AC's are now working great through the switchbot remotes.\r\nEverything is working fine, setting temperature, fanspeed and HVAC mode.\r\nIt was a long wait, but now all works good!\r\nThanks!\r\n\r\nnote: the OpenWonderLabs is still not working..... but.... who cares now, right?", "created_at": "2024-12-04T04:55:32Z"}
{"repo": "home-assistant/core", "pull_number": 132212, "instance_id": "home-assistant__core-132212", "issue_numbers": ["127610", "127610"], "base_commit": "4deaeaeda048112c9ebd5e3883bccfcadb8dded6", "patch": "diff --git a/homeassistant/components/unifiprotect/camera.py b/homeassistant/components/unifiprotect/camera.py\nindex a40939be9177f0..0b1c03b8dd6058 100644\n--- a/homeassistant/components/unifiprotect/camera.py\n+++ b/homeassistant/components/unifiprotect/camera.py\n@@ -90,7 +90,7 @@ def _get_camera_channels(\n                 is_default = False\n \n         # no RTSP enabled use first channel with no stream\n-        if is_default:\n+        if is_default and not camera.is_third_party_camera:\n             _create_rtsp_repair(hass, entry, data, camera)\n             yield camera, camera.channels[0], True\n         else:\n", "test_patch": "diff --git a/tests/components/unifiprotect/test_repairs.py b/tests/components/unifiprotect/test_repairs.py\nindex adb9555e6ea472..1117038bbd0c83 100644\n--- a/tests/components/unifiprotect/test_repairs.py\n+++ b/tests/components/unifiprotect/test_repairs.py\n@@ -363,3 +363,30 @@ async def test_rtsp_writable_fix_when_not_setup(\n     ufp.api.update_device.assert_called_with(\n         ModelType.CAMERA, doorbell.id, {\"channels\": channels}\n     )\n+\n+\n+async def test_rtsp_no_fix_if_third_party(\n+    hass: HomeAssistant,\n+    ufp: MockUFPFixture,\n+    doorbell: Camera,\n+    hass_ws_client: WebSocketGenerator,\n+) -> None:\n+    \"\"\"Test no RTSP disabled warning if camera is third-party.\"\"\"\n+\n+    for channel in doorbell.channels:\n+        channel.is_rtsp_enabled = False\n+    for user in ufp.api.bootstrap.users.values():\n+        user.all_permissions = []\n+\n+    ufp.api.get_camera = AsyncMock(return_value=doorbell)\n+    doorbell.is_third_party_camera = True\n+\n+    await init_entry(hass, ufp, [doorbell])\n+    await async_process_repairs_platforms(hass)\n+    ws_client = await hass_ws_client(hass)\n+\n+    await ws_client.send_json({\"id\": 1, \"type\": \"repairs/list_issues\"})\n+    msg = await ws_client.receive_json()\n+\n+    assert msg[\"success\"]\n+    assert not msg[\"result\"][\"issues\"]\n", "problem_statement": "Warning Raised for Disabled RTSPS on ONVIF Cameras Which Do Not Support RTSPS\n### The problem\n\nThe ability to add third-party cameras via ONVIF was added to UniFi Protect in version [5.0.33](https://community.ui.com/releases/UniFi-Protect-Application-5-0-33/2e1b6652-450b-4f65-ba42-815d08535efd).\r\n\r\nI added a Yi Cam running custom firmware that supports ONVIF to my instance of Protect, and ever since, the UniFi Protect integration has been raising the below warning for repair in Home Assistant:\r\n> **RTSPS is disabled on the camera Yi Cam.**\r\n> RTSPS is required to live stream your camera within Home Assistant. If you do not enable RTSPS, it may create an additional load on your UniFi Protect NVR as any live video players will default to rapidly pulling snapshots from the camera.\r\n>\r\n> You may manually [enable RTSPS](https://www.home-assistant.io/integrations/unifiprotect/#camera-streams) on your selected camera quality channel or Home Assistant can automatically enable the highest quality channel for you. Confirm this repair once you have enabled the RTSPS channel or if you want Home Assistant to enable the highest quality automatically.\r\n\r\nThe only button available on this warning is Submit. there is no Ignore button.\r\n\r\nWhen I click submit, I see the message:\r\n\r\n>**Success!**\r\n>The issue is repaired!\r\n\r\nHowever after a while, or after a reboot, the warning returns.\r\n\r\nUniFi Protect does not currently offer RTSPS streams for third-party ONVIF cameras. I believe this is the issue, as the integration is recognising the existence of camera without an RTSPS stream, but not recognising that RTSPS streaming is not possible for the camera.\r\n\r\nHere's the settings of the camera as they appear in the UniFi Protect app, showing the lack of an Advanced section, which normally holds the RTSPS settings:\r\n![image](https://github.com/user-attachments/assets/4db0a83f-98bd-4ee9-9a38-f78448e75784)\r\n \n\n### What version of Home Assistant Core has the issue?\n\ncore-2024.10.1\n\n### What was the last working version of Home Assistant Core?\n\n_No response_\n\n### What type of installation are you running?\n\nHome Assistant OS\n\n### Integration causing the issue\n\nUniFi Protect\n\n### Link to integration documentation on our website\n\nhttps://www.home-assistant.io/integrations/unifiprotect\n\n### Diagnostics information\n\n_No response_\n\n### Example YAML snippet\n\n_No response_\n\n### Anything in the logs that might be useful for us?\n\n_No response_\n\n### Additional information\n\n_No response_\nWarning Raised for Disabled RTSPS on ONVIF Cameras Which Do Not Support RTSPS\n### The problem\n\nThe ability to add third-party cameras via ONVIF was added to UniFi Protect in version [5.0.33](https://community.ui.com/releases/UniFi-Protect-Application-5-0-33/2e1b6652-450b-4f65-ba42-815d08535efd).\r\n\r\nI added a Yi Cam running custom firmware that supports ONVIF to my instance of Protect, and ever since, the UniFi Protect integration has been raising the below warning for repair in Home Assistant:\r\n> **RTSPS is disabled on the camera Yi Cam.**\r\n> RTSPS is required to live stream your camera within Home Assistant. If you do not enable RTSPS, it may create an additional load on your UniFi Protect NVR as any live video players will default to rapidly pulling snapshots from the camera.\r\n>\r\n> You may manually [enable RTSPS](https://www.home-assistant.io/integrations/unifiprotect/#camera-streams) on your selected camera quality channel or Home Assistant can automatically enable the highest quality channel for you. Confirm this repair once you have enabled the RTSPS channel or if you want Home Assistant to enable the highest quality automatically.\r\n\r\nThe only button available on this warning is Submit. there is no Ignore button.\r\n\r\nWhen I click submit, I see the message:\r\n\r\n>**Success!**\r\n>The issue is repaired!\r\n\r\nHowever after a while, or after a reboot, the warning returns.\r\n\r\nUniFi Protect does not currently offer RTSPS streams for third-party ONVIF cameras. I believe this is the issue, as the integration is recognising the existence of camera without an RTSPS stream, but not recognising that RTSPS streaming is not possible for the camera.\r\n\r\nHere's the settings of the camera as they appear in the UniFi Protect app, showing the lack of an Advanced section, which normally holds the RTSPS settings:\r\n![image](https://github.com/user-attachments/assets/4db0a83f-98bd-4ee9-9a38-f78448e75784)\r\n \n\n### What version of Home Assistant Core has the issue?\n\ncore-2024.10.1\n\n### What was the last working version of Home Assistant Core?\n\n_No response_\n\n### What type of installation are you running?\n\nHome Assistant OS\n\n### Integration causing the issue\n\nUniFi Protect\n\n### Link to integration documentation on our website\n\nhttps://www.home-assistant.io/integrations/unifiprotect\n\n### Diagnostics information\n\n_No response_\n\n### Example YAML snippet\n\n_No response_\n\n### Anything in the logs that might be useful for us?\n\n_No response_\n\n### Additional information\n\n_No response_\n", "hints_text": "[unifiprotect documentation](https://www.home-assistant.io/integrations/unifiprotect)\n[unifiprotect source](https://github.com/home-assistant/core/tree/dev/homeassistant/components/unifiprotect)\nI have the same problem\nHello,\r\nSame for me, I use this integration only to get cpu/ram/disk information (not for video). How can I disable this warning ?\r\n\r\nThanks in advance\nCould someone (or even multiple people) perhaps generate example data as described here? https://uiprotect.readthedocs.io/en/latest/dev/#linting-and-testing under \"Generating Test Data\"\n@zoic21 @Robbe-B @Garywoo I've already started working on a fix, but it would still be very helpful if you could provide an example using the camera object from Bootstrap. I got myself an ONVIF camera to test this, but it seems to provide RTSP streams. If you want the fix to be tested with real data, I'll need your support with that.\n@RaHehl, I can test your changes if you send me the PR.\n[unifiprotect documentation](https://www.home-assistant.io/integrations/unifiprotect)\n[unifiprotect source](https://github.com/home-assistant/core/tree/dev/homeassistant/components/unifiprotect)\nI have the same problem\nHello,\r\nSame for me, I use this integration only to get cpu/ram/disk information (not for video). How can I disable this warning ?\r\n\r\nThanks in advance\nCould someone (or even multiple people) perhaps generate example data as described here? https://uiprotect.readthedocs.io/en/latest/dev/#linting-and-testing under \"Generating Test Data\"\n@zoic21 @Robbe-B @Garywoo I've already started working on a fix, but it would still be very helpful if you could provide an example using the camera object from Bootstrap. I got myself an ONVIF camera to test this, but it seems to provide RTSP streams. If you want the fix to be tested with real data, I'll need your support with that.\n@RaHehl, I can test your changes if you send me the PR.", "created_at": "2024-12-03T20:56:56Z"}
{"repo": "home-assistant/core", "pull_number": 132199, "instance_id": "home-assistant__core-132199", "issue_numbers": ["132137"], "base_commit": "ab83ec61e0f28dec725547a5af198be3e64d1cc6", "patch": "diff --git a/script/scaffold/__main__.py b/script/scaffold/__main__.py\nindex 45dbed790e6cbf..93c787df50ff33 100644\n--- a/script/scaffold/__main__.py\n+++ b/script/scaffold/__main__.py\n@@ -28,7 +28,7 @@ def get_arguments() -> argparse.Namespace:\n     return parser.parse_args()\n \n \n-def main():\n+def main() -> int:\n     \"\"\"Scaffold an integration.\"\"\"\n     if not Path(\"requirements_all.txt\").is_file():\n         print(\"Run from project root\")\ndiff --git a/script/scaffold/generate.py b/script/scaffold/generate.py\nindex 0bee69b93f890f..9ca5ead57195f1 100644\n--- a/script/scaffold/generate.py\n+++ b/script/scaffold/generate.py\n@@ -19,7 +19,7 @@ def generate(template: str, info: Info) -> None:\n     print()\n \n \n-def _generate(src_dir, target_dir, info: Info) -> None:\n+def _generate(src_dir: Path, target_dir: Path, info: Info) -> None:\n     \"\"\"Generate an integration.\"\"\"\n     replaces = {\"NEW_DOMAIN\": info.domain, \"NEW_NAME\": info.name}\n \ndiff --git a/script/scaffold/templates/config_flow/integration/config_flow.py b/script/scaffold/templates/config_flow/integration/config_flow.py\nindex 0bff976f288cc4..06db7592840e42 100644\n--- a/script/scaffold/templates/config_flow/integration/config_flow.py\n+++ b/script/scaffold/templates/config_flow/integration/config_flow.py\n@@ -1,4 +1,4 @@\n-\"\"\"Config flow for NEW_NAME integration.\"\"\"\n+\"\"\"Config flow for the NEW_NAME integration.\"\"\"\n \n from __future__ import annotations\n \ndiff --git a/script/scaffold/templates/config_flow_discovery/integration/config_flow.py b/script/scaffold/templates/config_flow_discovery/integration/config_flow.py\nindex e2cfed40e1d474..570b70b85aaf89 100644\n--- a/script/scaffold/templates/config_flow_discovery/integration/config_flow.py\n+++ b/script/scaffold/templates/config_flow_discovery/integration/config_flow.py\n@@ -1,4 +1,4 @@\n-\"\"\"Config flow for NEW_NAME.\"\"\"\n+\"\"\"Config flow for the NEW_NAME integration.\"\"\"\n \n import my_pypi_dependency\n \ndiff --git a/script/scaffold/templates/config_flow_helper/integration/config_flow.py b/script/scaffold/templates/config_flow_helper/integration/config_flow.py\nindex 5d89fec2da268e..c2ab7a205daa76 100644\n--- a/script/scaffold/templates/config_flow_helper/integration/config_flow.py\n+++ b/script/scaffold/templates/config_flow_helper/integration/config_flow.py\n@@ -1,4 +1,4 @@\n-\"\"\"Config flow for NEW_NAME integration.\"\"\"\n+\"\"\"Config flow for the NEW_NAME integration.\"\"\"\n \n from __future__ import annotations\n \ndiff --git a/script/scaffold/templates/config_flow_oauth2/integration/application_credentials.py b/script/scaffold/templates/config_flow_oauth2/integration/application_credentials.py\nindex 51ef70b1885e56..0f01c8402dff3e 100644\n--- a/script/scaffold/templates/config_flow_oauth2/integration/application_credentials.py\n+++ b/script/scaffold/templates/config_flow_oauth2/integration/application_credentials.py\n@@ -1,11 +1,9 @@\n-\"\"\"application_credentials platform the NEW_NAME integration.\"\"\"\n+\"\"\"Application credentials platform for the NEW_NAME integration.\"\"\"\n \n from homeassistant.components.application_credentials import AuthorizationServer\n from homeassistant.core import HomeAssistant\n \n-# TODO Update with your own urls\n-OAUTH2_AUTHORIZE = \"https://www.example.com/auth/authorize\"\n-OAUTH2_TOKEN = \"https://www.example.com/auth/token\"\n+from .const import OAUTH2_AUTHORIZE, OAUTH2_TOKEN\n \n \n async def async_get_authorization_server(hass: HomeAssistant) -> AuthorizationServer:\ndiff --git a/script/scaffold/templates/integration/integration/quality_scale.yaml b/script/scaffold/templates/integration/integration/quality_scale.yaml\nnew file mode 100644\nindex 00000000000000..201a91652e5445\n--- /dev/null\n+++ b/script/scaffold/templates/integration/integration/quality_scale.yaml\n@@ -0,0 +1,60 @@\n+rules:\n+  # Bronze\n+  action-setup: todo\n+  appropriate-polling: todo\n+  brands: todo\n+  common-modules: todo\n+  config-flow-test-coverage: todo\n+  config-flow: todo\n+  dependency-transparency: todo\n+  docs-actions: todo\n+  docs-high-level-description: todo\n+  docs-installation-instructions: todo\n+  docs-removal-instructions: todo\n+  entity-event-setup: todo\n+  entity-unique-id: todo\n+  has-entity-name: todo\n+  runtime-data: todo\n+  test-before-configure: todo\n+  test-before-setup: todo\n+  unique-config-entry: todo\n+\n+  # Silver\n+  action-exceptions: todo\n+  config-entry-unloading: todo\n+  docs-configuration-parameters: todo\n+  docs-installation-parameters: todo\n+  entity-unavailable: todo\n+  integration-owner: todo\n+  log-when-unavailable: todo\n+  parallel-updates: todo\n+  reauthentication-flow: todo\n+  test-coverage: todo\n+\n+  # Gold\n+  devices: todo\n+  diagnostics: todo\n+  discovery-update-info: todo\n+  discovery: todo\n+  docs-data-update: todo\n+  docs-examples: todo\n+  docs-known-limitations: todo\n+  docs-supported-devices: todo\n+  docs-supported-functions: todo\n+  docs-troubleshooting: todo\n+  docs-use-cases: todo\n+  dynamic-devices: todo\n+  entity-category: todo\n+  entity-device-class: todo\n+  entity-disabled-by-default: todo\n+  entity-translations: todo\n+  exception-translations: todo\n+  icon-translations: todo\n+  reconfiguration-flow: todo\n+  repair-issues: todo\n+  stale-devices: todo\n+\n+  # Platinum\n+  async-dependency: todo\n+  inject-websession: todo\n+  strict-typing: todo\n", "test_patch": "", "problem_statement": "Scaffold script exits non-gracefully for failing IQS\n### The problem\n\nWhen using `python3 -m script.scaffold integration` the script raises an exception at the end:\r\n```log\r\nRunning hassfest to pick up new information.\r\nTraceback (most recent call last):\r\n  File \"<frozen runpy>\", line 198, in _run_module_as_main\r\n  File \"<frozen runpy>\", line 88, in _run_code\r\n  File \"/Users/meti/Documents/Dev/home-assistant/script/scaffold/__main__.py\", line 117, in <module>\r\n    sys.exit(main())\r\n             ^^^^^^\r\n  File \"/Users/meti/Documents/Dev/home-assistant/script/scaffold/__main__.py\", line 70, in main\r\n    subprocess.run([\"python\", \"-m\", \"script.hassfest\"], **pipe_null, check=True)\r\n  File \"/Users/meti/.pyenv/versions/3.12.1/lib/python3.12/subprocess.py\", line 571, in run\r\n    raise CalledProcessError(retcode, process.args,\r\nsubprocess.CalledProcessError: Command '['python', '-m', 'script.hassfest']' returned non-zero exit status 1.\r\n```\r\n\r\nRunning `python -m script.hassfest` yields\r\n```log\r\n* [ERROR] [QUALITY_SCALE] Quality scale definition not found. New integrations are required to at least reach the Bronze tier.\r\n```\r\n\r\nI think the scaffold script should create `quality_scale.yaml` and skip the check for \"Bronze\" tier so it exits without raising errors that are hard to understand for new contributors.\n\n### What version of Home Assistant Core has the issue?\n\ncore-2025.1.0.dev0\n\n### What was the last working version of Home Assistant Core?\n\n_No response_\n\n### What type of installation are you running?\n\nHome Assistant Core\n\n### Integration causing the issue\n\n_No response_\n\n### Link to integration documentation on our website\n\nhttps://developers.home-assistant.io/docs/creating_component_index/\n\n### Diagnostics information\n\n_No response_\n\n### Example YAML snippet\n\n_No response_\n\n### Anything in the logs that might be useful for us?\n\n_No response_\n\n### Additional information\n\n_No response_\n", "hints_text": "", "created_at": "2024-12-03T20:01:34Z"}
{"repo": "home-assistant/core", "pull_number": 132167, "instance_id": "home-assistant__core-132167", "issue_numbers": ["132156"], "base_commit": "545a780fcb8e2c0bfc594cd314fdd2d775a56f12", "patch": "diff --git a/homeassistant/components/recorder/util.py b/homeassistant/components/recorder/util.py\nindex a59519ef38dfa7..125b354211eb5d 100644\n--- a/homeassistant/components/recorder/util.py\n+++ b/homeassistant/components/recorder/util.py\n@@ -902,7 +902,7 @@ def resolve_period(\n             start_time = (start_time + timedelta(days=cal_offset * 366)).replace(\n                 month=1, day=1\n             )\n-            end_time = (start_time + timedelta(days=365)).replace(day=1)\n+            end_time = (start_time + timedelta(days=366)).replace(day=1)\n \n         start_time = dt_util.as_utc(start_time)\n         end_time = dt_util.as_utc(end_time)\n", "test_patch": "diff --git a/tests/components/recorder/test_util.py b/tests/components/recorder/test_util.py\nindex 4904bdecc4d9a9..7b8eef6b16f96a 100644\n--- a/tests/components/recorder/test_util.py\n+++ b/tests/components/recorder/test_util.py\n@@ -9,6 +9,7 @@\n from typing import Any\n from unittest.mock import MagicMock, Mock, patch\n \n+from freezegun.api import FrozenDateTimeFactory\n import pytest\n from sqlalchemy import lambda_stmt, text\n from sqlalchemy.engine.result import ChunkedIteratorResult\n@@ -1052,55 +1053,94 @@ def all(self):\n             assert rows == [\"mock_row\"]\n \n \n-@pytest.mark.freeze_time(datetime(2022, 10, 21, 7, 25, tzinfo=UTC))\n-async def test_resolve_period(hass: HomeAssistant) -> None:\n+@pytest.mark.parametrize(\n+    (\"start_time\", \"periods\"),\n+    [\n+        (\n+            # Test 00:25 local time, during DST\n+            datetime(2022, 10, 21, 7, 25, 50, 123, tzinfo=UTC),\n+            {\n+                \"hour\": [\"2022-10-21T07:00:00+00:00\", \"2022-10-21T08:00:00+00:00\"],\n+                \"hour-1\": [\"2022-10-21T06:00:00+00:00\", \"2022-10-21T07:00:00+00:00\"],\n+                \"day\": [\"2022-10-21T07:00:00+00:00\", \"2022-10-22T07:00:00+00:00\"],\n+                \"day-1\": [\"2022-10-20T07:00:00+00:00\", \"2022-10-21T07:00:00+00:00\"],\n+                \"week\": [\"2022-10-17T07:00:00+00:00\", \"2022-10-24T07:00:00+00:00\"],\n+                \"week-1\": [\"2022-10-10T07:00:00+00:00\", \"2022-10-17T07:00:00+00:00\"],\n+                \"month\": [\"2022-10-01T07:00:00+00:00\", \"2022-11-01T07:00:00+00:00\"],\n+                \"month-1\": [\"2022-09-01T07:00:00+00:00\", \"2022-10-01T07:00:00+00:00\"],\n+                \"year\": [\"2022-01-01T08:00:00+00:00\", \"2023-01-01T08:00:00+00:00\"],\n+                \"year-1\": [\"2021-01-01T08:00:00+00:00\", \"2022-01-01T08:00:00+00:00\"],\n+            },\n+        ),\n+        (\n+            # Test 00:25 local time, standard time, February 28th a leap year\n+            datetime(2024, 2, 28, 8, 25, 50, 123, tzinfo=UTC),\n+            {\n+                \"hour\": [\"2024-02-28T08:00:00+00:00\", \"2024-02-28T09:00:00+00:00\"],\n+                \"hour-1\": [\"2024-02-28T07:00:00+00:00\", \"2024-02-28T08:00:00+00:00\"],\n+                \"day\": [\"2024-02-28T08:00:00+00:00\", \"2024-02-29T08:00:00+00:00\"],\n+                \"day-1\": [\"2024-02-27T08:00:00+00:00\", \"2024-02-28T08:00:00+00:00\"],\n+                \"week\": [\"2024-02-26T08:00:00+00:00\", \"2024-03-04T08:00:00+00:00\"],\n+                \"week-1\": [\"2024-02-19T08:00:00+00:00\", \"2024-02-26T08:00:00+00:00\"],\n+                \"month\": [\"2024-02-01T08:00:00+00:00\", \"2024-03-01T08:00:00+00:00\"],\n+                \"month-1\": [\"2024-01-01T08:00:00+00:00\", \"2024-02-01T08:00:00+00:00\"],\n+                \"year\": [\"2024-01-01T08:00:00+00:00\", \"2025-01-01T08:00:00+00:00\"],\n+                \"year-1\": [\"2023-01-01T08:00:00+00:00\", \"2024-01-01T08:00:00+00:00\"],\n+            },\n+        ),\n+    ],\n+)\n+async def test_resolve_period(\n+    hass: HomeAssistant,\n+    freezer: FrozenDateTimeFactory,\n+    start_time: datetime,\n+    periods: dict[str, tuple[str, str]],\n+) -> None:\n     \"\"\"Test statistic_during_period.\"\"\"\n+    assert hass.config.time_zone == \"US/Pacific\"\n+    freezer.move_to(start_time)\n \n     now = dt_util.utcnow()\n \n     start_t, end_t = resolve_period({\"calendar\": {\"period\": \"hour\"}})\n-    assert start_t.isoformat() == \"2022-10-21T07:00:00+00:00\"\n-    assert end_t.isoformat() == \"2022-10-21T08:00:00+00:00\"\n-\n-    start_t, end_t = resolve_period({\"calendar\": {\"period\": \"hour\"}})\n-    assert start_t.isoformat() == \"2022-10-21T07:00:00+00:00\"\n-    assert end_t.isoformat() == \"2022-10-21T08:00:00+00:00\"\n+    assert start_t.isoformat() == periods[\"hour\"][0]\n+    assert end_t.isoformat() == periods[\"hour\"][1]\n \n     start_t, end_t = resolve_period({\"calendar\": {\"period\": \"hour\", \"offset\": -1}})\n-    assert start_t.isoformat() == \"2022-10-21T06:00:00+00:00\"\n-    assert end_t.isoformat() == \"2022-10-21T07:00:00+00:00\"\n+    assert start_t.isoformat() == periods[\"hour-1\"][0]\n+    assert end_t.isoformat() == periods[\"hour-1\"][1]\n \n     start_t, end_t = resolve_period({\"calendar\": {\"period\": \"day\"}})\n-    assert start_t.isoformat() == \"2022-10-21T07:00:00+00:00\"\n-    assert end_t.isoformat() == \"2022-10-22T07:00:00+00:00\"\n+    assert start_t.isoformat() == periods[\"day\"][0]\n+    assert end_t.isoformat() == periods[\"day\"][1]\n \n     start_t, end_t = resolve_period({\"calendar\": {\"period\": \"day\", \"offset\": -1}})\n-    assert start_t.isoformat() == \"2022-10-20T07:00:00+00:00\"\n-    assert end_t.isoformat() == \"2022-10-21T07:00:00+00:00\"\n+    assert start_t.isoformat() == periods[\"day-1\"][0]\n+    assert end_t.isoformat() == periods[\"day-1\"][1]\n \n     start_t, end_t = resolve_period({\"calendar\": {\"period\": \"week\"}})\n-    assert start_t.isoformat() == \"2022-10-17T07:00:00+00:00\"\n-    assert end_t.isoformat() == \"2022-10-24T07:00:00+00:00\"\n+    assert start_t.isoformat() == periods[\"week\"][0]\n+    assert end_t.isoformat() == periods[\"week\"][1]\n \n     start_t, end_t = resolve_period({\"calendar\": {\"period\": \"week\", \"offset\": -1}})\n-    assert start_t.isoformat() == \"2022-10-10T07:00:00+00:00\"\n-    assert end_t.isoformat() == \"2022-10-17T07:00:00+00:00\"\n+    assert start_t.isoformat() == periods[\"week-1\"][0]\n+    assert end_t.isoformat() == periods[\"week-1\"][1]\n \n     start_t, end_t = resolve_period({\"calendar\": {\"period\": \"month\"}})\n-    assert start_t.isoformat() == \"2022-10-01T07:00:00+00:00\"\n-    assert end_t.isoformat() == \"2022-11-01T07:00:00+00:00\"\n+    assert start_t.isoformat() == periods[\"month\"][0]\n+    assert end_t.isoformat() == periods[\"month\"][1]\n \n     start_t, end_t = resolve_period({\"calendar\": {\"period\": \"month\", \"offset\": -1}})\n-    assert start_t.isoformat() == \"2022-09-01T07:00:00+00:00\"\n-    assert end_t.isoformat() == \"2022-10-01T07:00:00+00:00\"\n+    assert start_t.isoformat() == periods[\"month-1\"][0]\n+    assert end_t.isoformat() == periods[\"month-1\"][1]\n \n     start_t, end_t = resolve_period({\"calendar\": {\"period\": \"year\"}})\n-    assert start_t.isoformat() == \"2022-01-01T08:00:00+00:00\"\n-    assert end_t.isoformat() == \"2023-01-01T08:00:00+00:00\"\n+    assert start_t.isoformat() == periods[\"year\"][0]\n+    assert end_t.isoformat() == periods[\"year\"][1]\n \n     start_t, end_t = resolve_period({\"calendar\": {\"period\": \"year\", \"offset\": -1}})\n-    assert start_t.isoformat() == \"2021-01-01T08:00:00+00:00\"\n-    assert end_t.isoformat() == \"2022-01-01T08:00:00+00:00\"\n+    assert start_t.isoformat() == periods[\"year-1\"][0]\n+    assert end_t.isoformat() == periods[\"year-1\"][1]\n \n     # Fixed period\n     assert resolve_period({}) == (None, None)\n", "problem_statement": "Max value does not update in December if set to \"this Year\" and this year is Leap year\n### The problem\r\n\r\nI track some measurements in homeassistant and show the max value as well. \r\nI use the statistic card to show the max value for the current year.\r\n\r\nHowever it seems like theses don't update anymore during December - the last update was in November\r\n\r\ncore-2024.11.3 and core-2024.11.4 both seem to be at least affected\r\n\r\n### What version of Home Assistant Core has the issue?\r\n\r\ncore-2024.11.4\r\n\r\n### What was the last working version of Home Assistant Core?\r\n\r\nBased on further analysis, this might have never worked\r\n\r\n### What type of installation are you running?\r\n\r\nHome Assistant Container\r\n\r\n### Integration causing the issue\r\n\r\nNot sure if it's an integration\r\nI'm using the statistics card to show the max value\r\n![image](https://github.com/user-attachments/assets/c17ac1c2-de2e-4c17-99c8-bdd8988583f7)\r\n\r\n\r\nHowever it does not update anymore since about a month and it's current value is higher: \r\n![image](https://github.com/user-attachments/assets/b3407a76-c044-48f3-b2c8-4e2b1b389ef3)\r\n\r\n\r\n### Link to integration documentation on our website\r\n\r\n_No response_\r\n\r\n### Diagnostics information\r\n\r\n_No response_\r\n\r\n### Example YAML snippet\r\n\r\n_No response_\r\n\r\n### Anything in the logs that might be useful for us?\r\n\r\nWhen I set to \"this month\" it works - the current value is shown. \r\nIs December not counted into \"this year\" maybe? Could be some < and  <= issue somewhere\r\n\r\nI also found a workaround for the yaml config of the statistic card: \r\n```\r\ntype: statistic\r\nperiod:\r\n  fixed_period:\r\n    start: 2024-01-01\r\n    end: 2024-12-31\r\nstat_type: max\r\nname: Depot Gains ATH\r\nentity: sensor.xxx\r\nlayout_options:\r\n  grid_columns: 4\r\n  grid_rows: 2\r\n```\r\n\r\nThis counts from 1st of Jan to end of December and gives the correct value. So I'm relatively certain that the calculation for \"this year\" does not include December. I haven't found the right place in the code to double check though. \r\n### Additional information\r\n\r\n_No response_\n", "hints_text": "", "created_at": "2024-12-03T11:48:48Z"}
{"repo": "home-assistant/core", "pull_number": 132162, "instance_id": "home-assistant__core-132162", "issue_numbers": ["131376"], "base_commit": "74e4654c26177909e653921f27f838fd1366adc0", "patch": "diff --git a/homeassistant/components/opentherm_gw/button.py b/homeassistant/components/opentherm_gw/button.py\nindex bac50295199ab..00b91ad33e031 100644\n--- a/homeassistant/components/opentherm_gw/button.py\n+++ b/homeassistant/components/opentherm_gw/button.py\n@@ -16,7 +16,12 @@\n from homeassistant.helpers.entity_platform import AddEntitiesCallback\n \n from . import OpenThermGatewayHub\n-from .const import DATA_GATEWAYS, DATA_OPENTHERM_GW, GATEWAY_DEVICE_DESCRIPTION\n+from .const import (\n+    DATA_GATEWAYS,\n+    DATA_OPENTHERM_GW,\n+    GATEWAY_DEVICE_DESCRIPTION,\n+    THERMOSTAT_DEVICE_DESCRIPTION,\n+)\n from .entity import OpenThermEntity, OpenThermEntityDescription\n \n \n@@ -30,6 +35,12 @@ class OpenThermButtonEntityDescription(\n \n \n BUTTON_DESCRIPTIONS: tuple[OpenThermButtonEntityDescription, ...] = (\n+    OpenThermButtonEntityDescription(\n+        key=\"cancel_room_setpoint_override\",\n+        translation_key=\"cancel_room_setpoint_override\",\n+        device_description=THERMOSTAT_DEVICE_DESCRIPTION,\n+        action=lambda hub: hub.set_room_setpoint(0),\n+    ),\n     OpenThermButtonEntityDescription(\n         key=\"restart_button\",\n         device_class=ButtonDeviceClass.RESTART,\ndiff --git a/homeassistant/components/opentherm_gw/strings.json b/homeassistant/components/opentherm_gw/strings.json\nindex 834168eb113a8..4c452da41ae17 100644\n--- a/homeassistant/components/opentherm_gw/strings.json\n+++ b/homeassistant/components/opentherm_gw/strings.json\n@@ -158,6 +158,11 @@\n         \"name\": \"Programmed change has priority over override\"\n       }\n     },\n+    \"button\": {\n+      \"cancel_room_setpoint_override\": {\n+        \"name\": \"Cancel room setpoint override\"\n+      }\n+    },\n     \"select\": {\n       \"gpio_mode_n\": {\n         \"name\": \"GPIO {gpio_id} mode\",\n", "test_patch": "diff --git a/tests/components/opentherm_gw/test_button.py b/tests/components/opentherm_gw/test_button.py\nindex b02a9d9fef073..d8de52559e7ce 100644\n--- a/tests/components/opentherm_gw/test_button.py\n+++ b/tests/components/opentherm_gw/test_button.py\n@@ -16,6 +16,40 @@\n from tests.common import MockConfigEntry\n \n \n+async def test_cancel_room_setpoint_override_button(\n+    hass: HomeAssistant,\n+    entity_registry: er.EntityRegistry,\n+    mock_config_entry: MockConfigEntry,\n+    mock_pyotgw: MagicMock,\n+) -> None:\n+    \"\"\"Test cancel room setpoint override button.\"\"\"\n+\n+    mock_pyotgw.return_value.set_target_temp = AsyncMock(return_value=0)\n+    mock_config_entry.add_to_hass(hass)\n+\n+    await hass.config_entries.async_setup(mock_config_entry.entry_id)\n+    await hass.async_block_till_done()\n+\n+    assert (\n+        button_entity_id := entity_registry.async_get_entity_id(\n+            BUTTON_DOMAIN,\n+            OPENTHERM_DOMAIN,\n+            f\"{mock_config_entry.data[CONF_ID]}-{OpenThermDeviceIdentifier.THERMOSTAT}-cancel_room_setpoint_override\",\n+        )\n+    ) is not None\n+\n+    await hass.services.async_call(\n+        BUTTON_DOMAIN,\n+        SERVICE_PRESS,\n+        {\n+            ATTR_ENTITY_ID: button_entity_id,\n+        },\n+        blocking=True,\n+    )\n+\n+    mock_pyotgw.return_value.set_target_temp.assert_awaited_once_with(0, True)\n+\n+\n async def test_restart_button(\n     hass: HomeAssistant,\n     entity_registry: er.EntityRegistry,\n", "problem_statement": "Cannot return the thermostat to programming due to 0 no longer being an accepted temperature value\n### The problem\n\nSomewhere in the past year the behavior of Climate: Set target temperature changed for the opentherm integration (or for all integrations, I cannot evaluate that). The result is that I cannot set the temperature to 0 anymore, setting the temperature to 0 should reset the thermostat back to programming. But that is no longer possible since this change.\r\n\r\nI have tried a customization to change the min_temp however still I cannot set the temp to 0. I think it will need to be changed in the code it self..\r\n\r\nIt seems there were changes here in the past year so it would make sense that those caused the issue?\r\n\r\nhttps://github.com/home-assistant/core/blob/dev/homeassistant/components/opentherm_gw/climate.py\r\n\r\n`class OpenThermClimate(OpenThermStatusEntity, ClimateEntity):\r\n    \"\"\"Representation of a climate device.\"\"\"\r\n\r\n    _attr_supported_features = (\r\n        ClimateEntityFeature.TARGET_TEMPERATURE | ClimateEntityFeature.PRESET_MODE\r\n    )\r\n    _attr_temperature_unit = UnitOfTemperature.CELSIUS\r\n    _attr_hvac_modes = []\r\n    _attr_name = None\r\n    _attr_preset_modes = []\r\n    _attr_min_temp = 1\r\n    _attr_max_temp = 30\r\n    _attr_hvac_mode = HVACMode.HEAT\r\n    _away_mode_a: int | None = None\r\n    _away_mode_b: int | None = None\r\n    _away_state_a = False\r\n    _away_state_b = False\r\n    _enable_turn_on_off_backwards_compatibility = False\r\n    _target_temperature: float | None = None\r\n    _new_target_temperature: float | None = None\r\n    entity_description: OpenThermClimateEntityDescription`\n\n### What version of Home Assistant Core has the issue?\n\n2024.11.2\n\n### What was the last working version of Home Assistant Core?\n\n_No response_\n\n### What type of installation are you running?\n\nHome Assistant Container\n\n### Integration causing the issue\n\nopentherm_gw\n\n### Link to integration documentation on our website\n\nhttps://www.home-assistant.io/integrations/opentherm_gw/\n\n### Diagnostics information\n\n_No response_\n\n### Example YAML snippet\n\n_No response_\n\n### Anything in the logs that might be useful for us?\n\n_No response_\n\n### Additional information\n\n_No response_\n", "hints_text": "\nHey there @mvn23, mind taking a look at this issue as it has been labeled with an integration (`opentherm_gw`) you are listed as a [code owner](https://github.com/home-assistant/core/blob/dev/CODEOWNERS#L1077) for? Thanks!\n\n<details>\n<summary>Code owner commands</summary>\n\n\nCode owners of `opentherm_gw` can trigger bot actions by commenting:\n\n- `@home-assistant close` Closes the issue.\n- `@home-assistant rename Awesome new title` Renames the issue.\n- `@home-assistant reopen` Reopen the issue.\n- `@home-assistant unassign opentherm_gw` Removes the current integration label and assignees on the issue, add the integration domain after the command.\n- `@home-assistant add-label needs-more-information` Add a label (needs-more-information, problem in dependency, problem in custom component) to the issue.\n- `@home-assistant remove-label needs-more-information` Remove a label (needs-more-information, problem in dependency, problem in custom component) on the issue.\n\n</details>\n\n\n<sub><sup>(message by CodeOwnersMention)</sup></sub>\n\n---\n\n[opentherm_gw documentation](https://www.home-assistant.io/integrations/opentherm_gw)\n[opentherm_gw source](https://github.com/home-assistant/core/tree/dev/homeassistant/components/opentherm_gw)\n<sub><sup>(message by IssueLinks)</sup></sub>\nThe `min_temp` has been `1` since at least 2019. What makes you think it changed in the past year? Maybe Home Assistant just became more vocal about the unsupported value?\r\n\r\nI am also curious why this could be useful. I see that both `TT` and `TC` commands support the value, but I also know that the thermostat can always override the value we set manually anyway. With the `TT` command changes in the thermostat program will override our setting as well. We can change the command we send in the integration options (Temporary Setpoint Override Mode). In which situation would a value of `0` be useful if we already have the functionality described here?\n> The `min_temp` has been `1` since at least 2019. What makes you think it changed in the past year? Maybe Home Assistant just became more vocal about the unsupported value?\r\n\r\nThe check was added in https://github.com/home-assistant/core/pull/118649\nThanks for the reference @PierreAronnax\r\n\r\nSince it is apparently a behavioral change in Home Assistant I am inclined to either lower the `min_temp` in the opentherm_gw integration or to add support for the functionality in another way (e.g. a button).\r\nIn this case the latter has my preference as we're not actually setting the target temperature to `0`.\n@mvn23 you are correct that there are other ways to set up the automations to get to the same result. But since it was working before I figured I would report it. \r\n\r\nIt would be nice to have a way to cancel the override without reverting to the transparent commands. Especially one that you can use via automations (I think a button would not be usable, only via UI right?).\nWe have the `button.press` [action](https://www.home-assistant.io/integrations/button/#actions) for that.", "created_at": "2024-12-03T11:00:17Z"}
{"repo": "home-assistant/core", "pull_number": 132147, "instance_id": "home-assistant__core-132147", "issue_numbers": ["127610"], "base_commit": "9e723752f887b0e24b753aaaa92ab7ecc9b23f52", "patch": "diff --git a/homeassistant/components/unifiprotect/manifest.json b/homeassistant/components/unifiprotect/manifest.json\nindex 9730c1e37410af..e8a8c0628004bc 100644\n--- a/homeassistant/components/unifiprotect/manifest.json\n+++ b/homeassistant/components/unifiprotect/manifest.json\n@@ -40,7 +40,7 @@\n   \"integration_type\": \"hub\",\n   \"iot_class\": \"local_push\",\n   \"loggers\": [\"uiprotect\", \"unifi_discovery\"],\n-  \"requirements\": [\"uiprotect==6.6.4\", \"unifi-discovery==1.2.0\"],\n+  \"requirements\": [\"uiprotect==6.6.5\", \"unifi-discovery==1.2.0\"],\n   \"ssdp\": [\n     {\n       \"manufacturer\": \"Ubiquiti Networks\",\ndiff --git a/requirements_all.txt b/requirements_all.txt\nindex 70d5dc6c555f4c..fd74b4bdd84705 100644\n--- a/requirements_all.txt\n+++ b/requirements_all.txt\n@@ -2897,7 +2897,7 @@ typedmonarchmoney==0.3.1\n uasiren==0.0.1\n \n # homeassistant.components.unifiprotect\n-uiprotect==6.6.4\n+uiprotect==6.6.5\n \n # homeassistant.components.landisgyr_heat_meter\n ultraheat-api==0.5.7\n", "test_patch": "diff --git a/requirements_test_all.txt b/requirements_test_all.txt\nindex 2e3544dc7c8266..b39af5354b44f5 100644\n--- a/requirements_test_all.txt\n+++ b/requirements_test_all.txt\n@@ -2313,7 +2313,7 @@ typedmonarchmoney==0.3.1\n uasiren==0.0.1\n \n # homeassistant.components.unifiprotect\n-uiprotect==6.6.4\n+uiprotect==6.6.5\n \n # homeassistant.components.landisgyr_heat_meter\n ultraheat-api==0.5.7\n", "problem_statement": "Warning Raised for Disabled RTSPS on ONVIF Cameras Which Do Not Support RTSPS\n### The problem\n\nThe ability to add third-party cameras via ONVIF was added to UniFi Protect in version [5.0.33](https://community.ui.com/releases/UniFi-Protect-Application-5-0-33/2e1b6652-450b-4f65-ba42-815d08535efd).\r\n\r\nI added a Yi Cam running custom firmware that supports ONVIF to my instance of Protect, and ever since, the UniFi Protect integration has been raising the below warning for repair in Home Assistant:\r\n> **RTSPS is disabled on the camera Yi Cam.**\r\n> RTSPS is required to live stream your camera within Home Assistant. If you do not enable RTSPS, it may create an additional load on your UniFi Protect NVR as any live video players will default to rapidly pulling snapshots from the camera.\r\n>\r\n> You may manually [enable RTSPS](https://www.home-assistant.io/integrations/unifiprotect/#camera-streams) on your selected camera quality channel or Home Assistant can automatically enable the highest quality channel for you. Confirm this repair once you have enabled the RTSPS channel or if you want Home Assistant to enable the highest quality automatically.\r\n\r\nThe only button available on this warning is Submit. there is no Ignore button.\r\n\r\nWhen I click submit, I see the message:\r\n\r\n>**Success!**\r\n>The issue is repaired!\r\n\r\nHowever after a while, or after a reboot, the warning returns.\r\n\r\nUniFi Protect does not currently offer RTSPS streams for third-party ONVIF cameras. I believe this is the issue, as the integration is recognising the existence of camera without an RTSPS stream, but not recognising that RTSPS streaming is not possible for the camera.\r\n\r\nHere's the settings of the camera as they appear in the UniFi Protect app, showing the lack of an Advanced section, which normally holds the RTSPS settings:\r\n![image](https://github.com/user-attachments/assets/4db0a83f-98bd-4ee9-9a38-f78448e75784)\r\n \n\n### What version of Home Assistant Core has the issue?\n\ncore-2024.10.1\n\n### What was the last working version of Home Assistant Core?\n\n_No response_\n\n### What type of installation are you running?\n\nHome Assistant OS\n\n### Integration causing the issue\n\nUniFi Protect\n\n### Link to integration documentation on our website\n\nhttps://www.home-assistant.io/integrations/unifiprotect\n\n### Diagnostics information\n\n_No response_\n\n### Example YAML snippet\n\n_No response_\n\n### Anything in the logs that might be useful for us?\n\n_No response_\n\n### Additional information\n\n_No response_\n", "hints_text": "[unifiprotect documentation](https://www.home-assistant.io/integrations/unifiprotect)\n[unifiprotect source](https://github.com/home-assistant/core/tree/dev/homeassistant/components/unifiprotect)\nI have the same problem\nHello,\r\nSame for me, I use this integration only to get cpu/ram/disk information (not for video). How can I disable this warning ?\r\n\r\nThanks in advance\nCould someone (or even multiple people) perhaps generate example data as described here? https://uiprotect.readthedocs.io/en/latest/dev/#linting-and-testing under \"Generating Test Data\"", "created_at": "2024-12-03T08:32:29Z"}
{"repo": "home-assistant/core", "pull_number": 132099, "instance_id": "home-assistant__core-132099", "issue_numbers": ["122252"], "base_commit": "950563cf32e0bd594cdc37a8c7196fa6f9e18deb", "patch": "diff --git a/homeassistant/components/spaceapi/__init__.py b/homeassistant/components/spaceapi/__init__.py\nindex 93d448bd17f50..90281fe311c4c 100644\n--- a/homeassistant/components/spaceapi/__init__.py\n+++ b/homeassistant/components/spaceapi/__init__.py\n@@ -1,6 +1,7 @@\n \"\"\"Support for the SpaceAPI.\"\"\"\n \n from contextlib import suppress\n+import math\n \n import voluptuous as vol\n \n@@ -254,7 +255,17 @@ def get_sensor_data(hass, spaceapi, sensor):\n         \"\"\"Get data from a sensor.\"\"\"\n         if not (sensor_state := hass.states.get(sensor)):\n             return None\n-        sensor_data = {ATTR_NAME: sensor_state.name, ATTR_VALUE: sensor_state.state}\n+\n+        # SpaceAPI sensor values must be numbers\n+        try:\n+            state = float(sensor_state.state)\n+        except ValueError:\n+            state = math.nan\n+        sensor_data = {\n+            ATTR_NAME: sensor_state.name,\n+            ATTR_VALUE: state,\n+        }\n+\n         if ATTR_SENSOR_LOCATION in sensor_state.attributes:\n             sensor_data[ATTR_LOCATION] = sensor_state.attributes[ATTR_SENSOR_LOCATION]\n         else:\n", "test_patch": "diff --git a/tests/components/spaceapi/test_init.py b/tests/components/spaceapi/test_init.py\nindex 0de96d05605b3..8c0e897947a3e 100644\n--- a/tests/components/spaceapi/test_init.py\n+++ b/tests/components/spaceapi/test_init.py\n@@ -6,7 +6,12 @@\n from aiohttp.test_utils import TestClient\n import pytest\n \n-from homeassistant.components.spaceapi import DOMAIN, SPACEAPI_VERSION, URL_API_SPACEAPI\n+from homeassistant.components.spaceapi import (\n+    ATTR_SENSOR_LOCATION,\n+    DOMAIN,\n+    SPACEAPI_VERSION,\n+    URL_API_SPACEAPI,\n+)\n from homeassistant.const import ATTR_UNIT_OF_MEASUREMENT, PERCENTAGE, UnitOfTemperature\n from homeassistant.core import HomeAssistant\n from homeassistant.setup import async_setup_component\n@@ -27,7 +32,7 @@\n             \"icon_closed\": \"https://home-assistant.io/close.png\",\n         },\n         \"sensors\": {\n-            \"temperature\": [\"test.temp1\", \"test.temp2\"],\n+            \"temperature\": [\"test.temp1\", \"test.temp2\", \"test.temp3\"],\n             \"humidity\": [\"test.hum1\"],\n         },\n         \"spacefed\": {\"spacenet\": True, \"spacesaml\": False, \"spacephone\": True},\n@@ -67,17 +72,23 @@\n             \"location\": \"Home\",\n             \"name\": \"temp1\",\n             \"unit\": UnitOfTemperature.CELSIUS,\n-            \"value\": \"25\",\n+            \"value\": 25.0,\n         },\n         {\n-            \"location\": \"Home\",\n+            \"location\": \"outside\",\n             \"name\": \"temp2\",\n             \"unit\": UnitOfTemperature.CELSIUS,\n-            \"value\": \"23\",\n+            \"value\": 23.0,\n+        },\n+        {\n+            \"location\": \"Home\",\n+            \"name\": \"temp3\",\n+            \"unit\": UnitOfTemperature.CELSIUS,\n+            \"value\": None,\n         },\n     ],\n     \"humidity\": [\n-        {\"location\": \"Home\", \"name\": \"hum1\", \"unit\": PERCENTAGE, \"value\": \"88\"}\n+        {\"location\": \"Home\", \"name\": \"hum1\", \"unit\": PERCENTAGE, \"value\": 88.0}\n     ],\n }\n \n@@ -96,6 +107,19 @@ def mock_client(hass: HomeAssistant, hass_client: ClientSessionGenerator) -> Tes\n     hass.states.async_set(\n         \"test.temp2\",\n         23,\n+        attributes={\n+            ATTR_UNIT_OF_MEASUREMENT: UnitOfTemperature.CELSIUS,\n+            ATTR_SENSOR_LOCATION: \"outside\",\n+        },\n+    )\n+    hass.states.async_set(\n+        \"test.temp3\",\n+        \"foo\",\n+        attributes={ATTR_UNIT_OF_MEASUREMENT: UnitOfTemperature.CELSIUS},\n+    )\n+    hass.states.async_set(\n+        \"test.temp3\",\n+        \"foo\",\n         attributes={ATTR_UNIT_OF_MEASUREMENT: UnitOfTemperature.CELSIUS},\n     )\n     hass.states.async_set(\n", "problem_statement": "spaceapi: sensor values must be numbers, not strings\n### The problem\r\n\r\nThe spaceapi integration exports sensors in the following format:\r\n\r\n```json\r\n\"sensors\": {\r\n\t\"temperature\": [\r\n\t\t{\r\n\t\t\t\"name\":\"Temperature\",\r\n\t\t\t\"value\":\"24.23\",\r\n\t\t\t\"location\":\"inside\",\r\n\t\t\t\"unit\":\"\u00b0C\"\r\n\t\t}\r\n\t]\r\n}\r\n```\r\n\r\nThe [spaceapi schema](https://github.com/SpaceApi/schema/blob/359b3a204800b0dd1efcbde51e52e240aed2f6a9/13.json#L289) clearly states that the `value` field must be a number, not a string. This causes the spaceapi JSON exported by the integration to fail validation.\r\n\r\n### What version of Home Assistant Core has the issue?\r\n\r\n2024.7.3\r\n\r\n### What was the last working version of Home Assistant Core?\r\n\r\n_No response_\r\n\r\n### What type of installation are you running?\r\n\r\nHome Assistant OS\r\n\r\n### Integration causing the issue\r\n\r\nspaceapi\r\n\r\n### Link to integration documentation on our website\r\n\r\n_No response_\r\n\r\n### Diagnostics information\r\n\r\n_No response_\r\n\r\n### Example YAML snippet\r\n\r\n```yaml\r\nspaceapi:\r\n  sensors:\r\n    temperature:\r\n      - \"sensor.my_temp_sensor\"\r\n```\r\n\r\n\r\n### Anything in the logs that might be useful for us?\r\n\r\n_No response_\r\n\r\n### Additional information\r\n\r\n_No response_\n", "hints_text": "Hi \r\nThis is a custom component, which is not maintained by the HA core project. Please report your issue to the maintainer or in the source repository of this custom component.\r\nThx \ud83d\udc4d\nWhat are you talking about? The source is right here: https://github.com/home-assistant/core/blob/dev/homeassistant/components/spaceapi/__init__.py\n\nHey there @fabaff, mind taking a look at this issue as it has been labeled with an integration (`spaceapi`) you are listed as a [code owner](https://github.com/home-assistant/core/blob/dev/CODEOWNERS#L1340) for? Thanks!\n\n<details>\n<summary>Code owner commands</summary>\n\n\nCode owners of `spaceapi` can trigger bot actions by commenting:\n\n- `@home-assistant close` Closes the issue.\n- `@home-assistant rename Awesome new title` Renames the issue.\n- `@home-assistant reopen` Reopen the issue.\n- `@home-assistant unassign spaceapi` Removes the current integration label and assignees on the issue, add the integration domain after the command.\n- `@home-assistant add-label needs-more-information` Add a label (needs-more-information, problem in dependency, problem in custom component) to the issue.\n- `@home-assistant remove-label needs-more-information` Remove a label (needs-more-information, problem in dependency, problem in custom component) on the issue.\n\n</details>\n\n\n<sub><sup>(message by CodeOwnersMention)</sup></sub>\n\n---\n\n[spaceapi documentation](https://www.home-assistant.io/integrations/spaceapi)\n[spaceapi source](https://github.com/home-assistant/core/tree/dev/homeassistant/components/spaceapi)\n<sub><sup>(message by IssueLinks)</sup></sub>\nsorry, was confused by the provided link in the description \nThere hasn't been any activity on this issue recently. Due to the high number of incoming GitHub notifications, we have to clean some of the old issues, as many of them have already been resolved with the latest updates.\nPlease make sure to update to the latest Home Assistant version and check if that solves the issue. Let us know if that works for you by adding a comment \ud83d\udc4d\nThis issue has now been marked as stale and will be closed if no further activity occurs. Thank you for your contributions.\nUnsurprisingly, it hasn't fixed itself, and closing it won't fix it either.", "created_at": "2024-12-02T19:13:03Z"}
{"repo": "home-assistant/core", "pull_number": 132081, "instance_id": "home-assistant__core-132081", "issue_numbers": ["132042"], "base_commit": "d7cdb357dc27547b85b48febbeef5b1d8f811db6", "patch": "diff --git a/homeassistant/components/imap/coordinator.py b/homeassistant/components/imap/coordinator.py\nindex 41fd703d79bf4..1df107196ff56 100644\n--- a/homeassistant/components/imap/coordinator.py\n+++ b/homeassistant/components/imap/coordinator.py\n@@ -334,7 +334,17 @@ async def _async_fetch_number_of_messages(self) -> int | None:\n             raise UpdateFailed(\n                 f\"Invalid response for search '{self.config_entry.data[CONF_SEARCH]}': {result} / {lines[0]}\"\n             )\n-        if not (count := len(message_ids := lines[0].split())):\n+        # Check we do have returned items.\n+        #\n+        # In rare cases, when no UID's are returned,\n+        # only the status line is returned, and not an empty line.\n+        # See: https://github.com/home-assistant/core/issues/132042\n+        #\n+        # Strictly the RfC notes that 0 or more numbers should be returned\n+        # delimited by a space.\n+        #\n+        # See: https://datatracker.ietf.org/doc/html/rfc3501#section-7.2.5\n+        if len(lines) == 1 or not (count := len(message_ids := lines[0].split())):\n             self._last_message_uid = None\n             return 0\n         last_message_uid = (\n", "test_patch": "diff --git a/tests/components/imap/const.py b/tests/components/imap/const.py\nindex 037960c9e5daa..8f6761bd79511 100644\n--- a/tests/components/imap/const.py\n+++ b/tests/components/imap/const.py\n@@ -141,6 +141,8 @@\n )\n \n EMPTY_SEARCH_RESPONSE = (\"OK\", [b\"\", b\"Search completed (0.0001 + 0.000 secs).\"])\n+EMPTY_SEARCH_RESPONSE_ALT = (\"OK\", [b\"Search completed (0.0001 + 0.000 secs).\"])\n+\n BAD_RESPONSE = (\"BAD\", [b\"\", b\"Unexpected error\"])\n \n TEST_SEARCH_RESPONSE = (\"OK\", [b\"1\", b\"Search completed (0.0001 + 0.000 secs).\"])\ndiff --git a/tests/components/imap/test_init.py b/tests/components/imap/test_init.py\nindex 7bdfc44571adf..d4281b9e51340 100644\n--- a/tests/components/imap/test_init.py\n+++ b/tests/components/imap/test_init.py\n@@ -20,6 +20,7 @@\n from .const import (\n     BAD_RESPONSE,\n     EMPTY_SEARCH_RESPONSE,\n+    EMPTY_SEARCH_RESPONSE_ALT,\n     TEST_BADLY_ENCODED_CONTENT,\n     TEST_FETCH_RESPONSE_BINARY,\n     TEST_FETCH_RESPONSE_HTML,\n@@ -517,6 +518,11 @@ async def test_fetch_number_of_messages(\n     assert state.state == STATE_UNAVAILABLE\n \n \n+@pytest.mark.parametrize(\n+    \"empty_search_reponse\",\n+    [EMPTY_SEARCH_RESPONSE, EMPTY_SEARCH_RESPONSE_ALT],\n+    ids=[\"regular_empty_search_response\", \"alt_empty_search_response\"],\n+)\n @pytest.mark.parametrize(\"imap_search\", [TEST_SEARCH_RESPONSE])\n @pytest.mark.parametrize(\n     (\"imap_fetch\", \"valid_date\"),\n@@ -525,7 +531,10 @@ async def test_fetch_number_of_messages(\n )\n @pytest.mark.parametrize(\"imap_has_capability\", [True, False], ids=[\"push\", \"poll\"])\n async def test_reset_last_message(\n-    hass: HomeAssistant, mock_imap_protocol: MagicMock, valid_date: bool\n+    hass: HomeAssistant,\n+    mock_imap_protocol: MagicMock,\n+    valid_date: bool,\n+    empty_search_reponse: tuple[str, list[bytes]],\n ) -> None:\n     \"\"\"Test receiving a message successfully.\"\"\"\n     event = asyncio.Event()  # needed for pushed coordinator to make a new loop\n@@ -580,7 +589,7 @@ async def _sleep_till_event() -> None:\n     )\n \n     # Simulate an update where no messages are found (needed for pushed coordinator)\n-    mock_imap_protocol.search.return_value = Response(*EMPTY_SEARCH_RESPONSE)\n+    mock_imap_protocol.search.return_value = Response(*empty_search_reponse)\n \n     # Make sure we have an update\n     async_fire_time_changed(hass, utcnow() + timedelta(seconds=30))\n", "problem_statement": "Imap sensor defaults to state 5 when no emails found\n### The problem\n\nI have a imap sensor setup with default options:\r\n![image](https://github.com/user-attachments/assets/5086e4ea-0612-48a3-9dfa-231dc104ebe4)\r\n\r\nimap account is an icloud email. Whenever the mailbox is empty or all emails are read the state is 5 for some reason. When there is an unread email in the inbox it seems to work reliably.\r\n\r\nNot a major issue since I use events to trigger automation but for use of the sensor to trigger automation when above 0 or increasing or some other trigger it would not work.\n\n### What version of Home Assistant Core has the issue?\n\n2024.11.3\n\n### What was the last working version of Home Assistant Core?\n\n_No response_\n\n### What type of installation are you running?\n\nHome Assistant OS\n\n### Integration causing the issue\n\nimap\n\n### Link to integration documentation on our website\n\nhttps://www.home-assistant.io/integrations/imap\n\n### Diagnostics information\n\n_No response_\n\n### Example YAML snippet\n\n_No response_\n\n### Anything in the logs that might be useful for us?\n\n_No response_\n\n### Additional information\n\n_No response_\n", "hints_text": "\nHey there @jbouwh, mind taking a look at this issue as it has been labeled with an integration (`imap`) you are listed as a [code owner](https://github.com/home-assistant/core/blob/dev/CODEOWNERS#L693) for? Thanks!\n\n<details>\n<summary>Code owner commands</summary>\n\n\nCode owners of `imap` can trigger bot actions by commenting:\n\n- `@home-assistant close` Closes the issue.\n- `@home-assistant rename Awesome new title` Renames the issue.\n- `@home-assistant reopen` Reopen the issue.\n- `@home-assistant unassign imap` Removes the current integration label and assignees on the issue, add the integration domain after the command.\n- `@home-assistant add-label needs-more-information` Add a label (needs-more-information, problem in dependency, problem in custom component) to the issue.\n- `@home-assistant remove-label needs-more-information` Remove a label (needs-more-information, problem in dependency, problem in custom component) on the issue.\n\n</details>\n\n\n<sub><sup>(message by CodeOwnersMention)</sup></sub>\n\n---\n\n[imap documentation](https://www.home-assistant.io/integrations/imap)\n[imap source](https://github.com/home-assistant/core/tree/dev/homeassistant/components/imap)\n<sub><sup>(message by IssueLinks)</sup></sub>\nNot seeing that with my own IMAP sensors:\r\n\r\n![image](https://github.com/user-attachments/assets/2740d5f8-2d2f-4c19-ae3e-31d6ee214291)\r\n\r\n\r\nNot sure what happens. You could turn on debug logging to see the last received message. When there are no unread messages it should not use another filter. Possible you have some old unread messages?\nSorry I forgot to mention that I also have another sensor with the same integration for my gmail, there I don't see the same behavior so I suppose it has to do with icloud email somehow.\r\n\r\nNo I can't find any old unread emails, not in inbox and not in any other folder either.\r\n\r\n```\r\n2024-12-02 10:11:01.443 DEBUG (MainThread) [homeassistant.components.imap.coordinator] Finished fetching imap data in 0.342 seconds (success: True)\r\n2024-12-02 10:11:07.148 DEBUG (MainThread) [aioimaplib.aioimaplib] Received : b'* 1 FETCH (UID 343 FLAGS (\\\\Deleted))\\r\\n'\r\n2024-12-02 10:11:07.148 INFO (MainThread) [aioimaplib.aioimaplib] ignored untagged response : b'1 FETCH (UID 343 FLAGS (\\\\Deleted))'\r\n2024-12-02 10:11:11.100 DEBUG (MainThread) [aioimaplib.aioimaplib] Sending : b'PACE98889 NOOP\\r\\n'\r\n2024-12-02 10:11:11.270 DEBUG (MainThread) [aioimaplib.aioimaplib] Received : b'* 1 EXPUNGE\\r\\nPACE98889 OK NOOP completed (took 2 ms)\\r\\n'\r\n2024-12-02 10:11:11.271 DEBUG (MainThread) [aioimaplib.aioimaplib] tagged status b'PACE98889 OK NOOP completed (took 2 ms)'\r\n2024-12-02 10:11:11.271 DEBUG (MainThread) [aioimaplib.aioimaplib] Sending : b'PACE98890 SEARCH CHARSET utf-8 UnSeen UnDeleted\\r\\n'\r\n2024-12-02 10:11:11.447 DEBUG (MainThread) [aioimaplib.aioimaplib] Received : b'PACE98890 OK SEARCH completed (took 2 ms)\\r\\n'\r\n2024-12-02 10:11:11.447 DEBUG (MainThread) [aioimaplib.aioimaplib] tagged status b'PACE98890 OK SEARCH completed (took 2 ms)'\r\n2024-12-02 10:11:11.448 DEBUG (MainThread) [aioimaplib.aioimaplib] Sending : b'PACE98891 FETCH ms) BODY.PEEK[]\\r\\n'\r\n2024-12-02 10:11:11.614 DEBUG (MainThread) [aioimaplib.aioimaplib] Received : b'PACE98891 BAD Parse Error (took 0 ms)\\r\\n'\r\n2024-12-02 10:11:11.615 DEBUG (MainThread) [aioimaplib.aioimaplib] tagged status b'PACE98891 BAD Parse Error (took 0 ms)'\r\n2024-12-02 10:11:11.615 DEBUG (MainThread) [homeassistant.components.imap.coordinator] Finished fetching imap data in 0.515 seconds (success: True)\r\n```\r\nWhen I turn on debug this is what happens when I delete or mark as read the last unread mail in inbox. \r\nThere is some bad parse error and ingnored untagged response that is not there as long as there is any unread.\r\n\r\n```\r\n2024-12-02 10:11:01.101 DEBUG (MainThread) [aioimaplib.aioimaplib] Sending : b'PACE98887 NOOP\\r\\n'\r\n2024-12-02 10:11:01.270 DEBUG (MainThread) [aioimaplib.aioimaplib] Received : b'PACE98887 OK NOOP completed (took 1 ms)\\r\\n'\r\n2024-12-02 10:11:01.270 DEBUG (MainThread) [aioimaplib.aioimaplib] tagged status b'PACE98887 OK NOOP completed (took 1 ms)'\r\n2024-12-02 10:11:01.270 DEBUG (MainThread) [aioimaplib.aioimaplib] Sending : b'PACE98888 SEARCH CHARSET utf-8 UnSeen UnDeleted\\r\\n'\r\n2024-12-02 10:11:01.442 DEBUG (MainThread) [aioimaplib.aioimaplib] Received : b'* SEARCH 1\\r\\nPACE98888 OK SEARCH completed (took 1 ms)\\r\\n'\r\n2024-12-02 10:11:01.442 DEBUG (MainThread) [aioimaplib.aioimaplib] tagged status b'PACE98888 OK SEARCH completed (took 1 ms)'\r\n2024-12-02 10:11:01.443 DEBUG (MainThread) [homeassistant.components.imap.coordinator] Finished fetching imap data in 0.342 seconds (success: True)\r\n```\nHmm, that is weird. What email provider do you use, is there a way I can test / reproduce this?\nThe ones that gives this issue is Apple iCloud. I also have gmail but that one works perfectly fine.\r\n\r\nIt behaves like this as soon as I have 0 unread in inbox, and has been doing so since I set it up.\nRight, so the debug logging with the search error is when there are no message on an imap icloud sensor\nexactly, the second code snip (without errors) is where I do have an unread email, no errors and repeating over and over.\r\nAs soon as I delete or mark as read the last unread email in the inbox the error message (first code snippet) shows up and state goes to 5.\nCan you turn on debug level logging on `homeassistant.components.imap` then supply logging with on item unread, then the second part of the logging where the items has been read?\nIt might be the search command is not processed correctly or its response is not interpreted correctly.\r\nIt is assumed that a list of UID's is returned. The length off this list is considered the number of messages.\r\nMay be the reponse is different and 5 other elements (may be words) are returned.\n> Can you turn on debug level logging on `homeassistant.components.imap` then supply logging with on item unread, then the second part of the logging where the items has been read?\r\n\r\nIsn't that what I added before? Or am I misunderstanding?\r\n\r\n```\r\n2024-12-02 13:27:58.100 DEBUG (MainThread) [aioimaplib.aioimaplib] Sending : b'PACE101254 NOOP\\r\\n'\r\n2024-12-02 13:27:58.268 DEBUG (MainThread) [aioimaplib.aioimaplib] Received : b'PACE101254 OK NOOP completed (took 1 ms)\\r\\n'\r\n2024-12-02 13:27:58.268 DEBUG (MainThread) [aioimaplib.aioimaplib] tagged status b'PACE101254 OK NOOP completed (took 1 ms)'\r\n2024-12-02 13:27:58.269 DEBUG (MainThread) [aioimaplib.aioimaplib] Sending : b'PACE101255 SEARCH CHARSET utf-8 UnSeen UnDeleted\\r\\n'\r\n2024-12-02 13:27:58.333 DEBUG (MainThread) [aioimaplib.aioimaplib] Received : b'* 2 FETCH (UID 349 FLAGS ())\\r\\n'\r\n2024-12-02 13:27:58.334 INFO (MainThread) [aioimaplib.aioimaplib] ignored untagged response : b'2 FETCH (UID 349 FLAGS ())'\r\n2024-12-02 13:27:58.383 DEBUG (MainThread) [aioimaplib.aioimaplib] Received : b'* 2 FETCH (UID 349 FLAGS ())\\r\\n'\r\n2024-12-02 13:27:58.384 INFO (MainThread) [aioimaplib.aioimaplib] ignored untagged response : b'2 FETCH (UID 349 FLAGS ())'\r\n2024-12-02 13:27:58.441 DEBUG (MainThread) [aioimaplib.aioimaplib] Received : b'* SEARCH 2\\r\\nPACE101255 OK SEARCH completed (took 3 ms)\\r\\n'\r\n2024-12-02 13:27:58.441 DEBUG (MainThread) [aioimaplib.aioimaplib] tagged status b'PACE101255 OK SEARCH completed (took 3 ms)'\r\n2024-12-02 13:27:58.442 DEBUG (MainThread) [aioimaplib.aioimaplib] Sending : b'PACE101256 FETCH 2 BODY.PEEK[]\\r\\n'\r\n2024-12-02 13:27:58.468 DEBUG (MainThread) [aioimaplib.aioimaplib] Received : b'* 2 FETCH (UID 349 FLAGS ())\\r\\n'\r\n2024-12-02 13:27:58.468 INFO (MainThread) [aioimaplib.aioimaplib] ignored untagged response : b'2 FETCH (UID 349 FLAGS ())'\r\n2024-12-02 13:27:58.772 DEBUG (MainThread) [aioimaplib.aioimaplib] Received : b'* 2 FETCH (BODY[] {12377}\\r\\nReturn-path: <010201938752a454-a3985506-a146-4a78-bb6a-4538fab27142-000000@aws-ses.verisure.com>\\r\\nOriginal-recipient: rfc822;REDACTED@icloud.com\\r\\nReceived: from p00-icloudmta-smtpin-us-central-1n-100-percent-11 by p103-mailgateway-smtp-7548596999-tvwrq (mailgateway 2429B41)\\r\\n\\twith SMTP id 11f979e6-79d7-4492-958b-c74588070a72 \\r\\n\\tfor <REDACTED@icloud.com>; Mon, 2 Dec 2024 12:22:49 GMT\\r\\nX-ICLOUD-MAIL-BWL: 1\\r\\nX-Apple-MoveToFolder: INBOX \\r\\nX-Apple-Action: WL/INBOX\\r\\nX-Apple-UUID: 11f979e6-79d7-4492-958b-c74588070a72\\r\\nReceived: from a3-4.smtp-out.eu-west-1.amazonses.com (a3-4.smtp-out.eu-west-1.amazonses.com [54.240.3.4])\\r\\n\\tby p00-icloudmta-smtpin-us-central-1n-100-percent-11.p00-icloudmta-smtpin-vip.icloud-mail-production.svc.kube.us-central-1n.k8s.cloud.apple.com (Postfix) with ESMTPS id F22C5C0670F\\r\\n\\tfor <REDACTED@icloud.com>; Mon,  2 Dec 2024 12:22:42 +0000 (UTC)\\r\\nX-ICL-Info: GAtbRFYDBVFFSlVESwQEUVUKE0oWX1gHVQoPB0UFAkxHTVZZSx4CQhAdW0dJAARSREBVT08FBANBTFJaGQMPWkBMVkFVUQdWQ1RSFk8IGwAXTwdaTAUFWhMYBEVPAQJQWElWR0gABiIUDhVaC1VFTAMcFB4LRUQHWxoJGlhWUl8DHBQeC0VEB1saCRpYQlVfEBgBGx1DQgEZGA8FOFlVDhoMAlkbX1tCHRwKGEVRBU9BVxUaDEAbDQANSBINHUEHBg1LRlZRWwMPFggEHUMYARoURgcMQgsDRlRSWQtdQhJYFhMDVlVDTwIcFQNVARgDGBgcGBZDUxFbGgkaWFRSXwMcFB4LRUQHWxoJGkNRWwMPFggEHUMYARoURhoRVAteRUhWRUgBD1FNTlNFGQQDVlgYVU5ABQNSQ1QHRkwGG1YUTl5aGlIAA1hNU0RAVlcAR05XQ0odBlJFSVZHOFVDTwIcFQNVARgDGBgcGBZDUxFbGgkaRg==\\r\\nX-ICL-Score: 3.33303333423\\r\\nAuthentication-Results: bimi.icloud.com; bimi=none\\r\\nX-ARC-Info: policy=fail; arc=none\\r\\nAuthentication-Results: arc.icloud.com; arc=none\\r\\nAuthentication-Results: dmarc.icloud.com; dmarc=pass header.from=verisure.com\\r\\nX-DMARC-Policy: v=DMARC1; p=reject; rua=mailto:dmarc_rua@emaildefense.proofpoint.com; ruf=mailto:dmarc_ruf@emaildefense.proofpoint.com;fo=1\\r\\nX-DMARC-Info: pass=pass; dmarc-policy=reject; s=r1; d=r1; pdomain=verisure.com\\r\\nAuthentication-Results: dkim-verifier.icloud.com;\\r\\n\\tdkim=pass (1024-bit key) header.d=verisure.com header.i=@verisure.com header.b=kbNnj4Cq\\r\\nAuthentication-Results: dkim-verifier.icloud.com;\\r\\n\\tdkim=pass (1024-bit key) header.d=amazonses.com header.i=@amazonses.com header.b=Uchri0j3\\r\\nAuthentication-Results: spf.icloud.com; spf=pass (spf.icloud.com: domain of 010201938752a454-a3985506-a146-4a78-bb6a-4538fab27142-000000@aws-ses.verisure.com designates 54.240.3.4 as permitted sender) smtp.mailfrom=010201938752a454-a3985506-a146-4a78-bb6a-4538fab27142-000000@aws-ses.verisure.com\\r\\nReceived-SPF: pass (spf.icloud.com: domain of 010201938752a454-a3985506-a146-4a78-bb6a-4538fab27142-000000@aws-ses.verisure.com designates 54.240.3.4 as permitted sender) receiver=spf.icloud.com; client-ip=54.240.3.4; helo=a3-4.smtp-out.eu-west-1.amazonses.com; envelope-from=010201938752a454-a3985506-a146-4a78-bb6a-4538fab27142-000000@aws-ses.verisure.com\\r\\nDKIM-Signature: v=1; a=rsa-sha256; q=dns/txt; c=relaxed/simple;\\r\\n\\ts=3yt544ffglpcwye6h6aqnsje5ljfufmk; d=verisure.com; t=1733142160;\\r\\n\\th=Date:From:To:Message-ID:Subject:MIME-Version:Content-Type:Content-Transfer-Encoding;\\r\\n\\tbh=kdYjOo1yfe3mfUDTFkdECkueJiyjxFK5azv/1y0X5KM=;\\r\\n\\tb=kbNnj4CqOWvo7gXNkux/e4wB5OLRVdLerhB59CxQm+JacMacJT/OM+3TGCp8BNQu\\r\\n\\tLai6IU/1GsHOLCChy48iUaqvBXj7C6774KsyYjg6KfoEDvloNeJ1dCO+QhCYgMKT877\\r\\n\\tlA839nmdv++VziPfjl8xtIGum5eMwmmwEIMcae2c=\\r\\nDKIM-Signature: v=1; a=rsa-sha256; q=dns/txt; c=relaxed/simple;\\r\\n\\ts=uku4taia5b5tsbglxyj6zym32efj7xqv; d=amazonses.com; t=1733142160;\\r\\n\\th=Date:From:To:Message-ID:Subject:MIME-Version:Content-Type:Content-Transfer-Encoding:Feedback-ID;\\r\\n\\tbh=kdYjOo1yfe3mfUDTFkdECkueJiyjxFK5azv/1y0X5KM=;\\r\\n\\tb=Uchri0j3U6fJs1fLh88/6tHbOlbFtbESTrO+w54Xv0rOElGOhNovPoFfP0BY4NEO\\r\\n\\tdun2Yrwfb+3AHEcHjv/wuk/pq4LYCS4+VjhA+dqiTYvXrIRVw1tXeU1wWYBJw/SSewS\\r\\n\\ts9y/vzHVRFClmAD3KLn66f+dAby2rq4lx1UCLAgs=\\r\\nDate: Mon, 2 Dec 2024 12:22:40 +0000\\r\\nFrom: Verisure <no-reply@verisure.com>\\r\\nTo: REDACTED@icloud.com\\r\\nMessage-ID: <010201938752a454-a3985506-a146-4a78-bb6a-4538fab27142-000000@eu-west-1.amazonses.com>\\r\\nSubject: =?UTF-8?Q?Uppl=C3=A5st_inifr=C3=A5n?=\\r\\nMIME-Version: 1.0\\r\\nContent-Type: text/html;charset=UTF-8\\r\\nContent-Transfer-Encoding'\r\n2024-12-02 13:27:58.774 DEBUG (MainThread) [aioimaplib.aioimaplib] Received : b': quoted-printable\\r\\nFeedback-ID: ::1.eu-west-1.jExQklJ3NsHCig4dbI7BLuXzs52tdLVbdwH/fnDv3iU=:AmazonSES\\r\\nX-SES-Outgoing: 2024.12.02-54.240.3.4\\r\\nX-MANTSH: 1TFkXGxoaGhEKWUQXYX1ae0JYbBxubG8RCllNF3pPWFlFREtGa0ZGRV0RCl9ZFxs\\r\\n TEQpfTRdkRURPEQpZSRcacRoQGncGGx9xHBobEB4YHHcGHgYaEQpZXhdsbHkRCkNOFxlkewdQb\\r\\n H5HQRJkUxNfZGJadVAZaR5pTW5FQkEfGktMEQpYXBcZBBoEHxoFGxoaBB0aBBsTEgQbHBAbHho\\r\\n fGhEKXlkXT00aWV8RCk1cFxgcGBEKTFoXaWhtWk1NEQpNThdoaBEKTEYXTWsRCkNaFx8eBBgeG\\r\\n gQZBB4RCkJeFxsRCkJcFxsRCl5OFxsRCkJLF2BbWVB+HURcfltrEQpCSRdgW1lQfh1EXH5baxE\\r\\n KQkUXa3N/X18BbkJZWk4RCkJOF2BbWVB+HURcfltrEQpCTBdieAVBQWZIbRtzaREKQmwXZ0dLX\\r\\n WBue3N8U1kRCkJAF2lmZ1xZXmVAR09iEQpCWBd6SUZjQ15DYURIGREKWlgXEhEKcGgXZFlgW3o\\r\\n aaBN8Hx0QGRoRCnBoF2VQY1NQRWwYbBNQEBoRCnBoF2RtawFIc0ZyZRxsEAcbEhEKcGgXbU5kf\\r\\n 2R8Y2xGck4QBxsSEQpwaBdgWm1HX29zQWMTTRAHGxIRCnBoF2RMRW57YmlzRGd/EAcbEhEKcGg\\r\\n XYBt4awVTSBNdc2gQGhEKcGgXZ1BCR1NZaxJBch0QBxsSEQpwfxdtQ2VkGGZITWF/GhAHHRMRC\\r\\n nBfF2VkYGhlSU1bWgFvEAcSGBEKcH0XYBJBbUVbaUYfGl0QBxsbEhEKcH8XYBoSaUN5YB1IGk8\\r\\n QBx4aEQpwXxdkaXoaHB4eXwFtcxAHGxIRCnB9F2FoS05ocB9rb0llEAcbEhEKcF8Xa3kefGxOH\\r\\n 1wBYX0QBxsSEQpwfRdvTFtzG1NGXEhBehAHGxIRCnB/F2diQn5DG1JbS2FHEBoRCnBfF2ZZXkl\\r\\n beURwT19nEAcbEhEKcH0XawFMfU5QHEN9eHkQBxsSEQpwXxdgUnNTeh96bV0YGBAHGxIRCnB9F\\r\\n 2BSc1N6H3ptXRgYEAcbEhEKcH8XZm19QgVnaWFkRlsQBxIYEQpwXxdvQhgSeWFtc2NJExAHGxI\\r\\n RCnB9F2ljTmwTeEdQeUJdEAcbEhEKcF8XaRxPQWtCGBNLYFwQBxsSEQpwfRdvaH5eTkdaU2cTH\\r\\n xAHGxIRCnB/F29EYVASE38bHBJ+EAcTGxEKcF8XbB1Jc3BQaUgFYUcQBxIeEQpwfRdvGAViQn5\\r\\n vUmgZWBAHGxIRCnBfF2ViWm9ich0TWW1yEAcbEhEKcH0XYGx4XFJBfnBbUE4QBxsSEQpwbBdnG\\r\\n n5BY1JvZEQFExAHHRsRCm1+FxoRClhNF0sR\\r\\nX-Proofpoint-ORIG-GUID: 3NQ-zFTmk8Ny9uNHp_z3C4CgDohk50af\\r\\nX-Proofpoint-GUID: 3NQ-zFTmk8Ny9uNHp_z3C4CgDohk50af\\r\\nX-Authority-Info: v=2.4 cv=AYHjHGXG c=1 sm=1 tr=0 ts=674da693 b=1 cx=c_pps a=p82mOsv/gcnbQNwSku8EhA==:117 a=p82mOsv/gcnbQNwSku8EhA==:17 a=IkcTkHD0fZMA:10 a=RZcAm9yDv7YA:10 a=Hgn-wnRn1-cA:10 a=5KLPUuaC_9wA:10 a=tLYPQTZOJK4A:10 a=YFHz6ByJM4cA:10 a=g8TUdU_LZmEA:10 a=3g80flMcAAAA:8 a=3mGz-6hrAAAA:8 a=NUWrXTziAAAA:8 a=t-IPkPogAAAA:8 a=1XWaLZrsAAAA:8 a=dkqJ-qE5Hu04xti5B2gA:9 a=KOEDDpSzhS9tyghv:21 a=_W_S_7VecoQA:10 a=lqcHg5cX4UMA:10 a=QEXdDO2ut3YA:10 a=O23WzTs1fjcA:10 a=Kl61tIc_S7pjS278E8k4:22 a=3urWGuTZa-U-TZ_dHwj2:22 a=_r3JdlzVTz_TzSp0BUuH:22 a=4RA0bdID1wfY3PaYaTkR:22\\r\\n\\r\\n<!DOCTYPE html PUBLIC \"-//W3C//DTD HTML 4.01 Transitional//EN\" \"http://www.=\\r\\nw3.org/TR/html4/loose.dtd\">\\r\\n\\r\\n<html>\\r\\n  <head>\\r\\n    <meta http-equiv=3D\"Content-Type\" content=3D\"text/html; charset=3Dutf-8=\\r\\n\" />\\r\\n    <link\\r\\n      href=3D\"https://fonts.googleapis.com/css?family=3DFira+Sans\"\\r\\n      rel=3D\"stylesheet\"\\r\\n    />\\r\\n    <title></title>\\r\\n    <style>\\r\\n      body {\\r\\n        background: #ffffff;\\r\\n        -webkit-text-size-adjust: none;\\r\\n      }\\r\\n\\r\\n      h1 {\\r\\n        color: #292929 !important;\\r\\n        font-size: 24px;\\r\\n        font-weight: normal;\\r\\n      }\\r\\n\\r\\n      h2 {\\r\\n        font-size: 14px;\\r\\n        font-weight: 500;\\r\\n        line-height: 20px;\\r\\n        color: #292929 !important;\\r\\n      }\\r\\n\\r\\n      a {\\r\\n        color: #ff0033 !important;\\r\\n        text-decoration: none;\\r\\n      }\\r\\n\\r\\n      td {\\r\\n        padding: 0 16px;\\r\\n      }\\r\\n\\r\\n      * {\\r\\n        margin: 0;\\r\\n      }\\r\\n\\r\\n      .main-table {\\r\\n        width: 100%;\\r\\n        max-width: 620px;\\r\\n        margin: 0 auto;\\r\\n        border: 0;\\r\\n        font-family: \\'Fira Sans\\', sans-serif !important;\\r\\n        color: #7f7f7f !important;\\r\\n        font-size: 14px;\\r\\n        line-height: 24px;\\r\\n      }\\r\\n\\r\\n      /* im class used by Gmail to mark text in a thread - defaults to purp=\\r\\nle color */\\r\\n      .im {\\r\\n        color: #7f7f7f !important;\\r\\n      }\\r\\n\\r\\n      .footer-table {\\r\\n        width: 100%;\\r\\n        max-width: 620px;\\r\\n        margin: 0 auto;\\r\\n        border: 0;\\r\\n        font-family: \\'Fira Sans\\', sans-serif !important;\\r\\n        color: #7f7f7f !important;\\r\\n        font-size: 12px;\\r\\n        line-height: 24px;\\r\\n        background-color: #efefef;\\r\\n      }\\r\\n\\r\\n      .button {\\r\\n        border-radius: 3px;\\r\\n        background: white;\\r\\n        height: 40px;\\r\\n        color: #ff0033 !important;\\r\\n        border: 1px solid #dfdfdf;\\r\\n        padding: 0 16px;\\r\\n        text-decoration: none;\\r\\n        display: inline-block;\\r\\n        line-height: 40px;\\r\\n      }\\r\\n\\r\\n      .button:hover,\\r\\n      .button:active,\\r\\n      .button:focus {\\r\\n        background: #e9e9e9 !important;\\r\\n      }\\r\\n\\r\\n      @media only screen and (max-device-width: 480px) {\\r\\n        table[class=3D\\'table\\'],\\r\\n        td[class=3D\\'cell\\'] {\\r\\n          max-width: 300px !important;\\r\\n        }\\r\\n        table[class=3D\\'wide\\'],\\r\\n        img[class=3D\\'wide\\'],\\r\\n        td[class=3D\\'wide\\'] {\\r\\n          display: none !important;\\r\\n        }\\r\\n      }\\r\\n    </style>\\r\\n  </head>\\r\\n  <body>\\r\\n    <table class=3D\"main-table\" cellspacing=3D\"0\">\\r\\n      <!-- LOGO -->\\r\\n      <tr>\\r\\n        <td style=3D\"padding-top: 32px;\">\\r\\n          <img\\r\\n            src=3D\"https://mypages.verisure.com/img/email/verisure_logo_tra=\\r\\nnsparent.png\"\\r\\n            alt=3D\"Verisure\"\\r\\n            title=3D\"Verisure\"\\r\\n            id=3D\"verisure\"\\r\\n            height=3D\"40\"\\r\\n          />\\r\\n        </td>\\r\\n      </tr>\\r\\n\\r\\n      <!-- TITLE -->\\r\\n      <tr>\\r\\n        <td>\\r\\n          <h1\\r\\n            style=3D\"margin-top:42px; margin-bottom: 21px;  color: #292929;=\\r\\n font-size: 24px; font-weight: normal;\"\\r\\n          >\\r\\n            Uppl=C3=A5st inifr=C3=A5n\\r\\n          </h1>\\r\\n        </td>\\r\\n      </tr>\\r\\n      <!-- GREETING -->\\r\\n      <tr>\\r\\n        <td>\\r\\n          <p style=3D\"margin-bottom: 21px;\">\\r\\n=09=09=09=09      Groventr=C3=A9 - Grankullegatan 60\\r\\n          </p>\\r\\n        </td>\\r\\n      </tr>\\r\\n      <!-- EMAIL CONTENT -->\\r\\n      <tr>\\r\\n        <td>\\r\\n          Smart l=C3=A5s Groventr=C3=A9, Grankullegatan l=C3=A5stes upp med=\\r\\n vred fr=C3=A5n insidan.\\r\\n        </td>\\r\\n      </tr>\\r\\n      <!-- SENDER TEXT-->\\r\\n      <tr>\\r\\n        <td>\\r\\n            <p style=3D\"margin-bottom: 21px; margin-top:21px\">\\r\\n              V=C3=A4nliga h=C3=A4lsningar\\r\\n              <br/>\\r\\n              Verisure\\r\\n           </p>\\r\\n        </td>\\r\\n      </tr>\\r\\n      <!-- FINAL NOTE-->\\r\\n    </table>\\r\\n\\r\\n    <!-- FOOTER -->\\r\\n    <table class=3D\"footer-table\" cellspacing=3D\"0\">\\r\\n      <tr>\\r\\n        <td\\r\\n          valign=3D\"top\"\\r\\n          style=3D\"padding: 16px; box-sizing: border-box; width: 100%;\"\\r\\n        >\\r\\n          <h2>Kundtj=C3=A4nst</h2>\\r\\n          <a style=3D\"display: block;\" href=3D\"tel:020724365\">\\r\\n            <img\\r\\n              src=3D\"https://mypages.verisure.com/img/email/IC_Phone.png\"\\r\\n              alt=3D\"phone\"\\r\\n              height=3D\"12\"\\r\\n              style=3D\"margin-right: 8px; vertical-align: middle; width: 12=\\r\\npx;\"\\r\\n            />\\r\\n            020-724365\\r\\n          </a>\\r\\n          <h2 style=3D\"margin-top: 16px;\">\\r\\n            Snabbl=C3=A4nkar\\r\\n          </h2>\\r\\n          <a\\r\\n            style=3D\"display:block;\"\\r\\n            href=3D\"https://www.verisure.se/\"\\r\\n            target=3D\"_blank\"\\r\\n            >Hemsida</a\\r\\n          >\\r\\n          <a\\r\\n            style=3D\"display:block;\"\\r\\n            href=3D\"https://mypages.verisure.com/se/\"\\r\\n            target=3D\"_blank\"\\r\\n            >Mina Sidor</a\\r\\n          >\\r\\n        </td>\\r\\n        <td style=3D\"vertical-align: top; padding:16px; text-align: right;\"=\\r\\n>\\r\\n          <a\\r\\n            style=3D\"display:block; margin-bottom: 8px;\"\\r\\n            href=3D\"https://itunes.apple.com/se/app/verisure/id423747572?mt=\\r\\n=3D8\"\\r\\n          >\\r\\n            <img\\r\\n              src=3D\"https://mypages.verisure.com/img/appstores/apple_se.pn=\\r\\ng\"\\r\\n              alt=3D\"App store\"\\r\\n              width=3D\"96\"\\r\\n              style=3D\"max-height: 40px\"\\r\\n            />\\r\\n          </a>\\r\\n          <a\\r\\n            style=3D\"display:block; margin-bottom: 8px;\"\\r\\n            href=3D\"https://play.google.com/store/apps/details?id=3Dcom.sdi=\\r\\n.mobile.android.verisure\"\\r\\n          >\\r\\n            <img\\r\\n              src=3D\"https://mypages.verisure.com/img/appstores/google_se.p=\\r\\nng\"\\r\\n              alt=3D\"Google Play\"\\r\\n              width=3D\"96\"\\r\\n              style=3D\"max-height: 40px\"\\r\\n            />\\r\\n          </a>\\r\\n        </td>\\r\\n      </tr>\\r\\n      <tr>\\r\\n        <td colspan=3D\"2\">\\r\\n          <hr style=3D\"border:1px solid #DFDFDF; \" />\\r\\n          <p style=3D\"margin-top:12px;margin-bottom: 16px;\">\\r\\n            &#169; 2024 Samtliga r=C3=A4ttigheter tillh=C3=B6r Verisure\\r\\n          </p>\\r\\n        </td>\\r\\n      </tr>\\r\\n    </table>\\r\\n  </body>\\r\\n</html>\\r\\n)\\r\\nPACE101256 OK FETCH completed (took 164 ms)\\r\\n'\r\n2024-12-02 13:27:58.775 DEBUG (MainThread) [aioimaplib.aioimaplib] tagged status b'PACE101256 OK FETCH completed (took 164 ms)'\r\n2024-12-02 13:27:58.777 DEBUG (MainThread) [homeassistant.components.imap.coordinator] Message with id 2 (<010201938752a454-a3985506-a146-4a78-bb6a-4538fab27142-000000@eu-west-1.amazonses.com>) processed, sender: no-reply@verisure.com, subject: Uppl\u00e5st inifr\u00e5n, initial: False\r\n2024-12-02 13:27:58.778 DEBUG (MainThread) [homeassistant.components.imap.coordinator] Finished fetching imap data in 0.677 seconds (success: True)\r\n2024-12-02 13:28:09.101 DEBUG (MainThread) [aioimaplib.aioimaplib] Sending : b'PACE101257 NOOP\\r\\n'\r\n2024-12-02 13:28:09.271 DEBUG (MainThread) [aioimaplib.aioimaplib] Received : b'PACE101257 OK NOOP completed (took 1 ms)\\r\\n'\r\n2024-12-02 13:28:09.271 DEBUG (MainThread) [aioimaplib.aioimaplib] tagged status b'PACE101257 OK NOOP completed (took 1 ms)'\r\n2024-12-02 13:28:09.272 DEBUG (MainThread) [aioimaplib.aioimaplib] Sending : b'PACE101258 SEARCH CHARSET utf-8 UnSeen UnDeleted\\r\\n'\r\n2024-12-02 13:28:09.442 DEBUG (MainThread) [aioimaplib.aioimaplib] Received : b'* SEARCH 2\\r\\nPACE101258 OK SEARCH completed (took 2 ms)\\r\\n'\r\n2024-12-02 13:28:09.442 DEBUG (MainThread) [aioimaplib.aioimaplib] tagged status b'PACE101258 OK SEARCH completed (took 2 ms)'\r\n2024-12-02 13:28:09.443 DEBUG (MainThread) [homeassistant.components.imap.coordinator] Finished fetching imap data in 0.342 seconds (success: True)\r\n2024-12-02 13:28:19.101 DEBUG (MainThread) [aioimaplib.aioimaplib] Sending : b'PACE101259 NOOP\\r\\n'\r\n2024-12-02 13:28:19.292 DEBUG (MainThread) [aioimaplib.aioimaplib] Received : b'PACE101259 OK NOOP completed (took 12 ms)\\r\\n'\r\n2024-12-02 13:28:19.292 DEBUG (MainThread) [aioimaplib.aioimaplib] tagged status b'PACE101259 OK NOOP completed (took 12 ms)'\r\n2024-12-02 13:28:19.293 DEBUG (MainThread) [aioimaplib.aioimaplib] Sending : b'PACE101260 SEARCH CHARSET utf-8 UnSeen UnDeleted\\r\\n'\r\n2024-12-02 13:28:19.464 DEBUG (MainThread) [aioimaplib.aioimaplib] Received : b'* SEARCH 2\\r\\nPACE101260 OK SEARCH completed (took 1 ms)\\r\\n'\r\n2024-12-02 13:28:19.464 DEBUG (MainThread) [aioimaplib.aioimaplib] tagged status b'PACE101260 OK SEARCH completed (took 1 ms)'\r\n2024-12-02 13:28:19.465 DEBUG (MainThread) [homeassistant.components.imap.coordinator] Finished fetching imap data in 0.364 seconds (success: True)\r\n2024-12-02 13:28:24.180 DEBUG (MainThread) [aioimaplib.aioimaplib] Received : b'* 2 FETCH (UID 349 FLAGS (\\\\Seen))\\r\\n'\r\n2024-12-02 13:28:24.180 INFO (MainThread) [aioimaplib.aioimaplib] ignored untagged response : b'2 FETCH (UID 349 FLAGS (\\\\Seen))'\r\n2024-12-02 13:28:24.223 DEBUG (MainThread) [aioimaplib.aioimaplib] Received : b'* 2 FETCH (UID 349 FLAGS (\\\\Seen))\\r\\n'\r\n2024-12-02 13:28:24.223 INFO (MainThread) [aioimaplib.aioimaplib] ignored untagged response : b'2 FETCH (UID 349 FLAGS (\\\\Seen))'\r\n2024-12-02 13:28:24.591 DEBUG (MainThread) [aioimaplib.aioimaplib] Received : b'* 2 FETCH (UID 349 FLAGS (\\\\Seen))\\r\\n'\r\n2024-12-02 13:28:24.591 INFO (MainThread) [aioimaplib.aioimaplib] ignored untagged response : b'2 FETCH (UID 349 FLAGS (\\\\Seen))'\r\n2024-12-02 13:28:29.101 DEBUG (MainThread) [aioimaplib.aioimaplib] Sending : b'PACE101261 NOOP\\r\\n'\r\n2024-12-02 13:28:29.283 DEBUG (MainThread) [aioimaplib.aioimaplib] Received : b'PACE101261 OK NOOP completed (took 8 ms)\\r\\n'\r\n2024-12-02 13:28:29.283 DEBUG (MainThread) [aioimaplib.aioimaplib] tagged status b'PACE101261 OK NOOP completed (took 8 ms)'\r\n2024-12-02 13:28:29.283 DEBUG (MainThread) [aioimaplib.aioimaplib] Sending : b'PACE101262 SEARCH CHARSET utf-8 UnSeen UnDeleted\\r\\n'\r\n2024-12-02 13:28:29.453 DEBUG (MainThread) [aioimaplib.aioimaplib] Received : b'PACE101262 OK SEARCH completed (took 1 ms)\\r\\n'\r\n2024-12-02 13:28:29.453 DEBUG (MainThread) [aioimaplib.aioimaplib] tagged status b'PACE101262 OK SEARCH completed (took 1 ms)'\r\n2024-12-02 13:28:29.453 DEBUG (MainThread) [aioimaplib.aioimaplib] Sending : b'PACE101263 FETCH ms) BODY.PEEK[]\\r\\n'\r\n2024-12-02 13:28:29.621 DEBUG (MainThread) [aioimaplib.aioimaplib] Received : b'PACE101263 BAD Parse Error (took 0 ms)\\r\\n'\r\n2024-12-02 13:28:29.622 DEBUG (MainThread) [aioimaplib.aioimaplib] tagged status b'PACE101263 BAD Parse Error (took 0 ms)'\r\n2024-12-02 13:28:29.622 DEBUG (MainThread) [homeassistant.components.imap.coordinator] Finished fetching imap data in 0.521 seconds (success: True)\r\n```\r\n\r\nHere is the debug log when an unread message is found and then when it is marked as read.\r\nThe sensor then goes from 1 to 5 when there is no unread message anymore.\nFrom what point in the logging was the last message marked as read?\nIt seems it tries to fetch `ms)` instead of  a uid.\r\n\r\nIn response: `PACE101262 OK SEARCH completed (took 1 ms)`\r\nIt seems to be a last part of a response\r\n\n\r\n\r\n\r\n\r\n> From what point in the logging was the last message marked as read?\r\n\r\nFrom the INFO-messages I would say, last 15 lines. Where the bad parse lines show up.\nSeem my edited last response: https://github.com/home-assistant/core/issues/132042#issuecomment-2511455874\nHello, I did attempt to reproduce it on Gmail, but I didn't got issue. iCloud Mail should be used to test it.\r\n", "created_at": "2024-12-02T14:56:47Z"}
{"repo": "home-assistant/core", "pull_number": 132080, "instance_id": "home-assistant__core-132080", "issue_numbers": ["132067"], "base_commit": "d7cdb357dc27547b85b48febbeef5b1d8f811db6", "patch": "diff --git a/homeassistant/components/trend/binary_sensor.py b/homeassistant/components/trend/binary_sensor.py\nindex 681680f180fb0..9691ecf0744a9 100644\n--- a/homeassistant/components/trend/binary_sensor.py\n+++ b/homeassistant/components/trend/binary_sensor.py\n@@ -227,10 +227,15 @@ def trend_sensor_state_listener(\n                     state = new_state.attributes.get(self._attribute)\n                 else:\n                     state = new_state.state\n-                if state not in (STATE_UNKNOWN, STATE_UNAVAILABLE):\n+\n+                if state in (STATE_UNKNOWN, STATE_UNAVAILABLE):\n+                    self._attr_available = False\n+                else:\n+                    self._attr_available = True\n                     sample = (new_state.last_updated.timestamp(), float(state))  # type: ignore[arg-type]\n                     self.samples.append(sample)\n-                    self.async_schedule_update_ha_state(True)\n+\n+                self.async_schedule_update_ha_state(True)\n             except (ValueError, TypeError) as ex:\n                 _LOGGER.error(ex)\n \n", "test_patch": "diff --git a/tests/components/trend/test_binary_sensor.py b/tests/components/trend/test_binary_sensor.py\nindex ad85f65a9fce8..4a829bb86d253 100644\n--- a/tests/components/trend/test_binary_sensor.py\n+++ b/tests/components/trend/test_binary_sensor.py\n@@ -9,7 +9,7 @@\n \n from homeassistant import setup\n from homeassistant.components.trend.const import DOMAIN\n-from homeassistant.const import STATE_OFF, STATE_ON, STATE_UNKNOWN\n+from homeassistant.const import STATE_OFF, STATE_ON, STATE_UNAVAILABLE, STATE_UNKNOWN\n from homeassistant.core import HomeAssistant, State\n from homeassistant.helpers import device_registry as dr, entity_registry as er\n from homeassistant.setup import async_setup_component\n@@ -395,3 +395,45 @@ async def test_device_id(\n     trend_entity = entity_registry.async_get(\"binary_sensor.trend\")\n     assert trend_entity is not None\n     assert trend_entity.device_id == source_entity.device_id\n+\n+\n+@pytest.mark.parametrize(\n+    \"error_state\",\n+    [\n+        STATE_UNKNOWN,\n+        STATE_UNAVAILABLE,\n+    ],\n+)\n+async def test_unavailable_source(\n+    hass: HomeAssistant,\n+    config_entry: MockConfigEntry,\n+    freezer: FrozenDateTimeFactory,\n+    setup_component: ComponentSetup,\n+    error_state: str,\n+) -> None:\n+    \"\"\"Test for unavailable source.\"\"\"\n+    await setup_component(\n+        {\n+            \"sample_duration\": 10000,\n+            \"min_gradient\": 1,\n+            \"max_samples\": 25,\n+            \"min_samples\": 5,\n+        },\n+    )\n+\n+    for val in (10, 20, 30, 40, 50, 60):\n+        freezer.tick(timedelta(seconds=2))\n+        hass.states.async_set(\"sensor.test_state\", val)\n+        await hass.async_block_till_done()\n+\n+    assert hass.states.get(\"binary_sensor.test_trend_sensor\").state == \"on\"\n+\n+    hass.states.async_set(\"sensor.test_state\", error_state)\n+    await hass.async_block_till_done()\n+\n+    assert hass.states.get(\"binary_sensor.test_trend_sensor\").state == STATE_UNAVAILABLE\n+\n+    hass.states.async_set(\"sensor.test_state\", 50)\n+    await hass.async_block_till_done()\n+\n+    assert hass.states.get(\"binary_sensor.test_trend_sensor\").state == \"on\"\n", "problem_statement": "Binary trend sensor does Not error on unavailability of source sensor\n### The problem\r\n\r\n<img width=\"951\" alt=\"Scherm\u00adafbeelding 2024-12-02 om 12 24 27\" src=\"https://github.com/user-attachments/assets/74255550-fd05-4f46-a146-09db1354e279\">\r\n\r\nThe Buienradar entity has become unavailable in HA 2024.12 beta,\r\n<img width=\"604\" alt=\"Scherm\u00adafbeelding 2024-12-02 om 13 15 26\" src=\"https://github.com/user-attachments/assets/95cceaaa-d4fd-4786-bea4-a3605f9ac01a\">\r\n\r\n\r\n\r\n but this trend sensor remains being off, as if nothing is blocking its configuration\r\n\r\nIt would be expected that the integration errors on unavailability of its source sensor entity, but logs nothing at all\r\n\r\n### What version of Home Assistant Core has the issue?\r\n\r\n2024.12.0b3\r\n\r\n### What was the last working version of Home Assistant Core?\r\n\r\n_No response_\r\n\r\n### What type of installation are you running?\r\n\r\nHome Assistant OS\r\n\r\n### Integration causing the issue\r\n\r\nTrend\r\n\r\n### Link to integration documentation on our website\r\n\r\nhttps://www.home-assistant.io/integrations/trend/\r\n\r\n### Diagnostics information\r\n\r\n_No response_\r\n\r\n### Example YAML snippet\r\n\r\n_No response_\r\n\r\n### Anything in the logs that might be useful for us?\r\n\r\n_No response_\r\n\r\n### Additional information\r\n\r\nwe can change several options in the UI, but not the source entity:\r\n\r\n\r\n<img width=\"612\" alt=\"Scherm\u00adafbeelding 2024-12-02 om 13 13 22\" src=\"https://github.com/user-attachments/assets/0cdcdad1-fd47-43db-be08-bc13322d5893\">\r\n\r\nso we are left to delete and recreate, or edit core.config_entries\r\n\r\nneither of which are a great UX\n", "hints_text": "\nHey there @jpbede, mind taking a look at this issue as it has been labeled with an integration (`trend`) you are listed as a [code owner](https://github.com/home-assistant/core/blob/dev/CODEOWNERS#L1558) for? Thanks!\n\n<details>\n<summary>Code owner commands</summary>\n\n\nCode owners of `trend` can trigger bot actions by commenting:\n\n- `@home-assistant close` Closes the issue.\n- `@home-assistant rename Awesome new title` Renames the issue.\n- `@home-assistant reopen` Reopen the issue.\n- `@home-assistant unassign trend` Removes the current integration label and assignees on the issue, add the integration domain after the command.\n- `@home-assistant add-label needs-more-information` Add a label (needs-more-information, problem in dependency, problem in custom component) to the issue.\n- `@home-assistant remove-label needs-more-information` Remove a label (needs-more-information, problem in dependency, problem in custom component) on the issue.\n\n</details>\n\n\n<sub><sup>(message by CodeOwnersMention)</sup></sub>\n\n---\n\n[trend documentation](https://www.home-assistant.io/integrations/trend)\n[trend source](https://github.com/home-assistant/core/tree/dev/homeassistant/components/trend)\n<sub><sup>(message by IssueLinks)</sup></sub>", "created_at": "2024-12-02T14:44:48Z"}
{"repo": "home-assistant/core", "pull_number": 132062, "instance_id": "home-assistant__core-132062", "issue_numbers": ["131901"], "base_commit": "3d26fa7864b612d7686519d1701538b35bd08ce7", "patch": "diff --git a/homeassistant/components/acaia/config_flow.py b/homeassistant/components/acaia/config_flow.py\nindex 36727059c8a8a..fb2639fc886df 100644\n--- a/homeassistant/components/acaia/config_flow.py\n+++ b/homeassistant/components/acaia/config_flow.py\n@@ -42,7 +42,7 @@ async def async_step_user(\n         errors: dict[str, str] = {}\n \n         if user_input is not None:\n-            mac = format_mac(user_input[CONF_ADDRESS])\n+            mac = user_input[CONF_ADDRESS]\n             try:\n                 is_new_style_scale = await is_new_scale(mac)\n             except AcaiaDeviceNotFound:\n@@ -53,12 +53,12 @@ async def async_step_user(\n             except AcaiaUnknownDevice:\n                 return self.async_abort(reason=\"unsupported_device\")\n             else:\n-                await self.async_set_unique_id(mac)\n+                await self.async_set_unique_id(format_mac(mac))\n                 self._abort_if_unique_id_configured()\n \n             if not errors:\n                 return self.async_create_entry(\n-                    title=self._discovered_devices[user_input[CONF_ADDRESS]],\n+                    title=self._discovered_devices[mac],\n                     data={\n                         CONF_ADDRESS: mac,\n                         CONF_IS_NEW_STYLE_SCALE: is_new_style_scale,\n@@ -99,10 +99,10 @@ async def async_step_bluetooth(\n     ) -> ConfigFlowResult:\n         \"\"\"Handle a discovered Bluetooth device.\"\"\"\n \n-        self._discovered[CONF_ADDRESS] = mac = format_mac(discovery_info.address)\n+        self._discovered[CONF_ADDRESS] = discovery_info.address\n         self._discovered[CONF_NAME] = discovery_info.name\n \n-        await self.async_set_unique_id(mac)\n+        await self.async_set_unique_id(format_mac(discovery_info.address))\n         self._abort_if_unique_id_configured()\n \n         try:\ndiff --git a/homeassistant/components/acaia/entity.py b/homeassistant/components/acaia/entity.py\nindex 8a2108d26871b..db01b414b9903 100644\n--- a/homeassistant/components/acaia/entity.py\n+++ b/homeassistant/components/acaia/entity.py\n@@ -2,7 +2,7 @@\n \n from dataclasses import dataclass\n \n-from homeassistant.helpers.device_registry import DeviceInfo\n+from homeassistant.helpers.device_registry import DeviceInfo, format_mac\n from homeassistant.helpers.entity import EntityDescription\n from homeassistant.helpers.update_coordinator import CoordinatorEntity\n \n@@ -25,10 +25,11 @@ def __init__(\n         super().__init__(coordinator)\n         self.entity_description = entity_description\n         self._scale = coordinator.scale\n-        self._attr_unique_id = f\"{self._scale.mac}_{entity_description.key}\"\n+        formatted_mac = format_mac(self._scale.mac)\n+        self._attr_unique_id = f\"{formatted_mac}_{entity_description.key}\"\n \n         self._attr_device_info = DeviceInfo(\n-            identifiers={(DOMAIN, self._scale.mac)},\n+            identifiers={(DOMAIN, formatted_mac)},\n             manufacturer=\"Acaia\",\n             model=self._scale.model,\n             suggested_area=\"Kitchen\",\n", "test_patch": "", "problem_statement": "Acaia integration causes aiohttp error when trying to connect with old Acaia Pearl scale\n### The problem\n\nI'm not sure if this scale is even supported, as it's quite old (bought it in 2017), however it's BT name is PROCHBT001 which is listed in the integration manifest, so maybe it is?\r\n\r\nThe scale is not discovered automatically, I tried to add it manually which causes error.\r\n\r\nI have disabled BT in my phone to be 100% sure it's not intercepting the scale connection. I have multiple Shellies with BT proxy enabled and I also tried moving my scale and testing it right next to ESP32 with Esphome 2024.9 installed. There is nothing in ESP logs that would say it tries to connect to the scale.\n\n### What version of Home Assistant Core has the issue?\n\ncore-2024.12.0b2\n\n### What was the last working version of Home Assistant Core?\n\n_No response_\n\n### What type of installation are you running?\n\nHome Assistant OS\n\n### Integration causing the issue\n\nAcaia\n\n### Link to integration documentation on our website\n\nhttps://github.com/home-assistant/core/tree/dev/homeassistant/components/acaia\n\n### Diagnostics information\n\n_No response_\n\n### Example YAML snippet\n\n_No response_\n\n### Anything in the logs that might be useful for us?\n\n```txt\nRejestrator: aiohttp.server\r\n\u0179r\u00f3d\u0142o: /usr/local/lib/python3.13/site-packages/aiohttp/web_protocol.py:450\r\nPierwsze zdarzenie: 10:26:39 (11 zdarzenia)\r\nOstatnio zalogowany: 10:52:39\r\n\r\nError handling request\r\nTraceback (most recent call last):\r\n  File \"/usr/local/lib/python3.13/site-packages/aiohttp/web_protocol.py\", line 479, in _handle_request\r\n    resp = await request_handler(request)\r\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/local/lib/python3.13/site-packages/aiohttp/web_app.py\", line 569, in _handle\r\n    return await handler(request)\r\n           ^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/local/lib/python3.13/site-packages/aiohttp/web_middlewares.py\", line 117, in impl\r\n    return await handler(request)\r\n           ^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/src/homeassistant/homeassistant/components/http/security_filter.py\", line 92, in security_filter_middleware\r\n    return await handler(request)\r\n           ^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/src/homeassistant/homeassistant/components/http/forwarded.py\", line 210, in forwarded_middleware\r\n    return await handler(request)\r\n           ^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/src/homeassistant/homeassistant/components/http/request_context.py\", line 26, in request_context_middleware\r\n    return await handler(request)\r\n           ^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/src/homeassistant/homeassistant/components/http/ban.py\", line 86, in ban_middleware\r\n    return await handler(request)\r\n           ^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/src/homeassistant/homeassistant/components/http/auth.py\", line 242, in auth_middleware\r\n    return await handler(request)\r\n           ^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/src/homeassistant/homeassistant/components/http/headers.py\", line 32, in headers_middleware\r\n    response = await handler(request)\r\n               ^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/src/homeassistant/homeassistant/helpers/http.py\", line 73, in handle\r\n    result = await handler(request, **request.match_info)\r\n             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/src/homeassistant/homeassistant/components/http/decorators.py\", line 81, in with_admin\r\n    return await func(self, request, *args, **kwargs)\r\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/src/homeassistant/homeassistant/components/config/config_entries.py\", line 222, in post\r\n    return await super().post(request, flow_id)\r\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/src/homeassistant/homeassistant/components/http/data_validator.py\", line 74, in wrapper\r\n    return await method(view, request, data, *args, **kwargs)\r\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/src/homeassistant/homeassistant/helpers/data_entry_flow.py\", line 122, in post\r\n    result = await self._flow_mgr.async_configure(flow_id, data)\r\n             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/src/homeassistant/homeassistant/data_entry_flow.py\", line 367, in async_configure\r\n    result = await self._async_configure(flow_id, user_input)\r\n             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/src/homeassistant/homeassistant/data_entry_flow.py\", line 414, in _async_configure\r\n    result = await self._async_handle_step(\r\n             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n        flow, cur_step[\"step_id\"], user_input\r\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n    )\r\n    ^\r\n  File \"/usr/src/homeassistant/homeassistant/data_entry_flow.py\", line 517, in _async_handle_step\r\n    result: _FlowResultT = await getattr(flow, method)(user_input)\r\n                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/src/homeassistant/homeassistant/components/acaia/config_flow.py\", line 47, in async_step_user\r\n    is_new_style_scale = await is_new_scale(mac)\r\n                         ^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/local/lib/python3.13/site-packages/aioacaia/helpers.py\", line 46, in is_new_scale\r\n    async with BleakClient(address_or_ble_device) as client:\r\n               ~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/local/lib/python3.13/site-packages/bleak/__init__.py\", line 570, in __aenter__\r\n    await self.connect()\r\n  File \"/usr/local/lib/python3.13/site-packages/habluetooth/wrappers.py\", line 286, in connect\r\n    wrapped_backend = self._async_get_best_available_backend_and_device(manager)\r\n  File \"/usr/local/lib/python3.13/site-packages/habluetooth/wrappers.py\", line 395, in _async_get_best_available_backend_and_device\r\n    raise BleakError(\r\n    ...<2 lines>...\r\n    )\r\nbleak.exc.BleakError: No backend with an available connection slot that can reach address 00:1c:97:16:5b:c7 was found\n```\n\n\n### Additional information\n\n_No response_\n", "hints_text": "\nHey there @zweckj, mind taking a look at this issue as it has been labeled with an integration (`acaia`) you are listed as a [code owner](https://github.com/home-assistant/core/blob/dev/CODEOWNERS#L43) for? Thanks!\n\n<details>\n<summary>Code owner commands</summary>\n\n\nCode owners of `acaia` can trigger bot actions by commenting:\n\n- `@home-assistant close` Closes the issue.\n- `@home-assistant rename Awesome new title` Renames the issue.\n- `@home-assistant reopen` Reopen the issue.\n- `@home-assistant unassign acaia` Removes the current integration label and assignees on the issue, add the integration domain after the command.\n- `@home-assistant add-label needs-more-information` Add a label (needs-more-information, problem in dependency, problem in custom component) to the issue.\n- `@home-assistant remove-label needs-more-information` Remove a label (needs-more-information, problem in dependency, problem in custom component) on the issue.\n\n</details>\n\n\n<sub><sup>(message by CodeOwnersMention)</sup></sub>\n\n---\n\n[acaia documentation](https://www.home-assistant.io/integrations/acaia)\n[acaia source](https://github.com/home-assistant/core/tree/dev/homeassistant/components/acaia)\n<sub><sup>(message by IssueLinks)</sup></sub>\nThis is an unhandled exception indeed, so thanks for reporting, but the underlying issue here is that you have no Bluetooth connection from your HA instance/BT proxy to your scale.\nWell, that's strange, because I have 3 Shellies Plus 2PM in 3 meter range around where I usually use my Acaia and I'm on beta since it's release on wednesday and it was never discovered automatically.\r\nToday I also had some time to troubleshoot so I took my Acaia near my PC to which I connected ESP32 with ble_proxy enabled and it was not discovered either.\r\n\r\nMaybe it's the matter of incompatible scale?\nIt could be, but here the exception clearly states `No backend with an available connection slot that can reach address 00:1c:97:16:5b:c7 was found`\r\n\r\nif it was discovered but incompatible, it would show in acaia's debug logs. ", "created_at": "2024-12-02T11:25:18Z"}
{"repo": "home-assistant/core", "pull_number": 132016, "instance_id": "home-assistant__core-132016", "issue_numbers": ["131180"], "base_commit": "cf0ee635077114961f6e508be56ce7620c718c18", "patch": "diff --git a/homeassistant/components/lamarzocco/__init__.py b/homeassistant/components/lamarzocco/__init__.py\nindex da513bc8cffa6f..5de9a2eeed4f25 100644\n--- a/homeassistant/components/lamarzocco/__init__.py\n+++ b/homeassistant/components/lamarzocco/__init__.py\n@@ -23,7 +23,7 @@\n )\n from homeassistant.core import HomeAssistant\n from homeassistant.helpers import issue_registry as ir\n-from homeassistant.helpers.httpx_client import get_async_client\n+from homeassistant.helpers.httpx_client import create_async_httpx_client\n \n from .const import CONF_USE_BLUETOOTH, DOMAIN\n from .coordinator import LaMarzoccoConfigEntry, LaMarzoccoUpdateCoordinator\n@@ -47,11 +47,11 @@ async def async_setup_entry(hass: HomeAssistant, entry: LaMarzoccoConfigEntry) -\n \n     assert entry.unique_id\n     serial = entry.unique_id\n-\n+    client = create_async_httpx_client(hass)\n     cloud_client = LaMarzoccoCloudClient(\n         username=entry.data[CONF_USERNAME],\n         password=entry.data[CONF_PASSWORD],\n-        client=get_async_client(hass),\n+        client=client,\n     )\n \n     # initialize local API\n@@ -61,7 +61,7 @@ async def async_setup_entry(hass: HomeAssistant, entry: LaMarzoccoConfigEntry) -\n         local_client = LaMarzoccoLocalClient(\n             host=host,\n             local_bearer=entry.data[CONF_TOKEN],\n-            client=get_async_client(hass),\n+            client=client,\n         )\n \n     # initialize Bluetooth\ndiff --git a/homeassistant/components/lamarzocco/config_flow.py b/homeassistant/components/lamarzocco/config_flow.py\nindex a727e3fe35796e..c01b55fb885998 100644\n--- a/homeassistant/components/lamarzocco/config_flow.py\n+++ b/homeassistant/components/lamarzocco/config_flow.py\n@@ -6,6 +6,7 @@\n import logging\n from typing import Any\n \n+from httpx import AsyncClient\n from pylamarzocco.client_cloud import LaMarzoccoCloudClient\n from pylamarzocco.client_local import LaMarzoccoLocalClient\n from pylamarzocco.exceptions import AuthFail, RequestNotSuccessful\n@@ -37,7 +38,7 @@\n )\n from homeassistant.core import callback\n from homeassistant.helpers import config_validation as cv\n-from homeassistant.helpers.httpx_client import get_async_client\n+from homeassistant.helpers.httpx_client import create_async_httpx_client\n from homeassistant.helpers.selector import (\n     SelectOptionDict,\n     SelectSelector,\n@@ -57,6 +58,8 @@ class LmConfigFlow(ConfigFlow, domain=DOMAIN):\n \n     VERSION = 2\n \n+    _client: AsyncClient\n+\n     def __init__(self) -> None:\n         \"\"\"Initialize the config flow.\"\"\"\n         self._config: dict[str, Any] = {}\n@@ -79,10 +82,12 @@ async def async_step_user(\n                 **user_input,\n                 **self._discovered,\n             }\n+            self._client = create_async_httpx_client(self.hass)\n \n             cloud_client = LaMarzoccoCloudClient(\n                 username=data[CONF_USERNAME],\n                 password=data[CONF_PASSWORD],\n+                client=self._client,\n             )\n             try:\n                 self._fleet = await cloud_client.get_customer_fleet()\n@@ -163,7 +168,7 @@ async def async_step_machine_selection(\n             # validate local connection if host is provided\n             if user_input.get(CONF_HOST):\n                 if not await LaMarzoccoLocalClient.validate_connection(\n-                    client=get_async_client(self.hass),\n+                    client=self._client,\n                     host=user_input[CONF_HOST],\n                     token=selected_device.communication_key,\n                 ):\n", "test_patch": "", "problem_statement": "lamarzocco Integration: Setup fail with http error 400\n### The problem\n\nSteps to reproduce:\r\n- Add La Marzocco Integration\r\n- Enter username/password (same as in app / checked before that it works in app)\r\n- Machine with serial number is shown, no IP address entered\r\n- Click on ok\r\n\r\nResultat: integration is not working, reporting in the UI \"Request to endpoint https://cms.lamarzocco.io/oauth/v2/token failed with status code 400\"\r\n\r\n\r\n\r\nStrangely, afterwards the login in the app is not working anymore. Seems like the account has been locked. Password change is then the only way to get it going again.\r\n\r\n\n\n### What version of Home Assistant Core has the issue?\n\ncore-2024.11.2\n\n### What was the last working version of Home Assistant Core?\n\n_No response_\n\n### What type of installation are you running?\n\nHome Assistant OS\n\n### Integration causing the issue\n\nlamarzocco\n\n### Link to integration documentation on our website\n\nhttps://www.home-assistant.io/integrations/lamarzocco\n\n### Diagnostics information\n\n_No response_\n\n### Example YAML snippet\n\n_No response_\n\n### Anything in the logs that might be useful for us?\n\n```txt\nDebug log:\r\n`2024-11-21 12:35:59.156 DEBUG (MainThread) [homeassistant.components.lamarzocco.coordinator] Request to endpoint https://cms.lamarzocco.io/oauth/v2/token failed with status code 400\r\nTraceback (most recent call last):\r\n  File \"/usr/src/homeassistant/homeassistant/components/lamarzocco/coordinator.py\", line 127, in _async_handle_request\r\n    await func(*args, **kwargs)\r\n  File \"/usr/local/lib/python3.12/site-packages/lmcloud/lm_device.py\", line 132, in get_config\r\n    raw_config = await self._cloud_client.get_config(self.serial_number)\r\n                 ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/local/lib/python3.12/site-packages/lmcloud/client_cloud.py\", line 166, in get_config\r\n    return await self._rest_api_call(url=url, method=HTTPMethod.GET)\r\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/local/lib/python3.12/site-packages/lmcloud/client_cloud.py\", line 118, in _rest_api_call\r\n    access_token = await self.async_get_access_token()\r\n                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/local/lib/python3.12/site-packages/lmcloud/client_cloud.py\", line 58, in async_get_access_token\r\n    return await self._async_get_access_token()\r\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/local/lib/python3.12/site-packages/lmcloud/client_cloud.py\", line 72, in _async_get_access_token\r\n    return await self.__async_get_token(data)\r\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/local/lib/python3.12/site-packages/lmcloud/client_cloud.py\", line 105, in __async_get_token\r\n    raise RequestNotSuccessful(\r\nlmcloud.exceptions.RequestNotSuccessful: Request to endpoint https://cms.lamarzocco.io/oauth/v2/token failed with status code 400`\n```\n\n\n### Additional information\n\nLa Marzocco Linea Micra\n", "hints_text": "\nHey there @zweckj, mind taking a look at this issue as it has been labeled with an integration (`lamarzocco`) you are listed as a [code owner](https://github.com/home-assistant/core/blob/dev/CODEOWNERS#L800) for? Thanks!\n\n<details>\n<summary>Code owner commands</summary>\n\n\nCode owners of `lamarzocco` can trigger bot actions by commenting:\n\n- `@home-assistant close` Closes the issue.\n- `@home-assistant rename Awesome new title` Renames the issue.\n- `@home-assistant reopen` Reopen the issue.\n- `@home-assistant unassign lamarzocco` Removes the current integration label and assignees on the issue, add the integration domain after the command.\n- `@home-assistant add-label needs-more-information` Add a label (needs-more-information, problem in dependency, problem in custom component) to the issue.\n- `@home-assistant remove-label needs-more-information` Remove a label (needs-more-information, problem in dependency, problem in custom component) on the issue.\n\n</details>\n\n\n<sub><sup>(message by CodeOwnersMention)</sup></sub>\n\n---\n\n[lamarzocco documentation](https://www.home-assistant.io/integrations/lamarzocco)\n[lamarzocco source](https://github.com/home-assistant/core/tree/dev/homeassistant/components/lamarzocco)\n<sub><sup>(message by IssueLinks)</sup></sub>\n@martingruening  Can you please try what happens if you enter an IP address?\n@zweckj Connection refused ('Verbindung fehlgeschlagen').\r\n\r\nNothing in the debug log.\r\n\r\n________________________________\r\nVon: Josef Zweck ***@***.***>\r\nGesendet: Donnerstag, November 21, 2024 4:42:00 PM\r\nAn: home-assistant/core ***@***.***>\r\nCc: Martin Gr\u00fcning ***@***.***>; Mention ***@***.***>\r\nBetreff: Re: [home-assistant/core] lamarzocco Integration: Setup fail with http error 400 (Issue #131180)\r\n\r\n\r\n@martingruening<https://github.com/martingruening> Can you please try what happens if you enter an IP address?\r\n\r\n\u2014\r\nReply to this email directly, view it on GitHub<https://github.com/home-assistant/core/issues/131180#issuecomment-2491577021>, or unsubscribe<https://github.com/notifications/unsubscribe-auth/AIXWEHRCNNO5RAKFI6OZIST2BX5MDAVCNFSM6AAAAABSHHN4RCVHI2DSMVQWIX3LMV43OSLTON2WKQ3PNVWWK3TUHMZDIOJRGU3TOMBSGE>.\r\nYou are receiving this because you were mentioned.Message ID: ***@***.***>\r\n\r\n\nthat's weird. it should log something on error level in this case (coming from lmcloud)\nSorry, my mistake. I grepped for the wrong keyword.\r\n\r\n2024-11-21 20:33:15.209 ERROR (MainThread) [lmcloud.client_local] Local API returned 403.\r\n________________________________\r\nFrom: Josef Zweck ***@***.***>\r\nSent: Thursday, November 21, 2024 8:50:56 PM\r\nTo: home-assistant/core ***@***.***>\r\nCc: Martin Gr\u00fcning ***@***.***>; Mention ***@***.***>\r\nSubject: Re: [home-assistant/core] lamarzocco Integration: Setup fail with http error 400 (Issue #131180)\r\n\r\n\r\nthat's weird. it should log something on error level in this case (coming from lmcloud)\r\n\r\n\u2014\r\nReply to this email directly, view it on GitHub<https://github.com/home-assistant/core/issues/131180#issuecomment-2492129502>, or unsubscribe<https://github.com/notifications/unsubscribe-auth/AIXWEHQPPYNUTOLKYK6LTWD2BY2SBAVCNFSM6AAAAABSHHN4RCVHI2DSMVQWIX3LMV43OSLTON2WKQ3PNVWWK3TUHMZDIOJSGEZDSNJQGI>.\r\nYou are receiving this because you were mentioned.Message ID: ***@***.***>\r\n\nHm. I'm a bit clueless tbh. I don't have any of those issues. You're machine is correctly added to your account in the app?\nYes, it is. Looks like an authentication problem to me.\r\n________________________________\r\nFrom: Josef Zweck ***@***.***>\r\nSent: Thursday, November 21, 2024 10:15:48 PM\r\nTo: home-assistant/core ***@***.***>\r\nCc: Martin Gr\u00fcning ***@***.***>; Mention ***@***.***>\r\nSubject: Re: [home-assistant/core] lamarzocco Integration: Setup fail with http error 400 (Issue #131180)\r\n\r\n\r\nHm. I'm a bit clueless tbh. I don't have any of those issues. You're machine is correctly added to your account in the app?\r\n\r\n\u2014\r\nReply to this email directly, view it on GitHub<https://github.com/home-assistant/core/issues/131180#issuecomment-2492352036>, or unsubscribe<https://github.com/notifications/unsubscribe-auth/AIXWEHQ7XQ4PJQ546NALBJD2BZEQJAVCNFSM6AAAAABSHHN4RCVHI2DSMVQWIX3LMV43OSLTON2WKQ3PNVWWK3TUHMZDIOJSGM2TEMBTGY>.\r\nYou are receiving this because you were mentioned.Message ID: ***@***.***>\r\n\nOh no wait. For that 403 I got an idea. Try to setup the integration with local IP again, but only after you connected (successfully) to it with the official app. Wait a bit between the official app login and integration setup.\nI restarted the app, connected to the machine, switched on the boiler, waited for some time (3 minutes) and then retried the integration setup. Same result with error codes 400 and 403.\r\n\r\nMy HA instance and the Linea Micra are on different subnets with a router/firewall in between. The firewall rules have been checked multiple times. The Micra can connect to anything via TCP. The HA instance is allowed to connect to port 8081 on the Micra via TCP. My mobile is on a third subnet and has appropriate firewall rules. I can see those connections to port 8081 happening from HA and my mobile phone. I see no blocked connections to/from the Micra IP address. So that should not be the issue, right?\r\n\r\nGateway Firmware is v3.6-RC4 and machine firmware is 1.17\nIt sure sounds like. What I don't understand is why you are the first one having those issues and it seems to be working fine for everybody else (including me).\n\nBit of technical background: The local 403 is sometimes happening if the local API is stilled locked, which needs a cloud command after machine restart to be unlocked, which the integration currently doesn't give on setup, but that also shouldn't be an issue if you have connected with the app before...\n\nFor the cloud block I'm wondering whether they started blocking consecutive login attempts (the integration does setup in cloud only mode but then fail right?), but again why only you then?\nI agree - impacting only me is strange. My machine and my account are fairly new (3 days old). Maybe they have changed API settings, but keep compability for older accounts (would seem weird).\r\n\r\nhttp 400 means:\r\nBad Request: The request was malformed or invalid. Check the syntax and parameters of the request.\r\n\r\nSo a http 400 in request for the oauth token could mean they have changed authentication somehow for newer user accounts. A check for that would be somebody that has a working setup deleting the old user account and creating a fresh one.\r\n\r\nEdit:\r\nI will try to debug the request to https://cms.lamarzocco.io/oauth/v2/token myself. Is the client_id and client_secret the one reported here: https://github.com/rccoleman/lamarzocco or do I have to use mitmproxy to retrieve them for my individual account?\nI did this `curl -d \"@auth.txt\" -X POST https://cms.lamarzocco.io/oauth/v2/token`\r\n\r\nauth.txt contains\r\n`grant_type=password&client_id=7_1xwei9rtkuckso44ks4o8s0c0oc4swowo00wgw0ogsok84kosg&client_secret=2mgjqpikbfuok8g4s44oo4gsw0ks44okk4kc4kkkko0c8soc8s&username=user@domain.tld&password=notmyrealpassword`\r\n\r\nResponse is \r\n> {\"error\":\"user_manually_disabled\",\"error_description\":\"User was deactivated by admin edit\"}\r\n\r\nAfterwards I deleted the account in the app, created a new one (`user+lama@domain.tld`), assigned the machine to it via the app. I first failed with the response `{\"error\":\"invalid_grant\",\"error_description\":\"Invalid username and password combination\"}`. After replacing the `+` sign with the encoded version `%2B` it worked and I got an access token back.\r\n\r\n`{\"access_token\":\"LONGTOKENHERE\",\"expires_in\":3600,\"token_type\":\"bearer\",\"scope\":null,\"refresh_token\":\"ANOTHERLONGTOKENHERE\"}`\r\n\r\nSo the problem with my account now seems to be solved. The integration still produces the same behaviour. There must be something different happening between my curl-command and the token request in lmcloud that makes the request fail. A nice first improvement could be to report the error_description back in HA when the token request fails.\n\r\n> {\"error\":\"user_manually_disabled\",\"error_description\":\"User was deactivated by admin edit\"}\r\n\r\nthat's interesting. I'm trying to add a logout after each login, to avoid sending consecutive logins with #131240. But `admin edit` sounds wild.\r\n\nCould be that it's just an encoding problem. If there's still a \"+\" in your username, the integration does not encode that.\r\nEdit: Have you tried putting your username in encoded version in the integration setup?\n> Could be that it's just an encoding problem. If there's still a \"+\" in your username, the integration does not encode that.\r\n\r\nA plus sign is valid in any email address, so the lmcloud client should encode that properly. When I use `user%2Blama@domain.tld` as the user name in the integration, then the connection fails immediately. When I enter a plain `+` sign as part of the username I can proceed to the next step where I can select the machine, but then the integration still fails requesting an oauth token.\r\n\r\nI have now switched my username to `lama@domain.tld` to avoid any encoding problems. I immediately managed to get an oauth token via curl using that user. The app is connected as well. The integration lets me choose the machine and then the behaviour is the same (HTTP error 400). Strange - would be great to expose the `error` and `error_description` fields from the failed token request in lmcloud in the HA debug log.\nI did add it to the library, but you will get those changes earliest in the next HA beta on wednesday.\r\nIt would be easier tbh if you could install the library and test from there. If you could install `pylamarzocco` (name changed) through pip and run the following small Python script, that would help a lot in getting an actual fix in the next release\r\n\r\n```python\r\nimport asyncio\r\nfrom pylamarzocco.client_cloud import LaMarzoccoCloudClient\r\n\r\nasync def main():\r\n    cloud_client = LaMarzoccoCloudClient(username, password)\r\n    fleet = await cloud_client.get_customer_fleet()\r\n    config = await cloud_client.get_config(serial_number)\r\n\r\nasyncio.run(main())\r\n```\n```\r\n>>> username = \"lama@domain.tld\"\r\n>>> password = \"PASSWORD\"\r\n>>> serial_number = \"MR025146\"\r\n>>> import asyncio\r\n>>> from pylamarzocco.client_cloud import LaMarzoccoCloudClient\r\n>>>\r\n>>> async def main():\r\n...     cloud_client = LaMarzoccoCloudClient(username, password)\r\n...     fleet = await cloud_client.get_customer_fleet()\r\n...     config = await cloud_client.get_config(serial_number)\r\n...\r\n>>> asyncio.run(main())\r\n>>>\r\n```\r\nNo error message shown.\n```python\r\nimport asyncio\r\nfrom pylamarzocco.client_cloud import LaMarzoccoCloudClient\r\n\r\nasync def main():\r\n    cloud_client = LaMarzoccoCloudClient(username, password)\r\n    fleet = await cloud_client.get_customer_fleet()\r\n    config = await cloud_client.get_config(serial_number)\r\n    cloud_client = LaMarzoccoCloudClient(username, password)\r\n    fleet = await cloud_client.get_customer_fleet()\r\n    config = await cloud_client.get_config(serial_number)\r\n\r\nasyncio.run(main())\r\n```\r\n\r\nThanks for helping! Let's see if two consecutive login attempts change something \nSure, I am happy to get your support too. Runs slightly longer, no error message.\n```python\r\nimport asyncio\r\nfrom pylamarzocco.client_cloud import LaMarzoccoCloudClient\r\nfrom pylamarzocco.client_local import LaMarzoccoLocalClient\r\n\r\nserial_number = \"LM000000000\"\r\nusername = \"username\"\r\npassword = \"password\"\r\nhost = \"192.168.1.42\"\r\n\r\nasync def main():\r\n    cloud_client = LaMarzoccoCloudClient(username, password)\r\n    try:\r\n        fleet = await cloud_client.get_customer_fleet()\r\n        config = await cloud_client.get_config(serial_number)\r\n    except Exception as ex:\r\n        print(ex)\r\n        exit(1)\r\n    else:\r\n        print(config)\r\n    cloud_client = LaMarzoccoCloudClient(username, password)\r\n    try:\r\n        fleet = await cloud_client.get_customer_fleet()\r\n        config = await cloud_client.get_config(serial_number)\r\n    except Exception as ex:\r\n        print(ex)\r\n        exit(1)\r\n    else:\r\n        print(config)\r\n    local_client = LaMarzoccoLocalClient(host, fleet[serial_number].communication_key)\r\n    try:\r\n        config = await local_client.get_config()\r\n    except Exception as ex:\r\n        print(ex)\r\n        exit(1)\r\n    else:\r\n        print(config)\r\n\r\nasyncio.run(main())\r\n```\r\n\r\nnow I REALLY don't know what's going on. This should print your machine's status 3 times to the console. I'm not interested in that content, I just wanna see if it's able to get it.\n```\r\n>>> asyncio.run(main())\r\nTraceback (most recent call last):\r\n  File \"<stdin>\", line 1, in <module>\r\n  File \"/usr/lib/python3.11/asyncio/runners.py\", line 190, in run\r\n    return runner.run(main)\r\n           ^^^^^^^^^^^^^^^^\r\n  File \"/usr/lib/python3.11/asyncio/runners.py\", line 118, in run\r\n    return self._loop.run_until_complete(task)\r\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/lib/python3.11/asyncio/base_events.py\", line 653, in run_until_complete\r\n    return future.result()\r\n           ^^^^^^^^^^^^^^^\r\n  File \"<stdin>\", line 10, in main\r\n  File \"/usr/lib/python3.11/dataclasses.py\", line 1273, in asdict\r\n    raise TypeError(\"asdict() should be called on dataclass instances\")\r\nTypeError: asdict() should be called on dataclass instances\r\n```\nsorry, mixed up the functions, fixed the script above\n```\r\n>>> asyncio.run(main())\r\n{'version': 'v1', 'preinfusionModesAvailable': ['ByDoseType'], 'machineCapabilities': [{'family': 'MICRA', 'groupsNumber': 1, 'coffeeBoilersNumber': 1, 'hasCupWarmer': False, 'steamBoilersNumber': 1, 'teaDosesNumber': 1, 'machineModes': ['BrewingMode', 'StandBy'], 'schedulingType': 'smartWakeUpSleep'}], 'machine_sn': 'Sn2406030216', 'machine_hw': '0', 'isPlumbedIn': False, 'isBackFlushEnabled': False, 'standByTime': 0, 'tankStatus': True, 'groupCapabilities': [{'capabilities': {'groupType': 'AV_Group', 'groupNumber': 'Group1', 'boilerId': 'CoffeeBoiler1', 'hasScale': False, 'hasFlowmeter': True, 'numberOfDoses': 1}, 'doses': [{'groupNumber': 'Group1', 'doseIndex': 'DoseA', 'doseType': 'PulsesType', 'stopTarget': 0}], 'doseMode': {'groupNumber': 'Group1', 'brewingType': 'PulsesType'}}], 'machineMode': 'StandBy', 'teaDoses': {'DoseA': {'doseIndex': 'DoseA', 'stopTarget': 0}}, 'boilers': [{'id': 'SteamBoiler', 'isEnabled': True, 'target': 128, 'current': 110}, {'id': 'CoffeeBoiler1', 'isEnabled': True, 'target': 94, 'current': 82}], 'boilerTargetTemperature': {'SteamBoiler': 128, 'CoffeeBoiler1': 94}, 'preinfusionMode': {'Group1': {'groupNumber': 'Group1', 'preinfusionStyle': 'PreinfusionByDoseType'}}, 'preinfusionSettings': {'mode': 'Disabled', 'Group1': [{'groupNumber': 'Group1', 'doseType': 'DoseA', 'preWetTime': 5, 'preWetHoldTime': 5}]}, 'clock': '2024-11-23T11:06:47', 'wakeUpSleepEntries': [{'id': 'E4Qn9AK', 'days': ['monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday', 'sunday'], 'steam': True, 'enabled': True, 'timeOn': '5:45', 'timeOff': '9:30'}], 'smartStandBy': {'mode': 'LastBrewing', 'minutes': 30, 'enabled': True}, 'firmwareVersions': [{'name': 'machine_firmware', 'fw_version': '1.17'}, {'name': 'gateway_firmware', 'fw_version': 'v3.6-rc4'}]}\r\n```\r\nConfig output repeats three times, cut down to one here. Code run on two different systems, of them my HA host to rule out firewall issues. Both deliver same result. Integration stills fails with HTTP error 400. The request for the oauth token seems to get malformed. Debugging the HTTP POST Call for oauth token or the passed parameters to the function seems to be necessary.\nthat's really weird. We'll need to wait for the beta next Wednesday and the improved debug logging I guess.\nBeta is out, you could try again. \nTried it. Checked before on command line that config retrieval works with the above code, then tried the HA integration. It somehow now autodiscovers the machine:\r\n```\r\n2024-12-01 08:16:52.056 DEBUG (MainThread) [homeassistant.components.lamarzocco.config_flow] Discovered La Marzocco machine mr025146 through DHCP at address 192.168.181.77\r\n```\r\n\r\nThe error is still HTTP 400:\r\n```\r\npylamarzocco.exceptions.RequestNotSuccessful: Request to endpoint https://cms.lamarzocco.io/oauth/v2/token failed with status code 400response: {\"error\":\"invalid_client\",\"error_description\":\"The client credentials are invalid\"}\r\n```\r\n\r\nBut this code works\r\n```\r\nimport asyncio\r\nfrom pylamarzocco.clients.cloud import LaMarzoccoCloudClient\r\nfrom pylamarzocco.clients.local import LaMarzoccoLocalClient\r\n\r\nserial_number = \"MR025146\"\r\nusername = \"email@domain.tld\"\r\npassword = \"PASSWORD\"\r\nhost = \"192.168.181.77\"\r\n\r\nasync def main():\r\n    cloud_client = LaMarzoccoCloudClient(username, password)\r\n    try:\r\n        fleet = await cloud_client.get_customer_fleet()\r\n        config = await cloud_client.get_config(serial_number)\r\n    except Exception as ex:\r\n        print(ex)\r\n        exit(1)\r\n    else:\r\n        print(fleet)\r\n        print(config)\r\n\r\nasyncio.run(main())\r\n```\r\n\r\nResults in\r\n```\r\n>>> asyncio.run(main())\r\n{'MR025146': LaMarzoccoDeviceInfo(serial_number='MR025146', name='Micra', communication_key='f95824d356a5dfb63d8aebdaf8a508549a578142bd5f7aa4807f591649c31482', model='Micra')}\r\n{'version': 'v1', 'preinfusionModesAvailable': ['ByDoseType'], 'machineCapabilities': [{'family': 'MICRA', 'groupsNumber': 1, 'coffeeBoilersNumber': 1, 'hasCupWarmer': False, 'steamBoilersNumber': 1, 'teaDosesNumber': 1, 'machineModes': ['BrewingMode', 'StandBy'], 'schedulingType': 'smartWakeUpSleep'}], 'machine_sn': 'Sn2406030216', 'machine_hw': '0', 'isPlumbedIn': False, 'isBackFlushEnabled': False, 'standByTime': 0, 'tankStatus': True, 'groupCapabilities': [{'capabilities': {'groupType': 'AV_Group', 'groupNumber': 'Group1', 'boilerId': 'CoffeeBoiler1', 'hasScale': False, 'hasFlowmeter': True, 'numberOfDoses': 1}, 'doses': [{'groupNumber': 'Group1', 'doseIndex': 'DoseA', 'doseType': 'PulsesType', 'stopTarget': 0}], 'doseMode': {'groupNumber': 'Group1', 'brewingType': 'PulsesType'}}], 'machineMode': 'BrewingMode', 'teaDoses': {'DoseA': {'doseIndex': 'DoseA', 'stopTarget': 0}}, 'boilers': [{'id': 'SteamBoiler', 'isEnabled': True, 'target': 128, 'current': 128}, {'id': 'CoffeeBoiler1', 'isEnabled': True, 'target': 94, 'current': 97}], 'boilerTargetTemperature': {'SteamBoiler': 128, 'CoffeeBoiler1': 94}, 'preinfusionMode': {'Group1': {'groupNumber': 'Group1', 'preinfusionStyle': 'PreinfusionByDoseType'}}, 'preinfusionSettings': {'mode': 'Disabled', 'Group1': [{'groupNumber': 'Group1', 'doseType': 'DoseA', 'preWetTime': 5, 'preWetHoldTime': 5}]}, 'clock': '2024-12-01T08:16:37', 'wakeUpSleepEntries': [{'id': 'E4Qn9AK', 'days': ['monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday', 'sunday'], 'steam': True, 'enabled': True, 'timeOn': '5:45', 'timeOff': '9:30'}], 'smartStandBy': {'mode': 'LastBrewing', 'minutes': 30, 'enabled': True}, 'firmwareVersions': [{'name': 'machine_firmware', 'fw_version': '1.17'}, {'name': 'gateway_firmware', 'fw_version': 'v3.6-rc4'}]}\r\nUnclosed client session\r\nclient_session: <aiohttp.client.ClientSession object at 0x7f49b574fcb0>\r\nUnclosed connector\r\nconnections: ['deque([(<aiohttp.client_proto.ResponseHandler object at 0x7f49b5753a70>, 7476006.585139505)])', 'deque([(<aiohttp.client_proto.ResponseHandler object at 0x7f49b5753e30>, 7476006.851638583)])']\r\nconnector: <aiohttp.connector.TCPConnector object at 0x7f49b57751c0>\r\n```\r\n\r\nI can send you my username and password if you want to debug yourself using my account?\n> I can send you my username and password if you want to debug yourself using my account?\r\n\r\nDon't want to go there \ud83d\ude05\r\n\r\npylamarzocco should (debug) log your account details in both cases. Do you see any difference in your account/password between those two?\nAlso, just so we are on the same page:\r\n- you configure the integration \r\n- it fails on config entry setup then?\nIt autodetect the Micra, I added it to the system by entering username and password. Integration is then added. In the UI it says `'Errror while communicating with the API'`.\r\n\r\nAll I can see in the log is\r\n```\r\n2024-12-01 12:04:18.595 WARNING (MainThread) [homeassistant.util.loop] Detected blocking call to load_verify_locations with args (<ssl.SSLContext object at 0x7f19d6eea450>,) inside the event loop by integration 'lamarzocco' at homeassistant/components/lamarzocco/config_flow.py, line 83: cloud_client = LaMarzoccoCloudClient( (offender: /usr/local/lib/python3.13/site-packages/httpx/_config.py, line 149: context.load_verify_locations(cafile=cafile)), please create a bug report at https://github.com/home-assistant/core/issues?q=is%3Aopen+is%3Aissue+label%3A%22integration%3A+lamarzocco%22\r\n2024-12-01 12:04:48.211 DEBUG (MainThread) [homeassistant.components.lamarzocco] Initializing local API\r\n2024-12-01 12:04:48.212 DEBUG (MainThread) [homeassistant.components.lamarzocco.coordinator] Init WebSocket in background task\r\n2024-12-01 12:04:48.582 DEBUG (MainThread) [homeassistant.components.lamarzocco.coordinator] Request to endpoint https://cms.lamarzocco.io/oauth/v2/token failed with status code 400response: {\"error\":\"invalid_client\",\"error_description\":\"The client credentials are invalid\"}\r\n2024-12-01 12:04:48.586 DEBUG (MainThread) [homeassistant.components.lamarzocco.coordinator] Finished fetching lamarzocco data in 0.374 seconds (success: False)\r\n2024-12-01 12:04:53.848 DEBUG (MainThread) [homeassistant.components.lamarzocco] Initializing local API\r\n2024-12-01 12:04:53.848 DEBUG (MainThread) [homeassistant.components.lamarzocco.coordinator] Init WebSocket in background task\r\n2024-12-01 12:04:54.129 DEBUG (MainThread) [homeassistant.components.lamarzocco.coordinator] Request to endpoint https://cms.lamarzocco.io/oauth/v2/token failed with status code 400response: {\"error\":\"invalid_client\",\"error_description\":\"The client credentials are invalid\"}\r\n2024-12-01 12:04:54.130 DEBUG (MainThread) [homeassistant.components.lamarzocco.coordinator] Finished fetching lamarzocco data in 0.281 seconds (success: False)\r\n2024-12-01 12:05:04.504 DEBUG (MainThread) [homeassistant.components.lamarzocco] Initializing local API\r\n2024-12-01 12:05:04.505 DEBUG (MainThread) [homeassistant.components.lamarzocco.coordinator] Init WebSocket in background task\r\n2024-12-01 12:05:04.673 DEBUG (MainThread) [homeassistant.components.lamarzocco.coordinator] Request to endpoint https://cms.lamarzocco.io/oauth/v2/token failed with status code 400response: {\"error\":\"invalid_client\",\"error_description\":\"The client credentials are invalid\"}\r\n2024-12-01 12:05:04.675 DEBUG (MainThread) [homeassistant.components.lamarzocco.coordinator] Finished fetching lamarzocco data in 0.169 seconds (success: False)\r\n```\nThis one is really bugging me \ud83d\ude05\r\n\r\n- No debug logs at all from`pylamarzocco`?\r\n- While the integration is configured check `/homeassistant/.storage/core.config_entries` You should find a block for lamarzocco and in it your credentials. Does anything look funny there?\nForget that, I have another theory: Maybe another of your integrations is injecting something to the shared http client (which is not used during configuration). Are you comfortable using SSH on your instance? \n- Sorry, I had to configure the debug logging for pylamarzocco and restart. Log is below.\r\n- I can find the config entry, but nothing funny there. Matches debug log from pylamarzocco.\r\n\r\n```\r\n2024-12-01 13:19:41.088 DEBUG (MainThread) [homeassistant.components.lamarzocco.coordinator] Finished fetching lamarzocco data in 0.399 seconds (success: False)\r\n2024-12-01 13:19:46.569 DEBUG (MainThread) [homeassistant.components.lamarzocco] Initializing local API\r\n2024-12-01 13:19:46.569 DEBUG (MainThread) [homeassistant.components.lamarzocco.coordinator] Init WebSocket in background task\r\n2024-12-01 13:19:46.766 DEBUG (MainThread) [pylamarzocco.lm_device] Got 403 from local API, sending token request to cloud\r\n2024-12-01 13:19:46.766 DEBUG (MainThread) [pylamarzocco.client_cloud] Getting new access token, data: {'username': 'lama@grun.ing', 'password': 'PASSWD', 'grant_type': 'password', 'client_id': '7_1xwei9rtkuckso44ks4o8s0c0oc4swowo00wgw0ogsok84kosg', 'client_secret': '2mgjqpikbfuok8g4s44oo4gsw0ks44okk4kc4kkkko0c8soc8s'}\r\n2024-12-01 13:19:46.867 DEBUG (MainThread) [homeassistant.components.lamarzocco.coordinator] Request to endpoint https://cms.lamarzocco.io/oauth/v2/token failed with status code 400response: {\"error\":\"invalid_client\",\"error_description\":\"The client credentials are invalid\"}\r\n```\r\nWhat I can tell:\r\n- Credentials are correct. They work in the app. After I have enabled the integration for some time my account seems to get locked and I have to reset the password three times in a row to get the app back to signing in.\r\n\r\nI am happy to use the integrated console to debugging.", "created_at": "2024-12-01T17:55:46Z"}
{"repo": "home-assistant/core", "pull_number": 132005, "instance_id": "home-assistant__core-132005", "issue_numbers": ["127272"], "base_commit": "8878d0f0e13adfebc086bc14d38ea71a7540c7ec", "patch": "diff --git a/homeassistant/components/bmw_connected_drive/manifest.json b/homeassistant/components/bmw_connected_drive/manifest.json\nindex d1ca735ce55eb9..81928a59a52bc9 100644\n--- a/homeassistant/components/bmw_connected_drive/manifest.json\n+++ b/homeassistant/components/bmw_connected_drive/manifest.json\n@@ -6,5 +6,5 @@\n   \"documentation\": \"https://www.home-assistant.io/integrations/bmw_connected_drive\",\n   \"iot_class\": \"cloud_polling\",\n   \"loggers\": [\"bimmer_connected\"],\n-  \"requirements\": [\"bimmer-connected[china]==0.17.0\"]\n+  \"requirements\": [\"bimmer-connected[china]==0.17.2\"]\n }\ndiff --git a/requirements_all.txt b/requirements_all.txt\nindex 0fa30cee23a316..ba584f1c7a952c 100644\n--- a/requirements_all.txt\n+++ b/requirements_all.txt\n@@ -582,7 +582,7 @@ beautifulsoup4==4.12.3\n # beewi-smartclim==0.0.10\n \n # homeassistant.components.bmw_connected_drive\n-bimmer-connected[china]==0.17.0\n+bimmer-connected[china]==0.17.2\n \n # homeassistant.components.bizkaibus\n bizkaibus==0.1.1\n", "test_patch": "diff --git a/requirements_test_all.txt b/requirements_test_all.txt\nindex 668e98a262af0a..4e7e757f9b2cc2 100644\n--- a/requirements_test_all.txt\n+++ b/requirements_test_all.txt\n@@ -516,7 +516,7 @@ base36==0.1.1\n beautifulsoup4==4.12.3\n \n # homeassistant.components.bmw_connected_drive\n-bimmer-connected[china]==0.17.0\n+bimmer-connected[china]==0.17.2\n \n # homeassistant.components.eq3btsmart\n # homeassistant.components.esphome\n", "problem_statement": "Error when sending POI / bmw_connected_drive\n### The problem\n\nError when sending POI / integration: bmw_connected_drive\r\n\r\nAfter deleting the location entry line / see Issue #125314 \r\n\r\nThe POI send request fails with: \r\nHTTPStatusError: Bad Request\r\n\r\n![image](https://github.com/user-attachments/assets/a4d7b06b-fbf2-417d-9cb9-2c9297f6919e)\r\n\r\n\r\nYAML Code:\r\ndata:\r\n  message: HT auf / EMA inaktiv\r\n  data:\r\n    latitude: 51.500729\r\n    longitude: -0.124625\r\n    street: HT & GT auf / EMA inaktiv\r\n  title: WB HA\r\naction: notify.bmw_connected_drive_ix_xdrive50\n\n### What version of Home Assistant Core has the issue?\n\n2024.9.3 also with 2024.8.3\n\n### What was the last working version of Home Assistant Core?\n\n2024.7.4\n\n### What type of installation are you running?\n\nHome Assistant OS\n\n### Integration causing the issue\n\nBMW Connected Drive\n\n### Link to integration documentation on our website\n\nhttps://www.home-assistant.io/integrations/bmw_connected_drive/#send-a-point-of-interest-to-your-vehicle\n\n### Diagnostics information\n\n2024-10-02 10:47:48.358 ERROR (MainThread) [bimmer_connected.api.client] MyBMWAPIError due to HTTPStatusError: Bad Request - \r\n2024-10-02 10:47:48.358 ERROR (MainThread) [homeassistant.helpers.script.websocket_api_script] websocket_api script: Error executing script. Error for call_service at pos 1: HTTPStatusError: Bad Request - \r\n2024-10-02 10:47:48.359 ERROR (MainThread) [homeassistant.components.websocket_api.http.connection] [140302965518928] Error handling message: HTTPStatusError: Bad Request -  (home_assistant_error) MIBO from 127.0.0.1 (Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/129.0.0.0 Safari/537.36 Edg/129.0.0.0)\r\n2024-10-02 10:53:40.850 DEBUG (MainThread) [bimmer_connected.account] Getting vehicle list\r\n2024-10-02 10:53:40.850 DEBUG (MainThread) [bimmer_connected.vehicle.vehicle] Getting vehicle list\r\n2024-10-02 10:53:42.183 DEBUG (MainThread) [homeassistant.components.bmw_connected_drive.coordinator] Finished fetching bmw_connected_drive-mbosch@upg.de data in 1.333 seconds (success: True)\r\n2024-10-02 10:53:42.183 DEBUG (MainThread) [homeassistant.components.bmw_connected_drive.binary_sensor] Updating binary sensor 'lids' of iX xDrive50\r\n2024-10-02 10:53:42.183 DEBUG (MainThread) [homeassistant.components.bmw_connected_drive.binary_sensor] Updating binary sensor 'windows' of iX xDrive50\r\n2024-10-02 10:53:42.183 DEBUG (MainThread) [homeassistant.components.bmw_connected_drive.binary_sensor] Updating binary sensor 'door_lock_state' of iX xDrive50\r\n2024-10-02 10:53:42.183 DEBUG (MainThread) [homeassistant.components.bmw_connected_drive.binary_sensor] Updating binary sensor 'condition_based_services' of iX xDrive50\r\n2024-10-02 10:53:42.183 DEBUG (MainThread) [homeassistant.components.bmw_connected_drive.binary_sensor] Updating binary sensor 'check_control_messages' of iX xDrive50\r\n2024-10-02 10:53:42.183 DEBUG (MainThread) [homeassistant.components.bmw_connected_drive.binary_sensor] Updating binary sensor 'charging_status' of iX xDrive50\r\n2024-10-02 10:53:42.183 DEBUG (MainThread) [homeassistant.components.bmw_connected_drive.binary_sensor] Updating binary sensor 'connection_status' of iX xDrive50\r\n2024-10-02 10:53:42.183 DEBUG (MainThread) [homeassistant.components.bmw_connected_drive.binary_sensor] Updating binary sensor 'is_pre_entry_climatization_enabled' of iX xDrive50\r\n2024-10-02 10:53:42.184 DEBUG (MainThread) [homeassistant.components.bmw_connected_drive.lock] Updating lock data of iX xDrive50\r\n2024-10-02 10:53:42.184 DEBUG (MainThread) [homeassistant.components.bmw_connected_drive.select] Updating select 'ac_limit' of iX xDrive50\r\n2024-10-02 10:53:42.184 DEBUG (MainThread) [homeassistant.components.bmw_connected_drive.select] Updating select 'charging_mode' of iX xDrive50\r\n2024-10-02 10:53:42.184 DEBUG (MainThread) [homeassistant.components.bmw_connected_drive.sensor] Updating sensor 'fuel_and_battery.charging_end_time' of iX xDrive50\r\n2024-10-02 10:53:42.184 DEBUG (MainThread) [homeassistant.components.bmw_connected_drive.sensor] Updating sensor 'fuel_and_battery.charging_status' of iX xDrive50\r\n2024-10-02 10:53:42.184 DEBUG (MainThread) [homeassistant.components.bmw_connected_drive.sensor] Updating sensor 'fuel_and_battery.charging_target' of iX xDrive50\r\n2024-10-02 10:53:42.184 DEBUG (MainThread) [homeassistant.components.bmw_connected_drive.sensor] Updating sensor 'fuel_and_battery.remaining_battery_percent' of iX xDrive50\r\n2024-10-02 10:53:42.184 DEBUG (MainThread) [homeassistant.components.bmw_connected_drive.sensor] Updating sensor 'mileage' of iX xDrive50\r\n2024-10-02 10:53:42.184 DEBUG (MainThread) [homeassistant.components.bmw_connected_drive.sensor] Updating sensor 'fuel_and_battery.remaining_range_total' of iX xDrive50\r\n2024-10-02 10:53:42.184 DEBUG (MainThread) [homeassistant.components.bmw_connected_drive.sensor] Updating sensor 'fuel_and_battery.remaining_range_electric' of iX xDrive50\r\n2024-10-02 10:53:42.184 DEBUG (MainThread) [homeassistant.components.bmw_connected_drive.sensor] Updating sensor 'climate.activity' of iX xDrive50\r\n2024-10-02 10:53:42.185 DEBUG (MainThread) [homeassistant.components.bmw_connected_drive.sensor] Updating sensor 'tires.front_left.current_pressure' of iX xDrive50\r\n2024-10-02 10:53:42.185 DEBUG (MainThread) [homeassistant.components.bmw_connected_drive.sensor] Updating sensor 'tires.front_right.current_pressure' of iX xDrive50\r\n2024-10-02 10:53:42.185 DEBUG (MainThread) [homeassistant.components.bmw_connected_drive.sensor] Updating sensor 'tires.rear_left.current_pressure' of iX xDrive50\r\n2024-10-02 10:53:42.185 DEBUG (MainThread) [homeassistant.components.bmw_connected_drive.sensor] Updating sensor 'tires.rear_right.current_pressure' of iX xDrive50\r\n2024-10-02 10:53:45.007 DEBUG (MainThread) [homeassistant.components.bmw_connected_drive.notify] Sending message to iX xDrive50\r\n2024-10-02 10:53:45.188 ERROR (MainThread) [bimmer_connected.api.client] MyBMWAPIError due to HTTPStatusError: Bad Request - \r\n2024-10-02 10:53:45.188 ERROR (MainThread) [homeassistant.helpers.script.websocket_api_script] websocket_api script: Error executing script. Error for call_service at pos 1: HTTPStatusError: Bad Request - \r\n2024-10-02 10:53:45.189 ERROR (MainThread) [homeassistant.components.websocket_api.http.connection] [140302965518928] Error handling message: HTTPStatusError: Bad Request -  (home_assistant_error) MIBO from 127.0.0.1 (Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/129.0.0.0 Safari/537.36 Edg/129.0.0.0)\n\n### Example YAML snippet\n\n```yaml\ndata:\r\n  message: HT auf / EMA inaktiv\r\n  data:\r\n    latitude: 51.500729\r\n    longitude: -0.124625\r\n    street: HT & GT auf / EMA inaktiv\r\n  title: WB HA\r\naction: notify.bmw_connected_drive_ix_xdrive50\n```\n\n\n### Anything in the logs that might be useful for us?\n\n_No response_\n\n### Additional information\n\n_No response_\n", "hints_text": "\nHey there @gerard33, @rikroe, mind taking a look at this issue as it has been labeled with an integration (`bmw_connected_drive`) you are listed as a [code owner](https://github.com/home-assistant/core/blob/dev/CODEOWNERS#L211) for? Thanks!\n\n<details>\n<summary>Code owner commands</summary>\n\n\nCode owners of `bmw_connected_drive` can trigger bot actions by commenting:\n\n- `@home-assistant close` Closes the issue.\n- `@home-assistant rename Awesome new title` Renames the issue.\n- `@home-assistant reopen` Reopen the issue.\n- `@home-assistant unassign bmw_connected_drive` Removes the current integration label and assignees on the issue, add the integration domain after the command.\n- `@home-assistant add-label needs-more-information` Add a label (needs-more-information, problem in dependency, problem in custom component) to the issue.\n- `@home-assistant remove-label needs-more-information` Remove a label (needs-more-information, problem in dependency, problem in custom component) on the issue.\n\n</details>\n\n\n<sub><sup>(message by CodeOwnersMention)</sup></sub>\n\n---\n\n[bmw_connected_drive documentation](https://www.home-assistant.io/integrations/bmw_connected_drive)\n[bmw_connected_drive source](https://github.com/home-assistant/core/tree/dev/homeassistant/components/bmw_connected_drive)\n<sub><sup>(message by IssueLinks)</sup></sub>\nAny ideas ?\nUnfortunately I haven't had the chance to look into it.\n> Unfortunately I haven't had the chance to look into it.\r\n\r\nIf you need any further info or logs, just let me know.\nFix in library with https://github.com/bimmerconnected/bimmer_connected/pull/695", "created_at": "2024-12-01T15:11:59Z"}
{"repo": "home-assistant/core", "pull_number": 131993, "instance_id": "home-assistant__core-131993", "issue_numbers": ["129739"], "base_commit": "47aebabc513eec2f2eb833c5dc264bd295351ccf", "patch": "diff --git a/homeassistant/components/cloud/strings.json b/homeassistant/components/cloud/strings.json\nindex 9f7e0dbadcdf81..1da91f6781340c 100644\n--- a/homeassistant/components/cloud/strings.json\n+++ b/homeassistant/components/cloud/strings.json\n@@ -68,12 +68,12 @@\n   },\n   \"services\": {\n     \"remote_connect\": {\n-      \"name\": \"Remote connect\",\n-      \"description\": \"Makes the instance UI accessible from outside of the local network by using Home Assistant Cloud.\"\n+      \"name\": \"Enable remote access\",\n+      \"description\": \"Makes the instance UI accessible from outside of the local network by enabling your Home Assistant Cloud connection.\"\n     },\n     \"remote_disconnect\": {\n-      \"name\": \"Remote disconnect\",\n-      \"description\": \"Disconnects the Home Assistant UI from the Home Assistant Cloud. You will no longer be able to access your Home Assistant instance from outside your local network.\"\n+      \"name\": \"Disable remote access\",\n+      \"description\": \"Disconnects the instance UI from Home Assistant Cloud. This disables access to it from outside your local network.\"\n     }\n   }\n }\n", "test_patch": "", "problem_statement": "Home Assistant Cloud: Naming and description of \"Remote connect\" action misleading\n### The problem\n\nThe Home Assistant Cloud integration provides two actions which actually toggle this setting on and off:\r\n\r\n![Screenshot 2024-11-03 17 08 10](https://github.com/user-attachments/assets/75503d92-4c8c-43e3-b40d-5fbb4c9921bb)\r\n\r\nBut given the current naming of these actions it's easy to completely misunderstand their purpose:\r\n\r\nhttps://github.com/home-assistant/core/blob/fbe27749a046e5c60bf92bf7ecd38675c90c9ed3/homeassistant/components/cloud/strings.json#L69-L76\r\n\r\nShould be changed to something like the following:\r\n\r\n     \"name\": \"Enable Remote access\",\r\n     \"description\": \"Makes the instance UI accessible from outside of the local network by enabling your Home Assistant Cloud connection.\"\r\n\r\n     \"name\": \"Disable Remote access\",\r\n     \"description\": \"Disconnects the instance UI from Home Assistant Cloud. This disables access to it from outside your local network.\"\r\n\r\nThe rewording of the first description also takes into account that you need to have this set up before this will work at all.\r\n\r\n\r\nTo prove my point the current German translation was:\r\n\r\n\"Fernverbindung aufbauen\" / \"Fernverbindung trennen\"\r\n\r\nwhich means\r\n\r\n\"Establish a remote connection\" / Disconnect a remote connection\"\r\n\r\nThis can be avoided by using \"Remote access\" from the UI here as well.\n\n### What version of Home Assistant Core has the issue?\n\n2024.11.0b2\n\n### What was the last working version of Home Assistant Core?\n\nn/a\n\n### What type of installation are you running?\n\nHome Assistant OS\n\n### Integration causing the issue\n\nHome Assistant Cloud\n\n### Link to integration documentation on our website\n\nhttps://www.home-assistant.io/integrations/cloud/\n\n### Diagnostics information\n\n_No response_\n\n### Example YAML snippet\n\n_No response_\n\n### Anything in the logs that might be useful for us?\n\n_No response_\n\n### Additional information\n\n_No response_\n", "hints_text": "\nHey there @home-assistant/cloud, mind taking a look at this issue as it has been labeled with an integration (`cloud`) you are listed as a [code owner](https://github.com/home-assistant/core/blob/dev/CODEOWNERS#L259) for? Thanks!\n\n<details>\n<summary>Code owner commands</summary>\n\n\nCode owners of `cloud` can trigger bot actions by commenting:\n\n- `@home-assistant close` Closes the issue.\n- `@home-assistant rename Awesome new title` Renames the issue.\n- `@home-assistant reopen` Reopen the issue.\n- `@home-assistant unassign cloud` Removes the current integration label and assignees on the issue, add the integration domain after the command.\n- `@home-assistant add-label needs-more-information` Add a label (needs-more-information, problem in dependency, problem in custom component) to the issue.\n- `@home-assistant remove-label needs-more-information` Remove a label (needs-more-information, problem in dependency, problem in custom component) on the issue.\n\n</details>\n\n\n<sub><sup>(message by CodeOwnersMention)</sup></sub>\n\n---\n\n[cloud documentation](https://www.home-assistant.io/integrations/cloud)\n[cloud source](https://github.com/home-assistant/core/tree/dev/homeassistant/components/cloud)\n<sub><sup>(message by IssueLinks)</sup></sub>\nCan I make a PR for the change?\r\n```\r\n\"services\": {\r\n    \"remote_connect\": {\r\n      \"name\": \"Remote connect\",\r\n      \"description\": \"Makes the instance UI accessible from outside of the local network by enabling your Home Assistant Cloud connection.\"\r\n    },\r\n    \"remote_disconnect\": {\r\n      \"name\": \"Remote disconnect\",\r\n      \"description\": \"Disconnects the instance UI from Home Assistant Cloud. This disables access to it from outside your local network.\"\r\n    }\r\n  }\r\n```", "created_at": "2024-12-01T10:34:10Z"}
{"repo": "home-assistant/core", "pull_number": 131973, "instance_id": "home-assistant__core-131973", "issue_numbers": ["98578"], "base_commit": "2b907ee56e8eba05b8af46eab97c75ba3337b676", "patch": "diff --git a/homeassistant/components/homekit/util.py b/homeassistant/components/homekit/util.py\nindex d540a88d6e67a7..d339aa6aded34a 100644\n--- a/homeassistant/components/homekit/util.py\n+++ b/homeassistant/components/homekit/util.py\n@@ -434,20 +434,12 @@ def cleanup_name_for_homekit(name: str | None) -> str:\n \n def temperature_to_homekit(temperature: float, unit: str) -> float:\n     \"\"\"Convert temperature to Celsius for HomeKit.\"\"\"\n-    return round(\n-        TemperatureConverter.convert(temperature, unit, UnitOfTemperature.CELSIUS), 1\n-    )\n+    return TemperatureConverter.convert(temperature, unit, UnitOfTemperature.CELSIUS)\n \n \n def temperature_to_states(temperature: float, unit: str) -> float:\n     \"\"\"Convert temperature back from Celsius to Home Assistant unit.\"\"\"\n-    return (\n-        round(\n-            TemperatureConverter.convert(temperature, UnitOfTemperature.CELSIUS, unit)\n-            * 2\n-        )\n-        / 2\n-    )\n+    return TemperatureConverter.convert(temperature, UnitOfTemperature.CELSIUS, unit)\n \n \n def density_to_air_quality(density: float) -> int:\n", "test_patch": "diff --git a/tests/components/homekit/test_type_thermostats.py b/tests/components/homekit/test_type_thermostats.py\nindex 8454610566b44d..e99db8f6234aa0 100644\n--- a/tests/components/homekit/test_type_thermostats.py\n+++ b/tests/components/homekit/test_type_thermostats.py\n@@ -921,8 +921,8 @@ async def test_thermostat_fahrenheit(\n     await hass.async_block_till_done()\n     assert call_set_temperature[0]\n     assert call_set_temperature[0].data[ATTR_ENTITY_ID] == entity_id\n-    assert call_set_temperature[0].data[ATTR_TARGET_TEMP_HIGH] == 73.5\n-    assert call_set_temperature[0].data[ATTR_TARGET_TEMP_LOW] == 68\n+    assert call_set_temperature[0].data[ATTR_TARGET_TEMP_HIGH] == 73.4\n+    assert call_set_temperature[0].data[ATTR_TARGET_TEMP_LOW] == 68.18\n     assert len(events) == 1\n     assert events[-1].data[ATTR_VALUE] == \"CoolingThresholdTemperature to 23\u00b0C\"\n \n@@ -942,8 +942,8 @@ async def test_thermostat_fahrenheit(\n     await hass.async_block_till_done()\n     assert call_set_temperature[1]\n     assert call_set_temperature[1].data[ATTR_ENTITY_ID] == entity_id\n-    assert call_set_temperature[1].data[ATTR_TARGET_TEMP_HIGH] == 73.5\n-    assert call_set_temperature[1].data[ATTR_TARGET_TEMP_LOW] == 71.5\n+    assert call_set_temperature[1].data[ATTR_TARGET_TEMP_HIGH] == 73.4\n+    assert call_set_temperature[1].data[ATTR_TARGET_TEMP_LOW] == 71.6\n     assert len(events) == 2\n     assert events[-1].data[ATTR_VALUE] == \"HeatingThresholdTemperature to 22\u00b0C\"\n \n@@ -962,7 +962,7 @@ async def test_thermostat_fahrenheit(\n     await hass.async_block_till_done()\n     assert call_set_temperature[2]\n     assert call_set_temperature[2].data[ATTR_ENTITY_ID] == entity_id\n-    assert call_set_temperature[2].data[ATTR_TEMPERATURE] == 75.0\n+    assert call_set_temperature[2].data[ATTR_TEMPERATURE] == 75.2\n     assert len(events) == 3\n     assert events[-1].data[ATTR_VALUE] == \"TargetTemperature to 24.0\u00b0C\"\n \ndiff --git a/tests/components/homekit/test_util.py b/tests/components/homekit/test_util.py\nindex e544362acc0628..853db54b9926d9 100644\n--- a/tests/components/homekit/test_util.py\n+++ b/tests/components/homekit/test_util.py\n@@ -280,14 +280,16 @@ def test_cleanup_name_for_homekit() -> None:\n \n def test_temperature_to_homekit() -> None:\n     \"\"\"Test temperature conversion from HA to HomeKit.\"\"\"\n-    assert temperature_to_homekit(20.46, UnitOfTemperature.CELSIUS) == 20.5\n-    assert temperature_to_homekit(92.1, UnitOfTemperature.FAHRENHEIT) == 33.4\n+    assert temperature_to_homekit(20.46, UnitOfTemperature.CELSIUS) == 20.46\n+    assert temperature_to_homekit(92.1, UnitOfTemperature.FAHRENHEIT) == pytest.approx(\n+        33.388888888888886\n+    )\n \n \n def test_temperature_to_states() -> None:\n     \"\"\"Test temperature conversion from HomeKit to HA.\"\"\"\n     assert temperature_to_states(20, UnitOfTemperature.CELSIUS) == 20.0\n-    assert temperature_to_states(20.2, UnitOfTemperature.FAHRENHEIT) == 68.5\n+    assert temperature_to_states(20.2, UnitOfTemperature.FAHRENHEIT) == 68.36\n \n \n def test_density_to_air_quality() -> None:\n", "problem_statement": "Thermostat rounding errors - changing setpoint\n### The problem\n\nHoping I got in the right section.\r\nI have a Honeywell (Residio) thermostat that is integrated via HomeKit Device.   There is at least one temperature set point that when selected, a few seconds later the set point changes.   For example, if I set it to 73....it changes to 74.   I wonder if the set point is stored in C and rounded somewhat when it displays in F.\r\nHappy to provide any additional info.\n\n### What version of Home Assistant Core has the issue?\n\ncore-2023.8.2\n\n### What was the last working version of Home Assistant Core?\n\n_No response_\n\n### What type of installation are you running?\n\nHome Assistant OS\n\n### Integration causing the issue\n\nHomekit Device\n\n### Link to integration documentation on our website\n\n_No response_\n\n### Diagnostics information\n\n_No response_\n\n### Example YAML snippet\n\n_No response_\n\n### Anything in the logs that might be useful for us?\n\n_No response_\n\n### Additional information\n\n_No response_\n", "hints_text": "I'm having the same issue.\nHere is a previous issue where they asked to open a new issue.\r\nhttps://github.com/home-assistant/core/issues/30039\n\nHey there @bdraco, mind taking a look at this issue as it has been labeled with an integration (`homekit`) you are listed as a [code owner](https://github.com/home-assistant/core/blob/dev/CODEOWNERS#L534) for? Thanks!\n\n<details>\n<summary>Code owner commands</summary>\n\n\nCode owners of `homekit` can trigger bot actions by commenting:\n\n- `@home-assistant close` Closes the issue.\n- `@home-assistant rename Awesome new title` Renames the issue.\n- `@home-assistant reopen` Reopen the issue.\n- `@home-assistant unassign homekit` Removes the current integration label and assignees on the issue, add the integration domain after the command.\n\n</details>\n\n\n<sub><sup>(message by CodeOwnersMention)</sup></sub>\n\n---\n\n[homekit documentation](https://www.home-assistant.io/integrations/homekit)\n[homekit source](https://github.com/home-assistant/core/tree/dev/homeassistant/components/homekit)\n<sub><sup>(message by IssueLinks)</sup></sub>\nHomeKit does everything in C. There is always going to be a conversion loss that we can't fix.\nCan we reduce the step value of the conversion then, maybe to .1? Right now it is impossible to set the thermostat to certain values, including 73 and 74. \nI think I experienced a similar issue while working on #95696 , setting temperature in \u00b0C in the UI when the native unit is \u00b0F seems to not round towards the nearest PRECISION_HALVES or PRECISION_WHOLE as requested by the device. But I didn't spend enough time to troubleshoot this, it maybe a Lyric integration issue.\n> Can we reduce the step value of the conversion then, maybe to .1?\r\n\r\nIt already is 0.1\r\n\r\nhttps://github.com/home-assistant/core/blob/4073f56c5eb4205457b219d3f04a2edd868fa279/homeassistant/components/homekit/type_thermostats.py#L230\nIf the data is actually stored in C and it's rounded to tenths, I don't see how this is an issue. \r\nSee table below\r\n<img width=\"522\" alt=\"image\" src=\"https://github.com/home-assistant/core/assets/54906719/3dcd9170-df76-4eeb-8197-531af62191d8\">\r\n\nYeah, it's definitely not working the way it's intended. I have to switch to the native app to set it to 73\u00b0, and I have to set it to 73\u00b0 in order to get 74\u00b0. \nThere hasn't been any activity on this issue recently. Due to the high number of incoming GitHub notifications, we have to clean some of the old issues, as many of them have already been resolved with the latest updates.\nPlease make sure to update to the latest Home Assistant version and check if that solves the issue. Let us know if that works for you by adding a comment \ud83d\udc4d\nThis issue has now been marked as stale and will be closed if no further activity occurs. Thank you for your contributions.\nThis is still an issue. \n@bdraco If I enable debug logging for homekit, it seems like it is using half degree steps. I set the thermostat to 73\u00b0, and the PUT request is for 23.0 rather than 22.8. There are then two callbacks, the first for 23.0, the second for 23.5, which rounds to 74\u00b0.\r\n```\r\n2024-02-28 09:44:40.469 DEBUG (MainThread) [aiohomekit.controller.ip.connection] 192.168.5.189: raw request: b'PUT /characteristics HTTP/1.1\\r\\nHost: 192.168.5.189\\r\\nContent-Length: 53\\r\\nContent-Type: application/hap+json\\r\\n\\r\\n{\"characteristics\":[{\"aid\":2,\"iid\":38,\"value\":23.0}]}'\r\n2024-02-28 09:44:41.059 DEBUG (MainThread) [aiohomekit.controller.ip.connection] 192.168.5.189: raw response: bytearray(b'')\r\n2024-02-28 09:44:41.059 DEBUG (MainThread) [aiohomekit.controller.abstract] callback ev:{(2, 38): {'value': 23.0}}\r\n2024-02-28 09:44:41.059 DEBUG (MainThread) [homeassistant.components.homekit_controller.connection] Called async_set_available_state with True for 55:2F:E4:FE:04:26\r\n2024-02-28 09:44:41.215 DEBUG (MainThread) [aiohomekit.controller.abstract] callback ev:{(2, 38): {'value': 23.5}}\r\n2024-02-28 09:44:41.216 DEBUG (MainThread) [homeassistant.components.homekit_controller.connection] Called async_set_available_state with True for 55:2F:E4:FE:04:26\r\n2024-02-28 09:44:50.150 DEBUG (MainThread) [aiohomekit.controller.abstract] callback ev:{(2, 41): {'value': 50}}\r\n2024-02-28 09:44:50.150 DEBUG (MainThread) [homeassistant.components.homekit_controller.connection] Called async_set_available_state with True for 55:2F:E4:FE:04:26\r\n```\r\n\r\nIs this due to https://github.com/home-assistant/core/issues/45332#issuecomment-764377184?\nThere hasn't been any activity on this issue recently. Due to the high number of incoming GitHub notifications, we have to clean some of the old issues, as many of them have already been resolved with the latest updates.\nPlease make sure to update to the latest Home Assistant version and check if that solves the issue. Let us know if that works for you by adding a comment \ud83d\udc4d\nThis issue has now been marked as stale and will be closed if no further activity occurs. Thank you for your contributions.\nThis is still an active issue.\nThere hasn't been any activity on this issue recently. Due to the high number of incoming GitHub notifications, we have to clean some of the old issues, as many of them have already been resolved with the latest updates.\nPlease make sure to update to the latest Home Assistant version and check if that solves the issue. Let us know if that works for you by adding a comment \ud83d\udc4d\nThis issue has now been marked as stale and will be closed if no further activity occurs. Thank you for your contributions.\n@bdraco This is still an issue. Is there any progress on this? I cannot set my thermostats to 73\u00b0.\nThere hasn't been any activity on this issue recently. Due to the high number of incoming GitHub notifications, we have to clean some of the old issues, as many of them have already been resolved with the latest updates.\nPlease make sure to update to the latest Home Assistant version and check if that solves the issue. Let us know if that works for you by adding a comment \ud83d\udc4d\nThis issue has now been marked as stale and will be closed if no further activity occurs. Thank you for your contributions.\nStill an issue \n> @bdraco If I enable debug logging for homekit, it seems like it is using half degree steps. I set the thermostat to 73\u00b0, and the PUT request is for 23.0 rather than 22.8. There are then two callbacks, the first for 23.0, the second for 23.5, which rounds to 74\u00b0.\r\n> \r\n> ```\r\n> 2024-02-28 09:44:40.469 DEBUG (MainThread) [aiohomekit.controller.ip.connection] 192.168.5.189: raw request: b'PUT /characteristics HTTP/1.1\\r\\nHost: 192.168.5.189\\r\\nContent-Length: 53\\r\\nContent-Type: application/hap+json\\r\\n\\r\\n{\"characteristics\":[{\"aid\":2,\"iid\":38,\"value\":23.0}]}'\r\n> 2024-02-28 09:44:41.059 DEBUG (MainThread) [aiohomekit.controller.ip.connection] 192.168.5.189: raw response: bytearray(b'')\r\n> 2024-02-28 09:44:41.059 DEBUG (MainThread) [aiohomekit.controller.abstract] callback ev:{(2, 38): {'value': 23.0}}\r\n> 2024-02-28 09:44:41.059 DEBUG (MainThread) [homeassistant.components.homekit_controller.connection] Called async_set_available_state with True for 55:2F:E4:FE:04:26\r\n> 2024-02-28 09:44:41.215 DEBUG (MainThread) [aiohomekit.controller.abstract] callback ev:{(2, 38): {'value': 23.5}}\r\n> 2024-02-28 09:44:41.216 DEBUG (MainThread) [homeassistant.components.homekit_controller.connection] Called async_set_available_state with True for 55:2F:E4:FE:04:26\r\n> 2024-02-28 09:44:50.150 DEBUG (MainThread) [aiohomekit.controller.abstract] callback ev:{(2, 41): {'value': 50}}\r\n> 2024-02-28 09:44:50.150 DEBUG (MainThread) [homeassistant.components.homekit_controller.connection] Called async_set_available_state with True for 55:2F:E4:FE:04:26\r\n> ```\r\n> \r\n> Is this due to [#45332 (comment)](https://github.com/home-assistant/core/issues/45332#issuecomment-764377184)?\r\n\r\nThe debug logs you posted are for `homekit_controller`.  The homekit bridge integration will have debug logs under `pyhap`", "created_at": "2024-11-30T20:47:24Z"}
{"repo": "home-assistant/core", "pull_number": 131971, "instance_id": "home-assistant__core-131971", "issue_numbers": ["126296"], "base_commit": "bcdac7ed3785473fb8962d48eab96a6133cb41ca", "patch": "diff --git a/homeassistant/components/homekit/util.py b/homeassistant/components/homekit/util.py\nindex b255d4c79dd377..d540a88d6e67a7 100644\n--- a/homeassistant/components/homekit/util.py\n+++ b/homeassistant/components/homekit/util.py\n@@ -114,7 +114,7 @@\n \n NUMBERS_ONLY_RE = re.compile(r\"[^\\d.]+\")\n VERSION_RE = re.compile(r\"([0-9]+)(\\.[0-9]+)?(\\.[0-9]+)?\")\n-INVALID_END_CHARS = \"-_\"\n+INVALID_END_CHARS = \"-_ \"\n MAX_VERSION_PART = 2**32 - 1\n \n \n", "test_patch": "diff --git a/tests/components/homekit/test_accessories.py b/tests/components/homekit/test_accessories.py\nindex c37cac84b8ab55..00cf42bb916311 100644\n--- a/tests/components/homekit/test_accessories.py\n+++ b/tests/components/homekit/test_accessories.py\n@@ -121,7 +121,7 @@ async def test_home_accessory(hass: HomeAssistant, hk_driver) -> None:\n     serv = acc3.services[0]  # SERV_ACCESSORY_INFO\n     assert (\n         serv.get_characteristic(CHAR_NAME).value\n-        == \"Home Accessory that exceeds the maximum maximum maximum maximum \"\n+        == \"Home Accessory that exceeds the maximum maximum maximum maximum\"\n     )\n     assert (\n         serv.get_characteristic(CHAR_MANUFACTURER).value\n@@ -154,7 +154,7 @@ async def test_home_accessory(hass: HomeAssistant, hk_driver) -> None:\n     serv = acc4.services[0]  # SERV_ACCESSORY_INFO\n     assert (\n         serv.get_characteristic(CHAR_NAME).value\n-        == \"Home Accessory that exceeds the maximum maximum maximum maximum \"\n+        == \"Home Accessory that exceeds the maximum maximum maximum maximum\"\n     )\n     assert (\n         serv.get_characteristic(CHAR_MANUFACTURER).value\ndiff --git a/tests/components/homekit/test_util.py b/tests/components/homekit/test_util.py\nindex ebd260de05406a..e544362acc0628 100644\n--- a/tests/components/homekit/test_util.py\n+++ b/tests/components/homekit/test_util.py\n@@ -268,6 +268,7 @@ def test_cleanup_name_for_homekit() -> None:\n     \"\"\"Ensure name sanitize works as expected.\"\"\"\n \n     assert cleanup_name_for_homekit(\"abc\") == \"abc\"\n+    assert cleanup_name_for_homekit(\"abc \") == \"abc\"\n     assert cleanup_name_for_homekit(\"a b c\") == \"a b c\"\n     assert cleanup_name_for_homekit(\"ab_c\") == \"ab c\"\n     assert (\n", "problem_statement": "space after device name when setting up homekit\n### The problem\n\nI've found that often if a device does not have its own name in HASS when that device is added to Homekit it throws an error becauise there is a space after the suggested name for the device while setting up the bridge.\n\n### What version of Home Assistant Core has the issue?\n\ncore-2024.8.0\n\n### What was the last working version of Home Assistant Core?\n\n_No response_\n\n### What type of installation are you running?\n\nHome Assistant OS\n\n### Integration causing the issue\n\nhomekit\n\n### Link to integration documentation on our website\n\nhttps://www.home-assistant.io/integrations/homekit/\n\n### Diagnostics information\n\n_No response_\n\n### Example YAML snippet\n\n_No response_\n\n### Anything in the logs that might be useful for us?\n\n_No response_\n\n### Additional information\n\n_No response_\n", "hints_text": "\nHey there @bdraco, mind taking a look at this issue as it has been labeled with an integration (`homekit`) you are listed as a [code owner](https://github.com/home-assistant/core/blob/dev/CODEOWNERS#L632) for? Thanks!\n\n<details>\n<summary>Code owner commands</summary>\n\n\nCode owners of `homekit` can trigger bot actions by commenting:\n\n- `@home-assistant close` Closes the issue.\n- `@home-assistant rename Awesome new title` Renames the issue.\n- `@home-assistant reopen` Reopen the issue.\n- `@home-assistant unassign homekit` Removes the current integration label and assignees on the issue, add the integration domain after the command.\n- `@home-assistant add-label needs-more-information` Add a label (needs-more-information, problem in dependency, problem in custom component) to the issue.\n- `@home-assistant remove-label needs-more-information` Remove a label (needs-more-information, problem in dependency, problem in custom component) on the issue.\n\n</details>\n\n\n<sub><sup>(message by CodeOwnersMention)</sup></sub>\n\n---\n\n[homekit documentation](https://www.home-assistant.io/integrations/homekit)\n[homekit source](https://github.com/home-assistant/core/tree/dev/homeassistant/components/homekit)\n<sub><sup>(message by IssueLinks)</sup></sub>\nthere is also a chance this is related to entities that are created by the switch -> light option, at least for me that is where this shows up the most.\n\r\n> it throws an error\r\n\r\nPlease provide more information about what error you are referencing.\r\n\r\nIf there is a traceback, please post it.\r\n\r\nIf its an error on iOS, please include a screenshot\r\n\nthe error is when you add the bridge, and then the devices show up on iOS, and you try to save them but it can't.  you need to backspace the name to remove the empty character, and then save.  it works, just a pain.  also I have an issue with helpers  showing no response in home, and think its related to the same thing.  if remove the bridge fix name, and readd it works.", "created_at": "2024-11-30T20:13:52Z"}
{"repo": "home-assistant/core", "pull_number": 131963, "instance_id": "home-assistant__core-131963", "issue_numbers": ["99218"], "base_commit": "13a37da91756858d84ec5aedf16a49060ed8a96c", "patch": "diff --git a/.github/workflows/wheels.yml b/.github/workflows/wheels.yml\nindex 749f95fa922164..a36b3073aab058 100644\n--- a/.github/workflows/wheels.yml\n+++ b/.github/workflows/wheels.yml\n@@ -197,33 +197,6 @@ jobs:\n \n           split -l $(expr $(expr $(cat requirements_all.txt | wc -l) + 1) / 3) requirements_all_wheels_${{ matrix.arch }}.txt requirements_all.txt\n \n-      - name: Create requirements for cython<3\n-        if: matrix.abi == 'cp312'\n-        run: |\n-          # Some dependencies still require 'cython<3'\n-          # and don't yet use isolated build environments.\n-          # Build these first.\n-          # pydantic: https://github.com/pydantic/pydantic/issues/7689\n-\n-          touch requirements_old-cython.txt\n-          cat homeassistant/package_constraints.txt | grep 'pydantic==' >> requirements_old-cython.txt\n-\n-      - name: Build wheels (old cython)\n-        uses: home-assistant/wheels@2024.11.0\n-        if: matrix.abi == 'cp312'\n-        with:\n-          abi: ${{ matrix.abi }}\n-          tag: musllinux_1_2\n-          arch: ${{ matrix.arch }}\n-          wheels-key: ${{ secrets.WHEELS_KEY }}\n-          env-file: true\n-          apk: \"bluez-dev;libffi-dev;openssl-dev;glib-dev;eudev-dev;libxml2-dev;libxslt-dev;libpng-dev;libjpeg-turbo-dev;tiff-dev;cups-dev;gmp-dev;mpfr-dev;mpc1-dev;ffmpeg-dev;gammu-dev;yaml-dev;openblas-dev;fftw-dev;lapack-dev;gfortran;blas-dev;eigen-dev;freetype-dev;glew-dev;harfbuzz-dev;hdf5-dev;libdc1394-dev;libtbb-dev;mesa-dev;openexr-dev;openjpeg-dev;uchardet-dev\"\n-          skip-binary: aiohttp;charset-normalizer;grpcio;multidict;SQLAlchemy;propcache;protobuf;pydantic;pymicro-vad;yarl\n-          constraints: \"homeassistant/package_constraints.txt\"\n-          requirements-diff: \"requirements_diff.txt\"\n-          requirements: \"requirements_old-cython.txt\"\n-          pip: \"'cython<3'\"\n-\n       - name: Build wheels (part 1)\n         uses: home-assistant/wheels@2024.11.0\n         with:\ndiff --git a/homeassistant/components/aussie_broadband/manifest.json b/homeassistant/components/aussie_broadband/manifest.json\nindex 877a46a3650684..456b8962461303 100644\n--- a/homeassistant/components/aussie_broadband/manifest.json\n+++ b/homeassistant/components/aussie_broadband/manifest.json\n@@ -6,5 +6,5 @@\n   \"documentation\": \"https://www.home-assistant.io/integrations/aussie_broadband\",\n   \"iot_class\": \"cloud_polling\",\n   \"loggers\": [\"aussiebb\"],\n-  \"requirements\": [\"pyaussiebb==0.0.15\"]\n+  \"requirements\": [\"pyaussiebb==0.1.4\"]\n }\ndiff --git a/homeassistant/components/bang_olufsen/const.py b/homeassistant/components/bang_olufsen/const.py\nindex 209311d3e8aae2..81345d3f5cbeef 100644\n--- a/homeassistant/components/bang_olufsen/const.py\n+++ b/homeassistant/components/bang_olufsen/const.py\n@@ -137,7 +137,7 @@ class WebsocketNotification(StrEnum):\n # Fallback sources to use in case of API failure.\n FALLBACK_SOURCES: Final[SourceArray] = SourceArray(\n     items=[\n-        Source(\n+        Source(  # type: ignore[call-arg]\n             id=\"uriStreamer\",\n             is_enabled=True,\n             is_playable=True,\n@@ -145,7 +145,7 @@ class WebsocketNotification(StrEnum):\n             type=SourceTypeEnum(value=\"uriStreamer\"),\n             is_seekable=False,\n         ),\n-        Source(\n+        Source(  # type: ignore[call-arg]\n             id=\"bluetooth\",\n             is_enabled=True,\n             is_playable=True,\n@@ -153,7 +153,7 @@ class WebsocketNotification(StrEnum):\n             type=SourceTypeEnum(value=\"bluetooth\"),\n             is_seekable=False,\n         ),\n-        Source(\n+        Source(  # type: ignore[call-arg]\n             id=\"spotify\",\n             is_enabled=True,\n             is_playable=True,\n@@ -161,7 +161,7 @@ class WebsocketNotification(StrEnum):\n             type=SourceTypeEnum(value=\"spotify\"),\n             is_seekable=True,\n         ),\n-        Source(\n+        Source(  # type: ignore[call-arg]\n             id=\"lineIn\",\n             is_enabled=True,\n             is_playable=True,\n@@ -169,7 +169,7 @@ class WebsocketNotification(StrEnum):\n             type=SourceTypeEnum(value=\"lineIn\"),\n             is_seekable=False,\n         ),\n-        Source(\n+        Source(  # type: ignore[call-arg]\n             id=\"spdif\",\n             is_enabled=True,\n             is_playable=True,\n@@ -177,7 +177,7 @@ class WebsocketNotification(StrEnum):\n             type=SourceTypeEnum(value=\"spdif\"),\n             is_seekable=False,\n         ),\n-        Source(\n+        Source(  # type: ignore[call-arg]\n             id=\"netRadio\",\n             is_enabled=True,\n             is_playable=True,\n@@ -185,7 +185,7 @@ class WebsocketNotification(StrEnum):\n             type=SourceTypeEnum(value=\"netRadio\"),\n             is_seekable=False,\n         ),\n-        Source(\n+        Source(  # type: ignore[call-arg]\n             id=\"deezer\",\n             is_enabled=True,\n             is_playable=True,\n@@ -193,7 +193,7 @@ class WebsocketNotification(StrEnum):\n             type=SourceTypeEnum(value=\"deezer\"),\n             is_seekable=True,\n         ),\n-        Source(\n+        Source(  # type: ignore[call-arg]\n             id=\"tidalConnect\",\n             is_enabled=True,\n             is_playable=True,\ndiff --git a/homeassistant/components/bang_olufsen/entity.py b/homeassistant/components/bang_olufsen/entity.py\nindex 8ed68da1678042..77fe7c6a1ff91a 100644\n--- a/homeassistant/components/bang_olufsen/entity.py\n+++ b/homeassistant/components/bang_olufsen/entity.py\n@@ -42,7 +42,7 @@ def __init__(self, entry: ConfigEntry, client: MozartClient) -> None:\n \n         # Objects that get directly updated by notifications.\n         self._playback_metadata: PlaybackContentMetadata = PlaybackContentMetadata()\n-        self._playback_progress: PlaybackProgress = PlaybackProgress(total_duration=0)\n+        self._playback_progress: PlaybackProgress = PlaybackProgress(total_duration=0)  # type: ignore[call-arg]\n         self._playback_source: Source = Source()\n         self._playback_state: RenderingState = RenderingState()\n         self._source_change: Source = Source()\ndiff --git a/homeassistant/components/bang_olufsen/media_player.py b/homeassistant/components/bang_olufsen/media_player.py\nindex 96e7cca017512d..84b88b3054477f 100644\n--- a/homeassistant/components/bang_olufsen/media_player.py\n+++ b/homeassistant/components/bang_olufsen/media_player.py\n@@ -205,9 +205,9 @@ def __init__(self, entry: ConfigEntry, client: MozartClient) -> None:\n         # Misc. variables.\n         self._audio_sources: dict[str, str] = {}\n         self._media_image: Art = Art()\n-        self._software_status: SoftwareUpdateStatus = SoftwareUpdateStatus(\n+        self._software_status: SoftwareUpdateStatus = SoftwareUpdateStatus(  # type: ignore[call-arg]\n             software_version=\"\",\n-            state=SoftwareUpdateState(seconds_remaining=0, value=\"idle\"),\n+            state=SoftwareUpdateState(seconds_remaining=0, value=\"idle\"),  # type: ignore[call-arg]\n         )\n         self._sources: dict[str, str] = {}\n         self._state: str = MediaPlayerState.IDLE\n@@ -891,9 +891,9 @@ async def async_play_media(\n \n         elif media_type == BangOlufsenMediaType.RADIO:\n             await self._client.run_provided_scene(\n-                scene_properties=SceneProperties(\n+                scene_properties=SceneProperties(  # type: ignore[call-arg]\n                     action_list=[\n-                        Action(\n+                        Action(  # type: ignore[call-arg]\n                             type=\"radio\",\n                             radio_station_id=media_id,\n                         )\n@@ -914,7 +914,7 @@ async def async_play_media(\n                         deezer_id = kwargs[ATTR_MEDIA_EXTRA][\"id\"]\n \n                     await self._client.start_deezer_flow(\n-                        user_flow=UserFlow(user_id=deezer_id)\n+                        user_flow=UserFlow(user_id=deezer_id)  # type: ignore[call-arg]\n                     )\n \n                 # Play a playlist or album.\n@@ -924,7 +924,7 @@ async def async_play_media(\n                         start_from = kwargs[ATTR_MEDIA_EXTRA][\"start_from\"]\n \n                     await self._client.add_to_queue(\n-                        play_queue_item=PlayQueueItem(\n+                        play_queue_item=PlayQueueItem(  # type: ignore[call-arg]\n                             provider=PlayQueueItemType(value=media_type),\n                             start_now_from_position=start_from,\n                             type=\"playlist\",\n@@ -935,7 +935,7 @@ async def async_play_media(\n                 # Play a track.\n                 else:\n                     await self._client.add_to_queue(\n-                        play_queue_item=PlayQueueItem(\n+                        play_queue_item=PlayQueueItem(  # type: ignore[call-arg]\n                             provider=PlayQueueItemType(value=media_type),\n                             start_now_from_position=0,\n                             type=\"track\",\ndiff --git a/homeassistant/components/google/__init__.py b/homeassistant/components/google/__init__.py\nindex 2ad400aababd75..1d2048835790ea 100644\n--- a/homeassistant/components/google/__init__.py\n+++ b/homeassistant/components/google/__init__.py\n@@ -277,10 +277,10 @@ async def _add_event(call: ServiceCall) -> None:\n         elif EVENT_START_DATETIME in call.data and EVENT_END_DATETIME in call.data:\n             start_dt = call.data[EVENT_START_DATETIME]\n             end_dt = call.data[EVENT_END_DATETIME]\n-            start = DateOrDatetime(\n+            start = DateOrDatetime(  # type: ignore[call-arg]\n                 date_time=start_dt, timezone=str(hass.config.time_zone)\n             )\n-            end = DateOrDatetime(date_time=end_dt, timezone=str(hass.config.time_zone))\n+            end = DateOrDatetime(date_time=end_dt, timezone=str(hass.config.time_zone))  # type: ignore[call-arg]\n \n         if start is None or end is None:\n             raise ValueError(\ndiff --git a/homeassistant/components/google/calendar.py b/homeassistant/components/google/calendar.py\nindex 5ac5dae616c4d6..045e0e31b468c5 100644\n--- a/homeassistant/components/google/calendar.py\n+++ b/homeassistant/components/google/calendar.py\n@@ -272,7 +272,7 @@ async def async_setup_entry(\n                     entity_description.search,\n                 )\n             else:\n-                request_template = SyncEventsRequest(\n+                request_template = SyncEventsRequest(  # type: ignore[call-arg]\n                     calendar_id=calendar_id,\n                     start_time=dt_util.now() + SYNC_EVENT_MIN_TIME,\n                 )\n@@ -437,11 +437,11 @@ async def async_create_event(self, **kwargs: Any) -> None:\n         start: DateOrDatetime\n         end: DateOrDatetime\n         if isinstance(dtstart, datetime):\n-            start = DateOrDatetime(\n+            start = DateOrDatetime(  # type: ignore[call-arg]\n                 date_time=dt_util.as_local(dtstart),\n                 timezone=str(dt_util.get_default_time_zone()),\n             )\n-            end = DateOrDatetime(\n+            end = DateOrDatetime(  # type: ignore[call-arg]\n                 date_time=dt_util.as_local(dtend),\n                 timezone=str(dt_util.get_default_time_zone()),\n             )\n@@ -543,8 +543,8 @@ async def async_create_event(entity: GoogleCalendarEntity, call: ServiceCall) ->\n     elif EVENT_START_DATETIME in call.data and EVENT_END_DATETIME in call.data:\n         start_dt = call.data[EVENT_START_DATETIME]\n         end_dt = call.data[EVENT_END_DATETIME]\n-        start = DateOrDatetime(date_time=start_dt, timezone=str(hass.config.time_zone))\n-        end = DateOrDatetime(date_time=end_dt, timezone=str(hass.config.time_zone))\n+        start = DateOrDatetime(date_time=start_dt, timezone=str(hass.config.time_zone))  # type: ignore[call-arg]\n+        end = DateOrDatetime(date_time=end_dt, timezone=str(hass.config.time_zone))  # type: ignore[call-arg]\n \n     if start is None or end is None:\n         raise ValueError(\"Missing required fields to set start or end date/datetime\")\ndiff --git a/homeassistant/components/google/coordinator.py b/homeassistant/components/google/coordinator.py\nindex 19198041c05616..06f337824792d4 100644\n--- a/homeassistant/components/google/coordinator.py\n+++ b/homeassistant/components/google/coordinator.py\n@@ -131,7 +131,7 @@ async def async_get_events(\n         self, start_date: datetime, end_date: datetime\n     ) -> Iterable[Event]:\n         \"\"\"Get all events in a specific time frame.\"\"\"\n-        request = ListEventsRequest(\n+        request = ListEventsRequest(  # type: ignore[call-arg]\n             calendar_id=self.calendar_id,\n             start_time=start_date,\n             end_time=end_date,\n@@ -149,7 +149,7 @@ async def async_get_events(\n \n     async def _async_update_data(self) -> list[Event]:\n         \"\"\"Fetch data from API endpoint.\"\"\"\n-        request = ListEventsRequest(calendar_id=self.calendar_id, search=self._search)\n+        request = ListEventsRequest(calendar_id=self.calendar_id, search=self._search)  # type: ignore[call-arg]\n         try:\n             result = await self.calendar_service.async_list_events(request)\n         except ApiException as err:\ndiff --git a/homeassistant/components/purpleair/diagnostics.py b/homeassistant/components/purpleair/diagnostics.py\nindex a3b3af857fb105..30f1deeb36844e 100644\n--- a/homeassistant/components/purpleair/diagnostics.py\n+++ b/homeassistant/components/purpleair/diagnostics.py\n@@ -37,7 +37,7 @@ async def async_get_config_entry_diagnostics(\n     return async_redact_data(\n         {\n             \"entry\": entry.as_dict(),\n-            \"data\": coordinator.data.dict(),\n+            \"data\": coordinator.data.dict(),  # type: ignore[deprecated]\n         },\n         TO_REDACT,\n     )\ndiff --git a/homeassistant/components/purpleair/manifest.json b/homeassistant/components/purpleair/manifest.json\nindex cf74365d6d83cc..87cb375c347b54 100644\n--- a/homeassistant/components/purpleair/manifest.json\n+++ b/homeassistant/components/purpleair/manifest.json\n@@ -5,5 +5,5 @@\n   \"config_flow\": true,\n   \"documentation\": \"https://www.home-assistant.io/integrations/purpleair\",\n   \"iot_class\": \"cloud_polling\",\n-  \"requirements\": [\"aiopurpleair==2022.12.1\"]\n+  \"requirements\": [\"aiopurpleair==2023.12.0\"]\n }\ndiff --git a/homeassistant/components/unifiprotect/services.py b/homeassistant/components/unifiprotect/services.py\nindex 119fe52756c350..9c045164d6dd4d 100644\n--- a/homeassistant/components/unifiprotect/services.py\n+++ b/homeassistant/components/unifiprotect/services.py\n@@ -6,7 +6,7 @@\n import functools\n from typing import Any, cast\n \n-from pydantic import ValidationError\n+from pydantic.v1 import ValidationError\n from uiprotect.api import ProtectApiClient\n from uiprotect.data import Camera, Chime\n from uiprotect.exceptions import ClientError\ndiff --git a/homeassistant/components/xbox/manifest.json b/homeassistant/components/xbox/manifest.json\nindex 30a6c3bc7005ac..3fc2071e66bf79 100644\n--- a/homeassistant/components/xbox/manifest.json\n+++ b/homeassistant/components/xbox/manifest.json\n@@ -6,5 +6,5 @@\n   \"dependencies\": [\"auth\", \"application_credentials\"],\n   \"documentation\": \"https://www.home-assistant.io/integrations/xbox\",\n   \"iot_class\": \"cloud_polling\",\n-  \"requirements\": [\"xbox-webapi==2.0.11\"]\n+  \"requirements\": [\"xbox-webapi==2.1.0\"]\n }\ndiff --git a/homeassistant/components/zwave_js/triggers/event.py b/homeassistant/components/zwave_js/triggers/event.py\nindex 9938d08408ceb7..db52683c173f0e 100644\n--- a/homeassistant/components/zwave_js/triggers/event.py\n+++ b/homeassistant/components/zwave_js/triggers/event.py\n@@ -5,7 +5,7 @@\n from collections.abc import Callable\n import functools\n \n-from pydantic import ValidationError\n+from pydantic.v1 import ValidationError\n import voluptuous as vol\n from zwave_js_server.client import Client\n from zwave_js_server.model.controller import CONTROLLER_EVENT_MODEL_MAP\ndiff --git a/homeassistant/package_constraints.txt b/homeassistant/package_constraints.txt\nindex cd45f15fe7c2de..932c743933661d 100644\n--- a/homeassistant/package_constraints.txt\n+++ b/homeassistant/package_constraints.txt\n@@ -125,9 +125,8 @@ multidict>=6.0.2\n # Version 2.0 added typing, prevent accidental fallbacks\n backoff>=2.0\n \n-# Required to avoid breaking (#101042).\n-# v2 has breaking changes (#99218).\n-pydantic==1.10.19\n+# ensure pydantic version does not float since it might have breaking changes\n+pydantic==2.10.3\n \n # Required for Python 3.12.4 compatibility (#119223).\n mashumaro>=3.13.1\ndiff --git a/requirements_all.txt b/requirements_all.txt\nindex 6fce6667da55ed..936b5529b1ab13 100644\n--- a/requirements_all.txt\n+++ b/requirements_all.txt\n@@ -328,7 +328,7 @@ aiopegelonline==0.1.0\n aiopulse==0.4.6\n \n # homeassistant.components.purpleair\n-aiopurpleair==2022.12.1\n+aiopurpleair==2023.12.0\n \n # homeassistant.components.hunterdouglas_powerview\n aiopvapi==3.1.1\n@@ -1781,7 +1781,7 @@ pyatmo==8.1.0\n pyatv==0.16.0\n \n # homeassistant.components.aussie_broadband\n-pyaussiebb==0.0.15\n+pyaussiebb==0.1.4\n \n # homeassistant.components.balboa\n pybalboa==1.0.2\n@@ -3020,7 +3020,7 @@ wolf-comm==0.0.15\n wyoming==1.5.4\n \n # homeassistant.components.xbox\n-xbox-webapi==2.0.11\n+xbox-webapi==2.1.0\n \n # homeassistant.components.xiaomi_ble\n xiaomi-ble==0.33.0\ndiff --git a/script/gen_requirements_all.py b/script/gen_requirements_all.py\nindex 97ffcac79a467b..648798f79c8b6b 100755\n--- a/script/gen_requirements_all.py\n+++ b/script/gen_requirements_all.py\n@@ -158,9 +158,8 @@\n # Version 2.0 added typing, prevent accidental fallbacks\n backoff>=2.0\n \n-# Required to avoid breaking (#101042).\n-# v2 has breaking changes (#99218).\n-pydantic==1.10.19\n+# ensure pydantic version does not float since it might have breaking changes\n+pydantic==2.10.3\n \n # Required for Python 3.12.4 compatibility (#119223).\n mashumaro>=3.13.1\n", "test_patch": "diff --git a/requirements_test.txt b/requirements_test.txt\nindex 06a0fd035d317c..50e5957bf96122 100644\n--- a/requirements_test.txt\n+++ b/requirements_test.txt\n@@ -14,7 +14,7 @@ license-expression==30.4.0\n mock-open==1.4.0\n mypy-dev==1.14.0a6\n pre-commit==4.0.0\n-pydantic==1.10.19\n+pydantic==2.10.3\n pylint==3.3.2\n pylint-per-file-ignores==1.3.2\n pipdeptree==2.23.4\ndiff --git a/requirements_test_all.txt b/requirements_test_all.txt\nindex 540ec43335962b..3691b1944d434e 100644\n--- a/requirements_test_all.txt\n+++ b/requirements_test_all.txt\n@@ -310,7 +310,7 @@ aiopegelonline==0.1.0\n aiopulse==0.4.6\n \n # homeassistant.components.purpleair\n-aiopurpleair==2022.12.1\n+aiopurpleair==2023.12.0\n \n # homeassistant.components.hunterdouglas_powerview\n aiopvapi==3.1.1\n@@ -1455,7 +1455,7 @@ pyatmo==8.1.0\n pyatv==0.16.0\n \n # homeassistant.components.aussie_broadband\n-pyaussiebb==0.0.15\n+pyaussiebb==0.1.4\n \n # homeassistant.components.balboa\n pybalboa==1.0.2\n@@ -2415,7 +2415,7 @@ wolf-comm==0.0.15\n wyoming==1.5.4\n \n # homeassistant.components.xbox\n-xbox-webapi==2.0.11\n+xbox-webapi==2.1.0\n \n # homeassistant.components.xiaomi_ble\n xiaomi-ble==0.33.0\ndiff --git a/tests/components/lacrosse_view/test_config_flow.py b/tests/components/lacrosse_view/test_config_flow.py\nindex 9ca7fb78bdd6cf..f953d9a384113b 100644\n--- a/tests/components/lacrosse_view/test_config_flow.py\n+++ b/tests/components/lacrosse_view/test_config_flow.py\n@@ -30,7 +30,7 @@ async def test_form(hass: HomeAssistant, mock_setup_entry: AsyncMock) -> None:\n         ),\n         patch(\n             \"lacrosse_view.LaCrosse.get_locations\",\n-            return_value=[Location(id=1, name=\"Test\")],\n+            return_value=[Location(id=\"1\", name=\"Test\")],\n         ),\n     ):\n         result2 = await hass.config_entries.flow.async_configure(\n@@ -206,7 +206,7 @@ async def test_already_configured_device(\n         ),\n         patch(\n             \"lacrosse_view.LaCrosse.get_locations\",\n-            return_value=[Location(id=1, name=\"Test\")],\n+            return_value=[Location(id=\"1\", name=\"Test\")],\n         ),\n     ):\n         result2 = await hass.config_entries.flow.async_configure(\n@@ -262,7 +262,7 @@ async def test_reauth(hass: HomeAssistant) -> None:\n         patch(\"lacrosse_view.LaCrosse.login\", return_value=True),\n         patch(\n             \"lacrosse_view.LaCrosse.get_locations\",\n-            return_value=[Location(id=1, name=\"Test\")],\n+            return_value=[Location(id=\"1\", name=\"Test\")],\n         ),\n     ):\n         result2 = await hass.config_entries.flow.async_configure(\ndiff --git a/tests/components/peco/test_sensor.py b/tests/components/peco/test_sensor.py\nindex 9cbef9fa1e6950..4c9a3fca104a53 100644\n--- a/tests/components/peco/test_sensor.py\n+++ b/tests/components/peco/test_sensor.py\n@@ -39,7 +39,7 @@ async def test_sensor_available(\n             \"peco.PecoOutageApi.get_outage_totals\",\n             return_value=OutageResults(\n                 customers_out=123,\n-                percent_customers_out=15.589,\n+                percent_customers_out=15,\n                 outage_count=456,\n                 customers_served=789,\n             ),\n@@ -74,7 +74,7 @@ async def test_sensor_available(\n             \"peco.PecoOutageApi.get_outage_count\",\n             return_value=OutageResults(\n                 customers_out=123,\n-                percent_customers_out=15.589,\n+                percent_customers_out=15,\n                 outage_count=456,\n                 customers_served=789,\n             ),\ndiff --git a/tests/components/youtube/snapshots/test_sensor.ambr b/tests/components/youtube/snapshots/test_sensor.ambr\nindex dce546b4803d6f..f4549e89c8cbaf 100644\n--- a/tests/components/youtube/snapshots/test_sensor.ambr\n+++ b/tests/components/youtube/snapshots/test_sensor.ambr\n@@ -4,7 +4,7 @@\n     'attributes': ReadOnlyDict({\n       'entity_picture': 'https://i.ytimg.com/vi/wysukDrMdqU/maxresdefault.jpg',\n       'friendly_name': 'Google for Developers Latest upload',\n-      'published_at': datetime.datetime(2023, 5, 11, 0, 20, 46, tzinfo=datetime.timezone.utc),\n+      'published_at': datetime.datetime(2023, 5, 11, 0, 20, 46, tzinfo=TzInfo(UTC)),\n       'video_id': 'wysukDrMdqU',\n     }),\n     'context': <ANY>,\n", "problem_statement": "Pydantic v2 migration issue\n### The problem\r\n\r\nPydantic released v2 of their library. Some libraries want to utilize the new features of Pydantic v2 so HA should update to Pydantic v2. To not burden all libraries to rework, [Pydantic is providing v1 in a separate package of v2](https://docs.pydantic.dev/latest/migration/#continue-using-pydantic-v1-features). This has been implemented in several libraries already made by some HA community members (https://github.com/AngellusMortis/pyunifiprotect/pull/297). This way the library supports both v1 and v2, this way of working is preferred to not burden the v2 upgrade with a lot of libraries to update at once.\r\n\r\nAfter installing all dependencies and using `pipdeptree` we see that the current libraries use pydantic.\r\n\r\n```\r\npydantic==1.10.12\r\n\u251c\u2500\u2500 aiolivisi==0.0.19 [requires: pydantic]\r\n\u251c\u2500\u2500 aionotion==2023.5.5 [requires: pydantic>=1.10.7,<2.0.0]\r\n\u251c\u2500\u2500 aioopenexchangerates==0.4.0 [requires: pydantic>=1.9,<2.0]\r\n\u251c\u2500\u2500 aiopurpleair==2022.12.1 [requires: pydantic>=1.10.2,<2.0.0]\r\n\u251c\u2500\u2500 aiowaqi==0.2.1 [requires: pydantic>=1.10.8]\r\n\u251c\u2500\u2500 demetriek==0.4.0 [requires: pydantic>=1.9.0,<2.0.0]\r\n\u251c\u2500\u2500 elgato==4.0.1 [requires: pydantic>=1.8.0,<2.0.0]\r\n\u251c\u2500\u2500 gcal-sync==4.1.4 [requires: pydantic>=1.9.0,<2.0a]\r\n\u251c\u2500\u2500 google-nest-sdm==2.2.5 [requires: pydantic>=1.10.4]\r\n\u251c\u2500\u2500 ical==5.0.1 [requires: pydantic>=1.9.1]\r\n\u2502   \u251c\u2500\u2500 gcal-sync==4.1.4 [requires: ical>=4.2.5]\r\n\u2502   \u2514\u2500\u2500 pyrainbird==4.0.0 [requires: ical>=4.2.9]\r\n\u251c\u2500\u2500 inflect==6.0.4 [requires: pydantic>=1.9.1]\r\n\u2502   \u251c\u2500\u2500 jaraco.itertools==6.2.1 [requires: inflect]\r\n\u2502   \u2502   \u2514\u2500\u2500 jaraco.abode==3.3.0 [requires: jaraco.itertools]\r\n\u2502   \u2514\u2500\u2500 jaraco.text==3.11.1 [requires: inflect]\r\n\u2502       \u251c\u2500\u2500 jaraco.collections==4.2.0 [requires: jaraco.text]\r\n\u2502       \u2502   \u251c\u2500\u2500 jaraco.abode==3.3.0 [requires: jaraco.collections]\r\n\u2502       \u2502   \u251c\u2500\u2500 jaraco.email==3.1.0 [requires: jaraco.collections]\r\n\u2502       \u2502   \u2502   \u2514\u2500\u2500 jaraco.net==9.3.1 [requires: jaraco.email]\r\n\u2502       \u2502   \u2502       \u2514\u2500\u2500 jaraco.abode==3.3.0 [requires: jaraco.net>=9]\r\n\u2502       \u2502   \u2514\u2500\u2500 jaraco.net==9.3.1 [requires: jaraco.collections]\r\n\u2502       \u2502       \u2514\u2500\u2500 jaraco.abode==3.3.0 [requires: jaraco.net>=9]\r\n\u2502       \u251c\u2500\u2500 jaraco.email==3.1.0 [requires: jaraco.text>=1.3]\r\n\u2502       \u2502   \u2514\u2500\u2500 jaraco.net==9.3.1 [requires: jaraco.email]\r\n\u2502       \u2502       \u2514\u2500\u2500 jaraco.abode==3.3.0 [requires: jaraco.net>=9]\r\n\u2502       \u2514\u2500\u2500 jaraco.net==9.3.1 [requires: jaraco.text]\r\n\u2502           \u2514\u2500\u2500 jaraco.abode==3.3.0 [requires: jaraco.net>=9]\r\n\u251c\u2500\u2500 intellifire4py==2.2.2 [requires: pydantic]\r\n\u251c\u2500\u2500 lacrosse-view==1.0.1 [requires: pydantic>=1.9.0]\r\n\u251c\u2500\u2500 open-meteo==0.2.1 [requires: pydantic>=1.8.0,<2.0.0]\r\n\u251c\u2500\u2500 peco==0.0.29 [requires: pydantic>=1.9.0]\r\n\u251c\u2500\u2500 pvo==1.0.0 [requires: pydantic>=1.8.0,<2.0.0]\r\n\u251c\u2500\u2500 pyaussiebb==0.0.15 [requires: pydantic>=1.9.0,<2.0.0]\r\n\u251c\u2500\u2500 pyrainbird==4.0.0 [requires: pydantic>=1.10.4]\r\n\u251c\u2500\u2500 python-bsblan==0.5.11 [requires: pydantic>=1.9.0]\r\n\u251c\u2500\u2500 python-kasa==0.5.3 [requires: pydantic>=1,<2]\r\n\u251c\u2500\u2500 python-opensky==0.2.0 [requires: pydantic>=1.10.8]\r\n\u251c\u2500\u2500 pytraccar==1.0.0 [requires: pydantic>=1,<2]\r\n\u251c\u2500\u2500 pyunifiprotect==4.10.6 [requires: pydantic!=1.9.1]\r\n\u251c\u2500\u2500 radios==0.1.1 [requires: pydantic>=1.9,<2.0]\r\n\u251c\u2500\u2500 sfrbox-api==0.0.6 [requires: pydantic>=1.10.2]\r\n\u251c\u2500\u2500 systembridgeconnector==3.4.9 [requires: pydantic>=1.9.0]\r\n\u251c\u2500\u2500 tailscale==0.2.0 [requires: pydantic>=1.8.0,<2.0.0]\r\n\u251c\u2500\u2500 vehicle==1.0.1 [requires: pydantic>=1.8.0,<2.0.0]\r\n\u251c\u2500\u2500 withings-api==2.4.0 [requires: pydantic>=1.7.2,<2.0.0]\r\n\u251c\u2500\u2500 xbox-webapi==2.0.11 [requires: pydantic]\r\n\u251c\u2500\u2500 yolink-api==0.3.0 [requires: pydantic>=1.9.0]\r\n\u251c\u2500\u2500 youtubeaio==1.1.5 [requires: pydantic>=1.10.8]\r\n\u2514\u2500\u2500 zwave-js-server-python==0.50.1 [requires: pydantic>=1.10.0]\r\n```\r\n\r\nThis issue will be the progress tracker of this migration.\r\n\r\n<details>\r\n<summary>\u274c aiolivisi</summary>\r\nLibrary: [aiolivisi](https://github.com/StefanIacobLivisi/aiolivisi)\r\nIntegrations using this library: [Livisi](https://github.com/home-assistant/core/tree/dev/homeassistant/components/livisi)\r\nCode owners: @StefanIacobLivisi @planbnet\r\n\r\n- [ ] Supports Pydantic v2 (PR: https://github.com/StefanIacobLivisi/aiolivisi/pull/12)\r\n- [ ] Is updated in HA (PR: # )\r\n\r\nRemarks:\r\n\r\n</details>\r\n<details>\r\n<summary>\u2714\ufe0f aionotion</summary>\r\n\r\nLibrary: [aionotion](https://github.com/bachya/aionotion)\r\nIntegrations using this library: [Notion](https://github.com/home-assistant/core/tree/dev/homeassistant/components/notion)\r\nCode owners: @bachya\r\n\r\n- [x] Supports Pydantic v2 (PR: https://github.com/bachya/aionotion/pull/251)\r\n- [x] Is updated in HA (PR: #111388 )\r\n\r\nRemarks:\r\nThere seems to be no version that supports both v1 and v2, so this library should be directly bumped with the v2 update.\r\n\r\n</details>\r\n<details>\r\n<summary>\u2714\ufe0f aioopenexchangerates</summary>\r\n\r\n--\r\nLibrary: [aioopenexchangerates](https://github.com/MartinHjelmare/aioopenexchangerates)\r\nIntegrations using this library: [OpenExchangeRates](https://github.com/home-assistant/core/tree/dev/homeassistant/components/openexchangerates)\r\nCode owners: @MartinHjelmare \r\n\r\n- [ ] Supports Pydantic v2 (PR: )\r\n- [x] Is updated in HA (PR: #125593 )\r\n\r\nRemarks:\r\n\r\n</details>\r\n<details>\r\n<summary>\u274c aiopurpleair</summary>\r\n\r\n--\r\nLibrary: [aiopurpleair](https://github.com/bachya/aiopurpleair)\r\nIntegrations using this library: [PurpleAir](https://github.com/home-assistant/core/tree/dev/homeassistant/components/purpleair)\r\nCode owners: @bachya\r\n\r\n- [x] Supports Pydantic v2 (PR: https://github.com/bachya/aiopurpleair/pull/195)\r\n- [ ] Is updated in HA (PR: # )\r\n\r\nRemarks:\r\nThere seems to be no version that supports both v1 and v2, so this library should be directly bumped with the v2 update.\r\n\r\n</details>\r\n<details>\r\n<summary> \u2714\ufe0f  aiowaqi</summary>\r\n\r\n--\r\nLibrary: [aiowaqi](https://github.com/joostlek/python-waqi)\r\nIntegrations using this library: [WAQI](https://github.com/home-assistant/core/tree/dev/homeassistant/components/waqi)\r\nCode owners: @joostlek\r\n\r\n- [x] Supports Pydantic v2 (PR: Initial commit)\r\n- [x] Is updated in HA (PR: #98000)\r\n\r\nRemarks:\r\n\r\n</details>\r\n<details>\r\n<summary>\u274c demetriek</summary>\r\n\r\n--\r\nLibrary: [demetriek](https://github.com/frenck/python-demetriek)\r\nIntegrations using this library: [lametric](https://github.com/home-assistant/core/tree/dev/homeassistant/components/lametric)\r\nCode owners: @robbiet480 @frenck @bachya \r\n\r\n- [ ] Supports Pydantic v2 (PR: https://github.com/frenck/python-demetriek/pull/531)\r\n- [ ] Is updated in HA (PR: # )\r\n\r\nRemarks:\r\n\r\n</details>\r\n<details>\r\n<summary> \u2714\ufe0f elgato</summary>\r\n\r\n--\r\nLibrary: [elgato](https://github.com/frenck/python-elgato)\r\nIntegrations using this library: [elgato](https://github.com/home-assistant/core/tree/dev/homeassistant/components/elgato)\r\nCode owners: @frenck\r\n\r\n- [x] Supports Pydantic v2 (PR: https://github.com/frenck/python-elgato/pull/833)\r\n- [x] Is updated in HA (PR: #102405 )\r\n\r\nRemarks:\r\n\r\n</details>\r\n<details>\r\n<summary> \u2714\ufe0f gcal-sync</summary>\r\n\r\n--\r\nLibrary: [gcal-sync](https://github.com/allenporter/gcal_sync)\r\nIntegrations using this library: [Google Calendar](https://github.com/home-assistant/core/tree/dev/homeassistant/components/google)\r\nCode owners: @allenporter\r\n\r\n- [x] Supports Pydantic v2 (PR: https://github.com/allenporter/gcal_sync/pull/275)\r\n- [x] Is updated in HA (PR: #102010)\r\n\r\nRemarks:\r\nSupports shims. Needs a release so we can bump the dependency beforehand. Latest version also has ical 5.0.1, and that has pydantic v2 support since 5.0.0.\r\n\r\n</details>\r\n<details>\r\n<summary>\u2714\ufe0f google-nest-sdm</summary>\r\n\r\n--\r\nLibrary: [google-nest-sdm](https://github.com/allenporter/python-google-nest-sdm)\r\nIntegrations using this library: [Nest](https://github.com/home-assistant/core/tree/dev/homeassistant/components/nest)\r\nCode owners: @allenporter\r\n\r\n- [x] Supports Pydantic v2 (PR: https://github.com/allenporter/python-google-nest-sdm/pull/670)\r\n- [x] Is updated in HA (PR: #99175)\r\n\r\nRemarks:\r\n\r\n</details>\r\n<details>\r\n<summary>\u2714\ufe0f ical</summary>\r\n\r\n--\r\nLibrary: [ical](https://github.com/allenporter/ical)\r\nIntegrations using this library: [Local calendar](https://github.com/home-assistant/core/tree/dev/homeassistant/components/local_calendar)\r\nCode owners: @allenporter\r\n\r\n- [x] Supports Pydantic v2 (PR: https://github.com/allenporter/ical/pull/207)\r\n- [x] Is updated in HA (PR: #98998)\r\n\r\nRemarks:\r\n\r\n</details>\r\n<details>\r\n<summary>\u274c inflect</summary>\r\n\r\n--\r\nLibrary: [inflect](https://github.com/jaraco/inflect)\r\nIntegrations using this library: [Abode](https://github.com/home-assistant/core/tree/dev/homeassistant/components/abode)\r\nCode owners: @shred86\r\n\r\n- [ ] Supports Pydantic v2 (PR: )\r\n- [ ] Is updated in HA (PR: # )\r\n\r\nRemarks:\r\nThis seems to be a deeper problem. I need to dive in to this to know the status.\r\n\r\n</details>\r\n<details>\r\n<summary>\u274c intellifire4py</summary>\r\n\r\n--\r\nLibrary: [intellifire4py](https://github.com/jeeftor/intellifire4py)\r\nIntegrations using this library: [IntelliFire](https://github.com/home-assistant/core/tree/dev/homeassistant/components/intellifire)\r\nCode owners: @jeeftor\r\n\r\n- [ ] Supports Pydantic v2 (PR: )\r\n- [ ] Is updated in HA (PR: # )\r\n\r\nRemarks:\r\n\r\n</details>\r\n<details>\r\n<summary>\u274c lacrosse-view</summary>\r\n\r\n--\r\nLibrary: [lacrosse-view](https://github.com/IceBotYT/lacrosse_view)\r\nIntegrations using this library: [LaCrosse View](https://github.com/home-assistant/core/tree/dev/homeassistant/components/lacrosse_view)\r\nCode owners: @IceBotYT\r\n\r\n- [ ] Supports Pydantic v2 (PR: )\r\n- [ ] Is updated in HA (PR: # )\r\n\r\nRemarks:\r\n\r\n</details>\r\n<details>\r\n<summary>\u2714\ufe0f open-meteo</summary>\r\n\r\n--\r\nLibrary: [open-meteo](https://github.com/frenck/python-open-meteo)\r\nIntegrations using this library: [Open Meteo](https://github.com/home-assistant/core/tree/dev/homeassistant/components/open_meteo)\r\nCode owners: @frenck\r\n\r\n- [x] Supports Pydantic v2 (PR: https://github.com/frenck/python-open-meteo/pull/353)\r\n- [x] Is updated in HA (PR: #103613)\r\n\r\nRemarks:\r\nTo verify: There has been no code change to support it, but in the lock file is 2.0.3 so I am expecting this works.\r\nIf this is as expected, it still needs a release and to be bumped.\r\n\r\n</details>\r\n<details>\r\n<summary>\u274c peco</summary>\r\n\r\n--\r\nLibrary: [peco](https://github.com/IceBotYT/peco-outage-api)\r\nIntegrations using this library: [PECO Outage Counter](https://github.com/home-assistant/core/tree/dev/homeassistant/components/peco)\r\nCode owners: @IceBotYT\r\n\r\n- [ ] Supports Pydantic v2 (PR: )\r\n- [ ] Is updated in HA (PR: # )\r\n\r\nRemarks:\r\nThere has been no explicit PR to fix support for v2. This might work but needs to be verified.\r\n\r\n</details>\r\n<details>\r\n<summary> \u2714\ufe0f pvo</summary>\r\n\r\n--\r\nLibrary: [pvo](https://github.com/frenck/python-pvoutput)\r\nIntegrations using this library: [PVOutput](https://github.com/home-assistant/core/tree/dev/homeassistant/components/pvoutput)\r\nCode owners: @frenck\r\n\r\n- [x] Supports Pydantic v2 (PR: https://github.com/frenck/python-pvoutput/pull/394)\r\n- [x] Is updated in HA (PR: #102398 )\r\n\r\nRemarks:\r\n\r\n</details>\r\n<details>\r\n<summary>\u274c pyaussiebb</summary>\r\n\r\n--\r\nLibrary: [pyaussiebb](https://github.com/yaleman/pyaussiebb)\r\nIntegrations using this library: [Aussie Broadband](https://github.com/home-assistant/core/tree/dev/homeassistant/components/aussie_broadband)\r\nCode owners: @nickw444 @Bre77\r\n\r\n- [x] Supports Pydantic v2 ([commit](https://github.com/yaleman/pyaussiebb/commit/a0d240d75935955bd3af518d8e28fd5cac95722e))\r\n- [ ] Is updated in HA (PR: #99077)\r\n\r\nRemarks:\r\nLibrary does not support v1 shims. Should be bumped with the v2 bump.\r\ncc @yaleman\r\n\r\n</details>\r\n<details>\r\n<summary> \u2714\ufe0f pyrainbird</summary>\r\n\r\n--\r\nLibrary: [pyrainbird](https://github.com/allenporter/pyrainbird)\r\nIntegrations using this library: [Rain Bird](https://github.com/home-assistant/core/tree/dev/homeassistant/components/rainbird)\r\nCode owners: @konikvranik @allenporter\r\n\r\n- [x] Supports Pydantic v2 (PR: https://github.com/allenporter/pyrainbird/pull/217)\r\n- [x] Is updated in HA (PR: #96610)\r\n\r\nRemarks:\r\nStill needs to update ical to =>5.0.0 as ical relies on pydantic as well.\r\n\r\n</details>\r\n<details>\r\n<summary>\u2714\ufe0f python-bsblan</summary>\r\n\r\n--\r\nLibrary: [python-bsblan](https://github.com/liudger/python-bsblan)\r\nIntegrations using this library: [BSB-Lan](https://github.com/home-assistant/core/tree/dev/homeassistant/components/bsblan)\r\nCode owners: @liudger\r\n\r\n- [ ] Supports Pydantic v2 (PR: )\r\n- [ ] Is updated in HA (PR: # )\r\n\r\nRemarks:\r\n\r\n</details>\r\n<details>\r\n<summary>\u2714\ufe0f python-kasa</summary>\r\n\r\n--\r\nLibrary: [python-kasa](https://github.com/python-kasa/python-kasa)\r\nIntegrations using this library: [TP-Link Kasa Smart](https://github.com/home-assistant/core/tree/dev/homeassistant/components/tplink)\r\nCode owners: @rytilahti @thegardenmonkey\r\n\r\n- [x] Supports Pydantic v2 (PR: https://github.com/python-kasa/python-kasa/pull/504)\r\n- [x] Is updated in HA (PR: #103038)\r\n\r\nRemarks:\r\n\r\n</details>\r\n<details>\r\n<summary>\u2714\ufe0f python-opensky</summary>\r\n\r\n--\r\nLibrary: [python-opensky](https://github.com/joostlek/python-opensky)\r\nIntegrations using this library: [OpenSky Network](https://github.com/home-assistant/core/tree/dev/homeassistant/components/opensky)\r\nCode owners: @joostlek\r\n\r\n- [x] Supports Pydantic v2 (PR: https://github.com/joostlek/python-opensky/pull/85)\r\n- [x] Is updated in HA (PR: #97687)\r\n\r\nRemarks:\r\n\r\n</details>\r\n<details>\r\n<summary>\u2714\ufe0f pytraccar</summary>\r\n\r\n--\r\nLibrary: [pytraccar](https://github.com/ludeeus/pytraccar)\r\nIntegrations using this library: [Traccar](https://github.com/home-assistant/core/tree/dev/homeassistant/components/traccar)\r\nCode owners: @ludeeus\r\n\r\n- [ ] Supports Pydantic v2 (PR: )\r\n- [x] Is updated in HA (PR: #103318)\r\n\r\nRemarks:\r\n\r\n</details>\r\n<details>\r\n<summary> \u2714\ufe0f pyunifiprotect</summary>\r\n\r\n--\r\nLibrary: [pyunifiprotect](https://github.com/AngellusMortis/pyunifiprotect)\r\nIntegrations using this library: [asd](https://github.com/home-assistant/core/tree/dev/homeassistant/components/unifiprotect)\r\nCode owners: @AngellusMortis @bdraco\r\n\r\n- [x] Supports Pydantic v2 (PR: https://github.com/AngellusMortis/pyunifiprotect/pull/297)\r\n- [x] Is updated in HA (PR: #96486)\r\n\r\nRemarks:\r\n\r\n</details>\r\n<details>\r\n<summary>\u2714\ufe0f radios</summary>\r\n\r\n--\r\nLibrary: [radios](https://github.com/frenck/python-radios)\r\nIntegrations using this library: [Radio Browser](https://github.com/home-assistant/core/tree/dev/homeassistant/components/radio_browser)\r\nCode owners: @frenck\r\n\r\n- [ ] Supports Pydantic v2 (PR: )\r\n- [x] Is updated in HA (PR: #103614)\r\n\r\nRemarks:\r\n\r\n</details>\r\n<details>\r\n<summary>\u2714\ufe0f sfrbox-api</summary>\r\n\r\n--\r\nLibrary: [sfrbox-api](https://github.com/hacf-fr/sfrbox-api)\r\nIntegrations using this library: [SFR Box](https://github.com/home-assistant/core/tree/dev/homeassistant/components/sfr_box)\r\nCode owners: @epenet\r\n\r\n- [ ] Supports Pydantic v2 (PR: )\r\n- [x] Is updated in HA (PR: #125732 )\r\n\r\nRemarks:\r\n\r\n</details>\r\n<details>\r\n<summary>\u274c systembridgeconnector</summary>\r\n\r\n--\r\nLibrary: [systembridgeconnector](https://github.com/timmo001/system-bridge)\r\nIntegrations using this library: [System Bridge](https://github.com/home-assistant/core/tree/dev/homeassistant/components/system_bridge)\r\nCode owners: @timmo001\r\n\r\n- [ ] Supports Pydantic v2 (PR: )\r\n- [ ] Is updated in HA (PR: # )\r\n\r\nRemarks:\r\n\r\n</details>\r\n<details>\r\n<summary>\u2714\ufe0f tailscale</summary>\r\n\r\n--\r\nLibrary: [tailscale](https://github.com/frenck/python-tailscale)\r\nIntegrations using this library: [asd](https://github.com/home-assistant/core/tree/dev/homeassistant/components/tailscale)\r\nCode owners: @frenck\r\n\r\n- [x] Supports Pydantic v2 (PR: https://github.com/frenck/python-tailscale/pull/370)\r\n- [ ] Is updated in HA (PR: # )\r\n\r\nRemarks:\r\nTo verify: There has been no code change to support it, but in the lock file is 2.0.3 so I am expecting this works.\r\nIf this is as expected, it still needs a release and to be bumped.\r\n\r\n</details>\r\n<details>\r\n<summary> \u2714\ufe0f vehicle</summary>\r\n\r\n--\r\nLibrary: [vehicle](https://github.com/frenck/python-vehicle)\r\nIntegrations using this library: [RDW](https://github.com/home-assistant/core/tree/dev/homeassistant/components/rdw)\r\nCode owners: @frenck @joostlek\r\n\r\n- [x] Supports Pydantic v2 (PR: https://github.com/frenck/python-vehicle/pull/441)\r\n- [x] Is updated in HA (PR: #102379 )\r\n\r\nRemarks:\r\n\r\n</details>\r\n<details>\r\n<summary> \u2714\ufe0f  withings-api</summary>\r\n\r\n--\r\nLibrary: [withings-api](https://github.com/vangorra/python_withings_api)\r\nIntegrations using this library: [Withings](https://github.com/home-assistant/core/tree/dev/homeassistant/components/withings)\r\nCode owners: @vangorra\r\n\r\n- [ ] Supports Pydantic v2 (PR: )\r\n- [x] Is updated in HA (PR: #101819)\r\n\r\nRemarks:\r\nIs now/will be replaced with a new lib without pydantic\r\n\r\n</details>\r\n<details>\r\n<summary>\u274c xbox-webapi</summary>\r\n\r\n--\r\nLibrary: [xbox-webapi](https://github.com/OpenXbox/xbox-webapi-python)\r\nIntegrations using this library: [Xbox](https://github.com/home-assistant/core/tree/dev/homeassistant/components/xbox)\r\nCode owners: @hunterjm\r\n\r\n- [ ] Supports Pydantic v2 (PR: )\r\n- [ ] Is updated in HA (PR: # )\r\n\r\nRemarks:\r\n\r\n</details>\r\n<details>\r\n<summary>\u2714\ufe0f yolink-api</summary>\r\n\r\n--\r\nLibrary: [yolink-api](https://github.com/YoSmart-Inc/yolink-api)\r\nIntegrations using this library: [YoLink](https://github.com/home-assistant/core/tree/dev/homeassistant/components/yolink)\r\nCode owners: @matrixd2\r\n\r\n- [x] Supports Pydantic v2 (PR: https://github.com/YoSmart-Inc/yolink-api/commit/836e61b8b755cd180291fbea7aef824fc12c2580)\r\n- [x] Is updated in HA (PR: #105124)\r\n\r\nRemarks:\r\n\r\n</details>\r\n<details>\r\n<summary> \u2714\ufe0f  youtubeaio</summary>\r\n\r\n--\r\nLibrary: [youtubeaio](https://github.com/joostlek/python-youtube)\r\nIntegrations using this library: [YouTube](https://github.com/home-assistant/core/tree/dev/homeassistant/components/youtube)\r\nCode owners: @joostlek\r\n\r\n- [x] Supports Pydantic v2 (PR: )\r\n- [x] Is updated in HA (PR: # )\r\n\r\nRemarks:\r\n\r\n</details>\r\n<details>\r\n<summary> \u2714\ufe0f  zwave-js-server-python</summary>\r\n\r\n--\r\nLibrary: [zwave-js-server-python](https://github.com/home-assistant-libs/zwave-js-server-python)\r\nIntegrations using this library: [Z-Wave](https://github.com/home-assistant/core/tree/dev/homeassistant/components/zwave_js)\r\nCode owners: @home-assistant/z-wave\r\n\r\n- [x] Supports Pydantic v2 (PR: https://github.com/home-assistant-libs/zwave-js-server-python/pull/703)\r\n- [x] Is updated in HA (PR: #94760)\r\n\r\nRemarks:\r\n\r\n</details>\r\n\r\n--\r\n\r\nFor the core members, feel free to update where needed. For others, let us know if something has updated in a comment and we will update it.\r\n\r\n\r\ncc @cdce8p\r\n\r\n\r\n\n", "hints_text": "As also reported on Discord. But replying here as well, as I was tagged. I have no intention of supporting v2 of Pydantic in my libraries.\r\n\r\nInstead, I might be re-evaluating the use of Pydantic overall.\r\n\r\n../Frenck\n@frenck if you do find a good alternative please do share it here. Others may want to choose the same option. I have v2 semi working but since all the internals have changed and are IMO more complicated I haven't been interested much in investing time into it\nA good reminder: one can retain the V1 standards while upgrading to the V2 library. This is an excellent way to unstick this PR without committing yourself to a complete upgrade (assuming they don't get rid of this path at some point).\r\n\r\nhttps://docs.pydantic.dev/latest/migration/#continue-using-pydantic-v1-features\nAs far as I am aware, it doesn't support everything backward. As said, I have no plans of supporting V2 at this point, and I am not willing to spend any second on it until I have explored other options.\r\n\r\n\r\n../Frenck\r\n\n`pydantic` has been fully removed from `tailscale` and `elgato` (and thus no longer taking part in this issue).\n`pydantic` has been fully removed from `vehicle` (RDW integration) and thus no longer taking part in this issue.\nI've been checking all the boxes :)\nRight, but those don't take part in the migration process. It simply aren't using Pydantic at all anymore.\n`pydantic` has been fully removed from `pvo` (PVOutput integration) and thus no longer taking part in this issue.\n`pydantic` has been fully removed from `open-meteo` and thus no longer taking part in this issue.\r\nPR @ Core: <https://github.com/home-assistant/core/pull/103613>\n`pydantic` has been fully removed from `radios` (Radio Browser integration) and thus no longer taking part in this issue.\r\nPR @ Core: https://github.com/home-assistant/core/pull/103614\nMan, what a liberating feeling! I should have learned about other options before using Pydantic in the first place. It would have saved me from many headaches now and in the past.\n@frenck Are you using `mashumaro` as a replacement? I ask because I don't see a way to use it to validate a dict based on a `TypedDict` which is what I am looking for, so may have to keep looking :/\nFYI: beartype \r\n\r\nI found this issue, while searching why the used pydantic version is so old.\r\nMaybe it's just me, but I then found beartype which I've never heard of before.\r\nI've switched from pydantic to beartype today.\r\nI'm still astonished how simple that was and how it immediately found the bug, that already cost me several hours today.\r\n\r\nSteps I did:\r\n* remove every mention of pydantic\r\n* into `__init__.py` add:\r\n```\r\nfrom beartype.claw import beartype_this_package\r\n\r\nbeartype_this_package()\r\n```\nDo you have a repo which we can look at?\nSure, although I'm not sure it's worth looking: https://github.com/AlexanderLanin/homeassistant-sungrow/blob/main/custom_components/__init__.py\r\n\r\nSo far it found incorrect assignment to dataclasses and incorrect parameter types in functions. Both in addition to running mypy.\r\n\r\nSee https://beartype.readthedocs.io/en/latest/ for more info.\n> See https://beartype.readthedocs.io/en/latest/ for more info.\r\n\r\nThat looks pretty promising. Thank you for sharing!\r\nI - and I think others - get benefit from the ser/de + coercion aspects of Pydantic which `beartype` doesn't do :(.\nI think this worked for my codebase:\r\n\r\n```python\r\ntry:\r\n    from pydantic.v1 import Field, validator  # type: ignore # noqa F401 # pragma: no cover\r\n    from pydantic.v1 import BaseModel  # type: ignore # pragma: no cover\r\nexcept ImportError:\r\n    from pydantic import Field  # type: ignore # pragma: no cover\r\n    from pydantic import BaseModel  # type: ignore # pragma: no cover\r\n```\nPydantic will be removed from systembridgeconnector in #107957\r\n\r\nThe dependent package systembridgemodels now only uses standard dataclasses.\n`aionotion` now uses `mashumaro` and can be removed from the list.\nfyi, https://github.com/pydantic/pydantic/pull/9042 will allow cleaning up the compat code a bit when it ships.\nFYI, the [latest release](https://inflect.readthedocs.io/en/latest/history.html#v7-2-0) of inflect no longer depends on pydantic.\n> fyi, [pydantic/pydantic#9042](https://github.com/pydantic/pydantic/pull/9042) will allow cleaning up the compat code a bit when it ships.\r\n\r\nThis has now shipped, and is available in [Pydantic 1.10.15](https://docs.pydantic.dev/latest/changelog/#v11015-2024-04-03).\n> > fyi, [pydantic/pydantic#9042](https://github.com/pydantic/pydantic/pull/9042) will allow cleaning up the compat code a bit when it ships.\r\n> \r\n> This has now shipped, and is available in [Pydantic 1.10.15](https://docs.pydantic.dev/latest/changelog/#v11015-2024-04-03).\r\n\r\nIt does not work. They also have no plans on fixing since v1 is out of support. They are working on v3 now and we still have not even gotten to v2. The Xbox integration (@hunterjm) is the only integration with any notable amount of users. Can we just consider moving to v2 or at least set a deadline for the integrations to migrate?\r\n\r\nOwners refusing to support v2 via the shims is not fair to anyone else and it is preventing anyone from being able to use the performance improvements of v2. And once v3 comes out, it means a bunch of integrations are either going to go abandoned or those few owners are going to force everyone to rewrite their libraries just because they disagree with out a tool decided to implement something. \nI want to spend more time on this when I am done with my thesis, I definetly want to speed the whole process up then\nxbox seems to support v2 now so it might be able to be bumped with v2 as well\r\n\r\nhttps://github.com/OpenXbox/xbox-webapi-python/commit/307a36de16ba2f0db42f5100d2560cc386e9c70d\r\n\r\n\n> It does not work. They also have no plans on fixing since v1 is out of support. They are working on v3 now and we still have not even gotten to v2.\r\n\r\nUnsure what you are referring to. Are you referring to [this](https://github.com/pydantic/pydantic/issues/9357#issuecomment-2086528335) comment?\r\n\r\n> Indeed, looks like things weren't fully implemented there. PR welcome with a fix! This is relatively low priority though, given that it's on the V1 end of things.\r\n\r\nThere is by [all accounts](https://github.com/pydantic/pydantic/pull/9162) an active effort to fix / improve the v1 shim. The comment is just saying that it's low priority, and quite rightfully.\r\n\r\n\nPECO should be compatible once #117165 gets merged\nPECO now supports Pydantic v2 and is now merged into HA \ud83d\udc4d\nIf helped is needed to migrate to V2, I can help.\n> If helped is needed to migrate to V2, I can help.\r\n\r\nSee https://github.com/MartinHjelmare/aioopenexchangerates/pull/96 as @MartinHjelmare was wanting help to convert to mashumaro \naioopenexchangerates has been updated to remove pydantic.\nsfrbox-api has been updated to remove pydantic: https://github.com/home-assistant/core/pull/125732\nDo you have a date or forecast for the release of the constraint of having 1.x ?\nLaCrosse View should be compatible once #129174 gets merged\nHello everyone,\r\n\r\nThe library inflect [depends on `jaraco.itertools`](https://github.com/jaraco/jaraco.itertools/blob/main/pyproject.toml#L22C3-L22C10). The dependency is not pinned, so it should be already updated on HA. [Here is the latest tag (7.4.0)](https://github.com/jaraco/inflect/releases/tag/v7.4.0). If I install dependencies, I get the latest version:\r\n\r\n```\r\nCollecting inflect (from jaraco.itertools->jaraco.abode==6.2.1->-r requirements_all.txt (line 1222))\r\n  Downloading inflect-7.4.0-py3-none-any.whl.metadata (21 kB)\r\n```\r\n\r\nHere you can find the PR that removed pydantic from `inflect` and the one that updated `jaraco.itertools` on HA (thus updating `inflect`):\r\n\r\n--\r\nLibrary: [inflect](https://github.com/jaraco/inflect)\r\nIntegrations using this library: [Abode](https://github.com/home-assistant/core/tree/dev/homeassistant/components/abode)\r\nCode owners: @shred86\r\n\r\n- [X] ~Supports Pydantic v2~ Replaced pydantic by typeguard (PR: https://github.com/jaraco/inflect/pull/199)\r\n- [X] Is updated in HA (PR: https://github.com/home-assistant/core/pull/126823)\r\n\r\n--\r\n\r\nMaybe one maintainer can find the time to tick the boxes!\nThe library [`xbox-webapi`](https://github.com/OpenXbox/xbox-webapi-python) supports Pydantic 2 since version [2.1.0](https://github.com/OpenXbox/xbox-webapi-python/releases/tag/v2.1.0), but they did not implement the upgrade via shims. **This means that the library cannot be upgraded before updating HA Pydantic library first.**\r\n\r\n--\r\nLibrary: [xbox-webapi](https://github.com/OpenXbox/xbox-webapi-python)\r\nIntegrations using this library: [Xbox](https://github.com/home-assistant/core/tree/dev/homeassistant/components/xbox)\r\nCode owners: @hunterjm\r\n\r\n- [x] Supports Pydantic v2 (PR: https://github.com/OpenXbox/xbox-webapi-python/pull/100)\r\n- [ ] Is updated in HA (PR: # )\n> LaCrosse View should be compatible once #129174 gets merged\r\n\r\nJust to fill in the links for [lacrosse-view](https://github.com/IceBotYT/lacrosse_view). The library seems to use only the `BaseModel` from pydantic so the library is straight up compatible. I confirmed with a pip install that it works:\r\n\r\n```bash\r\n$ pip install lacrosse_view\r\nDownloading pydantic-2.9.2-py3-none-any.whl (434 kB)\r\n...\r\n```\r\n\r\n--\r\nLibrary: [lacrosse-view](https://github.com/IceBotYT/lacrosse_view)\r\nIntegrations using this library: [LaCrosse View](https://github.com/home-assistant/core/tree/dev/homeassistant/components/lacrosse_view)\r\nCode owners: @IceBotYT\r\n\r\n- [x] Supports Pydantic v2 (Commit: https://github.com/IceBotYT/lacrosse_view/commit/b549c01c7cee07b0812228c3df6091db81a22918)\r\n- [x] Is updated in HA (PR: https://github.com/home-assistant/core/pull/129174)\nFor [intellifire4py](https://github.com/jeeftor/intellifire4py), it seems like pydantic was added in December last year and HA is already using the latest version ([4.1.9](https://github.com/jeeftor/intellifire4py/releases/tag/v4.1.9)) of the library, that was fixed to work with both versions after the PR https://github.com/home-assistant/core/pull/104799 was closed due to incompatibility.\r\n\r\nI can confirm that if installed the latest version of pydantic is picked:\r\n\r\n```\r\n$ pip install intellifire4py\r\nCollecting intellifire4py\r\n  Downloading intellifire4py-4.1.9-py3-none-any.whl.metadata (3.4 kB)\r\n...\r\nCollecting pydantic>=1.10.8 (from intellifire4py)\r\n  Downloading pydantic-2.9.2-py3-none-any.whl.metadata (149 kB)\r\n```\r\n\r\n--\r\nLibrary: [intellifire4py](https://github.com/jeeftor/intellifire4py)\r\nIntegrations using this library: [IntelliFire](https://github.com/home-assistant/core/tree/dev/homeassistant/components/intellifire)\r\nCode owners: @jeeftor\r\n\r\n- [x] Supports Pydantic v2 (Commit: https://github.com/jeeftor/intellifire4py/commit/2f931cc6f0415813e4d34381d820c225412726b3)\r\n- [x] Is updated in HA (PR: https://github.com/home-assistant/core/pull/121091)\nFor [peco](https://github.com/IceBotYT/peco-outage-api), the upgrade is not necessary as the library only uses the BaseModel and does not alter any objects. This means that it's compatible with any version of pydantic.\r\n\r\nThe `pyproject.toml` points to [an updated version of pydantic](https://github.com/IceBotYT/peco-outage-api/blob/4b230a35d85ceed5738e0e8ef1df89bdf33df914/pyproject.toml#L37), and a pip install confirms that latest version will be installed (in case dependencies could impact it):\r\n\r\n```bash\r\n$ pip install peco\r\nDownloading pydantic-2.9.2-py3-none-any.whl (434 kB)\r\n```\r\n\r\n--\r\nLibrary: [peco](https://github.com/IceBotYT/peco-outage-api)\r\nIntegrations using this library: [PECO Outage Counter](https://github.com/home-assistant/core/tree/dev/homeassistant/components/peco)\r\nCode owners: @IceBotYT\r\n\r\n- [x] Supports Pydantic v2 (Commit: https://github.com/IceBotYT/peco-outage-api/commit/e9e3983d3acb1a5c3004e2af7068c456e8c0490b)\r\n- [x] Is updated in HA (PR: https://github.com/home-assistant/core/pull/117165)\nFor [pyaussiebb](https://github.com/yaleman/pyaussiebb), both changes were already linked, but seems like the HA update is not ticked. I just wanted to confirm the correctness with pip install:\r\n\r\n```\r\n$ pip install --user pyaussiebb\r\nCollecting pydantic<3.0,>=2.0 (from pyaussiebb)\r\n  Downloading pydantic-2.9.2-py3-none-any.whl.metadata (149 kB)\r\n```\r\n\r\n--\r\nLibrary: [pyaussiebb](https://github.com/yaleman/pyaussiebb)\r\nIntegrations using this library: [Aussie Broadband](https://github.com/home-assistant/core/tree/dev/homeassistant/components/aussie_broadband)\r\nCode owners: @nickw444 @Bre77\r\n\r\n- [x] Supports Pydantic v2 (Commit: https://github.com/yaleman/pyaussiebb/commit/a0d240d75935955bd3af518d8e28fd5cac95722e)\r\n- [x] Is updated in HA (PR: https://github.com/home-assistant/core/pull/99077)\nFor [systembridgeconnector](https://github.com/timmo001/system-bridge) the dependency is inside of the [system-bridge-models](https://github.com/timmo001/system-bridge-models), and this dependency has completely dropped pydantic in favor of dataclasses in version [4.0.0](https://github.com/timmo001/system-bridge-models/releases/tag/4.0.0). This means that this package is now excluded from the dependants from pydantic.\r\n\r\nConfirmed dependency is not imported with pip install:\r\n\r\n```\r\n$ pip install systembridgeconnector==4.1.5 systembridgemodels==4.2.4\r\n...\r\n```\r\n\r\n--\r\nLibrary: [systembridgeconnector](https://github.com/timmo001/system-bridge)\r\nIntegrations using this library: [System Bridge](https://github.com/home-assistant/core/tree/dev/homeassistant/components/system_bridge)\r\nCode owners: @timmo001\r\n\r\n- [x] Supports Pydantic v2 (PR: https://github.com/timmo001/system-bridge-models/pull/21)\r\n- [x] Is updated in HA (PR: https://github.com/home-assistant/core/pull/123657)\nFor [aiolivisi](https://github.com/StefanIacobLivisi/aiolivisi) it seems like the library is not maintained anymore. The last commit was in Mar 15 2023, and it does not seem like the PR https://github.com/StefanIacobLivisi/aiolivisi/pull/12 is going to be merged.\r\n\r\nHowever, due to luck, this library does not have to be updated! It seems like the library uses pydantic only for JSON parsing, and the dependency is not pinned. This means that if you install the library, the latest pydantic will be picked:\r\n\r\n```\r\n$ pip install aiolivisi\r\nDownloading pydantic-2.9.2-py3-none-any.whl (434 kB)\r\n```\r\n\r\nAt the same time, I can import the packages without any issues:\r\n\r\n```python\r\nfrom aiolivisi.websocket import Websocket\r\n```\r\n\r\nThe only issue is the [deprecated call to `parse_raw`](https://github.com/StefanIacobLivisi/aiolivisi/blob/2b8280d616a2e76bac6a490ee8103155da2532cf/aiolivisi/websocket.py#L68), but it happens inside of the `Websocket` class which is referenced by the [coordinator.py component](https://github.com/home-assistant/core/blob/0fc019305e034e0d5c8116a9fabbf5318783a231/homeassistant/components/livisi/coordinator.py#L8). Since it's a method call, the class can easily be overwritten to NOT use the deprecated method. I could also provide the patch if anyone is interested into moving this issue forward.\r\n\r\n--\r\nLibrary: [aiolivisi](https://github.com/StefanIacobLivisi/aiolivisi) \r\nIntegrations using this library: [Livisi](https://github.com/home-assistant/core/tree/dev/homeassistant/components/livisi) \r\nCode owners: @StefanIacobLivisi @planbnet\r\n\r\n- [ ] Supports Pydantic v2 (PR: https://github.com/StefanIacobLivisi/aiolivisi/pull/12)\r\n- [ ] Is updated in HA (PR: # )\n> For [intellifire4py](https://github.com/jeeftor/intellifire4py), it seems like pydantic was added in December last year and HA is already using the latest version ([4.1.9](https://github.com/jeeftor/intellifire4py/releases/tag/v4.1.9)) of the library, that was fixed to work with both versions after the PR #104799 was closed due to incompatibility.\r\n> \r\n> I can confirm that if installed the latest version of pydantic is picked:\r\n> \r\n> ```\r\n> $ pip install intellifire4py\r\n> Collecting intellifire4py\r\n>   Downloading intellifire4py-4.1.9-py3-none-any.whl.metadata (3.4 kB)\r\n> ...\r\n> Collecting pydantic>=1.10.8 (from intellifire4py)\r\n>   Downloading pydantic-2.9.2-py3-none-any.whl.metadata (149 kB)\r\n> ```\r\n> \r\n> -- Library: [intellifire4py](https://github.com/jeeftor/intellifire4py) Integrations using this library: [IntelliFire](https://github.com/home-assistant/core/tree/dev/homeassistant/components/intellifire) Code owners: @jeeftor\r\n> \r\n> * [x]  Supports Pydantic v2 (Commit: [jeeftor/intellifire4py@2f931cc](https://github.com/jeeftor/intellifire4py/commit/2f931cc6f0415813e4d34381d820c225412726b3))\r\n> * [x]  Is updated in HA (PR: [Bump Intellifire to 4.1.9\u00a0#121091](https://github.com/home-assistant/core/pull/121091))\r\n\r\nSo do I have to do anything?\nFinally, the last integration that blocks this issue is the [demetriek](https://github.com/frenck/python-demetriek). There was a PR https://github.com/frenck/python-demetriek/pull/531 suggested but it got rejected (automatically closed by inactivity bot). The package still depends on pinned pydantic though, which makes the installation break, but also imports the deprecated `root_validator` which would cause import errors.\r\n\r\nIt's hard to say what to do with this one, as it's the only dependency that cannot be worked around, but the author states no intention of upgrading pydantic. Seems like the library is also not maintained anymore, not receiving non-bot commits since May 29 2023, and the last release being Oct 18 2022.\r\n\r\nThe author seems to be associated with Home Assistant so I guess there could be a middle ground achieved to move forward with the migration. I, for example, would be open to provide a patch replacing it completely by python [dataclasses](https://docs.python.org/3.12/library/dataclasses.html), if the owner would agree to review and merge it.\r\n\r\n--\r\nLibrary: [demetriek](https://github.com/frenck/python-demetriek)\r\nIntegrations using this library: [lametric](https://github.com/home-assistant/core/tree/dev/homeassistant/components/lametric)\r\nCode owners: @robbiet480 @frenck @bachya\r\n\r\n- [ ] Supports Pydantic v2 (PR: https://github.com/frenck/python-demetriek/pull/531)\r\n- [ ] Is updated in HA (PR: # )\nI do not plan on adding support for Pydantic 2. As stated before. Sorry.\n\nIf anything I will move away from it, as I have done with all other packages. Hopefully, I can find some time to do so soon.\n> So do I have to do anything?\r\n\r\n@jeeftor as far as I can tell not, if your tests run pydantic 2 then it should integrate fine.\r\n\r\n> I do not plan on adding support for Pydantic 2. As stated before. Sorry.\r\n> \r\n> If anything I will move away from it, as I have done with all other packages. Hopefully, I can find some time to do so soon.\r\n\r\n@frenck Of course I understand your point, but what about the proposal in my comment, what do you think?\nI also want to add, this list has been outdated. I have been keeping an eye out for new integrations using the shims. But I'm sure I missed some\n> > So do I have to do anything?\n> \n> \n> \n> @jeeftor as far as I can tell not, if your tests run pydantic 2 then it should integrate fine.\n> \n> \n> \n> > I do not plan on adding support for Pydantic 2. As stated before. Sorry.\n> \n> > \n> \n> > If anything I will move away from it, as I have done with all other packages. Hopefully, I can find some time to do so soon.\n> \n> \n> \n> @frenck Of course I understand your point, but what about the proposal in my comment, what do you think?\n\n\nI think replacing it with just dataclasses isn\u2019t the right approach.\nJust to update, here is the updated list of dependencies using `pipdeptree`:\r\n\r\n```\r\npydantic==1.10.18\r\n\u251c\u2500\u2500 aiolivisi==0.0.19 [requires: pydantic]\r\n\u251c\u2500\u2500 aiopurpleair==2022.12.1 [requires: pydantic>=1.10.2,<2.0.0]\r\n\u251c\u2500\u2500 anthropic==0.31.2 [requires: pydantic>=1.9.0,<3]\r\n\u251c\u2500\u2500 demetriek==0.4.0 [requires: pydantic>=1.9.0,<2.0.0]\r\n\u251c\u2500\u2500 elevenlabs==1.6.1 [requires: pydantic>=1.9.2]\r\n\u251c\u2500\u2500 gcal_sync==6.2.0 [requires: pydantic>=1.9.0]\r\n\u251c\u2500\u2500 google-generativeai==0.8.2 [requires: pydantic]\r\n\u251c\u2500\u2500 ical==8.2.0 [requires: pydantic>=1.9.1]\r\n\u2502   \u251c\u2500\u2500 aioautomower==2024.10.3 [requires: ical>=8.0.1]\r\n\u2502   \u251c\u2500\u2500 gcal_sync==6.2.0 [requires: ical>=6.1.0]\r\n\u2502   \u2514\u2500\u2500 pyrainbird==6.0.1 [requires: ical>=4.2.9]\r\n\u251c\u2500\u2500 intellifire4py==4.1.9 [requires: pydantic>=1.10.8]\r\n\u251c\u2500\u2500 lacrosse_view==1.0.3 [requires: pydantic>=1.9.0,<3.0.0]\r\n\u251c\u2500\u2500 lektricowifi==0.0.43 [requires: pydantic>=1.10.17]\r\n\u251c\u2500\u2500 mozart_api==4.1.1.116.0 [requires: pydantic>=1.10]\r\n\u251c\u2500\u2500 openai==1.35.7 [requires: pydantic>=1.9.0,<3]\r\n\u251c\u2500\u2500 peco==0.0.30 [requires: pydantic>=1.9.0]\r\n\u251c\u2500\u2500 pyatv==0.15.1 [requires: pydantic>=1.10.10]\r\n\u251c\u2500\u2500 pyaussiebb==0.0.15 [requires: pydantic>=1.9.0,<2.0.0]\r\n\u251c\u2500\u2500 pykoplenti==1.2.2 [requires: pydantic~=1.10]\r\n\u251c\u2500\u2500 python-kasa==0.7.7 [requires: pydantic>=1.10.15]\r\n\u251c\u2500\u2500 pytouchlinesl==0.1.8 [requires: pydantic]\r\n\u251c\u2500\u2500 uiprotect==6.4.0 [requires: pydantic>=1.10.17]\r\n\u251c\u2500\u2500 weheat==2024.9.23 [requires: pydantic>=1.10.5,<2]\r\n\u251c\u2500\u2500 xbox-webapi==2.0.11 [requires: pydantic]\r\n\u251c\u2500\u2500 yolink-api==0.4.7 [requires: pydantic>=1.9.0]\r\n\u251c\u2500\u2500 youtubeaio==1.1.5 [requires: pydantic>=1.10.8]\r\n\u2514\u2500\u2500 zwave-js-server-python==0.59.0 [requires: pydantic>=1.10.0]\r\n```\r\n\r\nthe new dependencies that seem problematic:\r\n\r\n- `pykoplenti==1.2.2 [requires: pydantic~=1.10]`: For [pykoplenti](https://github.com/stegm/pykoplenti), the dependency seems to have been made backwards compatible in https://github.com/stegm/pykoplenti/pull/13. If a new version is released, it could be upgraded on HA.\r\n- `weheat==2024.9.23 [requires: pydantic>=1.10.5,<2]`: For [weheat](https://github.com/wefabricate/wh-python), I submitted https://github.com/wefabricate/wh-python/pull/12 to add support via shims. Waiting for review/response.\r\n\r\n\nOne more small update, this time for [pykoplenti](https://github.com/stegm/pykoplenti), the upgrade via shims has been done and the new version is already updated on HA. Confirming just to be sure:\r\n\r\n```bash\r\n$ pip install pykoplenti\r\nCollecting pykoplenti\r\n  Downloading pykoplenti-1.3.0-py3-none-any.whl.metadata (5.8 kB)\r\n...\r\nDownloading pydantic-2.9.2-py3-none-any.whl (434 kB)\r\n```\r\n\r\n--\r\nLibrary: [pykoplenti](https://github.com/stegm/pykoplenti)\r\nIntegrations using this library: [kostal_plenticore](https://github.com/home-assistant/core/tree/dev/homeassistant/components/kostal_plenticore)\r\nCode owners: @stegm\r\n\r\n- [x] Supports Pydantic v2 (PR: https://github.com/stegm/pykoplenti/pull/13)\r\n- [x] Is updated in HA (PR: https://github.com/home-assistant/core/pull/130719)\nOne more update! This time [weheat](https://github.com/wefabricate/wh-python) has been made compatible with pydantic via shims. The dependency has already been upgraded on HA. Thanks for the quick responses and the HA upgrade @jesperraemaekers \r\n\r\n--\r\nLibrary: [weheat](https://github.com/wefabricate/wh-python/pull/12)\r\nIntegrations using this library: [weheat](https://github.com/wefabricate/ha-core/tree/dev/homeassistant/components/weheat)\r\nCode owners: @jesperraemaekers\r\n\r\n- [x] Supports Pydantic v2 (PR: https://github.com/wefabricate/wh-python/pull/12)\r\n- [x] Is updated in HA (PR: https://github.com/home-assistant/core/pull/131630)\nThis all seems very close...\r\n\r\nI just reviewed the list and I believe this may be all that is left?\r\n- demetriek - PR in flight https://github.com/frenck/python-demetriek/pull/740\r\n- aiolivisi - You discuss this above, and https://github.com/StefanIacobLivisi/aiolivisi/pull/12 looks like its not the way this will go, The PR mentions these APIs will shut down too, so maybe something is already broken.\r\n- aiopurpleair needs bump (requires v2 in aiopurpleair==2022.12.1 and higher)\r\n- xbox-webapi needs bump (requires v2 in xbox-webapi==2.1.0)\r\n- pyaussiebb needs bump (requires v2)\r\n\r\nAnything else missing?\nIt looks like `aiolivisi` is abandoned and https://home.livisi.de/ is offline. While there is https://github.com/planbnet/livisi_unofficial for anyone holding on to these devices. It seems clear that `aiolivisi` is never going to be updated so we may want to drop the integration as the service has shutdown.\n> The PR mentions these APIs will shut down too, so maybe something is already broken.\r\n\r\nAccording to [this source](https://www.innogy-smarthome-forum.com/thread-ist-livisi-am-ende), Livisi shut down at the end of 2020, but I believe some of their devices still work offline, hence the reason why there is a fork.\r\n\r\nAs I mentioned in my comment above, I would propose for this library that we do a class patch in order for it to work (from my analysis, this should make the code fully compatible):\r\n\r\n<details>\r\n  <summary>Code proposal</summary>\r\n\r\n```python\r\nfrom aiolivisi.websocket import (\r\n    Websocket as WebsocketDeprecated,\r\n    EVENT_STATE_CHANGED,\r\n    ON_STATE,\r\n    VALUE,\r\n    LivisiEvent,\r\n    SET_POINT_TEMPERATURE,\r\n    POINT_TEMPERATURE,\r\n    TEMPERATURE,\r\n    HUMIDITY,\r\n    LUMINANCE,\r\n    IS_REACHABLE,\r\n    IS_OPEN,\r\n    EVENT_BUTTON_PRESSED,\r\n    KEY_INDEX,\r\n    KEY_PRESS_LONG,\r\n    KEY_PRESS_TYPE,\r\n)\r\nfrom pydantic import ValidationError\r\nfrom typing import Callable\r\n\r\n\r\nclass Websocket(WebsocketDeprecated):\r\n    async def consumer_handler(self, websocket, on_data: Callable):\r\n        \"\"\"Used when data is transmited using the websocket.\"\"\"\r\n        async for message in websocket:\r\n            try:\r\n                event_data = LivisiEvent.model_validate(message)\r\n            except ValidationError:\r\n                continue\r\n\r\n            if \"device\" in event_data.source:\r\n                event_data.source = event_data.source.replace(\"/device/\", \"\")\r\n            if event_data.properties is None:\r\n                continue\r\n\r\n            if event_data.type == EVENT_STATE_CHANGED:\r\n                if ON_STATE in event_data.properties.keys():\r\n                    event_data.onState = event_data.properties.get(ON_STATE)\r\n                elif VALUE in event_data.properties.keys() and isinstance(event_data.properties.get(VALUE), bool):\r\n                    event_data.onState = event_data.properties.get(VALUE)\r\n                if SET_POINT_TEMPERATURE in event_data.properties.keys():\r\n                    event_data.vrccData = event_data.properties.get(SET_POINT_TEMPERATURE)\r\n                elif POINT_TEMPERATURE in event_data.properties.keys():\r\n                    event_data.vrccData = event_data.properties.get(POINT_TEMPERATURE)\r\n                elif TEMPERATURE in event_data.properties.keys():\r\n                    event_data.vrccData = event_data.properties.get(TEMPERATURE)\r\n                elif HUMIDITY in event_data.properties.keys():\r\n                    event_data.vrccData = event_data.properties.get(HUMIDITY)\r\n                if LUMINANCE in event_data.properties.keys():\r\n                    event_data.luminance = event_data.properties.get(LUMINANCE)\r\n                if IS_REACHABLE in event_data.properties.keys():\r\n                    event_data.isReachable = event_data.properties.get(IS_REACHABLE)\r\n                if IS_OPEN in event_data.properties.keys():\r\n                    event_data.isOpen = event_data.properties.get(IS_OPEN)\r\n            elif event_data.type == EVENT_BUTTON_PRESSED:\r\n                if KEY_INDEX in event_data.properties.keys():\r\n                    event_data.keyIndex = event_data.properties.get(KEY_INDEX)\r\n                    event_data.isLongKeyPress = KEY_PRESS_LONG == event_data.properties.get(KEY_PRESS_TYPE)\r\n            on_data(event_data)\r\n```\r\n</details>\r\n\r\n> Anything else missing?\r\n\r\nAs of now just the demetrik update. @frenck if you have some I would really appreciate if you could review all the PRs I've placed. I've split all unrelated changes into separate PRs described in https://github.com/frenck/python-demetriek/pull/740#issuecomment-2508935381. If those get merged then all the workflows and tests should pass on CI for the mashumaro upgrade.\r\n\n> As I mentioned in my comment above, I would propose for this library that we do a class patch in order for it to work (from my analysis, this should make the code fully compatible):\r\n\r\nIt would be a lot cleaner to fork the library, modify it and republish it under a new name", "created_at": "2024-11-30T16:47:18Z"}
{"repo": "home-assistant/core", "pull_number": 131931, "instance_id": "home-assistant__core-131931", "issue_numbers": ["131900", "131900"], "base_commit": "6144cc26ba80314c46c9784165f4324cbfa039f7", "patch": "diff --git a/homeassistant/components/unifiprotect/manifest.json b/homeassistant/components/unifiprotect/manifest.json\nindex 9a76ba6f984d85..9730c1e37410af 100644\n--- a/homeassistant/components/unifiprotect/manifest.json\n+++ b/homeassistant/components/unifiprotect/manifest.json\n@@ -40,7 +40,7 @@\n   \"integration_type\": \"hub\",\n   \"iot_class\": \"local_push\",\n   \"loggers\": [\"uiprotect\", \"unifi_discovery\"],\n-  \"requirements\": [\"uiprotect==6.6.3\", \"unifi-discovery==1.2.0\"],\n+  \"requirements\": [\"uiprotect==6.6.4\", \"unifi-discovery==1.2.0\"],\n   \"ssdp\": [\n     {\n       \"manufacturer\": \"Ubiquiti Networks\",\ndiff --git a/requirements_all.txt b/requirements_all.txt\nindex a49a7434ef5044..e63af5cede4a2d 100644\n--- a/requirements_all.txt\n+++ b/requirements_all.txt\n@@ -2897,7 +2897,7 @@ typedmonarchmoney==0.3.1\n uasiren==0.0.1\n \n # homeassistant.components.unifiprotect\n-uiprotect==6.6.3\n+uiprotect==6.6.4\n \n # homeassistant.components.landisgyr_heat_meter\n ultraheat-api==0.5.7\n", "test_patch": "diff --git a/requirements_test_all.txt b/requirements_test_all.txt\nindex c98d3525419a33..a0a39296b39311 100644\n--- a/requirements_test_all.txt\n+++ b/requirements_test_all.txt\n@@ -2310,7 +2310,7 @@ typedmonarchmoney==0.3.1\n uasiren==0.0.1\n \n # homeassistant.components.unifiprotect\n-uiprotect==6.6.3\n+uiprotect==6.6.4\n \n # homeassistant.components.landisgyr_heat_meter\n ultraheat-api==0.5.7\n", "problem_statement": "Unifi protect camera's not generating snapshots\n### The problem\r\n\r\nUnifi protect camera's do not seem to be able to generate snapshots. Good to mention that live streams are working without any issue.\r\n\r\n### What version of Home Assistant Core has the issue?\r\n\r\n2014.12.0b2\r\n\r\n### What was the last working version of Home Assistant Core?\r\n\r\n2014.11.3\r\n\r\n### What type of installation are you running?\r\n\r\nHome Assistant OS\r\n\r\n### Integration causing the issue\r\n\r\nUniFi Protect\r\n\r\n### Link to integration documentation on our website\r\n\r\nhttps://www.home-assistant.io/integrations/unifiprotect/\r\n\r\n### Diagnostics information\r\n\r\n_No response_\r\n\r\n### Example YAML snippet\r\n\r\n_No response_\r\n\r\n### Anything in the logs that might be useful for us?\r\n\r\n```txt\r\nLogger: aiohttp.server\r\nSource: /usr/local/lib/python3.13/site-packages/aiohttp/web_protocol.py:450\r\nFirst occurred: 10:21:59 (10 occurrences)\r\nLast logged: 10:23:32\r\n\r\nError handling request\r\nTraceback (most recent call last):\r\n  File \"/usr/local/lib/python3.13/site-packages/aiohttp/web_protocol.py\", line 479, in _handle_request\r\n    resp = await request_handler(request)\r\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/local/lib/python3.13/site-packages/aiohttp/web_app.py\", line 569, in _handle\r\n    return await handler(request)\r\n           ^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/local/lib/python3.13/site-packages/aiohttp/web_middlewares.py\", line 117, in impl\r\n    return await handler(request)\r\n           ^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/src/homeassistant/homeassistant/components/http/security_filter.py\", line 92, in security_filter_middleware\r\n    return await handler(request)\r\n           ^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/src/homeassistant/homeassistant/components/http/forwarded.py\", line 83, in forwarded_middleware\r\n    return await handler(request)\r\n           ^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/src/homeassistant/homeassistant/components/http/request_context.py\", line 26, in request_context_middleware\r\n    return await handler(request)\r\n           ^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/src/homeassistant/homeassistant/components/http/ban.py\", line 86, in ban_middleware\r\n    return await handler(request)\r\n           ^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/src/homeassistant/homeassistant/components/http/auth.py\", line 242, in auth_middleware\r\n    return await handler(request)\r\n           ^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/src/homeassistant/homeassistant/components/http/headers.py\", line 32, in headers_middleware\r\n    response = await handler(request)\r\n               ^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/src/homeassistant/homeassistant/helpers/http.py\", line 73, in handle\r\n    result = await handler(request, **request.match_info)\r\n             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/src/homeassistant/homeassistant/components/camera/__init__.py\", line 985, in get\r\n    return await self.handle(request, camera)\r\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/src/homeassistant/homeassistant/components/camera/__init__.py\", line 1003, in handle\r\n    image = await _async_get_image(\r\n            ^^^^^^^^^^^^^^^^^^^^^^^\r\n    ...<4 lines>...\r\n    )\r\n    ^\r\n  File \"/usr/src/homeassistant/homeassistant/components/camera/__init__.py\", line 217, in _async_get_image\r\n    else await camera.async_camera_image(width=width, height=height)\r\n         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/src/homeassistant/homeassistant/components/unifiprotect/camera.py\", line 250, in async_camera_image\r\n    last_image = await self.device.get_snapshot(width, height)\r\n                 ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/local/lib/python3.13/site-packages/uiprotect/data/devices.py\", line 2026, in get_snapshot\r\n    raise NotAuthorized(\r\n        f\"Do not have permission to {action} for camera: {self.id}\"\r\n    )\r\nuiprotect.exceptions.NotAuthorized: Do not have permission to read live for camera: 64a3d2b6003eaf03e70003f2\r\n```\r\n\r\n\r\n### Additional information\r\n\r\n_No response_\nUnifi protect camera's not generating snapshots\n### The problem\r\n\r\nUnifi protect camera's do not seem to be able to generate snapshots. Good to mention that live streams are working without any issue.\r\n\r\n### What version of Home Assistant Core has the issue?\r\n\r\n2014.12.0b2\r\n\r\n### What was the last working version of Home Assistant Core?\r\n\r\n2014.11.3\r\n\r\n### What type of installation are you running?\r\n\r\nHome Assistant OS\r\n\r\n### Integration causing the issue\r\n\r\nUniFi Protect\r\n\r\n### Link to integration documentation on our website\r\n\r\nhttps://www.home-assistant.io/integrations/unifiprotect/\r\n\r\n### Diagnostics information\r\n\r\n_No response_\r\n\r\n### Example YAML snippet\r\n\r\n_No response_\r\n\r\n### Anything in the logs that might be useful for us?\r\n\r\n```txt\r\nLogger: aiohttp.server\r\nSource: /usr/local/lib/python3.13/site-packages/aiohttp/web_protocol.py:450\r\nFirst occurred: 10:21:59 (10 occurrences)\r\nLast logged: 10:23:32\r\n\r\nError handling request\r\nTraceback (most recent call last):\r\n  File \"/usr/local/lib/python3.13/site-packages/aiohttp/web_protocol.py\", line 479, in _handle_request\r\n    resp = await request_handler(request)\r\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/local/lib/python3.13/site-packages/aiohttp/web_app.py\", line 569, in _handle\r\n    return await handler(request)\r\n           ^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/local/lib/python3.13/site-packages/aiohttp/web_middlewares.py\", line 117, in impl\r\n    return await handler(request)\r\n           ^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/src/homeassistant/homeassistant/components/http/security_filter.py\", line 92, in security_filter_middleware\r\n    return await handler(request)\r\n           ^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/src/homeassistant/homeassistant/components/http/forwarded.py\", line 83, in forwarded_middleware\r\n    return await handler(request)\r\n           ^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/src/homeassistant/homeassistant/components/http/request_context.py\", line 26, in request_context_middleware\r\n    return await handler(request)\r\n           ^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/src/homeassistant/homeassistant/components/http/ban.py\", line 86, in ban_middleware\r\n    return await handler(request)\r\n           ^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/src/homeassistant/homeassistant/components/http/auth.py\", line 242, in auth_middleware\r\n    return await handler(request)\r\n           ^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/src/homeassistant/homeassistant/components/http/headers.py\", line 32, in headers_middleware\r\n    response = await handler(request)\r\n               ^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/src/homeassistant/homeassistant/helpers/http.py\", line 73, in handle\r\n    result = await handler(request, **request.match_info)\r\n             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/src/homeassistant/homeassistant/components/camera/__init__.py\", line 985, in get\r\n    return await self.handle(request, camera)\r\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/src/homeassistant/homeassistant/components/camera/__init__.py\", line 1003, in handle\r\n    image = await _async_get_image(\r\n            ^^^^^^^^^^^^^^^^^^^^^^^\r\n    ...<4 lines>...\r\n    )\r\n    ^\r\n  File \"/usr/src/homeassistant/homeassistant/components/camera/__init__.py\", line 217, in _async_get_image\r\n    else await camera.async_camera_image(width=width, height=height)\r\n         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/src/homeassistant/homeassistant/components/unifiprotect/camera.py\", line 250, in async_camera_image\r\n    last_image = await self.device.get_snapshot(width, height)\r\n                 ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/local/lib/python3.13/site-packages/uiprotect/data/devices.py\", line 2026, in get_snapshot\r\n    raise NotAuthorized(\r\n        f\"Do not have permission to {action} for camera: {self.id}\"\r\n    )\r\nuiprotect.exceptions.NotAuthorized: Do not have permission to read live for camera: 64a3d2b6003eaf03e70003f2\r\n```\r\n\r\n\r\n### Additional information\r\n\r\n_No response_\n", "hints_text": "\nHey there @rahehl, mind taking a look at this issue as it has been labeled with an integration (`unifiprotect`) you are listed as a [code owner](https://github.com/home-assistant/core/blob/dev/CODEOWNERS#L1576) for? Thanks!\n\n<details>\n<summary>Code owner commands</summary>\n\n\nCode owners of `unifiprotect` can trigger bot actions by commenting:\n\n- `@home-assistant close` Closes the issue.\n- `@home-assistant rename Awesome new title` Renames the issue.\n- `@home-assistant reopen` Reopen the issue.\n- `@home-assistant unassign unifiprotect` Removes the current integration label and assignees on the issue, add the integration domain after the command.\n- `@home-assistant add-label needs-more-information` Add a label (needs-more-information, problem in dependency, problem in custom component) to the issue.\n- `@home-assistant remove-label needs-more-information` Remove a label (needs-more-information, problem in dependency, problem in custom component) on the issue.\n\n</details>\n\n\n<sub><sup>(message by CodeOwnersMention)</sup></sub>\n\n---\n\n[unifiprotect documentation](https://www.home-assistant.io/integrations/unifiprotect)\n[unifiprotect source](https://github.com/home-assistant/core/tree/dev/homeassistant/components/unifiprotect)\n<sub><sup>(message by IssueLinks)</sup></sub>\nLooking at the log message, HA needs \"read live\" permissions for the camera in UniFi OS/Protect. Previously, the more advanced extensive \"read media\" permissions were required. Now, that or even just \"read live\" should work.\r\nSome explanation on why this change was made can be found here:\r\n- https://github.com/uilibs/uiprotect/pull/285\r\n\r\nIt\u2019s a valid issue if permissions are set up correctly.\n@Yardco Curious, everything with read media should actually have read live permissions. Which version of Protect are you using, and what are the permissions of the HA user in Protect?\nCurrently on Protect 5.1.57, and have a dedicated home assistant account with full management rights for protect (account is restricted to local access only) instead of live or view only. I've set it this way ever since setting up the integration so didn't expect this to potentially be the culprit?\nIf I'm not mistaken, the issue lies with the protect API being a bit unclean, but the fix is most likely in the uiprotect library. For snapshots without a timestamp, the request should be forwarded if either of the permissions is present.\nuiprotect lib fix is ready Needs Review and Release https://github.com/uilibs/uiprotect/pull/298\n\nHey there @rahehl, mind taking a look at this issue as it has been labeled with an integration (`unifiprotect`) you are listed as a [code owner](https://github.com/home-assistant/core/blob/dev/CODEOWNERS#L1576) for? Thanks!\n\n<details>\n<summary>Code owner commands</summary>\n\n\nCode owners of `unifiprotect` can trigger bot actions by commenting:\n\n- `@home-assistant close` Closes the issue.\n- `@home-assistant rename Awesome new title` Renames the issue.\n- `@home-assistant reopen` Reopen the issue.\n- `@home-assistant unassign unifiprotect` Removes the current integration label and assignees on the issue, add the integration domain after the command.\n- `@home-assistant add-label needs-more-information` Add a label (needs-more-information, problem in dependency, problem in custom component) to the issue.\n- `@home-assistant remove-label needs-more-information` Remove a label (needs-more-information, problem in dependency, problem in custom component) on the issue.\n\n</details>\n\n\n<sub><sup>(message by CodeOwnersMention)</sup></sub>\n\n---\n\n[unifiprotect documentation](https://www.home-assistant.io/integrations/unifiprotect)\n[unifiprotect source](https://github.com/home-assistant/core/tree/dev/homeassistant/components/unifiprotect)\n<sub><sup>(message by IssueLinks)</sup></sub>\nLooking at the log message, HA needs \"read live\" permissions for the camera in UniFi OS/Protect. Previously, the more advanced extensive \"read media\" permissions were required. Now, that or even just \"read live\" should work.\r\nSome explanation on why this change was made can be found here:\r\n- https://github.com/uilibs/uiprotect/pull/285\r\n\r\nIt\u2019s a valid issue if permissions are set up correctly.\n@Yardco Curious, everything with read media should actually have read live permissions. Which version of Protect are you using, and what are the permissions of the HA user in Protect?\nCurrently on Protect 5.1.57, and have a dedicated home assistant account with full management rights for protect (account is restricted to local access only) instead of live or view only. I've set it this way ever since setting up the integration so didn't expect this to potentially be the culprit?\nIf I'm not mistaken, the issue lies with the protect API being a bit unclean, but the fix is most likely in the uiprotect library. For snapshots without a timestamp, the request should be forwarded if either of the permissions is present.\nuiprotect lib fix is ready Needs Review and Release https://github.com/uilibs/uiprotect/pull/298", "created_at": "2024-11-29T17:56:36Z"}
{"repo": "home-assistant/core", "pull_number": 131930, "instance_id": "home-assistant__core-131930", "issue_numbers": ["131929"], "base_commit": "920c958ec7e6a52c6c535113cc495a8d817827a7", "patch": "diff --git a/homeassistant/components/apsystems/coordinator.py b/homeassistant/components/apsystems/coordinator.py\nindex b6e951343f7ef1..e56cb8268407af 100644\n--- a/homeassistant/components/apsystems/coordinator.py\n+++ b/homeassistant/components/apsystems/coordinator.py\n@@ -5,12 +5,17 @@\n from dataclasses import dataclass\n from datetime import timedelta\n \n-from APsystemsEZ1 import APsystemsEZ1M, ReturnAlarmInfo, ReturnOutputData\n+from APsystemsEZ1 import (\n+    APsystemsEZ1M,\n+    InverterReturnedError,\n+    ReturnAlarmInfo,\n+    ReturnOutputData,\n+)\n \n from homeassistant.core import HomeAssistant\n from homeassistant.helpers.update_coordinator import DataUpdateCoordinator, UpdateFailed\n \n-from .const import LOGGER\n+from .const import DOMAIN, LOGGER\n \n \n @dataclass\n@@ -43,6 +48,11 @@ async def _async_setup(self) -> None:\n         self.api.min_power = device_info.minPower\n \n     async def _async_update_data(self) -> ApSystemsSensorData:\n-        output_data = await self.api.get_output_data()\n-        alarm_info = await self.api.get_alarm_info()\n+        try:\n+            output_data = await self.api.get_output_data()\n+            alarm_info = await self.api.get_alarm_info()\n+        except InverterReturnedError:\n+            raise UpdateFailed(\n+                translation_domain=DOMAIN, translation_key=\"inverter_error\"\n+            ) from None\n         return ApSystemsSensorData(output_data=output_data, alarm_info=alarm_info)\ndiff --git a/homeassistant/components/apsystems/strings.json b/homeassistant/components/apsystems/strings.json\nindex e02f86c273055c..b3a10ca49a70eb 100644\n--- a/homeassistant/components/apsystems/strings.json\n+++ b/homeassistant/components/apsystems/strings.json\n@@ -72,5 +72,10 @@\n         \"name\": \"Inverter status\"\n       }\n     }\n+  },\n+  \"exceptions\": {\n+    \"inverter_error\": {\n+      \"message\": \"Inverter returned an error\"\n+    }\n   }\n }\n", "test_patch": "diff --git a/tests/components/apsystems/test_init.py b/tests/components/apsystems/test_init.py\nnew file mode 100644\nindex 00000000000000..c85c4094e30c82\n--- /dev/null\n+++ b/tests/components/apsystems/test_init.py\n@@ -0,0 +1,25 @@\n+\"\"\"Test the APSystem setup.\"\"\"\n+\n+from unittest.mock import AsyncMock\n+\n+from APsystemsEZ1 import InverterReturnedError\n+\n+from homeassistant.components.apsystems.const import DOMAIN\n+from homeassistant.config_entries import ConfigEntryState\n+from homeassistant.core import HomeAssistant\n+\n+from . import setup_integration\n+\n+from tests.common import MockConfigEntry\n+\n+\n+async def test_update_failed(\n+    hass: HomeAssistant,\n+    mock_apsystems: AsyncMock,\n+    mock_config_entry: MockConfigEntry,\n+) -> None:\n+    \"\"\"Test update failed.\"\"\"\n+    mock_apsystems.get_output_data.side_effect = InverterReturnedError\n+    await setup_integration(hass, mock_config_entry)\n+    entry = hass.config_entries.async_entries(DOMAIN)[0]\n+    assert entry.state is ConfigEntryState.SETUP_RETRY\n", "problem_statement": "Uncaught InverterReturnedError in AP Systems\n### The problem\r\n\r\nThere is often a `InverterReturnedError`. Sometimes every 5 minutes.\r\nThis exception should be catched and `UpdateFailed` should be rissen.\r\n\r\n### What version of Home Assistant Core has the issue?\r\n\r\ncore-2024.11.3\r\n\r\n### What was the last working version of Home Assistant Core?\r\n\r\n_No response_\r\n\r\n### What type of installation are you running?\r\n\r\nHome Assistant OS\r\n\r\n### Integration causing the issue\r\n\r\napsystems\r\n\r\n### Link to integration documentation on our website\r\n\r\nhttps://www.home-assistant.io/integrations/apsystems/\r\n\r\n### Diagnostics information\r\n\r\n_No response_\r\n\r\n### Example YAML snippet\r\n\r\n_No response_\r\n\r\n### Anything in the logs that might be useful for us?\r\n\r\n```txt\r\n2024-11-29 08:48:37.609 ERROR (MainThread) [homeassistant.components.apsystems] Unexpected error fetching APSystems Data data\r\nTraceback (most recent call last):\r\n  File \"/usr/src/homeassistant/homeassistant/helpers/update_coordinator.py\", line 382, in _async_refresh\r\n    self.data = await self._async_update_data()\r\n                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/src/homeassistant/homeassistant/components/apsystems/coordinator.py\", line 46, in _async_update_data\r\n    output_data = await self.api.get_output_data()\r\n                  ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/local/lib/python3.12/site-packages/APsystemsEZ1/__init__.py\", line 219, in get_output_data\r\n    response = await self._request(\"getOutputData\")\r\n               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/local/lib/python3.12/site-packages/APsystemsEZ1/__init__.py\", line 106, in _request\r\n    return await self._request(endpoint, retry=False)\r\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/local/lib/python3.12/site-packages/APsystemsEZ1/__init__.py\", line 107, in _request\r\n    raise InverterReturnedError\r\nAPsystemsEZ1.InverterReturnedError\r\n```\r\n\r\n\r\n### Additional information\r\n\r\n_No response_\n```[tasklist]\n### Tasks\n```\n\n", "hints_text": "\nHey there @mawoka-myblock, @sonnenladengmbh, mind taking a look at this issue as it has been labeled with an integration (`apsystems`) you are listed as a [code owner](https://github.com/home-assistant/core/blob/dev/CODEOWNERS#L134) for? Thanks!\n\n<details>\n<summary>Code owner commands</summary>\n\n\nCode owners of `apsystems` can trigger bot actions by commenting:\n\n- `@home-assistant close` Closes the issue.\n- `@home-assistant rename Awesome new title` Renames the issue.\n- `@home-assistant reopen` Reopen the issue.\n- `@home-assistant unassign apsystems` Removes the current integration label and assignees on the issue, add the integration domain after the command.\n- `@home-assistant add-label needs-more-information` Add a label (needs-more-information, problem in dependency, problem in custom component) to the issue.\n- `@home-assistant remove-label needs-more-information` Remove a label (needs-more-information, problem in dependency, problem in custom component) on the issue.\n\n</details>\n\n\n<sub><sup>(message by CodeOwnersMention)</sup></sub>\n\n---\n\n[apsystems documentation](https://www.home-assistant.io/integrations/apsystems)\n[apsystems source](https://github.com/home-assistant/core/tree/dev/homeassistant/components/apsystems)\n<sub><sup>(message by IssueLinks)</sup></sub>", "created_at": "2024-11-29T17:21:09Z"}
{"repo": "home-assistant/core", "pull_number": 131906, "instance_id": "home-assistant__core-131906", "issue_numbers": ["131901"], "base_commit": "954ac0d288d8768836803508a259060c4e22c2d3", "patch": "diff --git a/homeassistant/components/acaia/manifest.json b/homeassistant/components/acaia/manifest.json\nindex 49b3489cf9ad6e..3f3e1c14d58d17 100644\n--- a/homeassistant/components/acaia/manifest.json\n+++ b/homeassistant/components/acaia/manifest.json\n@@ -25,5 +25,5 @@\n   \"integration_type\": \"device\",\n   \"iot_class\": \"local_push\",\n   \"loggers\": [\"aioacaia\"],\n-  \"requirements\": [\"aioacaia==0.1.9\"]\n+  \"requirements\": [\"aioacaia==0.1.10\"]\n }\ndiff --git a/requirements_all.txt b/requirements_all.txt\nindex 0226fa8d924bab..f024c44943baf2 100644\n--- a/requirements_all.txt\n+++ b/requirements_all.txt\n@@ -173,7 +173,7 @@ aio-geojson-usgs-earthquakes==0.3\n aio-georss-gdacs==0.10\n \n # homeassistant.components.acaia\n-aioacaia==0.1.9\n+aioacaia==0.1.10\n \n # homeassistant.components.airq\n aioairq==0.4.3\n", "test_patch": "diff --git a/requirements_test_all.txt b/requirements_test_all.txt\nindex ac180f8c6508a5..7a2e48c80d88a7 100644\n--- a/requirements_test_all.txt\n+++ b/requirements_test_all.txt\n@@ -161,7 +161,7 @@ aio-geojson-usgs-earthquakes==0.3\n aio-georss-gdacs==0.10\n \n # homeassistant.components.acaia\n-aioacaia==0.1.9\n+aioacaia==0.1.10\n \n # homeassistant.components.airq\n aioairq==0.4.3\n", "problem_statement": "Acaia integration causes aiohttp error when trying to connect with old Acaia Pearl scale\n### The problem\n\nI'm not sure if this scale is even supported, as it's quite old (bought it in 2017), however it's BT name is PROCHBT001 which is listed in the integration manifest, so maybe it is?\r\n\r\nThe scale is not discovered automatically, I tried to add it manually which causes error.\r\n\r\nI have disabled BT in my phone to be 100% sure it's not intercepting the scale connection. I have multiple Shellies with BT proxy enabled and I also tried moving my scale and testing it right next to ESP32 with Esphome 2024.9 installed. There is nothing in ESP logs that would say it tries to connect to the scale.\n\n### What version of Home Assistant Core has the issue?\n\ncore-2024.12.0b2\n\n### What was the last working version of Home Assistant Core?\n\n_No response_\n\n### What type of installation are you running?\n\nHome Assistant OS\n\n### Integration causing the issue\n\nAcaia\n\n### Link to integration documentation on our website\n\nhttps://github.com/home-assistant/core/tree/dev/homeassistant/components/acaia\n\n### Diagnostics information\n\n_No response_\n\n### Example YAML snippet\n\n_No response_\n\n### Anything in the logs that might be useful for us?\n\n```txt\nRejestrator: aiohttp.server\r\n\u0179r\u00f3d\u0142o: /usr/local/lib/python3.13/site-packages/aiohttp/web_protocol.py:450\r\nPierwsze zdarzenie: 10:26:39 (11 zdarzenia)\r\nOstatnio zalogowany: 10:52:39\r\n\r\nError handling request\r\nTraceback (most recent call last):\r\n  File \"/usr/local/lib/python3.13/site-packages/aiohttp/web_protocol.py\", line 479, in _handle_request\r\n    resp = await request_handler(request)\r\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/local/lib/python3.13/site-packages/aiohttp/web_app.py\", line 569, in _handle\r\n    return await handler(request)\r\n           ^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/local/lib/python3.13/site-packages/aiohttp/web_middlewares.py\", line 117, in impl\r\n    return await handler(request)\r\n           ^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/src/homeassistant/homeassistant/components/http/security_filter.py\", line 92, in security_filter_middleware\r\n    return await handler(request)\r\n           ^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/src/homeassistant/homeassistant/components/http/forwarded.py\", line 210, in forwarded_middleware\r\n    return await handler(request)\r\n           ^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/src/homeassistant/homeassistant/components/http/request_context.py\", line 26, in request_context_middleware\r\n    return await handler(request)\r\n           ^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/src/homeassistant/homeassistant/components/http/ban.py\", line 86, in ban_middleware\r\n    return await handler(request)\r\n           ^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/src/homeassistant/homeassistant/components/http/auth.py\", line 242, in auth_middleware\r\n    return await handler(request)\r\n           ^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/src/homeassistant/homeassistant/components/http/headers.py\", line 32, in headers_middleware\r\n    response = await handler(request)\r\n               ^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/src/homeassistant/homeassistant/helpers/http.py\", line 73, in handle\r\n    result = await handler(request, **request.match_info)\r\n             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/src/homeassistant/homeassistant/components/http/decorators.py\", line 81, in with_admin\r\n    return await func(self, request, *args, **kwargs)\r\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/src/homeassistant/homeassistant/components/config/config_entries.py\", line 222, in post\r\n    return await super().post(request, flow_id)\r\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/src/homeassistant/homeassistant/components/http/data_validator.py\", line 74, in wrapper\r\n    return await method(view, request, data, *args, **kwargs)\r\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/src/homeassistant/homeassistant/helpers/data_entry_flow.py\", line 122, in post\r\n    result = await self._flow_mgr.async_configure(flow_id, data)\r\n             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/src/homeassistant/homeassistant/data_entry_flow.py\", line 367, in async_configure\r\n    result = await self._async_configure(flow_id, user_input)\r\n             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/src/homeassistant/homeassistant/data_entry_flow.py\", line 414, in _async_configure\r\n    result = await self._async_handle_step(\r\n             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n        flow, cur_step[\"step_id\"], user_input\r\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n    )\r\n    ^\r\n  File \"/usr/src/homeassistant/homeassistant/data_entry_flow.py\", line 517, in _async_handle_step\r\n    result: _FlowResultT = await getattr(flow, method)(user_input)\r\n                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/src/homeassistant/homeassistant/components/acaia/config_flow.py\", line 47, in async_step_user\r\n    is_new_style_scale = await is_new_scale(mac)\r\n                         ^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/local/lib/python3.13/site-packages/aioacaia/helpers.py\", line 46, in is_new_scale\r\n    async with BleakClient(address_or_ble_device) as client:\r\n               ~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/local/lib/python3.13/site-packages/bleak/__init__.py\", line 570, in __aenter__\r\n    await self.connect()\r\n  File \"/usr/local/lib/python3.13/site-packages/habluetooth/wrappers.py\", line 286, in connect\r\n    wrapped_backend = self._async_get_best_available_backend_and_device(manager)\r\n  File \"/usr/local/lib/python3.13/site-packages/habluetooth/wrappers.py\", line 395, in _async_get_best_available_backend_and_device\r\n    raise BleakError(\r\n    ...<2 lines>...\r\n    )\r\nbleak.exc.BleakError: No backend with an available connection slot that can reach address 00:1c:97:16:5b:c7 was found\n```\n\n\n### Additional information\n\n_No response_\n", "hints_text": "\nHey there @zweckj, mind taking a look at this issue as it has been labeled with an integration (`acaia`) you are listed as a [code owner](https://github.com/home-assistant/core/blob/dev/CODEOWNERS#L43) for? Thanks!\n\n<details>\n<summary>Code owner commands</summary>\n\n\nCode owners of `acaia` can trigger bot actions by commenting:\n\n- `@home-assistant close` Closes the issue.\n- `@home-assistant rename Awesome new title` Renames the issue.\n- `@home-assistant reopen` Reopen the issue.\n- `@home-assistant unassign acaia` Removes the current integration label and assignees on the issue, add the integration domain after the command.\n- `@home-assistant add-label needs-more-information` Add a label (needs-more-information, problem in dependency, problem in custom component) to the issue.\n- `@home-assistant remove-label needs-more-information` Remove a label (needs-more-information, problem in dependency, problem in custom component) on the issue.\n\n</details>\n\n\n<sub><sup>(message by CodeOwnersMention)</sup></sub>\n\n---\n\n[acaia documentation](https://www.home-assistant.io/integrations/acaia)\n[acaia source](https://github.com/home-assistant/core/tree/dev/homeassistant/components/acaia)\n<sub><sup>(message by IssueLinks)</sup></sub>\nThis is an unhandled exception indeed, so thanks for reporting, but the underlying issue here is that you have no Bluetooth connection from your HA instance/BT proxy to your scale.", "created_at": "2024-11-29T11:05:41Z"}
{"repo": "home-assistant/core", "pull_number": 131882, "instance_id": "home-assistant__core-131882", "issue_numbers": ["121792"], "base_commit": "d596b4169dc909b709fa1047f0a7c866a1e6011c", "patch": "diff --git a/homeassistant/components/denonavr/manifest.json b/homeassistant/components/denonavr/manifest.json\nindex eff70b94a18fd2..328ab504bd1d39 100644\n--- a/homeassistant/components/denonavr/manifest.json\n+++ b/homeassistant/components/denonavr/manifest.json\n@@ -6,7 +6,7 @@\n   \"documentation\": \"https://www.home-assistant.io/integrations/denonavr\",\n   \"iot_class\": \"local_push\",\n   \"loggers\": [\"denonavr\"],\n-  \"requirements\": [\"denonavr==1.0.0\"],\n+  \"requirements\": [\"denonavr==1.0.1\"],\n   \"ssdp\": [\n     {\n       \"manufacturer\": \"Denon\",\ndiff --git a/requirements_all.txt b/requirements_all.txt\nindex 0226fa8d924bab..ee4177baa0a91d 100644\n--- a/requirements_all.txt\n+++ b/requirements_all.txt\n@@ -752,7 +752,7 @@ deluge-client==1.10.2\n demetriek==0.4.0\n \n # homeassistant.components.denonavr\n-denonavr==1.0.0\n+denonavr==1.0.1\n \n # homeassistant.components.devialet\n devialet==1.4.5\n", "test_patch": "diff --git a/requirements_test_all.txt b/requirements_test_all.txt\nindex ac180f8c6508a5..85d5a5bbdd9eb7 100644\n--- a/requirements_test_all.txt\n+++ b/requirements_test_all.txt\n@@ -642,7 +642,7 @@ deluge-client==1.10.2\n demetriek==0.4.0\n \n # homeassistant.components.denonavr\n-denonavr==1.0.0\n+denonavr==1.0.1\n \n # homeassistant.components.devialet\n devialet==1.4.5\n", "problem_statement": "Denon AVR Sound Mode mismatch between HA and the actual unit\n### The problem\n\nWhen using the \"Denon AVR network recievers\" integration with my AVR_X1600H, I discovered the following issue:\r\n\r\n- Sound mode status de-sync when operating via UI\r\n\r\nMethod to reproduce: \r\n1. turn on the reciever and select DTS NEU:X as sound mode with IR remote\r\n2. via developer tools/service, call `media_player.select_sound_mode` on the unit with \"DOLBY DIGITAL\" as sound mode, observe that the unit actually changed to DSUR mode\r\n3. observe that the state attribute of the unit changes to:\r\n```\r\nsound_mode: DOLBY DIGITAL\r\nsound_mode_raw: DOLBY AUDIO-DSUR\r\n```\r\n4. select \"DTS SURROUND\" via the UI, notice the unit actually changes to DTS Neu:X mode\r\n5. observe that the state attribute of the unit changes to:\r\n```\r\nsound_mode: DOLBY DIGITAL     <--- mismatch\r\nsound_mode_raw: NEURAL:X\r\n``` \r\n6. close the dialogue box on the UI and re-open it, observe the sound mode is still stuck at \"DOLBY DIGITAL\"\n\n### What version of Home Assistant Core has the issue?\n\ncore-2024.7.2\n\n### What was the last working version of Home Assistant Core?\n\n_No response_\n\n### What type of installation are you running?\n\nHome Assistant Container\n\n### Integration causing the issue\n\nDenon AVR network recievers\n\n### Link to integration documentation on our website\n\nhttps://www.home-assistant.io/integrations/denonavr/\n\n### Diagnostics information\n\n*It does not provide diagnostic*\n\n### Example YAML snippet\n\n_No response_\n\n### Anything in the logs that might be useful for us?\n\n```txt\nLogger: homeassistant.components.denonavr.media_player\r\nSource: components/denonavr/media_player.py:213\r\nintegration: Denon AVR Network Receivers (documentation, issues)\r\nFirst occurred: July 11, 2024 at 10:02:36 PM (3 occurrences)\r\nLast logged: July 11, 2024 at 10:35:41 PM\r\n\r\nDenon AVR receiver at host 192.168.31.36 responded with HTTP 403 error. Device is unavailable. Please consider power cycling your receiver\n```\n\n\n### Additional information\n\nA reload does not fix the issue, so the 403 is likely not an issue. \r\n\r\nPossibily related to #117255 , but I cannot find the relevant logs.\r\n\r\nIt is possible to transition from DTS-STEREO-DOLBY, but the sound mode is still wrong.\r\n\r\nIt is not possible to transition from DTS-DOLBY directly as it thinks it was in DOLBY already.\r\n\r\n\n", "hints_text": "\nHey there @ol-iver, @starkillerog, mind taking a look at this issue as it has been labeled with an integration (`denonavr`) you are listed as a [code owner](https://github.com/home-assistant/core/blob/dev/CODEOWNERS#L303) for? Thanks!\n\n<details>\n<summary>Code owner commands</summary>\n\n\nCode owners of `denonavr` can trigger bot actions by commenting:\n\n- `@home-assistant close` Closes the issue.\n- `@home-assistant rename Awesome new title` Renames the issue.\n- `@home-assistant reopen` Reopen the issue.\n- `@home-assistant unassign denonavr` Removes the current integration label and assignees on the issue, add the integration domain after the command.\n- `@home-assistant add-label needs-more-information` Add a label (needs-more-information, problem in dependency, problem in custom component) to the issue.\n- `@home-assistant remove-label needs-more-information` Remove a label (needs-more-information, problem in dependency, problem in custom component) on the issue.\n\n</details>\n\n\n<sub><sup>(message by CodeOwnersMention)</sup></sub>\n\n---\n\n[denonavr documentation](https://www.home-assistant.io/integrations/denonavr)\n[denonavr source](https://github.com/home-assistant/core/tree/dev/homeassistant/components/denonavr)\n<sub><sup>(message by IssueLinks)</sup></sub>\nFrom my limited tests, I think the issue is incorrect mapping of `NEURAL:X` to `DOLBY DIGITAL`.\r\n\r\nI will look through the code and see if I find anything\nIt seems that it was incorrectly mapped here. I can't find Dolby Neural:X on my unit, perhaps it would be unit-dependent?\r\n\r\nhttps://github.com/ol-iver/denonavr/blob/a32de5979a4bda19e1e9b599fd895570af59e292/denonavr/const.py#L238-L249\r\n\r\nMaybe it would be more approiate to check for `NEURAL:X` instead of `DTS NEURAL:X`?\r\n\r\nhttps://github.com/ol-iver/denonavr/blob/a32de5979a4bda19e1e9b599fd895570af59e292/denonavr/const.py#L275-L279\r\n\r\nEdit: sorry cant get the embedded code snippets to work\nFurther testing will be needed to see if this have been solved by #126703\nWe made the wrong assumption where `NEURAL:X` belongs to \ud83d\ude42 \r\nI fixed this with https://github.com/ol-iver/denonavr/pull/317.", "created_at": "2024-11-28T22:52:58Z"}
{"repo": "home-assistant/core", "pull_number": 131876, "instance_id": "home-assistant__core-131876", "issue_numbers": ["131872"], "base_commit": "94b16da90f0b6863255fb5fdbfee554e28c82045", "patch": "diff --git a/homeassistant/components/elmax/common.py b/homeassistant/components/elmax/common.py\nindex 88e61e36a683d8..18350e45efeb08 100644\n--- a/homeassistant/components/elmax/common.py\n+++ b/homeassistant/components/elmax/common.py\n@@ -35,7 +35,7 @@ def check_local_version_supported(api_version: str | None) -> bool:\n class DirectPanel(PanelEntry):\n     \"\"\"Helper class for wrapping a directly accessed Elmax Panel.\"\"\"\n \n-    def __init__(self, panel_uri):\n+    def __init__(self, panel_uri) -> None:\n         \"\"\"Construct the object.\"\"\"\n         super().__init__(panel_uri, True, {})\n \ndiff --git a/homeassistant/components/elmax/config_flow.py b/homeassistant/components/elmax/config_flow.py\nindex bf479e997efba7..3bb01efd3d53b5 100644\n--- a/homeassistant/components/elmax/config_flow.py\n+++ b/homeassistant/components/elmax/config_flow.py\n@@ -203,7 +203,7 @@ async def _test_direct_and_create_entry(self):\n \n     async def async_step_direct(self, user_input: dict[str, Any]) -> ConfigFlowResult:\n         \"\"\"Handle the direct setup step.\"\"\"\n-        self._selected_mode = CONF_ELMAX_MODE_CLOUD\n+        self._selected_mode = CONF_ELMAX_MODE_DIRECT\n         if user_input is None:\n             return self.async_show_form(\n                 step_id=CONF_ELMAX_MODE_DIRECT,\ndiff --git a/homeassistant/components/elmax/cover.py b/homeassistant/components/elmax/cover.py\nindex a53c28c5f338b0..403bc51dbffab0 100644\n--- a/homeassistant/components/elmax/cover.py\n+++ b/homeassistant/components/elmax/cover.py\n@@ -121,13 +121,13 @@ async def async_stop_cover(self, **kwargs: Any) -> None:\n         else:\n             _LOGGER.debug(\"Ignoring stop request as the cover is IDLE\")\n \n-    async def async_open_cover(self, **kwargs):\n+    async def async_open_cover(self, **kwargs: Any) -> None:\n         \"\"\"Open the cover.\"\"\"\n         await self.coordinator.http_client.execute_command(\n             endpoint_id=self._device.endpoint_id, command=CoverCommand.UP\n         )\n \n-    async def async_close_cover(self, **kwargs):\n+    async def async_close_cover(self, **kwargs: Any) -> None:\n         \"\"\"Close the cover.\"\"\"\n         await self.coordinator.http_client.execute_command(\n             endpoint_id=self._device.endpoint_id, command=CoverCommand.DOWN\ndiff --git a/homeassistant/components/elmax/manifest.json b/homeassistant/components/elmax/manifest.json\nindex efa97a9f6b958b..dfa20326d0c1f5 100644\n--- a/homeassistant/components/elmax/manifest.json\n+++ b/homeassistant/components/elmax/manifest.json\n@@ -6,7 +6,7 @@\n   \"documentation\": \"https://www.home-assistant.io/integrations/elmax\",\n   \"iot_class\": \"cloud_polling\",\n   \"loggers\": [\"elmax_api\"],\n-  \"requirements\": [\"elmax-api==0.0.6.1\"],\n+  \"requirements\": [\"elmax-api==0.0.6.3\"],\n   \"zeroconf\": [\n     {\n       \"type\": \"_elmax-ssl._tcp.local.\"\ndiff --git a/requirements_all.txt b/requirements_all.txt\nindex 4d114841761b32..55a5d3a9e5add4 100644\n--- a/requirements_all.txt\n+++ b/requirements_all.txt\n@@ -821,7 +821,7 @@ eliqonline==1.2.2\n elkm1-lib==2.2.10\n \n # homeassistant.components.elmax\n-elmax-api==0.0.6.1\n+elmax-api==0.0.6.3\n \n # homeassistant.components.elvia\n elvia==0.1.0\n", "test_patch": "diff --git a/requirements_test_all.txt b/requirements_test_all.txt\nindex 9c0d22b51ec87f..6c4349415ab782 100644\n--- a/requirements_test_all.txt\n+++ b/requirements_test_all.txt\n@@ -696,7 +696,7 @@ elgato==5.1.2\n elkm1-lib==2.2.10\n \n # homeassistant.components.elmax\n-elmax-api==0.0.6.1\n+elmax-api==0.0.6.3\n \n # homeassistant.components.elvia\n elvia==0.1.0\ndiff --git a/tests/components/elmax/conftest.py b/tests/components/elmax/conftest.py\nindex f92fc2f18278c4..f8cf33ffe1a09b 100644\n--- a/tests/components/elmax/conftest.py\n+++ b/tests/components/elmax/conftest.py\n@@ -1,6 +1,7 @@\n \"\"\"Configuration for Elmax tests.\"\"\"\n \n from collections.abc import Generator\n+from datetime import datetime, timedelta\n import json\n from unittest.mock import AsyncMock, patch\n \n@@ -11,6 +12,7 @@\n     ENDPOINT_LOGIN,\n )\n from httpx import Response\n+import jwt\n import pytest\n import respx\n \n@@ -64,9 +66,20 @@ def httpx_mock_direct_fixture() -> Generator[respx.MockRouter]:\n     ) as respx_mock:\n         # Mock Login POST.\n         login_route = respx_mock.post(f\"/api/v2/{ENDPOINT_LOGIN}\", name=\"login\")\n-        login_route.return_value = Response(\n-            200, json=json.loads(load_fixture(\"direct/login.json\", \"elmax\"))\n+\n+        login_json = json.loads(load_fixture(\"direct/login.json\", \"elmax\"))\n+        decoded_jwt = jwt.decode_complete(\n+            login_json[\"token\"].split(\" \")[1],\n+            algorithms=\"HS256\",\n+            options={\"verify_signature\": False},\n+        )\n+        expiration = datetime.now() + timedelta(hours=1)\n+        decoded_jwt[\"payload\"][\"exp\"] = int(expiration.timestamp())\n+        jws_string = jwt.encode(\n+            payload=decoded_jwt[\"payload\"], algorithm=\"HS256\", key=\"\"\n         )\n+        login_json[\"token\"] = f\"JWT {jws_string}\"\n+        login_route.return_value = Response(200, json=login_json)\n \n         # Mock Device list GET.\n         list_devices_route = respx_mock.get(\n", "problem_statement": "Elmax - Error when adding direct panel without discovery\n### The problem\n\nWhen setting up the Elmax integration manually, the \"add operation\" goes well but the setup fails almost immediately.\n\n### What version of Home Assistant Core has the issue?\n\ncore-2024.11.3\n\n### What was the last working version of Home Assistant Core?\n\n_No response_\n\n### What type of installation are you running?\n\nHome Assistant OS\n\n### Integration causing the issue\n\nelmax\n\n### Link to integration documentation on our website\n\n_No response_\n\n### Diagnostics information\n\nThe error is related to a wrong/missing entry in the config_entry data. \r\n\r\n![image](https://github.com/user-attachments/assets/238ff07d-526f-435f-b48b-8c931fb12439)\r\n\n\n### Example YAML snippet\n\n_No response_\n\n### Anything in the logs that might be useful for us?\n\n_No response_\n\n### Additional information\n\n_No response_\n", "hints_text": "", "created_at": "2024-11-28T20:16:15Z"}
{"repo": "home-assistant/core", "pull_number": 131873, "instance_id": "home-assistant__core-131873", "issue_numbers": ["131775"], "base_commit": "954ac0d288d8768836803508a259060c4e22c2d3", "patch": "diff --git a/homeassistant/components/lamarzocco/config_flow.py b/homeassistant/components/lamarzocco/config_flow.py\nindex 0f288e22c4a018..a727e3fe35796e 100644\n--- a/homeassistant/components/lamarzocco/config_flow.py\n+++ b/homeassistant/components/lamarzocco/config_flow.py\n@@ -291,6 +291,7 @@ async def async_step_dhcp(\n                 CONF_ADDRESS: discovery_info.macaddress,\n             }\n         )\n+        self._async_abort_entries_match({CONF_ADDRESS: discovery_info.macaddress})\n \n         _LOGGER.debug(\n             \"Discovered La Marzocco machine %s through DHCP at address %s\",\n", "test_patch": "diff --git a/tests/components/lamarzocco/test_config_flow.py b/tests/components/lamarzocco/test_config_flow.py\nindex f8103ac3054410..b206b7b68a3c27 100644\n--- a/tests/components/lamarzocco/test_config_flow.py\n+++ b/tests/components/lamarzocco/test_config_flow.py\n@@ -493,6 +493,27 @@ async def test_dhcp_discovery(\n         }\n \n \n+async def test_dhcp_discovery_abort_on_hostname_changed(\n+    hass: HomeAssistant,\n+    mock_lamarzocco: MagicMock,\n+    mock_cloud_client: MagicMock,\n+    mock_config_entry: MockConfigEntry,\n+) -> None:\n+    \"\"\"Test dhcp discovery aborts when hostname was changed manually.\"\"\"\n+    mock_config_entry.add_to_hass(hass)\n+    result = await hass.config_entries.flow.async_init(\n+        DOMAIN,\n+        context={\"source\": SOURCE_DHCP},\n+        data=DhcpServiceInfo(\n+            ip=\"192.168.1.42\",\n+            hostname=\"custom_name\",\n+            macaddress=\"00:00:00:00:00:00\",\n+        ),\n+    )\n+    assert result[\"type\"] is FlowResultType.ABORT\n+    assert result[\"reason\"] == \"already_configured\"\n+\n+\n async def test_dhcp_already_configured_and_update(\n     hass: HomeAssistant,\n     mock_lamarzocco: MagicMock,\n", "problem_statement": "\"New\" La Marzocco machine discovered\n### The problem\r\n\r\nThe La Marzocco integration has seemingly discovered a new machine in addition to the one I already have, and shows an untranslated string in the message.  The existing machine works fine with the integration.\r\n\r\n### What version of Home Assistant Core has the issue?\r\n\r\ncore-2024.12.0b0\r\n\r\n### What was the last working version of Home Assistant Core?\r\n\r\ncore-2024.11.3\r\n\r\n### What type of installation are you running?\r\n\r\nHome Assistant Container\r\n\r\n### Integration causing the issue\r\n\r\nLa Marzocco\r\n\r\n### Link to integration documentation on our website\r\n\r\nhttps://www.home-assistant.io/integrations/lamarzocco/\r\n\r\n### Diagnostics information\r\n\r\n[config_entry-lamarzocco-b780300196851a7621455e543cc8aeff (1).json](https://github.com/user-attachments/files/17940443/config_entry-lamarzocco-b780300196851a7621455e543cc8aeff.1.json)\r\n\r\n\r\n### Example YAML snippet\r\n\r\n_No response_\r\n\r\n### Anything in the logs that might be useful for us?\r\n\r\nI power cycled my machine to see if I could find something in the zeroconf advertisement, but I don't even see it there.  When I did that, I got the following in my HA logs:\r\n\r\n```txt\r\n2024-11-27 14:19:53.488 ERROR (MainThread) [frontend.js.modern.202411270] Failed to format translation for key 'component.lamarzocco.config.flow_title' in language 'en'. Error: The intl string context variable \"host\" was not provided to the string \"La Marzocco Espresso {host}\"\r\n2024-11-27 14:19:53.489 ERROR (MainThread) [frontend.js.modern.202411270] Failed to format translation for key 'component.lamarzocco.config.flow_title' in language 'en'. Error: The intl string context variable \"host\" was not provided to the string \"La Marzocco Espresso {host}\"\r\n2024-11-27 14:19:53.490 ERROR (MainThread) [frontend.js.modern.202411270] Failed to format translation for key 'component.lamarzocco.config.flow_title' in language 'en'. Error: The intl string context variable \"host\" was not provided to the string \"La Marzocco Espresso {host}\"\r\n2024-11-27 14:19:53.490 ERROR (MainThread) [frontend.js.modern.202411270] Failed to format translation for key 'component.lamarzocco.config.flow_title' in language 'en'. Error: The intl string context variable \"host\" was not provided to the string \"La Marzocco Espresso {host}\"\r\n```\r\n\r\n\r\n### Additional information\r\n\r\nI do have 3 Bluetooth proxies active in my house, so I don't know if that's causing any duplication.\r\n\r\n![IMG_1305](https://github.com/user-attachments/assets/34093fee-6276-4a29-9616-7424b5c5c18d)\r\n![IMG_1304](https://github.com/user-attachments/assets/d131acfb-826d-4739-bf42-3f22e7f52dd0)\r\n\n", "hints_text": "\nHey there @zweckj, mind taking a look at this issue as it has been labeled with an integration (`lamarzocco`) you are listed as a [code owner](https://github.com/home-assistant/core/blob/dev/CODEOWNERS#L800) for? Thanks!\n\n<details>\n<summary>Code owner commands</summary>\n\n\nCode owners of `lamarzocco` can trigger bot actions by commenting:\n\n- `@home-assistant close` Closes the issue.\n- `@home-assistant rename Awesome new title` Renames the issue.\n- `@home-assistant reopen` Reopen the issue.\n- `@home-assistant unassign lamarzocco` Removes the current integration label and assignees on the issue, add the integration domain after the command.\n- `@home-assistant add-label needs-more-information` Add a label (needs-more-information, problem in dependency, problem in custom component) to the issue.\n- `@home-assistant remove-label needs-more-information` Remove a label (needs-more-information, problem in dependency, problem in custom component) on the issue.\n\n</details>\n\n\n<sub><sup>(message by CodeOwnersMention)</sup></sub>\n\n---\n\n[lamarzocco documentation](https://www.home-assistant.io/integrations/lamarzocco)\n[lamarzocco source](https://github.com/home-assistant/core/tree/dev/homeassistant/components/lamarzocco)\n<sub><sup>(message by IssueLinks)</sup></sub>\n@rccoleman that string is definitely no longer in strings.json, so maybe that\u2019s cached somewhere. Why it\u2019s discovered at all is interesting. Is the hostname of your machine your serial number?\r\nCan you please turn on debug logs for `homeassistant.components.bluetooth` and `homeassistant.components.dhcp` to see where the discovery is coming from?\nLooks like it's coming from DHCP:\r\n\r\n```\r\n2024-11-28 08:31:08.004 DEBUG (MainThread) [homeassistant.components.dhcp] Processing updated address data for 192.168.1.215: mac=C82B96907B88 hostname=lamarzoccogs3\r\n2024-11-28 08:31:08.004 DEBUG (MainThread) [homeassistant.components.lamarzocco.config_flow] Discovered La Marzocco machine lamarzoccogs3 through DHCP at address 192.168.1.215\r\n```\r\n\r\nThat hostname is coming from pfSense, where I can make it whatever I want when I create a static lease and automatically update my local DNS, so I'm not sure if triggering from a specific name is going to be reliable.  I'm actually curious how it detected it based on what I see in the `manifest.json`:\r\n\r\n```\r\n  \"dhcp\": [\r\n    {\r\n      \"registered_devices\": true\r\n    },\r\n    {\r\n      \"hostname\": \"gs[0-9][0-9][0-9][0-9][0-9][0-9]\"\r\n    },\r\n    {\r\n      \"hostname\": \"lm[0-9][0-9][0-9][0-9][0-9][0-9]\"\r\n    },\r\n    {\r\n      \"hostname\": \"mr[0-9][0-9][0-9][0-9][0-9][0-9]\"\r\n    }\r\n  ],\r\n```\r\n\r\nThe machine has been at that IP address forever.  The config entry looks like this:\r\n```\r\n{\"created_at\":\"1970-01-01T00:00:00+00:00\",\"data\":{\"address\":\"c82b96907b88\",\"host\":\"192.168.1.215\",\"mac\":\"C8:2B:96:90:7B:8A\",\"model\":\"GS3 AV\",\"name\":\"GS3AV_GS013432\",\"password\":\"xxx\",\"token\":\"xxx\",\"username\":\"xxx\"},\"disabled_by\":null,\"discovery_keys\":{\"bluetooth\":[{\"domain\":\"bluetooth\",\"key\":\"C8:2B:96:90:7B:8A\",\"version\":1}],\"dhcp\":[{\"domain\":\"dhcp\",\"key\":\"c82b96907b88\",\"version\":1}]},\"domain\":\"lamarzocco\",\"entry_id\":\"b780300196851a7621455e543cc8aeff\",\"minor_version\":1,\"modified_at\":\"2024-11-27T21:14:56.634204+00:00\",\"options\":{},\"pref_disable_new_entities\":false,\"pref_disable_polling\":false,\"source\":\"user\",\"title\":\"GS013432\",\"unique_id\":\"GS013432\",\"version\":2},\r\n```\r\n\r\nI'm pretty sure it's all due to my custom hostname.  It's not able to pull the serial number from the hostname:\r\n\r\n```\r\n        serial = name.split(\"_\")[1]\r\n        self._discovered[CONF_MACHINE] = serial\r\n\r\n        await self.async_set_unique_id(serial)\r\n        self._abort_if_unique_id_configured()\r\n```\r\n\r\nBTW, I found the key in lokalise: https://app.lokalise.com/project/130246255a974bd3b5e8a1.51616605/?view=multi&filter=custom_8201&search=La%20Marzocco%20Espresso\r\n\r\nI agree that I don't see it being used in `strings.json`, but I cleared my frontend cache, restarted HA, and it's still showing up.  I don't know much about how the translations work, but this is from the browser console:\r\n\r\n<img width=\"508\" alt=\"image\" src=\"https://github.com/user-attachments/assets/c9e73db4-b402-45b0-8cec-ee941105d524\">\r\n\nYes, it's due to the custom hostname, but I don\u2019t understand how it's pulling that in. Or rather how it got pulled in in the first place. Because now it\u2019s a registered device, so it\u2019s triggering again and not matching the unique idea, but the question is, how did it get the (network) address assigned in the first place, when it\u2019s definitely no pattern match?\nI'm also confused about that, but it's consistent from start to start.  Incidentally, it looks like you're expecting a hostname with an underscore in it (like `GS3_GS013432`, I guess), but the DHCP patterns in `manifest.json` don't appear to allow for that.  This is definitely new behavior as of the 2024.12 HA beta.\r\n\r\nEdit: I just remove my DHCP lease and the default hostname looks like `GS013432`.  My guess is that it's matching it based on `registered_devices: true`:\r\n\r\n```\r\n        dev_reg = dr.async_get(self.hass)\r\n        if device := dev_reg.async_get_device(\r\n            connections={(CONNECTION_NETWORK_MAC, formatted_mac)}\r\n        ):\r\n            for entry_id in device.config_entries:\r\n                if (\r\n                    entry := self.hass.config_entries.async_get_entry(entry_id)\r\n                ) and entry.domain in registered_devices_domains:\r\n                    matched_domains.add(entry.domain)\r\n```\r\n\r\nhttps://github.com/home-assistant/core/blob/dev/homeassistant/components/dhcp/__init__.py\r\n\r\n> We support passively listening for DHCP discovery by the hostname and [OUI](https://en.wikipedia.org/wiki/Organizationally_unique_identifier), or matching device registry mac address when registered_devices is set to true\r\n\r\nWhich seems weird, because it's allowing a match if there's already a config entry for a device with that MAC address and the integration domain?\nno, the underscore is for Bluetooth only. For DHCP it is expecting the serial. If it was matched once, it's writing its address to the entry, so it'll match again. So the behaviour would make sense if it matched it and then you changed the hostname. But I don't know how it initially matched the network device to the entry, as the hostname shouldn't have triggered the flow...\r\n\r\nEdit: I have an idea how to fix it, but I'd like to understand it nevertheless....\n> no, the underscore is for Bluetooth only\r\n\r\nOops, yeah, I see that now.  Based on the data in the config_entry, I suspect that it was initially discovered via Bluetooth and is now being re-discovered via DHCP.", "created_at": "2024-11-28T19:54:23Z"}
{"repo": "home-assistant/core", "pull_number": 131860, "instance_id": "home-assistant__core-131860", "issue_numbers": ["131223"], "base_commit": "1a9ab0774215169270c3b7d003b0357c7ea06376", "patch": "diff --git a/homeassistant/components/met_eireann/manifest.json b/homeassistant/components/met_eireann/manifest.json\nindex 72afc6977dd97..7b913df4d3c9a 100644\n--- a/homeassistant/components/met_eireann/manifest.json\n+++ b/homeassistant/components/met_eireann/manifest.json\n@@ -6,5 +6,5 @@\n   \"documentation\": \"https://www.home-assistant.io/integrations/met_eireann\",\n   \"iot_class\": \"cloud_polling\",\n   \"loggers\": [\"meteireann\"],\n-  \"requirements\": [\"PyMetEireann==2021.8.0\"]\n+  \"requirements\": [\"PyMetEireann==2024.11.0\"]\n }\ndiff --git a/requirements_all.txt b/requirements_all.txt\nindex 535a5bbc34b93..a089fbc8b0724 100644\n--- a/requirements_all.txt\n+++ b/requirements_all.txt\n@@ -60,7 +60,7 @@ PyFronius==0.7.3\n PyLoadAPI==1.3.2\n \n # homeassistant.components.met_eireann\n-PyMetEireann==2021.8.0\n+PyMetEireann==2024.11.0\n \n # homeassistant.components.met\n # homeassistant.components.norway_air\n", "test_patch": "diff --git a/requirements_test_all.txt b/requirements_test_all.txt\nindex 077847d260b0e..3a2cfb9d6204c 100644\n--- a/requirements_test_all.txt\n+++ b/requirements_test_all.txt\n@@ -57,7 +57,7 @@ PyFronius==0.7.3\n PyLoadAPI==1.3.2\n \n # homeassistant.components.met_eireann\n-PyMetEireann==2021.8.0\n+PyMetEireann==2024.11.0\n \n # homeassistant.components.met\n # homeassistant.components.norway_air\n", "problem_statement": "Met Eireann weather integration using deprecated URL, which is now broken\n### The problem\n\nAs of this afternoon, the Met Eireann integration fails to pull any data. This is because the URL it's polling times out: `http://metwdb-openaccess.ichec.ie/metno-wdb2ts/locationforecast?lat=<SNIP>;long=<SNIP>;alt=<SNIP>;from=2024-11-21T19:00`\r\n\r\nAccording to [the Irish Government website](https://data.gov.ie/dataset/fa9574c1-48f4-4a98-a22b-d1c23c433821/resource/5d156b15-38b8-4de9-921b-0ffc8704c88e):\r\n\r\n> Announcement: The upgrade of the api will result in termination of the old 'metwdb-openaccess.ichec.ie' URL by 15th September. This is replaced with 'openaccess.pf.api.met.ie'.\r\n> \r\n> URLs of the form:\r\n> `http://metwdb-openaccess.ichec.ie/metno-wdb2ts/locationforecast`\r\n> should be replaced with\r\n>`http://openaccess.pf.api.met.ie/metno-wdb2ts/locationforecast`\r\n> \r\n> Disclaimer This API services and data offering is scheduled for upgrade starting Q1 2024. Every effort will be made to maintain data access during the upgrade period, and services/data will be provided on a best effort basis.\r\n\r\nSeems we may be a little behind with this one! Any chance of a quick fix?\r\n\r\nThanks!\n\n### What version of Home Assistant Core has the issue?\n\ncore-2024.11.2\n\n### What was the last working version of Home Assistant Core?\n\ncore-2024.11.2\n\n### What type of installation are you running?\n\nHome Assistant OS\n\n### Integration causing the issue\n\nMet Eireann\n\n### Link to integration documentation on our website\n\nhttps://www.home-assistant.io/integrations/met_eireann\n\n### Diagnostics information\n\n_No response_\n\n### Example YAML snippet\n\n_No response_\n\n### Anything in the logs that might be useful for us?\n\n```txt\n2024-11-21 21:21:33.696 ERROR (MainThread) [meteireann] http://metwdb-openaccess.ichec.ie/metno-wdb2ts/locationforecast?lat=[SNIP];long=[SNIP];alt=[SNIP];from=2024-11-21T19:00 returned\n```\n\n\n### Additional information\n\n_No response_\n", "hints_text": "\nHey there @dylangore, mind taking a look at this issue as it has been labeled with an integration (`met_eireann`) you are listed as a [code owner](https://github.com/home-assistant/core/blob/dev/CODEOWNERS#L905) for? Thanks!\n\n<details>\n<summary>Code owner commands</summary>\n\n\nCode owners of `met_eireann` can trigger bot actions by commenting:\n\n- `@home-assistant close` Closes the issue.\n- `@home-assistant rename Awesome new title` Renames the issue.\n- `@home-assistant reopen` Reopen the issue.\n- `@home-assistant unassign met_eireann` Removes the current integration label and assignees on the issue, add the integration domain after the command.\n- `@home-assistant add-label needs-more-information` Add a label (needs-more-information, problem in dependency, problem in custom component) to the issue.\n- `@home-assistant remove-label needs-more-information` Remove a label (needs-more-information, problem in dependency, problem in custom component) on the issue.\n\n</details>\n\n\n<sub><sup>(message by CodeOwnersMention)</sup></sub>\n\n---\n\n[met_eireann documentation](https://www.home-assistant.io/integrations/met_eireann)\n[met_eireann source](https://github.com/home-assistant/core/tree/dev/homeassistant/components/met_eireann)\n<sub><sup>(message by IssueLinks)</sup></sub>\nA hack that got the integration running again for me is to override the DNS entry for the old site `metwdb-openaccess.ichec.ie` with the IP address of `openaccess.pf.api.met.ie` (== CNAME az.openaccess.pf.api.met.ie == 137.116.252.12)\r\n\r\nThere are a few ways to do this. I have added this DNS override to my internet router, how to do that is completely router dependent. If your HA instance resolves DNS through pi-hole, then you might be able to add the override in `Local DNS > DNS Records`. It might also be possible to add an override (ie. `137.116.252.12 openaccess.pf.api.met.ie`) in `/etc/hosts` within the `homeassistant` container, though I have not tried this, and this change may be overwritten on each HA restart.\r\n\r\nNote that this hack depends on the web server of the new site not looking at the site name in the request URL. If they fix this to serve only requests to `openaccess.pf.api.met.ie`, then this hack will stop working.\nYou haven't noticed any loss of functionality with this approach? If that's the case, maybe we should just PR the change, I imagine it's a one-liner\nIt got my temperature and humidity back :) I have not tested this extensively in the ~20 mins since I made the change.\r\n\r\nThe PR for the URL change will need to be submitted against https://github.com/DylanGore/PyMetEireann . However, note that the owner has not submitted anything to GitHub since 8-Aug-2023, over a year ago. Only after that package has been updated and re-released can the HA integration be updated to pull the new version of the package.\nI noticed that as well, but the author has been active on LinkedIn, so I remain hopeful! Maybe it'd be worth bugging them there? It does seem like that repo is basically unmaintained.\nPR DylanGore/PyMetEireann#8 submitted\nI've been trying to figure out a way to contact the guy - it looks like he's made himself quite difficult to contact, unfortunately.\r\n\r\n- **Dev.to** - seems abandoned\r\n- **LinkedIn** - wants me to pay an eye-watering 120 euro/month to send messages to people I don't know\r\n- **Twitter** - private account\r\n\r\nHis website does contain an email address, which I'll try contacting shortly and get back to you.\n@crowbarz @gdude2002  \r\n\r\nWill this fix to the DylanGore/PyMetEireann repo be merged automatically into Home Assistant or is a pull request needed?\r\n\r\nThanks for flagging and helping fix the issue. ", "created_at": "2024-11-28T17:19:10Z"}
{"repo": "home-assistant/core", "pull_number": 131856, "instance_id": "home-assistant__core-131856", "issue_numbers": ["131847"], "base_commit": "8b467268df7ddb8bc581babe669cd5a2bf473fad", "patch": "diff --git a/homeassistant/components/history_stats/data.py b/homeassistant/components/history_stats/data.py\nindex 40cf351fd9eb3..f9b79d74cb44c 100644\n--- a/homeassistant/components/history_stats/data.py\n+++ b/homeassistant/components/history_stats/data.py\n@@ -4,6 +4,8 @@\n \n from dataclasses import dataclass\n import datetime\n+import logging\n+import math\n \n from homeassistant.components.recorder import get_instance, history\n from homeassistant.core import Event, EventStateChangedData, HomeAssistant, State\n@@ -14,6 +16,8 @@\n \n MIN_TIME_UTC = datetime.datetime.min.replace(tzinfo=dt_util.UTC)\n \n+_LOGGER = logging.getLogger(__name__)\n+\n \n @dataclass\n class HistoryStatsState:\n@@ -186,8 +190,13 @@ def _async_compute_seconds_and_changes(\n             current_state_matches = history_state.state in self._entity_states\n             state_change_timestamp = history_state.last_changed\n \n-            if state_change_timestamp > now_timestamp:\n+            if math.floor(state_change_timestamp) > now_timestamp:\n                 # Shouldn't count states that are in the future\n+                _LOGGER.debug(\n+                    \"Skipping future timestamp %s (now %s)\",\n+                    state_change_timestamp,\n+                    now_timestamp,\n+                )\n                 continue\n \n             if previous_state_matches:\n", "test_patch": "", "problem_statement": "history_stats sensor with `count` option not updating immediately\n### The problem\n\nProbably introduced by #126271.\r\n\r\nLet's consider the following automation.\r\n\r\n```\r\ntriggers:\r\n  - entity_id: binary_sensor.door\r\n    to: 'on'\r\n    trigger: state\r\nactions:\r\n  - variables:\r\n      door: '{{ states.sensor.door_open_counter.state }}'\r\n```\r\n\r\nwhere `sensor.door_open_counter` is\r\n\r\n```\r\nsensor:\r\n  - platform: history_stats\r\n    name: Door open counter\r\n    entity_id: binary_sensor.door\r\n    state: \"on\"\r\n    type: count\r\n    start: \"{{ today_at() }}\"\r\n    end: \"{{ now() }}\"\r\n```\r\n\r\nThe `door` variable doesn't contain the proper value since the sensor it's now only updating after a few seconds.\r\nWhich it shouldn't, since the trigger is what is actually counting for the status to change.\r\n\r\nE.g. if the value of the sensor was 1 before the trigger, the `door` variable should contain  2, but from the trace of the automation the value is still 1.\r\n\r\n![image](https://github.com/user-attachments/assets/a88bdf57-7f9d-4f7f-b65f-c4d723cdfaa4)\r\n\r\n\n\n### What version of Home Assistant Core has the issue?\n\n2023.12.0b0\n\n### What was the last working version of Home Assistant Core?\n\n2024.11\n\n### What type of installation are you running?\n\nHome Assistant OS\n\n### Integration causing the issue\n\nhistory_stats\n\n### Link to integration documentation on our website\n\nhttps://www.home-assistant.io/integrations/history_stats/\n\n### Diagnostics information\n\n_No response_\n\n### Example YAML snippet\n\n_No response_\n\n### Anything in the logs that might be useful for us?\n\n_No response_\n\n### Additional information\n\n_No response_\n", "hints_text": "[history_stats documentation](https://www.home-assistant.io/integrations/history_stats)\n[history_stats source](https://github.com/home-assistant/core/tree/dev/homeassistant/components/history_stats)", "created_at": "2024-11-28T16:21:47Z"}
{"repo": "home-assistant/core", "pull_number": 131852, "instance_id": "home-assistant__core-131852", "issue_numbers": ["130117"], "base_commit": "f7d2d06c9b267be8d5e7fa12ac049a4813ee9376", "patch": "diff --git a/homeassistant/components/apple_tv/manifest.json b/homeassistant/components/apple_tv/manifest.json\nindex b4e1b3548783c7..b10a14af32b0cb 100644\n--- a/homeassistant/components/apple_tv/manifest.json\n+++ b/homeassistant/components/apple_tv/manifest.json\n@@ -7,7 +7,7 @@\n   \"documentation\": \"https://www.home-assistant.io/integrations/apple_tv\",\n   \"iot_class\": \"local_push\",\n   \"loggers\": [\"pyatv\", \"srptools\"],\n-  \"requirements\": [\"pyatv==0.15.1\"],\n+  \"requirements\": [\"pyatv==0.16.0\"],\n   \"zeroconf\": [\n     \"_mediaremotetv._tcp.local.\",\n     \"_companion-link._tcp.local.\",\ndiff --git a/requirements_all.txt b/requirements_all.txt\nindex 9a4c93ee96e01f..535a5bbc34b936 100644\n--- a/requirements_all.txt\n+++ b/requirements_all.txt\n@@ -1778,7 +1778,7 @@ pyatag==0.3.5.3\n pyatmo==8.1.0\n \n # homeassistant.components.apple_tv\n-pyatv==0.15.1\n+pyatv==0.16.0\n \n # homeassistant.components.aussie_broadband\n pyaussiebb==0.0.15\n", "test_patch": "diff --git a/requirements_test_all.txt b/requirements_test_all.txt\nindex b17bd38a84928d..077847d260b0e5 100644\n--- a/requirements_test_all.txt\n+++ b/requirements_test_all.txt\n@@ -1449,7 +1449,7 @@ pyatag==0.3.5.3\n pyatmo==8.1.0\n \n # homeassistant.components.apple_tv\n-pyatv==0.15.1\n+pyatv==0.16.0\n \n # homeassistant.components.aussie_broadband\n pyaussiebb==0.0.15\n", "problem_statement": "Unexpected exception importing platform homeassistant.components.apple_tv.config_flow\n### The problem\n\nHello \r\n\r\nSince Homeassistant 2024.11.0, I get an error at HA startup and every 10 min regarding AppleTV integration : \r\nError doing job: Task exception was never retrieved (None)\r\nError occurred loading flow for integration apple_tv: Exception importing homeassistant.components.apple_tv.config_flow\r\nUnexpected exception importing platform homeassistant.components.apple_tv.config_flow\n\n### What version of Home Assistant Core has the issue?\n\ncore-2024.11.0\n\n### What was the last working version of Home Assistant Core?\n\ncore-2024.10.4\n\n### What type of installation are you running?\n\nHome Assistant Core\n\n### Integration causing the issue\n\nApple TV\n\n### Link to integration documentation on our website\n\nhttps://www.home-assistant.io/integrations/apple_tv/\n\n### Diagnostics information\n\n_No response_\n\n### Example YAML snippet\n\n_No response_\n\n### Anything in the logs that might be useful for us?\n\n```txt\nUnexpected exception importing platform homeassistant.components.apple_tv.config_flow\r\n\r\nTraceback (most recent call last):\r\n  File \"/srv/homeassistant/lib/python3.12/site-packages/homeassistant/loader.py\", line 1268, in _load_platform\r\n    cache[full_name] = self._import_platform(platform_name)\r\n                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/srv/homeassistant/lib/python3.12/site-packages/homeassistant/loader.py\", line 1300, in _import_platform\r\n    return importlib.import_module(f\"{self.pkg_path}.{platform_name}\")\r\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/srv/homeassistant/lib/python3.12/site-packages/homeassistant/util/loop.py\", line 200, in protected_loop_func\r\n    return func(*args, **kwargs)\r\n           ^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/local/lib/python3.12/importlib/__init__.py\", line 90, in import_module\r\n    return _bootstrap._gcd_import(name[level:], package, level)\r\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"<frozen importlib._bootstrap>\", line 1387, in _gcd_import\r\n  File \"<frozen importlib._bootstrap>\", line 1360, in _find_and_load\r\n  File \"<frozen importlib._bootstrap>\", line 1310, in _find_and_load_unlocked\r\n  File \"<frozen importlib._bootstrap>\", line 488, in _call_with_frames_removed\r\n  File \"<frozen importlib._bootstrap>\", line 1387, in _gcd_import\r\n  File \"<frozen importlib._bootstrap>\", line 1360, in _find_and_load\r\n  File \"<frozen importlib._bootstrap>\", line 1331, in _find_and_load_unlocked\r\n  File \"<frozen importlib._bootstrap>\", line 935, in _load_unlocked\r\n  File \"<frozen importlib._bootstrap_external>\", line 995, in exec_module\r\n  File \"<frozen importlib._bootstrap>\", line 488, in _call_with_frames_removed\r\n  File \"/srv/homeassistant/lib/python3.12/site-packages/homeassistant/components/apple_tv/__init__.py\", line 10, in <module>\r\n    from pyatv import connect, exceptions, scan\r\n  File \"/srv/homeassistant/lib/python3.12/site-packages/pyatv/__init__.py\", line 26, in <module>\r\n    from pyatv.protocols import PROTOCOLS\r\n  File \"/srv/homeassistant/lib/python3.12/site-packages/pyatv/protocols/__init__.py\", line 10, in <module>\r\n    from pyatv.protocols import airplay as airplay_proto\r\n  File \"/srv/homeassistant/lib/python3.12/site-packages/pyatv/protocols/airplay/__init__.py\", line 28, in <module>\r\n    from pyatv.protocols import mrp\r\n  File \"/srv/homeassistant/lib/python3.12/site-packages/pyatv/protocols/mrp/__init__.py\", line 60, in <module>\r\n    from pyatv.protocols.mrp import messages, protobuf\r\n  File \"/srv/homeassistant/lib/python3.12/site-packages/pyatv/protocols/mrp/messages.py\", line 9, in <module>\r\n    from pyatv.protocols.mrp import protobuf\r\n  File \"/srv/homeassistant/lib/python3.12/site-packages/pyatv/protocols/mrp/protobuf/__init__.py\", line 9, in <module>\r\n    from . import AudioFadeMessage_pb2\r\n  File \"/srv/homeassistant/lib/python3.12/site-packages/pyatv/protocols/mrp/protobuf/AudioFadeMessage_pb2.py\", line 15, in <module>\r\n    from pyatv.protocols.mrp.protobuf import PlayerPath_pb2 as pyatv_dot_protocols_dot_mrp_dot_protobuf_dot_PlayerPath__pb2\r\n  File \"/srv/homeassistant/lib/python3.12/site-packages/pyatv/protocols/mrp/protobuf/PlayerPath_pb2.py\", line 14, in <module>\r\n    from pyatv.protocols.mrp.protobuf import Origin_pb2 as pyatv_dot_protocols_dot_mrp_dot_protobuf_dot_Origin__pb2\r\n  File \"/srv/homeassistant/lib/python3.12/site-packages/pyatv/protocols/mrp/protobuf/Origin_pb2.py\", line 14, in <module>\r\n    from pyatv.protocols.mrp.protobuf import DeviceInfoMessage_pb2 as pyatv_dot_protocols_dot_mrp_dot_protobuf_dot_DeviceInfoMessage__pb2\r\n  File \"/srv/homeassistant/lib/python3.12/site-packages/pyatv/protocols/mrp/protobuf/DeviceInfoMessage_pb2.py\", line 24, in <module>\r\n    pyatv_dot_protocols_dot_mrp_dot_protobuf_dot_ProtocolMessage__pb2.ProtocolMessage.RegisterExtension(deviceInfoMessage)\r\n    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\nAttributeError: type object 'ProtocolMessage' has no attribute 'RegisterExtension'\n```\n\n\n### Additional information\n\nDepdencies seem to be good. \r\n$ pip list | grep protobuf\r\nprotobuf                     5.28.3\r\n\r\nWhen running  \r\n$ atvremote wizard command \r\nget same error : \r\nAttributeError: type object 'ProtocolMessage' has no attribute 'RegisterExtension'\r\n\r\nBut if manually update pyatv to 0.16\r\n$ atvremote wizard \r\nI can see my apple TV.\r\n\r\nBut HA automaticly downgrade to 0.15.1\n", "hints_text": "\nHey there @postlund, mind taking a look at this issue as it has been labeled with an integration (`apple_tv`) you are listed as a [code owner](https://github.com/home-assistant/core/blob/dev/CODEOWNERS#L122) for? Thanks!\n\n<details>\n<summary>Code owner commands</summary>\n\n\nCode owners of `apple_tv` can trigger bot actions by commenting:\n\n- `@home-assistant close` Closes the issue.\n- `@home-assistant rename Awesome new title` Renames the issue.\n- `@home-assistant reopen` Reopen the issue.\n- `@home-assistant unassign apple_tv` Removes the current integration label and assignees on the issue, add the integration domain after the command.\n- `@home-assistant add-label needs-more-information` Add a label (needs-more-information, problem in dependency, problem in custom component) to the issue.\n- `@home-assistant remove-label needs-more-information` Remove a label (needs-more-information, problem in dependency, problem in custom component) on the issue.\n\n</details>\n\n\n<sub><sup>(message by CodeOwnersMention)</sup></sub>\n\n---\n\n[apple_tv documentation](https://www.home-assistant.io/integrations/apple_tv)\n[apple_tv source](https://github.com/home-assistant/core/tree/dev/homeassistant/components/apple_tv)\n<sub><sup>(message by IssueLinks)</sup></sub>\nI got the same results sinds Home Assistant 2024.11.x\n@tim427 As workaround I modified /homeassistant/components/apple_tv/manifest.json as follow :\r\n... \r\n\"requirements\": [\"pyatv==0.16.0\"], \r\n...\r\n\r\nRestart Homeassistant \r\n\r\nThis install pyatv 0.16 across homeassistant restart, but it is not clean.\nVerified it works with hass core 2024.11.3. Unfortunately this change is not in yet in 2024.12.0b1.", "created_at": "2024-11-28T15:51:01Z"}
{"repo": "home-assistant/core", "pull_number": 131832, "instance_id": "home-assistant__core-131832", "issue_numbers": ["131823"], "base_commit": "d9832f8c3ac731555e72ef880c294d4932667a48", "patch": "diff --git a/homeassistant/components/esphome/select.py b/homeassistant/components/esphome/select.py\nindex ab7654478a7de..71a21186d3da9 100644\n--- a/homeassistant/components/esphome/select.py\n+++ b/homeassistant/components/esphome/select.py\n@@ -10,6 +10,7 @@\n )\n from homeassistant.components.assist_satellite import AssistSatelliteConfiguration\n from homeassistant.components.select import SelectEntity, SelectEntityDescription\n+from homeassistant.const import EntityCategory\n from homeassistant.core import HomeAssistant, callback\n from homeassistant.helpers import restore_state\n from homeassistant.helpers.entity_platform import AddEntitiesCallback\n@@ -100,7 +101,9 @@ class EsphomeAssistSatelliteWakeWordSelect(\n     \"\"\"Wake word selector for esphome devices.\"\"\"\n \n     entity_description = SelectEntityDescription(\n-        key=\"wake_word\", translation_key=\"wake_word\"\n+        key=\"wake_word\",\n+        translation_key=\"wake_word\",\n+        entity_category=EntityCategory.CONFIG,\n     )\n     _attr_should_poll = False\n     _attr_current_option: str | None = None\n", "test_patch": "", "problem_statement": "The new wake word select should be a configuration entity\n### The problem\n\n![CleanShot 2024-11-28 at 11 31 53](https://github.com/user-attachments/assets/e5403c5e-1418-4ca6-8fb9-60848afb30d1)\r\n\r\nThe new wake word select should be set as a configuration entity, so that it sits next to the pipeline select, as these two entities are supposed to be used together\n\n### What version of Home Assistant Core has the issue?\n\n2024.12.0b0\n\n### What was the last working version of Home Assistant Core?\n\nNot applicable (New feature)\n\n### What type of installation are you running?\n\nHome Assistant OS\n\n### Integration causing the issue\n\nassist_satellite\n\n### Link to integration documentation on our website\n\nhttps://www.home-assistant.io/integrations/assist_satellite/\n\n### Diagnostics information\n\n_No response_\n\n### Example YAML snippet\n\n_No response_\n\n### Anything in the logs that might be useful for us?\n\n_No response_\n\n### Additional information\n\n_No response_\n", "hints_text": "\nHey there @home-assistant/core, @synesthesiam, mind taking a look at this issue as it has been labeled with an integration (`assist_satellite`) you are listed as a [code owner](https://github.com/home-assistant/core/blob/dev/CODEOWNERS#L149) for? Thanks!\n\n<details>\n<summary>Code owner commands</summary>\n\n\nCode owners of `assist_satellite` can trigger bot actions by commenting:\n\n- `@home-assistant close` Closes the issue.\n- `@home-assistant rename Awesome new title` Renames the issue.\n- `@home-assistant reopen` Reopen the issue.\n- `@home-assistant unassign assist_satellite` Removes the current integration label and assignees on the issue, add the integration domain after the command.\n- `@home-assistant add-label needs-more-information` Add a label (needs-more-information, problem in dependency, problem in custom component) to the issue.\n- `@home-assistant remove-label needs-more-information` Remove a label (needs-more-information, problem in dependency, problem in custom component) on the issue.\n\n</details>\n\n\n<sub><sup>(message by CodeOwnersMention)</sup></sub>\n\n---\n\n[assist_satellite documentation](https://www.home-assistant.io/integrations/assist_satellite)\n[assist_satellite source](https://github.com/home-assistant/core/tree/dev/homeassistant/components/assist_satellite)\n<sub><sup>(message by IssueLinks)</sup></sub>", "created_at": "2024-11-28T12:33:16Z"}
{"repo": "home-assistant/core", "pull_number": 131830, "instance_id": "home-assistant__core-131830", "issue_numbers": ["131777"], "base_commit": "f41bc98fe2dad97e3008a6f5d955808900800d90", "patch": "diff --git a/homeassistant/components/buienradar/sensor.py b/homeassistant/components/buienradar/sensor.py\nindex afce293402e05e..712f765237e855 100644\n--- a/homeassistant/components/buienradar/sensor.py\n+++ b/homeassistant/components/buienradar/sensor.py\n@@ -742,6 +742,7 @@ def __init__(\n     ) -> None:\n         \"\"\"Initialize the sensor.\"\"\"\n         self.entity_description = description\n+        self._data: BrData | None = None\n         self._measured = None\n         self._attr_unique_id = (\n             f\"{coordinates[CONF_LATITUDE]:2.6f}{coordinates[CONF_LONGITUDE]:2.6f}\"\n@@ -756,17 +757,29 @@ def __init__(\n         if description.key.startswith(PRECIPITATION_FORECAST):\n             self._timeframe = None\n \n+    async def async_added_to_hass(self) -> None:\n+        \"\"\"Handle entity being added to hass.\"\"\"\n+        if self._data is None:\n+            return\n+        self._update()\n+\n     @callback\n     def data_updated(self, data: BrData):\n-        \"\"\"Update data.\"\"\"\n-        if self._load_data(data.data) and self.hass:\n+        \"\"\"Handle data update.\"\"\"\n+        self._data = data\n+        if not self.hass:\n+            return\n+        self._update()\n+\n+    def _update(self):\n+        \"\"\"Update sensor data.\"\"\"\n+        _LOGGER.debug(\"Updating sensor %s\", self.entity_id)\n+        if self._load_data(self._data.data):\n             self.async_write_ha_state()\n \n     @callback\n     def _load_data(self, data):  # noqa: C901\n         \"\"\"Load the sensor with relevant data.\"\"\"\n-        # Find sensor\n-\n         # Check if we have a new measurement,\n         # otherwise we do not have to update the sensor\n         if self._measured == data.get(MEASURED):\ndiff --git a/homeassistant/components/sensor/__init__.py b/homeassistant/components/sensor/__init__.py\nindex 3c92506a45ecee..42e4288debe1d6 100644\n--- a/homeassistant/components/sensor/__init__.py\n+++ b/homeassistant/components/sensor/__init__.py\n@@ -481,6 +481,11 @@ def _unit_of_measurement_translation_key(self) -> str | None:\n         \"\"\"Return translation key for unit of measurement.\"\"\"\n         if self.translation_key is None:\n             return None\n+        if self.platform is None:\n+            raise ValueError(\n+                f\"Sensor {type(self)} cannot have a translation key for \"\n+                \"unit of measurement before being added to the entity platform\"\n+            )\n         platform = self.platform\n         return (\n             f\"component.{platform.platform_name}.entity.{platform.domain}\"\n", "test_patch": "diff --git a/tests/components/sensor/test_init.py b/tests/components/sensor/test_init.py\nindex 6c2d73cb68c291..1da351da52e1cd 100644\n--- a/tests/components/sensor/test_init.py\n+++ b/tests/components/sensor/test_init.py\n@@ -548,6 +548,45 @@ async def test_translated_unit_with_native_unit_raises(\n         assert entity0.entity_id is None\n \n \n+async def test_unit_translation_key_without_platform_raises(\n+    hass: HomeAssistant,\n+) -> None:\n+    \"\"\"Test that unit translation key property raises if the entity has no platform yet.\"\"\"\n+\n+    with patch(\n+        \"homeassistant.helpers.service.translation.async_get_translations\",\n+        return_value={\n+            \"component.test.entity.sensor.test_translation_key.unit_of_measurement\": \"Tests\"\n+        },\n+    ):\n+        entity0 = MockSensor(\n+            name=\"Test\",\n+            native_value=\"123\",\n+            unique_id=\"very_unique\",\n+        )\n+        entity0.entity_description = SensorEntityDescription(\n+            \"test\",\n+            translation_key=\"test_translation_key\",\n+        )\n+        with pytest.raises(\n+            ValueError,\n+            match=\"cannot have a translation key for unit of measurement before \"\n+            \"being added to the entity platform\",\n+        ):\n+            unit = entity0.unit_of_measurement  # noqa: F841\n+\n+        setup_test_component_platform(hass, sensor.DOMAIN, [entity0])\n+\n+        assert await async_setup_component(\n+            hass, \"sensor\", {\"sensor\": {\"platform\": \"test\"}}\n+        )\n+        await hass.async_block_till_done()\n+\n+        # Should not raise after being added to the platform\n+        unit = entity0.unit_of_measurement  # noqa: F841\n+        assert unit == \"Tests\"\n+\n+\n @pytest.mark.parametrize(\n     (\n         \"device_class\",\n", "problem_statement": "Buienradar in 2024.12.0 : NoneType' object has no attribute 'platform_name'\n### The problem\n\nas logged\n\n### What version of Home Assistant Core has the issue?\n\n2024.12.0b0\n\n### What was the last working version of Home Assistant Core?\n\n_No response_\n\n### What type of installation are you running?\n\nHome Assistant OS\n\n### Integration causing the issue\n\nBuienradar\n\n### Link to integration documentation on our website\n\nhttps://www.home-assistant.io/integrations/buienradar/\n\n### Diagnostics information\n\n_No response_\n\n### Example YAML snippet\n\n_No response_\n\n### Anything in the logs that might be useful for us?\n\n```txt\n2024-11-27 23:15:44.356 ERROR (MainThread) [homeassistant.components.sensor] Error while setting up buienradar platform for sensor\r\nTraceback (most recent call last):\r\n  File \"/usr/src/homeassistant/homeassistant/helpers/entity_platform.py\", line 366, in _async_setup_platform\r\n    await asyncio.shield(awaitable)\r\n  File \"/usr/src/homeassistant/homeassistant/components/buienradar/sensor.py\", line 728, in async_setup_entry\r\n    await data.async_update()\r\n  File \"/usr/src/homeassistant/homeassistant/components/buienradar/util.py\", line 177, in async_update\r\n    await self.update_devices()\r\n  File \"/usr/src/homeassistant/homeassistant/components/buienradar/util.py\", line 78, in update_devices\r\n    dev.data_updated(self)\r\n    ~~~~~~~~~~~~~~~~^^^^^^\r\n  File \"/usr/src/homeassistant/homeassistant/components/buienradar/sensor.py\", line 762, in data_updated\r\n    if self._load_data(data.data) and self.hass:\r\n       ~~~~~~~~~~~~~~~^^^^^^^^^^^\r\n  File \"/usr/src/homeassistant/homeassistant/components/buienradar/sensor.py\", line 857, in _load_data\r\n    if new_state != self.state or img != self.entity_picture:\r\n                    ^^^^^^^^^^\r\n  File \"/usr/src/homeassistant/homeassistant/components/sensor/__init__.py\", line 567, in state\r\n    unit_of_measurement = self.unit_of_measurement\r\n                          ^^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/src/homeassistant/homeassistant/components/sensor/__init__.py\", line 546, in unit_of_measurement\r\n    if (translation_key := self._unit_of_measurement_translation_key) and (\r\n                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"src/propcache/_helpers_c.pyx\", line 88, in propcache._helpers_c.cached_property.__get__\r\n  File \"/usr/src/homeassistant/homeassistant/components/sensor/__init__.py\", line 514, in _unit_of_measurement_translation_key\r\n    f\"component.{platform.platform_name}.entity.{platform.domain}\"\r\n                 ^^^^^^^^^^^^^^^^^^^^^^\r\nAttributeError: 'NoneType' object has no attribute 'platform_name'\n```\n\n\n### Additional information\n\n_No response_\n", "hints_text": "\nHey there @mjj4791, @ties, @robbie1221, mind taking a look at this issue as it has been labeled with an integration (`buienradar`) you are listed as a [code owner](https://github.com/home-assistant/core/blob/dev/CODEOWNERS#L238) for? Thanks!\n\n<details>\n<summary>Code owner commands</summary>\n\n\nCode owners of `buienradar` can trigger bot actions by commenting:\n\n- `@home-assistant close` Closes the issue.\n- `@home-assistant rename Awesome new title` Renames the issue.\n- `@home-assistant reopen` Reopen the issue.\n- `@home-assistant unassign buienradar` Removes the current integration label and assignees on the issue, add the integration domain after the command.\n- `@home-assistant add-label needs-more-information` Add a label (needs-more-information, problem in dependency, problem in custom component) to the issue.\n- `@home-assistant remove-label needs-more-information` Remove a label (needs-more-information, problem in dependency, problem in custom component) on the issue.\n\n</details>\n\n\n<sub><sup>(message by CodeOwnersMention)</sup></sub>\n\n---\n\n[buienradar documentation](https://www.home-assistant.io/integrations/buienradar)\n[buienradar source](https://github.com/home-assistant/core/tree/dev/homeassistant/components/buienradar)\n<sub><sup>(message by IssueLinks)</sup></sub>\nprobably related to PR #131633\r\n", "created_at": "2024-11-28T12:25:38Z"}
{"repo": "home-assistant/core", "pull_number": 131784, "instance_id": "home-assistant__core-131784", "issue_numbers": ["131759"], "base_commit": "17236a56989ff82f6aba9a2231cfc88741709baf", "patch": "diff --git a/homeassistant/components/samsungtv/manifest.json b/homeassistant/components/samsungtv/manifest.json\nindex d25501b356d826..041e9b8fe9b3b1 100644\n--- a/homeassistant/components/samsungtv/manifest.json\n+++ b/homeassistant/components/samsungtv/manifest.json\n@@ -37,7 +37,7 @@\n   \"requirements\": [\n     \"getmac==0.9.4\",\n     \"samsungctl[websocket]==0.7.1\",\n-    \"samsungtvws[async,encrypted]==2.7.0\",\n+    \"samsungtvws[async,encrypted]==2.7.1\",\n     \"wakeonlan==2.1.0\",\n     \"async-upnp-client==0.41.0\"\n   ],\ndiff --git a/requirements_all.txt b/requirements_all.txt\nindex cc6ada55f72c90..279788e8bbf75c 100644\n--- a/requirements_all.txt\n+++ b/requirements_all.txt\n@@ -2610,7 +2610,7 @@ rxv==0.7.0\n samsungctl[websocket]==0.7.1\n \n # homeassistant.components.samsungtv\n-samsungtvws[async,encrypted]==2.7.0\n+samsungtvws[async,encrypted]==2.7.1\n \n # homeassistant.components.sanix\n sanix==1.0.6\n", "test_patch": "diff --git a/requirements_test_all.txt b/requirements_test_all.txt\nindex 452e6143c3425e..956ced46bcdf2c 100644\n--- a/requirements_test_all.txt\n+++ b/requirements_test_all.txt\n@@ -2086,7 +2086,7 @@ rxv==0.7.0\n samsungctl[websocket]==0.7.1\n \n # homeassistant.components.samsungtv\n-samsungtvws[async,encrypted]==2.7.0\n+samsungtvws[async,encrypted]==2.7.1\n \n # homeassistant.components.sanix\n sanix==1.0.6\n", "problem_statement": "AttributeError: 'ClientConnection' Samsung TV\n### The problem\n\nHello,\r\n\r\nUpdating to 2024.12.0b0 and my Samsung TV integration seems to broken with the following log thanks\r\n\r\n```\r\nLogger: homeassistant.components.samsungtv\r\nSource: helpers/update_coordinator.py:379\r\nintegration: Samsung Smart TV (documentation, issues)\r\nFirst occurred: 1:26:47 PM (8 occurrences)\r\nLast logged: 1:32:48 PM\r\n\r\nUnexpected error fetching samsungtv data\r\nTraceback (most recent call last):\r\n  File \"/usr/src/homeassistant/homeassistant/helpers/update_coordinator.py\", line 379, in _async_refresh\r\n    self.data = await self._async_update_data()\r\n                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/src/homeassistant/homeassistant/components/samsungtv/coordinator.py\", line 45, in _async_update_data\r\n    self.is_on = await self.bridge.async_is_on()\r\n                 ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/src/homeassistant/homeassistant/components/samsungtv/bridge.py\", line 509, in async_is_on\r\n    return await super().async_is_on()\r\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/src/homeassistant/homeassistant/components/samsungtv/bridge.py\", line 422, in async_is_on\r\n    return remote.is_alive()\r\n           ~~~~~~~~~~~~~~~^^\r\n  File \"/usr/local/lib/python3.13/site-packages/samsungtvws/async_connection.py\", line 177, in is_alive\r\n    return self.connection is not None and not self.connection.closed\r\n                                               ^^^^^^^^^^^^^^^^^^^^^^\r\nAttributeError: 'ClientConnection' object has no attribute 'closed'. Did you mean: 'close'?\r\n```\n\n### What version of Home Assistant Core has the issue?\n\n2024.12.0b0\n\n### What was the last working version of Home Assistant Core?\n\n2024.11.x\n\n### What type of installation are you running?\n\nHome Assistant OS\n\n### Integration causing the issue\n\nSamsung TV\n\n### Link to integration documentation on our website\n\nhttps://www.home-assistant.io/integrations/samsungtv/\n\n### Diagnostics information\n\n_No response_\n\n### Example YAML snippet\n\n_No response_\n\n### Anything in the logs that might be useful for us?\n\n_No response_\n\n### Additional information\n\n_No response_\n", "hints_text": "\nHey there @chemelli74, @epenet, mind taking a look at this issue as it has been labeled with an integration (`samsungtv`) you are listed as a [code owner](https://github.com/home-assistant/core/blob/dev/CODEOWNERS#L1276) for? Thanks!\n\n<details>\n<summary>Code owner commands</summary>\n\n\nCode owners of `samsungtv` can trigger bot actions by commenting:\n\n- `@home-assistant close` Closes the issue.\n- `@home-assistant rename Awesome new title` Renames the issue.\n- `@home-assistant reopen` Reopen the issue.\n- `@home-assistant unassign samsungtv` Removes the current integration label and assignees on the issue, add the integration domain after the command.\n- `@home-assistant add-label needs-more-information` Add a label (needs-more-information, problem in dependency, problem in custom component) to the issue.\n- `@home-assistant remove-label needs-more-information` Remove a label (needs-more-information, problem in dependency, problem in custom component) on the issue.\n\n</details>\n\n\n<sub><sup>(message by CodeOwnersMention)</sup></sub>\n\n---\n\n[samsungtv documentation](https://www.home-assistant.io/integrations/samsungtv)\n[samsungtv source](https://github.com/home-assistant/core/tree/dev/homeassistant/components/samsungtv)\n<sub><sup>(message by IssueLinks)</sup></sub>\nclosed is only available in the legacy protocol\r\nhttps://github.com/python-websockets/websockets/blob/59d4dcf779fe7d2b0302083b072d8b03adce2f61/src/websockets/legacy/protocol.py#L425\n```\r\n    def is_alive(self) -> bool:\r\n        return self._connection is not None and self._connection.protocol.close_code is None\r\n```\r\n\r\nThat should fix it\nhttps://github.com/xchwarze/samsung-tv-ws-api/blob/8ee4242e3d8b0f873aca5384e75ce39752c773c2/samsungtvws/encrypted/remote.py#L186\nAlso facing this:\r\n\r\n```\r\nLogger: homeassistant.components.samsungtv\r\nSource: helpers/update_coordinator.py:379\r\nintegration: Samsung Smart TV (documentation, issues)\r\nFirst occurred: 10:56:48 (14 occurrences)\r\nLast logged: 11:06:56\r\n\r\nUnexpected error fetching samsungtv data\r\nTraceback (most recent call last):\r\n  File \"/usr/src/homeassistant/homeassistant/helpers/update_coordinator.py\", line 379, in _async_refresh\r\n    self.data = await self._async_update_data()\r\n                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/src/homeassistant/homeassistant/components/samsungtv/coordinator.py\", line 45, in _async_update_data\r\n    self.is_on = await self.bridge.async_is_on()\r\n                 ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/src/homeassistant/homeassistant/components/samsungtv/bridge.py\", line 509, in async_is_on\r\n    return await super().async_is_on()\r\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/src/homeassistant/homeassistant/components/samsungtv/bridge.py\", line 422, in async_is_on\r\n    return remote.is_alive()\r\n           ~~~~~~~~~~~~~~~^^\r\n  File \"/usr/local/lib/python3.13/site-packages/samsungtvws/async_connection.py\", line 177, in is_alive\r\n    return self.connection is not None and not self.connection.closed\r\n                                               ^^^^^^^^^^^^^^^^^^^^^^\r\nAttributeError: 'ClientConnection' object has no attribute 'closed'. Did you mean: 'close'?\r\n```\n> ```\r\n>     def is_alive(self) -> bool:\r\n>         return self._connection is not None and self._connection.protocol.close_code is None\r\n> ```\r\n> \r\n> That should fix it\r\n\r\nThis will not suffice. See the log in OP's post. It is used in `async_connection.py` as well. https://github.com/search?q=repo%3Axchwarze%2Fsamsung-tv-ws-api+.closed&type=code", "created_at": "2024-11-28T07:11:36Z"}
{"repo": "home-assistant/core", "pull_number": 131776, "instance_id": "home-assistant__core-131776", "issue_numbers": ["131766"], "base_commit": "6edb2c0252296996af96a09270d026128ee3731e", "patch": "diff --git a/homeassistant/components/zha/manifest.json b/homeassistant/components/zha/manifest.json\nindex ded37fc4713db9..1fbbd83bb9c005 100644\n--- a/homeassistant/components/zha/manifest.json\n+++ b/homeassistant/components/zha/manifest.json\n@@ -21,7 +21,7 @@\n     \"zha\",\n     \"universal_silabs_flasher\"\n   ],\n-  \"requirements\": [\"universal-silabs-flasher==0.0.25\", \"zha==0.0.40\"],\n+  \"requirements\": [\"universal-silabs-flasher==0.0.25\", \"zha==0.0.41\"],\n   \"usb\": [\n     {\n       \"vid\": \"10C4\",\ndiff --git a/requirements_all.txt b/requirements_all.txt\nindex fcbfdf91a5960a..34891388187aed 100644\n--- a/requirements_all.txt\n+++ b/requirements_all.txt\n@@ -3081,7 +3081,7 @@ zeroconf==0.136.2\n zeversolar==0.3.2\n \n # homeassistant.components.zha\n-zha==0.0.40\n+zha==0.0.41\n \n # homeassistant.components.zhong_hong\n zhong-hong-hvac==1.0.13\n", "test_patch": "diff --git a/requirements_test_all.txt b/requirements_test_all.txt\nindex cbfb6abf5eaf74..48f923e81556cc 100644\n--- a/requirements_test_all.txt\n+++ b/requirements_test_all.txt\n@@ -2464,7 +2464,7 @@ zeroconf==0.136.2\n zeversolar==0.3.2\n \n # homeassistant.components.zha\n-zha==0.0.40\n+zha==0.0.41\n \n # homeassistant.components.zwave_js\n zwave-js-server-python==0.59.1\n", "problem_statement": "ZHA failed setup in 2024.12.0b0 with \"data too short to contain 2 bytes\" error \n### The problem\r\n\r\nWhen updated to `2024.12.0b0` the ZHA integration fails to set up with the following message:\r\n\r\n```\r\nFailed setup, will retry: Data too short to contain 2 bytes.\r\n```\r\n\r\nI use the [Silicon Labs Multiprotocol addon](https://github.com/home-assistant/addons/tree/master/silabs-multiprotocol) with a [Smlight SLZB-07 dongle](https://smlight.tech/manual-slzb-07/) using [this firmware](https://github.com/darkxst/silabs-firmware-builder/blob/main/firmware_builds/slzb-07/rcp-uart-802154-v4.3.1-slzb-07-460800.gbl).\r\n\r\nI've tried restarting the addon and HA without success. Downgrading to `2024.11.3` worked.\r\n\r\nI will try to gather more debug information tomorrow if needed.\r\n\r\n### What version of Home Assistant Core has the issue?\r\n\r\ncore-2024.12.0b0\r\n\r\n### What was the last working version of Home Assistant Core?\r\n\r\ncore-2024.11.3\r\n\r\n### What type of installation are you running?\r\n\r\nHome Assistant OS\r\n\r\n### Integration causing the issue\r\n\r\nzha\r\n\r\n### Link to integration documentation on our website\r\n\r\nhttps://www.home-assistant.io/integrations/zha/\r\n\r\n### Diagnostics information\r\n\r\n_No response_\r\n\r\n### Example YAML snippet\r\n\r\n_No response_\r\n\r\n### Anything in the logs that might be useful for us?\r\n\r\n```txt\r\n2024-11-27 21:51:55.543 DEBUG (MainThread) [zigpy.serial] Opening a serial connection to 'socket://core-silabs-multiprotocol:9999' (baudrate=115200, xonxoff=True, rtscts=False)\r\n2024-11-27 21:51:55.549 DEBUG (MainThread) [zigpy.serial] Connection made: <bellows.ash.AshProtocol object at 0x7f221cd89ff0>\r\n2024-11-27 21:51:56.551 DEBUG (MainThread) [bellows.ezsp] Resetting EZSP\r\n2024-11-27 21:51:56.552 DEBUG (MainThread) [bellows.uart] Resetting ASH\r\n2024-11-27 21:51:56.552 DEBUG (MainThread) [bellows.ash] Sending frame CANCEL + RstFrame() + FLAG\r\n2024-11-27 21:51:56.552 DEBUG (MainThread) [bellows.ash] Sending data  1ac038bc7e\r\n2024-11-27 21:52:00.670 DEBUG (MainThread) [bellows.ash] Received data 1ac1020b\r\n2024-11-27 21:52:00.670 DEBUG (MainThread) [bellows.ash] Received cancel byte, clearing buffer\r\n2024-11-27 21:52:00.670 DEBUG (MainThread) [bellows.ash] Received data 0a527e\r\n2024-11-27 21:52:00.671 DEBUG (MainThread) [bellows.ash] Received frame RStackFrame(version=2, reset_code=<NcpResetCode.RESET_SOFTWARE: 11>)\r\n2024-11-27 21:52:00.671 DEBUG (MainThread) [bellows.ezsp] Switching to EZSP protocol version 4\r\n2024-11-27 21:52:00.671 DEBUG (MainThread) [bellows.ezsp.protocol] Sending command  version: () {'desiredProtocolVersion': 4}\r\n2024-11-27 21:52:00.672 DEBUG (MainThread) [bellows.ash] Sending frame DataFrame(frm_num=0, re_tx=False, ack_num=0, ezsp_frame=b'\\x00\\x00\\x00\\x04') + FLAG\r\n2024-11-27 21:52:00.672 DEBUG (MainThread) [bellows.ash] Sending data  004221a850ed2c7e\r\n2024-11-27 21:52:00.673 DEBUG (MainThread) [bellows.ash] Received data 0142a1a8582805c1ae24\r\n2024-11-27 21:52:00.674 DEBUG (MainThread) [bellows.ash] Received data 7e\r\n2024-11-27 21:52:00.675 DEBUG (MainThread) [bellows.ash] Received frame DataFrame(frm_num=0, re_tx=0, ack_num=1, ezsp_frame=b'\\x00\\x80\\x00\\x0c\\x02\\x10s')\r\n2024-11-27 21:52:00.675 DEBUG (MainThread) [bellows.ash] Sending frame AckFrame(res=0, ncp_ready=0, ack_num=1) + FLAG\r\n2024-11-27 21:52:00.675 DEBUG (MainThread) [bellows.ash] Sending data  8160597e\r\n2024-11-27 21:52:00.675 DEBUG (MainThread) [bellows.ezsp.protocol] Received command version: {'protocolVersion': 12, 'stackType': 2, 'stackVersion': 29456}\r\n2024-11-27 21:52:00.676 DEBUG (MainThread) [bellows.ash] Changing ACK timeout from 1.60 to 1.40\r\n2024-11-27 21:52:00.677 DEBUG (MainThread) [bellows.ezsp] Switching to EZSP protocol version 12\r\n2024-11-27 21:52:00.677 DEBUG (MainThread) [bellows.ezsp.protocol] Sending command  version: () {'desiredProtocolVersion': 12}\r\n2024-11-27 21:52:00.677 DEBUG (MainThread) [bellows.ash] Sending frame DataFrame(frm_num=1, re_tx=False, ack_num=1, ezsp_frame=b'\\x00\\x00\\x01\\x00\\x00\\x0c') + FLAG\r\n2024-11-27 21:52:00.677 DEBUG (MainThread) [bellows.ash] Sending data  7d314221a9542a19cc5b7e\r\n2024-11-27 21:52:00.678 DEBUG (MainThread) [bellows.ash] Received data 1242a1a9542a19b049e709ff\r\n2024-11-27 21:52:00.679 DEBUG (MainThread) [bellows.ash] Received data 7e\r\n2024-11-27 21:52:00.679 DEBUG (MainThread) [bellows.ash] Received frame DataFrame(frm_num=1, re_tx=0, ack_num=2, ezsp_frame=b'\\x00\\x80\\x01\\x00\\x00\\x0c\\x02\\x10s')\r\n2024-11-27 21:52:00.679 DEBUG (MainThread) [bellows.ash] Sending frame AckFrame(res=0, ncp_ready=0, ack_num=2) + FLAG\r\n2024-11-27 21:52:00.679 DEBUG (MainThread) [bellows.ash] Sending data  82503a7e\r\n2024-11-27 21:52:00.680 DEBUG (MainThread) [bellows.ezsp.protocol] Received command version: {'protocolVersion': 12, 'stackType': 2, 'stackVersion': 29456}\r\n2024-11-27 21:52:00.680 DEBUG (MainThread) [bellows.ash] Changing ACK timeout from 1.40 to 1.23\r\n2024-11-27 21:52:00.680 DEBUG (MainThread) [bellows.ezsp] EZSP Stack Type: 2, Stack Version: 7310, Protocol version: 12\r\n2024-11-27 21:52:00.680 DEBUG (MainThread) [bellows.ezsp] Sending XNCP frame: XncpCommand(command_id=<XncpCommandId.GET_SUPPORTED_FEATURES_REQ: 0>, status=<EmberStatus.SUCCESS: 0>, payload=GetSupportedFeaturesReq())\r\n2024-11-27 21:52:00.681 DEBUG (MainThread) [bellows.ezsp.protocol] Sending command  customFrame: (b'\\x00\\x00\\x00',) {}\r\n2024-11-27 21:52:00.681 DEBUG (MainThread) [bellows.ash] Sending frame DataFrame(frm_num=2, re_tx=False, ack_num=2, ezsp_frame=b'\\x01\\x00\\x01G\\x00\\x03\\x00\\x00\\x00') + FLAG\r\n2024-11-27 21:52:00.681 DEBUG (MainThread) [bellows.ash] Sending data  224321a97d332a16b25994e79e7e\r\n2024-11-27 21:52:00.682 DEBUG (MainThread) [bellows.ash] Received data 2343a1a97d332a15b21bbe7e\r\n2024-11-27 21:52:00.682 DEBUG (MainThread) [bellows.ash] Received frame DataFrame(frm_num=2, re_tx=0, ack_num=3, ezsp_frame=b'\\x01\\x80\\x01G\\x00\\x00\\x00')\r\n2024-11-27 21:52:00.682 DEBUG (MainThread) [bellows.ash] Sending frame AckFrame(res=0, ncp_ready=0, ack_num=3) + FLAG\r\n2024-11-27 21:52:00.682 DEBUG (MainThread) [bellows.ash] Sending data  83401b7e\r\n2024-11-27 21:52:00.683 DEBUG (MainThread) [bellows.ezsp.protocol] Received command customFrame: {'status': <EmberStatus.SUCCESS: 0>, 'reply': b''}\r\n2024-11-27 21:52:00.683 DEBUG (MainThread) [bellows.ash] Changing ACK timeout from 1.23 to 1.08\r\n2024-11-27 21:52:00.683 DEBUG (MainThread) [zigpy.serial] Waiting for serial port to close\r\n2024-11-27 21:52:00.684 DEBUG (MainThread) [zigpy.serial] Connection lost: None\r\n2024-11-27 21:52:00.684 DEBUG (MainThread) [bellows.uart] Connection lost: None\r\n2024-11-27 21:52:00.684 DEBUG (MainThread) [zigpy.application] Connection to the radio has been lost: None\r\n2024-11-27 21:52:00.684 DEBUG (MainThread) [zha.application.helpers] stopping global updater\r\n2024-11-27 21:52:00.685 DEBUG (MainThread) [zha.application.helpers] global updater stopped\r\n2024-11-27 21:52:00.685 DEBUG (MainThread) [zha.application.helpers] stopping device availability checker\r\n2024-11-27 21:52:00.685 DEBUG (MainThread) [zha.application.helpers] device availability checker stopped\r\n2024-11-27 21:52:00.685 DEBUG (MainThread) [zha.application.gateway] Shutting down ZHA ControllerApplication\r\n2024-11-27 21:52:00.685 DEBUG (Thread-163) [aiosqlite] executing functools.partial(<function PersistingListener._set_isolation_level.<locals>.<lambda> at 0x7f220088b880>)\r\n2024-11-27 21:52:00.685 DEBUG (Thread-163) [aiosqlite] operation functools.partial(<function PersistingListener._set_isolation_level.<locals>.<lambda> at 0x7f220088b880>) completed\r\n2024-11-27 21:52:00.686 DEBUG (Thread-163) [aiosqlite] executing functools.partial(<built-in method execute of sqlite3.Connection object at 0x7f2213692890>, 'PRAGMA wal_checkpoint;', [])\r\n2024-11-27 21:52:00.687 DEBUG (Thread-163) [aiosqlite] operation functools.partial(<built-in method execute of sqlite3.Connection object at 0x7f2213692890>, 'PRAGMA wal_checkpoint;', []) completed\r\n2024-11-27 21:52:00.688 DEBUG (Thread-163) [aiosqlite] executing functools.partial(<function PersistingListener._set_isolation_level.<locals>.<lambda> at 0x7f2201bff600>)\r\n2024-11-27 21:52:00.689 DEBUG (Thread-163) [aiosqlite] operation functools.partial(<function PersistingListener._set_isolation_level.<locals>.<lambda> at 0x7f2201bff600>) completed\r\n2024-11-27 21:52:00.689 DEBUG (Thread-163) [aiosqlite] executing functools.partial(<built-in method close of sqlite3.Connection object at 0x7f2213692890>)\r\n2024-11-27 21:52:00.699 DEBUG (Thread-163) [aiosqlite] operation functools.partial(<built-in method close of sqlite3.Connection object at 0x7f2213692890>) completed\r\n2024-11-27 21:52:00.803 DEBUG (MainThread) [homeassistant.components.zha] Failed to set up ZHA\r\nTraceback (most recent call last):\r\n  File \"/usr/src/homeassistant/homeassistant/components/zha/__init__.py\", line 151, in async_setup_entry\r\n    await zha_gateway.async_initialize()\r\n  File \"/usr/local/lib/python3.13/site-packages/zha/application/gateway.py\", line 275, in async_initialize\r\n    await self._async_initialize()\r\n  File \"/usr/local/lib/python3.13/site-packages/zha/application/gateway.py\", line 258, in _async_initialize\r\n    await self.application_controller.startup(auto_form=True)\r\n  File \"/usr/local/lib/python3.13/site-packages/zigpy/application.py\", line 220, in startup\r\n    await self.connect()\r\n  File \"/usr/local/lib/python3.13/site-packages/bellows/zigbee/application.py\", line 155, in connect\r\n    await self._ezsp.connect(use_thread=self.config[CONF_USE_THREAD])\r\n  File \"/usr/local/lib/python3.13/site-packages/bellows/ezsp/__init__.py\", line 138, in connect\r\n    await self.startup_reset()\r\n  File \"/usr/local/lib/python3.13/site-packages/bellows/ezsp/__init__.py\", line 130, in startup_reset\r\n    await self.get_xncp_features()\r\n  File \"/usr/local/lib/python3.13/site-packages/bellows/ezsp/__init__.py\", line 184, in get_xncp_features\r\n    self._xncp_features = await self.xncp_get_supported_firmware_features()\r\n                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/local/lib/python3.13/site-packages/bellows/ezsp/__init__.py\", line 672, in xncp_get_supported_firmware_features\r\n    rsp = await self.send_xncp_frame(xncp.GetSupportedFeaturesReq())\r\n          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/local/lib/python3.13/site-packages/bellows/ezsp/__init__.py\", line 662, in send_xncp_frame\r\n    rsp_frame = xncp.XncpCommand.from_bytes(data)\r\n  File \"/usr/local/lib/python3.13/site-packages/bellows/ezsp/xncp.py\", line 68, in from_bytes\r\n    command_id, data = XncpCommandId.deserialize(data)\r\n                       ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^\r\n  File \"/usr/local/lib/python3.13/site-packages/zigpy/types/basic.py\", line 199, in deserialize\r\n    raise ValueError(f\"Data is too short to contain {byte_size} bytes\")\r\nValueError: Data is too short to contain 2 bytes\r\n```\r\n\r\n\r\n### Additional information\r\n\r\n_No response_\n", "hints_text": "\nHey there @dmulcahey, @adminiuga, @puddly, @thejulianjes, mind taking a look at this issue as it has been labeled with an integration (`zha`) you are listed as a [code owner](https://github.com/home-assistant/core/blob/dev/CODEOWNERS#L1738) for? Thanks!\n\n<details>\n<summary>Code owner commands</summary>\n\n\nCode owners of `zha` can trigger bot actions by commenting:\n\n- `@home-assistant close` Closes the issue.\n- `@home-assistant rename Awesome new title` Renames the issue.\n- `@home-assistant reopen` Reopen the issue.\n- `@home-assistant unassign zha` Removes the current integration label and assignees on the issue, add the integration domain after the command.\n- `@home-assistant add-label needs-more-information` Add a label (needs-more-information, problem in dependency, problem in custom component) to the issue.\n- `@home-assistant remove-label needs-more-information` Remove a label (needs-more-information, problem in dependency, problem in custom component) on the issue.\n\n</details>\n\n\n<sub><sup>(message by CodeOwnersMention)</sup></sub>\n\n---\n\n[zha documentation](https://www.home-assistant.io/integrations/zha)\n[zha source](https://github.com/home-assistant/core/tree/dev/homeassistant/components/zha)\n<sub><sup>(message by IssueLinks)</sup></sub>\nAh, the buggy multiprotocol firmware strikes again. I suggest you migrate back to normal Zigbee firmware.\r\n\r\nThis is a bug in a beta and will be fixed but multiprotocol is not really an actively supported configuration right now.\nSo, the suggestion is:\r\n1. Backup network\r\n2. Flash EmberZNet NCP firmware\r\n3. Restore network by configuring the dongle directly in ZHA\r\n4. Ditch Multiprotocol\r\n\r\nI'll do it tomorrow.", "created_at": "2024-11-27T22:35:09Z"}
{"repo": "home-assistant/core", "pull_number": 131773, "instance_id": "home-assistant__core-131773", "issue_numbers": ["131769"], "base_commit": "6edb2c0252296996af96a09270d026128ee3731e", "patch": "diff --git a/homeassistant/components/esphome/manifest.json b/homeassistant/components/esphome/manifest.json\nindex 5524e87e2a80c7..77a3164d94c1c8 100644\n--- a/homeassistant/components/esphome/manifest.json\n+++ b/homeassistant/components/esphome/manifest.json\n@@ -16,7 +16,7 @@\n   \"loggers\": [\"aioesphomeapi\", \"noiseprotocol\", \"bleak_esphome\"],\n   \"mqtt\": [\"esphome/discover/#\"],\n   \"requirements\": [\n-    \"aioesphomeapi==27.0.2\",\n+    \"aioesphomeapi==27.0.3\",\n     \"esphome-dashboard-api==1.2.3\",\n     \"bleak-esphome==1.1.0\"\n   ],\ndiff --git a/requirements_all.txt b/requirements_all.txt\nindex fcbfdf91a5960a..a047d286fa1ab3 100644\n--- a/requirements_all.txt\n+++ b/requirements_all.txt\n@@ -243,7 +243,7 @@ aioelectricitymaps==0.4.0\n aioemonitor==1.0.5\n \n # homeassistant.components.esphome\n-aioesphomeapi==27.0.2\n+aioesphomeapi==27.0.3\n \n # homeassistant.components.flo\n aioflo==2021.11.0\n", "test_patch": "diff --git a/requirements_test_all.txt b/requirements_test_all.txt\nindex cbfb6abf5eaf74..4e69fdcccf3548 100644\n--- a/requirements_test_all.txt\n+++ b/requirements_test_all.txt\n@@ -231,7 +231,7 @@ aioelectricitymaps==0.4.0\n aioemonitor==1.0.5\n \n # homeassistant.components.esphome\n-aioesphomeapi==27.0.2\n+aioesphomeapi==27.0.3\n \n # homeassistant.components.flo\n aioflo==2021.11.0\n", "problem_statement": "Py warnings in logs in 2024.12.0b0\n### The problem\n\n```\r\n2024-11-27 22:07:37.825 WARNING (MainThread) [py.warnings] /usr/local/lib/python3.13/site-packages/noise/backends/default/ciphers.py:10: FutureWarning: functools.partial will be a method descriptor in future Python versions; wrap it in staticmethod() if you want to preserve the old behavior\r\n  return self.cipher.encrypt(nonce=self.format_nonce(n), data=plaintext, associated_data=ad)\r\n2024-11-27 22:07:37.884 WARNING (MainThread) [py.warnings] /usr/local/lib/python3.13/site-packages/noise/backends/default/ciphers.py:13: FutureWarning: functools.partial will be a method descriptor in future Python versions; wrap it in staticmethod() if you want to preserve the old behavior\r\n  return self.cipher.decrypt(nonce=self.format_nonce(n), data=ciphertext, associated_data=ad)\r\n```\n\n### What version of Home Assistant Core has the issue?\n\n2024.12.0b0\n\n### What was the last working version of Home Assistant Core?\n\n_No response_\n\n### What type of installation are you running?\n\nHome Assistant OS\n\n### Integration causing the issue\n\n_No response_\n\n### Link to integration documentation on our website\n\n_No response_\n\n### Diagnostics information\n\n_No response_\n\n### Example YAML snippet\n\n_No response_\n\n### Anything in the logs that might be useful for us?\n\n_No response_\n\n### Additional information\n\n_No response_\n", "hints_text": "\nHey there @ottowinter, @jesserockz, @kbx81, @bdraco, mind taking a look at this issue as it has been labeled with an integration (`esphome`) you are listed as a [code owner](https://github.com/home-assistant/core/blob/dev/CODEOWNERS#L438) for? Thanks!\n\n<details>\n<summary>Code owner commands</summary>\n\n\nCode owners of `esphome` can trigger bot actions by commenting:\n\n- `@home-assistant close` Closes the issue.\n- `@home-assistant rename Awesome new title` Renames the issue.\n- `@home-assistant reopen` Reopen the issue.\n- `@home-assistant unassign esphome` Removes the current integration label and assignees on the issue, add the integration domain after the command.\n- `@home-assistant add-label needs-more-information` Add a label (needs-more-information, problem in dependency, problem in custom component) to the issue.\n- `@home-assistant remove-label needs-more-information` Remove a label (needs-more-information, problem in dependency, problem in custom component) on the issue.\n\n</details>\n\n\n<sub><sup>(message by CodeOwnersMention)</sup></sub>\n\n---\n\n[esphome documentation](https://www.home-assistant.io/integrations/esphome)\n[esphome source](https://github.com/home-assistant/core/tree/dev/homeassistant/components/esphome)\n<sub><sup>(message by IssueLinks)</sup></sub>\nIts likely complaining about https://github.com/esphome/aioesphomeapi/blob/aa40e10f7682d1197df3fa2ab3a2d566d6dcd70e/aioesphomeapi/_frame_helper/noise.py#L41\n27.0.3 publishing now with the fix\r\nhttps://github.com/esphome/aioesphomeapi/actions/runs/12058503424 \r\n", "created_at": "2024-11-27T22:00:51Z"}
{"repo": "home-assistant/core", "pull_number": 131765, "instance_id": "home-assistant__core-131765", "issue_numbers": ["131762"], "base_commit": "1635074aae275b9fb3377e4ffadfd674db3311b5", "patch": "diff --git a/homeassistant/components/lamarzocco/manifest.json b/homeassistant/components/lamarzocco/manifest.json\nindex a71da7c4754418..43b1c7deb477a6 100644\n--- a/homeassistant/components/lamarzocco/manifest.json\n+++ b/homeassistant/components/lamarzocco/manifest.json\n@@ -36,5 +36,5 @@\n   \"integration_type\": \"device\",\n   \"iot_class\": \"cloud_polling\",\n   \"loggers\": [\"pylamarzocco\"],\n-  \"requirements\": [\"pylamarzocco==1.2.11\"]\n+  \"requirements\": [\"pylamarzocco==1.2.12\"]\n }\ndiff --git a/requirements_all.txt b/requirements_all.txt\nindex af34c0e797b250..3acf8392cefc2e 100644\n--- a/requirements_all.txt\n+++ b/requirements_all.txt\n@@ -2027,7 +2027,7 @@ pykwb==0.0.8\n pylacrosse==0.4\n \n # homeassistant.components.lamarzocco\n-pylamarzocco==1.2.11\n+pylamarzocco==1.2.12\n \n # homeassistant.components.lastfm\n pylast==5.1.0\n", "test_patch": "diff --git a/requirements_test_all.txt b/requirements_test_all.txt\nindex 40d43ea825ebbe..b6e6bbcfd5090c 100644\n--- a/requirements_test_all.txt\n+++ b/requirements_test_all.txt\n@@ -1632,7 +1632,7 @@ pykrakenapi==0.1.8\n pykulersky==0.5.2\n \n # homeassistant.components.lamarzocco\n-pylamarzocco==1.2.11\n+pylamarzocco==1.2.12\n \n # homeassistant.components.lastfm\n pylast==5.1.0\n", "problem_statement": "\"extra_headers\" exception at startup of La Marzocco integration\n### The problem\n\nI just updated to 2024.12.0b0 and saw this when the La Marzocco integration started up:\r\n\r\n```\r\n2024-11-27 12:39:04.344 INFO (MainThread) [homeassistant.setup] Setup of domain lamarzocco took 0.00 seconds\r\n2024-11-27 12:39:04.353 ERROR (MainThread) [homeassistant] Error doing job: Task exception was never retrieved (None)\r\nTraceback (most recent call last):\r\n  File \"/usr/local/lib/python3.13/site-packages/pylamarzocco/lm_machine.py\", line 384, in websocket_connect\r\n    await self._local_client.websocket_connect(\r\n        callback=self.on_websocket_message_received\r\n    )\r\n  File \"/usr/local/lib/python3.13/site-packages/pylamarzocco/client_local.py\", line 115, in websocket_connect\r\n    async for websocket in connect(\r\n    ...<24 lines>...\r\n            _LOGGER.warning(\"Exception during websocket connection: %s\", ex)\r\n  File \"/usr/local/lib/python3.13/site-packages/websockets/asyncio/client.py\", line 498, in __aiter__\r\n    async with self as protocol:\r\n               ^^^^\r\n  File \"/usr/local/lib/python3.13/site-packages/websockets/asyncio/client.py\", line 482, in __aenter__\r\n    return await self\r\n           ^^^^^^^^^^\r\n  File \"/usr/local/lib/python3.13/site-packages/websockets/asyncio/client.py\", line 439, in __await_impl__\r\n    self.connection = await self.create_connection()\r\n                      ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/local/lib/python3.13/site-packages/websockets/asyncio/client.py\", line 365, in create_connection\r\n    _, connection = await loop.create_connection(factory, **kwargs)\r\n                          ~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^\r\nTypeError: BaseEventLoop.create_connection() got an unexpected keyword argument 'extra_headers'\r\n```\r\n\r\nIt repeats for me on every HA restart and if I manually reload the integration.  The integration seems to work otherwise.\n\n### What version of Home Assistant Core has the issue?\n\ncore-2024.12.0b0\n\n### What was the last working version of Home Assistant Core?\n\ncore-2024.11.3\n\n### What type of installation are you running?\n\nHome Assistant Container\n\n### Integration causing the issue\n\nLa Marzocco\n\n### Link to integration documentation on our website\n\nhttps://www.home-assistant.io/integrations/lamarzocco/\n\n### Diagnostics information\n\n[config_entry-lamarzocco-b780300196851a7621455e543cc8aeff.json](https://github.com/user-attachments/files/17939901/config_entry-lamarzocco-b780300196851a7621455e543cc8aeff.json)\r\n\n\n### Example YAML snippet\n\n_No response_\n\n### Anything in the logs that might be useful for us?\n\n_No response_\n\n### Additional information\n\n_No response_\n", "hints_text": "\nHey there @zweckj, mind taking a look at this issue as it has been labeled with an integration (`lamarzocco`) you are listed as a [code owner](https://github.com/home-assistant/core/blob/dev/CODEOWNERS#L800) for? Thanks!\n\n<details>\n<summary>Code owner commands</summary>\n\n\nCode owners of `lamarzocco` can trigger bot actions by commenting:\n\n- `@home-assistant close` Closes the issue.\n- `@home-assistant rename Awesome new title` Renames the issue.\n- `@home-assistant reopen` Reopen the issue.\n- `@home-assistant unassign lamarzocco` Removes the current integration label and assignees on the issue, add the integration domain after the command.\n- `@home-assistant add-label needs-more-information` Add a label (needs-more-information, problem in dependency, problem in custom component) to the issue.\n- `@home-assistant remove-label needs-more-information` Remove a label (needs-more-information, problem in dependency, problem in custom component) on the issue.\n\n</details>\n\n\n<sub><sup>(message by CodeOwnersMention)</sup></sub>\n\n---\n\n[lamarzocco documentation](https://www.home-assistant.io/integrations/lamarzocco)\n[lamarzocco source](https://github.com/home-assistant/core/tree/dev/homeassistant/components/lamarzocco)\n<sub><sup>(message by IssueLinks)</sup></sub>", "created_at": "2024-11-27T21:08:26Z"}
{"repo": "home-assistant/core", "pull_number": 131764, "instance_id": "home-assistant__core-131764", "issue_numbers": ["131760"], "base_commit": "1635074aae275b9fb3377e4ffadfd674db3311b5", "patch": "diff --git a/homeassistant/components/unifiprotect/manifest.json b/homeassistant/components/unifiprotect/manifest.json\nindex a8ad956a667865..9a76ba6f984d85 100644\n--- a/homeassistant/components/unifiprotect/manifest.json\n+++ b/homeassistant/components/unifiprotect/manifest.json\n@@ -40,7 +40,7 @@\n   \"integration_type\": \"hub\",\n   \"iot_class\": \"local_push\",\n   \"loggers\": [\"uiprotect\", \"unifi_discovery\"],\n-  \"requirements\": [\"uiprotect==6.6.2\", \"unifi-discovery==1.2.0\"],\n+  \"requirements\": [\"uiprotect==6.6.3\", \"unifi-discovery==1.2.0\"],\n   \"ssdp\": [\n     {\n       \"manufacturer\": \"Ubiquiti Networks\",\ndiff --git a/requirements_all.txt b/requirements_all.txt\nindex 5decd2975fd92a..229bbe97138612 100644\n--- a/requirements_all.txt\n+++ b/requirements_all.txt\n@@ -2897,7 +2897,7 @@ typedmonarchmoney==0.3.1\n uasiren==0.0.1\n \n # homeassistant.components.unifiprotect\n-uiprotect==6.6.2\n+uiprotect==6.6.3\n \n # homeassistant.components.landisgyr_heat_meter\n ultraheat-api==0.5.7\n", "test_patch": "diff --git a/requirements_test_all.txt b/requirements_test_all.txt\nindex 3f824a1f21299a..b8471ed5ea61c4 100644\n--- a/requirements_test_all.txt\n+++ b/requirements_test_all.txt\n@@ -2310,7 +2310,7 @@ typedmonarchmoney==0.3.1\n uasiren==0.0.1\n \n # homeassistant.components.unifiprotect\n-uiprotect==6.6.2\n+uiprotect==6.6.3\n \n # homeassistant.components.landisgyr_heat_meter\n ultraheat-api==0.5.7\n", "problem_statement": "Unifiprotect CookieError: Invalid attribute 'partitioned'\n### The problem\n\nUnifiprotect integration does not start in latest beta 2024.12.0b0\r\n\r\n```\r\nError setting up entry Aurel Popesti for unifiprotect\r\nTraceback (most recent call last):\r\n  File \"/usr/src/homeassistant/homeassistant/config_entries.py\", line 640, in __async_setup_with_context\r\n    result = await component.async_setup_entry(hass, self)\r\n             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/src/homeassistant/homeassistant/components/unifiprotect/__init__.py\", line 75, in async_setup_entry\r\n    await protect.update()\r\n  File \"/usr/local/lib/python3.13/site-packages/uiprotect/api.py\", line 827, in update\r\n    bootstrap = await self.get_bootstrap()\r\n                ^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/local/lib/python3.13/site-packages/uiprotect/api.py\", line 1177, in get_bootstrap\r\n    data = await self.api_request_obj(\"bootstrap\")\r\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/local/lib/python3.13/site-packages/uiprotect/api.py\", line 477, in api_request_obj\r\n    data = await self.api_request(\r\n           ^^^^^^^^^^^^^^^^^^^^^^^\r\n    ...<5 lines>...\r\n    )\r\n    ^\r\n  File \"/usr/local/lib/python3.13/site-packages/uiprotect/api.py\", line 451, in api_request\r\n    data = await self.api_request_raw(\r\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n    ...<5 lines>...\r\n    )\r\n    ^\r\n  File \"/usr/local/lib/python3.13/site-packages/uiprotect/api.py\", line 393, in api_request_raw\r\n    response = await self.request(\r\n               ^^^^^^^^^^^^^^^^^^^\r\n    ...<5 lines>...\r\n    )\r\n    ^\r\n  File \"/usr/local/lib/python3.13/site-packages/uiprotect/api.py\", line 329, in request\r\n    await self.ensure_authenticated()\r\n  File \"/usr/local/lib/python3.13/site-packages/uiprotect/api.py\", line 513, in ensure_authenticated\r\n    await self._load_session()\r\n  File \"/usr/local/lib/python3.13/site-packages/uiprotect/api.py\", line 602, in _load_session\r\n    session_cookie = await self._read_auth_config()\r\n                     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/local/lib/python3.13/site-packages/uiprotect/api.py\", line 635, in _read_auth_config\r\n    cookie[cookie_name][key] = value\r\n    ~~~~~~~~~~~~~~~~~~~^^^^^\r\n  File \"/usr/local/lib/python3.13/http/cookies.py\", line 295, in __setitem__\r\n    raise CookieError(\"Invalid attribute %r\" % (K,))\r\nhttp.cookies.CookieError: Invalid attribute 'partitioned'\r\n```\n\n### What version of Home Assistant Core has the issue?\n\ncore-2024.12.0b0\n\n### What was the last working version of Home Assistant Core?\n\ncore-2024.11.3\n\n### What type of installation are you running?\n\nHome Assistant Core\n\n### Integration causing the issue\n\nUnifi Protect\n\n### Link to integration documentation on our website\n\nhttps://www.home-assistant.io/integrations/unifiprotect/\n\n### Diagnostics information\n\n_No response_\n\n### Example YAML snippet\n\n_No response_\n\n### Anything in the logs that might be useful for us?\n\n_No response_\n\n### Additional information\n\n_No response_\n", "hints_text": "\nHey there @rahehl, mind taking a look at this issue as it has been labeled with an integration (`unifiprotect`) you are listed as a [code owner](https://github.com/home-assistant/core/blob/dev/CODEOWNERS#L1576) for? Thanks!\n\n<details>\n<summary>Code owner commands</summary>\n\n\nCode owners of `unifiprotect` can trigger bot actions by commenting:\n\n- `@home-assistant close` Closes the issue.\n- `@home-assistant rename Awesome new title` Renames the issue.\n- `@home-assistant reopen` Reopen the issue.\n- `@home-assistant unassign unifiprotect` Removes the current integration label and assignees on the issue, add the integration domain after the command.\n- `@home-assistant add-label needs-more-information` Add a label (needs-more-information, problem in dependency, problem in custom component) to the issue.\n- `@home-assistant remove-label needs-more-information` Remove a label (needs-more-information, problem in dependency, problem in custom component) on the issue.\n\n</details>\n\n\n<sub><sup>(message by CodeOwnersMention)</sup></sub>\n\n---\n\n[unifiprotect documentation](https://www.home-assistant.io/integrations/unifiprotect)\n[unifiprotect source](https://github.com/home-assistant/core/tree/dev/homeassistant/components/unifiprotect)\n<sub><sup>(message by IssueLinks)</sup></sub>\nuiprotect doesn't have python 3.13 compat yet\r\nhttps://github.com/uilibs/uiprotect/issues/274", "created_at": "2024-11-27T20:57:16Z"}
{"repo": "home-assistant/core", "pull_number": 131744, "instance_id": "home-assistant__core-131744", "issue_numbers": ["73885"], "base_commit": "e04b6f0cd86c0490ff5a9c74b79b653de9a41a60", "patch": "diff --git a/homeassistant/components/http/__init__.py b/homeassistant/components/http/__init__.py\nindex 3b18b44862a998..95cdee9ab9e46e 100644\n--- a/homeassistant/components/http/__init__.py\n+++ b/homeassistant/components/http/__init__.py\n@@ -326,7 +326,8 @@ def _make_request(\n             protocol,\n             writer,\n             task,\n-            loop=self._loop,\n+            # loop will never be None when called from aiohttp\n+            loop=self._loop,  # type: ignore[arg-type]\n             client_max_size=self._client_max_size,\n         )\n \ndiff --git a/homeassistant/package_constraints.txt b/homeassistant/package_constraints.txt\nindex a4beb141911f6a..0819990cffcd02 100644\n--- a/homeassistant/package_constraints.txt\n+++ b/homeassistant/package_constraints.txt\n@@ -5,7 +5,7 @@ aiodiscover==2.1.0\n aiodns==3.2.0\n aiohasupervisor==0.2.1\n aiohttp-fast-zlib==0.2.0\n-aiohttp==3.11.7\n+aiohttp==3.11.8\n aiohttp_cors==0.7.0\n aiozoneinfo==0.2.1\n astral==2.2\ndiff --git a/pyproject.toml b/pyproject.toml\nindex e281a2429d05da..aa74fa8d77c186 100644\n--- a/pyproject.toml\n+++ b/pyproject.toml\n@@ -29,7 +29,7 @@ dependencies    = [\n     # change behavior based on presence of supervisor. Deprecated with #127228\n     # Lib can be removed with 2025.11\n     \"aiohasupervisor==0.2.1\",\n-    \"aiohttp==3.11.7\",\n+    \"aiohttp==3.11.8\",\n     \"aiohttp_cors==0.7.0\",\n     \"aiohttp-fast-zlib==0.2.0\",\n     \"aiozoneinfo==0.2.1\",\ndiff --git a/requirements.txt b/requirements.txt\nindex 5ca035921078da..28034d80394e0e 100644\n--- a/requirements.txt\n+++ b/requirements.txt\n@@ -5,7 +5,7 @@\n # Home Assistant Core\n aiodns==3.2.0\n aiohasupervisor==0.2.1\n-aiohttp==3.11.7\n+aiohttp==3.11.8\n aiohttp_cors==0.7.0\n aiohttp-fast-zlib==0.2.0\n aiozoneinfo==0.2.1\n", "test_patch": "", "problem_statement": "aiohttp.server message=\"Bad status line 'Invalid method encountered'\"\n### The problem\n\nAfter upgrade to newest 2022.6.7 i see this error at logs\n\n### What version of Home Assistant Core has the issue?\n\n2022.6.7\n\n### What was the last working version of Home Assistant Core?\n\ni dont remember\n\n### What type of installation are you running?\n\nHome Assistant OS\n\n### Integration causing the issue\n\n_No response_\n\n### Link to integration documentation on our website\n\n_No response_\n\n### Diagnostics information\n\n_No response_\n\n### Example YAML snippet\n\n_No response_\n\n### Anything in the logs that might be useful for us?\n\n```txt\nLogger: aiohttp.server\r\nSource: /usr/local/lib/python3.9/site-packages/aiohttp/web_protocol.py:405\r\nFirst occurred: 03:36:42 (3 occurrences)\r\nLast logged: 08:20:30\r\n\r\nError handling request\r\nTraceback (most recent call last):\r\n  File \"/usr/local/lib/python3.9/site-packages/aiohttp/web_protocol.py\", line 334, in data_received\r\n    messages, upgraded, tail = self._request_parser.feed_data(data)\r\n  File \"aiohttp/_http_parser.pyx\", line 551, in aiohttp._http_parser.HttpParser.feed_data\r\naiohttp.http_exceptions.BadStatusLine: 400, message=\"Bad status line 'Invalid method encountered'\"\n```\n\n\n### Additional information\n\n_No response_\n", "hints_text": "I have the same issue after upgrading my containerized HA from 2022.5.2 to 2022.6.7\r\n\r\nError I'm seeing:\r\n``` \r\nFile \"/usr/local/lib/python3.9/site-packages/aiohttp/web_protocol.py\", line 334, in data_received\r\n    messages, upgraded, tail = self._request_parser.feed_data(data)\r\n  File \"aiohttp/_http_parser.pyx\", line 551, in aiohttp._http_parser.HttpParser.feed_data\r\naiohttp.http_exceptions.BadStatusLine: 400, message=\"Bad status line 'Invalid method encountered'\"\r\n```\r\n\r\nThis happens upon startup since the upgrade. Using old container fortunately worked okay\nNot an issue in my case.\r\n\r\nAfter searching on the internet I came to conclusion that one of my devices in LAN is trying to connect to :8123 port using HTTPS.\r\n\r\nI've reviewed all phones and tablets and turned out it was my sons device.\r\n\r\nThis was coincidence that it happened after upgrade.\nHaving the same error and occors 18 times, but not every day:\r\n\r\nLogger: aiohttp.server\r\nSource: /usr/local/lib/python3.10/site-packages/aiohttp/web_protocol.py:405\r\nFirst occurred: 2 augustus 2022 om 16:48:11 (18 occurrences)\r\nLast logged: 05:36:10\r\n\r\nError handling request\r\nTraceback (most recent call last):\r\n  File \"/usr/local/lib/python3.10/site-packages/aiohttp/web_protocol.py\", line 334, in data_received\r\n    messages, upgraded, tail = self._request_parser.feed_data(data)\r\n  File \"aiohttp/_http_parser.pyx\", line 551, in aiohttp._http_parser.HttpParser.feed_data\r\naiohttp.http_exceptions.BadStatusLine: 400, message=\"Bad status line 'Invalid method encountered'\"\r\n\r\nRunning on RPI4 - core-2022.7.3 - Home Assistant OS 8.4\nI see the same error accompanied by another one before it.\r\n\r\n```\r\n2022-08-13 06:41:11.153 ERROR (MainThread) [aiohttp.server] Error handling request\r\nTraceback (most recent call last):\r\nFile \"/usr/local/lib/python3.10/site-packages/aiohttp/web_protocol.py\", line 334, in data_received\r\nmessages, upgraded, tail = self._request_parser.feed_data(data)\r\nFile \"aiohttp/_http_parser.pyx\", line 551, in aiohttp._http_parser.HttpParser.feed_data\r\naiohttp.http_exceptions.BadHttpMessage: 400, message='Pause on PRI/Upgrade'\r\n\r\n2022-08-13 06:45:03.774 ERROR (MainThread) [aiohttp.server] Error handling request\r\nTraceback (most recent call last):\r\nFile \"/usr/local/lib/python3.10/site-packages/aiohttp/web_protocol.py\", line 334, in data_received\r\nmessages, upgraded, tail = self._request_parser.feed_data(data)\r\nFile \"aiohttp/_http_parser.pyx\", line 551, in aiohttp._http_parser.HttpParser.feed_data\r\naiohttp.http_exceptions.BadStatusLine: 400, message=\"Bad status line 'Invalid method encountered'\"\r\n```\r\n\r\nI have changed IP address of my HA instance to test the possibility of the [reason tomhash2 gave](https://github.com/home-assistant/core/issues/73885#issuecomment-1176457301) that some device is trying to connect to HA instance using HTTPS and port 8123. Since I still this these errors, the HTTPS and port 8123 is not the reason in my case.\n> I see the same error accompanied by another one before it.\r\n> \r\n> ```\r\n> 2022-08-13 06:41:11.153 ERROR (MainThread) [aiohttp.server] Error handling request\r\n> Traceback (most recent call last):\r\n> File \"/usr/local/lib/python3.10/site-packages/aiohttp/web_protocol.py\", line 334, in data_received\r\n> messages, upgraded, tail = self._request_parser.feed_data(data)\r\n> File \"aiohttp/_http_parser.pyx\", line 551, in aiohttp._http_parser.HttpParser.feed_data\r\n> aiohttp.http_exceptions.BadHttpMessage: 400, message='Pause on PRI/Upgrade'\r\n> \r\n> 2022-08-13 06:45:03.774 ERROR (MainThread) [aiohttp.server] Error handling request\r\n> Traceback (most recent call last):\r\n> File \"/usr/local/lib/python3.10/site-packages/aiohttp/web_protocol.py\", line 334, in data_received\r\n> messages, upgraded, tail = self._request_parser.feed_data(data)\r\n> File \"aiohttp/_http_parser.pyx\", line 551, in aiohttp._http_parser.HttpParser.feed_data\r\n> aiohttp.http_exceptions.BadStatusLine: 400, message=\"Bad status line 'Invalid method encountered'\"\r\n> ```\r\n> \r\n> I have changed IP address of my HA instance to test the possibility of the [reason tomhash2 gave](https://github.com/home-assistant/core/issues/73885#issuecomment-1176457301) that some device is trying to connect to HA instance using HTTPS and port 8123. Since I still this these errors, the HTTPS and port 8123 is not the reason in my case.\r\n\r\n**UPDATE:**\r\nI did grep for my IP address in the config directory and found one auth token that was using https on my **old** IP address:8123. \r\n\r\n**grep result:**\r\n``` .storage/auth:462:        \"client_id\": \"https://192.168.1.108:8123/\" ```\r\n\r\nI opened config/.storage/auth file, went to this auth entry, found the device ID and searched for that again in the config directory. It was from my Galaxy watch. I have removed the auth token now.\r\n\r\nMight be helpful for people to search for devices using HTTPS for port 8123 to reach HA instance.\r\n\r\nBUT, in my case, I didn't change the IP address on my watch after I changed my HA IP. So, the watch couldn't have pinged my **new** IP with HTTPS and port 8123. So the aiohttp errors I got today morning (posted in the quoted message) are definitely not from my watch pinging 8123 using HTTPS.\r\n\r\nI will report back if I see the errors again.\n> > I see the same error accompanied by another one before it.\r\n> > ```\r\n> > 2022-08-13 06:41:11.153 ERROR (MainThread) [aiohttp.server] Error handling request\r\n> > Traceback (most recent call last):\r\n> > File \"/usr/local/lib/python3.10/site-packages/aiohttp/web_protocol.py\", line 334, in data_received\r\n> > messages, upgraded, tail = self._request_parser.feed_data(data)\r\n> > File \"aiohttp/_http_parser.pyx\", line 551, in aiohttp._http_parser.HttpParser.feed_data\r\n> > aiohttp.http_exceptions.BadHttpMessage: 400, message='Pause on PRI/Upgrade'\r\n> > \r\n> > 2022-08-13 06:45:03.774 ERROR (MainThread) [aiohttp.server] Error handling request\r\n> > Traceback (most recent call last):\r\n> > File \"/usr/local/lib/python3.10/site-packages/aiohttp/web_protocol.py\", line 334, in data_received\r\n> > messages, upgraded, tail = self._request_parser.feed_data(data)\r\n> > File \"aiohttp/_http_parser.pyx\", line 551, in aiohttp._http_parser.HttpParser.feed_data\r\n> > aiohttp.http_exceptions.BadStatusLine: 400, message=\"Bad status line 'Invalid method encountered'\"\r\n> > ```\r\n> > \r\n> > \r\n> >     \r\n> >       \r\n> >     \r\n> > \r\n> >       \r\n> >     \r\n> > \r\n> >     \r\n> >   \r\n> > I have changed IP address of my HA instance to test the possibility of the [reason tomhash2 gave](https://github.com/home-assistant/core/issues/73885#issuecomment-1176457301) that some device is trying to connect to HA instance using HTTPS and port 8123. Since I still this these errors, the HTTPS and port 8123 is not the reason in my case.\r\n> \r\n> **UPDATE:** I did grep for my IP address in the config directory and found one auth token that was using https on my **old** IP address:8123.\r\n> \r\n> **grep result:** `.storage/auth:462: \"client_id\": \"https://192.168.1.108:8123/\"`\r\n> \r\n> I opened config/.storage/auth file, went to this auth entry, found the device ID and searched for that again in the config directory. It was from my Galaxy watch. I have removed the auth token now.\r\n> \r\n> Might be helpful for people to search for devices using HTTPS for port 8123 to reach HA instance.\r\n> \r\n> BUT, in my case, I didn't change the IP address on my watch after I changed my HA IP. So, the watch couldn't have pinged my **new** IP with HTTPS and port 8123. So the aiohttp errors I got today morning (posted in the quoted message) are definitely not from my watch pinging 8123 using HTTPS.\r\n> \r\n> I will report back if I see the errors again.\r\n\r\nSaw the same error messages again. So what I did above didn't solve it.\r\n\r\n```\r\n2022-08-13 23:33:53.827 ERROR (MainThread) [aiohttp.server] Error handling request\r\nTraceback (most recent call last):\r\nFile \"/usr/local/lib/python3.10/site-packages/aiohttp/web_protocol.py\", line 334, in data_received\r\nmessages, upgraded, tail = self._request_parser.feed_data(data)\r\nFile \"aiohttp/_http_parser.pyx\", line 551, in aiohttp._http_parser.HttpParser.feed_data\r\naiohttp.http_exceptions.BadStatusLine: 400, message=\"Bad status line 'Invalid method encountered'\"\r\n2022-08-13 23:33:55.044 ERROR (MainThread) [aiohttp.server] Error handling request\r\nTraceback (most recent call last):\r\nFile \"/usr/local/lib/python3.10/site-packages/aiohttp/web_protocol.py\", line 334, in data_received\r\nmessages, upgraded, tail = self._request_parser.feed_data(data)\r\nFile \"aiohttp/_http_parser.pyx\", line 551, in aiohttp._http_parser.HttpParser.feed_data\r\naiohttp.http_exceptions.BadHttpMessage: 400, message='Pause on PRI/Upgrade'\r\n```\nAny progress on this issue? I\u00b4ve got the error more than once (see above).\r\n\r\n```\r\nLogger: aiohttp.server\r\nSource: /usr/local/lib/python3.10/site-packages/aiohttp/web_protocol.py:405 \r\nFirst occurred: 2:13:21 PM (959 occurrences) \r\nLast logged: 2:14:59 PM\r\n\r\nError handling request\r\nTraceback (most recent call last):\r\n  File \"/usr/local/lib/python3.10/site-packages/aiohttp/web_protocol.py\", line 334, in data_received\r\n    messages, upgraded, tail = self._request_parser.feed_data(data)\r\n  File \"aiohttp/_http_parser.pyx\", line 551, in aiohttp._http_parser.HttpParser.feed_data\r\naiohttp.http_exceptions.BadStatusLine: 400, message=\"Bad status line 'Invalid method encountered'\"\r\n```\r\n\r\nIs there I could do to present more details?\nI'm facing same issue. Please help\r\n\r\n`Nov 15 13:59:07 NUC11PAHi7 homeassistant[6196]: 2022-11-15 13:59:07.202 ERROR (MainThread) [aiohttp.server] Error handling request\r\nNov 15 13:59:07 NUC11PAHi7 homeassistant[6196]: Traceback (most recent call last):\r\nNov 15 13:59:07 NUC11PAHi7 homeassistant[6196]:   File \"/usr/local/lib/python3.10/site-packages/aiohttp/web_protocol.py\", line 334, in data_received\r\nNov 15 13:59:07 NUC11PAHi7 homeassistant[6196]:     messages, upgraded, tail = self._request_parser.feed_data(data)\r\nNov 15 13:59:07 NUC11PAHi7 homeassistant[6196]:   File \"aiohttp/_http_parser.pyx\", line 551, in aiohttp._http_parser.HttpParser.feed_data\r\nNov 15 13:59:07 NUC11PAHi7 homeassistant[6196]: aiohttp.http_exceptions.BadStatusLine: 400, message=\"Bad status line 'Invalid method encountered'\"\r\nNov 15 13:59:07 NUC11PAHi7 homeassistant[6196]: 2022-11-15 13:59:07.699 ERROR (MainThread) [aiohttp.server] Error handling request\r\nNov 15 13:59:07 NUC11PAHi7 homeassistant[6196]: Traceback (most recent call last):\r\nNov 15 13:59:07 NUC11PAHi7 homeassistant[6196]:   File \"/usr/local/lib/python3.10/site-packages/aiohttp/web_protocol.py\", line 334, in data_received\r\nNov 15 13:59:07 NUC11PAHi7 homeassistant[6196]:     messages, upgraded, tail = self._request_parser.feed_data(data)\r\nNov 15 13:59:07 NUC11PAHi7 homeassistant[6196]:   File \"aiohttp/_http_parser.pyx\", line 551, in aiohttp._http_parser.HttpParser.feed_data\r\nNov 15 13:59:07 NUC11PAHi7 homeassistant[6196]: aiohttp.http_exceptions.BadStatusLine: 400, message=\"Bad status line 'Invalid method encountered'\"\r\nNov 15 13:59:07 NUC11PAHi7 homeassistant[6196]: 2022-11-15 13:59:07.732 ERROR (MainThread) [aiohttp.server] Error handling request\r\nNov 15 13:59:07 NUC11PAHi7 homeassistant[6196]: Traceback (most recent call last):\r\nNov 15 13:59:07 NUC11PAHi7 homeassistant[6196]:   File \"/usr/local/lib/python3.10/site-packages/aiohttp/web_protocol.py\", line 334, in data_received\r\nNov 15 13:59:07 NUC11PAHi7 homeassistant[6196]:     messages, upgraded, tail = self._request_parser.feed_data(data)\r\nNov 15 13:59:07 NUC11PAHi7 homeassistant[6196]:   File \"aiohttp/_http_parser.pyx\", line 551, in aiohttp._http_parser.HttpParser.feed_data\r\nNov 15 13:59:07 NUC11PAHi7 homeassistant[6196]: aiohttp.http_exceptions.BadStatusLine: 400, message=\"Bad status line 'Invalid method encountered'\"\r\nNov 15 13:59:07 NUC11PAHi7 homeassistant[6196]: 2022-11-15 13:59:07.766 ERROR (MainThread) [aiohttp.server] Error handling request\r\nNov 15 13:59:07 NUC11PAHi7 homeassistant[6196]: Traceback (most recent call last):\r\nNov 15 13:59:07 NUC11PAHi7 homeassistant[6196]:   File \"/usr/local/lib/python3.10/site-packages/aiohttp/web_protocol.py\", line 334, in data_received\r\nNov 15 13:59:07 NUC11PAHi7 homeassistant[6196]:     messages, upgraded, tail = self._request_parser.feed_data(data)\r\nNov 15 13:59:07 NUC11PAHi7 homeassistant[6196]:   File \"aiohttp/_http_parser.pyx\", line 551, in aiohttp._http_parser.HttpParser.feed_data\r\nNov 15 13:59:07 NUC11PAHi7 homeassistant[6196]: aiohttp.http_exceptions.BadStatusLine: 400, message=\"Bad status line 'Invalid method encountered'\"\r\nNov 15 13:59:07 NUC11PAHi7 homeassistant[6196]: 2022-11-15 13:59:07.795 ERROR (MainThread) [aiohttp.server] Error handling request\r\nNov 15 13:59:07 NUC11PAHi7 homeassistant[6196]: Traceback (most recent call last):\r\nNov 15 13:59:07 NUC11PAHi7 homeassistant[6196]:   File \"/usr/local/lib/python3.10/site-packages/aiohttp/web_protocol.py\", line 334, in data_received\r\nNov 15 13:59:07 NUC11PAHi7 homeassistant[6196]:     messages, upgraded, tail = self._request_parser.feed_data(data)\r\nNov 15 13:59:07 NUC11PAHi7 homeassistant[6196]:   File \"aiohttp/_http_parser.pyx\", line 551, in aiohttp._http_parser.HttpParser.feed_data\r\nNov 15 13:59:07 NUC11PAHi7 homeassistant[6196]: aiohttp.http_exceptions.BadStatusLine: 400, message=\"Bad status line 'Invalid method encountered'\"\r\nNov 15 13:59:07 NUC11PAHi7 homeassistant[6196]: 2022-11-15 13:59:07.826 ERROR (MainThread) [aiohttp.server] Error handling request\r\nNov 15 13:59:07 NUC11PAHi7 homeassistant[6196]: Traceback (most recent call last):\r\nNov 15 13:59:07 NUC11PAHi7 homeassistant[6196]:   File \"/usr/local/lib/python3.10/site-packages/aiohttp/web_protocol.py\", line 334, in data_received\r\nNov 15 13:59:07 NUC11PAHi7 homeassistant[6196]:     messages, upgraded, tail = self._request_parser.feed_data(data)\r\nNov 15 13:59:07 NUC11PAHi7 homeassistant[6196]:   File \"aiohttp/_http_parser.pyx\", line 551, in aiohttp._http_parser.HttpParser.feed_data\r\nNov 15 13:59:07 NUC11PAHi7 homeassistant[6196]: aiohttp.http_exceptions.BadStatusLine: 400, message=\"Bad status line 'Invalid method encountered'\"\r\n`\nSame issue here, any updates on this?\r\n\r\nI have a feeling it relates back to Nginx, which I'm using to reverse-proxy to my HA instance.  I don't have any issues (I don't think) from the app on iOS, but when using Firefox on my laptop it can take ages to load HA through the reverse proxy and I see the same errors others are reporting...\nHi.\r\n\r\nI have similar error in my case after update HA 2022.12.\r\nMy environment: HA Core (docker version).\r\n\r\nThis is the log:\r\n```\r\n2022-12-16 13:08:27.734 ERROR (MainThread) [aiohttp.server] Error handling request\r\nTraceback (most recent call last):\r\n  File \"/usr/local/lib/python3.10/site-packages/aiohttp/web_protocol.py\", line 334, in data_received\r\n    messages, upgraded, tail = self._request_parser.feed_data(data)\r\n  File \"aiohttp/_http_parser.pyx\", line 551, in aiohttp._http_parser.HttpParser.feed_data\r\naiohttp.http_exceptions.BadStatusLine: 400, message=\"Bad status line 'Invalid method encountered'\"\r\n```\r\nIn log have 9 occurrences\r\n\r\nThanks\r\n\r\n\nSame issue here for me!\r\n\r\n\r\n```\r\nLogger: aiohttp.server\r\nSource: /usr/local/lib/python3.10/site-packages/aiohttp/web_protocol.py:405\r\nFirst occurred: 11:43:34 AM (5 occurrences)\r\nLast logged: 11:44:11 AM\r\n\r\nError handling request\r\nTraceback (most recent call last):\r\n  File \"/usr/local/lib/python3.10/site-packages/aiohttp/web_protocol.py\", line 334, in data_received\r\n    messages, upgraded, tail = self._request_parser.feed_data(data)\r\n  File \"aiohttp/_http_parser.pyx\", line 551, in aiohttp._http_parser.HttpParser.feed_data\r\naiohttp.http_exceptions.BadStatusLine: 400, message=\"Bad status line 'Invalid method encountered'\"\r\n```\nSame issue:\r\n\r\nHA 2023.01.1\r\n\r\nLogger: aiohttp.server\r\nSource: /usr/local/lib/python3.10/site-packages/aiohttp/web_protocol.py:405\r\nFirst occurred: 16:42:05 (1 occurrences)\r\nLast logged: 16:42:05\r\nError handling request\r\n\r\nTraceback (most recent call last):\r\n  File \"/usr/local/lib/python3.10/site-packages/aiohttp/web_protocol.py\", line 334, in data_received\r\n    messages, upgraded, tail = self._request_parser.feed_data(data)\r\n  File \"aiohttp/_http_parser.pyx\", line 551, in aiohttp._http_parser.HttpParser.feed_data\r\naiohttp.http_exceptions.BadStatusLine: 400, message=\"Bad status line 'Invalid method encountered'\"\r\n\r\n\nSame here:\r\n2023-01-23 00:14:23.930 ERROR (MainThread) [aiohttp.server] Error handling request\r\nTraceback (most recent call last):\r\n  File \"/usr/local/lib/python3.10/site-packages/aiohttp/web_protocol.py\", line 334, in data_received\r\n    messages, upgraded, tail = self._request_parser.feed_data(data)\r\n  File \"aiohttp/_http_parser.pyx\", line 551, in aiohttp._http_parser.HttpParser.feed_data\r\naiohttp.http_exceptions.BadStatusLine: 400, message=\"Bad status line 'Invalid method encountered'\"\nSimilar here, message is different:\r\nLogger: aiohttp.server\r\nSource: /usr/local/lib/python3.10/site-packages/aiohttp/web_protocol.py:405\r\nFirst occurred: 3:22:08 PM (1 occurrences)\r\nLast logged: 3:22:08 PM\r\nError handling request\r\n\r\nTraceback (most recent call last):\r\n  File \"/usr/local/lib/python3.10/site-packages/aiohttp/web_protocol.py\", line 334, in data_received\r\n    messages, upgraded, tail = self._request_parser.feed_data(data)\r\n  File \"aiohttp/_http_parser.pyx\", line 551, in aiohttp._http_parser.HttpParser.feed_data\r\naiohttp.http_exceptions.BadHttpMessage: 400, message='Pause on PRI/Upgrade'\r\n\r\n\nSame here:\r\n\r\nTraceback (most recent call last):\r\nFile \"/usr/local/lib/python3.10/site-packages/aiohttp/web_protocol.py\", line 332, in data_received\r\nmessages, upgraded, tail = self._request_parser.feed_data(data)\r\nFile \"aiohttp/_http_parser.pyx\", line 551, in aiohttp._http_parser.HttpParser.feed_data\r\naiohttp.http_exceptions.BadStatusLine: 400, message=\"Bad status line 'Invalid method encountered'\"\n#87861 \n```\r\nLogger: aiohttp.server\r\nSource: /usr/local/lib/python3.10/site-packages/aiohttp/web_protocol.py:405\r\nFirst occurred: 12:21:51 (12175 occurrences)\r\nLast logged: 19:25:40\r\n\r\nError handling request\r\nTraceback (most recent call last):\r\n  File \"/usr/local/lib/python3.10/site-packages/aiohttp/web_protocol.py\", line 334, in data_received\r\n    messages, upgraded, tail = self._request_parser.feed_data(data)\r\n  File \"aiohttp/_http_parser.pyx\", line 551, in aiohttp._http_parser.HttpParser.feed_data\r\naiohttp.http_exceptions.BadStatusLine: 400, message=\"Bad status line 'Invalid method encountered'\"\r\n```\nGetting the same issues, and have isolated it down to my iOS home companion app remote accessing the HA instance, via external URL. Accessing the HA instance via internal URL has no issues.\r\n\r\nIn my case, I am accessing it remotely via http (unsecured) via duckdns, and with my router port forwarding 8123 to the HA device.\nIn my case, I am accessing it remotely via https (secured) via duckdns, and with my router port forwarding 8123 to the HA device\nTo add on, I get the same error as long I\u2019m using external URL functionality. Used an internal IP on the external URL section, via wifi.\nDouble-check the URL you're using in your request. Make sure it's correctly formatted and that there are no extra characters or spaces. Ensure the URL scheme (http/https) is correct for the API you're using. I had a similar problem, I specified the port to a URL, but it was not necessary.\nI found out that such errors occur when the https://about.censys.io/ service sends requests like:\r\n**167.94.138.126 [28/Apr/2023:01:49:57 +0000] \"GET / HTTP/1.1\" 404 172 \"-\" \"Mozilla/5.0 (compatible; CensysInspect/1.1; +https://about.censys. io/)\"**\r\nOn their official website, you can see from which ip addresses this happens and block them on the server->>\r\nhttps://support.censys.io/hc/en-us/articles/360043177092-Opt-Out-of-Data-Collection\n> I found out that such errors occur when the https://about.censys.io/ service sends requests like: **167.94.138.126 [28/Apr/2023:01:49:57 +0000] \"GET / HTTP/1.1\" 404 172 \"-\" \"Mozilla/5.0 (compatible; CensysInspect/1.1; +https://about.censys. io/)\"** On their official website, you can see from which ip addresses this happens and block them on the server->> https://support.censys.io/hc/en-us/articles/360043177092-Opt-Out-of-Data-Collection\r\n\r\nBut I don't have censys service !!!\nSame here, using \r\nNGINX Home Assistant SSL proxy 3.5.0\r\n2023.6.1\r\nHome Assistant OS 10.2\r\n\nSame Problem here\nI did a fresh install of HAOS 10.3 with 2023.6 and then immediately installed the Let's Encrypt add-on and issued a wildcard SSL cert. When I restart HA and attempt to access HA via HTTPS it fails, and I see the error in this thread in the log. \nguys, have a same problem\r\nmy HA works in docker\r\nby typing `docker logs homeassistant` i see:\r\n\r\n`2023-06-30 00:41:32.471 ERROR (MainThread) [homeassistant.components.http.forwarded] Received X-Forwarded-For header from an untrusted proxy 172.28.0.1`\r\n\r\nthe ip 172.28.0.1 is my docker network. I just added this net to trusted proxy and it all work fine now.\r\nI also usng https with duckdns. Hope my solution will help you\r\n\r\n### My nginx.conf with reverse proxy on it\r\n\r\nserver {\r\n    server_name homeassistant.bla.bla;\r\n    proxy_ssl_server_name on;\r\n    location / {\r\n      proxy_ssl_name $host;\r\n       proxy_pass               http://localhost:8123; #HA is on 80 port, docker listen 8123\r\n      proxy_set_header          Host                    $host;\r\n      proxy_pass_header         Authorization;  \r\n      proxy_set_header          Upgrade                 $http_upgrade;\r\n      proxy_set_header          Connection              \"upgrade\";        \r\n      proxy_set_header          X-Forwarded-For         $remote_addr;    \r\n    }\r\n    listen 443 ssl; # managed by Certbot\r\n    ssl_certificate /etc/letsencrypt/live/homeassistant.bla.bla/fullchain.pem; # managed by Certbot\r\n    ssl_certificate_key /etc/letsencrypt/live/homeassistant.bla.bla/privkey.pem; # managed by Certbot\r\n    include /etc/letsencrypt/options-ssl-nginx.conf; # managed by Certbot\r\n    ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem; # managed by Certbot\r\n}\r\n\r\nserver {\r\n        if ($host = homeassistant.bla.bla) {\r\n                return 301 http://$host:8123$request_uri;\r\n        } # managed by Certbot\r\n                server_name     homeassistant.bla.bla;\r\n                listen          80;\r\n        return 404; # managed by Certbot\r\n} \r\n\r\n \r\n\nThis may be related to this issue: https://github.com/aio-libs/aiohttp/issues/7208\r\n\r\nBasically, if the request does not set content-length, aiohttp server returns 400 with `Invalid method encountered`.\nIt happens to me right now when calling Google Translate TTS.\r\n\r\n`Traceback (most recent call last):\r\n  File \"/usr/local/lib/python3.11/site-packages/aiohttp/web_protocol.py\", line 332, in data_received\r\n    messages, upgraded, tail = self._request_parser.feed_data(data)\r\n                               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"aiohttp/_http_parser.pyx\", line 557, in aiohttp._http_parser.HttpParser.feed_data\r\naiohttp.http_exceptions.BadStatusLine: 400, message:\r\n  Bad status line \"Invalid method encountered:\\n\\n  b'\\\\x16\\\\x03\\\\x01\\\\x02'\\n    ^\"`\nSame issue on my side:\r\n`2023-10-08 17:02:25.552 ERROR (MainThread) [aiohttp.server] Error handling request\r\nTraceback (most recent call last):\r\n  File \"/usr/local/lib/python3.11/site-packages/aiohttp/web_protocol.py\", line 332, in data_received\r\n    messages, upgraded, tail = self._request_parser.feed_data(data)\r\n                               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"aiohttp/_http_parser.pyx\", line 557, in aiohttp._http_parser.HttpParser.feed_data\r\naiohttp.http_exceptions.BadStatusLine: 400, message:\r\n  Bad status line \"Invalid method encountered:\\n\\n  b'\\\\x16\\\\x03\\\\x01\\\\x02'\\n    ^\"`\n same error in log here, but I didn't do anything with HA at the time it appeared. I think I have seen the same message a few times last days, but not sure it's exactly the same.\r\n\r\n Logger: aiohttp.server\r\nSource: /usr/local/lib/python3.11/site-packages/aiohttp/web_protocol.py:403\r\nFirst occurred: 19:15:37 (1 occurrences)\r\nLast logged: 19:15:37\r\n\r\nError handling request\r\nTraceback (most recent call last):\r\n  File \"/usr/local/lib/python3.11/site-packages/aiohttp/web_protocol.py\", line 332, in data_received\r\n    messages, upgraded, tail = self._request_parser.feed_data(data)\r\n                               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"aiohttp/_http_parser.pyx\", line 557, in aiohttp._http_parser.HttpParser.feed_data\r\naiohttp.http_exceptions.BadHttpMessage: 400, message:\r\n  Pause on PRI/Upgrade:\r\n\r\n    b''\r\n      ^\r\n\nAdd me to the list too... Same error.  Been working on it for weeks.  Nothing fixes it. \nSame error here.\nJust a small note. Now that I use https with a valid let's encrypt certificate for my domain, the error has not occurred for 5 hours. \r\nI also found this hind but wasen't able to test it. Maybe someone else can do so?\r\nhttps://serverfault.com/questions/195622/what-is-this-in-error-log-invalid-method-in-request-x16-x03-x01\nI have used https with let's encrypt cetificate since my on boarding days almost a year ago and I have this error almost daily\nSame error here, everyday.... Any ideas how to fix it ? I use duckdns.\r\n\r\n```\r\nLogger: aiohttp.server\r\nSource: /usr/local/lib/python3.11/site-packages/aiohttp/web_protocol.py:403\r\nFirst occurred: 10.45.41 (1 occurrences)\r\nLast logged: 10.45.41\r\n\r\nError handling request\r\nTraceback (most recent call last):\r\n  File \"/usr/local/lib/python3.11/site-packages/aiohttp/web_protocol.py\", line 332, in data_received\r\n    messages, upgraded, tail = self._request_parser.feed_data(data)\r\n                               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"aiohttp/_http_parser.pyx\", line 557, in aiohttp._http_parser.HttpParser.feed_data\r\naiohttp.http_exceptions.BadStatusLine: 400, message:\r\n  Bad status line \"Invalid method encountered:\\n\\n  b''\\n    ^\"\r\n```\n```\r\nTraceback (most recent call last):\r\n  File \"/usr/local/lib/python3.11/site-packages/aiohttp/web_protocol.py\", line 332, in data_received\r\n    messages, upgraded, tail = self._request_parser.feed_data(data)\r\n                               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"aiohttp/_http_parser.pyx\", line 557, in aiohttp._http_parser.HttpParser.feed_data\r\naiohttp.http_exceptions.BadStatusLine: 400, message:\r\n  Bad status line \"Invalid method encountered:\\n\\n  b'\\\\x16\\\\x03\\\\x01\\\\x02\\\\x8a\\\\x01'\\n    ^\"\r\n```\r\n\r\nI have shortly tried Nginx/DuckDNS but have disabled the add-ons now.\nAlso experiencing the same issue. \nSame issue here, just bought the wifi dongle for my heatpump, tried to set it up in HA but experienced this error upon logging in to MelCloud.\nLogger: aiohttp.server\r\nSource: /usr/local/lib/python3.11/site-packages/aiohttp/web_protocol.py:403\r\nFirst occurred: November 5, 2023 at 20:41:40 (9 occurrences)\r\nLast logged: 17:53:40\r\n\r\nError handling request\r\nTraceback (most recent call last):\r\n  File \"/usr/local/lib/python3.11/site-packages/aiohttp/web_protocol.py\", line 332, in data_received\r\n    messages, upgraded, tail = self._request_parser.feed_data(data)\r\n                               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"aiohttp/_http_parser.pyx\", line 557, in aiohttp._http_parser.HttpParser.feed_data\r\naiohttp.http_exceptions.BadStatusLine: 400, message:\r\n  Bad status line 'Invalid method encountered:\\n\\n  b\\'{\"id\": 1, \"method\": \"mining.subscribe\", \"params\": [\"cpuminer/2.5.1\"]}\\'\\n    ^'\n> Same issue here, just bought the wifi dongle for my heatpump, tried to set it up in HA but experienced this error upon logging in to MelCloud.\r\n\r\nI think it is a malformed Webhook somewhere.  When I turned off all of the \"auto\" webhooks in MotionEye the number of errors went from Dozens and Dozens to one or two per day.  Very weird, rare and odd error.  \r\n\r\nIt would be nice if the error message was a little more descriptive. \nAny chance to track it down? Are there any log levels we could raise to get more insights?\nsame problem :(\nOne thing that is really odd with this error... When I either SSH in or use the terminal and start to navigate the directory tree...\r\nthe file  usr/local/lib/python3.11/site-packages/aiohttp/web_protocol.py  does not exist.  In fact I don't seem to have a python3.11 directory.    \nFollowing, same error here. Looking for a solution.\nhello, everyone,i found to use aiohttp=3.8.5 no error, you can try it.\r\n![image](https://github.com/home-assistant/core/assets/8349271/a8966e13-fa5c-4597-bc49-06016022e18a)\r\n\n> hello, everyone,i found to use aiohttp=3.8.5 no error, you can try it.\r\n\r\nIs there a link/documentation on how to install 3.8.5? \nRunning my HA in docker container on synology NAS, exposed using reverse proxy (nginx) an issue started appearing today after isp maintenance. I have the aiohttp=3.8.5 \r\n<img width=\"280\" alt=\"image\" src=\"https://github.com/home-assistant/core/assets/5645568/bb778f21-5a25-4f82-9a34-28e116519d62\">\r\n```Logger: aiohttp.server\r\nSource: /usr/local/lib/python3.11/site-packages/aiohttp/web_protocol.py:403\r\nFirst occurred: 20:45:55 (28 occurrences)\r\nLast logged: 20:46:01\r\n\r\nError handling request\r\nTraceback (most recent call last):\r\n  File \"/usr/local/lib/python3.11/site-packages/aiohttp/web_protocol.py\", line 332, in data_received\r\n    messages, upgraded, tail = self._request_parser.feed_data(data)\r\n                               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"aiohttp/_http_parser.pyx\", line 557, in aiohttp._http_parser.HttpParser.feed_data\r\naiohttp.http_exceptions.BadStatusLine: 400, message:\r\n  Bad status line \"Invalid method encountered:\\n\\n  b'\\\\x16\\\\x03\\\\x01\\\\x02/\\\\x01'\\n    ^\"\r\n  ```\nExactly same error for me ^\nStill active issue.\n> With regards to the first error, it's possible that your webserver is mistakenly trying to speak unencrypted HTTP to a request that came in on port 443 (HTTPS). \r\n\r\n[Source](https://serverfault.com/a/195630)\r\n\r\nIf you have a Home Assistant instance that doesn't integrate the SSL certificate in the main configuration and you (or an integration, plugin, etc.) are trying to access the encrypted version of the API / dashboard, this error is going to appear.\r\n\r\nCheck the [http configuration](https://www.home-assistant.io/integrations/http/#configuration-variables).\r\n\r\n```\r\nhttp:\r\n  server_port: 8123\r\n  ssl_certificate: /etc/letsencrypt/live/YOUR_DDNS_URL.com/fullchain.pem\r\n  ssl_key: /etc/letsencrypt/live/YOUR_DDNS_URL.com/privkey.pem\r\n  cors_allowed_origins:\r\n    - https://google.com\r\n    - https://www.home-assistant.io\r\n    - https://cast.home-assistant.io\r\n    - cast.home-assistant.io\r\n    - https://YOUR_DDNS_URL.com:8123\r\n```\r\n\r\nI use Home Assistant like this without trouble, over TLS / SSL.\r\n \r\n\n> cors_allowed_origins:\r\n>     - https://google.com\r\n\r\nA couple of questions \r\n\r\n\r\nThe DDNS_URL is my DuckDNS domain, right?  and \r\n\r\nWhy am I allowing google?\r\n\r\n*EDIT*\r\n\r\nThis did not solve the error for me... Still getting the error\n> 1, \"method\": \"mining.subscribe\", \"params\": [\"cpuminer/2.5.1\"]}'\\n ^'\r\n\r\nI got this exact same log in my home assistant aswell. My home assistant frontend crashes very often now. Anyone know what this is? Is there a miner on my device or are there just someone trying to make sim random api call to my server where this line is included?\nI had this issue. It happened because HA was working in HTTP mode and the proxy tried to access it in HTTPS mode. A proper HA configuration to work in HTTPS mode solved this issue.\nAny link/tip on how you converted HA into HTTPS mode?\r\nMy HA instance only accepts HTTPS access and I get this error a few times a day, \r\n\n@ur7x you are not running HA through a proxy, like Nginx, Apache, correct?\r\nOtherwise, [this](https://github.com/home-assistant/core/issues/73885#issuecomment-1864195102) should be enough.\r\n\r\nMaybe there's still an integration with still uses unsecure connection to a server?\nExactly. If some person, device, service or scanner accidentally or intentionally tries to access your HA with a different HTTP(S) protocol than expected, you will get this kind of error in log anyway. \n> @ur7x you are not running HA through a proxy, like Nginx, Apache, correct? Otherwise, [this](https://github.com/home-assistant/core/issues/73885#issuecomment-1864195102) should be enough.\r\n> \r\n> Maybe there's still an integration with still uses unsecure connection to a server?\r\n\r\nI use DuckDNS to get a certficate and external domain. But no proxy.\r\n\r\nI tried your config change and it made no change to my errors. \nDon't know much about DuckDNS integration, but it might act like a reverse proxy. Try with other DNS provider with standalone tools for updating the IP, like NO-IP and get a certificate with certbot.\r\nI have DNS configured to be updated by the router, and another one by the IPS.\n@ur7x you can stay on DuckDDNS and just test your HA with wget or curl using different HTTP(S) method to trigger this error and confirm that it happens because of this... \n> @ur7x you can stay on DuckDDNS and just test your HA with wget or curl using different HTTP(S) method to trigger this error and confirm that it happens because of this...\r\n\r\nand how to do this? you can help? thanks\n> @ur7x you can stay on DuckDDNS and just test your HA with wget or curl using different HTTP(S) method to trigger this error and confirm that it happens because of this...\r\n\r\nThanks I tried that... \r\nI installed wget on my PC and tried to use it to down load a known backup file from the backup directory.. first using my internal HTTPS address (https://192.168.X.Y:8123) .  wget failed with a certificate error...\r\n\r\nThen it tried with the same address, just http this time.\r\nwget managed to connect but HA refused access to the file..\r\n\r\nThen I tried http with my duckdns domain name...\r\nwget connected and succeeded.\r\n\r\nThen I tried https with my duckdns domain name..\r\nwget connected and failed to find the file.?! (404 error) \r\n\r\nall surprising results.\r\n\r\nEven more surprising NONE of the four wget commands triggered the aiohttp error. \r\n\r\n\r\n\nCertificate error is correct as the certificate is issued by domain name, so you can't use it for LAN connection without ignoring some security policies. \n> Certificate error is correct as the certificate is issued by domain name, so you can't use it for LAN connection without ignoring some security policies.\r\n\r\nUnderstood.  But that test also produced ZERO aiohttp errors... so something else is causing them .\nYou can ignore SSL errors with wget https://redfern.me/skipping-certificate-checks-with-wget/\nThere hasn't been any activity on this issue recently. Due to the high number of incoming GitHub notifications, we have to clean some of the old issues, as many of them have already been resolved with the latest updates.\nPlease make sure to update to the latest Home Assistant version and check if that solves the issue. Let us know if that works for you by adding a comment \ud83d\udc4d\nThis issue has now been marked as stale and will be closed if no further activity occurs. Thank you for your contributions.\nThe topic is still present. In my case I have meanwhile the feeling that it comes from IOS mobile app.\r\nSometime you can find behind \"Invalid method encountered:\" something which looks similar to an IP-Address. The same IP-Address can be found in the auth-file in \".storage\" which guides me to the mentioned assumption. In other cases the info behind \"Invalid method encountered:\" is a little bit strange: b'\\x16\\x03\\x01'\r\n\r\nI get this type of message 1-2 times a day.\nme too\n**There should be an option to disable SSL verification when establishing connections to the server**. I am using it through Wireguard, which ensures that all my data remains encrypted, even when transmitted over HTTP. \r\n\r\nIt would be beneficial to include an advanced configuration setting that allows experienced users to override security settings. \r\n\r\nSince I operate a k8s cluster where certificates are generated automatically, it's impractical to update the container configuration files with a new certificate each time one is generated.\nThere hasn't been any activity on this issue recently. Due to the high number of incoming GitHub notifications, we have to clean some of the old issues, as many of them have already been resolved with the latest updates.\nPlease make sure to update to the latest Home Assistant version and check if that solves the issue. Let us know if that works for you by adding a comment \ud83d\udc4d\nThis issue has now been marked as stale and will be closed if no further activity occurs. Thank you for your contributions.\nTopic shall not be closed as it is still present.\r\nAt least an information would be helpfull, how to debug \"who the guilty guy is\", which leads to that bad status line.\nnot stale", "created_at": "2024-11-27T17:44:01Z"}
{"repo": "home-assistant/core", "pull_number": 131724, "instance_id": "home-assistant__core-131724", "issue_numbers": ["131003"], "base_commit": "d6f4a79b468d06e1c2d41ffd8561f4f2dabfea2b", "patch": "diff --git a/homeassistant/components/unifiprotect/data.py b/homeassistant/components/unifiprotect/data.py\nindex 4ad8892ca01992..baecc7f8323ac5 100644\n--- a/homeassistant/components/unifiprotect/data.py\n+++ b/homeassistant/components/unifiprotect/data.py\n@@ -349,6 +349,7 @@ def async_ufp_instance_for_config_entry_ids(\n             entry.runtime_data.api\n             for entry_id in config_entry_ids\n             if (entry := hass.config_entries.async_get_entry(entry_id))\n+            and entry.domain == DOMAIN\n             and hasattr(entry, \"runtime_data\")\n         ),\n         None,\n", "test_patch": "diff --git a/tests/components/unifiprotect/test_init.py b/tests/components/unifiprotect/test_init.py\nindex 46e57c62101ee7..457fd9d3b975b9 100644\n--- a/tests/components/unifiprotect/test_init.py\n+++ b/tests/components/unifiprotect/test_init.py\n@@ -2,8 +2,9 @@\n \n from __future__ import annotations\n \n-from unittest.mock import AsyncMock, patch\n+from unittest.mock import AsyncMock, Mock, patch\n \n+import pytest\n from uiprotect import NotAuthorized, NvrError, ProtectApiClient\n from uiprotect.api import DEVICE_UPDATE_INTERVAL\n from uiprotect.data import NVR, Bootstrap, CloudAccount, Light\n@@ -13,6 +14,9 @@\n     CONF_DISABLE_RTSP,\n     DOMAIN,\n )\n+from homeassistant.components.unifiprotect.data import (\n+    async_ufp_instance_for_config_entry_ids,\n+)\n from homeassistant.config_entries import ConfigEntry, ConfigEntryState\n from homeassistant.core import HomeAssistant\n from homeassistant.helpers import device_registry as dr, entity_registry as er\n@@ -286,3 +290,63 @@ async def test_device_remove_devices_nvr(\n     client = await hass_ws_client(hass)\n     response = await client.remove_device(live_device_entry.id, entry_id)\n     assert not response[\"success\"]\n+\n+\n+@pytest.mark.parametrize(\n+    (\"mock_entries\", \"expected_result\"),\n+    [\n+        pytest.param(\n+            [\n+                Mock(\n+                    spec=ConfigEntry,\n+                    domain=DOMAIN,\n+                    runtime_data=Mock(api=\"mock_api_instance_1\"),\n+                ),\n+                Mock(\n+                    spec=ConfigEntry,\n+                    domain=\"other_domain\",\n+                    runtime_data=Mock(api=\"mock_api_instance_2\"),\n+                ),\n+            ],\n+            \"mock_api_instance_1\",\n+            id=\"one_matching_domain\",\n+        ),\n+        pytest.param(\n+            [\n+                Mock(\n+                    spec=ConfigEntry,\n+                    domain=\"other_domain\",\n+                    runtime_data=Mock(api=\"mock_api_instance_1\"),\n+                ),\n+                Mock(\n+                    spec=ConfigEntry,\n+                    domain=\"other_domain\",\n+                    runtime_data=Mock(api=\"mock_api_instance_2\"),\n+                ),\n+            ],\n+            None,\n+            id=\"no_matching_domain\",\n+        ),\n+    ],\n+)\n+async def test_async_ufp_instance_for_config_entry_ids(\n+    mock_entries, expected_result\n+) -> None:\n+    \"\"\"Test async_ufp_instance_for_config_entry_ids with various entry configurations.\"\"\"\n+\n+    hass = Mock(spec=HomeAssistant)\n+\n+    mock_entry_mapping = {\n+        str(index): entry for index, entry in enumerate(mock_entries, start=1)\n+    }\n+\n+    def mock_async_get_entry(entry_id):\n+        return mock_entry_mapping.get(entry_id)\n+\n+    hass.config_entries.async_get_entry = Mock(side_effect=mock_async_get_entry)\n+\n+    entry_ids = set(mock_entry_mapping.keys())\n+\n+    result = async_ufp_instance_for_config_entry_ids(hass, entry_ids)\n+\n+    assert result == expected_result\n", "problem_statement": "Unifi Protect - Cant Add Doorbell Text\n### The problem\n\nI was trying out a new automation that sets the doorbell text and it does not work - the UI says \"Error running action - unknown error\".\n\n### What version of Home Assistant Core has the issue?\n\n2024.11.2\n\n### What was the last working version of Home Assistant Core?\n\n_No response_\n\n### What type of installation are you running?\n\nHome Assistant Container\n\n### Integration causing the issue\n\nUnifi Protect \n\n### Link to integration documentation on our website\n\nhttps://www.home-assistant.io/integrations/unifiprotect\n\n### Diagnostics information\n\n[protect-error.txt](https://github.com/user-attachments/files/17823360/protect-error.txt)\r\n\n\n### Example YAML snippet\n\n```yaml\naction: unifiprotect.add_doorbell_text\r\nmetadata: {}\r\ndata:\r\n  device_id: <redacted>\r\n  message: <redacted>\n```\n\n\n### Anything in the logs that might be useful for us?\n\n```txt\nUnifi OS: v4.0.21\r\nUnifi Protect: 5.0.51\r\nDevice: G4 Doorbell Pro\n```\n\n\n### Additional information\n\n_No response_\n", "hints_text": "[unifiprotect documentation](https://www.home-assistant.io/integrations/unifiprotect)\n[unifiprotect source](https://github.com/home-assistant/core/tree/dev/homeassistant/components/unifiprotect)\n@spmfox Works perfectly with my G4 Doorbell Pro PoE. Are you sure you provided the correct device_id? The error AttributeError: 'Controller' object has no attribute 'bootstrap' suggests you might have used the console device_id instead\nYeah I just double checked, it's using the device_id for the doorbell. \nWhat permissions does the user you set up Protect with in HA have?\r\n\r\n![image](https://github.com/user-attachments/assets/7acfa507-0bd8-4c14-97b2-f2cd7fb44116)\r\n\nOkay we're getting somewhere - the user was underprivileged for sure. I was unable to even set the text from the device page in Home Assistant. Thank you @RaHehl \r\n\r\nOnce fixing the user, and reloading the integration, I was able to make the change manually from the device page.\r\n\r\nChanging it manually got me curious why this works, so looking at the logs HA called a different action then I was trying to use.\r\n\r\n```\r\naction: text.set_value\r\nmetadata: {}\r\ndata:\r\n  value: NO SOLICITORS\r\ntarget:\r\n  entity_id: text.cam_doorbell_doorbell\r\n```\r\n\r\nThis works - but the original method I was trying (which is the way per the documentation) still does not work. I'm happy with any method so I think I'm good, however perhaps the developers want to chime in and determine if this is a bug or maybe the documentation needs to be updated and the other (old?) method removed.\n@spmfox Thank you for sharing your findings! I\u2019m happy to look into this further, but could you please provide logs after adjusting the permissions? As mentioned, it\u2019s working on my end, so having additional details from your setup could help pinpoint the issue.\nOkay, I reproduced the issue with debug logging on using this YAML:\r\n\r\n```\r\naction: unifiprotect.add_doorbell_text\r\nmetadata: {}\r\ndata:\r\n  device_id: <REDACTED>\r\n  message: TEST\r\n```\r\n\r\n`AttributeError: 'Controller' object has no attribute 'bootstrap'`\r\n\r\n[unifi-protect-debug.log](https://github.com/user-attachments/files/17908417/unifi-protect-debug.log)\r\n\nProbably the device is linked to multiple integrations so we need to check the domain here:\r\n```diff\r\ndiff --git a/homeassistant/components/unifiprotect/data.py b/homeassistant/components/unifiprotect/data.py\r\nindex 4ad8892ca01..baecc7f8323 100644\r\n--- a/homeassistant/components/unifiprotect/data.py\r\n+++ b/homeassistant/components/unifiprotect/data.py\r\n@@ -349,6 +349,7 @@ def async_ufp_instance_for_config_entry_ids(\r\n             entry.runtime_data.api\r\n             for entry_id in config_entry_ids\r\n             if (entry := hass.config_entries.async_get_entry(entry_id))\r\n+            and entry.domain == DOMAIN\r\n             and hasattr(entry, \"runtime_data\")\r\n         ),\r\n         None,\r\n```\n@bdraco I honestly don't quite know what a domain means in this context, but it sounds plausible. I had similar theories when I looked into it \u2014 that there might be multiple instances, possibly even orphaned configurations or something like that.\r\n\r\nShould I go ahead and prepare a PR with your suggestion?\n> @bdraco I honestly don't quite know what a domain means in this context, but it sounds plausible. I had similar theories when I looked into it \u2014 that there might be multiple instances, possibly even orphaned configurations or something like that.\r\n> \r\n`DOMAIN` in this context is `unifiprotect`.\r\n\r\n> Should I go ahead and prepare a PR with your suggestion?\r\n\r\nThat would be great.\r\n\r\nYou should be able to get test coverage for it by mocking the device registry and creating another config entry with any other domain with the same mac address of the camera.\r\n\nExample of a test for another integration that fixed a similar issue\r\n\r\nhttps://github.com/home-assistant/core/blob/055c38a3c819ccfc042a155af7759e39fe0d38c1/tests/components/tplink/test_init.py#L426\nI'll try to implement that tomorrow.", "created_at": "2024-11-27T15:00:12Z"}
{"repo": "home-assistant/core", "pull_number": 131700, "instance_id": "home-assistant__core-131700", "issue_numbers": ["128723", "128723"], "base_commit": "56b4733e4aebf53970e63308a5474b7e02c90e51", "patch": "diff --git a/homeassistant/components/overkiz/climate/somfy_thermostat.py b/homeassistant/components/overkiz/climate/somfy_thermostat.py\nindex 829a3bad03b0df..e03d2065958d5d 100644\n--- a/homeassistant/components/overkiz/climate/somfy_thermostat.py\n+++ b/homeassistant/components/overkiz/climate/somfy_thermostat.py\n@@ -57,10 +57,7 @@ class SomfyThermostat(OverkizEntity, ClimateEntity):\n \n     _attr_temperature_unit = UnitOfTemperature.CELSIUS\n     _attr_supported_features = (\n-        ClimateEntityFeature.PRESET_MODE\n-        | ClimateEntityFeature.TARGET_TEMPERATURE\n-        | ClimateEntityFeature.TURN_OFF\n-        | ClimateEntityFeature.TURN_ON\n+        ClimateEntityFeature.PRESET_MODE | ClimateEntityFeature.TARGET_TEMPERATURE\n     )\n     _attr_hvac_modes = [*HVAC_MODES_TO_OVERKIZ]\n     _attr_preset_modes = [*PRESET_MODES_TO_OVERKIZ]\n@@ -83,11 +80,12 @@ def __init__(\n     @property\n     def hvac_mode(self) -> HVACMode:\n         \"\"\"Return hvac operation ie. heat, cool mode.\"\"\"\n-        return OVERKIZ_TO_HVAC_MODES[\n-            cast(\n-                str, self.executor.select_state(OverkizState.CORE_DEROGATION_ACTIVATION)\n-            )\n-        ]\n+        if derogation_activation := self.executor.select_state(\n+            OverkizState.CORE_DEROGATION_ACTIVATION\n+        ):\n+            return OVERKIZ_TO_HVAC_MODES[cast(str, derogation_activation)]\n+\n+        return HVACMode.AUTO\n \n     @property\n     def preset_mode(self) -> str:\n@@ -97,9 +95,10 @@ def preset_mode(self) -> str:\n         else:\n             state_key = OverkizState.SOMFY_THERMOSTAT_DEROGATION_HEATING_MODE\n \n-        state = cast(str, self.executor.select_state(state_key))\n+        if state := self.executor.select_state(state_key):\n+            return OVERKIZ_TO_PRESET_MODES[OverkizCommandParam(cast(str, state))]\n \n-        return OVERKIZ_TO_PRESET_MODES[OverkizCommandParam(state)]\n+        return PRESET_NONE\n \n     @property\n     def current_temperature(self) -> float | None:\n", "test_patch": "", "problem_statement": "SomfyThermostat entity is unavailable in Overkiz integration\n### The problem\n\nHi there!\r\n\r\nI\u00b4m using Overkiz integration to connect to all my Somfy devices in my HA. \r\nEverything looks good, and all the sensors are there, but when it comes to thermostat controls they appear as unavailable.\r\n\r\n![image](https://github.com/user-attachments/assets/a4e33ddc-f11a-443d-a1a4-af967f42bbb4)\r\n\r\nI\u00b4m connected to my TaHoma Switch using the cloud API and both thermostats are Somfy connected thermostats v2 perfectly connected to my TaHoma.\r\n\r\nThanks in advance for the support!\n\n### What version of Home Assistant Core has the issue?\n\ncore-2024.10.3\n\n### What was the last working version of Home Assistant Core?\n\n_No response_\n\n### What type of installation are you running?\n\nHome Assistant OS\n\n### Integration causing the issue\n\noverkiz\n\n### Link to integration documentation on our website\n\nhttps://www.home-assistant.io/integrations/overkiz\n\n### Diagnostics information\n\n[config_entry-overkiz-e85a625e656f3e9ea3c091d01ff50edd.json](https://github.com/user-attachments/files/17444399/config_entry-overkiz-e85a625e656f3e9ea3c091d01ff50edd.json)\r\n\n\n### Example YAML snippet\n\n_No response_\n\n### Anything in the logs that might be useful for us?\n\n_No response_\n\n### Additional information\n\n_No response_\nSomfyThermostat entity is unavailable in Overkiz integration\n### The problem\n\nHi there!\r\n\r\nI\u00b4m using Overkiz integration to connect to all my Somfy devices in my HA. \r\nEverything looks good, and all the sensors are there, but when it comes to thermostat controls they appear as unavailable.\r\n\r\n![image](https://github.com/user-attachments/assets/a4e33ddc-f11a-443d-a1a4-af967f42bbb4)\r\n\r\nI\u00b4m connected to my TaHoma Switch using the cloud API and both thermostats are Somfy connected thermostats v2 perfectly connected to my TaHoma.\r\n\r\nThanks in advance for the support!\n\n### What version of Home Assistant Core has the issue?\n\ncore-2024.10.3\n\n### What was the last working version of Home Assistant Core?\n\n_No response_\n\n### What type of installation are you running?\n\nHome Assistant OS\n\n### Integration causing the issue\n\noverkiz\n\n### Link to integration documentation on our website\n\nhttps://www.home-assistant.io/integrations/overkiz\n\n### Diagnostics information\n\n[config_entry-overkiz-e85a625e656f3e9ea3c091d01ff50edd.json](https://github.com/user-attachments/files/17444399/config_entry-overkiz-e85a625e656f3e9ea3c091d01ff50edd.json)\r\n\n\n### Example YAML snippet\n\n_No response_\n\n### Anything in the logs that might be useful for us?\n\n_No response_\n\n### Additional information\n\n_No response_\n", "hints_text": "\nHey there @imicknl, @vlebourl, @tetienne, @nyrodev, @tronix117, @alexfp14, mind taking a look at this issue as it has been labeled with an integration (`overkiz`) you are listed as a [code owner](https://github.com/home-assistant/core/blob/dev/CODEOWNERS#L1085) for? Thanks!\n\n<details>\n<summary>Code owner commands</summary>\n\n\nCode owners of `overkiz` can trigger bot actions by commenting:\n\n- `@home-assistant close` Closes the issue.\n- `@home-assistant rename Awesome new title` Renames the issue.\n- `@home-assistant reopen` Reopen the issue.\n- `@home-assistant unassign overkiz` Removes the current integration label and assignees on the issue, add the integration domain after the command.\n- `@home-assistant add-label needs-more-information` Add a label (needs-more-information, problem in dependency, problem in custom component) to the issue.\n- `@home-assistant remove-label needs-more-information` Remove a label (needs-more-information, problem in dependency, problem in custom component) on the issue.\n\n</details>\n\n\n<sub><sup>(message by CodeOwnersMention)</sup></sub>\n\n---\n\n[overkiz documentation](https://www.home-assistant.io/integrations/overkiz)\n[overkiz source](https://github.com/home-assistant/core/tree/dev/homeassistant/components/overkiz)\n<sub><sup>(message by IssueLinks)</sup></sub>\nDo you have any issues / errors in your log?\r\n\nYes. I\u00b4ve just check the logs after reloading the integration and found this on my HomeAssistant Core logs\r\n\r\n```\r\nLogger: homeassistant.components.climate\r\nSource: helpers/entity_platform.py:595\r\nintegration: Climate (documentation, issues)\r\nFirst occurred: 18 October 2024 at 19:45:49 (16 occurrences)\r\nLast logged: 09:42:42\r\n\r\nError adding entity climate.termostato_planta_0 for domain climate with platform overkiz\r\nError adding entity climate.termostato_planta_1 for domain climate with platform overkiz\r\nTraceback (most recent call last):\r\n  File \"/usr/src/homeassistant/homeassistant/helpers/entity_platform.py\", line 595, in _async_add_entities\r\n    await coro\r\n  File \"/usr/src/homeassistant/homeassistant/helpers/entity_platform.py\", line 909, in _async_add_entity\r\n    await entity.add_to_platform_finish()\r\n  File \"/usr/src/homeassistant/homeassistant/helpers/entity.py\", line 1366, in add_to_platform_finish\r\n    self.async_write_ha_state()\r\n  File \"/usr/src/homeassistant/homeassistant/helpers/entity.py\", line 1005, in async_write_ha_state\r\n    self._async_write_ha_state()\r\n  File \"/usr/src/homeassistant/homeassistant/helpers/entity.py\", line 1130, in _async_write_ha_state\r\n    self.__async_calculate_state()\r\n  File \"/usr/src/homeassistant/homeassistant/helpers/entity.py\", line 1067, in __async_calculate_state\r\n    state = self._stringify_state(available)\r\n            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/src/homeassistant/homeassistant/helpers/entity.py\", line 1011, in _stringify_state\r\n    if (state := self.state) is None:\r\n                 ^^^^^^^^^^\r\n  File \"/usr/src/homeassistant/homeassistant/components/climate/__init__.py\", line 324, in __getattribute__\r\n    return super().__getattribute__(__name)\r\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/src/homeassistant/homeassistant/components/climate/__init__.py\", line 469, in state\r\n    hvac_mode = self.hvac_mode\r\n                ^^^^^^^^^^^^^^\r\n  File \"/usr/src/homeassistant/homeassistant/components/climate/__init__.py\", line 324, in __getattribute__\r\n    return super().__getattribute__(__name)\r\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/src/homeassistant/homeassistant/components/overkiz/climate/somfy_thermostat.py\", line 86, in hvac_mode\r\n    return OVERKIZ_TO_HVAC_MODES[\r\n           ^^^^^^^^^^^^^^^^^^^^^^\r\nKeyError: None\r\n```\n@dariopascu do you still face this issue? I don't have enough information in your log to solve the issue.\r\n\r\nCould you contact me on Discord (`_imick`) so we can have a closer look?\n\nHey there @imicknl, @vlebourl, @tetienne, @nyrodev, @tronix117, @alexfp14, mind taking a look at this issue as it has been labeled with an integration (`overkiz`) you are listed as a [code owner](https://github.com/home-assistant/core/blob/dev/CODEOWNERS#L1085) for? Thanks!\n\n<details>\n<summary>Code owner commands</summary>\n\n\nCode owners of `overkiz` can trigger bot actions by commenting:\n\n- `@home-assistant close` Closes the issue.\n- `@home-assistant rename Awesome new title` Renames the issue.\n- `@home-assistant reopen` Reopen the issue.\n- `@home-assistant unassign overkiz` Removes the current integration label and assignees on the issue, add the integration domain after the command.\n- `@home-assistant add-label needs-more-information` Add a label (needs-more-information, problem in dependency, problem in custom component) to the issue.\n- `@home-assistant remove-label needs-more-information` Remove a label (needs-more-information, problem in dependency, problem in custom component) on the issue.\n\n</details>\n\n\n<sub><sup>(message by CodeOwnersMention)</sup></sub>\n\n---\n\n[overkiz documentation](https://www.home-assistant.io/integrations/overkiz)\n[overkiz source](https://github.com/home-assistant/core/tree/dev/homeassistant/components/overkiz)\n<sub><sup>(message by IssueLinks)</sup></sub>\nDo you have any issues / errors in your log?\r\n\nYes. I\u00b4ve just check the logs after reloading the integration and found this on my HomeAssistant Core logs\r\n\r\n```\r\nLogger: homeassistant.components.climate\r\nSource: helpers/entity_platform.py:595\r\nintegration: Climate (documentation, issues)\r\nFirst occurred: 18 October 2024 at 19:45:49 (16 occurrences)\r\nLast logged: 09:42:42\r\n\r\nError adding entity climate.termostato_planta_0 for domain climate with platform overkiz\r\nError adding entity climate.termostato_planta_1 for domain climate with platform overkiz\r\nTraceback (most recent call last):\r\n  File \"/usr/src/homeassistant/homeassistant/helpers/entity_platform.py\", line 595, in _async_add_entities\r\n    await coro\r\n  File \"/usr/src/homeassistant/homeassistant/helpers/entity_platform.py\", line 909, in _async_add_entity\r\n    await entity.add_to_platform_finish()\r\n  File \"/usr/src/homeassistant/homeassistant/helpers/entity.py\", line 1366, in add_to_platform_finish\r\n    self.async_write_ha_state()\r\n  File \"/usr/src/homeassistant/homeassistant/helpers/entity.py\", line 1005, in async_write_ha_state\r\n    self._async_write_ha_state()\r\n  File \"/usr/src/homeassistant/homeassistant/helpers/entity.py\", line 1130, in _async_write_ha_state\r\n    self.__async_calculate_state()\r\n  File \"/usr/src/homeassistant/homeassistant/helpers/entity.py\", line 1067, in __async_calculate_state\r\n    state = self._stringify_state(available)\r\n            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/src/homeassistant/homeassistant/helpers/entity.py\", line 1011, in _stringify_state\r\n    if (state := self.state) is None:\r\n                 ^^^^^^^^^^\r\n  File \"/usr/src/homeassistant/homeassistant/components/climate/__init__.py\", line 324, in __getattribute__\r\n    return super().__getattribute__(__name)\r\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/src/homeassistant/homeassistant/components/climate/__init__.py\", line 469, in state\r\n    hvac_mode = self.hvac_mode\r\n                ^^^^^^^^^^^^^^\r\n  File \"/usr/src/homeassistant/homeassistant/components/climate/__init__.py\", line 324, in __getattribute__\r\n    return super().__getattribute__(__name)\r\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/src/homeassistant/homeassistant/components/overkiz/climate/somfy_thermostat.py\", line 86, in hvac_mode\r\n    return OVERKIZ_TO_HVAC_MODES[\r\n           ^^^^^^^^^^^^^^^^^^^^^^\r\nKeyError: None\r\n```\n@dariopascu do you still face this issue? I don't have enough information in your log to solve the issue.\r\n\r\nCould you contact me on Discord (`_imick`) so we can have a closer look?", "created_at": "2024-11-27T10:00:26Z"}
{"repo": "home-assistant/core", "pull_number": 131696, "instance_id": "home-assistant__core-131696", "issue_numbers": ["131474", "131474"], "base_commit": "96eae1221cc8de5417464cd09a6e84c1c99ef2c9", "patch": "diff --git a/homeassistant/components/overkiz/config_flow.py b/homeassistant/components/overkiz/config_flow.py\nindex 471a13d0de2e6d..af7e277d928516 100644\n--- a/homeassistant/components/overkiz/config_flow.py\n+++ b/homeassistant/components/overkiz/config_flow.py\n@@ -151,9 +151,11 @@ async def async_step_cloud(\n             except BadCredentialsException as exception:\n                 # If authentication with CozyTouch auth server is valid, but token is invalid\n                 # for Overkiz API server, the hardware is not supported.\n-                if user_input[CONF_HUB] == Server.ATLANTIC_COZYTOUCH and not isinstance(\n-                    exception, CozyTouchBadCredentialsException\n-                ):\n+                if user_input[CONF_HUB] in {\n+                    Server.ATLANTIC_COZYTOUCH,\n+                    Server.SAUTER_COZYTOUCH,\n+                    Server.THERMOR_COZYTOUCH,\n+                } and not isinstance(exception, CozyTouchBadCredentialsException):\n                     description_placeholders[\"unsupported_device\"] = \"CozyTouch\"\n                     errors[\"base\"] = \"unsupported_hardware\"\n                 else:\n", "test_patch": "", "problem_statement": "Bad Credentials for CozyTouch server in Overkiz integration\n### The problem\n\nHello,\r\n\r\nJust want to connect via Overkill , then I select Thermor Atlantic, then enter the connexion infos like I do in the cozy touch mobile app.\r\nI always get a invalid issue.\r\n\r\nIs it still working ?\r\n<img width=\"715\" alt=\"Capture d\u2019e\u0301cran 2024-11-24 a\u0300 18 40 37\" src=\"https://github.com/user-attachments/assets/78277004-222c-4ff7-9c56-385221673b99\">\r\n\n\n### What version of Home Assistant Core has the issue?\n\n2024.11.3\n\n### What was the last working version of Home Assistant Core?\n\n_No response_\n\n### What type of installation are you running?\n\nHome Assistant Container\n\n### Integration causing the issue\n\nOverkiz\n\n### Link to integration documentation on our website\n\n_No response_\n\n### Diagnostics information\n\n## System Information\r\n\r\nversion | core-2024.11.3\r\n-- | --\r\ninstallation_type | Home Assistant Container\r\ndev | false\r\nhassio | false\r\ndocker | true\r\nuser | root\r\nvirtualenv | false\r\npython_version | 3.12.4\r\nos_name | Linux\r\nos_version | 6.1.21-v8+\r\narch | aarch64\r\ntimezone | Europe/Paris\r\nconfig_dir | /config\r\n\r\n<details><summary>Home Assistant Cloud</summary>\r\n\r\nlogged_in | false\r\n-- | --\r\ncan_reach_cert_server | ok\r\ncan_reach_cloud_auth | ok\r\ncan_reach_cloud | ok\r\n\r\n</details>\r\n\r\n<details><summary>Dashboards</summary>\r\n\r\ndashboards | 2\r\n-- | --\r\nresources | 0\r\nviews | 0\r\nmode | storage\r\n\r\n</details>\r\n\r\n<details><summary>Recorder</summary>\r\n\r\noldest_recorder_run | 24 novembre 2024 \u00e0 15:07\r\n-- | --\r\ncurrent_recorder_run | 24 novembre 2024 \u00e0 17:47\r\nestimated_db_size | 0.29 MiB\r\ndatabase_engine | sqlite\r\ndatabase_version | 3.45.3\r\n\r\n</details>\n\n### Example YAML snippet\n\n_No response_\n\n### Anything in the logs that might be useful for us?\n\n_No response_\n\n### Additional information\n\n_No response_\nBad Credentials for CozyTouch server in Overkiz integration\n### The problem\n\nHello,\r\n\r\nJust want to connect via Overkill , then I select Thermor Atlantic, then enter the connexion infos like I do in the cozy touch mobile app.\r\nI always get a invalid issue.\r\n\r\nIs it still working ?\r\n<img width=\"715\" alt=\"Capture d\u2019e\u0301cran 2024-11-24 a\u0300 18 40 37\" src=\"https://github.com/user-attachments/assets/78277004-222c-4ff7-9c56-385221673b99\">\r\n\n\n### What version of Home Assistant Core has the issue?\n\n2024.11.3\n\n### What was the last working version of Home Assistant Core?\n\n_No response_\n\n### What type of installation are you running?\n\nHome Assistant Container\n\n### Integration causing the issue\n\nOverkiz\n\n### Link to integration documentation on our website\n\n_No response_\n\n### Diagnostics information\n\n## System Information\r\n\r\nversion | core-2024.11.3\r\n-- | --\r\ninstallation_type | Home Assistant Container\r\ndev | false\r\nhassio | false\r\ndocker | true\r\nuser | root\r\nvirtualenv | false\r\npython_version | 3.12.4\r\nos_name | Linux\r\nos_version | 6.1.21-v8+\r\narch | aarch64\r\ntimezone | Europe/Paris\r\nconfig_dir | /config\r\n\r\n<details><summary>Home Assistant Cloud</summary>\r\n\r\nlogged_in | false\r\n-- | --\r\ncan_reach_cert_server | ok\r\ncan_reach_cloud_auth | ok\r\ncan_reach_cloud | ok\r\n\r\n</details>\r\n\r\n<details><summary>Dashboards</summary>\r\n\r\ndashboards | 2\r\n-- | --\r\nresources | 0\r\nviews | 0\r\nmode | storage\r\n\r\n</details>\r\n\r\n<details><summary>Recorder</summary>\r\n\r\noldest_recorder_run | 24 novembre 2024 \u00e0 15:07\r\n-- | --\r\ncurrent_recorder_run | 24 novembre 2024 \u00e0 17:47\r\nestimated_db_size | 0.29 MiB\r\ndatabase_engine | sqlite\r\ndatabase_version | 3.45.3\r\n\r\n</details>\n\n### Example YAML snippet\n\n_No response_\n\n### Anything in the logs that might be useful for us?\n\n_No response_\n\n### Additional information\n\n_No response_\n", "hints_text": "\nHey there @imicknl, @vlebourl, @tetienne, @nyrodev, @tronix117, @alexfp14, mind taking a look at this issue as it has been labeled with an integration (`overkiz`) you are listed as a [code owner](https://github.com/home-assistant/core/blob/dev/CODEOWNERS#L1096) for? Thanks!\n\n<details>\n<summary>Code owner commands</summary>\n\n\nCode owners of `overkiz` can trigger bot actions by commenting:\n\n- `@home-assistant close` Closes the issue.\n- `@home-assistant rename Awesome new title` Renames the issue.\n- `@home-assistant reopen` Reopen the issue.\n- `@home-assistant unassign overkiz` Removes the current integration label and assignees on the issue, add the integration domain after the command.\n- `@home-assistant add-label needs-more-information` Add a label (needs-more-information, problem in dependency, problem in custom component) to the issue.\n- `@home-assistant remove-label needs-more-information` Remove a label (needs-more-information, problem in dependency, problem in custom component) on the issue.\n\n</details>\n\n\n<sub><sup>(message by CodeOwnersMention)</sup></sub>\n\n---\n\n[overkiz documentation](https://www.home-assistant.io/integrations/overkiz)\n[overkiz source](https://github.com/home-assistant/core/tree/dev/homeassistant/components/overkiz)\n<sub><sup>(message by IssueLinks)</sup></sub>\n@MatthD this should be supported, but it is hard to debug for us. Can you contact me on Discord? (`_imick`).\n\nHey there @imicknl, @vlebourl, @tetienne, @nyrodev, @tronix117, @alexfp14, mind taking a look at this issue as it has been labeled with an integration (`overkiz`) you are listed as a [code owner](https://github.com/home-assistant/core/blob/dev/CODEOWNERS#L1096) for? Thanks!\n\n<details>\n<summary>Code owner commands</summary>\n\n\nCode owners of `overkiz` can trigger bot actions by commenting:\n\n- `@home-assistant close` Closes the issue.\n- `@home-assistant rename Awesome new title` Renames the issue.\n- `@home-assistant reopen` Reopen the issue.\n- `@home-assistant unassign overkiz` Removes the current integration label and assignees on the issue, add the integration domain after the command.\n- `@home-assistant add-label needs-more-information` Add a label (needs-more-information, problem in dependency, problem in custom component) to the issue.\n- `@home-assistant remove-label needs-more-information` Remove a label (needs-more-information, problem in dependency, problem in custom component) on the issue.\n\n</details>\n\n\n<sub><sup>(message by CodeOwnersMention)</sup></sub>\n\n---\n\n[overkiz documentation](https://www.home-assistant.io/integrations/overkiz)\n[overkiz source](https://github.com/home-assistant/core/tree/dev/homeassistant/components/overkiz)\n<sub><sup>(message by IssueLinks)</sup></sub>\n@MatthD this should be supported, but it is hard to debug for us. Can you contact me on Discord? (`_imick`).", "created_at": "2024-11-27T09:12:43Z"}
{"repo": "home-assistant/core", "pull_number": 131688, "instance_id": "home-assistant__core-131688", "issue_numbers": ["131583"], "base_commit": "2b939ce6ec037c1cbcbe17af9cfb19354ed9f1a1", "patch": "diff --git a/homeassistant/components/myuplink/helpers.py b/homeassistant/components/myuplink/helpers.py\nindex de5486d8dea204..bd875d8a872035 100644\n--- a/homeassistant/components/myuplink/helpers.py\n+++ b/homeassistant/components/myuplink/helpers.py\n@@ -95,11 +95,17 @@ def find_matching_platform(\n )\n \n PARAMETER_ID_TO_INCLUDE_SMO20 = (\n+    \"40013\",\n+    \"40033\",\n     \"40940\",\n+    \"44069\",\n+    \"44071\",\n+    \"44073\",\n     \"47011\",\n     \"47015\",\n     \"47028\",\n     \"47032\",\n+    \"47398\",\n     \"50004\",\n )\n \n", "test_patch": "", "problem_statement": "Can't adjust temperature of NIBE F2040\n### The problem\n\nI have a NIBE F2040 ASHP, I used to be able to control it with hass_nibe addon from HACS. Since the the nibeuplink -> myuplink transition and switching to the myUplink integration in core I can no longer set the thermostat temperature from HA. I can still set the Temporary Lux from HA, so the connection and authentication seem to be working.\r\n\r\nThe closest looking entry, that shows in the Controls panel is `number.smo_20_climate_system`\r\n![image](https://github.com/user-attachments/assets/4e5e3b14-4271-4392-a5f6-d388bd335dbf)\r\nBut this has no influence on the heat pump, and does not reflect changes made with the physical control panel, or via the myuplink website.\r\n\r\nIn the old integration I could adjust it via `climate.nibe_127388_s1_room`\r\n![image](https://github.com/user-attachments/assets/e3cfd9ce-ca59-4489-9672-dd39e495eeb8)\r\n\n\n### What version of Home Assistant Core has the issue?\n\ncore-2024.11.3\n\n### What was the last working version of Home Assistant Core?\n\n_No response_\n\n### What type of installation are you running?\n\nHome Assistant OS\n\n### Integration causing the issue\n\nmyuplink\n\n### Link to integration documentation on our website\n\nhttps://www.home-assistant.io/integrations/myuplink\n\n### Diagnostics information\n\n[config_entry-myuplink-01J7VTVKGM7QNWZFTNSRHTRS8D.json](https://github.com/user-attachments/files/17909499/config_entry-myuplink-01J7VTVKGM7QNWZFTNSRHTRS8D.json)\r\n\n\n### Example YAML snippet\n\n_No response_\n\n### Anything in the logs that might be useful for us?\n\n_No response_\n\n### Additional information\n\n_No response_\n", "hints_text": "\nHey there @pajzo, @astrandb, mind taking a look at this issue as it has been labeled with an integration (`myuplink`) you are listed as a [code owner](https://github.com/home-assistant/core/blob/dev/CODEOWNERS#L969) for? Thanks!\n\n<details>\n<summary>Code owner commands</summary>\n\n\nCode owners of `myuplink` can trigger bot actions by commenting:\n\n- `@home-assistant close` Closes the issue.\n- `@home-assistant rename Awesome new title` Renames the issue.\n- `@home-assistant reopen` Reopen the issue.\n- `@home-assistant unassign myuplink` Removes the current integration label and assignees on the issue, add the integration domain after the command.\n- `@home-assistant add-label needs-more-information` Add a label (needs-more-information, problem in dependency, problem in custom component) to the issue.\n- `@home-assistant remove-label needs-more-information` Remove a label (needs-more-information, problem in dependency, problem in custom component) on the issue.\n\n</details>\n\n\n<sub><sup>(message by CodeOwnersMention)</sup></sub>\n\n---\n\n[myuplink documentation](https://www.home-assistant.io/integrations/myuplink)\n[myuplink source](https://github.com/home-assistant/core/tree/dev/homeassistant/components/myuplink)\n<sub><sup>(message by IssueLinks)</sup></sub>\nLooking through the diagnostic data, I think the correct control should be\r\n```\r\n                {\r\n                  \"category\": \"SMO 20\",\r\n                  \"parameterId\": \"47398\",\r\n                  \"parameterName\": \"Room sensor set point value heating climate system 1\",\r\n                  \"parameterUnit\": \"\\u00b0C\",\r\n                  \"writable\": true,\r\n                  \"timestamp\": \"2024-11-25T22:17:35+00:00\",\r\n                  \"value\": 17.5,\r\n                  \"strVal\": \"17.5\\u00b0C\",\r\n                  \"smartHomeCategories\": [],\r\n                  \"minValue\": 50.0,\r\n                  \"maxValue\": 350.0,\r\n                  \"stepValue\": 5.0,\r\n                  \"enumValues\": [],\r\n                  \"scaleValue\": \"0.1\",\r\n                  \"zoneId\": null\r\n                },\r\n```\r\nThat value is effected by making a change on the myuplink web interface.\nThank you for reporting.\r\nThis integration downloads all data points from the API and uses best effort to represent the points as relevant entities in HA. This process includes some guesswork and also some \"manual\" mapping. The official documentation from Nibe is somewhat sparse to say the least.\r\n\r\nThe API data for SMO 20 has been a challenge...\r\n\r\nThe \"climate system\" entity is a temperature setpoint  (allowed range 5-70C)  I have no info of what it is supposed to do.\r\n\r\nI will enable 47398 for SMO 20, it will be exposed as a number entity. Climate entities are currelntly not supported in this integration. They may be in the future.\r\n\r\nCannot promise anything on when the patch will be released. It depends on the code review process.\nThanks. Is there anything I can do to help decipher any other values?\r\n\r\nIt would be nice to have few more exposed, for example 40013 \"Hot water top (BT7)\", is the best indicator of is the water hot enough to have a shower. \r\n\r\nIs a climate entity what is needed to get a thermostat widget? I could have go at writing a PR, if there is some documentation you can point me at.\nPlease enumerate the sensors you are missing (in addition to 40013). If it is just a simple enabling that is needed it may be possible to get it accepted for next patch release of HA, otherwise it will have to wait for next monthly release.\r\n\r\nThe climate entity is one of the more complex platforms and perhaps a bit difficult as a starter. You can find the documentation here: https://developers.home-assistant.io/docs/core/entity/climate .\r\n\r\nThe entity sholud ideally expose both setpoint temperature and corresponding actual temperature and I am not sure that there is an easy way to map these data-point automatically from all heatpump models that myUplink supports.\r\n\r\nAdding a new platform to the integration also involves updates to the documentation and addition of tests.", "created_at": "2024-11-27T07:49:04Z"}
{"repo": "home-assistant/core", "pull_number": 131680, "instance_id": "home-assistant__core-131680", "issue_numbers": ["130710"], "base_commit": "a97eeaf189057b606c73189fee18a3edb372c4cd", "patch": "diff --git a/homeassistant/components/zha/manifest.json b/homeassistant/components/zha/manifest.json\nindex a2a285e61094f..ded37fc4713db 100644\n--- a/homeassistant/components/zha/manifest.json\n+++ b/homeassistant/components/zha/manifest.json\n@@ -21,7 +21,7 @@\n     \"zha\",\n     \"universal_silabs_flasher\"\n   ],\n-  \"requirements\": [\"universal-silabs-flasher==0.0.25\", \"zha==0.0.39\"],\n+  \"requirements\": [\"universal-silabs-flasher==0.0.25\", \"zha==0.0.40\"],\n   \"usb\": [\n     {\n       \"vid\": \"10C4\",\ndiff --git a/homeassistant/components/zha/strings.json b/homeassistant/components/zha/strings.json\nindex c462bef8fb070..4706e2048720e 100644\n--- a/homeassistant/components/zha/strings.json\n+++ b/homeassistant/components/zha/strings.json\n@@ -600,6 +600,12 @@\n       },\n       \"self_test\": {\n         \"name\": \"Self-test\"\n+      },\n+      \"reset_summation_delivered\": {\n+        \"name\": \"Reset summation delivered\"\n+      },\n+      \"restart_device\": {\n+        \"name\": \"Restart device\"\n       }\n     },\n     \"climate\": {\n@@ -798,6 +804,24 @@\n       },\n       \"off_led_intensity\": {\n         \"name\": \"Off LED intensity\"\n+      },\n+      \"frost_protection_temperature\": {\n+        \"name\": \"Frost protection temperature\"\n+      },\n+      \"valve_opening_degree\": {\n+        \"name\": \"Valve opening degree\"\n+      },\n+      \"valve_closing_degree\": {\n+        \"name\": \"Valve closing degree\"\n+      },\n+      \"siren_time\": {\n+        \"name\": \"Siren time\"\n+      },\n+      \"timer_time_left\": {\n+        \"name\": \"Timer time left\"\n+      },\n+      \"approach_distance\": {\n+        \"name\": \"Approach distance\"\n       }\n     },\n     \"select\": {\n@@ -899,6 +923,9 @@\n       },\n       \"off_led_color\": {\n         \"name\": \"Off LED color\"\n+      },\n+      \"external_trigger_mode\": {\n+        \"name\": \"External trigger mode\"\n       }\n     },\n     \"sensor\": {\n@@ -1096,6 +1123,15 @@\n       },\n       \"valve_status_2\": {\n         \"name\": \"Status 2\"\n+      },\n+      \"timer_state\": {\n+        \"name\": \"Timer state\"\n+      },\n+      \"last_valve_open_duration\": {\n+        \"name\": \"Last valve open duration\"\n+      },\n+      \"motion_distance\": {\n+        \"name\": \"Motion distance\"\n       }\n     },\n     \"switch\": {\n@@ -1209,6 +1245,18 @@\n       },\n       \"double_up_full\": {\n         \"name\": \"Double tap on - full\"\n+      },\n+      \"open_window\": {\n+        \"name\": \"Open window\"\n+      },\n+      \"turbo_mode\": {\n+        \"name\": \"Turbo mode\"\n+      },\n+      \"detach_relay\": {\n+        \"name\": \"Detach relay\"\n+      },\n+      \"enable_siren\": {\n+        \"name\": \"Enable siren\"\n       }\n     }\n   }\ndiff --git a/requirements_all.txt b/requirements_all.txt\nindex 1cc1ac50051e7..1b1551fb82a3f 100644\n--- a/requirements_all.txt\n+++ b/requirements_all.txt\n@@ -3081,7 +3081,7 @@ zeroconf==0.136.0\n zeversolar==0.3.2\n \n # homeassistant.components.zha\n-zha==0.0.39\n+zha==0.0.40\n \n # homeassistant.components.zhong_hong\n zhong-hong-hvac==1.0.13\n", "test_patch": "diff --git a/requirements_test_all.txt b/requirements_test_all.txt\nindex 74e7bfd4f66db..38e7dd374f2e3 100644\n--- a/requirements_test_all.txt\n+++ b/requirements_test_all.txt\n@@ -2464,7 +2464,7 @@ zeroconf==0.136.0\n zeversolar==0.3.2\n \n # homeassistant.components.zha\n-zha==0.0.39\n+zha==0.0.40\n \n # homeassistant.components.zwave_js\n zwave-js-server-python==0.59.1\n", "problem_statement": "Zigbee : class 'zigpy.types.basic.Single'> to int | str\n### The problem\n\nFailed to convert attr_value=5.0 from type <class 'zigpy.types.basic.Single'> to int | str\r\n\r\nOn any Zigbee device I try to change a setting on I get this type of error. Same thing in the logs.\n\n### What version of Home Assistant Core has the issue?\n\ncore-2024.11.1\n\n### What was the last working version of Home Assistant Core?\n\ncore-2024.11.0\n\n### What type of installation are you running?\n\nHome Assistant Container\n\n### Integration causing the issue\n\nZHA\n\n### Link to integration documentation on our website\n\nhttps://www.home-assistant.io/integrations/zha\n\n### Diagnostics information\n\n_No response_\n\n### Example YAML snippet\n\n```yaml\nn/a\n```\n\n\n### Anything in the logs that might be useful for us?\n\n```txt\nThe above exception was the direct cause of the following exception:\r\n\r\nTraceback (most recent call last):\r\n  File \"/usr/src/homeassistant/homeassistant/components/automation/__init__.py\", line 743, in async_trigger\r\n    return await self.action_script.async_run(\r\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/src/homeassistant/homeassistant/helpers/script.py\", line 1801, in async_run\r\n    return await asyncio.shield(create_eager_task(run.async_run()))\r\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/src/homeassistant/homeassistant/helpers/script.py\", line 464, in async_run\r\n    await self._async_step(log_exceptions=False)\r\n  File \"/usr/src/homeassistant/homeassistant/helpers/script.py\", line 528, in _async_step\r\n    self._handle_exception(\r\n  File \"/usr/src/homeassistant/homeassistant/helpers/script.py\", line 558, in _handle_exception\r\n    raise exception\r\n  File \"/usr/src/homeassistant/homeassistant/helpers/script.py\", line 526, in _async_step\r\n    await getattr(self, handler)()\r\n  File \"/usr/src/homeassistant/homeassistant/helpers/script.py\", line 764, in _async_call_service_step\r\n    response_data = await self._async_run_long_action(\r\n                    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/src/homeassistant/homeassistant/helpers/script.py\", line 727, in _async_run_long_action\r\n    return await long_task\r\n           ^^^^^^^^^^^^^^^\r\n  File \"/usr/src/homeassistant/homeassistant/core.py\", line 2802, in async_call\r\n    response_data = await coro\r\n                    ^^^^^^^^^^\r\n  File \"/usr/src/homeassistant/homeassistant/core.py\", line 2845, in _execute_service\r\n    return await target(service_call)\r\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/src/homeassistant/homeassistant/helpers/service.py\", line 1007, in entity_service_call\r\n    single_response = await _handle_entity_call(\r\n                      ^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/src/homeassistant/homeassistant/helpers/service.py\", line 1079, in _handle_entity_call\r\n    result = await task\r\n             ^^^^^^^^^^\r\n  File \"/usr/src/homeassistant/homeassistant/components/number/__init__.py\", line 122, in async_set_value\r\n    await entity.async_set_native_value(native_value)\r\n  File \"/usr/src/homeassistant/homeassistant/components/zha/helpers.py\", line 1335, in handler\r\n    return await func(self, *args, **kwargs)\r\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/src/homeassistant/homeassistant/components/zha/number.py\", line 88, in async_set_native_value\r\n    await self.entity_data.entity.async_set_native_value(value=value)\r\n  File \"/usr/local/lib/python3.12/site-packages/zha/application/platforms/number/__init__.py\", line 173, in async_set_native_value\r\n    await self._analog_output_cluster_handler.async_set_present_value(float(value))\r\n  File \"/usr/local/lib/python3.12/site-packages/zha/zigbee/cluster_handlers/general.py\", line 161, in async_set_present_value\r\n    await self.write_attributes_safe(\r\n  File \"/usr/local/lib/python3.12/site-packages/zha/zigbee/cluster_handlers/__init__.py\", line 614, in write_attributes_safe\r\n    res = await self.write_attributes(attributes, manufacturer=manufacturer)\r\n          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/local/lib/python3.12/site-packages/zha/zigbee/cluster_handlers/__init__.py\", line 85, in wrapper\r\n    return await RETRYABLE_REQUEST_DECORATOR(func)(*args, **kwargs)\r\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/local/lib/python3.12/site-packages/zigpy/util.py\", line 136, in retry\r\n    return await func()\r\n           ^^^^^^^^^^^^\r\n  File \"/usr/local/lib/python3.12/site-packages/zhaquirks/tuya/mcu/__init__.py\", line 111, in write_attributes\r\n    cluster_data = TuyaClusterData(\r\n                   ^^^^^^^^^^^^^^^^\r\n  File \"/usr/local/lib/python3.12/site-packages/zigpy/types/struct.py\", line 118, in __new__\r\n    setattr(instance, name, field._convert_type(value, struct=instance))\r\n                            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/local/lib/python3.12/site-packages/zigpy/types/struct.py\", line 52, in _convert_type\r\n    raise ValueError(\r\nValueError: Failed to convert attr_value=5.0 from type <class 'zigpy.types.basic.Single'> to int | str\n```\n\n\n### Additional information\n\n_No response_\n", "hints_text": "\nHey there @dmulcahey, @adminiuga, @puddly, @thejulianjes, mind taking a look at this issue as it has been labeled with an integration (`zha`) you are listed as a [code owner](https://github.com/home-assistant/core/blob/dev/CODEOWNERS#L1738) for? Thanks!\n\n<details>\n<summary>Code owner commands</summary>\n\n\nCode owners of `zha` can trigger bot actions by commenting:\n\n- `@home-assistant close` Closes the issue.\n- `@home-assistant rename Awesome new title` Renames the issue.\n- `@home-assistant reopen` Reopen the issue.\n- `@home-assistant unassign zha` Removes the current integration label and assignees on the issue, add the integration domain after the command.\n- `@home-assistant add-label needs-more-information` Add a label (needs-more-information, problem in dependency, problem in custom component) to the issue.\n- `@home-assistant remove-label needs-more-information` Remove a label (needs-more-information, problem in dependency, problem in custom component) on the issue.\n\n</details>\n\n\n<sub><sup>(message by CodeOwnersMention)</sup></sub>\n\n---\n\n[zha documentation](https://www.home-assistant.io/integrations/zha)\n[zha source](https://github.com/home-assistant/core/tree/dev/homeassistant/components/zha)\n<sub><sup>(message by IssueLinks)</sup></sub>\nsee https://community.home-assistant.io/t/tze204-ztc6ggyl-microwave-sensor-cannot-change-any-settings/792402 as well\nShould eventually be fixed by:\n- https://github.com/zigpy/zha/pull/267", "created_at": "2024-11-27T02:56:28Z"}
{"repo": "home-assistant/core", "pull_number": 131674, "instance_id": "home-assistant__core-131674", "issue_numbers": ["103786"], "base_commit": "551a584ca69771804b6f094eceb67dcb25a2f627", "patch": "diff --git a/CODEOWNERS b/CODEOWNERS\nindex 382fbffecaa3a8..0e2934b1f4932b 100644\n--- a/CODEOWNERS\n+++ b/CODEOWNERS\n@@ -1742,6 +1742,7 @@ build.json @home-assistant/supervisor\n /tests/components/youless/ @gjong\n /homeassistant/components/youtube/ @joostlek\n /tests/components/youtube/ @joostlek\n+/homeassistant/components/zabbix/ @kruton\n /homeassistant/components/zamg/ @killer0071234\n /tests/components/zamg/ @killer0071234\n /homeassistant/components/zengge/ @emontnemery\ndiff --git a/homeassistant/components/zabbix/__init__.py b/homeassistant/components/zabbix/__init__.py\nindex d9bab3e6fe4d0a..05881d649cf84f 100644\n--- a/homeassistant/components/zabbix/__init__.py\n+++ b/homeassistant/components/zabbix/__init__.py\n@@ -11,8 +11,9 @@\n from urllib.error import HTTPError\n from urllib.parse import urljoin\n \n-from pyzabbix import ZabbixAPI, ZabbixAPIException, ZabbixMetric, ZabbixSender\n import voluptuous as vol\n+from zabbix_utils import ItemValue, Sender, ZabbixAPI\n+from zabbix_utils.exceptions import APIRequestError\n \n from homeassistant.const import (\n     CONF_HOST,\n@@ -42,6 +43,7 @@\n \n DEFAULT_SSL = False\n DEFAULT_PATH = \"zabbix\"\n+DEFAULT_SENDER_PORT = 10051\n \n TIMEOUT = 5\n RETRY_DELAY = 20\n@@ -86,7 +88,7 @@ def setup(hass: HomeAssistant, config: ConfigType) -> bool:\n     try:\n         zapi = ZabbixAPI(url=url, user=username, password=password)\n         _LOGGER.debug(\"Connected to Zabbix API Version %s\", zapi.api_version())\n-    except ZabbixAPIException as login_exception:\n+    except APIRequestError as login_exception:\n         _LOGGER.error(\"Unable to login to the Zabbix API: %s\", login_exception)\n         return False\n     except HTTPError as http_error:\n@@ -104,7 +106,7 @@ def setup(hass: HomeAssistant, config: ConfigType) -> bool:\n \n     def event_to_metrics(\n         event: Event, float_keys: set[str], string_keys: set[str]\n-    ) -> list[ZabbixMetric] | None:\n+    ) -> list[ItemValue] | None:\n         \"\"\"Add an event to the outgoing Zabbix list.\"\"\"\n         state = event.data.get(\"new_state\")\n         if state is None or state.state in (STATE_UNKNOWN, \"\", STATE_UNAVAILABLE):\n@@ -145,14 +147,14 @@ def event_to_metrics(\n         float_keys.update(floats)\n         if len(float_keys) != float_keys_count:\n             floats_discovery = [{\"{#KEY}\": float_key} for float_key in float_keys]\n-            metric = ZabbixMetric(\n+            metric = ItemValue(\n                 publish_states_host,\n                 \"homeassistant.floats_discovery\",\n                 json.dumps(floats_discovery),\n             )\n             metrics.append(metric)\n         for key, value in floats.items():\n-            metric = ZabbixMetric(\n+            metric = ItemValue(\n                 publish_states_host, f\"homeassistant.float[{key}]\", value\n             )\n             metrics.append(metric)\n@@ -161,7 +163,7 @@ def event_to_metrics(\n         return metrics\n \n     if publish_states_host:\n-        zabbix_sender = ZabbixSender(zabbix_server=conf[CONF_HOST])\n+        zabbix_sender = Sender(server=conf[CONF_HOST], port=DEFAULT_SENDER_PORT)\n         instance = ZabbixThread(zabbix_sender, event_to_metrics)\n         instance.setup(hass)\n \n@@ -175,10 +177,8 @@ class ZabbixThread(threading.Thread):\n \n     def __init__(\n         self,\n-        zabbix_sender: ZabbixSender,\n-        event_to_metrics: Callable[\n-            [Event, set[str], set[str]], list[ZabbixMetric] | None\n-        ],\n+        zabbix_sender: Sender,\n+        event_to_metrics: Callable[[Event, set[str], set[str]], list[ItemValue] | None],\n     ) -> None:\n         \"\"\"Initialize the listener.\"\"\"\n         threading.Thread.__init__(self, name=\"Zabbix\")\n@@ -208,12 +208,12 @@ def _event_listener(self, event: Event[EventStateChangedData]) -> None:\n         item = (time.monotonic(), event)\n         self.queue.put(item)\n \n-    def get_metrics(self) -> tuple[int, list[ZabbixMetric]]:\n+    def get_metrics(self) -> tuple[int, list[ItemValue]]:\n         \"\"\"Return a batch of events formatted for writing.\"\"\"\n         queue_seconds = QUEUE_BACKLOG_SECONDS + self.MAX_TRIES * RETRY_DELAY\n \n         count = 0\n-        metrics: list[ZabbixMetric] = []\n+        metrics: list[ItemValue] = []\n \n         dropped = 0\n \n@@ -243,7 +243,7 @@ def get_metrics(self) -> tuple[int, list[ZabbixMetric]]:\n \n         return count, metrics\n \n-    def write_to_zabbix(self, metrics: list[ZabbixMetric]) -> None:\n+    def write_to_zabbix(self, metrics: list[ItemValue]) -> None:\n         \"\"\"Write preprocessed events to zabbix, with retry.\"\"\"\n \n         for retry in range(self.MAX_TRIES + 1):\ndiff --git a/homeassistant/components/zabbix/manifest.json b/homeassistant/components/zabbix/manifest.json\nindex 9c7171bea4622c..86389d2b839c26 100644\n--- a/homeassistant/components/zabbix/manifest.json\n+++ b/homeassistant/components/zabbix/manifest.json\n@@ -1,10 +1,10 @@\n {\n   \"domain\": \"zabbix\",\n   \"name\": \"Zabbix\",\n-  \"codeowners\": [],\n+  \"codeowners\": [\"@kruton\"],\n   \"documentation\": \"https://www.home-assistant.io/integrations/zabbix\",\n   \"iot_class\": \"local_polling\",\n-  \"loggers\": [\"pyzabbix\"],\n+  \"loggers\": [\"zabbix_utils\"],\n   \"quality_scale\": \"legacy\",\n-  \"requirements\": [\"py-zabbix==1.1.7\"]\n+  \"requirements\": [\"zabbix-utils==2.0.1\"]\n }\ndiff --git a/homeassistant/components/zabbix/sensor.py b/homeassistant/components/zabbix/sensor.py\nindex f5d96f106cb176..7728233ebc091b 100644\n--- a/homeassistant/components/zabbix/sensor.py\n+++ b/homeassistant/components/zabbix/sensor.py\n@@ -6,8 +6,8 @@\n import logging\n from typing import Any\n \n-from pyzabbix import ZabbixAPI\n import voluptuous as vol\n+from zabbix_utils import ZabbixAPI\n \n from homeassistant.components.sensor import (\n     PLATFORM_SCHEMA as SENSOR_PLATFORM_SCHEMA,\ndiff --git a/requirements_all.txt b/requirements_all.txt\nindex 1f40c8d1612d10..d453000609382d 100644\n--- a/requirements_all.txt\n+++ b/requirements_all.txt\n@@ -1723,9 +1723,6 @@ py-sucks==0.9.10\n # homeassistant.components.synology_dsm\n py-synologydsm-api==2.5.3\n \n-# homeassistant.components.zabbix\n-py-zabbix==1.1.7\n-\n # homeassistant.components.atome\n pyAtome==0.1.1\n \n@@ -3084,6 +3081,9 @@ youtubeaio==1.1.5\n # homeassistant.components.media_extractor\n yt-dlp[default]==2024.12.13\n \n+# homeassistant.components.zabbix\n+zabbix-utils==2.0.1\n+\n # homeassistant.components.zamg\n zamg==0.3.6\n \n", "test_patch": "", "problem_statement": "Zabbix Integration dont work\n### The problem\n\nHello, I would like to use the Zabbix integration from Home Assistant. I created a user homeassistant in Zabbix and granted the rights for the API. then I created the host and imported and applied the zabbix template. Lastly, I added the zabbix lines to the configuration.yaml and restarted the Homeassistant. Unfortunately the integration doesn't work and I get error messages in the log.\n\n### What version of Home Assistant Core has the issue?\n\ncore-2023.11.2\n\n### What was the last working version of Home Assistant Core?\n\n_No response_\n\n### What type of installation are you running?\n\nHome Assistant OS\n\n### Integration causing the issue\n\nZabbix\n\n### Link to integration documentation on our website\n\nhttps://www.home-assistant.io/integrations/zabbix\n\n### Diagnostics information\n\n2023-11-11 11:47:58.312 ERROR (SyncWorker_5) [homeassistant.components.zabbix] Unable to login to the Zabbix API: {'code': -32602, 'message': 'Invalid params.', 'data': 'Invalid parameter \"/\": unexpected parameter \"user\".', 'json': \"{'jsonrpc': '2.0', 'method': 'user.login', 'params': {'user': 'homeassistant', 'password': '********'}, 'id': '1'}\"}\r\n2023-11-11 11:47:58.461 ERROR (MainThread) [homeassistant.setup] Setup failed for zabbix: Integration failed to initialize.\n\n### Example YAML snippet\n\n```yaml\nzabbix:\r\n  host: mydomsin.de\r\n  ssl: true\r\n  username: homeassistant\r\n  password: mypassword\r\n  publish_states_host: homeassistant\r\n  exclude:\r\n    domains:\r\n      - device_tracker\r\n    entities:\r\n      - sun.sun\r\n      - sensor.time\n```\n\n\n### Anything in the logs that might be useful for us?\n\n_No response_\n\n### Additional information\n\n_No response_\n", "hints_text": "[zabbix documentation](https://www.home-assistant.io/integrations/zabbix)\n[zabbix source](https://github.com/home-assistant/core/tree/dev/homeassistant/components/zabbix)\n\nThe following steps will solve the problem until the next core update. please fix the code!\n\ndocker exec -ti homeassistant bash\n\nPatch File:\nvi /usr/local/lib/python3.11/site-packages/pyzabbix/api.py\n\nLine 208 und 210\nuser to username\n\nThe issue is not in HA but in the py-zabbix lib. You should open an issue here: https://github.com/adubkov/py-zabbix/\r\n\r\nNote that this library has not been updated since 2020 and seems abandoned\u2026\nIt is possible to Change the libary from pyzabbix instead of py-zabbix.\nThere hasn't been any activity on this issue recently. Due to the high number of incoming GitHub notifications, we have to clean some of the old issues, as many of them have already been resolved with the latest updates.\nPlease make sure to update to the latest Home Assistant version and check if that solves the issue. Let us know if that works for you by adding a comment \ud83d\udc4d\nThis issue has now been marked as stale and will be closed if no further activity occurs. Thank you for your contributions.\nStill an Issue\nStill no fix for this?\nproblem still not solved \r\n\r\n Core 2024.7.3\r\nSupervisor 2024.06.2\r\nOperating System 12.4 \r\n\r\n Unable to enter Zabbix API: {'code': -32602, 'message': 'Invalid params.', 'data': 'Invalid parameter \"/\": unexpected parameter \"user\".', 'json': '{'jsonrpc': '2.0', 'method': 'user.login', 'params': {'user': 'Admin', 'password': '********'}, 'id': '1'}\"}\"}. \nAny chance we could replace the API used to the official [zabbix_utils](https://github.com/zabbix/python-zabbix-utils)?\nSince 2024.9 pyzabbix is no longer available... WTF?", "created_at": "2024-11-26T23:27:20Z"}
{"repo": "home-assistant/core", "pull_number": 131666, "instance_id": "home-assistant__core-131666", "issue_numbers": ["127529"], "base_commit": "055c38a3c819ccfc042a155af7759e39fe0d38c1", "patch": "diff --git a/homeassistant/package_constraints.txt b/homeassistant/package_constraints.txt\nindex 19bfee3c80a519..b11c27489184f2 100644\n--- a/homeassistant/package_constraints.txt\n+++ b/homeassistant/package_constraints.txt\n@@ -197,3 +197,11 @@ tenacity!=8.4.0\n # 5.0.0 breaks Timeout as a context manager\n # TypeError: 'Timeout' object does not support the context manager protocol\n async-timeout==4.0.3\n+\n+# aiofiles keeps getting downgraded by custom components\n+# causing newer methods to not be available and breaking\n+# some integrations at startup\n+# https://github.com/home-assistant/core/issues/127529\n+# https://github.com/home-assistant/core/issues/122508\n+# https://github.com/home-assistant/core/issues/118004\n+aiofiles>=24.1.0\ndiff --git a/script/gen_requirements_all.py b/script/gen_requirements_all.py\nindex e9e4cf5bbb36f1..97ffcac79a467b 100755\n--- a/script/gen_requirements_all.py\n+++ b/script/gen_requirements_all.py\n@@ -230,6 +230,14 @@\n # 5.0.0 breaks Timeout as a context manager\n # TypeError: 'Timeout' object does not support the context manager protocol\n async-timeout==4.0.3\n+\n+# aiofiles keeps getting downgraded by custom components\n+# causing newer methods to not be available and breaking\n+# some integrations at startup\n+# https://github.com/home-assistant/core/issues/127529\n+# https://github.com/home-assistant/core/issues/122508\n+# https://github.com/home-assistant/core/issues/118004\n+aiofiles>=24.1.0\n \"\"\"\n \n GENERATED_MESSAGE = (\n", "test_patch": "", "problem_statement": "failled to setup integration Unifi Protect\n### The problem\n\nUnable to start to Unifi Protect int\u00e9gration after the upgrade to 2024.10.0\n\n### What version of Home Assistant Core has the issue?\n\ncore-2024.10.0\n\n### What was the last working version of Home Assistant Core?\n\ncore-2024.9.3\n\n### What type of installation are you running?\n\nHome Assistant OS\n\n### Integration causing the issue\n\nunifiprotect\n\n### Link to integration documentation on our website\n\nhttps://www.home-assistant.io/integrations/unifiprotect\n\n### Diagnostics information\n\n_No response_\n\n### Example YAML snippet\n\n_No response_\n\n### Anything in the logs that might be useful for us?\n\n```txt\nError setting up entry UDMP for unifiprotect\r\nTraceback (most recent call last):\r\n  File \"/usr/src/homeassistant/homeassistant/config_entries.py\", line 594, in async_setup\r\n    result = await component.async_setup_entry(hass, self)\r\n             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/src/homeassistant/homeassistant/components/unifiprotect/__init__.py\", line 75, in async_setup_entry\r\n    await protect.update()\r\n  File \"/usr/local/lib/python3.12/site-packages/uiprotect/api.py\", line 826, in update\r\n    bootstrap = await self.get_bootstrap()\r\n                ^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/local/lib/python3.12/site-packages/uiprotect/api.py\", line 1176, in get_bootstrap\r\n    data = await self.api_request_obj(\"bootstrap\")\r\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/local/lib/python3.12/site-packages/uiprotect/api.py\", line 476, in api_request_obj\r\n    data = await self.api_request(\r\n           ^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/local/lib/python3.12/site-packages/uiprotect/api.py\", line 450, in api_request\r\n    data = await self.api_request_raw(\r\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/local/lib/python3.12/site-packages/uiprotect/api.py\", line 392, in api_request_raw\r\n    response = await self.request(\r\n               ^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/local/lib/python3.12/site-packages/uiprotect/api.py\", line 328, in request\r\n    await self.ensure_authenticated()\r\n  File \"/usr/local/lib/python3.12/site-packages/uiprotect/api.py\", line 512, in ensure_authenticated\r\n    await self._load_session()\r\n  File \"/usr/local/lib/python3.12/site-packages/uiprotect/api.py\", line 601, in _load_session\r\n    session_cookie = await self._read_auth_config()\r\n                     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/local/lib/python3.12/site-packages/uiprotect/api.py\", line 610, in _read_auth_config\r\n    async with aiofiles.open(self.config_file, \"rb\") as f:\r\n               ^^^^^^^^^^^^^\r\nAttributeError: module 'aiofiles' has no attribute 'open'\n```\n\n\n### Additional information\n\n_No response_\n", "hints_text": "[unifiprotect documentation](https://www.home-assistant.io/integrations/unifiprotect)\n[unifiprotect source](https://github.com/home-assistant/core/tree/dev/homeassistant/components/unifiprotect)\n```\r\nLogger: homeassistant.config_entries\r\nSource: config_entries.py:399\r\nFirst occurred: October 12, 2024 at 12:14:23 AM (4 occurrences)\r\nLast logged: 6:18:35 AM\r\n\r\nError setting up entry UCK G2 Plus for unifiprotect\r\nTraceback (most recent call last):\r\n  File \"/usr/src/homeassistant/homeassistant/config_entries.py\", line 399, in async_setup\r\n    result = await component.async_setup_entry(hass, self)\r\n             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/src/homeassistant/homeassistant/components/unifiprotect/__init__.py\", line 105, in async_setup_entry\r\n    await _async_setup_entry(hass, entry, data_service)\r\n  File \"/usr/src/homeassistant/homeassistant/components/unifiprotect/__init__.py\", line 137, in _async_setup_entry\r\n    await data_service.async_setup()\r\n  File \"/usr/src/homeassistant/homeassistant/components/unifiprotect/data.py\", line 114, in async_setup\r\n    await self.async_refresh()\r\n  File \"/usr/src/homeassistant/homeassistant/components/unifiprotect/data.py\", line 134, in async_refresh\r\n    updates = await self.api.update(force=force)\r\n              ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/local/lib/python3.11/site-packages/pyunifiprotect/api.py\", line 600, in update\r\n    self._bootstrap = await self.get_bootstrap()\r\n                      ^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/local/lib/python3.11/site-packages/pyunifiprotect/api.py\", line 776, in get_bootstrap\r\n    return Bootstrap.from_unifi_dict(**data, api=self)\r\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/local/lib/python3.11/site-packages/pyunifiprotect/data/base.py\", line 124, in from_unifi_dict\r\n    data = cls.unifi_dict_to_dict(data)\r\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/local/lib/python3.11/site-packages/pyunifiprotect/data/bootstrap.py\", line 202, in unifi_dict_to_dict\r\n    return super().unifi_dict_to_dict(data)\r\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/local/lib/python3.11/site-packages/pyunifiprotect/data/base.py\", line 356, in unifi_dict_to_dict\r\n    data[key] = cls._clean_protect_obj_dict(data[key], unifi_dicts[key], api)\r\n                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/local/lib/python3.11/site-packages/pyunifiprotect/data/base.py\", line 302, in _clean_protect_obj_dict\r\n    items[key] = cls._clean_protect_obj(value, klass, api)\r\n                 ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/local/lib/python3.11/site-packages/pyunifiprotect/data/base.py\", line 286, in _clean_protect_obj\r\n    return klass.unifi_dict_to_dict(data=data)\r\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/local/lib/python3.11/site-packages/pyunifiprotect/data/user.py\", line 70, in unifi_dict_to_dict\r\n    return super().unifi_dict_to_dict(data)\r\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/local/lib/python3.11/site-packages/pyunifiprotect/data/base.py\", line 351, in unifi_dict_to_dict\r\n    data[key] = cls._clean_protect_obj_list(data[key], unifi_lists[key], api)\r\n                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/local/lib/python3.11/site-packages/pyunifiprotect/data/base.py\", line 294, in _clean_protect_obj_list\r\n    items[index] = cls._clean_protect_obj(item, klass, api)\r\n                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/local/lib/python3.11/site-packages/pyunifiprotect/data/base.py\", line 286, in _clean_protect_obj\r\n    return klass.unifi_dict_to_dict(data=data)\r\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/local/lib/python3.11/site-packages/pyunifiprotect/data/user.py\", line 34, in unifi_dict_to_dict\r\n    data[\"nodes\"] = [PermissionNode(n) for n in parts[1].split(\",\")]\r\n                    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/local/lib/python3.11/site-packages/pyunifiprotect/data/user.py\", line 34, in <listcomp>\r\n    data[\"nodes\"] = [PermissionNode(n) for n in parts[1].split(\",\")]\r\n                     ^^^^^^^^^^^^^^^^^\r\n  File \"/usr/local/lib/python3.11/enum.py\", line 712, in __call__\r\n    return cls.__new__(cls, value)\r\n           ^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/local/lib/python3.11/enum.py\", line 1128, in __new__\r\n    raise ve_exc\r\nValueError: 'readlive' is not a valid PermissionNode\r\n\r\n```\r\n\r\nSame but different problem for me\nI have something similar starting with 2024.10.0 and seems to continue in 2024.11.1:\r\n\r\n```\r\nLogger: homeassistant.config_entries\r\nSource: config_entries.py:635\r\nFirst occurred: 12:18:36 PM (2 occurrences)\r\nLast logged: 12:23:48 PM\r\n\r\nError setting up entry Dream Machine Professional for unifiprotect\r\nTraceback (most recent call last):\r\n  File \"/usr/src/homeassistant/homeassistant/config_entries.py\", line 635, in __async_setup_with_context\r\n    result = await component.async_setup_entry(hass, self)\r\n             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/src/homeassistant/homeassistant/components/unifiprotect/__init__.py\", line 75, in async_setup_entry\r\n    await protect.update()\r\n  File \"/usr/local/lib/python3.12/site-packages/uiprotect/api.py\", line 827, in update\r\n    bootstrap = await self.get_bootstrap()\r\n                ^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/local/lib/python3.12/site-packages/uiprotect/api.py\", line 1177, in get_bootstrap\r\n    data = await self.api_request_obj(\"bootstrap\")\r\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/local/lib/python3.12/site-packages/uiprotect/api.py\", line 477, in api_request_obj\r\n    data = await self.api_request(\r\n           ^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/local/lib/python3.12/site-packages/uiprotect/api.py\", line 451, in api_request\r\n    data = await self.api_request_raw(\r\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/local/lib/python3.12/site-packages/uiprotect/api.py\", line 393, in api_request_raw\r\n    response = await self.request(\r\n               ^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/local/lib/python3.12/site-packages/uiprotect/api.py\", line 329, in request\r\n    await self.ensure_authenticated()\r\n  File \"/usr/local/lib/python3.12/site-packages/uiprotect/api.py\", line 515, in ensure_authenticated\r\n    await self.authenticate()\r\n  File \"/usr/local/lib/python3.12/site-packages/uiprotect/api.py\", line 538, in authenticate\r\n    response = await self.request(\"post\", url=url, json=auth)\r\n               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/local/lib/python3.12/site-packages/uiprotect/api.py\", line 350, in request\r\n    await self._update_last_token_cookie(response)\r\n  File \"/usr/local/lib/python3.12/site-packages/uiprotect/api.py\", line 554, in _update_last_token_cookie\r\n    await self._update_last_token_cookie(response)\r\n  File \"/usr/local/lib/python3.12/site-packages/uiprotect/api.py\", line 562, in _update_last_token_cookie\r\n    await self._update_auth_config(self._last_token_cookie)\r\n  File \"/usr/local/lib/python3.12/site-packages/uiprotect/api.py\", line 570, in _update_auth_config\r\n    await aos.makedirs(self.config_dir, exist_ok=True)\r\n          ^^^^^^^^^^^^\r\nAttributeError: module 'aiofiles.os' has no attribute 'makedirs'\r\n```\nI'm having the same problem, here is log file from most recent attempt to setup:\r\n[home-assistant_unifiprotect_2024-11-19T20-40-22.918Z.log](https://github.com/user-attachments/files/17821212/home-assistant_unifiprotect_2024-11-19T20-40-22.918Z.log)\r\n\n@PoVPoV29 @brthrsam @jeremyroberts0 \r\nErrors like AttributeError: module 'aiofiles.os' has no attribute 'makedirs' are usually related to dependency issues where the installed version of a library is incompatible or outdated. (I'm new to the Python world and am drawing on my experience from the Java world, but the concept should be analogous.)\r\n\r\nInterestingly, I also came across the following issue: [GitHub - Home Assistant Core Issue #118004](https://github.com/home-assistant/core/issues/118004). If I had to guess, it might be related to some HACS plugin that is no longer maintained.\n>   File \"/usr/local/lib/python3.11/site-packages/**_pyunifiprotect_**/data/user.py\", line 34, in <listcomp>\r\n>     data[\"nodes\"] = [PermissionNode(n) for n in parts[1].split(\",\")]\r\n>                      ^^^^^^^^^^^^^^^^^\r\n>   File \"/usr/local/lib/python3.11/enum.py\", line 712, in __call__\r\n>     return cls.__new__(cls, value)\r\n>            ^^^^^^^^^^^^^^^^^^^^^^^\r\n>   File \"/usr/local/lib/python3.11/enum.py\", line 1128, in __new__\r\n>     raise ve_exc\r\n> ValueError: '**_readlive_**' is not a valid PermissionNode\r\n> ```\r\n> \r\n> Same but different problem for me\r\n\r\n@LVLAaron  Looking at the stack trace, it seems like you're running an outdated Home Assistant installation that still relies on the old Protect library. However, your Protect app appears to be using the new readlive permission, which leads to an API incompatibility.\r\n\r\nUpdating Home Assistant to the latest version should resolve this issue. \n> > File \"/usr/local/lib/python3.11/site-packages/**_pyunifiprotect_**/data/user.py\", line 34, in \r\n> > data[\"nodes\"] = [PermissionNode(n) for n in parts[1].split(\",\")]\r\n> > ^^^^^^^^^^^^^^^^^\r\n> > File \"/usr/local/lib/python3.11/enum.py\", line 712, in **call**\r\n> > return cls.**new**(cls, value)\r\n> > ^^^^^^^^^^^^^^^^^^^^^^^\r\n> > File \"/usr/local/lib/python3.11/enum.py\", line 1128, in **new**\r\n> > raise ve_exc\r\n> > ValueError: '**_readlive_**' is not a valid PermissionNode\r\n> > ```\r\n> > \r\n> > Same but different problem for me\r\n> > ```\r\n> \r\n> @LVLAaron Looking at the stack trace, it seems like you're running an outdated Home Assistant installation that still relies on the old Protect library. However, your Protect app appears to be using the new readlive permission, which leads to an API incompatibility.\r\n> \r\n> Updating Home Assistant to the latest version should resolve this issue.\r\n\r\nWow.. yeah I do. I was trying to do something else and getting errors about not being able to reach the internet... I had to jiggle the IP address back and forth, reboot, and then I magically had lots of updates to do. \r\n\r\nEverything seems to be working now! \nProbably need to add a constraint for a minimum aiofiles version to prevent custom integrations from downgrading it to a non-working older version.", "created_at": "2024-11-26T20:43:07Z"}
{"repo": "home-assistant/core", "pull_number": 131660, "instance_id": "home-assistant__core-131660", "issue_numbers": ["129443"], "base_commit": "aa206c76087715e2eef82c2ef2c9389101018f78", "patch": "diff --git a/homeassistant/components/homekit/__init__.py b/homeassistant/components/homekit/__init__.py\nindex b85308ffd6635c..97fb17d7db5527 100644\n--- a/homeassistant/components/homekit/__init__.py\n+++ b/homeassistant/components/homekit/__init__.py\n@@ -33,6 +33,7 @@\n from homeassistant.components.event import DOMAIN as EVENT_DOMAIN, EventDeviceClass\n from homeassistant.components.http import KEY_HASS, HomeAssistantView\n from homeassistant.components.humidifier import DOMAIN as HUMIDIFIER_DOMAIN\n+from homeassistant.components.lock import DOMAIN as LOCK_DOMAIN\n from homeassistant.components.sensor import DOMAIN as SENSOR_DOMAIN, SensorDeviceClass\n from homeassistant.config_entries import SOURCE_IMPORT, ConfigEntry\n from homeassistant.const import (\n@@ -1133,6 +1134,8 @@ def _async_configure_linked_sensors(\n                 config[entity_id].setdefault(\n                     CONF_LINKED_MOTION_SENSOR, motion_binary_sensor_entity_id\n                 )\n+\n+        if domain in (CAMERA_DOMAIN, LOCK_DOMAIN):\n             if doorbell_event_entity_id := lookup.get(DOORBELL_EVENT_SENSOR):\n                 config[entity_id].setdefault(\n                     CONF_LINKED_DOORBELL_SENSOR, doorbell_event_entity_id\ndiff --git a/homeassistant/components/homekit/doorbell.py b/homeassistant/components/homekit/doorbell.py\nnew file mode 100644\nindex 00000000000000..45bbb2ea0ca758\n--- /dev/null\n+++ b/homeassistant/components/homekit/doorbell.py\n@@ -0,0 +1,121 @@\n+\"\"\"Extend the doorbell functions.\"\"\"\n+\n+from __future__ import annotations\n+\n+import logging\n+from typing import Any\n+\n+from pyhap.util import callback as pyhap_callback\n+\n+from homeassistant.const import STATE_ON, STATE_UNAVAILABLE, STATE_UNKNOWN\n+from homeassistant.core import (\n+    Event,\n+    EventStateChangedData,\n+    HassJobType,\n+    State,\n+    callback as ha_callback,\n+)\n+from homeassistant.helpers.event import async_track_state_change_event\n+\n+from .accessories import HomeAccessory\n+from .const import (\n+    CHAR_MUTE,\n+    CHAR_PROGRAMMABLE_SWITCH_EVENT,\n+    CONF_LINKED_DOORBELL_SENSOR,\n+    SERV_DOORBELL,\n+    SERV_SPEAKER,\n+    SERV_STATELESS_PROGRAMMABLE_SWITCH,\n+)\n+from .util import state_changed_event_is_same_state\n+\n+_LOGGER = logging.getLogger(__name__)\n+\n+DOORBELL_SINGLE_PRESS = 0\n+DOORBELL_DOUBLE_PRESS = 1\n+DOORBELL_LONG_PRESS = 2\n+\n+\n+class HomeDoorbellAccessory(HomeAccessory):\n+    \"\"\"Accessory with optional doorbell.\"\"\"\n+\n+    def __init__(self, *args: Any, **kwargs: Any) -> None:\n+        \"\"\"Initialize an Accessory object with optional attached doorbell.\"\"\"\n+        super().__init__(*args, **kwargs)\n+        self._char_doorbell_detected = None\n+        self._char_doorbell_detected_switch = None\n+        linked_doorbell_sensor: str | None\n+        linked_doorbell_sensor = self.config.get(CONF_LINKED_DOORBELL_SENSOR)\n+        self.linked_doorbell_sensor = linked_doorbell_sensor\n+        self.doorbell_is_event = False\n+        if not linked_doorbell_sensor:\n+            return\n+        self.doorbell_is_event = linked_doorbell_sensor.startswith(\"event.\")\n+        if not (state := self.hass.states.get(linked_doorbell_sensor)):\n+            return\n+        serv_doorbell = self.add_preload_service(SERV_DOORBELL)\n+        self.set_primary_service(serv_doorbell)\n+        self._char_doorbell_detected = serv_doorbell.configure_char(\n+            CHAR_PROGRAMMABLE_SWITCH_EVENT,\n+            value=0,\n+        )\n+        serv_stateless_switch = self.add_preload_service(\n+            SERV_STATELESS_PROGRAMMABLE_SWITCH\n+        )\n+        self._char_doorbell_detected_switch = serv_stateless_switch.configure_char(\n+            CHAR_PROGRAMMABLE_SWITCH_EVENT,\n+            value=0,\n+            valid_values={\"SinglePress\": DOORBELL_SINGLE_PRESS},\n+        )\n+        serv_speaker = self.add_preload_service(SERV_SPEAKER)\n+        serv_speaker.configure_char(CHAR_MUTE, value=0)\n+        self.async_update_doorbell_state(None, state)\n+\n+    @ha_callback\n+    @pyhap_callback  # type: ignore[misc]\n+    def run(self) -> None:\n+        \"\"\"Handle doorbell event.\"\"\"\n+        if self._char_doorbell_detected:\n+            assert self.linked_doorbell_sensor\n+            self._subscriptions.append(\n+                async_track_state_change_event(\n+                    self.hass,\n+                    self.linked_doorbell_sensor,\n+                    self.async_update_doorbell_state_event,\n+                    job_type=HassJobType.Callback,\n+                )\n+            )\n+\n+        super().run()\n+\n+    @ha_callback\n+    def async_update_doorbell_state_event(\n+        self, event: Event[EventStateChangedData]\n+    ) -> None:\n+        \"\"\"Handle state change event listener callback.\"\"\"\n+        if not state_changed_event_is_same_state(event) and (\n+            new_state := event.data[\"new_state\"]\n+        ):\n+            self.async_update_doorbell_state(event.data[\"old_state\"], new_state)\n+\n+    @ha_callback\n+    def async_update_doorbell_state(\n+        self, old_state: State | None, new_state: State\n+    ) -> None:\n+        \"\"\"Handle link doorbell sensor state change to update HomeKit value.\"\"\"\n+        assert self._char_doorbell_detected\n+        assert self._char_doorbell_detected_switch\n+        state = new_state.state\n+        if state == STATE_ON or (\n+            self.doorbell_is_event\n+            and old_state is not None\n+            and old_state.state != STATE_UNAVAILABLE\n+            and state not in (STATE_UNKNOWN, STATE_UNAVAILABLE)\n+        ):\n+            self._char_doorbell_detected.set_value(DOORBELL_SINGLE_PRESS)\n+            self._char_doorbell_detected_switch.set_value(DOORBELL_SINGLE_PRESS)\n+            _LOGGER.debug(\n+                \"%s: Set linked doorbell %s sensor to %d\",\n+                self.entity_id,\n+                self.linked_doorbell_sensor,\n+                DOORBELL_SINGLE_PRESS,\n+            )\ndiff --git a/homeassistant/components/homekit/type_cameras.py b/homeassistant/components/homekit/type_cameras.py\nindex 9e076f7d4d788b..0fb2c2e792264b 100644\n--- a/homeassistant/components/homekit/type_cameras.py\n+++ b/homeassistant/components/homekit/type_cameras.py\n@@ -31,15 +31,12 @@\n )\n from homeassistant.util.async_ import create_eager_task\n \n-from .accessories import TYPES, HomeAccessory, HomeDriver\n+from .accessories import TYPES, HomeDriver\n from .const import (\n     CHAR_MOTION_DETECTED,\n-    CHAR_MUTE,\n-    CHAR_PROGRAMMABLE_SWITCH_EVENT,\n     CONF_AUDIO_CODEC,\n     CONF_AUDIO_MAP,\n     CONF_AUDIO_PACKET_SIZE,\n-    CONF_LINKED_DOORBELL_SENSOR,\n     CONF_LINKED_MOTION_SENSOR,\n     CONF_MAX_FPS,\n     CONF_MAX_HEIGHT,\n@@ -64,18 +61,13 @@\n     DEFAULT_VIDEO_MAP,\n     DEFAULT_VIDEO_PACKET_SIZE,\n     DEFAULT_VIDEO_PROFILE_NAMES,\n-    SERV_DOORBELL,\n     SERV_MOTION_SENSOR,\n-    SERV_SPEAKER,\n-    SERV_STATELESS_PROGRAMMABLE_SWITCH,\n )\n+from .doorbell import HomeDoorbellAccessory\n from .util import pid_is_alive, state_changed_event_is_same_state\n \n _LOGGER = logging.getLogger(__name__)\n \n-DOORBELL_SINGLE_PRESS = 0\n-DOORBELL_DOUBLE_PRESS = 1\n-DOORBELL_LONG_PRESS = 2\n \n VIDEO_OUTPUT = (\n     \"-map {v_map} -an \"\n@@ -149,7 +141,7 @@\n @TYPES.register(\"Camera\")\n # False-positive on pylint, not a CameraEntity\n # pylint: disable-next=hass-enforce-class-module\n-class Camera(HomeAccessory, PyhapCamera):  # type: ignore[misc]\n+class Camera(HomeDoorbellAccessory, PyhapCamera):  # type: ignore[misc]\n     \"\"\"Generate a Camera accessory.\"\"\"\n \n     def __init__(\n@@ -237,36 +229,6 @@ def __init__(\n                 )\n                 self._async_update_motion_state(None, state)\n \n-        self._char_doorbell_detected = None\n-        self._char_doorbell_detected_switch = None\n-        linked_doorbell_sensor: str | None = self.config.get(\n-            CONF_LINKED_DOORBELL_SENSOR\n-        )\n-        self.linked_doorbell_sensor = linked_doorbell_sensor\n-        self.doorbell_is_event = False\n-        if not linked_doorbell_sensor:\n-            return\n-        self.doorbell_is_event = linked_doorbell_sensor.startswith(\"event.\")\n-        if not (state := self.hass.states.get(linked_doorbell_sensor)):\n-            return\n-        serv_doorbell = self.add_preload_service(SERV_DOORBELL)\n-        self.set_primary_service(serv_doorbell)\n-        self._char_doorbell_detected = serv_doorbell.configure_char(\n-            CHAR_PROGRAMMABLE_SWITCH_EVENT,\n-            value=0,\n-        )\n-        serv_stateless_switch = self.add_preload_service(\n-            SERV_STATELESS_PROGRAMMABLE_SWITCH\n-        )\n-        self._char_doorbell_detected_switch = serv_stateless_switch.configure_char(\n-            CHAR_PROGRAMMABLE_SWITCH_EVENT,\n-            value=0,\n-            valid_values={\"SinglePress\": DOORBELL_SINGLE_PRESS},\n-        )\n-        serv_speaker = self.add_preload_service(SERV_SPEAKER)\n-        serv_speaker.configure_char(CHAR_MUTE, value=0)\n-        self._async_update_doorbell_state(None, state)\n-\n     @pyhap_callback  # type: ignore[misc]\n     @callback\n     def run(self) -> None:\n@@ -285,17 +247,6 @@ def run(self) -> None:\n                 )\n             )\n \n-        if self._char_doorbell_detected:\n-            assert self.linked_doorbell_sensor\n-            self._subscriptions.append(\n-                async_track_state_change_event(\n-                    self.hass,\n-                    self.linked_doorbell_sensor,\n-                    self._async_update_doorbell_state_event,\n-                    job_type=HassJobType.Callback,\n-                )\n-            )\n-\n         super().run()\n \n     @callback\n@@ -344,39 +295,6 @@ def _async_update_motion_state(\n             detected,\n         )\n \n-    @callback\n-    def _async_update_doorbell_state_event(\n-        self, event: Event[EventStateChangedData]\n-    ) -> None:\n-        \"\"\"Handle state change event listener callback.\"\"\"\n-        if not state_changed_event_is_same_state(event) and (\n-            new_state := event.data[\"new_state\"]\n-        ):\n-            self._async_update_doorbell_state(event.data[\"old_state\"], new_state)\n-\n-    @callback\n-    def _async_update_doorbell_state(\n-        self, old_state: State | None, new_state: State\n-    ) -> None:\n-        \"\"\"Handle link doorbell sensor state change to update HomeKit value.\"\"\"\n-        assert self._char_doorbell_detected\n-        assert self._char_doorbell_detected_switch\n-        state = new_state.state\n-        if state == STATE_ON or (\n-            self.doorbell_is_event\n-            and old_state is not None\n-            and old_state.state != STATE_UNAVAILABLE\n-            and state not in (STATE_UNKNOWN, STATE_UNAVAILABLE)\n-        ):\n-            self._char_doorbell_detected.set_value(DOORBELL_SINGLE_PRESS)\n-            self._char_doorbell_detected_switch.set_value(DOORBELL_SINGLE_PRESS)\n-            _LOGGER.debug(\n-                \"%s: Set linked doorbell %s sensor to %d\",\n-                self.entity_id,\n-                self.linked_doorbell_sensor,\n-                DOORBELL_SINGLE_PRESS,\n-            )\n-\n     @callback\n     def async_update_state(self, new_state: State | None) -> None:\n         \"\"\"Handle state change to update HomeKit value.\"\"\"\ndiff --git a/homeassistant/components/homekit/type_locks.py b/homeassistant/components/homekit/type_locks.py\nindex 70570a8fca55ba..59da802b8b7b71 100644\n--- a/homeassistant/components/homekit/type_locks.py\n+++ b/homeassistant/components/homekit/type_locks.py\n@@ -9,8 +9,9 @@\n from homeassistant.const import ATTR_CODE, ATTR_ENTITY_ID, STATE_UNKNOWN\n from homeassistant.core import State, callback\n \n-from .accessories import TYPES, HomeAccessory\n+from .accessories import TYPES\n from .const import CHAR_LOCK_CURRENT_STATE, CHAR_LOCK_TARGET_STATE, SERV_LOCK\n+from .doorbell import HomeDoorbellAccessory\n \n _LOGGER = logging.getLogger(__name__)\n \n@@ -53,7 +54,7 @@\n \n \n @TYPES.register(\"Lock\")\n-class Lock(HomeAccessory):\n+class Lock(HomeDoorbellAccessory):\n     \"\"\"Generate a Lock accessory for a lock entity.\n \n     The lock entity must support: unlock and lock.\ndiff --git a/homeassistant/components/homekit/util.py b/homeassistant/components/homekit/util.py\nindex ae7e35030be297..b255d4c79dd377 100644\n--- a/homeassistant/components/homekit/util.py\n+++ b/homeassistant/components/homekit/util.py\n@@ -182,7 +182,6 @@\n     {vol.Optional(CONF_LINKED_HUMIDITY_SENSOR): cv.entity_domain(sensor.DOMAIN)}\n )\n \n-\n COVER_SCHEMA = BASIC_INFO_SCHEMA.extend(\n     {\n         vol.Optional(CONF_LINKED_OBSTRUCTION_SENSOR): cv.entity_domain(\n@@ -195,6 +194,14 @@\n     {vol.Optional(ATTR_CODE, default=None): vol.Any(None, cv.string)}\n )\n \n+LOCK_SCHEMA = CODE_SCHEMA.extend(\n+    {\n+        vol.Optional(CONF_LINKED_DOORBELL_SENSOR): cv.entity_domain(\n+            [binary_sensor.DOMAIN, EVENT_DOMAIN]\n+        ),\n+    }\n+)\n+\n MEDIA_PLAYER_SCHEMA = vol.Schema(\n     {\n         vol.Required(CONF_FEATURE): vol.All(\n@@ -284,7 +291,7 @@ def validate_entity_config(values: dict) -> dict[str, dict]:\n         if not isinstance(config, dict):\n             raise vol.Invalid(f\"The configuration for {entity} must be a dictionary.\")\n \n-        if domain in (\"alarm_control_panel\", \"lock\"):\n+        if domain == \"alarm_control_panel\":\n             config = CODE_SCHEMA(config)\n \n         elif domain == media_player.const.DOMAIN:\n@@ -301,6 +308,9 @@ def validate_entity_config(values: dict) -> dict[str, dict]:\n         elif domain == \"camera\":\n             config = CAMERA_SCHEMA(config)\n \n+        elif domain == \"lock\":\n+            config = LOCK_SCHEMA(config)\n+\n         elif domain == \"switch\":\n             config = SWITCH_TYPE_SCHEMA(config)\n \n", "test_patch": "diff --git a/tests/components/homekit/test_type_locks.py b/tests/components/homekit/test_type_locks.py\nindex 2961fe52170757..7691e341dcc94d 100644\n--- a/tests/components/homekit/test_type_locks.py\n+++ b/tests/components/homekit/test_type_locks.py\n@@ -1,17 +1,34 @@\n \"\"\"Test different accessory types: Locks.\"\"\"\n \n+from unittest.mock import MagicMock\n+\n import pytest\n \n-from homeassistant.components.homekit.const import ATTR_VALUE\n+from homeassistant.components import lock\n+from homeassistant.components.binary_sensor import BinarySensorDeviceClass\n+from homeassistant.components.event import EventDeviceClass\n+from homeassistant.components.homekit.accessories import HomeBridge\n+from homeassistant.components.homekit.const import (\n+    ATTR_VALUE,\n+    CHAR_PROGRAMMABLE_SWITCH_EVENT,\n+    CONF_LINKED_DOORBELL_SENSOR,\n+    SERV_DOORBELL,\n+    SERV_STATELESS_PROGRAMMABLE_SWITCH,\n+)\n from homeassistant.components.homekit.type_locks import Lock\n from homeassistant.components.lock import DOMAIN as LOCK_DOMAIN, LockState\n from homeassistant.const import (\n     ATTR_CODE,\n+    ATTR_DEVICE_CLASS,\n     ATTR_ENTITY_ID,\n+    STATE_OFF,\n+    STATE_ON,\n     STATE_UNAVAILABLE,\n     STATE_UNKNOWN,\n )\n from homeassistant.core import Event, HomeAssistant\n+from homeassistant.setup import async_setup_component\n+from homeassistant.util import dt as dt_util\n \n from tests.common import async_mock_service\n \n@@ -135,3 +152,285 @@ async def test_no_code(\n     assert acc.char_target_state.value == 1\n     assert len(events) == 1\n     assert events[-1].data[ATTR_VALUE] is None\n+\n+\n+async def test_lock_with_linked_doorbell_sensor(hass: HomeAssistant, hk_driver) -> None:\n+    \"\"\"Test a lock with a linked doorbell sensor can update.\"\"\"\n+    code = \"1234\"\n+    await async_setup_component(hass, lock.DOMAIN, {lock.DOMAIN: {\"platform\": \"demo\"}})\n+    await hass.async_block_till_done()\n+    doorbell_entity_id = \"binary_sensor.doorbell\"\n+\n+    hass.states.async_set(\n+        doorbell_entity_id,\n+        STATE_ON,\n+        {ATTR_DEVICE_CLASS: BinarySensorDeviceClass.OCCUPANCY},\n+    )\n+    await hass.async_block_till_done()\n+    entity_id = \"lock.demo_lock\"\n+\n+    hass.states.async_set(entity_id, None)\n+    await hass.async_block_till_done()\n+    acc = Lock(\n+        hass,\n+        hk_driver,\n+        \"Lock\",\n+        entity_id,\n+        2,\n+        {\n+            ATTR_CODE: code,\n+            CONF_LINKED_DOORBELL_SENSOR: doorbell_entity_id,\n+        },\n+    )\n+    bridge = HomeBridge(\"hass\", hk_driver, \"Test Bridge\")\n+    bridge.add_accessory(acc)\n+\n+    acc.run()\n+\n+    assert acc.aid == 2\n+    assert acc.category == 6  # DoorLock\n+\n+    service = acc.get_service(SERV_DOORBELL)\n+    assert service\n+    char = service.get_characteristic(CHAR_PROGRAMMABLE_SWITCH_EVENT)\n+    assert char\n+\n+    assert char.value is None\n+\n+    service2 = acc.get_service(SERV_STATELESS_PROGRAMMABLE_SWITCH)\n+    assert service2\n+    char2 = service.get_characteristic(CHAR_PROGRAMMABLE_SWITCH_EVENT)\n+    assert char2\n+    broker = MagicMock()\n+    char2.broker = broker\n+    assert char2.value is None\n+\n+    hass.states.async_set(\n+        doorbell_entity_id,\n+        STATE_OFF,\n+        {ATTR_DEVICE_CLASS: BinarySensorDeviceClass.OCCUPANCY},\n+    )\n+    await hass.async_block_till_done()\n+    assert char.value is None\n+    assert char2.value is None\n+    assert len(broker.mock_calls) == 0\n+\n+    char.set_value(True)\n+    char2.set_value(True)\n+    broker.reset_mock()\n+\n+    hass.states.async_set(\n+        doorbell_entity_id,\n+        STATE_ON,\n+        {ATTR_DEVICE_CLASS: BinarySensorDeviceClass.OCCUPANCY},\n+    )\n+    await hass.async_block_till_done()\n+    assert char.value is None\n+    assert char2.value is None\n+    assert len(broker.mock_calls) == 2\n+    broker.reset_mock()\n+\n+    hass.states.async_set(\n+        doorbell_entity_id,\n+        STATE_ON,\n+        {ATTR_DEVICE_CLASS: BinarySensorDeviceClass.OCCUPANCY},\n+        force_update=True,\n+    )\n+    await hass.async_block_till_done()\n+    assert char.value is None\n+    assert char2.value is None\n+    assert len(broker.mock_calls) == 0\n+    broker.reset_mock()\n+\n+    hass.states.async_set(\n+        doorbell_entity_id,\n+        STATE_ON,\n+        {ATTR_DEVICE_CLASS: BinarySensorDeviceClass.OCCUPANCY, \"other\": \"attr\"},\n+    )\n+    await hass.async_block_till_done()\n+    assert char.value is None\n+    assert char2.value is None\n+    assert len(broker.mock_calls) == 0\n+    broker.reset_mock()\n+\n+    # Ensure we do not throw when the linked\n+    # doorbell sensor is removed\n+    hass.states.async_remove(doorbell_entity_id)\n+    await hass.async_block_till_done()\n+    acc.run()\n+    await hass.async_block_till_done()\n+    assert char.value is None\n+    assert char2.value is None\n+\n+\n+async def test_lock_with_linked_doorbell_event(hass: HomeAssistant, hk_driver) -> None:\n+    \"\"\"Test a lock with a linked doorbell event can update.\"\"\"\n+    await async_setup_component(hass, lock.DOMAIN, {lock.DOMAIN: {\"platform\": \"demo\"}})\n+    await hass.async_block_till_done()\n+    doorbell_entity_id = \"event.doorbell\"\n+    code = \"1234\"\n+\n+    hass.states.async_set(\n+        doorbell_entity_id,\n+        dt_util.utcnow().isoformat(),\n+        {ATTR_DEVICE_CLASS: EventDeviceClass.DOORBELL},\n+    )\n+    await hass.async_block_till_done()\n+    entity_id = \"lock.demo_lock\"\n+\n+    hass.states.async_set(entity_id, None)\n+    await hass.async_block_till_done()\n+    acc = Lock(\n+        hass,\n+        hk_driver,\n+        \"Lock\",\n+        entity_id,\n+        2,\n+        {\n+            ATTR_CODE: code,\n+            CONF_LINKED_DOORBELL_SENSOR: doorbell_entity_id,\n+        },\n+    )\n+    bridge = HomeBridge(\"hass\", hk_driver, \"Test Bridge\")\n+    bridge.add_accessory(acc)\n+\n+    acc.run()\n+\n+    assert acc.aid == 2\n+    assert acc.category == 6  # DoorLock\n+\n+    service = acc.get_service(SERV_DOORBELL)\n+    assert service\n+    char = service.get_characteristic(CHAR_PROGRAMMABLE_SWITCH_EVENT)\n+    assert char\n+\n+    assert char.value is None\n+\n+    service2 = acc.get_service(SERV_STATELESS_PROGRAMMABLE_SWITCH)\n+    assert service2\n+    char2 = service.get_characteristic(CHAR_PROGRAMMABLE_SWITCH_EVENT)\n+    assert char2\n+    broker = MagicMock()\n+    char2.broker = broker\n+    assert char2.value is None\n+\n+    hass.states.async_set(\n+        doorbell_entity_id,\n+        STATE_UNKNOWN,\n+        {ATTR_DEVICE_CLASS: EventDeviceClass.DOORBELL},\n+    )\n+    await hass.async_block_till_done()\n+    assert char.value is None\n+    assert char2.value is None\n+    assert len(broker.mock_calls) == 0\n+\n+    char.set_value(True)\n+    char2.set_value(True)\n+    broker.reset_mock()\n+\n+    original_time = dt_util.utcnow().isoformat()\n+    hass.states.async_set(\n+        doorbell_entity_id,\n+        original_time,\n+        {ATTR_DEVICE_CLASS: EventDeviceClass.DOORBELL},\n+    )\n+    await hass.async_block_till_done()\n+    assert char.value is None\n+    assert char2.value is None\n+    assert len(broker.mock_calls) == 2\n+    broker.reset_mock()\n+\n+    hass.states.async_set(\n+        doorbell_entity_id,\n+        original_time,\n+        {ATTR_DEVICE_CLASS: EventDeviceClass.DOORBELL},\n+        force_update=True,\n+    )\n+    await hass.async_block_till_done()\n+    assert char.value is None\n+    assert char2.value is None\n+    assert len(broker.mock_calls) == 0\n+    broker.reset_mock()\n+\n+    hass.states.async_set(\n+        doorbell_entity_id,\n+        original_time,\n+        {ATTR_DEVICE_CLASS: EventDeviceClass.DOORBELL, \"other\": \"attr\"},\n+    )\n+    await hass.async_block_till_done()\n+    assert char.value is None\n+    assert char2.value is None\n+    assert len(broker.mock_calls) == 0\n+    broker.reset_mock()\n+\n+    # Ensure we do not throw when the linked\n+    # doorbell sensor is removed\n+    hass.states.async_remove(doorbell_entity_id)\n+    await hass.async_block_till_done()\n+    acc.run()\n+    await hass.async_block_till_done()\n+    assert char.value is None\n+    assert char2.value is None\n+\n+    await hass.async_block_till_done()\n+    hass.states.async_set(\n+        doorbell_entity_id,\n+        STATE_UNAVAILABLE,\n+        {ATTR_DEVICE_CLASS: EventDeviceClass.DOORBELL},\n+    )\n+    await hass.async_block_till_done()\n+    # Ensure re-adding does not fire an event\n+    assert not broker.mock_calls\n+    broker.reset_mock()\n+\n+    # going from unavailable to a state should not fire an event\n+    hass.states.async_set(\n+        doorbell_entity_id,\n+        dt_util.utcnow().isoformat(),\n+        {ATTR_DEVICE_CLASS: EventDeviceClass.DOORBELL},\n+    )\n+    await hass.async_block_till_done()\n+    assert not broker.mock_calls\n+\n+    # But a second update does\n+    hass.states.async_set(\n+        doorbell_entity_id,\n+        dt_util.utcnow().isoformat(),\n+        {ATTR_DEVICE_CLASS: EventDeviceClass.DOORBELL},\n+    )\n+    await hass.async_block_till_done()\n+    assert broker.mock_calls\n+\n+\n+async def test_lock_with_a_missing_linked_doorbell_sensor(\n+    hass: HomeAssistant, hk_driver\n+) -> None:\n+    \"\"\"Test a lock with a configured linked doorbell sensor that is missing.\"\"\"\n+    await async_setup_component(hass, lock.DOMAIN, {lock.DOMAIN: {\"platform\": \"demo\"}})\n+    await hass.async_block_till_done()\n+    code = \"1234\"\n+    doorbell_entity_id = \"binary_sensor.doorbell\"\n+    entity_id = \"lock.demo_lock\"\n+    hass.states.async_set(entity_id, None)\n+    await hass.async_block_till_done()\n+    acc = Lock(\n+        hass,\n+        hk_driver,\n+        \"Lock\",\n+        entity_id,\n+        2,\n+        {\n+            ATTR_CODE: code,\n+            CONF_LINKED_DOORBELL_SENSOR: doorbell_entity_id,\n+        },\n+    )\n+    bridge = HomeBridge(\"hass\", hk_driver, \"Test Bridge\")\n+    bridge.add_accessory(acc)\n+\n+    acc.run()\n+\n+    assert acc.aid == 2\n+    assert acc.category == 6  # DoorLock\n+\n+    assert not acc.get_service(SERV_DOORBELL)\n+    assert not acc.get_service(SERV_STATELESS_PROGRAMMABLE_SWITCH)\ndiff --git a/tests/components/homekit/test_util.py b/tests/components/homekit/test_util.py\nindex 7f7e3ee0ce080a..ebd260de05406a 100644\n--- a/tests/components/homekit/test_util.py\n+++ b/tests/components/homekit/test_util.py\n@@ -159,8 +159,20 @@ def test_validate_entity_config() -> None:\n     assert vec({\"lock.demo\": {}}) == {\n         \"lock.demo\": {ATTR_CODE: None, CONF_LOW_BATTERY_THRESHOLD: 20}\n     }\n-    assert vec({\"lock.demo\": {ATTR_CODE: \"1234\"}}) == {\n-        \"lock.demo\": {ATTR_CODE: \"1234\", CONF_LOW_BATTERY_THRESHOLD: 20}\n+\n+    assert vec(\n+        {\n+            \"lock.demo\": {\n+                ATTR_CODE: \"1234\",\n+                CONF_LINKED_DOORBELL_SENSOR: \"event.doorbell\",\n+            }\n+        }\n+    ) == {\n+        \"lock.demo\": {\n+            ATTR_CODE: \"1234\",\n+            CONF_LOW_BATTERY_THRESHOLD: 20,\n+            CONF_LINKED_DOORBELL_SENSOR: \"event.doorbell\",\n+        }\n     }\n \n     assert vec({\"media_player.demo\": {}}) == {\n", "problem_statement": "homekit bridge linked_doorbell_sensor is an invalid option for homekit locks and is only available for cameras\n### The problem\r\n\r\n2024.8 brings support for an event entity as a linked_doorbell_sensor in homekit bridge.\r\n2024.9 should also enable events for linked_doorbell_sensor (see #123991) \r\n\r\ndocumentation says:\r\n\r\n> linked_doorbell_sensor string (Optional)\r\n> The entity_id of a binary_sensor or event entity to use as the doorbell sensor of the camera accessory to enable doorbell notifications.\r\n\r\nMy homekit config in configuration.yaml:\r\n```yaml\r\n- name: HomeKit Ring.com\r\n  port: 21065\r\n  mode: accessory\r\n  filter:\r\n    include_entities:\r\n      - lock.mydoor\r\n  entity_config:\r\n    lock.mydoor:\r\n      low_battery_threshold: 25\r\n      linked_doorbell_sensor: event.mydoor_doorbell\r\n      linked_battery_sensor: sensor.mydoor_battery\r\n```\r\n\r\nchecking config in developer tools produces this warning:\r\n\r\n> Invalid config for 'homekit' at homekit.yaml, line 28: 'linked_doorbell_sensor' is an invalid option for 'homekit', check: homekit->2->entity_config->linked_doorbell_sensor\r\n\r\nIf you ignore that warning and restart anyway, homekit bridge doesn't reload.\r\nI am using ring.com integration\r\n\r\n\r\n### What version of Home Assistant Core has the issue?\r\n\r\ncore-2024.10.4\r\n\r\n### What was the last working version of Home Assistant Core?\r\n\r\n_No response_\r\n\r\n### What type of installation are you running?\r\n\r\nHome Assistant OS\r\n\r\n### Integration causing the issue\r\n\r\nHomekit Bridge\r\n\r\n### Link to integration documentation on our website\r\n\r\nhttps://www.home-assistant.io/integrations/homekit\r\n\r\n### Diagnostics information\r\n\r\n_No response_\r\n\r\n### Example YAML snippet\r\n\r\n```yaml\r\n- name: HomeKit Ring.com\r\n  port: 21065\r\n  mode: accessory\r\n  filter:\r\n    include_entities:\r\n      - lock.mydoor\r\n  entity_config:\r\n    lock.mydoor:\r\n      low_battery_threshold: 25\r\n      linked_doorbell_sensor: event.mydoor_doorbell\r\n      linked_battery_sensor: sensor.mydoor_battery\r\n```\r\n\r\n\r\n### Anything in the logs that might be useful for us?\r\n\r\n_No response_\r\n\r\n\r\n### Additional information\r\n\r\n_No response_\n", "hints_text": "\nHey there @bdraco, mind taking a look at this issue as it has been labeled with an integration (`homekit`) you are listed as a [code owner](https://github.com/home-assistant/core/blob/dev/CODEOWNERS#L634) for? Thanks!\n\n<details>\n<summary>Code owner commands</summary>\n\n\nCode owners of `homekit` can trigger bot actions by commenting:\n\n- `@home-assistant close` Closes the issue.\n- `@home-assistant rename Awesome new title` Renames the issue.\n- `@home-assistant reopen` Reopen the issue.\n- `@home-assistant unassign homekit` Removes the current integration label and assignees on the issue, add the integration domain after the command.\n- `@home-assistant add-label needs-more-information` Add a label (needs-more-information, problem in dependency, problem in custom component) to the issue.\n- `@home-assistant remove-label needs-more-information` Remove a label (needs-more-information, problem in dependency, problem in custom component) on the issue.\n\n</details>\n\n\n<sub><sup>(message by CodeOwnersMention)</sup></sub>\n\n---\n\n[homekit documentation](https://www.home-assistant.io/integrations/homekit)\n[homekit source](https://github.com/home-assistant/core/tree/dev/homeassistant/components/homekit)\n<sub><sup>(message by IssueLinks)</sup></sub>\nSame problem here\nIt must be a `camera` not a `lock`\nCould that not be a use-case for a lock with a doorbell, but without a camara, too?\n\nI am living in an older house with many flats and could not add a camara to the door. That's why I am using a ring intercom to open the door. Ring intercom allows me to control that with the ring app and with home assistant, but I also want to integrate it into my homekit\n\nI had set up a homebridge just to integrate ring in homekit and it worked as well, but I don't want to have a virtual machine running just for this integration.\n@bdraco what are you thinking about this use-case?\nAssuming HomeKit is ok with the doorbell being the primary service on a lock, I think we could accept a PR to add support to locks.\r\n\r\nhttps://github.com/home-assistant/core/blob/433321136de91051ebc879c2f4d03cb9d8454a22/homeassistant/components/homekit/type_cameras.py#L242 would need to be broken out into a mixin, the schema would need to be updated in util.py, docs would need to be written, and tests added", "created_at": "2024-11-26T19:33:15Z"}
{"repo": "home-assistant/core", "pull_number": 131659, "instance_id": "home-assistant__core-131659", "issue_numbers": ["130597"], "base_commit": "2edcda47b04f2760ca88156274c03701c4fbc794", "patch": "diff --git a/homeassistant/components/plugwise/__init__.py b/homeassistant/components/plugwise/__init__.py\nindex 7d1b9ceac8a31..a100103b029be 100644\n--- a/homeassistant/components/plugwise/__init__.py\n+++ b/homeassistant/components/plugwise/__init__.py\n@@ -83,7 +83,7 @@ def migrate_sensor_entities(\n     # Migrating opentherm_outdoor_temperature\n     # to opentherm_outdoor_air_temperature sensor\n     for device_id, device in coordinator.data.devices.items():\n-        if device.get(\"dev_class\") != \"heater_central\":\n+        if device[\"dev_class\"] != \"heater_central\":\n             continue\n \n         old_unique_id = f\"{device_id}-outdoor_temperature\"\ndiff --git a/homeassistant/components/plugwise/climate.py b/homeassistant/components/plugwise/climate.py\nindex 46b4bff250aac..f1f54aa6647c6 100644\n--- a/homeassistant/components/plugwise/climate.py\n+++ b/homeassistant/components/plugwise/climate.py\n@@ -39,11 +39,19 @@ def _add_entities() -> None:\n         if not coordinator.new_devices:\n             return\n \n-        async_add_entities(\n-            PlugwiseClimateEntity(coordinator, device_id)\n-            for device_id in coordinator.new_devices\n-            if coordinator.data.devices[device_id][\"dev_class\"] in MASTER_THERMOSTATS\n-        )\n+        if coordinator.data.gateway[\"smile_name\"] == \"Adam\":\n+            async_add_entities(\n+                PlugwiseClimateEntity(coordinator, device_id)\n+                for device_id in coordinator.new_devices\n+                if coordinator.data.devices[device_id][\"dev_class\"] == \"climate\"\n+            )\n+        else:\n+            async_add_entities(\n+                PlugwiseClimateEntity(coordinator, device_id)\n+                for device_id in coordinator.new_devices\n+                if coordinator.data.devices[device_id][\"dev_class\"]\n+                in MASTER_THERMOSTATS\n+            )\n \n     _add_entities()\n     entry.async_on_unload(coordinator.async_add_listener(_add_entities))\n@@ -69,6 +77,11 @@ def __init__(\n         super().__init__(coordinator, device_id)\n         self._attr_extra_state_attributes = {}\n         self._attr_unique_id = f\"{device_id}-climate\"\n+\n+        self._location = device_id\n+        if (location := self.device.get(\"location\")) is not None:\n+            self._location = location\n+\n         self.cdr_gateway = coordinator.data.gateway\n         gateway_id: str = coordinator.data.gateway[\"gateway_id\"]\n         self.gateway_data = coordinator.data.devices[gateway_id]\n@@ -222,7 +235,7 @@ async def async_set_temperature(self, **kwargs: Any) -> None:\n         if mode := kwargs.get(ATTR_HVAC_MODE):\n             await self.async_set_hvac_mode(mode)\n \n-        await self.coordinator.api.set_temperature(self.device[\"location\"], data)\n+        await self.coordinator.api.set_temperature(self._location, data)\n \n     @plugwise_command\n     async def async_set_hvac_mode(self, hvac_mode: HVACMode) -> None:\n@@ -237,7 +250,7 @@ async def async_set_hvac_mode(self, hvac_mode: HVACMode) -> None:\n             await self.coordinator.api.set_regulation_mode(hvac_mode)\n         else:\n             await self.coordinator.api.set_schedule_state(\n-                self.device[\"location\"],\n+                self._location,\n                 \"on\" if hvac_mode == HVACMode.AUTO else \"off\",\n             )\n             if self.hvac_mode == HVACMode.OFF:\n@@ -246,4 +259,4 @@ async def async_set_hvac_mode(self, hvac_mode: HVACMode) -> None:\n     @plugwise_command\n     async def async_set_preset_mode(self, preset_mode: str) -> None:\n         \"\"\"Set the preset mode.\"\"\"\n-        await self.coordinator.api.set_preset(self.device[\"location\"], preset_mode)\n+        await self.coordinator.api.set_preset(self._location, preset_mode)\ndiff --git a/homeassistant/components/plugwise/coordinator.py b/homeassistant/components/plugwise/coordinator.py\nindex b897a8bf8336e..6ce6855e7d603 100644\n--- a/homeassistant/components/plugwise/coordinator.py\n+++ b/homeassistant/components/plugwise/coordinator.py\n@@ -64,11 +64,11 @@ async def _connect(self) -> None:\n         version = await self.api.connect()\n         self._connected = isinstance(version, Version)\n         if self._connected:\n-            self.api.get_all_devices()\n+            self.api.get_all_gateway_entities()\n \n     async def _async_update_data(self) -> PlugwiseData:\n         \"\"\"Fetch data from Plugwise.\"\"\"\n-        data = PlugwiseData({}, {})\n+        data = PlugwiseData(devices={}, gateway={})\n         try:\n             if not self._connected:\n                 await self._connect()\ndiff --git a/homeassistant/components/plugwise/diagnostics.py b/homeassistant/components/plugwise/diagnostics.py\nindex 9d15ea4fe2870..47ff7d1a9fbb0 100644\n--- a/homeassistant/components/plugwise/diagnostics.py\n+++ b/homeassistant/components/plugwise/diagnostics.py\n@@ -15,6 +15,6 @@ async def async_get_config_entry_diagnostics(\n     \"\"\"Return diagnostics for a config entry.\"\"\"\n     coordinator = entry.runtime_data\n     return {\n-        \"gateway\": coordinator.data.gateway,\n         \"devices\": coordinator.data.devices,\n+        \"gateway\": coordinator.data.gateway,\n     }\ndiff --git a/homeassistant/components/plugwise/entity.py b/homeassistant/components/plugwise/entity.py\nindex e24f3d1e1bb2f..7b28bf78342e0 100644\n--- a/homeassistant/components/plugwise/entity.py\n+++ b/homeassistant/components/plugwise/entity.py\n@@ -2,7 +2,7 @@\n \n from __future__ import annotations\n \n-from plugwise.constants import DeviceData\n+from plugwise.constants import GwEntityData\n \n from homeassistant.const import ATTR_NAME, ATTR_VIA_DEVICE, CONF_HOST\n from homeassistant.helpers.device_registry import (\n@@ -74,7 +74,7 @@ def available(self) -> bool:\n         )\n \n     @property\n-    def device(self) -> DeviceData:\n+    def device(self) -> GwEntityData:\n         \"\"\"Return data for this device.\"\"\"\n         return self.coordinator.data.devices[self._dev_id]\n \ndiff --git a/homeassistant/components/plugwise/manifest.json b/homeassistant/components/plugwise/manifest.json\nindex 9f11433d8d31a..d4d80749a8d1d 100644\n--- a/homeassistant/components/plugwise/manifest.json\n+++ b/homeassistant/components/plugwise/manifest.json\n@@ -7,6 +7,6 @@\n   \"integration_type\": \"hub\",\n   \"iot_class\": \"local_polling\",\n   \"loggers\": [\"plugwise\"],\n-  \"requirements\": [\"plugwise==1.5.2\"],\n+  \"requirements\": [\"plugwise==1.6.0\"],\n   \"zeroconf\": [\"_plugwise._tcp.local.\"]\n }\ndiff --git a/homeassistant/components/plugwise/number.py b/homeassistant/components/plugwise/number.py\nindex 06db5faa55b27..833ea3ec76123 100644\n--- a/homeassistant/components/plugwise/number.py\n+++ b/homeassistant/components/plugwise/number.py\n@@ -91,12 +91,12 @@ def __init__(\n     ) -> None:\n         \"\"\"Initiate Plugwise Number.\"\"\"\n         super().__init__(coordinator, device_id)\n-        self.device_id = device_id\n-        self.entity_description = description\n-        self._attr_unique_id = f\"{device_id}-{description.key}\"\n         self._attr_mode = NumberMode.BOX\n         self._attr_native_max_value = self.device[description.key][\"upper_bound\"]\n         self._attr_native_min_value = self.device[description.key][\"lower_bound\"]\n+        self._attr_unique_id = f\"{device_id}-{description.key}\"\n+        self.device_id = device_id\n+        self.entity_description = description\n \n         native_step = self.device[description.key][\"resolution\"]\n         if description.key != \"temperature_offset\":\ndiff --git a/homeassistant/components/plugwise/select.py b/homeassistant/components/plugwise/select.py\nindex b7d4a0a1ded60..46b27ca622544 100644\n--- a/homeassistant/components/plugwise/select.py\n+++ b/homeassistant/components/plugwise/select.py\n@@ -10,7 +10,7 @@\n from homeassistant.helpers.entity_platform import AddEntitiesCallback\n \n from . import PlugwiseConfigEntry\n-from .const import LOCATION, SelectOptionsType, SelectType\n+from .const import SelectOptionsType, SelectType\n from .coordinator import PlugwiseDataUpdateCoordinator\n from .entity import PlugwiseEntity\n from .util import plugwise_command\n@@ -89,8 +89,12 @@ def __init__(\n     ) -> None:\n         \"\"\"Initialise the selector.\"\"\"\n         super().__init__(coordinator, device_id)\n-        self.entity_description = entity_description\n         self._attr_unique_id = f\"{device_id}-{entity_description.key}\"\n+        self.entity_description = entity_description\n+\n+        self._location = device_id\n+        if (location := self.device.get(\"location\")) is not None:\n+            self._location = location\n \n     @property\n     def current_option(self) -> str:\n@@ -106,8 +110,8 @@ def options(self) -> list[str]:\n     async def async_select_option(self, option: str) -> None:\n         \"\"\"Change to the selected entity option.\n \n-        self.device[LOCATION] and STATE_ON are required for the thermostat-schedule select.\n+        self._location and STATE_ON are required for the thermostat-schedule select.\n         \"\"\"\n         await self.coordinator.api.set_select(\n-            self.entity_description.key, self.device[LOCATION], option, STATE_ON\n+            self.entity_description.key, self._location, option, STATE_ON\n         )\ndiff --git a/homeassistant/components/plugwise/sensor.py b/homeassistant/components/plugwise/sensor.py\nindex ae5b4e6ed9187..41ca439451a1c 100644\n--- a/homeassistant/components/plugwise/sensor.py\n+++ b/homeassistant/components/plugwise/sensor.py\n@@ -439,8 +439,8 @@ def __init__(\n     ) -> None:\n         \"\"\"Initialise the sensor.\"\"\"\n         super().__init__(coordinator, device_id)\n-        self.entity_description = description\n         self._attr_unique_id = f\"{device_id}-{description.key}\"\n+        self.entity_description = description\n \n     @property\n     def native_value(self) -> int | float:\ndiff --git a/homeassistant/components/plugwise/switch.py b/homeassistant/components/plugwise/switch.py\nindex a134ab5b04416..744fc0a2b729e 100644\n--- a/homeassistant/components/plugwise/switch.py\n+++ b/homeassistant/components/plugwise/switch.py\n@@ -93,8 +93,8 @@ def __init__(\n     ) -> None:\n         \"\"\"Set up the Plugwise API.\"\"\"\n         super().__init__(coordinator, device_id)\n-        self.entity_description = description\n         self._attr_unique_id = f\"{device_id}-{description.key}\"\n+        self.entity_description = description\n \n     @property\n     def is_on(self) -> bool:\ndiff --git a/requirements_all.txt b/requirements_all.txt\nindex 7911e16f316e7..4b0a221439da7 100644\n--- a/requirements_all.txt\n+++ b/requirements_all.txt\n@@ -1622,7 +1622,7 @@ plexauth==0.0.6\n plexwebsocket==0.0.14\n \n # homeassistant.components.plugwise\n-plugwise==1.5.2\n+plugwise==1.6.0\n \n # homeassistant.components.plum_lightpad\n plumlightpad==0.0.11\n", "test_patch": "diff --git a/requirements_test_all.txt b/requirements_test_all.txt\nindex 30f31ea6af4d2..05d115bd77fee 100644\n--- a/requirements_test_all.txt\n+++ b/requirements_test_all.txt\n@@ -1329,7 +1329,7 @@ plexauth==0.0.6\n plexwebsocket==0.0.14\n \n # homeassistant.components.plugwise\n-plugwise==1.5.2\n+plugwise==1.6.0\n \n # homeassistant.components.plum_lightpad\n plumlightpad==0.0.11\ndiff --git a/tests/components/plugwise/conftest.py b/tests/components/plugwise/conftest.py\nindex f18c96d36c5f8..dead58e0581c0 100644\n--- a/tests/components/plugwise/conftest.py\n+++ b/tests/components/plugwise/conftest.py\n@@ -93,7 +93,7 @@ def mock_smile_adam() -> Generator[MagicMock]:\n         smile.connect.return_value = Version(\"3.0.15\")\n         all_data = _read_json(chosen_env, \"all_data\")\n         smile.async_update.return_value = PlugwiseData(\n-            all_data[\"gateway\"], all_data[\"devices\"]\n+            all_data[\"devices\"], all_data[\"gateway\"]\n         )\n \n         yield smile\n@@ -120,7 +120,7 @@ def mock_smile_adam_2() -> Generator[MagicMock]:\n         smile.connect.return_value = Version(\"3.6.4\")\n         all_data = _read_json(chosen_env, \"all_data\")\n         smile.async_update.return_value = PlugwiseData(\n-            all_data[\"gateway\"], all_data[\"devices\"]\n+            all_data[\"devices\"], all_data[\"gateway\"]\n         )\n \n         yield smile\n@@ -147,7 +147,7 @@ def mock_smile_adam_3() -> Generator[MagicMock]:\n         smile.connect.return_value = Version(\"3.6.4\")\n         all_data = _read_json(chosen_env, \"all_data\")\n         smile.async_update.return_value = PlugwiseData(\n-            all_data[\"gateway\"], all_data[\"devices\"]\n+            all_data[\"devices\"], all_data[\"gateway\"]\n         )\n \n         yield smile\n@@ -174,7 +174,7 @@ def mock_smile_adam_4() -> Generator[MagicMock]:\n         smile.connect.return_value = Version(\"3.2.8\")\n         all_data = _read_json(chosen_env, \"all_data\")\n         smile.async_update.return_value = PlugwiseData(\n-            all_data[\"gateway\"], all_data[\"devices\"]\n+            all_data[\"devices\"], all_data[\"gateway\"]\n         )\n \n         yield smile\n@@ -200,7 +200,7 @@ def mock_smile_anna() -> Generator[MagicMock]:\n         smile.connect.return_value = Version(\"4.0.15\")\n         all_data = _read_json(chosen_env, \"all_data\")\n         smile.async_update.return_value = PlugwiseData(\n-            all_data[\"gateway\"], all_data[\"devices\"]\n+            all_data[\"devices\"], all_data[\"gateway\"]\n         )\n \n         yield smile\n@@ -226,7 +226,7 @@ def mock_smile_anna_2() -> Generator[MagicMock]:\n         smile.connect.return_value = Version(\"4.0.15\")\n         all_data = _read_json(chosen_env, \"all_data\")\n         smile.async_update.return_value = PlugwiseData(\n-            all_data[\"gateway\"], all_data[\"devices\"]\n+            all_data[\"devices\"], all_data[\"gateway\"]\n         )\n \n         yield smile\n@@ -252,7 +252,7 @@ def mock_smile_anna_3() -> Generator[MagicMock]:\n         smile.connect.return_value = Version(\"4.0.15\")\n         all_data = _read_json(chosen_env, \"all_data\")\n         smile.async_update.return_value = PlugwiseData(\n-            all_data[\"gateway\"], all_data[\"devices\"]\n+            all_data[\"devices\"], all_data[\"gateway\"]\n         )\n \n         yield smile\n@@ -278,7 +278,7 @@ def mock_smile_p1() -> Generator[MagicMock]:\n         smile.connect.return_value = Version(\"4.4.2\")\n         all_data = _read_json(chosen_env, \"all_data\")\n         smile.async_update.return_value = PlugwiseData(\n-            all_data[\"gateway\"], all_data[\"devices\"]\n+            all_data[\"devices\"], all_data[\"gateway\"]\n         )\n \n         yield smile\n@@ -304,7 +304,7 @@ def mock_smile_p1_2() -> Generator[MagicMock]:\n         smile.connect.return_value = Version(\"4.4.2\")\n         all_data = _read_json(chosen_env, \"all_data\")\n         smile.async_update.return_value = PlugwiseData(\n-            all_data[\"gateway\"], all_data[\"devices\"]\n+            all_data[\"devices\"], all_data[\"gateway\"]\n         )\n \n         yield smile\n@@ -330,7 +330,7 @@ def mock_smile_legacy_anna() -> Generator[MagicMock]:\n         smile.connect.return_value = Version(\"1.8.22\")\n         all_data = _read_json(chosen_env, \"all_data\")\n         smile.async_update.return_value = PlugwiseData(\n-            all_data[\"gateway\"], all_data[\"devices\"]\n+            all_data[\"devices\"], all_data[\"gateway\"]\n         )\n \n         yield smile\n@@ -356,7 +356,7 @@ def mock_stretch() -> Generator[MagicMock]:\n         smile.connect.return_value = Version(\"3.1.11\")\n         all_data = _read_json(chosen_env, \"all_data\")\n         smile.async_update.return_value = PlugwiseData(\n-            all_data[\"gateway\"], all_data[\"devices\"]\n+            all_data[\"devices\"], all_data[\"gateway\"]\n         )\n \n         yield smile\ndiff --git a/tests/components/plugwise/fixtures/legacy_anna/all_data.json b/tests/components/plugwise/fixtures/legacy_anna/all_data.json\nindex c5ee4b2b103e2..2cb439950af06 100644\n--- a/tests/components/plugwise/fixtures/legacy_anna/all_data.json\n+++ b/tests/components/plugwise/fixtures/legacy_anna/all_data.json\n@@ -45,7 +45,7 @@\n       \"name\": \"Anna\",\n       \"preset_modes\": [\"away\", \"vacation\", \"asleep\", \"home\", \"no_frost\"],\n       \"sensors\": {\n-        \"illuminance\": 151,\n+        \"illuminance\": 150.8,\n         \"setpoint\": 20.5,\n         \"temperature\": 20.4\n       },\ndiff --git a/tests/components/plugwise/fixtures/m_adam_cooling/all_data.json b/tests/components/plugwise/fixtures/m_adam_cooling/all_data.json\nindex 6edd4c5901d70..9c40e50278b03 100644\n--- a/tests/components/plugwise/fixtures/m_adam_cooling/all_data.json\n+++ b/tests/components/plugwise/fixtures/m_adam_cooling/all_data.json\n@@ -31,7 +31,7 @@\n       \"binary_sensors\": {\n         \"low_battery\": false\n       },\n-      \"dev_class\": \"thermo_sensor\",\n+      \"dev_class\": \"thermostatic_radiator_valve\",\n       \"firmware\": \"2020-11-04T01:00:00+01:00\",\n       \"hardware\": \"1\",\n       \"location\": \"f871b8c4d63549319221e294e4f88074\",\n@@ -40,6 +40,7 @@\n       \"name\": \"Tom Badkamer\",\n       \"sensors\": {\n         \"battery\": 99,\n+        \"setpoint\": 18.0,\n         \"temperature\": 21.6,\n         \"temperature_difference\": -0.2,\n         \"valve_position\": 100\n@@ -54,34 +55,16 @@\n       \"zigbee_mac_address\": \"000D6F000C8FF5EE\"\n     },\n     \"ad4838d7d35c4d6ea796ee12ae5aedf8\": {\n-      \"active_preset\": \"home\",\n       \"available\": true,\n-      \"available_schedules\": [\n-        \"Badkamer\",\n-        \"Test\",\n-        \"Vakantie\",\n-        \"Weekschema\",\n-        \"off\"\n-      ],\n-      \"climate_mode\": \"cool\",\n-      \"control_state\": \"cooling\",\n       \"dev_class\": \"thermostat\",\n       \"location\": \"f2bf9048bef64cc5b6d5110154e33c81\",\n       \"model\": \"ThermoTouch\",\n       \"model_id\": \"143.1\",\n       \"name\": \"Anna\",\n-      \"preset_modes\": [\"no_frost\", \"asleep\", \"vacation\", \"home\", \"away\"],\n-      \"select_schedule\": \"off\",\n       \"sensors\": {\n         \"setpoint\": 23.5,\n         \"temperature\": 25.8\n       },\n-      \"thermostat\": {\n-        \"lower_bound\": 1.0,\n-        \"resolution\": 0.01,\n-        \"setpoint\": 23.5,\n-        \"upper_bound\": 35.0\n-      },\n       \"vendor\": \"Plugwise\"\n     },\n     \"da224107914542988a88561b4452b0f6\": {\n@@ -113,20 +96,10 @@\n       \"zigbee_mac_address\": \"000D6F000D5A168D\"\n     },\n     \"e2f4322d57924fa090fbbc48b3a140dc\": {\n-      \"active_preset\": \"home\",\n       \"available\": true,\n-      \"available_schedules\": [\n-        \"Badkamer\",\n-        \"Test\",\n-        \"Vakantie\",\n-        \"Weekschema\",\n-        \"off\"\n-      ],\n       \"binary_sensors\": {\n         \"low_battery\": true\n       },\n-      \"climate_mode\": \"auto\",\n-      \"control_state\": \"preheating\",\n       \"dev_class\": \"zone_thermostat\",\n       \"firmware\": \"2016-10-10T02:00:00+02:00\",\n       \"hardware\": \"255\",\n@@ -134,8 +107,6 @@\n       \"model\": \"Lisa\",\n       \"model_id\": \"158-01\",\n       \"name\": \"Lisa Badkamer\",\n-      \"preset_modes\": [\"no_frost\", \"asleep\", \"vacation\", \"home\", \"away\"],\n-      \"select_schedule\": \"Badkamer\",\n       \"sensors\": {\n         \"battery\": 14,\n         \"setpoint\": 23.5,\n@@ -147,12 +118,6 @@\n         \"setpoint\": 0.0,\n         \"upper_bound\": 2.0\n       },\n-      \"thermostat\": {\n-        \"lower_bound\": 0.0,\n-        \"resolution\": 0.01,\n-        \"setpoint\": 25.0,\n-        \"upper_bound\": 99.9\n-      },\n       \"vendor\": \"Plugwise\",\n       \"zigbee_mac_address\": \"000D6F000C869B61\"\n     },\n@@ -166,14 +131,81 @@\n       \"name\": \"Test\",\n       \"switches\": {\n         \"relay\": true\n-      }\n+      },\n+      \"vendor\": \"Plugwise\"\n+    },\n+    \"f2bf9048bef64cc5b6d5110154e33c81\": {\n+      \"active_preset\": \"home\",\n+      \"available_schedules\": [\n+        \"Badkamer\",\n+        \"Test\",\n+        \"Vakantie\",\n+        \"Weekschema\",\n+        \"off\"\n+      ],\n+      \"climate_mode\": \"cool\",\n+      \"control_state\": \"cooling\",\n+      \"dev_class\": \"climate\",\n+      \"model\": \"ThermoZone\",\n+      \"name\": \"Living room\",\n+      \"preset_modes\": [\"no_frost\", \"asleep\", \"vacation\", \"home\", \"away\"],\n+      \"select_schedule\": \"off\",\n+      \"sensors\": {\n+        \"electricity_consumed\": 149.9,\n+        \"electricity_produced\": 0.0,\n+        \"temperature\": 25.8\n+      },\n+      \"thermostat\": {\n+        \"lower_bound\": 1.0,\n+        \"resolution\": 0.01,\n+        \"setpoint\": 23.5,\n+        \"upper_bound\": 35.0\n+      },\n+      \"thermostats\": {\n+        \"primary\": [\"ad4838d7d35c4d6ea796ee12ae5aedf8\"],\n+        \"secondary\": []\n+      },\n+      \"vendor\": \"Plugwise\"\n+    },\n+    \"f871b8c4d63549319221e294e4f88074\": {\n+      \"active_preset\": \"home\",\n+      \"available_schedules\": [\n+        \"Badkamer\",\n+        \"Test\",\n+        \"Vakantie\",\n+        \"Weekschema\",\n+        \"off\"\n+      ],\n+      \"climate_mode\": \"cool\",\n+      \"control_state\": \"auto\",\n+      \"dev_class\": \"climate\",\n+      \"model\": \"ThermoZone\",\n+      \"name\": \"Bathroom\",\n+      \"preset_modes\": [\"no_frost\", \"asleep\", \"vacation\", \"home\", \"away\"],\n+      \"select_schedule\": \"Badkamer\",\n+      \"sensors\": {\n+        \"electricity_consumed\": 0.0,\n+        \"electricity_produced\": 0.0,\n+        \"temperature\": 23.9\n+      },\n+      \"thermostat\": {\n+        \"lower_bound\": 0.0,\n+        \"resolution\": 0.01,\n+        \"setpoint\": 25.0,\n+        \"upper_bound\": 99.9\n+      },\n+      \"thermostats\": {\n+        \"primary\": [\"e2f4322d57924fa090fbbc48b3a140dc\"],\n+        \"secondary\": [\"1772a4ea304041adb83f357b751341ff\"]\n+      },\n+      \"vendor\": \"Plugwise\"\n     }\n   },\n   \"gateway\": {\n     \"cooling_present\": true,\n     \"gateway_id\": \"da224107914542988a88561b4452b0f6\",\n     \"heater_id\": \"056ee145a816487eaa69243c3280f8bf\",\n-    \"item_count\": 157,\n+    \"item_count\": 89,\n     \"notifications\": {},\n     \"reboot\": true,\n     \"smile_name\": \"Adam\"\ndiff --git a/tests/components/plugwise/fixtures/m_adam_heating/all_data.json b/tests/components/plugwise/fixtures/m_adam_heating/all_data.json\nindex 7a3fb6e3b5c58..fab2cea5fdc6b 100644\n--- a/tests/components/plugwise/fixtures/m_adam_heating/all_data.json\n+++ b/tests/components/plugwise/fixtures/m_adam_heating/all_data.json\n@@ -36,7 +36,7 @@\n       \"binary_sensors\": {\n         \"low_battery\": false\n       },\n-      \"dev_class\": \"thermo_sensor\",\n+      \"dev_class\": \"thermostatic_radiator_valve\",\n       \"firmware\": \"2020-11-04T01:00:00+01:00\",\n       \"hardware\": \"1\",\n       \"location\": \"f871b8c4d63549319221e294e4f88074\",\n@@ -45,6 +45,7 @@\n       \"name\": \"Tom Badkamer\",\n       \"sensors\": {\n         \"battery\": 99,\n+        \"setpoint\": 18.0,\n         \"temperature\": 18.6,\n         \"temperature_difference\": -0.2,\n         \"valve_position\": 100\n@@ -59,34 +60,16 @@\n       \"zigbee_mac_address\": \"000D6F000C8FF5EE\"\n     },\n     \"ad4838d7d35c4d6ea796ee12ae5aedf8\": {\n-      \"active_preset\": \"home\",\n       \"available\": true,\n-      \"available_schedules\": [\n-        \"Badkamer\",\n-        \"Test\",\n-        \"Vakantie\",\n-        \"Weekschema\",\n-        \"off\"\n-      ],\n-      \"climate_mode\": \"heat\",\n-      \"control_state\": \"preheating\",\n       \"dev_class\": \"thermostat\",\n       \"location\": \"f2bf9048bef64cc5b6d5110154e33c81\",\n       \"model\": \"ThermoTouch\",\n       \"model_id\": \"143.1\",\n       \"name\": \"Anna\",\n-      \"preset_modes\": [\"no_frost\", \"asleep\", \"vacation\", \"home\", \"away\"],\n-      \"select_schedule\": \"off\",\n       \"sensors\": {\n         \"setpoint\": 20.0,\n         \"temperature\": 19.1\n       },\n-      \"thermostat\": {\n-        \"lower_bound\": 1.0,\n-        \"resolution\": 0.01,\n-        \"setpoint\": 20.0,\n-        \"upper_bound\": 35.0\n-      },\n       \"vendor\": \"Plugwise\"\n     },\n     \"da224107914542988a88561b4452b0f6\": {\n@@ -112,20 +95,10 @@\n       \"zigbee_mac_address\": \"000D6F000D5A168D\"\n     },\n     \"e2f4322d57924fa090fbbc48b3a140dc\": {\n-      \"active_preset\": \"home\",\n       \"available\": true,\n-      \"available_schedules\": [\n-        \"Badkamer\",\n-        \"Test\",\n-        \"Vakantie\",\n-        \"Weekschema\",\n-        \"off\"\n-      ],\n       \"binary_sensors\": {\n         \"low_battery\": true\n       },\n-      \"climate_mode\": \"auto\",\n-      \"control_state\": \"off\",\n       \"dev_class\": \"zone_thermostat\",\n       \"firmware\": \"2016-10-10T02:00:00+02:00\",\n       \"hardware\": \"255\",\n@@ -133,8 +106,6 @@\n       \"model\": \"Lisa\",\n       \"model_id\": \"158-01\",\n       \"name\": \"Lisa Badkamer\",\n-      \"preset_modes\": [\"no_frost\", \"asleep\", \"vacation\", \"home\", \"away\"],\n-      \"select_schedule\": \"Badkamer\",\n       \"sensors\": {\n         \"battery\": 14,\n         \"setpoint\": 15.0,\n@@ -146,12 +117,6 @@\n         \"setpoint\": 0.0,\n         \"upper_bound\": 2.0\n       },\n-      \"thermostat\": {\n-        \"lower_bound\": 0.0,\n-        \"resolution\": 0.01,\n-        \"setpoint\": 15.0,\n-        \"upper_bound\": 99.9\n-      },\n       \"vendor\": \"Plugwise\",\n       \"zigbee_mac_address\": \"000D6F000C869B61\"\n     },\n@@ -165,14 +130,81 @@\n       \"name\": \"Test\",\n       \"switches\": {\n         \"relay\": true\n-      }\n+      },\n+      \"vendor\": \"Plugwise\"\n+    },\n+    \"f2bf9048bef64cc5b6d5110154e33c81\": {\n+      \"active_preset\": \"home\",\n+      \"available_schedules\": [\n+        \"Badkamer\",\n+        \"Test\",\n+        \"Vakantie\",\n+        \"Weekschema\",\n+        \"off\"\n+      ],\n+      \"climate_mode\": \"heat\",\n+      \"control_state\": \"preheating\",\n+      \"dev_class\": \"climate\",\n+      \"model\": \"ThermoZone\",\n+      \"name\": \"Living room\",\n+      \"preset_modes\": [\"no_frost\", \"asleep\", \"vacation\", \"home\", \"away\"],\n+      \"select_schedule\": \"off\",\n+      \"sensors\": {\n+        \"electricity_consumed\": 149.9,\n+        \"electricity_produced\": 0.0,\n+        \"temperature\": 19.1\n+      },\n+      \"thermostat\": {\n+        \"lower_bound\": 1.0,\n+        \"resolution\": 0.01,\n+        \"setpoint\": 20.0,\n+        \"upper_bound\": 35.0\n+      },\n+      \"thermostats\": {\n+        \"primary\": [\"ad4838d7d35c4d6ea796ee12ae5aedf8\"],\n+        \"secondary\": []\n+      },\n+      \"vendor\": \"Plugwise\"\n+    },\n+    \"f871b8c4d63549319221e294e4f88074\": {\n+      \"active_preset\": \"home\",\n+      \"available_schedules\": [\n+        \"Badkamer\",\n+        \"Test\",\n+        \"Vakantie\",\n+        \"Weekschema\",\n+        \"off\"\n+      ],\n+      \"climate_mode\": \"auto\",\n+      \"control_state\": \"off\",\n+      \"dev_class\": \"climate\",\n+      \"model\": \"ThermoZone\",\n+      \"name\": \"Bathroom\",\n+      \"preset_modes\": [\"no_frost\", \"asleep\", \"vacation\", \"home\", \"away\"],\n+      \"select_schedule\": \"Badkamer\",\n+      \"sensors\": {\n+        \"electricity_consumed\": 0.0,\n+        \"electricity_produced\": 0.0,\n+        \"temperature\": 17.9\n+      },\n+      \"thermostat\": {\n+        \"lower_bound\": 0.0,\n+        \"resolution\": 0.01,\n+        \"setpoint\": 15.0,\n+        \"upper_bound\": 99.9\n+      },\n+      \"thermostats\": {\n+        \"primary\": [\"e2f4322d57924fa090fbbc48b3a140dc\"],\n+        \"secondary\": [\"1772a4ea304041adb83f357b751341ff\"]\n+      },\n+      \"vendor\": \"Plugwise\"\n     }\n   },\n   \"gateway\": {\n     \"cooling_present\": false,\n     \"gateway_id\": \"da224107914542988a88561b4452b0f6\",\n     \"heater_id\": \"056ee145a816487eaa69243c3280f8bf\",\n-    \"item_count\": 157,\n+    \"item_count\": 89,\n     \"notifications\": {},\n     \"reboot\": true,\n     \"smile_name\": \"Adam\"\ndiff --git a/tests/components/plugwise/fixtures/m_adam_jip/all_data.json b/tests/components/plugwise/fixtures/m_adam_jip/all_data.json\nindex 61d6baaf88fbf..4516ce2c2d0d2 100644\n--- a/tests/components/plugwise/fixtures/m_adam_jip/all_data.json\n+++ b/tests/components/plugwise/fixtures/m_adam_jip/all_data.json\n@@ -1,13 +1,56 @@\n {\n   \"devices\": {\n-    \"1346fbd8498d4dbcab7e18d51b771f3d\": {\n+    \"06aecb3d00354375924f50c47af36bd2\": {\n       \"active_preset\": \"no_frost\",\n+      \"climate_mode\": \"off\",\n+      \"control_state\": \"off\",\n+      \"dev_class\": \"climate\",\n+      \"model\": \"ThermoZone\",\n+      \"name\": \"Slaapkamer\",\n+      \"preset_modes\": [\"home\", \"asleep\", \"away\", \"vacation\", \"no_frost\"],\n+      \"sensors\": {\n+        \"temperature\": 24.2\n+      },\n+      \"thermostat\": {\n+        \"lower_bound\": 0.0,\n+        \"resolution\": 0.01,\n+        \"setpoint\": 13.0,\n+        \"upper_bound\": 99.9\n+      },\n+      \"thermostats\": {\n+        \"primary\": [\"1346fbd8498d4dbcab7e18d51b771f3d\"],\n+        \"secondary\": [\"356b65335e274d769c338223e7af9c33\"]\n+      },\n+      \"vendor\": \"Plugwise\"\n+    },\n+    \"13228dab8ce04617af318a2888b3c548\": {\n+      \"active_preset\": \"home\",\n+      \"climate_mode\": \"heat\",\n+      \"control_state\": \"off\",\n+      \"dev_class\": \"climate\",\n+      \"model\": \"ThermoZone\",\n+      \"name\": \"Woonkamer\",\n+      \"preset_modes\": [\"home\", \"asleep\", \"away\", \"vacation\", \"no_frost\"],\n+      \"sensors\": {\n+        \"temperature\": 27.4\n+      },\n+      \"thermostat\": {\n+        \"lower_bound\": 4.0,\n+        \"resolution\": 0.01,\n+        \"setpoint\": 9.0,\n+        \"upper_bound\": 30.0\n+      },\n+      \"thermostats\": {\n+        \"primary\": [\"f61f1a2535f54f52ad006a3d18e459ca\"],\n+        \"secondary\": [\"833de10f269c4deab58fb9df69901b4e\"]\n+      },\n+      \"vendor\": \"Plugwise\"\n+    },\n+    \"1346fbd8498d4dbcab7e18d51b771f3d\": {\n       \"available\": true,\n       \"binary_sensors\": {\n         \"low_battery\": false\n       },\n-      \"climate_mode\": \"off\",\n-      \"control_state\": \"off\",\n       \"dev_class\": \"zone_thermostat\",\n       \"firmware\": \"2016-10-27T02:00:00+02:00\",\n       \"hardware\": \"255\",\n@@ -15,7 +58,6 @@\n       \"model\": \"Lisa\",\n       \"model_id\": \"158-01\",\n       \"name\": \"Slaapkamer\",\n-      \"preset_modes\": [\"home\", \"asleep\", \"away\", \"vacation\", \"no_frost\"],\n       \"sensors\": {\n         \"battery\": 92,\n         \"setpoint\": 13.0,\n@@ -27,18 +69,12 @@\n         \"setpoint\": 0.0,\n         \"upper_bound\": 2.0\n       },\n-      \"thermostat\": {\n-        \"lower_bound\": 0.0,\n-        \"resolution\": 0.01,\n-        \"setpoint\": 13.0,\n-        \"upper_bound\": 99.9\n-      },\n       \"vendor\": \"Plugwise\",\n       \"zigbee_mac_address\": \"ABCD012345670A03\"\n     },\n     \"1da4d325838e4ad8aac12177214505c9\": {\n       \"available\": true,\n-      \"dev_class\": \"thermo_sensor\",\n+      \"dev_class\": \"thermostatic_radiator_valve\",\n       \"firmware\": \"2020-11-04T01:00:00+01:00\",\n       \"hardware\": \"1\",\n       \"location\": \"d58fec52899f4f1c92e4f8fad6d8c48c\",\n@@ -62,7 +98,7 @@\n     },\n     \"356b65335e274d769c338223e7af9c33\": {\n       \"available\": true,\n-      \"dev_class\": \"thermo_sensor\",\n+      \"dev_class\": \"thermostatic_radiator_valve\",\n       \"firmware\": \"2020-11-04T01:00:00+01:00\",\n       \"hardware\": \"1\",\n       \"location\": \"06aecb3d00354375924f50c47af36bd2\",\n@@ -102,13 +138,10 @@\n       \"zigbee_mac_address\": \"ABCD012345670A06\"\n     },\n     \"6f3e9d7084214c21b9dfa46f6eeb8700\": {\n-      \"active_preset\": \"home\",\n       \"available\": true,\n       \"binary_sensors\": {\n         \"low_battery\": false\n       },\n-      \"climate_mode\": \"heat\",\n-      \"control_state\": \"off\",\n       \"dev_class\": \"zone_thermostat\",\n       \"firmware\": \"2016-10-27T02:00:00+02:00\",\n       \"hardware\": \"255\",\n@@ -116,7 +149,6 @@\n       \"model\": \"Lisa\",\n       \"model_id\": \"158-01\",\n       \"name\": \"Kinderkamer\",\n-      \"preset_modes\": [\"home\", \"asleep\", \"away\", \"vacation\", \"no_frost\"],\n       \"sensors\": {\n         \"battery\": 79,\n         \"setpoint\": 13.0,\n@@ -128,18 +160,12 @@\n         \"setpoint\": 0.0,\n         \"upper_bound\": 2.0\n       },\n-      \"thermostat\": {\n-        \"lower_bound\": 0.0,\n-        \"resolution\": 0.01,\n-        \"setpoint\": 13.0,\n-        \"upper_bound\": 99.9\n-      },\n       \"vendor\": \"Plugwise\",\n       \"zigbee_mac_address\": \"ABCD012345670A02\"\n     },\n     \"833de10f269c4deab58fb9df69901b4e\": {\n       \"available\": true,\n-      \"dev_class\": \"thermo_sensor\",\n+      \"dev_class\": \"thermostatic_radiator_valve\",\n       \"firmware\": \"2020-11-04T01:00:00+01:00\",\n       \"hardware\": \"1\",\n       \"location\": \"13228dab8ce04617af318a2888b3c548\",\n@@ -162,13 +188,10 @@\n       \"zigbee_mac_address\": \"ABCD012345670A09\"\n     },\n     \"a6abc6a129ee499c88a4d420cc413b47\": {\n-      \"active_preset\": \"home\",\n       \"available\": true,\n       \"binary_sensors\": {\n         \"low_battery\": false\n       },\n-      \"climate_mode\": \"heat\",\n-      \"control_state\": \"off\",\n       \"dev_class\": \"zone_thermostat\",\n       \"firmware\": \"2016-10-27T02:00:00+02:00\",\n       \"hardware\": \"255\",\n@@ -176,7 +199,6 @@\n       \"model\": \"Lisa\",\n       \"model_id\": \"158-01\",\n       \"name\": \"Logeerkamer\",\n-      \"preset_modes\": [\"home\", \"asleep\", \"away\", \"vacation\", \"no_frost\"],\n       \"sensors\": {\n         \"battery\": 80,\n         \"setpoint\": 13.0,\n@@ -188,12 +210,6 @@\n         \"setpoint\": 0.0,\n         \"upper_bound\": 2.0\n       },\n-      \"thermostat\": {\n-        \"lower_bound\": 0.0,\n-        \"resolution\": 0.01,\n-        \"setpoint\": 13.0,\n-        \"upper_bound\": 99.9\n-      },\n       \"vendor\": \"Plugwise\",\n       \"zigbee_mac_address\": \"ABCD012345670A01\"\n     },\n@@ -219,9 +235,32 @@\n       \"vendor\": \"Plugwise\",\n       \"zigbee_mac_address\": \"ABCD012345670101\"\n     },\n+    \"d27aede973b54be484f6842d1b2802ad\": {\n+      \"active_preset\": \"home\",\n+      \"climate_mode\": \"heat\",\n+      \"control_state\": \"off\",\n+      \"dev_class\": \"climate\",\n+      \"model\": \"ThermoZone\",\n+      \"name\": \"Kinderkamer\",\n+      \"preset_modes\": [\"home\", \"asleep\", \"away\", \"vacation\", \"no_frost\"],\n+      \"sensors\": {\n+        \"temperature\": 30.0\n+      },\n+      \"thermostat\": {\n+        \"lower_bound\": 0.0,\n+        \"resolution\": 0.01,\n+        \"setpoint\": 13.0,\n+        \"upper_bound\": 99.9\n+      },\n+      \"thermostats\": {\n+        \"primary\": [\"6f3e9d7084214c21b9dfa46f6eeb8700\"],\n+        \"secondary\": [\"d4496250d0e942cfa7aea3476e9070d5\"]\n+      },\n+      \"vendor\": \"Plugwise\"\n+    },\n     \"d4496250d0e942cfa7aea3476e9070d5\": {\n       \"available\": true,\n-      \"dev_class\": \"thermo_sensor\",\n+      \"dev_class\": \"thermostatic_radiator_valve\",\n       \"firmware\": \"2020-11-04T01:00:00+01:00\",\n       \"hardware\": \"1\",\n       \"location\": \"d27aede973b54be484f6842d1b2802ad\",\n@@ -243,6 +282,29 @@\n       \"vendor\": \"Plugwise\",\n       \"zigbee_mac_address\": \"ABCD012345670A04\"\n     },\n+    \"d58fec52899f4f1c92e4f8fad6d8c48c\": {\n+      \"active_preset\": \"home\",\n+      \"climate_mode\": \"heat\",\n+      \"control_state\": \"off\",\n+      \"dev_class\": \"climate\",\n+      \"model\": \"ThermoZone\",\n+      \"name\": \"Logeerkamer\",\n+      \"preset_modes\": [\"home\", \"asleep\", \"away\", \"vacation\", \"no_frost\"],\n+      \"sensors\": {\n+        \"temperature\": 30.0\n+      },\n+      \"thermostat\": {\n+        \"lower_bound\": 0.0,\n+        \"resolution\": 0.01,\n+        \"setpoint\": 13.0,\n+        \"upper_bound\": 99.9\n+      },\n+      \"thermostats\": {\n+        \"primary\": [\"a6abc6a129ee499c88a4d420cc413b47\"],\n+        \"secondary\": [\"1da4d325838e4ad8aac12177214505c9\"]\n+      },\n+      \"vendor\": \"Plugwise\"\n+    },\n     \"e4684553153b44afbef2200885f379dc\": {\n       \"available\": true,\n       \"binary_sensors\": {\n@@ -280,13 +342,10 @@\n       \"vendor\": \"Remeha B.V.\"\n     },\n     \"f61f1a2535f54f52ad006a3d18e459ca\": {\n-      \"active_preset\": \"home\",\n       \"available\": true,\n       \"binary_sensors\": {\n         \"low_battery\": false\n       },\n-      \"climate_mode\": \"heat\",\n-      \"control_state\": \"off\",\n       \"dev_class\": \"zone_thermometer\",\n       \"firmware\": \"2020-09-01T02:00:00+02:00\",\n       \"hardware\": \"1\",\n@@ -294,7 +353,6 @@\n       \"model\": \"Jip\",\n       \"model_id\": \"168-01\",\n       \"name\": \"Woonkamer\",\n-      \"preset_modes\": [\"home\", \"asleep\", \"away\", \"vacation\", \"no_frost\"],\n       \"sensors\": {\n         \"battery\": 100,\n         \"humidity\": 56.2,\n@@ -307,12 +365,6 @@\n         \"setpoint\": 0.0,\n         \"upper_bound\": 2.0\n       },\n-      \"thermostat\": {\n-        \"lower_bound\": 4.0,\n-        \"resolution\": 0.01,\n-        \"setpoint\": 9.0,\n-        \"upper_bound\": 30.0\n-      },\n       \"vendor\": \"Plugwise\",\n       \"zigbee_mac_address\": \"ABCD012345670A08\"\n     }\n@@ -321,7 +373,7 @@\n     \"cooling_present\": false,\n     \"gateway_id\": \"b5c2386c6f6342669e50fe49dd05b188\",\n     \"heater_id\": \"e4684553153b44afbef2200885f379dc\",\n-    \"item_count\": 228,\n+    \"item_count\": 244,\n     \"notifications\": {},\n     \"reboot\": true,\n     \"smile_name\": \"Adam\"\ndiff --git a/tests/components/plugwise/fixtures/m_adam_multiple_devices_per_zone/all_data.json b/tests/components/plugwise/fixtures/m_adam_multiple_devices_per_zone/all_data.json\nindex 7c3962b832fbc..67e8c235cc3b9 100644\n--- a/tests/components/plugwise/fixtures/m_adam_multiple_devices_per_zone/all_data.json\n+++ b/tests/components/plugwise/fixtures/m_adam_multiple_devices_per_zone/all_data.json\n@@ -21,6 +21,73 @@\n       \"vendor\": \"Plugwise\",\n       \"zigbee_mac_address\": \"ABCD012345670A15\"\n     },\n+    \"08963fec7c53423ca5680aa4cb502c63\": {\n+      \"active_preset\": \"away\",\n+      \"available_schedules\": [\n+        \"CV Roan\",\n+        \"Bios Schema met Film Avond\",\n+        \"GF7  Woonkamer\",\n+        \"Badkamer Schema\",\n+        \"CV Jessie\",\n+        \"off\"\n+      ],\n+      \"climate_mode\": \"auto\",\n+      \"dev_class\": \"climate\",\n+      \"model\": \"ThermoZone\",\n+      \"name\": \"Badkamer\",\n+      \"preset_modes\": [\"home\", \"asleep\", \"away\", \"vacation\", \"no_frost\"],\n+      \"select_schedule\": \"Badkamer Schema\",\n+      \"sensors\": {\n+        \"temperature\": 18.9\n+      },\n+      \"thermostat\": {\n+        \"lower_bound\": 0.0,\n+        \"resolution\": 0.01,\n+        \"setpoint\": 14.0,\n+        \"upper_bound\": 100.0\n+      },\n+      \"thermostats\": {\n+        \"primary\": [\n+          \"f1fee6043d3642a9b0a65297455f008e\",\n+          \"680423ff840043738f42cc7f1ff97a36\"\n+        ],\n+        \"secondary\": []\n+      },\n+      \"vendor\": \"Plugwise\"\n+    },\n+    \"12493538af164a409c6a1c79e38afe1c\": {\n+      \"active_preset\": \"away\",\n+      \"available_schedules\": [\n+        \"CV Roan\",\n+        \"Bios Schema met Film Avond\",\n+        \"GF7  Woonkamer\",\n+        \"Badkamer Schema\",\n+        \"CV Jessie\",\n+        \"off\"\n+      ],\n+      \"climate_mode\": \"heat\",\n+      \"dev_class\": \"climate\",\n+      \"model\": \"ThermoZone\",\n+      \"name\": \"Bios\",\n+      \"preset_modes\": [\"home\", \"asleep\", \"away\", \"vacation\", \"no_frost\"],\n+      \"select_schedule\": \"off\",\n+      \"sensors\": {\n+        \"electricity_consumed\": 0.0,\n+        \"electricity_produced\": 0.0,\n+        \"temperature\": 16.5\n+      },\n+      \"thermostat\": {\n+        \"lower_bound\": 0.0,\n+        \"resolution\": 0.01,\n+        \"setpoint\": 13.0,\n+        \"upper_bound\": 100.0\n+      },\n+      \"thermostats\": {\n+        \"primary\": [\"df4a4a8169904cdb9c03d61a21f42140\"],\n+        \"secondary\": [\"a2c3583e0a6349358998b760cea82d2a\"]\n+      },\n+      \"vendor\": \"Plugwise\"\n+    },\n     \"21f2b542c49845e6bb416884c55778d6\": {\n       \"available\": true,\n       \"dev_class\": \"game_console_plug\",\n@@ -42,6 +109,28 @@\n       \"vendor\": \"Plugwise\",\n       \"zigbee_mac_address\": \"ABCD012345670A12\"\n     },\n+    \"446ac08dd04d4eff8ac57489757b7314\": {\n+      \"active_preset\": \"no_frost\",\n+      \"climate_mode\": \"heat\",\n+      \"dev_class\": \"climate\",\n+      \"model\": \"ThermoZone\",\n+      \"name\": \"Garage\",\n+      \"preset_modes\": [\"home\", \"asleep\", \"away\", \"vacation\", \"no_frost\"],\n+      \"sensors\": {\n+        \"temperature\": 15.6\n+      },\n+      \"thermostat\": {\n+        \"lower_bound\": 0.0,\n+        \"resolution\": 0.01,\n+        \"setpoint\": 5.5,\n+        \"upper_bound\": 100.0\n+      },\n+      \"thermostats\": {\n+        \"primary\": [\"e7693eb9582644e5b865dba8d4447cf1\"],\n+        \"secondary\": []\n+      },\n+      \"vendor\": \"Plugwise\"\n+    },\n     \"4a810418d5394b3f82727340b91ba740\": {\n       \"available\": true,\n       \"dev_class\": \"router_plug\",\n@@ -89,13 +178,13 @@\n       \"binary_sensors\": {\n         \"low_battery\": false\n       },\n-      \"dev_class\": \"thermo_sensor\",\n+      \"dev_class\": \"thermostatic_radiator_valve\",\n       \"firmware\": \"2019-03-27T01:00:00+01:00\",\n       \"hardware\": \"1\",\n       \"location\": \"08963fec7c53423ca5680aa4cb502c63\",\n       \"model\": \"Tom/Floor\",\n       \"model_id\": \"106-03\",\n-      \"name\": \"Thermostatic Radiator Badkamer\",\n+      \"name\": \"Thermostatic Radiator Badkamer 1\",\n       \"sensors\": {\n         \"battery\": 51,\n         \"setpoint\": 14.0,\n@@ -113,20 +202,10 @@\n       \"zigbee_mac_address\": \"ABCD012345670A17\"\n     },\n     \"6a3bf693d05e48e0b460c815a4fdd09d\": {\n-      \"active_preset\": \"asleep\",\n       \"available\": true,\n-      \"available_schedules\": [\n-        \"CV Roan\",\n-        \"Bios Schema met Film Avond\",\n-        \"GF7  Woonkamer\",\n-        \"Badkamer Schema\",\n-        \"CV Jessie\",\n-        \"off\"\n-      ],\n       \"binary_sensors\": {\n         \"low_battery\": false\n       },\n-      \"climate_mode\": \"auto\",\n       \"dev_class\": \"zone_thermostat\",\n       \"firmware\": \"2016-10-27T02:00:00+02:00\",\n       \"hardware\": \"255\",\n@@ -134,8 +213,6 @@\n       \"model\": \"Lisa\",\n       \"model_id\": \"158-01\",\n       \"name\": \"Zone Thermostat Jessie\",\n-      \"preset_modes\": [\"home\", \"asleep\", \"away\", \"vacation\", \"no_frost\"],\n-      \"select_schedule\": \"CV Jessie\",\n       \"sensors\": {\n         \"battery\": 37,\n         \"setpoint\": 15.0,\n@@ -147,12 +224,6 @@\n         \"setpoint\": 0.0,\n         \"upper_bound\": 2.0\n       },\n-      \"thermostat\": {\n-        \"lower_bound\": 0.0,\n-        \"resolution\": 0.01,\n-        \"setpoint\": 15.0,\n-        \"upper_bound\": 99.9\n-      },\n       \"vendor\": \"Plugwise\",\n       \"zigbee_mac_address\": \"ABCD012345670A03\"\n     },\n@@ -176,6 +247,37 @@\n       \"vendor\": \"Plugwise\",\n       \"zigbee_mac_address\": \"ABCD012345670A05\"\n     },\n+    \"82fa13f017d240daa0d0ea1775420f24\": {\n+      \"active_preset\": \"asleep\",\n+      \"available_schedules\": [\n+        \"CV Roan\",\n+        \"Bios Schema met Film Avond\",\n+        \"GF7  Woonkamer\",\n+        \"Badkamer Schema\",\n+        \"CV Jessie\",\n+        \"off\"\n+      ],\n+      \"climate_mode\": \"auto\",\n+      \"dev_class\": \"climate\",\n+      \"model\": \"ThermoZone\",\n+      \"name\": \"Jessie\",\n+      \"preset_modes\": [\"home\", \"asleep\", \"away\", \"vacation\", \"no_frost\"],\n+      \"select_schedule\": \"CV Jessie\",\n+      \"sensors\": {\n+        \"temperature\": 17.2\n+      },\n+      \"thermostat\": {\n+        \"lower_bound\": 0.0,\n+        \"resolution\": 0.01,\n+        \"setpoint\": 15.0,\n+        \"upper_bound\": 100.0\n+      },\n+      \"thermostats\": {\n+        \"primary\": [\"6a3bf693d05e48e0b460c815a4fdd09d\"],\n+        \"secondary\": [\"d3da73bde12a47d5a6b8f9dad971f2ec\"]\n+      },\n+      \"vendor\": \"Plugwise\"\n+    },\n     \"90986d591dcd426cae3ec3e8111ff730\": {\n       \"binary_sensors\": {\n         \"heating_state\": true\n@@ -216,7 +318,7 @@\n       \"binary_sensors\": {\n         \"low_battery\": false\n       },\n-      \"dev_class\": \"thermo_sensor\",\n+      \"dev_class\": \"thermostatic_radiator_valve\",\n       \"firmware\": \"2019-03-27T01:00:00+01:00\",\n       \"hardware\": \"1\",\n       \"location\": \"12493538af164a409c6a1c79e38afe1c\",\n@@ -241,7 +343,7 @@\n     },\n     \"b310b72a0e354bfab43089919b9a88bf\": {\n       \"available\": true,\n-      \"dev_class\": \"thermo_sensor\",\n+      \"dev_class\": \"thermostatic_radiator_valve\",\n       \"firmware\": \"2019-03-27T01:00:00+01:00\",\n       \"hardware\": \"1\",\n       \"location\": \"c50f167537524366a5af7aa3942feb1e\",\n@@ -264,20 +366,10 @@\n       \"zigbee_mac_address\": \"ABCD012345670A02\"\n     },\n     \"b59bcebaf94b499ea7d46e4a66fb62d8\": {\n-      \"active_preset\": \"home\",\n       \"available\": true,\n-      \"available_schedules\": [\n-        \"CV Roan\",\n-        \"Bios Schema met Film Avond\",\n-        \"GF7  Woonkamer\",\n-        \"Badkamer Schema\",\n-        \"CV Jessie\",\n-        \"off\"\n-      ],\n       \"binary_sensors\": {\n         \"low_battery\": false\n       },\n-      \"climate_mode\": \"auto\",\n       \"dev_class\": \"zone_thermostat\",\n       \"firmware\": \"2016-08-02T02:00:00+02:00\",\n       \"hardware\": \"255\",\n@@ -285,8 +377,6 @@\n       \"model\": \"Lisa\",\n       \"model_id\": \"158-01\",\n       \"name\": \"Zone Lisa WK\",\n-      \"preset_modes\": [\"home\", \"asleep\", \"away\", \"vacation\", \"no_frost\"],\n-      \"select_schedule\": \"GF7  Woonkamer\",\n       \"sensors\": {\n         \"battery\": 34,\n         \"setpoint\": 21.5,\n@@ -298,14 +388,41 @@\n         \"setpoint\": 0.0,\n         \"upper_bound\": 2.0\n       },\n+      \"vendor\": \"Plugwise\",\n+      \"zigbee_mac_address\": \"ABCD012345670A07\"\n+    },\n+    \"c50f167537524366a5af7aa3942feb1e\": {\n+      \"active_preset\": \"home\",\n+      \"available_schedules\": [\n+        \"CV Roan\",\n+        \"Bios Schema met Film Avond\",\n+        \"GF7  Woonkamer\",\n+        \"Badkamer Schema\",\n+        \"CV Jessie\",\n+        \"off\"\n+      ],\n+      \"climate_mode\": \"auto\",\n+      \"dev_class\": \"climate\",\n+      \"model\": \"ThermoZone\",\n+      \"name\": \"Woonkamer\",\n+      \"preset_modes\": [\"home\", \"asleep\", \"away\", \"vacation\", \"no_frost\"],\n+      \"select_schedule\": \"GF7  Woonkamer\",\n+      \"sensors\": {\n+        \"electricity_consumed\": 35.6,\n+        \"electricity_produced\": 0.0,\n+        \"temperature\": 20.9\n+      },\n       \"thermostat\": {\n         \"lower_bound\": 0.0,\n         \"resolution\": 0.01,\n         \"setpoint\": 21.5,\n-        \"upper_bound\": 99.9\n+        \"upper_bound\": 100.0\n       },\n-      \"vendor\": \"Plugwise\",\n-      \"zigbee_mac_address\": \"ABCD012345670A07\"\n+      \"thermostats\": {\n+        \"primary\": [\"b59bcebaf94b499ea7d46e4a66fb62d8\"],\n+        \"secondary\": [\"b310b72a0e354bfab43089919b9a88bf\"]\n+      },\n+      \"vendor\": \"Plugwise\"\n     },\n     \"cd0ddb54ef694e11ac18ed1cbce5dbbd\": {\n       \"available\": true,\n@@ -333,7 +450,7 @@\n       \"binary_sensors\": {\n         \"low_battery\": false\n       },\n-      \"dev_class\": \"thermo_sensor\",\n+      \"dev_class\": \"thermostatic_radiator_valve\",\n       \"firmware\": \"2019-03-27T01:00:00+01:00\",\n       \"hardware\": \"1\",\n       \"location\": \"82fa13f017d240daa0d0ea1775420f24\",\n@@ -357,20 +474,10 @@\n       \"zigbee_mac_address\": \"ABCD012345670A10\"\n     },\n     \"df4a4a8169904cdb9c03d61a21f42140\": {\n-      \"active_preset\": \"away\",\n       \"available\": true,\n-      \"available_schedules\": [\n-        \"CV Roan\",\n-        \"Bios Schema met Film Avond\",\n-        \"GF7  Woonkamer\",\n-        \"Badkamer Schema\",\n-        \"CV Jessie\",\n-        \"off\"\n-      ],\n       \"binary_sensors\": {\n         \"low_battery\": false\n       },\n-      \"climate_mode\": \"heat\",\n       \"dev_class\": \"zone_thermostat\",\n       \"firmware\": \"2016-10-27T02:00:00+02:00\",\n       \"hardware\": \"255\",\n@@ -378,8 +485,6 @@\n       \"model\": \"Lisa\",\n       \"model_id\": \"158-01\",\n       \"name\": \"Zone Lisa Bios\",\n-      \"preset_modes\": [\"home\", \"asleep\", \"away\", \"vacation\", \"no_frost\"],\n-      \"select_schedule\": \"off\",\n       \"sensors\": {\n         \"battery\": 67,\n         \"setpoint\": 13.0,\n@@ -391,22 +496,14 @@\n         \"setpoint\": 0.0,\n         \"upper_bound\": 2.0\n       },\n-      \"thermostat\": {\n-        \"lower_bound\": 0.0,\n-        \"resolution\": 0.01,\n-        \"setpoint\": 13.0,\n-        \"upper_bound\": 99.9\n-      },\n       \"vendor\": \"Plugwise\",\n       \"zigbee_mac_address\": \"ABCD012345670A06\"\n     },\n     \"e7693eb9582644e5b865dba8d4447cf1\": {\n-      \"active_preset\": \"no_frost\",\n       \"available\": true,\n       \"binary_sensors\": {\n         \"low_battery\": false\n       },\n-      \"climate_mode\": \"heat\",\n       \"dev_class\": \"thermostatic_radiator_valve\",\n       \"firmware\": \"2019-03-27T01:00:00+01:00\",\n       \"hardware\": \"1\",\n@@ -414,7 +511,6 @@\n       \"model\": \"Tom/Floor\",\n       \"model_id\": \"106-03\",\n       \"name\": \"CV Kraan Garage\",\n-      \"preset_modes\": [\"home\", \"asleep\", \"away\", \"vacation\", \"no_frost\"],\n       \"sensors\": {\n         \"battery\": 68,\n         \"setpoint\": 5.5,\n@@ -428,39 +524,21 @@\n         \"setpoint\": 0.0,\n         \"upper_bound\": 2.0\n       },\n-      \"thermostat\": {\n-        \"lower_bound\": 0.0,\n-        \"resolution\": 0.01,\n-        \"setpoint\": 5.5,\n-        \"upper_bound\": 100.0\n-      },\n       \"vendor\": \"Plugwise\",\n       \"zigbee_mac_address\": \"ABCD012345670A11\"\n     },\n     \"f1fee6043d3642a9b0a65297455f008e\": {\n-      \"active_preset\": \"away\",\n       \"available\": true,\n-      \"available_schedules\": [\n-        \"CV Roan\",\n-        \"Bios Schema met Film Avond\",\n-        \"GF7  Woonkamer\",\n-        \"Badkamer Schema\",\n-        \"CV Jessie\",\n-        \"off\"\n-      ],\n       \"binary_sensors\": {\n         \"low_battery\": false\n       },\n-      \"climate_mode\": \"auto\",\n-      \"dev_class\": \"zone_thermostat\",\n+      \"dev_class\": \"thermostatic_radiator_valve\",\n       \"firmware\": \"2016-10-27T02:00:00+02:00\",\n       \"hardware\": \"255\",\n       \"location\": \"08963fec7c53423ca5680aa4cb502c63\",\n       \"model\": \"Lisa\",\n       \"model_id\": \"158-01\",\n-      \"name\": \"Zone Thermostat Badkamer\",\n-      \"preset_modes\": [\"home\", \"asleep\", \"away\", \"vacation\", \"no_frost\"],\n-      \"select_schedule\": \"Badkamer Schema\",\n+      \"name\": \"Thermostatic Radiator Badkamer 2\",\n       \"sensors\": {\n         \"battery\": 92,\n         \"setpoint\": 14.0,\n@@ -472,12 +550,6 @@\n         \"setpoint\": 0.0,\n         \"upper_bound\": 2.0\n       },\n-      \"thermostat\": {\n-        \"lower_bound\": 0.0,\n-        \"resolution\": 0.01,\n-        \"setpoint\": 14.0,\n-        \"upper_bound\": 99.9\n-      },\n       \"vendor\": \"Plugwise\",\n       \"zigbee_mac_address\": \"ABCD012345670A08\"\n     },\n@@ -505,7 +577,7 @@\n     \"cooling_present\": false,\n     \"gateway_id\": \"fe799307f1624099878210aa0b9f1475\",\n     \"heater_id\": \"90986d591dcd426cae3ec3e8111ff730\",\n-    \"item_count\": 340,\n+    \"item_count\": 364,\n     \"notifications\": {\n       \"af82e4ccf9c548528166d38e560662a4\": {\n         \"warning\": \"Node Plug (with MAC address 000D6F000D13CB01, in room 'n.a.') has been unreachable since 23:03 2020-01-18. Please check the connection and restart the device.\"\ndiff --git a/tests/components/plugwise/fixtures/stretch_v31/all_data.json b/tests/components/plugwise/fixtures/stretch_v31/all_data.json\nindex a875324fc1391..b1675116bdfcf 100644\n--- a/tests/components/plugwise/fixtures/stretch_v31/all_data.json\n+++ b/tests/components/plugwise/fixtures/stretch_v31/all_data.json\n@@ -96,7 +96,8 @@\n       \"name\": \"Schakel\",\n       \"switches\": {\n         \"relay\": true\n-      }\n+      },\n+      \"vendor\": \"Plugwise\"\n     },\n     \"d950b314e9d8499f968e6db8d82ef78c\": {\n       \"dev_class\": \"report\",\n@@ -111,7 +112,8 @@\n       \"name\": \"Stroomvreters\",\n       \"switches\": {\n         \"relay\": true\n-      }\n+      },\n+      \"vendor\": \"Plugwise\"\n     },\n     \"e1c884e7dede431dadee09506ec4f859\": {\n       \"dev_class\": \"refrigerator\",\ndiff --git a/tests/components/plugwise/snapshots/test_diagnostics.ambr b/tests/components/plugwise/snapshots/test_diagnostics.ambr\nindex 2a8223a256833..bf7d4260a32c6 100644\n--- a/tests/components/plugwise/snapshots/test_diagnostics.ambr\n+++ b/tests/components/plugwise/snapshots/test_diagnostics.ambr\n@@ -23,6 +23,90 @@\n         'vendor': 'Plugwise',\n         'zigbee_mac_address': 'ABCD012345670A15',\n       }),\n+      '08963fec7c53423ca5680aa4cb502c63': dict({\n+        'active_preset': 'away',\n+        'available_schedules': list([\n+          'CV Roan',\n+          'Bios Schema met Film Avond',\n+          'GF7  Woonkamer',\n+          'Badkamer Schema',\n+          'CV Jessie',\n+          'off',\n+        ]),\n+        'climate_mode': 'auto',\n+        'dev_class': 'climate',\n+        'model': 'ThermoZone',\n+        'name': 'Badkamer',\n+        'preset_modes': list([\n+          'home',\n+          'asleep',\n+          'away',\n+          'vacation',\n+          'no_frost',\n+        ]),\n+        'select_schedule': 'Badkamer Schema',\n+        'sensors': dict({\n+          'temperature': 18.9,\n+        }),\n+        'thermostat': dict({\n+          'lower_bound': 0.0,\n+          'resolution': 0.01,\n+          'setpoint': 14.0,\n+          'upper_bound': 100.0,\n+        }),\n+        'thermostats': dict({\n+          'primary': list([\n+            'f1fee6043d3642a9b0a65297455f008e',\n+            '680423ff840043738f42cc7f1ff97a36',\n+          ]),\n+          'secondary': list([\n+          ]),\n+        }),\n+        'vendor': 'Plugwise',\n+      }),\n+      '12493538af164a409c6a1c79e38afe1c': dict({\n+        'active_preset': 'away',\n+        'available_schedules': list([\n+          'CV Roan',\n+          'Bios Schema met Film Avond',\n+          'GF7  Woonkamer',\n+          'Badkamer Schema',\n+          'CV Jessie',\n+          'off',\n+        ]),\n+        'climate_mode': 'heat',\n+        'dev_class': 'climate',\n+        'model': 'ThermoZone',\n+        'name': 'Bios',\n+        'preset_modes': list([\n+          'home',\n+          'asleep',\n+          'away',\n+          'vacation',\n+          'no_frost',\n+        ]),\n+        'select_schedule': 'off',\n+        'sensors': dict({\n+          'electricity_consumed': 0.0,\n+          'electricity_produced': 0.0,\n+          'temperature': 16.5,\n+        }),\n+        'thermostat': dict({\n+          'lower_bound': 0.0,\n+          'resolution': 0.01,\n+          'setpoint': 13.0,\n+          'upper_bound': 100.0,\n+        }),\n+        'thermostats': dict({\n+          'primary': list([\n+            'df4a4a8169904cdb9c03d61a21f42140',\n+          ]),\n+          'secondary': list([\n+            'a2c3583e0a6349358998b760cea82d2a',\n+          ]),\n+        }),\n+        'vendor': 'Plugwise',\n+      }),\n       '21f2b542c49845e6bb416884c55778d6': dict({\n         'available': True,\n         'dev_class': 'game_console_plug',\n@@ -44,6 +128,37 @@\n         'vendor': 'Plugwise',\n         'zigbee_mac_address': 'ABCD012345670A12',\n       }),\n+      '446ac08dd04d4eff8ac57489757b7314': dict({\n+        'active_preset': 'no_frost',\n+        'climate_mode': 'heat',\n+        'dev_class': 'climate',\n+        'model': 'ThermoZone',\n+        'name': 'Garage',\n+        'preset_modes': list([\n+          'home',\n+          'asleep',\n+          'away',\n+          'vacation',\n+          'no_frost',\n+        ]),\n+        'sensors': dict({\n+          'temperature': 15.6,\n+        }),\n+        'thermostat': dict({\n+          'lower_bound': 0.0,\n+          'resolution': 0.01,\n+          'setpoint': 5.5,\n+          'upper_bound': 100.0,\n+        }),\n+        'thermostats': dict({\n+          'primary': list([\n+            'e7693eb9582644e5b865dba8d4447cf1',\n+          ]),\n+          'secondary': list([\n+          ]),\n+        }),\n+        'vendor': 'Plugwise',\n+      }),\n       '4a810418d5394b3f82727340b91ba740': dict({\n         'available': True,\n         'dev_class': 'router_plug',\n@@ -91,13 +206,13 @@\n         'binary_sensors': dict({\n           'low_battery': False,\n         }),\n-        'dev_class': 'thermo_sensor',\n+        'dev_class': 'thermostatic_radiator_valve',\n         'firmware': '2019-03-27T01:00:00+01:00',\n         'hardware': '1',\n         'location': '08963fec7c53423ca5680aa4cb502c63',\n         'model': 'Tom/Floor',\n         'model_id': '106-03',\n-        'name': 'Thermostatic Radiator Badkamer',\n+        'name': 'Thermostatic Radiator Badkamer 1',\n         'sensors': dict({\n           'battery': 51,\n           'setpoint': 14.0,\n@@ -115,20 +230,10 @@\n         'zigbee_mac_address': 'ABCD012345670A17',\n       }),\n       '6a3bf693d05e48e0b460c815a4fdd09d': dict({\n-        'active_preset': 'asleep',\n         'available': True,\n-        'available_schedules': list([\n-          'CV Roan',\n-          'Bios Schema met Film Avond',\n-          'GF7  Woonkamer',\n-          'Badkamer Schema',\n-          'CV Jessie',\n-          'off',\n-        ]),\n         'binary_sensors': dict({\n           'low_battery': False,\n         }),\n-        'climate_mode': 'auto',\n         'dev_class': 'zone_thermostat',\n         'firmware': '2016-10-27T02:00:00+02:00',\n         'hardware': '255',\n@@ -136,14 +241,6 @@\n         'model': 'Lisa',\n         'model_id': '158-01',\n         'name': 'Zone Thermostat Jessie',\n-        'preset_modes': list([\n-          'home',\n-          'asleep',\n-          'away',\n-          'vacation',\n-          'no_frost',\n-        ]),\n-        'select_schedule': 'CV Jessie',\n         'sensors': dict({\n           'battery': 37,\n           'setpoint': 15.0,\n@@ -155,12 +252,6 @@\n           'setpoint': 0.0,\n           'upper_bound': 2.0,\n         }),\n-        'thermostat': dict({\n-          'lower_bound': 0.0,\n-          'resolution': 0.01,\n-          'setpoint': 15.0,\n-          'upper_bound': 99.9,\n-        }),\n         'vendor': 'Plugwise',\n         'zigbee_mac_address': 'ABCD012345670A03',\n       }),\n@@ -184,6 +275,47 @@\n         'vendor': 'Plugwise',\n         'zigbee_mac_address': 'ABCD012345670A05',\n       }),\n+      '82fa13f017d240daa0d0ea1775420f24': dict({\n+        'active_preset': 'asleep',\n+        'available_schedules': list([\n+          'CV Roan',\n+          'Bios Schema met Film Avond',\n+          'GF7  Woonkamer',\n+          'Badkamer Schema',\n+          'CV Jessie',\n+          'off',\n+        ]),\n+        'climate_mode': 'auto',\n+        'dev_class': 'climate',\n+        'model': 'ThermoZone',\n+        'name': 'Jessie',\n+        'preset_modes': list([\n+          'home',\n+          'asleep',\n+          'away',\n+          'vacation',\n+          'no_frost',\n+        ]),\n+        'select_schedule': 'CV Jessie',\n+        'sensors': dict({\n+          'temperature': 17.2,\n+        }),\n+        'thermostat': dict({\n+          'lower_bound': 0.0,\n+          'resolution': 0.01,\n+          'setpoint': 15.0,\n+          'upper_bound': 100.0,\n+        }),\n+        'thermostats': dict({\n+          'primary': list([\n+            '6a3bf693d05e48e0b460c815a4fdd09d',\n+          ]),\n+          'secondary': list([\n+            'd3da73bde12a47d5a6b8f9dad971f2ec',\n+          ]),\n+        }),\n+        'vendor': 'Plugwise',\n+      }),\n       '90986d591dcd426cae3ec3e8111ff730': dict({\n         'binary_sensors': dict({\n           'heating_state': True,\n@@ -224,7 +356,7 @@\n         'binary_sensors': dict({\n           'low_battery': False,\n         }),\n-        'dev_class': 'thermo_sensor',\n+        'dev_class': 'thermostatic_radiator_valve',\n         'firmware': '2019-03-27T01:00:00+01:00',\n         'hardware': '1',\n         'location': '12493538af164a409c6a1c79e38afe1c',\n@@ -249,7 +381,7 @@\n       }),\n       'b310b72a0e354bfab43089919b9a88bf': dict({\n         'available': True,\n-        'dev_class': 'thermo_sensor',\n+        'dev_class': 'thermostatic_radiator_valve',\n         'firmware': '2019-03-27T01:00:00+01:00',\n         'hardware': '1',\n         'location': 'c50f167537524366a5af7aa3942feb1e',\n@@ -272,20 +404,10 @@\n         'zigbee_mac_address': 'ABCD012345670A02',\n       }),\n       'b59bcebaf94b499ea7d46e4a66fb62d8': dict({\n-        'active_preset': 'home',\n         'available': True,\n-        'available_schedules': list([\n-          'CV Roan',\n-          'Bios Schema met Film Avond',\n-          'GF7  Woonkamer',\n-          'Badkamer Schema',\n-          'CV Jessie',\n-          'off',\n-        ]),\n         'binary_sensors': dict({\n           'low_battery': False,\n         }),\n-        'climate_mode': 'auto',\n         'dev_class': 'zone_thermostat',\n         'firmware': '2016-08-02T02:00:00+02:00',\n         'hardware': '255',\n@@ -293,14 +415,6 @@\n         'model': 'Lisa',\n         'model_id': '158-01',\n         'name': 'Zone Lisa WK',\n-        'preset_modes': list([\n-          'home',\n-          'asleep',\n-          'away',\n-          'vacation',\n-          'no_frost',\n-        ]),\n-        'select_schedule': 'GF7  Woonkamer',\n         'sensors': dict({\n           'battery': 34,\n           'setpoint': 21.5,\n@@ -312,14 +426,51 @@\n           'setpoint': 0.0,\n           'upper_bound': 2.0,\n         }),\n+        'vendor': 'Plugwise',\n+        'zigbee_mac_address': 'ABCD012345670A07',\n+      }),\n+      'c50f167537524366a5af7aa3942feb1e': dict({\n+        'active_preset': 'home',\n+        'available_schedules': list([\n+          'CV Roan',\n+          'Bios Schema met Film Avond',\n+          'GF7  Woonkamer',\n+          'Badkamer Schema',\n+          'CV Jessie',\n+          'off',\n+        ]),\n+        'climate_mode': 'auto',\n+        'dev_class': 'climate',\n+        'model': 'ThermoZone',\n+        'name': 'Woonkamer',\n+        'preset_modes': list([\n+          'home',\n+          'asleep',\n+          'away',\n+          'vacation',\n+          'no_frost',\n+        ]),\n+        'select_schedule': 'GF7  Woonkamer',\n+        'sensors': dict({\n+          'electricity_consumed': 35.6,\n+          'electricity_produced': 0.0,\n+          'temperature': 20.9,\n+        }),\n         'thermostat': dict({\n           'lower_bound': 0.0,\n           'resolution': 0.01,\n           'setpoint': 21.5,\n-          'upper_bound': 99.9,\n+          'upper_bound': 100.0,\n+        }),\n+        'thermostats': dict({\n+          'primary': list([\n+            'b59bcebaf94b499ea7d46e4a66fb62d8',\n+          ]),\n+          'secondary': list([\n+            'b310b72a0e354bfab43089919b9a88bf',\n+          ]),\n         }),\n         'vendor': 'Plugwise',\n-        'zigbee_mac_address': 'ABCD012345670A07',\n       }),\n       'cd0ddb54ef694e11ac18ed1cbce5dbbd': dict({\n         'available': True,\n@@ -347,7 +498,7 @@\n         'binary_sensors': dict({\n           'low_battery': False,\n         }),\n-        'dev_class': 'thermo_sensor',\n+        'dev_class': 'thermostatic_radiator_valve',\n         'firmware': '2019-03-27T01:00:00+01:00',\n         'hardware': '1',\n         'location': '82fa13f017d240daa0d0ea1775420f24',\n@@ -371,20 +522,10 @@\n         'zigbee_mac_address': 'ABCD012345670A10',\n       }),\n       'df4a4a8169904cdb9c03d61a21f42140': dict({\n-        'active_preset': 'away',\n         'available': True,\n-        'available_schedules': list([\n-          'CV Roan',\n-          'Bios Schema met Film Avond',\n-          'GF7  Woonkamer',\n-          'Badkamer Schema',\n-          'CV Jessie',\n-          'off',\n-        ]),\n         'binary_sensors': dict({\n           'low_battery': False,\n         }),\n-        'climate_mode': 'heat',\n         'dev_class': 'zone_thermostat',\n         'firmware': '2016-10-27T02:00:00+02:00',\n         'hardware': '255',\n@@ -392,14 +533,6 @@\n         'model': 'Lisa',\n         'model_id': '158-01',\n         'name': 'Zone Lisa Bios',\n-        'preset_modes': list([\n-          'home',\n-          'asleep',\n-          'away',\n-          'vacation',\n-          'no_frost',\n-        ]),\n-        'select_schedule': 'off',\n         'sensors': dict({\n           'battery': 67,\n           'setpoint': 13.0,\n@@ -411,22 +544,14 @@\n           'setpoint': 0.0,\n           'upper_bound': 2.0,\n         }),\n-        'thermostat': dict({\n-          'lower_bound': 0.0,\n-          'resolution': 0.01,\n-          'setpoint': 13.0,\n-          'upper_bound': 99.9,\n-        }),\n         'vendor': 'Plugwise',\n         'zigbee_mac_address': 'ABCD012345670A06',\n       }),\n       'e7693eb9582644e5b865dba8d4447cf1': dict({\n-        'active_preset': 'no_frost',\n         'available': True,\n         'binary_sensors': dict({\n           'low_battery': False,\n         }),\n-        'climate_mode': 'heat',\n         'dev_class': 'thermostatic_radiator_valve',\n         'firmware': '2019-03-27T01:00:00+01:00',\n         'hardware': '1',\n@@ -434,13 +559,6 @@\n         'model': 'Tom/Floor',\n         'model_id': '106-03',\n         'name': 'CV Kraan Garage',\n-        'preset_modes': list([\n-          'home',\n-          'asleep',\n-          'away',\n-          'vacation',\n-          'no_frost',\n-        ]),\n         'sensors': dict({\n           'battery': 68,\n           'setpoint': 5.5,\n@@ -454,45 +572,21 @@\n           'setpoint': 0.0,\n           'upper_bound': 2.0,\n         }),\n-        'thermostat': dict({\n-          'lower_bound': 0.0,\n-          'resolution': 0.01,\n-          'setpoint': 5.5,\n-          'upper_bound': 100.0,\n-        }),\n         'vendor': 'Plugwise',\n         'zigbee_mac_address': 'ABCD012345670A11',\n       }),\n       'f1fee6043d3642a9b0a65297455f008e': dict({\n-        'active_preset': 'away',\n         'available': True,\n-        'available_schedules': list([\n-          'CV Roan',\n-          'Bios Schema met Film Avond',\n-          'GF7  Woonkamer',\n-          'Badkamer Schema',\n-          'CV Jessie',\n-          'off',\n-        ]),\n         'binary_sensors': dict({\n           'low_battery': False,\n         }),\n-        'climate_mode': 'auto',\n-        'dev_class': 'zone_thermostat',\n+        'dev_class': 'thermostatic_radiator_valve',\n         'firmware': '2016-10-27T02:00:00+02:00',\n         'hardware': '255',\n         'location': '08963fec7c53423ca5680aa4cb502c63',\n         'model': 'Lisa',\n         'model_id': '158-01',\n-        'name': 'Zone Thermostat Badkamer',\n-        'preset_modes': list([\n-          'home',\n-          'asleep',\n-          'away',\n-          'vacation',\n-          'no_frost',\n-        ]),\n-        'select_schedule': 'Badkamer Schema',\n+        'name': 'Thermostatic Radiator Badkamer 2',\n         'sensors': dict({\n           'battery': 92,\n           'setpoint': 14.0,\n@@ -504,12 +598,6 @@\n           'setpoint': 0.0,\n           'upper_bound': 2.0,\n         }),\n-        'thermostat': dict({\n-          'lower_bound': 0.0,\n-          'resolution': 0.01,\n-          'setpoint': 14.0,\n-          'upper_bound': 99.9,\n-        }),\n         'vendor': 'Plugwise',\n         'zigbee_mac_address': 'ABCD012345670A08',\n       }),\n@@ -537,7 +625,7 @@\n       'cooling_present': False,\n       'gateway_id': 'fe799307f1624099878210aa0b9f1475',\n       'heater_id': '90986d591dcd426cae3ec3e8111ff730',\n-      'item_count': 340,\n+      'item_count': 364,\n       'notifications': dict({\n         'af82e4ccf9c548528166d38e560662a4': dict({\n           'warning': \"Node Plug (with MAC address 000D6F000D13CB01, in room 'n.a.') has been unreachable since 23:03 2020-01-18. Please check the connection and restart the device.\",\ndiff --git a/tests/components/plugwise/test_climate.py b/tests/components/plugwise/test_climate.py\nindex f846e818b6e89..c0c1c00c68dbc 100644\n--- a/tests/components/plugwise/test_climate.py\n+++ b/tests/components/plugwise/test_climate.py\n@@ -28,7 +28,7 @@ async def test_adam_climate_entity_attributes(\n     hass: HomeAssistant, mock_smile_adam: MagicMock, init_integration: MockConfigEntry\n ) -> None:\n     \"\"\"Test creation of adam climate device environment.\"\"\"\n-    state = hass.states.get(\"climate.zone_lisa_wk\")\n+    state = hass.states.get(\"climate.woonkamer\")\n     assert state\n     assert state.state == HVACMode.AUTO\n     assert state.attributes[\"hvac_modes\"] == [HVACMode.AUTO, HVACMode.HEAT]\n@@ -46,7 +46,7 @@ async def test_adam_climate_entity_attributes(\n     assert state.attributes[\"max_temp\"] == 35.0\n     assert state.attributes[\"target_temp_step\"] == 0.1\n \n-    state = hass.states.get(\"climate.zone_thermostat_jessie\")\n+    state = hass.states.get(\"climate.jessie\")\n     assert state\n     assert state.state == HVACMode.AUTO\n     assert state.attributes[\"hvac_modes\"] == [HVACMode.AUTO, HVACMode.HEAT]\n@@ -68,7 +68,7 @@ async def test_adam_2_climate_entity_attributes(\n     hass: HomeAssistant, mock_smile_adam_2: MagicMock, init_integration: MockConfigEntry\n ) -> None:\n     \"\"\"Test creation of adam climate device environment.\"\"\"\n-    state = hass.states.get(\"climate.anna\")\n+    state = hass.states.get(\"climate.living_room\")\n     assert state\n     assert state.state == HVACMode.HEAT\n     assert state.attributes[\"hvac_action\"] == \"preheating\"\n@@ -78,7 +78,7 @@ async def test_adam_2_climate_entity_attributes(\n         HVACMode.HEAT,\n     ]\n \n-    state = hass.states.get(\"climate.lisa_badkamer\")\n+    state = hass.states.get(\"climate.bathroom\")\n     assert state\n     assert state.state == HVACMode.AUTO\n     assert state.attributes[\"hvac_action\"] == \"idle\"\n@@ -96,7 +96,7 @@ async def test_adam_3_climate_entity_attributes(\n     freezer: FrozenDateTimeFactory,\n ) -> None:\n     \"\"\"Test creation of adam climate device environment.\"\"\"\n-    state = hass.states.get(\"climate.anna\")\n+    state = hass.states.get(\"climate.living_room\")\n     assert state\n     assert state.state == HVACMode.COOL\n     assert state.attributes[\"hvac_action\"] == \"cooling\"\n@@ -109,7 +109,7 @@ async def test_adam_3_climate_entity_attributes(\n     data.devices[\"da224107914542988a88561b4452b0f6\"][\"select_regulation_mode\"] = (\n         \"heating\"\n     )\n-    data.devices[\"ad4838d7d35c4d6ea796ee12ae5aedf8\"][\"control_state\"] = \"heating\"\n+    data.devices[\"f2bf9048bef64cc5b6d5110154e33c81\"][\"control_state\"] = \"heating\"\n     data.devices[\"056ee145a816487eaa69243c3280f8bf\"][\"binary_sensors\"][\n         \"cooling_state\"\n     ] = False\n@@ -121,7 +121,7 @@ async def test_adam_3_climate_entity_attributes(\n         async_fire_time_changed(hass)\n         await hass.async_block_till_done()\n \n-        state = hass.states.get(\"climate.anna\")\n+        state = hass.states.get(\"climate.living_room\")\n         assert state\n         assert state.state == HVACMode.HEAT\n         assert state.attributes[\"hvac_action\"] == \"heating\"\n@@ -135,7 +135,7 @@ async def test_adam_3_climate_entity_attributes(\n     data.devices[\"da224107914542988a88561b4452b0f6\"][\"select_regulation_mode\"] = (\n         \"cooling\"\n     )\n-    data.devices[\"ad4838d7d35c4d6ea796ee12ae5aedf8\"][\"control_state\"] = \"cooling\"\n+    data.devices[\"f2bf9048bef64cc5b6d5110154e33c81\"][\"control_state\"] = \"cooling\"\n     data.devices[\"056ee145a816487eaa69243c3280f8bf\"][\"binary_sensors\"][\n         \"cooling_state\"\n     ] = True\n@@ -147,7 +147,7 @@ async def test_adam_3_climate_entity_attributes(\n         async_fire_time_changed(hass)\n         await hass.async_block_till_done()\n \n-        state = hass.states.get(\"climate.anna\")\n+        state = hass.states.get(\"climate.living_room\")\n         assert state\n         assert state.state == HVACMode.COOL\n         assert state.attributes[\"hvac_action\"] == \"cooling\"\n@@ -168,7 +168,7 @@ async def test_adam_climate_adjust_negative_testing(\n         await hass.services.async_call(\n             CLIMATE_DOMAIN,\n             SERVICE_SET_TEMPERATURE,\n-            {\"entity_id\": \"climate.zone_lisa_wk\", \"temperature\": 25},\n+            {\"entity_id\": \"climate.woonkamer\", \"temperature\": 25},\n             blocking=True,\n         )\n \n@@ -180,7 +180,7 @@ async def test_adam_climate_entity_climate_changes(\n     await hass.services.async_call(\n         CLIMATE_DOMAIN,\n         SERVICE_SET_TEMPERATURE,\n-        {\"entity_id\": \"climate.zone_lisa_wk\", \"temperature\": 25},\n+        {\"entity_id\": \"climate.woonkamer\", \"temperature\": 25},\n         blocking=True,\n     )\n     assert mock_smile_adam.set_temperature.call_count == 1\n@@ -192,7 +192,7 @@ async def test_adam_climate_entity_climate_changes(\n         CLIMATE_DOMAIN,\n         SERVICE_SET_TEMPERATURE,\n         {\n-            \"entity_id\": \"climate.zone_lisa_wk\",\n+            \"entity_id\": \"climate.woonkamer\",\n             \"hvac_mode\": \"heat\",\n             \"temperature\": 25,\n         },\n@@ -207,14 +207,14 @@ async def test_adam_climate_entity_climate_changes(\n         await hass.services.async_call(\n             CLIMATE_DOMAIN,\n             SERVICE_SET_TEMPERATURE,\n-            {\"entity_id\": \"climate.zone_lisa_wk\", \"temperature\": 150},\n+            {\"entity_id\": \"climate.woonkamer\", \"temperature\": 150},\n             blocking=True,\n         )\n \n     await hass.services.async_call(\n         CLIMATE_DOMAIN,\n         SERVICE_SET_PRESET_MODE,\n-        {\"entity_id\": \"climate.zone_lisa_wk\", \"preset_mode\": \"away\"},\n+        {\"entity_id\": \"climate.woonkamer\", \"preset_mode\": \"away\"},\n         blocking=True,\n     )\n     assert mock_smile_adam.set_preset.call_count == 1\n@@ -225,7 +225,7 @@ async def test_adam_climate_entity_climate_changes(\n     await hass.services.async_call(\n         CLIMATE_DOMAIN,\n         SERVICE_SET_HVAC_MODE,\n-        {\"entity_id\": \"climate.zone_lisa_wk\", \"hvac_mode\": \"heat\"},\n+        {\"entity_id\": \"climate.woonkamer\", \"hvac_mode\": \"heat\"},\n         blocking=True,\n     )\n     assert mock_smile_adam.set_schedule_state.call_count == 2\n@@ -238,7 +238,7 @@ async def test_adam_climate_entity_climate_changes(\n             CLIMATE_DOMAIN,\n             SERVICE_SET_HVAC_MODE,\n             {\n-                \"entity_id\": \"climate.zone_thermostat_jessie\",\n+                \"entity_id\": \"climate.jessie\",\n                 \"hvac_mode\": \"dry\",\n             },\n             blocking=True,\ndiff --git a/tests/components/plugwise/test_init.py b/tests/components/plugwise/test_init.py\nindex 5b276d5018dc1..3b9881c9e3dfc 100644\n--- a/tests/components/plugwise/test_init.py\n+++ b/tests/components/plugwise/test_init.py\n@@ -34,17 +34,18 @@\n TOM = {\n     \"01234567890abcdefghijklmnopqrstu\": {\n         \"available\": True,\n-        \"dev_class\": \"thermo_sensor\",\n+        \"dev_class\": \"thermostatic_radiator_valve\",\n         \"firmware\": \"2020-11-04T01:00:00+01:00\",\n         \"hardware\": \"1\",\n         \"location\": \"f871b8c4d63549319221e294e4f88074\",\n         \"model\": \"Tom/Floor\",\n-        \"name\": \"Tom Zolder\",\n+        \"name\": \"Tom Badkamer 2\",\n         \"binary_sensors\": {\n             \"low_battery\": False,\n         },\n         \"sensors\": {\n             \"battery\": 99,\n+            \"setpoint\": 18.0,\n             \"temperature\": 18.6,\n             \"temperature_difference\": 2.3,\n             \"valve_position\": 0.0,\n@@ -246,7 +247,7 @@ async def test_update_device(\n                 entity_registry, mock_config_entry.entry_id\n             )\n         )\n-        == 31\n+        == 38\n     )\n     assert (\n         len(\n@@ -254,11 +255,19 @@ async def test_update_device(\n                 device_registry, mock_config_entry.entry_id\n             )\n         )\n-        == 6\n+        == 8\n     )\n \n     # Add a 2nd Tom/Floor\n     data.devices.update(TOM)\n+    data.devices[\"f871b8c4d63549319221e294e4f88074\"][\"thermostats\"].update(\n+        {\n+            \"secondary\": [\n+                \"01234567890abcdefghijklmnopqrstu\",\n+                \"1772a4ea304041adb83f357b751341ff\",\n+            ]\n+        }\n+    )\n     with patch(HA_PLUGWISE_SMILE_ASYNC_UPDATE, return_value=data):\n         freezer.tick(timedelta(minutes=1))\n         async_fire_time_changed(hass)\n@@ -270,7 +279,7 @@ async def test_update_device(\n                     entity_registry, mock_config_entry.entry_id\n                 )\n             )\n-            == 37\n+            == 45\n         )\n         assert (\n             len(\n@@ -278,7 +287,7 @@ async def test_update_device(\n                     device_registry, mock_config_entry.entry_id\n                 )\n             )\n-            == 7\n+            == 9\n         )\n         item_list: list[str] = []\n         for device_entry in list(device_registry.devices.values()):\n@@ -286,6 +295,9 @@ async def test_update_device(\n         assert \"01234567890abcdefghijklmnopqrstu\" in item_list\n \n     # Remove the existing Tom/Floor\n+    data.devices[\"f871b8c4d63549319221e294e4f88074\"][\"thermostats\"].update(\n+        {\"secondary\": [\"01234567890abcdefghijklmnopqrstu\"]}\n+    )\n     data.devices.pop(\"1772a4ea304041adb83f357b751341ff\")\n     with patch(HA_PLUGWISE_SMILE_ASYNC_UPDATE, return_value=data):\n         freezer.tick(timedelta(minutes=1))\n@@ -298,7 +310,7 @@ async def test_update_device(\n                     entity_registry, mock_config_entry.entry_id\n                 )\n             )\n-            == 31\n+            == 38\n         )\n         assert (\n             len(\n@@ -306,7 +318,7 @@ async def test_update_device(\n                     device_registry, mock_config_entry.entry_id\n                 )\n             )\n-            == 6\n+            == 8\n         )\n         item_list: list[str] = []\n         for device_entry in list(device_registry.devices.values()):\ndiff --git a/tests/components/plugwise/test_select.py b/tests/components/plugwise/test_select.py\nindex f521787714b16..0fab41cdbaea4 100644\n--- a/tests/components/plugwise/test_select.py\n+++ b/tests/components/plugwise/test_select.py\n@@ -18,7 +18,7 @@ async def test_adam_select_entities(\n ) -> None:\n     \"\"\"Test a thermostat Select.\"\"\"\n \n-    state = hass.states.get(\"select.zone_lisa_wk_thermostat_schedule\")\n+    state = hass.states.get(\"select.woonkamer_thermostat_schedule\")\n     assert state\n     assert state.state == \"GF7  Woonkamer\"\n \n@@ -32,7 +32,7 @@ async def test_adam_change_select_entity(\n         SELECT_DOMAIN,\n         SERVICE_SELECT_OPTION,\n         {\n-            ATTR_ENTITY_ID: \"select.zone_lisa_wk_thermostat_schedule\",\n+            ATTR_ENTITY_ID: \"select.woonkamer_thermostat_schedule\",\n             ATTR_OPTION: \"Badkamer Schema\",\n         },\n         blocking=True,\n", "problem_statement": "Mismatch in climatecontrol thermostat with plugwise app when using two tom/floors in a zone\n### The problem\r\n![image](https://github.com/user-attachments/assets/fe06f154-5de8-495d-b068-cc845b21f439)\r\n\r\nI have a setup where **two** tom/floors are grouped in a zone.\r\nThe plugwise app uses the **first** tom/floor in the zone as the 'thermostat' \r\nThe homeassistant integration only creates a climate control bound to the **last** tom/floor in the group. \r\n\r\nThis creates a mismatch between the temperature readout and because of that issues with controlling the zone using the provided climate thermostat control.\r\n\r\n### What version of Home Assistant Core has the issue?\r\n\r\ncore-2024.10.3\r\n\r\n### What was the last working version of Home Assistant Core?\r\n\r\n_No response_\r\n\r\n### What type of installation are you running?\r\n\r\nHome Assistant Container\r\n\r\n### Integration causing the issue\r\n\r\nPlugwise\r\n\r\n### Link to integration documentation on our website\r\n\r\nhttps://www.home-assistant.io/integrations/plugwise\r\n\r\n### Diagnostics information\r\n\r\n[config_entry-plugwise-01JCBJ4S2MX47CAR9DRWVC4W05.json](https://github.com/user-attachments/files/17745578/config_entry-plugwise-01JCBJ4S2MX47CAR9DRWVC4W05.json)\r\n\r\n\r\n### Example YAML snippet\r\n\r\n_No response_\r\n\r\n### Anything in the logs that might be useful for us?\r\n\r\n_No response_\r\n\r\n### Additional information\r\n\r\nI've tried moving tom 9400 and reloading which gets me the climate control for tom 4D. However after adding 9400 the climate control for 4D is no longer provided.\r\nI've tried adding the toms in a different sequence to the plugwise app, but this did't affect which one was offered as climate control.\r\nI've tried renaming toms in the plugwise interface, but this didn't affect which one was created as climate control.\n", "hints_text": "\nHey there @compatech, @bouwew, @frenck, mind taking a look at this issue as it has been labeled with an integration (`plugwise`) you are listed as a [code owner](https://github.com/home-assistant/core/blob/dev/CODEOWNERS#L1126) for? Thanks!\n\n<details>\n<summary>Code owner commands</summary>\n\n\nCode owners of `plugwise` can trigger bot actions by commenting:\n\n- `@home-assistant close` Closes the issue.\n- `@home-assistant rename Awesome new title` Renames the issue.\n- `@home-assistant reopen` Reopen the issue.\n- `@home-assistant unassign plugwise` Removes the current integration label and assignees on the issue, add the integration domain after the command.\n- `@home-assistant add-label needs-more-information` Add a label (needs-more-information, problem in dependency, problem in custom component) to the issue.\n- `@home-assistant remove-label needs-more-information` Remove a label (needs-more-information, problem in dependency, problem in custom component) on the issue.\n\n</details>\n\n\n<sub><sup>(message by CodeOwnersMention)</sup></sub>\n\n---\n\n[plugwise documentation](https://www.home-assistant.io/integrations/plugwise)\n[plugwise source](https://github.com/home-assistant/core/tree/dev/homeassistant/components/plugwise)\n<sub><sup>(message by IssueLinks)</sup></sub>\n@VraagSander From what the picture shows I would guess that the Plugwise App shows the thermostat that reports the lowest temperature in the Badkamer. I'm wondering, what happens when you change the setpoint of the other Tom to 20? Will it then change the setpoint to 20 in the thermostat shown in the App?\n@bouwew \r\nThe setpoints of both toms are linked. If I update the thermostat of the zone via the app, both setpoints are adjusted. \r\nI can only adjust the setpoint of one of the toms, changing it is picked up by the plugwise app and then synced to the other toms.  \r\n![image](https://github.com/user-attachments/assets/46503fe8-edb1-4380-a251-7176fde13e5c)\r\n\r\n\nOk thanks for trying this. I can see what happens.\r\n\r\nThe quickest way forward in fixing this would be for you to capture some data from your Adam and sharing this data with me.\r\nBased on this data I should be able to find out how to fix this issue.\r\n\r\nPlease browse to your Adam via the \"Visit\"-link in HA, enter login (smile) and passwd (Smile ID) and browse to the following path: http://<ip of Adam>/core/domain_objects.\r\nYou should see a page with lots of xml data. Right-click anywhere on this page and select Save as ... (xml) into a file on your computer.\r\nPlease send this file with xml-data to bouwe at westerdijk point info (please change to a real email address :) )\nAlso, when you change something in your system, it should be picked up automatically by the Plugwise integration.\r\nThe thing is, when you change the name, the entity-name in HA will change too. So a name-change is not picked up.\r\n\r\nThe best way to fix this is to delete the Plugwise integration, wait for the Adam to be discovered, and add it again.\r\nIf the Adam is not discovered in a few minutes, try restarting HA.\nI've share the requested document by mail.\r\n\r\n(If i update a name in the plugwise app reloading the integration is sufficient to have the namechange reflected in the devices.)\r\n\r\nDifferent case same problem:  \r\n\r\n![image](https://github.com/user-attachments/assets/42bc6d53-0aa0-4a44-a1b7-e87ecdad32f3)\r\n\r\nThe plugwise integration uses the first lisa in the zone as 'primary' thermostat\r\nThe homeassistant integration in this case gives preference to the last thermostat in the zone (an anna in this case)\r\n\r\n\nI stand corrected. According to plugwise's documentation it is indeed either the lowest measured temperature from all thermostats in a zone, or the lowest measuring tom (if only toms are in a zone).\r\n\r\nhttps://plugwisehelp.freshdesk.com/en/support/solutions/articles/44002158527-what-measured-temperature-does-adam-use-\nOK, that's clear too, and thanks for the link!\r\n\r\nAn interesting use-case you are having at home :)\r\nThis is the first time that such a use-case comes up.\r\n\r\nIn the past we did notice the difference between a Tom used together with a Lisa or a standalone Tom.\r\nBut we had not encountered the scenario you have at home.\r\nIt will be interesting to see your Adam's xml-data, I'm hoping that it is somehow visible what the roles are of each device.\nHi Bouwe, sorry for supplying the wrong file at first. I've now sent my domain.xml. I hope it is useful. \r\n\r\nI also included my locations.xml file from /core/locations . \r\n\r\nEach location node there has a logs node holding the latest recorded thermostat setpoint and temperature measurement of the particular location.\r\nThere is also an actuator node included that correctly matches the termostat's state as reflected in the plugwise dashboard (heating, off, cooling)\r\nI tested them working by changing the setpoint and heating a node.\r\n\r\n![image](https://github.com/user-attachments/assets/ba6a2ae8-ec86-42f9-9d94-dd93dc7b86a5)\r\n\r\n![image](https://github.com/user-attachments/assets/3bbd7394-7394-4af6-9227-16407bc0b3b2)\r\n\r\n![image](https://github.com/user-attachments/assets/a611e838-6bdb-4088-b486-9c91e02932fd)\r\n\r\nPerhaps it can serve as a good source for the locations thermostats. \n@VraagSander Thanks for sending the xml-data!\r\n\r\nYes, I've come to the same conclusion after studying the problem. Us integration-owners were thinking too much device-related because we didn't know better, we only have a single primary thermostat in our homes.\r\nBut with the info you have provided it became clear that the Plugwise climate entities correspond to a zone/location.\r\nWorking on a solution...\n@VraagSander I have a solution working in the custom_component Plugwise-beta.\r\nIf you willing to help test, please let me know at https://github.com/plugwise/plugwise-beta/pull/770", "created_at": "2024-11-26T19:07:08Z"}
{"repo": "home-assistant/core", "pull_number": 131650, "instance_id": "home-assistant__core-131650", "issue_numbers": ["131648"], "base_commit": "192ffc09ee9ffdbb344d4b9f096ed1b841bbb8a0", "patch": "diff --git a/homeassistant/components/london_underground/const.py b/homeassistant/components/london_underground/const.py\nindex 532f4333ba925..447ed4461f3a7 100644\n--- a/homeassistant/components/london_underground/const.py\n+++ b/homeassistant/components/london_underground/const.py\n@@ -24,4 +24,10 @@\n     \"Piccadilly\",\n     \"Victoria\",\n     \"Waterloo & City\",\n+    \"Liberty\",\n+    \"Lioness\",\n+    \"Mildmay\",\n+    \"Suffragette\",\n+    \"Weaver\",\n+    \"Windrush\",\n ]\n", "test_patch": "", "problem_statement": "London Overground: no data; are new line names present in the API?\n### The problem\n\nThe London Underground integration is not reporting any data for London Overground. You may want to check the API, as the umbrella term London Overground may be split into the new line names: Liberty, Lioness, Mildmay, Suffragette, Weaver, Windrush.\n\n### What version of Home Assistant Core has the issue?\n\ncore-2024.11.3\n\n### What was the last working version of Home Assistant Core?\n\ncore-2024.11.3\n\n### What type of installation are you running?\n\nHome Assistant OS\n\n### Integration causing the issue\n\nLondon Underground\n\n### Link to integration documentation on our website\n\nhttps://www.home-assistant.io/integrations/london_underground\n\n### Diagnostics information\n\n_No response_\n\n### Example YAML snippet\n\n_No response_\n\n### Anything in the logs that might be useful for us?\n\n_No response_\n\n### Additional information\n\n_No response_\n", "hints_text": "\nHey there @jpbede, mind taking a look at this issue as it has been labeled with an integration (`london_underground`) you are listed as a [code owner](https://github.com/home-assistant/core/blob/dev/CODEOWNERS#L857) for? Thanks!\n\n<details>\n<summary>Code owner commands</summary>\n\n\nCode owners of `london_underground` can trigger bot actions by commenting:\n\n- `@home-assistant close` Closes the issue.\n- `@home-assistant rename Awesome new title` Renames the issue.\n- `@home-assistant reopen` Reopen the issue.\n- `@home-assistant unassign london_underground` Removes the current integration label and assignees on the issue, add the integration domain after the command.\n- `@home-assistant add-label needs-more-information` Add a label (needs-more-information, problem in dependency, problem in custom component) to the issue.\n- `@home-assistant remove-label needs-more-information` Remove a label (needs-more-information, problem in dependency, problem in custom component) on the issue.\n\n</details>\n\n\n<sub><sup>(message by CodeOwnersMention)</sup></sub>\n\n---\n\n[london_underground documentation](https://www.home-assistant.io/integrations/london_underground)\n[london_underground source](https://github.com/home-assistant/core/tree/dev/homeassistant/components/london_underground)\n<sub><sup>(message by IssueLinks)</sup></sub>", "created_at": "2024-11-26T17:25:38Z"}
{"repo": "home-assistant/core", "pull_number": 131627, "instance_id": "home-assistant__core-131627", "issue_numbers": ["131516"], "base_commit": "9510ef56f9a6399d5c0894d36410288667b83209", "patch": "diff --git a/homeassistant/components/ring/manifest.json b/homeassistant/components/ring/manifest.json\nindex 22a7171332f0b..86758b2679486 100644\n--- a/homeassistant/components/ring/manifest.json\n+++ b/homeassistant/components/ring/manifest.json\n@@ -29,5 +29,5 @@\n   \"documentation\": \"https://www.home-assistant.io/integrations/ring\",\n   \"iot_class\": \"cloud_polling\",\n   \"loggers\": [\"ring_doorbell\"],\n-  \"requirements\": [\"ring-doorbell==0.9.12\"]\n+  \"requirements\": [\"ring-doorbell==0.9.13\"]\n }\ndiff --git a/requirements_all.txt b/requirements_all.txt\nindex 9519ac823939d..f758f2d9cbb47 100644\n--- a/requirements_all.txt\n+++ b/requirements_all.txt\n@@ -2565,7 +2565,7 @@ rfk101py==0.0.1\n rflink==0.0.66\n \n # homeassistant.components.ring\n-ring-doorbell==0.9.12\n+ring-doorbell==0.9.13\n \n # homeassistant.components.fleetgo\n ritassist==0.9.2\n", "test_patch": "diff --git a/requirements_test_all.txt b/requirements_test_all.txt\nindex 82be50ab1ef49..13ab6ecf718e5 100644\n--- a/requirements_test_all.txt\n+++ b/requirements_test_all.txt\n@@ -2053,7 +2053,7 @@ reolink-aio==0.11.3\n rflink==0.0.66\n \n # homeassistant.components.ring\n-ring-doorbell==0.9.12\n+ring-doorbell==0.9.13\n \n # homeassistant.components.roku\n rokuecp==0.19.3\n", "problem_statement": "No Motion Entity for new Ring Battery Video Doorbell 2024 \n### The problem\n\nHey,\r\n\r\nI bought a New Ring Doorbell to replace my old one. Sadly the only things I see are the camera stream, Last Activity, Battery and Volume. The old Doorbell also showed me the motion and the state (as in if the button is pushed) here I have no chance to see any of it, which really is bothering me as I have automations running, using motion as a trigger. It also shows \"Unknown Doorbell\" instead of the Doorbell Name\n\n### What version of Home Assistant Core has the issue?\n\n2024.11.3\n\n### What was the last working version of Home Assistant Core?\n\n_No response_\n\n### What type of installation are you running?\n\nHome Assistant Core\n\n### Integration causing the issue\n\nRing\n\n### Link to integration documentation on our website\n\nhttps://www.home-assistant.io/integrations/ring/\n\n### Diagnostics information\n\n[home-assistant_ring_2024-11-25T09-50-36.561Z.log](https://github.com/user-attachments/files/17900828/home-assistant_ring_2024-11-25T09-50-36.561Z.log)\r\n\n\n### Example YAML snippet\n\n_No response_\n\n### Anything in the logs that might be useful for us?\n\n```txt\nI doubt it\n```\n\n\n### Additional information\n\n![image](https://github.com/user-attachments/assets/961ad8c6-b5d4-4466-bdef-95f9f49807de)\r\n\n", "hints_text": "\nHey there @sdb9696, mind taking a look at this issue as it has been labeled with an integration (`ring`) you are listed as a [code owner](https://github.com/home-assistant/core/blob/dev/CODEOWNERS#L1239) for? Thanks!\n\n<details>\n<summary>Code owner commands</summary>\n\n\nCode owners of `ring` can trigger bot actions by commenting:\n\n- `@home-assistant close` Closes the issue.\n- `@home-assistant rename Awesome new title` Renames the issue.\n- `@home-assistant reopen` Reopen the issue.\n- `@home-assistant unassign ring` Removes the current integration label and assignees on the issue, add the integration domain after the command.\n- `@home-assistant add-label needs-more-information` Add a label (needs-more-information, problem in dependency, problem in custom component) to the issue.\n- `@home-assistant remove-label needs-more-information` Remove a label (needs-more-information, problem in dependency, problem in custom component) on the issue.\n\n</details>\n\n\n<sub><sup>(message by CodeOwnersMention)</sup></sub>\n\n---\n\n[ring documentation](https://www.home-assistant.io/integrations/ring)\n[ring source](https://github.com/home-assistant/core/tree/dev/homeassistant/components/ring)\n<sub><sup>(message by IssueLinks)</sup></sub>\nCould you upload the diagnostic information from clicking \"Download diagnostics\"?\r\n\r\n![image](https://github.com/user-attachments/assets/05f9a4fd-07c1-473f-8f10-7129fddfab02)\r\n\n@home-assistant add-label needs-more-information\nSure here they are\r\n[config_entry-ring-2b9509f57c52baf741bf9e648628b4d8.json](https://github.com/user-attachments/files/17914003/config_entry-ring-2b9509f57c52baf741bf9e648628b4d8.json)\r\n", "created_at": "2024-11-26T14:12:57Z"}
{"repo": "home-assistant/core", "pull_number": 131625, "instance_id": "home-assistant__core-131625", "issue_numbers": ["127509"], "base_commit": "9510ef56f9a6399d5c0894d36410288667b83209", "patch": "diff --git a/homeassistant/components/template/config_flow.py b/homeassistant/components/template/config_flow.py\nindex c1c023c0ea4152..8ecef8539d335b 100644\n--- a/homeassistant/components/template/config_flow.py\n+++ b/homeassistant/components/template/config_flow.py\n@@ -157,7 +157,7 @@ def generate_schema(domain: str, flow_type: str) -> vol.Schema:\n                     type=selector.TextSelectorType.TEXT, multiline=False\n                 )\n             ),\n-            vol.Optional(CONF_SET_VALUE): selector.ActionSelector(),\n+            vol.Required(CONF_SET_VALUE): selector.ActionSelector(),\n         }\n \n     if domain == Platform.SELECT:\n", "test_patch": "diff --git a/tests/components/template/test_config_flow.py b/tests/components/template/test_config_flow.py\nindex 18b55d05672cb6..e0d95ff968d922 100644\n--- a/tests/components/template/test_config_flow.py\n+++ b/tests/components/template/test_config_flow.py\n@@ -273,11 +273,21 @@ async def test_config_flow(\n                 \"min\": \"0\",\n                 \"max\": \"100\",\n                 \"step\": \"0.1\",\n+                \"set_value\": {\n+                    \"action\": \"input_number.set_value\",\n+                    \"target\": {\"entity_id\": \"input_number.test\"},\n+                    \"data\": {\"value\": \"{{ value }}\"},\n+                },\n             },\n             {\n                 \"min\": 0,\n                 \"max\": 100,\n                 \"step\": 0.1,\n+                \"set_value\": {\n+                    \"action\": \"input_number.set_value\",\n+                    \"target\": {\"entity_id\": \"input_number.test\"},\n+                    \"data\": {\"value\": \"{{ value }}\"},\n+                },\n             },\n         ),\n         (\n@@ -1263,11 +1273,21 @@ async def test_option_flow_sensor_preview_config_entry_removed(\n                 \"min\": 0,\n                 \"max\": 100,\n                 \"step\": 0.1,\n+                \"set_value\": {\n+                    \"action\": \"input_number.set_value\",\n+                    \"target\": {\"entity_id\": \"input_number.test\"},\n+                    \"data\": {\"value\": \"{{ value }}\"},\n+                },\n             },\n             {\n                 \"min\": 0,\n                 \"max\": 100,\n                 \"step\": 0.1,\n+                \"set_value\": {\n+                    \"action\": \"input_number.set_value\",\n+                    \"target\": {\"entity_id\": \"input_number.test\"},\n+                    \"data\": {\"value\": \"{{ value }}\"},\n+                },\n             },\n         ),\n         (\n", "problem_statement": "Error while setting up template platform for number\n### The problem\n\nI was trying to set up a helper -> template number. That didn't work despite the right coding and format. Error required key not provided occurs. I am not able to delete it via UI as the delete button does not show like usually with other helpers.\r\n\r\n![grafik](https://github.com/user-attachments/assets/4151eda0-fde1-4b17-88e5-0a6ffe1ad5e2)\r\n\r\nThanks for taking a look at this.\n\n### What version of Home Assistant Core has the issue?\n\n2024.10.0\n\n### What was the last working version of Home Assistant Core?\n\nNot sure, but probably 2024.9\n\n### What type of installation are you running?\n\nHome Assistant OS\n\n### Integration causing the issue\n\n_No response_\n\n### Link to integration documentation on our website\n\n_No response_\n\n### Diagnostics information\n\n_No response_\n\n### Example YAML snippet\n\n_No response_\n\n### Anything in the logs that might be useful for us?\n\n```txt\nLogger: homeassistant.components.number\r\nQuelle: helpers/entity_platform.py:361\r\nIntegration: Nummer (Dokumentation, Probleme)\r\nErstmals aufgetreten: 01:55:03 (1 Vorkommnisse)\r\nZuletzt protokolliert: 01:55:03\r\n\r\nError while setting up template platform for number\r\nTraceback (most recent call last):\r\n  File \"/usr/src/homeassistant/homeassistant/helpers/entity_platform.py\", line 361, in _async_setup_platform\r\n    await asyncio.shield(awaitable)\r\n  File \"/usr/src/homeassistant/homeassistant/components/template/number.py\", line 129, in async_setup_entry\r\n    validated_config = NUMBER_CONFIG_SCHEMA(_options)\r\n                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/local/lib/python3.12/site-packages/voluptuous/schema_builder.py\", line 205, in __call__\r\n    return self._compiled([], data)\r\n           ^^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/local/lib/python3.12/site-packages/voluptuous/schema_builder.py\", line 549, in validate_dict\r\n    return base_validate(path, data.items(), out)\r\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/local/lib/python3.12/site-packages/voluptuous/schema_builder.py\", line 382, in validate_mapping\r\n    raise er.MultipleInvalid(errors)\r\nvoluptuous.error.MultipleInvalid: required key not provided @ data['set_value']\n```\n\n\n### Additional information\n\n_No response_\n", "hints_text": "Can you share your template which caused this issue?\n\nHey there @phracturedblue, @tetienne, @home-assistant/core, mind taking a look at this issue as it has been labeled with an integration (`template`) you are listed as a [code owner](https://github.com/home-assistant/core/blob/dev/CODEOWNERS#L1476) for? Thanks!\n\n<details>\n<summary>Code owner commands</summary>\n\n\nCode owners of `template` can trigger bot actions by commenting:\n\n- `@home-assistant close` Closes the issue.\n- `@home-assistant rename Awesome new title` Renames the issue.\n- `@home-assistant reopen` Reopen the issue.\n- `@home-assistant unassign template` Removes the current integration label and assignees on the issue, add the integration domain after the command.\n- `@home-assistant add-label needs-more-information` Add a label (needs-more-information, problem in dependency, problem in custom component) to the issue.\n- `@home-assistant remove-label needs-more-information` Remove a label (needs-more-information, problem in dependency, problem in custom component) on the issue.\n\n</details>\n\n\n<sub><sup>(message by CodeOwnersMention)</sup></sub>\n\n---\n\n[template documentation](https://www.home-assistant.io/integrations/template)\n[template source](https://github.com/home-assistant/core/tree/dev/homeassistant/components/template)\n<sub><sup>(message by IssueLinks)</sup></sub>\n![grafik](https://github.com/user-attachments/assets/5e2116ab-5d60-43f2-89d9-3cba2a2479cc)\r\n\r\nAccording to the template editor, the value should be 26.\r\n\r\n![grafik](https://github.com/user-attachments/assets/0d6c199a-a939-465c-99ac-021fce6c9dd3)\r\n\r\nThanks a lot for the quick response.\r\n\r\n\r\n\r\n> Can you share your template which caused this issue?\r\n\r\n\nIt's the action missing! What should happen when you change the value of your helper?\nOnce you maintain that the error will vanish...\n\nRemark: your min/max settings don't fit to the example of 26, I could imagine this will cause issues when as well.\nThat did the trick.\r\n\r\n \r\n\r\nMany thanks.  \ud83d\ude42\ud83d\udc4d\r\n\r\n \r\n\r\n \r\n\r\nVon: Nerdix ***@***.***> \r\nGesendet: Samstag, 5. Oktober 2024 09:05\r\nAn: home-assistant/core ***@***.***>\r\nCc: MonkeyTrunky ***@***.***>; Author ***@***.***>\r\nBetreff: Re: [home-assistant/core] Error while setting up template platform for number (Issue #127509)\r\n\r\n \r\n\r\nIt's the action missing! What should happen when you change the value of your helper?\r\nOnce you maintain that the error will vanish...\r\n\r\nRemark: your min/max settings don't fit to the example of 26, I could imagine this will cause issues when as well.\r\n\r\n\u2014\r\nReply to this email directly, view it on GitHub <https://github.com/home-assistant/core/issues/127509#issuecomment-2394958253> , or unsubscribe <https://github.com/notifications/unsubscribe-auth/AWN5FHBJIVA5ZEQ5ZWU3J4LZZ6FTJAVCNFSM6AAAAABPK2IQLSVHI2DSMVQWIX3LMV43OSLTON2WKQ3PNVWWK3TUHMZDGOJUHE2TQMRVGM> .\r\nYou are receiving this because you authored the thread.  <https://github.com/notifications/beacon/AWN5FHGMBZBNKRQT7ARP4BTZZ6FTJA5CNFSM6AAAAABPK2IQLSWGG33NNVSW45C7OR4XAZNMJFZXG5LFINXW23LFNZ2KUY3PNVWWK3TUL5UWJTUOYAU22.gif> Message ID: ***@***.*** ***@***.***> >\r\n\r\n\nIt is not possible to delete a helper without an action:\r\n\r\n1. Create a new template helper (type number)\r\n2. Fill the name and a state template and submit\r\n\r\n<img width=\"481\" alt=\"Screenshot 2024-11-19 at 13 09 30\" src=\"https://github.com/user-attachments/assets/316cc125-0d56-40cb-b8c3-9ee14c99c703\">\r\n\r\n<img width=\"210\" alt=\"Screenshot 2024-11-19 at 13 09 37\" src=\"https://github.com/user-attachments/assets/03ec500e-12e9-4717-8b38-a551a003c509\">\r\n\r\n3. Click \"show settings\"\r\n4. The strange error message `required key not provided @ data['set_value']. Got None` is still shown - and it is impossible to delete that helper without providing an action\r\n\r\n- Improve the error message `required key not provided @ data['set_value']. Got None`\r\n- Allow to delete a number helper without an action\n> It is not possible to delete a helper without an action:\n> \n> \n> \n> 1. Create a new template helper (type number)\n> \n> 2. Fill the name and a state template and submit\n> \n> \n> \n> <img width=\"481\" alt=\"Screenshot 2024-11-19 at 13 09 30\" src=\"https://github.com/user-attachments/assets/316cc125-0d56-40cb-b8c3-9ee14c99c703\">\n> \n> \n> \n> <img width=\"210\" alt=\"Screenshot 2024-11-19 at 13 09 37\" src=\"https://github.com/user-attachments/assets/03ec500e-12e9-4717-8b38-a551a003c509\">\n> \n> \n> \n> 3. Click \"show settings\"\n> \n> 4. The strange error message `required key not provided @ data['set_value']. Got None` is still shown - and it is impossible to delete that helper without providing an action\n> \n> \n> \n> - Improve the error message `required key not provided @ data['set_value']. Got None`\n> \n> - Allow to delete a number helper without an action\n\nIt is possible, also without an action. Make sure the state template is correct, save and refresh the UI. You can then delete the entity as usual:\n\n![image](https://github.com/user-attachments/assets/b2e0a29b-cc3b-4e58-b0a2-42dac38e7fd0)\n![image](https://github.com/user-attachments/assets/120b58fb-064d-488e-a846-687cdffffd28)\nIssue is still reproducible (fresh 2024.11.3 installation):\r\n\r\n\r\nhttps://github.com/user-attachments/assets/446c751c-0806-41a7-9ff9-f4385e1c27a3\r\n\r\n\n@MonkeyTrunky Please reopen this issue\nThis line should use `vol.Required` instead of `vol.Optional`:\r\nhttps://github.com/home-assistant/core/blob/3af751c129dc99ff02e293fe0bb6f027dd6385cc/homeassistant/components/template/config_flow.py#L160", "created_at": "2024-11-26T13:43:14Z"}
{"repo": "home-assistant/core", "pull_number": 131613, "instance_id": "home-assistant__core-131613", "issue_numbers": ["128494"], "base_commit": "5da7b1dd0512f334ee7fd7da4cf5f0d39d4e2720", "patch": "diff --git a/homeassistant/components/motionblinds_ble/manifest.json b/homeassistant/components/motionblinds_ble/manifest.json\nindex ce7e7a6bb8be8..70cddce30a1c5 100644\n--- a/homeassistant/components/motionblinds_ble/manifest.json\n+++ b/homeassistant/components/motionblinds_ble/manifest.json\n@@ -14,5 +14,5 @@\n   \"integration_type\": \"device\",\n   \"iot_class\": \"assumed_state\",\n   \"loggers\": [\"motionblindsble\"],\n-  \"requirements\": [\"motionblindsble==0.1.2\"]\n+  \"requirements\": [\"motionblindsble==0.1.3\"]\n }\ndiff --git a/requirements_all.txt b/requirements_all.txt\nindex 049310c344bf9..c178da273496b 100644\n--- a/requirements_all.txt\n+++ b/requirements_all.txt\n@@ -1397,7 +1397,7 @@ mopeka-iot-ble==0.8.0\n motionblinds==0.6.25\n \n # homeassistant.components.motionblinds_ble\n-motionblindsble==0.1.2\n+motionblindsble==0.1.3\n \n # homeassistant.components.motioneye\n motioneye-client==0.3.14\n", "test_patch": "diff --git a/requirements_test_all.txt b/requirements_test_all.txt\nindex f04da50271ed0..f0ca4ac3f3064 100644\n--- a/requirements_test_all.txt\n+++ b/requirements_test_all.txt\n@@ -1166,7 +1166,7 @@ mopeka-iot-ble==0.8.0\n motionblinds==0.6.25\n \n # homeassistant.components.motionblinds_ble\n-motionblindsble==0.1.2\n+motionblindsble==0.1.3\n \n # homeassistant.components.motioneye\n motioneye-client==0.3.14\n", "problem_statement": "Motionblinds bluetooth - no longer works without explicit connect\n### The problem\n\nI recently updated from 2024.6.4 to 2024.10.2. Previously, my one Motionblinds (integrated via ESPHome BLE proxies) was working normally.\r\n\r\nSince updating, just issuing the close or open action - either via the cover entity in the HASS UI or via a Scene - does nothing. In order to get it to work, I must now explicitly press the \"connect\" button and then immediately issue the close action.\r\n\r\nI also updated ESPHome at the same time but have _not_ updated the actual ESPs themselves, so that shouldn't be relevant here.\r\n\r\nI have not dug into this issue myself in any depth, beyond capturing the logs. I'd actually had my own Motionblinds BLE implementation in Python almost finished when this integration became available, so I have a decent working knowledge of BLEak and the Motionblinds protocol and am willing to help with debugging as my time allows.\r\n\r\n## Additional Information\r\n\r\n5 minutes after pressing the cover UI button to close, I see the following in the logbook (newest to oldest):\r\n\r\n```\r\nMotionblind 0EF4 Speed became unknown\r\n5:51:00 PM - 5 minutes ago\r\nLiving Room Shade became unknown\r\n5:51:00 PM - 5 minutes ago\r\nMotionblind 0EF4 Connection status changed to Disconnected\r\n5:51:00 PM - 5 minutes ago\r\nMotionblind 0EF4 Connection status changed to Disconnecting\r\n5:51:00 PM - 5 minutes ago\r\nMotionblind 0EF4 Speed changed to High\r\n5:50:45 PM - 5 minutes ago\r\nLiving Room Shade is closing\r\n5:50:45 PM - 5 minutes ago - Jason\r\nMotionblind 0EF4 Connection status changed to Connected\r\n5:50:45 PM - 5 minutes ago\r\nMotionblind 0EF4 Connection status changed to Connecting\r\n5:50:43 PM - 5 minutes ago\r\n```\r\n\r\nHowever, it's been 5 minutes and the blind has not moved at all.\r\n\r\nDebug logs from the time I pressed the button until now:\r\n\r\n```\r\nOct 15 17:50:43 nuc1 docker-hass[563612]: 2024-10-15 17:50:43.708 DEBUG (MainThread) [homeassistant.components.motionblinds_ble.cover] (0EF4) Closing\r\nOct 15 17:50:43 nuc1 docker-hass[563612]: 2024-10-15 17:50:43.708 DEBUG (MainThread) [motionblindsble.device] (49:30:60:7C:0E:F4) Connecting using create_task\r\nOct 15 17:50:43 nuc1 docker-hass[563612]: 2024-10-15 17:50:43.708 DEBUG (MainThread) [motionblindsble.device] (49:30:60:7C:0E:F4) Updating connection: connecting\r\nOct 15 17:50:45 nuc1 docker-hass[563612]: 2024-10-15 17:50:45.054 DEBUG (MainThread) [motionblindsble.device] (49:30:60:7C:0E:F4) Updating connection: connected\r\nOct 15 17:50:45 nuc1 docker-hass[563612]: 2024-10-15 17:50:45.086 DEBUG (MainThread) [motionblindsble.device] (49:30:60:7C:0E:F4) Refreshing disconnect timeout to 15.00s using call_later\r\nOct 15 17:50:45 nuc1 docker-hass[563612]: 2024-10-15 17:50:45.086 DEBUG (MainThread) [motionblindsble.device] (49:30:60:7C:0E:F4) Sending message: 02c001180a0f11322d0056\r\nOct 15 17:50:45 nuc1 docker-hass[563612]: 2024-10-15 17:50:45.086 DEBUG (MainThread) [motionblindsble.device] (49:30:60:7C:0E:F4) Received response in 0.00s\r\nOct 15 17:50:45 nuc1 docker-hass[563612]: 2024-10-15 17:50:45.086 DEBUG (MainThread) [motionblindsble.device] (49:30:60:7C:0E:F4) Refreshing disconnect timeout to 15.00s using call_later\r\nOct 15 17:50:45 nuc1 docker-hass[563612]: 2024-10-15 17:50:45.087 DEBUG (MainThread) [motionblindsble.device] (49:30:60:7C:0E:F4) Sending message: 03050f02180a0f11322d0057\r\nOct 15 17:50:45 nuc1 docker-hass[563612]: 2024-10-15 17:50:45.087 DEBUG (MainThread) [motionblindsble.device] (49:30:60:7C:0E:F4) Received response in 0.00s\r\nOct 15 17:50:45 nuc1 docker-hass[563612]: 2024-10-15 17:50:45.087 DEBUG (MainThread) [motionblindsble.device] (49:30:60:7C:0E:F4) Refreshing disconnect timeout to 15.00s using call_later\r\nOct 15 17:50:45 nuc1 docker-hass[563612]: 2024-10-15 17:50:45.087 DEBUG (MainThread) [motionblindsble.device] (49:30:60:7C:0E:F4) Updating running: closing\r\nOct 15 17:50:45 nuc1 docker-hass[563612]: 2024-10-15 17:50:45.088 DEBUG (MainThread) [motionblindsble.device] (49:30:60:7C:0E:F4) Sending message: 03020302180a0f11322d0057\r\nOct 15 17:50:45 nuc1 docker-hass[563612]: 2024-10-15 17:50:45.088 DEBUG (MainThread) [motionblindsble.device] (49:30:60:7C:0E:F4) Received response in 0.00s\r\nOct 15 17:50:45 nuc1 docker-hass[563612]: 2024-10-15 17:50:45.269 DEBUG (MainThread) [motionblindsble.device] (49:30:60:7C:0E:F4) Received message: 0201c0\r\nOct 15 17:50:45 nuc1 docker-hass[563612]: 2024-10-15 17:50:45.289 DEBUG (MainThread) [motionblindsble.device] (49:30:60:7C:0E:F4) Received message: 12040f020e000000000b0bb403000000005c09\r\nOct 15 17:50:45 nuc1 docker-hass[563612]: 2024-10-15 17:50:45.289 DEBUG (MainThread) [motionblindsble.device] (49:30:60:7C:0E:F4) Received status; position: 0, tilt: 0, battery percentage: 92, is charging: False, is wired: False, speed: HIGH, end positions: BOTH, favorite position set: False\r\nOct 15 17:50:45 nuc1 docker-hass[563612]: 2024-10-15 17:50:45.289 DEBUG (MainThread) [motionblindsble.device] (49:30:60:7C:0E:F4) Updating position: 0, tilt: 0\r\nOct 15 17:50:45 nuc1 docker-hass[563612]: 2024-10-15 17:50:45.290 DEBUG (MainThread) [motionblindsble.device] (49:30:60:7C:0E:F4) Updating battery; percentage: 92, is charging: False, is wired: False\r\nOct 15 17:50:45 nuc1 docker-hass[563612]: 2024-10-15 17:50:45.290 DEBUG (MainThread) [motionblindsble.device] (49:30:60:7C:0E:F4) Updating speed: HIGH\r\nOct 15 17:50:45 nuc1 docker-hass[563612]: 2024-10-15 17:50:45.291 DEBUG (MainThread) [motionblindsble.device] (49:30:60:7C:0E:F4) Updating end position info; end positions: BOTH, favorite position set: False\r\nOct 15 17:50:45 nuc1 docker-hass[563612]: 2024-10-15 17:50:45.291 DEBUG (MainThread) [motionblindsble.device] (49:30:60:7C:0E:F4) Updating calibration: calibrated\r\nOct 15 17:50:45 nuc1 docker-hass[563612]: 2024-10-15 17:50:45.481 DEBUG (MainThread) [motionblindsble.device] (49:30:60:7C:0E:F4) Received message: 12040f020e000000000b0bb403000000005c09\r\nOct 15 17:50:45 nuc1 docker-hass[563612]: 2024-10-15 17:50:45.481 DEBUG (MainThread) [motionblindsble.device] (49:30:60:7C:0E:F4) Received status; position: 0, tilt: 0, battery percentage: 92, is charging: False, is wired: False, speed: HIGH, end positions: BOTH, favorite position set: False\r\nOct 15 17:50:45 nuc1 docker-hass[563612]: 2024-10-15 17:50:45.481 DEBUG (MainThread) [motionblindsble.device] (49:30:60:7C:0E:F4) Updating position: 0, tilt: 0\r\nOct 15 17:50:45 nuc1 docker-hass[563612]: 2024-10-15 17:50:45.481 DEBUG (MainThread) [motionblindsble.device] (49:30:60:7C:0E:F4) Updating battery; percentage: 92, is charging: False, is wired: False\r\nOct 15 17:50:45 nuc1 docker-hass[563612]: 2024-10-15 17:50:45.482 DEBUG (MainThread) [motionblindsble.device] (49:30:60:7C:0E:F4) Updating speed: HIGH\r\nOct 15 17:50:45 nuc1 docker-hass[563612]: 2024-10-15 17:50:45.482 DEBUG (MainThread) [motionblindsble.device] (49:30:60:7C:0E:F4) Updating end position info; end positions: BOTH, favorite position set: False\r\nOct 15 17:50:45 nuc1 docker-hass[563612]: 2024-10-15 17:50:45.482 DEBUG (MainThread) [motionblindsble.device] (49:30:60:7C:0E:F4) Updating calibration: calibrated\r\nOct 15 17:50:45 nuc1 docker-hass[563612]: 2024-10-15 17:50:45.670 DEBUG (MainThread) [motionblindsble.device] (49:30:60:7C:0E:F4) Received message: 12040f020e000000000b0bb403000000005c09\r\nOct 15 17:50:45 nuc1 docker-hass[563612]: 2024-10-15 17:50:45.671 DEBUG (MainThread) [motionblindsble.device] (49:30:60:7C:0E:F4) Received status; position: 0, tilt: 0, battery percentage: 92, is charging: False, is wired: False, speed: HIGH, end positions: BOTH, favorite position set: False\r\nOct 15 17:50:45 nuc1 docker-hass[563612]: 2024-10-15 17:50:45.671 DEBUG (MainThread) [motionblindsble.device] (49:30:60:7C:0E:F4) Updating position: 0, tilt: 0\r\nOct 15 17:50:45 nuc1 docker-hass[563612]: 2024-10-15 17:50:45.671 DEBUG (MainThread) [motionblindsble.device] (49:30:60:7C:0E:F4) Updating battery; percentage: 92, is charging: False, is wired: False\r\nOct 15 17:50:45 nuc1 docker-hass[563612]: 2024-10-15 17:50:45.671 DEBUG (MainThread) [motionblindsble.device] (49:30:60:7C:0E:F4) Updating speed: HIGH\r\nOct 15 17:50:45 nuc1 docker-hass[563612]: 2024-10-15 17:50:45.671 DEBUG (MainThread) [motionblindsble.device] (49:30:60:7C:0E:F4) Updating end position info; end positions: BOTH, favorite position set: False\r\nOct 15 17:50:45 nuc1 docker-hass[563612]: 2024-10-15 17:50:45.671 DEBUG (MainThread) [motionblindsble.device] (49:30:60:7C:0E:F4) Updating calibration: calibrated\r\nOct 15 17:51:00 nuc1 docker-hass[563612]: 2024-10-15 17:51:00.088 DEBUG (MainThread) [motionblindsble.device] (49:30:60:7C:0E:F4) Disconnecting after 15.00s\r\nOct 15 17:51:00 nuc1 docker-hass[563612]: 2024-10-15 17:51:00.088 DEBUG (MainThread) [motionblindsble.device] (49:30:60:7C:0E:F4) Updating connection: disconnecting\r\nOct 15 17:51:00 nuc1 docker-hass[563612]: 2024-10-15 17:51:00.088 DEBUG (MainThread) [motionblindsble.device] (49:30:60:7C:0E:F4) Disconnecting\r\nOct 15 17:51:00 nuc1 docker-hass[563612]: 2024-10-15 17:51:00.135 DEBUG (MainThread) [motionblindsble.device] (49:30:60:7C:0E:F4) Disconnected\r\nOct 15 17:51:00 nuc1 docker-hass[563612]: 2024-10-15 17:51:00.135 DEBUG (MainThread) [motionblindsble.device] (49:30:60:7C:0E:F4) Updating connection: disconnected\r\nOct 15 17:51:00 nuc1 docker-hass[563612]: 2024-10-15 17:51:00.136 DEBUG (MainThread) [motionblindsble.device] (49:30:60:7C:0E:F4) Updating calibration: None\r\nOct 15 17:51:00 nuc1 docker-hass[563612]: 2024-10-15 17:51:00.136 DEBUG (MainThread) [motionblindsble.device] (49:30:60:7C:0E:F4) Updating running: None\r\nOct 15 17:51:00 nuc1 docker-hass[563612]: 2024-10-15 17:51:00.136 DEBUG (MainThread) [motionblindsble.device] (49:30:60:7C:0E:F4) Updating position: None, tilt: None\r\nOct 15 17:51:00 nuc1 docker-hass[563612]: 2024-10-15 17:51:00.136 DEBUG (MainThread) [motionblindsble.device] (49:30:60:7C:0E:F4) Updating speed: None\r\n```\n\n### What version of Home Assistant Core has the issue?\n\n2024.10.2\n\n### What was the last working version of Home Assistant Core?\n\n2024.6.4\n\n### What type of installation are you running?\n\nHome Assistant Container\n\n### Integration causing the issue\n\nmotionblinds_ble\n\n### Link to integration documentation on our website\n\nhttps://www.home-assistant.io/integrations/motionblinds_ble\n\n### Diagnostics information\n\n[config_entry-motionblinds_ble-7b80a70293a42176c803417c46b6de14.json](https://github.com/user-attachments/files/17386321/config_entry-motionblinds_ble-7b80a70293a42176c803417c46b6de14.json)\r\n\n\n### Example YAML snippet\n\n_No response_\n\n### Anything in the logs that might be useful for us?\n\n```txt\nSee issue body.\n```\n\n\n### Additional information\n\nSee issue body.\n", "hints_text": "\nHey there @lennp, @jerrybboy, mind taking a look at this issue as it has been labeled with an integration (`motionblinds_ble`) you are listed as a [code owner](https://github.com/home-assistant/core/blob/dev/CODEOWNERS#L942) for? Thanks!\n\n<details>\n<summary>Code owner commands</summary>\n\n\nCode owners of `motionblinds_ble` can trigger bot actions by commenting:\n\n- `@home-assistant close` Closes the issue.\n- `@home-assistant rename Awesome new title` Renames the issue.\n- `@home-assistant reopen` Reopen the issue.\n- `@home-assistant unassign motionblinds_ble` Removes the current integration label and assignees on the issue, add the integration domain after the command.\n- `@home-assistant add-label needs-more-information` Add a label (needs-more-information, problem in dependency, problem in custom component) to the issue.\n- `@home-assistant remove-label needs-more-information` Remove a label (needs-more-information, problem in dependency, problem in custom component) on the issue.\n\n</details>\n\n\n<sub><sup>(message by CodeOwnersMention)</sup></sub>\n\n---\n\n[motionblinds_ble documentation](https://www.home-assistant.io/integrations/motionblinds_ble)\n[motionblinds_ble source](https://github.com/home-assistant/core/tree/dev/homeassistant/components/motionblinds_ble)\n<sub><sup>(message by IssueLinks)</sup></sub>\nIt seems that I am having the same issue since updating from 2024.10.1 to 2024.10.2. I had two moments where the blinds should have openend/closed via an automation, but they did not change position. \r\n\r\nOnly when I gave multiple commands short after eachother it started moving. I enabled the debug logging and will report back when I have more details from my side. \n@fevo21 thanks for clarifying\r\n\r\n2024.10.2 introduced a fix (#127954) for issue #127664\r\n\r\nThe only thing that really changed is I set \u2018response=False\u2019, which means home assistant no longer waits for an ack for a message that is sent to the motor. I am not sure yet why this breaks your automation.\r\n\r\nIf you move the blind without connecting first (no automation), does the blind also not move? Maybe I have to introduce some delay X before the command is sent after connecting\nJust to confirm, my issue is not limited to automations or scenes; it also happens if I just press the button on a dashboard, or on the entity popup.\r\n\r\nIs it possible that with `response=True` either HomeAssistant or something lower down the bluetooth stack will automatically retry if it doesn't get an ack in a certain amount of time, but that `response=False` is disabling that logic?\nI have tried it myself, and I suspect the messages are sent too fast after one another.\r\n\r\nWhen you connect to a blind, it currently first sends a status query (to update the battery, position, tilt etc). However, since `response=False` now, it does not wait for an ack, resulting in the \"close blind\" (starting with `03020302`) message being sent 1ms after the \"status query\" (starting with `03050f02`) message:\r\n\r\n```\r\n17:50:45.087 DEBUG (MainThread) [motionblindsble.device] (49:30:60:7C:0E:F4) Sending message: 03050f02180a0f11322d0057\r\n17:50:45.088 DEBUG (MainThread) [motionblindsble.device] (49:30:60:7C:0E:F4) Sending message: 03020302180a0f11322d0057\r\n```\r\n\r\nI tried adding a delay of 1 second after the connect and before sending the message that moves the blind, and that seems to fix the problem: https://github.com/LennP/motionblindsble/compare/main...test_no_response_after_connect_fix\r\n\r\nI will experiment a bit more, but I think the solution is to either:\r\n- Add a delay (not sure yet how much is necessary, might only be a couple of milliseconds)\r\n- Wait for the status to be set using an `Event` before continuing with the command\nAttached logging for a successful run from automation this morning 9AM and a failed manual command this afternoon. At the failed manual attempt it connects, but the blinds don't move. Also battery status is not updated and remains at 'unknown' (whilst connected)\r\n[Uploading motionblinds successful opening and failed close command.log\u2026]()\r\n\nI did some more testing and it seems to work fine if I `asyncio.sleep(0.2)` after sending a message to the motor.\r\n\r\n@bdraco this issue is related to the `response=False` fix for issue #127664. It looks like the motor does not process a command if you send it too fast after another one. This was not an issue with `response=True`. Could it be true that the motor is processing the command for those ~0.2 seconds and therefore won't respond to any commands sent during that time (using `response=True` it takes around 0.2 seconds for the coroutine to complete)? I guess the only way to solve this without using `response=True` is to sleep after sending a command?\r\n\r\nHowever, I am not sure 0.2 seconds will suffice for all motors and all situations. What I could also do is add an option to the options flow to enable/disable `response=True`?\n@jantman @fevo21 if you want to try the fix for yourselves:\r\n\r\n1. Install the Advanced SSH & Web Terminal add-on (not the other SSH add-on, delete that one if you have it first)\r\n![Advanced SSH & Web Terminal add-on](https://private-user-images.githubusercontent.com/78048721/361417601-f40f2c19-7dbf-4253-a717-01d58c010f58.png?jwt=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJnaXRodWIuY29tIiwiYXVkIjoicmF3LmdpdGh1YnVzZXJjb250ZW50LmNvbSIsImtleSI6ImtleTUiLCJleHAiOjE3Mjk1MTc2NTEsIm5iZiI6MTcyOTUxNzM1MSwicGF0aCI6Ii83ODA0ODcyMS8zNjE0MTc2MDEtZjQwZjJjMTktN2RiZi00MjUzLWE3MTctMDFkNThjMDEwZjU4LnBuZz9YLUFtei1BbGdvcml0aG09QVdTNC1ITUFDLVNIQTI1NiZYLUFtei1DcmVkZW50aWFsPUFLSUFWQ09EWUxTQTUzUFFLNFpBJTJGMjAyNDEwMjElMkZ1cy1lYXN0LTElMkZzMyUyRmF3czRfcmVxdWVzdCZYLUFtei1EYXRlPTIwMjQxMDIxVDEzMjkxMVomWC1BbXotRXhwaXJlcz0zMDAmWC1BbXotU2lnbmF0dXJlPWI1YmI0MDhkYzQxYjA0OGZjMDg4NDU5Njc3MjRlNGM5YzA3ZDJhYTA1NjEyZTMzOGFjZDNhZGM1MzczMzA3YzgmWC1BbXotU2lnbmVkSGVhZGVycz1ob3N0In0.BO6B3U9u7V2Okrzv8o4K_ldisMQIAlOZpDH9YOih_8c)\r\n2. Go to the add-on and enable \"show in sidebar\" and disable \"protection mode\" (I think this needs to be disabled to access python but I haven't tested it leaving it enabled)\r\n3. Go to the add-on configuration tab, fill in a sufficiently secure password and then click save\r\n4. Start the add-on\r\n5. Go to the \"Terminal\" that is now showing in the sidebar\r\n6. Type the following command to install the version of the library with the fix in it:\r\n```\r\nsudo docker exec homeassistant python3 -m pip install --no-cache-dir --no-deps --force-reinstall git+https://github.com/LennP/motionblindsble@test_no_response_after_connect_fix\r\n```\r\n7. Restart Home Assistant\r\n8. Let me know if that fixes the issue!\r\n\n> It seems that I am having the same issue since updating from 2024.10.1 to 2024.10.2. I had two moments where the blinds should have openend/closed via an automation, but they did not change position.\r\n> \r\n> Only when I gave multiple commands short after eachother it started moving. I enabled the debug logging and will report back when I have more details from my side.\r\n\r\nsame issue here after going to 2024.10.3, automations won't run to tilt te blinds\n> same issue here after going to 2024.10.3, automations won't run to tilt te blinds\r\n\r\n@Janthenman67 this issue started occurring in 2024.10.2 and hasn't yet been fixed in 2024.10.3. If you want to, you could install the fix yourself in the meantime using the command mentioned in https://github.com/home-assistant/core/issues/128494#issuecomment-2426701104\nyeh but im not sure if im comfortable doing that, bc i don't know how to return if the method doesn't work \r\nwill there be a fix anytime soon?\n> @jantman @fevo21 if you want to try the fix for yourselves:\r\n> \r\n\r\n> 6. Type the following command to install the version of the library with the fix in it:\r\n> \r\n> ```\r\n> sudo docker exec homeassistant python3 -m pip install --no-cache-dir --no-deps --force-reinstall git+https://github.com/LennP/motionblindsble@test_no_response_after_connect_fix\r\n> ```\r\n> \r\n>  7. Restart Home Assistant\r\n> 8. Let me know if that fixes the issue!\r\n\r\nThanks for the quick fix. Yesterday I executed the above command on the docker host and the `motionblindsble 0.1.2` package was successfully replaced. So far the blinds moved all of the 5-6 times the open/close command was given from HASS. \nApologies for not replying sooner, it's been a crazy week at work.\r\n\r\nOk, installed from git as of https://github.com/LennP/motionblindsble/commit/da695fa89f03a86656716e1a63af76895590a3a2 and I'll report back after a day or two.\r\n\r\nFor what it's worth, I just baked a new Docker image with the git install in it\r\n\r\n```\r\nFROM ghcr.io/home-assistant/home-assistant:2024.10.2\r\nRUN /usr/local/bin/python3 -m pip install --no-cache-dir --no-deps --force-reinstall git+https://github.com/LennP/motionblindsble@da695fa89f03a86656716e1a63af76895590a3a2\r\n```\nI can confirm that this fixes it for me as well, thank you so much!\n> I can confirm that this fixes it for me as well, thank you so much!\n\nToo bad it is not in the 2024.10.4 release.. I was hoping for that\n> \r\n> Thanks for the quick fix. Yesterday I executed the above command on the docker host and the `motionblindsble 0.1.2` package was successfully replaced. So far the blinds moved all of the 5-6 times the open/close command was given from HASS.\r\n\r\nAlso for me no issues anymore since installing the fix. I think you can include it in the next update, thanks a lot!\r\n\r\n\nFrom the start using the integration, the automation for opening (50%) and closing results in going the blind first tot totaly closed to 100% and then going back to 0%. Anyone having the same experience? \n@Janthenman67 that sounds like a different issue? If so, please create a new GitHub issue for this with debug logs.\r\n\r\n> Also for me no issues anymore since installing the fix. I think you can include it in the next update, thanks a lot!\r\n\r\nAwesome! @bdraco when you have time would you be able to have a look at this (https://github.com/home-assistant/core/issues/128494#issuecomment-2420419905)? Using `asyncio.sleep(0.2)` after connection seems to solve the issue\n> > same issue here after going to 2024.10.3, automations won't run to tilt te blinds\r\n> \r\n> @Janthenman67 this issue started occurring in 2024.10.2 and hasn't yet been fixed in 2024.10.3. If you want to, you could install the fix yourself in the meantime using the command mentioned in [#128494 (comment)](https://github.com/home-assistant/core/issues/128494#issuecomment-2426701104)\r\n\r\n@lennp Am I right that this fix wasn't include in the 2024.11 update? I thought I'll sit it out, but still have the same problems (I'm too comfortable doing the manual update) \n> I did some more testing and it seems to work fine if I `asyncio.sleep(0.2)` after sending a message to the motor.\r\n> \r\n> @bdraco this issue is related to the `response=False` fix for issue #127664. It looks like the motor does not process a command if you send it too fast after another one. This was not an issue with `response=True`. Could it be true that the motor is processing the command for those ~0.2 seconds and therefore won't respond to any commands sent during that time (using `response=True` it takes around 0.2 seconds for the coroutine to complete)? I guess the only way to solve this without using `response=True` is to sleep after sending a command?\r\n> \r\n> However, I am not sure 0.2 seconds will suffice for all motors and all situations. What I could also do is add an option to the options flow to enable/disable `response=True`?\r\n\r\nWe had a similar problem with switchbot devices `PySwitchbot`.  That was solved by putting everything behind an asyncio.Lock that waits for a BLE notify to come back after sending a command before sending the next one.\r\n\r\nFor `aiohomekit` we ended up with a similar method.\r\n\r\nGenerally we avoid trying to make the user adjust configuration settings to get their devices. If you don't have a way to get the notify back I'd go with the 0.2s sleep (and probably a lock if one doesn't already exist).  It could always be increased a bit if needed later", "created_at": "2024-11-26T10:42:35Z"}
{"repo": "home-assistant/core", "pull_number": 131588, "instance_id": "home-assistant__core-131588", "issue_numbers": ["131551"], "base_commit": "c2d6599736e7ae5482b9308b8eb9b6f3ef88ad95", "patch": "diff --git a/homeassistant/components/mqtt/entity.py b/homeassistant/components/mqtt/entity.py\nindex 46b2c9e1d42b5e..c73e1975a68c1b 100644\n--- a/homeassistant/components/mqtt/entity.py\n+++ b/homeassistant/components/mqtt/entity.py\n@@ -1185,6 +1185,33 @@ def device_info_from_specifications(\n     return info\n \n \n+@callback\n+def ensure_via_device_exists(\n+    hass: HomeAssistant, device_info: DeviceInfo | None, config_entry: ConfigEntry\n+) -> None:\n+    \"\"\"Ensure the via device is in the device registry.\"\"\"\n+    if (\n+        device_info is None\n+        or CONF_VIA_DEVICE not in device_info\n+        or (device_registry := dr.async_get(hass)).async_get_device(\n+            identifiers={device_info[\"via_device\"]}\n+        )\n+    ):\n+        return\n+\n+    # Ensure the via device exists in the device registry\n+    _LOGGER.debug(\n+        \"Device identifier %s via_device reference from device_info %s \"\n+        \"not found in the Device Registry, creating new entry\",\n+        device_info[\"via_device\"],\n+        device_info,\n+    )\n+    device_registry.async_get_or_create(\n+        config_entry_id=config_entry.entry_id,\n+        identifiers={device_info[\"via_device\"]},\n+    )\n+\n+\n class MqttEntityDeviceInfo(Entity):\n     \"\"\"Mixin used for mqtt platforms that support the device registry.\"\"\"\n \n@@ -1203,6 +1230,7 @@ def device_info_discovery_update(self, config: DiscoveryInfoType) -> None:\n         device_info = self.device_info\n \n         if device_info is not None:\n+            ensure_via_device_exists(self.hass, device_info, self._config_entry)\n             device_registry.async_get_or_create(\n                 config_entry_id=config_entry_id, **device_info\n             )\n@@ -1256,6 +1284,7 @@ def __init__(\n             self, hass, discovery_data, self.discovery_update\n         )\n         MqttEntityDeviceInfo.__init__(self, config.get(CONF_DEVICE), config_entry)\n+        ensure_via_device_exists(self.hass, self.device_info, self._config_entry)\n \n     def _init_entity_id(self) -> None:\n         \"\"\"Set entity_id from object_id if defined in config.\"\"\"\n@@ -1490,6 +1519,8 @@ def update_device(\n     config_entry_id = config_entry.entry_id\n     device_info = device_info_from_specifications(config[CONF_DEVICE])\n \n+    ensure_via_device_exists(hass, device_info, config_entry)\n+\n     if config_entry_id is not None and device_info is not None:\n         update_device_info = cast(dict[str, Any], device_info)\n         update_device_info[\"config_entry_id\"] = config_entry_id\n", "test_patch": "diff --git a/tests/components/mqtt/test_discovery.py b/tests/components/mqtt/test_discovery.py\nindex e49e7a27c8d46a..8a674a4e1cdbfd 100644\n--- a/tests/components/mqtt/test_discovery.py\n+++ b/tests/components/mqtt/test_discovery.py\n@@ -2987,3 +2987,139 @@ async def test_shared_state_topic(\n     state = hass.states.get(entity_id)\n     assert state is not None\n     assert state.state == \"New state3\"\n+\n+\n+@pytest.mark.parametrize(\"single_configs\", [copy.deepcopy(TEST_SINGLE_CONFIGS)])\n+async def test_discovery_with_late_via_device_discovery(\n+    hass: HomeAssistant,\n+    device_registry: dr.DeviceRegistry,\n+    mqtt_mock_entry: MqttMockHAClientGenerator,\n+    tag_mock: AsyncMock,\n+    single_configs: list[tuple[str, dict[str, Any]]],\n+) -> None:\n+    \"\"\"Test a via device is available and the discovery of the via device is late.\"\"\"\n+    await mqtt_mock_entry()\n+\n+    await hass.async_block_till_done()\n+    await hass.async_block_till_done()\n+\n+    via_device_entry = device_registry.async_get_device(\n+        {(\"mqtt\", \"id_via_very_unique\")}\n+    )\n+    assert via_device_entry is None\n+    # Discovery single config schema\n+    for discovery_topic, config in single_configs:\n+        config[\"device\"][\"via_device\"] = \"id_via_very_unique\"\n+        payload = json.dumps(config)\n+        async_fire_mqtt_message(\n+            hass,\n+            discovery_topic,\n+            payload,\n+        )\n+        via_device_entry = device_registry.async_get_device(\n+            {(\"mqtt\", \"id_via_very_unique\")}\n+        )\n+        assert via_device_entry is not None\n+        assert via_device_entry.name is None\n+\n+    await hass.async_block_till_done()\n+\n+    # Now discover the via device (a switch)\n+    via_device_config = {\n+        \"name\": None,\n+        \"command_topic\": \"test-switch-topic\",\n+        \"unique_id\": \"very_unique_switch\",\n+        \"device\": {\"identifiers\": [\"id_via_very_unique\"], \"name\": \"My Switch\"},\n+    }\n+    payload = json.dumps(via_device_config)\n+    via_device_discovery_topic = \"homeassistant/switch/very_unique/config\"\n+    async_fire_mqtt_message(\n+        hass,\n+        via_device_discovery_topic,\n+        payload,\n+    )\n+    await hass.async_block_till_done()\n+    await hass.async_block_till_done()\n+    via_device_entry = device_registry.async_get_device(\n+        {(\"mqtt\", \"id_via_very_unique\")}\n+    )\n+    assert via_device_entry is not None\n+    assert via_device_entry.name == \"My Switch\"\n+\n+    await help_check_discovered_items(hass, device_registry, tag_mock)\n+\n+\n+@pytest.mark.parametrize(\"single_configs\", [copy.deepcopy(TEST_SINGLE_CONFIGS)])\n+async def test_discovery_with_late_via_device_update(\n+    hass: HomeAssistant,\n+    device_registry: dr.DeviceRegistry,\n+    mqtt_mock_entry: MqttMockHAClientGenerator,\n+    tag_mock: AsyncMock,\n+    single_configs: list[tuple[str, dict[str, Any]]],\n+) -> None:\n+    \"\"\"Test a via device is available and the discovery of the via device is is set via an update.\"\"\"\n+    await mqtt_mock_entry()\n+\n+    await hass.async_block_till_done()\n+    await hass.async_block_till_done()\n+\n+    via_device_entry = device_registry.async_get_device(\n+        {(\"mqtt\", \"id_via_very_unique\")}\n+    )\n+    assert via_device_entry is None\n+    # Discovery single config schema without via device\n+    for discovery_topic, config in single_configs:\n+        payload = json.dumps(config)\n+        async_fire_mqtt_message(\n+            hass,\n+            discovery_topic,\n+            payload,\n+        )\n+        via_device_entry = device_registry.async_get_device(\n+            {(\"mqtt\", \"id_via_very_unique\")}\n+        )\n+        await hass.async_block_till_done()\n+        await hass.async_block_till_done()\n+        assert via_device_entry is None\n+\n+    # Resend the discovery update to set the via device\n+    for discovery_topic, config in single_configs:\n+        config[\"device\"][\"via_device\"] = \"id_via_very_unique\"\n+        payload = json.dumps(config)\n+        async_fire_mqtt_message(\n+            hass,\n+            discovery_topic,\n+            payload,\n+        )\n+        via_device_entry = device_registry.async_get_device(\n+            {(\"mqtt\", \"id_via_very_unique\")}\n+        )\n+        assert via_device_entry is not None\n+        assert via_device_entry.name is None\n+\n+    await hass.async_block_till_done()\n+    await hass.async_block_till_done()\n+\n+    # Now discover the via device (a switch)\n+    via_device_config = {\n+        \"name\": None,\n+        \"command_topic\": \"test-switch-topic\",\n+        \"unique_id\": \"very_unique_switch\",\n+        \"device\": {\"identifiers\": [\"id_via_very_unique\"], \"name\": \"My Switch\"},\n+    }\n+    payload = json.dumps(via_device_config)\n+    via_device_discovery_topic = \"homeassistant/switch/very_unique/config\"\n+    async_fire_mqtt_message(\n+        hass,\n+        via_device_discovery_topic,\n+        payload,\n+    )\n+    await hass.async_block_till_done()\n+    await hass.async_block_till_done()\n+    via_device_entry = device_registry.async_get_device(\n+        {(\"mqtt\", \"id_via_very_unique\")}\n+    )\n+    assert via_device_entry is not None\n+    assert via_device_entry.name == \"My Switch\"\n+\n+    await help_check_discovered_items(hass, device_registry, tag_mock)\n", "problem_statement": "MQTT discovery via_device not recognized \n### The problem\n\nWhen sending a MQTT discovery message including via_device is sent, when the via_device is not available (yet), the device is not shown connected, after the via_device is sent at a later time.\r\n\r\nMoreover, if the first discovery message is sent again, with the via_device available, it remains disconnected forever.\r\n\r\nSteps to reproduce:\r\n\r\nSend discovery message: **homeassistant/light/lamp1/config**\r\n```\r\n{\r\n\t\"name\": \"Lamp 1\",\r\n\t\"object_id\": \"lamp1\",\r\n\t\"unique_id\": \"lamp1\",\r\n\t\"command_topic\": \"sometopic\",\r\n\t\"device\": {\r\n\t\t\"identifiers\": \"mydevice1\",\r\n\t\t\"name\": \"Device 1\",\r\n\t\t\"via_device\": \"topleveldevice1\"\r\n\t}\r\n}\r\n```\r\n\r\nNow send another message including the via_device: **homeassistant/sensor/sensor1/config**\r\n```\r\n{\r\n\t\"name\": \"Sensor 1\",\r\n\t\"object_id\": \"sensor1\",\r\n\t\"unique_id\": \"sensor1\",\r\n\t\"state_topic\": \"othertopic\",\r\n\t\"device_class\": \"temperature\",\r\n\t\"unit_of_measurement\": \"\u00b0C\",\r\n\t\"device\": {\r\n\t\t\"identifiers\": \"topleveldevice1\",\r\n\t\t\"name\": \"Top level device 1\",\r\n\t\t\"model\": \"Model\",\r\n\t\t\"manufacturer\": \"Someone\"\r\n\t}\r\n}\r\n```\r\n\r\nThe first Device 1 is not show connected to the via_device \"Top level device 1\".\r\n\r\nWhen trying to fix this you can try to re-send the first message, but it will remain disconnected.\r\n\r\nTo compare: when you first send the message with the via_device, and later connected device, it is connected correctly.\r\n\r\nSo the order of discovery message is critical. This should not be the case, or it should be documented.\r\n\n\n### What version of Home Assistant Core has the issue?\n\n2024.7.3\n\n### What was the last working version of Home Assistant Core?\n\n_No response_\n\n### What type of installation are you running?\n\nHome Assistant Container\n\n### Integration causing the issue\n\nMQTT\n\n### Link to integration documentation on our website\n\n_No response_\n\n### Diagnostics information\n\n_No response_\n\n### Example YAML snippet\n\n_No response_\n\n### Anything in the logs that might be useful for us?\n\n_No response_\n\n### Additional information\n\n_No response_\n", "hints_text": "\nHey there @emontnemery, @jbouwh, @bdraco, mind taking a look at this issue as it has been labeled with an integration (`mqtt`) you are listed as a [code owner](https://github.com/home-assistant/core/blob/dev/CODEOWNERS#L954) for? Thanks!\n\n<details>\n<summary>Code owner commands</summary>\n\n\nCode owners of `mqtt` can trigger bot actions by commenting:\n\n- `@home-assistant close` Closes the issue.\n- `@home-assistant rename Awesome new title` Renames the issue.\n- `@home-assistant reopen` Reopen the issue.\n- `@home-assistant unassign mqtt` Removes the current integration label and assignees on the issue, add the integration domain after the command.\n- `@home-assistant add-label needs-more-information` Add a label (needs-more-information, problem in dependency, problem in custom component) to the issue.\n- `@home-assistant remove-label needs-more-information` Remove a label (needs-more-information, problem in dependency, problem in custom component) on the issue.\n\n</details>\n\n\n<sub><sup>(message by CodeOwnersMention)</sup></sub>\n\n---\n\n[mqtt documentation](https://www.home-assistant.io/integrations/mqtt)\n[mqtt source](https://github.com/home-assistant/core/tree/dev/homeassistant/components/mqtt)\n<sub><sup>(message by IssueLinks)</sup></sub>\nResending a discovery message will only update the entity if the message it self was changed. Aftter a reload all device releations should show fine because they are all added to the device registry.\nNot sure what you mean by reload?\r\n\r\nThe order in which you send the messages has a PERMANENT effect on the device structure. \r\n\r\nPlease try the provided messages, and you will see the problem.\nDiscovery message need to be resend after The Home Assistant mqtt integration is (re)started. This can be either triggered by:\r\n- Subscribing to the birth message and use that as a trigger\r\n- Retained discovery messages\r\n\r\nhttps://www.home-assistant.io/integrations/mqtt/#discovery-messages-en-availability\r\n\r\nMQTT will recognize the via device next time the entity is loaded.\r\n\r\nIf you want to fix this initially you either need to:\r\n- submit the discovery message in the correct order, or\r\n- update the discovery message, so that there is a delta and the entity and device registry is updated\r\n\r\nWe filter out discovery messages by design if they did not change.\nI have fixed this for my own device (button.plus), all I want to do is help the stability of HA.\r\n\r\nThe discovery service feels quite unpredictable and unstable, partly due to the case at hand.\r\n\r\nI invite you to try the sample I included, and you will understand.\r\n\r\nIf you filter discovery messages if the are not changed, this is a problem if the context is changed, e.g. when via_device is added.\r\n\r\n\nI understand and respect your concern. The `via_device` option though only works if the `via_device` exists. As the device registry initially will be updated for all devices, it might be the `via_device` link could not be resolved. After the MQTT integration was restarted or reloaded, this dependency will be resolved, after processing the discovery messages for the second time.\r\n\r\n> If you filter discovery messages if the are not changed, this is a problem if the context is changed, e.g. when via_device is added.\r\n\r\nIf we would not filter those out we would this could cause a perfomance impact if discovery messages are re-send. As this is a temporary issue, and solvable by sending the message in the correct order. Therefore I do not think we should change this logic.\nPlease Jan, if you respect my concern, take 2 minutes and try my example.\r\n\r\nJust send the two messages, and restart the service: the devices remain disconnected!\n> Please Jan, if you respect my concern, take 2 minutes and try my example.\r\n> \r\n> Just send the two messages, and restart the service: the devices remain disconnected!\r\n\r\n![image](https://github.com/user-attachments/assets/0fd8cbe5-121b-4d48-81dc-d7b11b90c7aa)\r\n\r\nAfter reloading mqtt the device info is correctly shown.\r\nNote that I used retained configuration payloads to replay the configurations\nPlease note that this is NOT about getting the devices connected. You can simply achieve the connection (as show in your picture) by sending the messages in reverse order (first Sensor 1 and then Lamp 1).\r\n\r\nThis issues is about PERMANENT disconnection of the devices, even after multiple reloading, and multiple resubmission.\r\n\r\nWhen using retained messages, the order of replay is not guaranteed. I guess the replay was in the correct order?\r\nBTW I'm using the homeassistant/status topic to replay the discovery messages. \r\n\r\nBut auto discovery should really be independent of message order.  It makes you think you've gone mad sometimes, really. Until I found out about this ordering dependency, after hours of trying and testing.\n> When using retained messages, the order of replay is not guaranteed. I guess the replay was in the correct order?\r\n> BTW I'm using the homeassistant/status topic to replay the discovery messages.\r\n\r\nThe order does not matter when the payloads are replayed, because the devices are already in the device registry by then.\nIt does matter. Once you have sent the messages in the 'wrong' order (like in my example), the devices will never by connected again. \r\n\r\nThe only way to fix it, is deleting both devices from HA, and then sent in right order (reverse in this case).\nAnyway, it is not that relevant to find out all the steps. \r\n\r\nTo be predictable and reliable the messages should be independent of the order. And no reload should be necessary.\r\n\r\nAs for performance: this is really up to the maker of the device, they should prevent multiple messages for the same device.\n> It does matter. Once you have sent the messages in the 'wrong' order (like in my example), the devices will never by connected again.\r\n> \r\n> The only way to fix it, is deleting both devices from HA, and then sent in right order (reverse in this case).\r\n\r\nBased on my tests I do not agree upon you conclusion. If I try to reproduce it, then after reloading The MQTT service (that is not the broker, but the MQTT integration), then the device info is shown correctly, also when the discovery is in the \"wrong\" order.\nOkay, you're right:\r\n\r\n1.  Send the discovery in the 'wrong' order\r\n2.  Restart MQTT service (HA in my case as I do not (want to) know how to restart just MQTT\r\n3.  Send the discovery again (order irrelevant)\r\n4.  Device are now connected.\r\n\r\nNow compare:\r\n1.  Send the discovery in the 'right' order\r\n2.  Device are now connected.\r\n\r\nYou have to agree this needs a fix. Again, I am not dependent on this. Just want to prevent new developers from the same quest.\r\n\nAlso, I will send you a free Button+ device as way to say thank you.\n> You have to agree this needs a fix. Again, I am not dependent on this. Just want to prevent new developers from the same quest.\r\n\r\nIf the discovery is in the \"wrong\" order, it seems obvious to me the parent device does not show after the first initial payload. After the second one, the parent device is defined, and it would be ideal to update the first entity. It could be solved, so I agree that that would need a fix. So thank you for reporting.\r\n\r\nOn the other hand it is only the very first time this could occur (only if the top level device discovery comes later), because after the top level device is defined in the device registry, it will be in the system (that is the Device Registry). \r\n\nNote:\r\nA hint is to open PR to add https://github.com/koenhendriks/ha-button-plus to\r\nhttps://www.home-assistant.io/integrations/mqtt/#support-by-third-party-tools\r\n\r\non:\r\nhttps://github.com/home-assistant/home-assistant.io\nI'm currently writing the HA integration into the Button+ firmware itself. Koen is aware of this and supporting me. His addon will (soon) be no longer needed.\nThat sound good. I am looking into a possible solution for this.", "created_at": "2024-11-25T23:18:33Z"}
{"repo": "home-assistant/core", "pull_number": 131582, "instance_id": "home-assistant__core-131582", "issue_numbers": ["131556"], "base_commit": "4ba8db1de47552856207bd36a8c1d35c8094f1da", "patch": "diff --git a/homeassistant/components/bmw_connected_drive/__init__.py b/homeassistant/components/bmw_connected_drive/__init__.py\nindex 9e43cfc418758..ef97b1186e78d 100644\n--- a/homeassistant/components/bmw_connected_drive/__init__.py\n+++ b/homeassistant/components/bmw_connected_drive/__init__.py\n@@ -85,23 +85,29 @@ async def _async_migrate_entries(\n     @callback\n     def update_unique_id(entry: er.RegistryEntry) -> dict[str, str] | None:\n         replacements = {\n-            \"charging_level_hv\": \"fuel_and_battery.remaining_battery_percent\",\n-            \"fuel_percent\": \"fuel_and_battery.remaining_fuel_percent\",\n-            \"ac_current_limit\": \"charging_profile.ac_current_limit\",\n-            \"charging_start_time\": \"fuel_and_battery.charging_start_time\",\n-            \"charging_end_time\": \"fuel_and_battery.charging_end_time\",\n-            \"charging_status\": \"fuel_and_battery.charging_status\",\n-            \"charging_target\": \"fuel_and_battery.charging_target\",\n-            \"remaining_battery_percent\": \"fuel_and_battery.remaining_battery_percent\",\n-            \"remaining_range_total\": \"fuel_and_battery.remaining_range_total\",\n-            \"remaining_range_electric\": \"fuel_and_battery.remaining_range_electric\",\n-            \"remaining_range_fuel\": \"fuel_and_battery.remaining_range_fuel\",\n-            \"remaining_fuel\": \"fuel_and_battery.remaining_fuel\",\n-            \"remaining_fuel_percent\": \"fuel_and_battery.remaining_fuel_percent\",\n-            \"activity\": \"climate.activity\",\n+            Platform.SENSOR.value: {\n+                \"charging_level_hv\": \"fuel_and_battery.remaining_battery_percent\",\n+                \"fuel_percent\": \"fuel_and_battery.remaining_fuel_percent\",\n+                \"ac_current_limit\": \"charging_profile.ac_current_limit\",\n+                \"charging_start_time\": \"fuel_and_battery.charging_start_time\",\n+                \"charging_end_time\": \"fuel_and_battery.charging_end_time\",\n+                \"charging_status\": \"fuel_and_battery.charging_status\",\n+                \"charging_target\": \"fuel_and_battery.charging_target\",\n+                \"remaining_battery_percent\": \"fuel_and_battery.remaining_battery_percent\",\n+                \"remaining_range_total\": \"fuel_and_battery.remaining_range_total\",\n+                \"remaining_range_electric\": \"fuel_and_battery.remaining_range_electric\",\n+                \"remaining_range_fuel\": \"fuel_and_battery.remaining_range_fuel\",\n+                \"remaining_fuel\": \"fuel_and_battery.remaining_fuel\",\n+                \"remaining_fuel_percent\": \"fuel_and_battery.remaining_fuel_percent\",\n+                \"activity\": \"climate.activity\",\n+            }\n         }\n-        if (key := entry.unique_id.split(\"-\")[-1]) in replacements:\n-            new_unique_id = entry.unique_id.replace(key, replacements[key])\n+        if (key := entry.unique_id.split(\"-\")[-1]) in replacements.get(\n+            entry.domain, []\n+        ):\n+            new_unique_id = entry.unique_id.replace(\n+                key, replacements[entry.domain][key]\n+            )\n             _LOGGER.debug(\n                 \"Migrating entity '%s' unique_id from '%s' to '%s'\",\n                 entry.entity_id,\n", "test_patch": "diff --git a/tests/components/bmw_connected_drive/test_init.py b/tests/components/bmw_connected_drive/test_init.py\nindex e523b2b3d0265..8507cacc37645 100644\n--- a/tests/components/bmw_connected_drive/test_init.py\n+++ b/tests/components/bmw_connected_drive/test_init.py\n@@ -10,7 +10,7 @@\n     CONF_READ_ONLY,\n     DOMAIN as BMW_DOMAIN,\n )\n-from homeassistant.components.sensor import DOMAIN as SENSOR_DOMAIN\n+from homeassistant.const import Platform\n from homeassistant.core import HomeAssistant\n from homeassistant.helpers import device_registry as dr, entity_registry as er\n \n@@ -18,6 +18,9 @@\n \n from tests.common import MockConfigEntry\n \n+BINARY_SENSOR_DOMAIN = Platform.BINARY_SENSOR.value\n+SENSOR_DOMAIN = Platform.SENSOR.value\n+\n VIN = \"WBYYYYYYYYYYYYYYY\"\n VEHICLE_NAME = \"i3 (+ REX)\"\n VEHICLE_NAME_SLUG = \"i3_rex\"\n@@ -109,6 +112,28 @@ async def test_migrate_options_from_data(hass: HomeAssistant) -> None:\n             f\"{VIN}-mileage\",\n             f\"{VIN}-mileage\",\n         ),\n+        (\n+            {\n+                \"domain\": SENSOR_DOMAIN,\n+                \"platform\": BMW_DOMAIN,\n+                \"unique_id\": f\"{VIN}-charging_status\",\n+                \"suggested_object_id\": f\"{VEHICLE_NAME} Charging Status\",\n+                \"disabled_by\": None,\n+            },\n+            f\"{VIN}-charging_status\",\n+            f\"{VIN}-fuel_and_battery.charging_status\",\n+        ),\n+        (\n+            {\n+                \"domain\": BINARY_SENSOR_DOMAIN,\n+                \"platform\": BMW_DOMAIN,\n+                \"unique_id\": f\"{VIN}-charging_status\",\n+                \"suggested_object_id\": f\"{VEHICLE_NAME} Charging Status\",\n+                \"disabled_by\": None,\n+            },\n+            f\"{VIN}-charging_status\",\n+            f\"{VIN}-charging_status\",\n+        ),\n     ],\n )\n async def test_migrate_unique_ids(\n", "problem_statement": "Problems with battery charging binary sensor\n### The problem\r\n\r\nIf I change entity id and title of the battery charging binary sensor, this is ignored and every restart of the system, the renamed sensor is getting unavailable and the old one with default id and name is readded.\r\n\r\nHere you can see the old and new after the restart some minutes ago.\r\n\r\n![image](https://github.com/user-attachments/assets/535c2b6d-bedf-4b8b-a5a5-38f5ed7620d1)\r\n\r\n![image](https://github.com/user-attachments/assets/09dba48d-4c71-47e5-bff9-9b40abadedd3)\r\n\r\n![image](https://github.com/user-attachments/assets/9f984e08-e5b0-4fac-b878-87bb3f9e5ffe)\r\n\r\nIt is happening every restart. Ony only after update to 2024.11\r\n\r\n\r\n### What version of Home Assistant Core has the issue?\r\n\r\n2024.11.3\r\n\r\n### What was the last working version of Home Assistant Core?\r\n\r\n2024.6 (updated from there because of reasons ;-))\r\n\r\n### What type of installation are you running?\r\n\r\nHome Assistant OS\r\n\r\n### Integration causing the issue\r\n\r\nbmw_connected_drive\r\n\r\n### Link to integration documentation on our website\r\n\r\nhttps://www.home-assistant.io/integrations/bmw_connected_drive\r\n\r\n### Diagnostics information\r\n\r\n_No response_\r\n\r\n### Example YAML snippet\r\n\r\n_No response_\r\n\r\n### Anything in the logs that might be useful for us?\r\n\r\n_No response_\r\n\r\n### Additional information\r\n\r\n_No response_\n", "hints_text": "\nHey there @gerard33, @rikroe, mind taking a look at this issue as it has been labeled with an integration (`bmw_connected_drive`) you are listed as a [code owner](https://github.com/home-assistant/core/blob/dev/CODEOWNERS#L213) for? Thanks!\n\n<details>\n<summary>Code owner commands</summary>\n\n\nCode owners of `bmw_connected_drive` can trigger bot actions by commenting:\n\n- `@home-assistant close` Closes the issue.\n- `@home-assistant rename Awesome new title` Renames the issue.\n- `@home-assistant reopen` Reopen the issue.\n- `@home-assistant unassign bmw_connected_drive` Removes the current integration label and assignees on the issue, add the integration domain after the command.\n- `@home-assistant add-label needs-more-information` Add a label (needs-more-information, problem in dependency, problem in custom component) to the issue.\n- `@home-assistant remove-label needs-more-information` Remove a label (needs-more-information, problem in dependency, problem in custom component) on the issue.\n\n</details>\n\n\n<sub><sup>(message by CodeOwnersMention)</sup></sub>\n\n---\n\n[bmw_connected_drive documentation](https://www.home-assistant.io/integrations/bmw_connected_drive)\n[bmw_connected_drive source](https://github.com/home-assistant/core/tree/dev/homeassistant/components/bmw_connected_drive)\n<sub><sup>(message by IssueLinks)</sup></sub>\nAre you still able to login? Because if not, I guess somehow the change is not persisted.\nWhat do you mean? HA (and the integration) is running normal beside this single entity, which is reverted/resetted/readded every restart.\nThere is some major issue with BMW login right now (and the integration not working at all). If you're not impacted, then it is something different.\r\n\r\nI'll try to reproduce, but it'll be earliest next week. \r\n\nThx. Of course not that urgent. ", "created_at": "2024-11-25T21:41:18Z"}
{"repo": "home-assistant/core", "pull_number": 131572, "instance_id": "home-assistant__core-131572", "issue_numbers": ["127832", "127832"], "base_commit": "1b62e122617aa9111b9e9b7478dff3c49354173c", "patch": "diff --git a/homeassistant/components/nibe_heatpump/manifest.json b/homeassistant/components/nibe_heatpump/manifest.json\nindex b3e5597da7382c..407cdfcfd57ee8 100644\n--- a/homeassistant/components/nibe_heatpump/manifest.json\n+++ b/homeassistant/components/nibe_heatpump/manifest.json\n@@ -5,5 +5,5 @@\n   \"config_flow\": true,\n   \"documentation\": \"https://www.home-assistant.io/integrations/nibe_heatpump\",\n   \"iot_class\": \"local_polling\",\n-  \"requirements\": [\"nibe==2.11.0\"]\n+  \"requirements\": [\"nibe==2.13.0\"]\n }\ndiff --git a/requirements_all.txt b/requirements_all.txt\nindex c8c06c4711a6bb..02fa6dcd6a30d1 100644\n--- a/requirements_all.txt\n+++ b/requirements_all.txt\n@@ -1457,7 +1457,7 @@ nextcord==2.6.0\n nextdns==4.0.0\n \n # homeassistant.components.nibe_heatpump\n-nibe==2.11.0\n+nibe==2.13.0\n \n # homeassistant.components.nice_go\n nice-go==0.3.10\n", "test_patch": "diff --git a/requirements_test_all.txt b/requirements_test_all.txt\nindex fb83d2adff2a3e..b24e1f2db8e7f9 100644\n--- a/requirements_test_all.txt\n+++ b/requirements_test_all.txt\n@@ -1217,7 +1217,7 @@ nextcord==2.6.0\n nextdns==4.0.0\n \n # homeassistant.components.nibe_heatpump\n-nibe==2.11.0\n+nibe==2.13.0\n \n # homeassistant.components.nice_go\n nice-go==0.3.10\n", "problem_statement": "Cannot select correct unit (kW) for sensor.energy_log_current_power_consumption_32306\n### The problem\n\nEntity \"NIBE S320 current power consumption\" (sensor.energy_log_current_power_consumption_32306)  should have W or kW unit of measurement, because it is CURRENT consumption. But only Wh or kWh can be selected .\n\n### What version of Home Assistant Core has the issue?\n\ncore-2024.10.1\n\n### What was the last working version of Home Assistant Core?\n\n_No response_\n\n### What type of installation are you running?\n\nHome Assistant OS\n\n### Integration causing the issue\n\nNIBE heat pump\n\n### Link to integration documentation on our website\n\nhttps://www.home-assistant.io/integrations/nibe_heatpump/\n\n### Diagnostics information\n\n_No response_\n\n### Example YAML snippet\n\n_No response_\n\n### Anything in the logs that might be useful for us?\n\n_No response_\n\n### Additional information\n\n_No response_\nCannot select correct unit (kW) for sensor.energy_log_current_power_consumption_32306\n### The problem\n\nEntity \"NIBE S320 current power consumption\" (sensor.energy_log_current_power_consumption_32306)  should have W or kW unit of measurement, because it is CURRENT consumption. But only Wh or kWh can be selected .\n\n### What version of Home Assistant Core has the issue?\n\ncore-2024.10.1\n\n### What was the last working version of Home Assistant Core?\n\n_No response_\n\n### What type of installation are you running?\n\nHome Assistant OS\n\n### Integration causing the issue\n\nNIBE heat pump\n\n### Link to integration documentation on our website\n\nhttps://www.home-assistant.io/integrations/nibe_heatpump/\n\n### Diagnostics information\n\n_No response_\n\n### Example YAML snippet\n\n_No response_\n\n### Anything in the logs that might be useful for us?\n\n_No response_\n\n### Additional information\n\n_No response_\n", "hints_text": "\nHey there @elupus, mind taking a look at this issue as it has been labeled with an integration (`nibe_heatpump`) you are listed as a [code owner](https://github.com/home-assistant/core/blob/dev/CODEOWNERS#L993) for? Thanks!\n\n<details>\n<summary>Code owner commands</summary>\n\n\nCode owners of `nibe_heatpump` can trigger bot actions by commenting:\n\n- `@home-assistant close` Closes the issue.\n- `@home-assistant rename Awesome new title` Renames the issue.\n- `@home-assistant reopen` Reopen the issue.\n- `@home-assistant unassign nibe_heatpump` Removes the current integration label and assignees on the issue, add the integration domain after the command.\n- `@home-assistant add-label needs-more-information` Add a label (needs-more-information, problem in dependency, problem in custom component) to the issue.\n- `@home-assistant remove-label needs-more-information` Remove a label (needs-more-information, problem in dependency, problem in custom component) on the issue.\n\n</details>\n\n\n<sub><sup>(message by CodeOwnersMention)</sup></sub>\n\n---\n\n[nibe_heatpump documentation](https://www.home-assistant.io/integrations/nibe_heatpump)\n[nibe_heatpump source](https://github.com/home-assistant/core/tree/dev/homeassistant/components/nibe_heatpump)\n<sub><sup>(message by IssueLinks)</sup></sub>\nAre you sure. \"Current\".here could mean the momentary power. If it is wrong it need to be fixed in upstream lib.\nI've launched pull request https://github.com/yozik04/nibe/pull/181 to fix this in the upstream lib.\nSaw that this fix was commited in upstream lib, would it be possible for a new release to get this updated and fixed?\n@elupus would it be possible to bump the integration to version 2.13 for this fix to be part of next HA version? \nGood evening!\r\nI think this issue is the culprit of my energy graphs being weird with negative values! :)\r\nAs I cannot see the actual version of Nibe that is installed in HA (missing version information in the \"Unit information\" / \"Enhet information\" section) I guess it is not yet released?\r\n@elupus  - A release of this fix would be greatly appreciated! Any information of when it is planned?\r\nLooking forward to this fix, and thanks very much for your work!\r\nBest Regards\nGo ahead and create a pull request. its a community project, so its up to all to contribute. I can review, but not time to do the changes myself at the moment.\n\nHey there @elupus, mind taking a look at this issue as it has been labeled with an integration (`nibe_heatpump`) you are listed as a [code owner](https://github.com/home-assistant/core/blob/dev/CODEOWNERS#L993) for? Thanks!\n\n<details>\n<summary>Code owner commands</summary>\n\n\nCode owners of `nibe_heatpump` can trigger bot actions by commenting:\n\n- `@home-assistant close` Closes the issue.\n- `@home-assistant rename Awesome new title` Renames the issue.\n- `@home-assistant reopen` Reopen the issue.\n- `@home-assistant unassign nibe_heatpump` Removes the current integration label and assignees on the issue, add the integration domain after the command.\n- `@home-assistant add-label needs-more-information` Add a label (needs-more-information, problem in dependency, problem in custom component) to the issue.\n- `@home-assistant remove-label needs-more-information` Remove a label (needs-more-information, problem in dependency, problem in custom component) on the issue.\n\n</details>\n\n\n<sub><sup>(message by CodeOwnersMention)</sup></sub>\n\n---\n\n[nibe_heatpump documentation](https://www.home-assistant.io/integrations/nibe_heatpump)\n[nibe_heatpump source](https://github.com/home-assistant/core/tree/dev/homeassistant/components/nibe_heatpump)\n<sub><sup>(message by IssueLinks)</sup></sub>\nAre you sure. \"Current\".here could mean the momentary power. If it is wrong it need to be fixed in upstream lib.\nI've launched pull request https://github.com/yozik04/nibe/pull/181 to fix this in the upstream lib.\nSaw that this fix was commited in upstream lib, would it be possible for a new release to get this updated and fixed?\n@elupus would it be possible to bump the integration to version 2.13 for this fix to be part of next HA version? \nGood evening!\r\nI think this issue is the culprit of my energy graphs being weird with negative values! :)\r\nAs I cannot see the actual version of Nibe that is installed in HA (missing version information in the \"Unit information\" / \"Enhet information\" section) I guess it is not yet released?\r\n@elupus  - A release of this fix would be greatly appreciated! Any information of when it is planned?\r\nLooking forward to this fix, and thanks very much for your work!\r\nBest Regards\nGo ahead and create a pull request. its a community project, so its up to all to contribute. I can review, but not time to do the changes myself at the moment.", "created_at": "2024-11-25T20:25:07Z"}
{"repo": "home-assistant/core", "pull_number": 131487, "instance_id": "home-assistant__core-131487", "issue_numbers": ["128269", "128269"], "base_commit": "d4071e7123d05acbda07864506541f879fb563cd", "patch": "diff --git a/homeassistant/components/unifiprotect/sensor.py b/homeassistant/components/unifiprotect/sensor.py\nindex a91a94aa6298f1..09187e023a1067 100644\n--- a/homeassistant/components/unifiprotect/sensor.py\n+++ b/homeassistant/components/unifiprotect/sensor.py\n@@ -245,7 +245,7 @@ def _get_alarm_sound(obj: Sensor) -> str:\n         name=\"Recording mode\",\n         icon=\"mdi:video-outline\",\n         entity_category=EntityCategory.DIAGNOSTIC,\n-        ufp_value=\"recording_settings.mode\",\n+        ufp_value=\"recording_settings.mode.value\",\n         ufp_perm=PermRequired.NO_WRITE,\n     ),\n     ProtectSensorEntityDescription(\n@@ -254,7 +254,7 @@ def _get_alarm_sound(obj: Sensor) -> str:\n         icon=\"mdi:circle-opacity\",\n         entity_category=EntityCategory.DIAGNOSTIC,\n         ufp_required_field=\"feature_flags.has_led_ir\",\n-        ufp_value=\"isp_settings.ir_led_mode\",\n+        ufp_value=\"isp_settings.ir_led_mode.value\",\n         ufp_perm=PermRequired.NO_WRITE,\n     ),\n     ProtectSensorEntityDescription(\n", "test_patch": "", "problem_statement": "Values for Recording mode and Infrared mode entities are not showing correctly\n### The problem\r\n\r\nValues for entities Infrared mode and Recording mode are not showing correctly. Values for Infrared mode are showing as \"IRLEDMode.AUTO\" rather than \"Auto\". Recording mode is showing as \"RecordingMode.ALWAYS\" rather than \"Always\".\r\n\r\n### What version of Home Assistant Core has the issue?\r\n\r\n2024.10.2\r\n\r\n### What was the last working version of Home Assistant Core?\r\n\r\n_No response_\r\n\r\n### What type of installation are you running?\r\n\r\nHome Assistant OS\r\n\r\n### Integration causing the issue\r\n\r\nUnifi Protect\r\n\r\n### Link to integration documentation on our website\r\n\r\nhttps://www.home-assistant.io/integrations/unifiprotect/\r\n\r\n### Diagnostics information\r\n\r\n[config_entry-unifiprotect-01J9WJ69YY69V7C84KZGE71TR3.json](https://github.com/user-attachments/files/17352620/config_entry-unifiprotect-01J9WJ69YY69V7C84KZGE71TR3.json)\r\n\r\n\r\n### Example YAML snippet\r\n\r\n_No response_\r\n\r\n### Anything in the logs that might be useful for us?\r\n\r\n_No response_\r\n\r\n### Additional information\r\n\r\n_No response_\nValues for Recording mode and Infrared mode entities are not showing correctly\n### The problem\r\n\r\nValues for entities Infrared mode and Recording mode are not showing correctly. Values for Infrared mode are showing as \"IRLEDMode.AUTO\" rather than \"Auto\". Recording mode is showing as \"RecordingMode.ALWAYS\" rather than \"Always\".\r\n\r\n### What version of Home Assistant Core has the issue?\r\n\r\n2024.10.2\r\n\r\n### What was the last working version of Home Assistant Core?\r\n\r\n_No response_\r\n\r\n### What type of installation are you running?\r\n\r\nHome Assistant OS\r\n\r\n### Integration causing the issue\r\n\r\nUnifi Protect\r\n\r\n### Link to integration documentation on our website\r\n\r\nhttps://www.home-assistant.io/integrations/unifiprotect/\r\n\r\n### Diagnostics information\r\n\r\n[config_entry-unifiprotect-01J9WJ69YY69V7C84KZGE71TR3.json](https://github.com/user-attachments/files/17352620/config_entry-unifiprotect-01J9WJ69YY69V7C84KZGE71TR3.json)\r\n\r\n\r\n### Example YAML snippet\r\n\r\n_No response_\r\n\r\n### Anything in the logs that might be useful for us?\r\n\r\n_No response_\r\n\r\n### Additional information\r\n\r\n_No response_\n", "hints_text": "[unifiprotect documentation](https://www.home-assistant.io/integrations/unifiprotect)\n[unifiprotect source](https://github.com/home-assistant/core/tree/dev/homeassistant/components/unifiprotect)\n@cholywell Does the issue still persist with the current HA version? It's working for me:\r\n![image](https://github.com/user-attachments/assets/b7cf788c-42c3-449d-84e1-20baf1b6c2fb)\r\n\n<img width=\"291\" alt=\"Screenshot 2024-11-22 at 5 16 18\u202fPM\" src=\"https://github.com/user-attachments/assets/ef47506d-16f7-4882-8dfc-c70bb8841497\">\r\n\r\n@RaHehl I'm on 2024.11.2 and it's still broken.\n@cholywell Does the issue also occur in the browser's incognito mode?\n> @cholywell \"Does the issue also occur in the browser's incognito mode?\"\r\n\r\nAfter comparing your screenshot I found the problem.  The local user that the Home Assistant integration uses on Protect was set to \"View Only\".  Once I set it to \"Full Management\" and reloaded the integration it fixed everything.  Not that I want to be able to modify things on the CloudKey via Home Assistant but at least I know whats wrong now.\r\n\r\n<img width=\"287\" alt=\"Screenshot 2024-11-22 at 5 23 50\u202fPM\" src=\"https://github.com/user-attachments/assets/5ac70ceb-b9aa-42b0-b30f-c904ba15fff4\">\r\n\nAh yes, the 'view only' aspect is a good point. With 'view only' permissions, `sensor.py` provides the values, while with write permissions, `select.py` is used, which references the appropriate enum to correctly map the values. However, this mapping seems to be missing in the 'view only' variant.\r\n![image](https://github.com/user-attachments/assets/27aa62c7-793d-419c-9d64-fecf4ec1ed37)\r\n![image](https://github.com/user-attachments/assets/eb72e5a3-edd6-4f05-802f-8bed4d522ff8)\r\n\n[unifiprotect documentation](https://www.home-assistant.io/integrations/unifiprotect)\n[unifiprotect source](https://github.com/home-assistant/core/tree/dev/homeassistant/components/unifiprotect)\n@cholywell Does the issue still persist with the current HA version? It's working for me:\r\n![image](https://github.com/user-attachments/assets/b7cf788c-42c3-449d-84e1-20baf1b6c2fb)\r\n\n<img width=\"291\" alt=\"Screenshot 2024-11-22 at 5 16 18\u202fPM\" src=\"https://github.com/user-attachments/assets/ef47506d-16f7-4882-8dfc-c70bb8841497\">\r\n\r\n@RaHehl I'm on 2024.11.2 and it's still broken.\n@cholywell Does the issue also occur in the browser's incognito mode?\n> @cholywell \"Does the issue also occur in the browser's incognito mode?\"\r\n\r\nAfter comparing your screenshot I found the problem.  The local user that the Home Assistant integration uses on Protect was set to \"View Only\".  Once I set it to \"Full Management\" and reloaded the integration it fixed everything.  Not that I want to be able to modify things on the CloudKey via Home Assistant but at least I know whats wrong now.\r\n\r\n<img width=\"287\" alt=\"Screenshot 2024-11-22 at 5 23 50\u202fPM\" src=\"https://github.com/user-attachments/assets/5ac70ceb-b9aa-42b0-b30f-c904ba15fff4\">\r\n\nAh yes, the 'view only' aspect is a good point. With 'view only' permissions, `sensor.py` provides the values, while with write permissions, `select.py` is used, which references the appropriate enum to correctly map the values. However, this mapping seems to be missing in the 'view only' variant.\r\n![image](https://github.com/user-attachments/assets/27aa62c7-793d-419c-9d64-fecf4ec1ed37)\r\n![image](https://github.com/user-attachments/assets/eb72e5a3-edd6-4f05-802f-8bed4d522ff8)\r\n", "created_at": "2024-11-24T20:37:05Z"}
{"repo": "home-assistant/core", "pull_number": 131436, "instance_id": "home-assistant__core-131436", "issue_numbers": ["131232", "131232"], "base_commit": "60cf79765039eafa94897343ea0393f5233d40f3", "patch": "diff --git a/homeassistant/components/airtouch5/manifest.json b/homeassistant/components/airtouch5/manifest.json\nindex 312a627d0e8813..58ef8668ebe105 100644\n--- a/homeassistant/components/airtouch5/manifest.json\n+++ b/homeassistant/components/airtouch5/manifest.json\n@@ -6,5 +6,5 @@\n   \"documentation\": \"https://www.home-assistant.io/integrations/airtouch5\",\n   \"iot_class\": \"local_push\",\n   \"loggers\": [\"airtouch5py\"],\n-  \"requirements\": [\"airtouch5py==0.2.10\"]\n+  \"requirements\": [\"airtouch5py==0.2.11\"]\n }\ndiff --git a/requirements_all.txt b/requirements_all.txt\nindex f0fb753f9d7dba..c36746db073983 100644\n--- a/requirements_all.txt\n+++ b/requirements_all.txt\n@@ -441,7 +441,7 @@ airthings-cloud==0.2.0\n airtouch4pyapi==1.0.5\n \n # homeassistant.components.airtouch5\n-airtouch5py==0.2.10\n+airtouch5py==0.2.11\n \n # homeassistant.components.alpha_vantage\n alpha-vantage==2.3.1\n", "test_patch": "diff --git a/requirements_test_all.txt b/requirements_test_all.txt\nindex 0c1b3e9446fd81..5b6f7c69f389a8 100644\n--- a/requirements_test_all.txt\n+++ b/requirements_test_all.txt\n@@ -423,7 +423,7 @@ airthings-cloud==0.2.0\n airtouch4pyapi==1.0.5\n \n # homeassistant.components.airtouch5\n-airtouch5py==0.2.10\n+airtouch5py==0.2.11\n \n # homeassistant.components.amberelectric\n amberelectric==2.0.12\n", "problem_statement": "Unable to connect to AirTouch5 with integration\n### The problem\n\nUnable to connect to Airtouch5 host via IP address.\n\n### What version of Home Assistant Core has the issue?\n\n2024.11.2\n\n### What was the last working version of Home Assistant Core?\n\n_No response_\n\n### What type of installation are you running?\n\nHome Assistant OS\n\n### Integration causing the issue\n\nairtouch5\n\n### Link to integration documentation on our website\n\nhttps://www.home-assistant.io/integrations/airtouch5\n\n### Diagnostics information\n\n_No response_\n\n### Example YAML snippet\n\n_No response_\n\n### Anything in the logs that might be useful for us?\n\n```txt\n2024-11-22 15:12:42.453 INFO (MainThread) [airtouch5py.airtouch5_client] Connecting to 192.168.0.119:9005\r\n2024-11-22 15:12:42.457 INFO (MainThread) [airtouch5py.airtouch5_client] Connected to 192.168.0.119:9005\r\n2024-11-22 15:12:42.458 DEBUG (MainThread) [airtouch5py.airtouch5_client] Sending data: b'555555aa90b0021f0002ff11b04c'\r\n2024-11-22 15:12:42.554 DEBUG (MainThread) [airtouch5py.airtouch5_client] Received data: b'555555ab000001120112555555aab090021f0106ff1100184c6976696e670000000000000000000000001f1d121e101e011844696e696e670000000000000000000000001f1d121e101e0218426173656d656e74000000000000000000001f1d121e101e03185374756479000000000000000000000000001f1d121e101e04184265643100000000000000000000000000001f1d121e101e0518456e737569746500000000000000000000001f1d121e101e06184b69647320706c61790000000000000000001f1d121e101e07184265642032000000000000000000000000001f1d121e101e08184265642033000000000000000000000000001f1d121e101e09184265642034000000000000000000000000001f1d121e101eb587'\r\n2024-11-22 15:12:42.554 DEBUG (MainThread) [airtouch5py.airtouch5_client] Sending data: b'555555aa90b0031f0002ff13a0cc'\r\n2024-11-22 15:12:42.648 DEBUG (MainThread) [airtouch5py.airtouch5_client] Received data: b'555555ab0000000e000e555555aab090031f0002ff137aef'\r\n2024-11-22 15:13:07.982 INFO (MainThread) [airtouch5py.airtouch5_client] Connecting to 192.168.0.119:9005\r\n2024-11-22 15:13:07.986 INFO (MainThread) [airtouch5py.airtouch5_client] Connected to 192.168.0.119:9005\r\n2024-11-22 15:13:07.986 DEBUG (MainThread) [airtouch5py.airtouch5_client] Sending data: b'555555aa90b0021f0002ff11b04c'\r\n2024-11-22 15:13:08.146 DEBUG (MainThread) [airtouch5py.airtouch5_client] Received data: b'555555ab000001120112555555aab090021f0106ff1100184c6976696e670000000000000000000000001f1d121e101e011844696e696e670000000000000000000000001f1d121e101e0218426173656d656e74000000000000000000001f1d121e101e03185374756479000000000000000000000000001f1d121e101e04184265643100000000000000000000000000001f1d121e101e0518456e737569746500000000000000000000001f1d121e101e06184b69647320706c61790000000000000000001f1d121e101e07184265642032000000000000000000000000001f1d121e101e08184265642033000000000000000000000000001f1d121e101e09184265642034000000000000000000000000001f1d121e101eb587'\r\n2024-11-22 15:13:08.146 DEBUG (MainThread) [airtouch5py.airtouch5_client] Sending data: b'555555aa90b0031f0002ff13a0cc'\r\n2024-11-22 15:13:08.239 DEBUG (MainThread) [airtouch5py.airtouch5_client] Received data: b'555555ab0000000e000e555555aab090031f0002ff137aef'\r\n2024-11-22 15:13:19.493 ERROR (MainThread) [homeassistant] Error doing job: Task was destroyed but it is pending! (<Task pending name='Task-31180' coro=<Airtouch5Client._read_packets() running at /usr/local/lib/python3.12/site-packages/airtouch5py/airtouch5_client.py:116> wait_for=<Future pending cb=[Task.task_wakeup()]>>)\r\n2024-11-22 15:13:19.494 ERROR (MainThread) [homeassistant] Error doing job: Task was destroyed but it is pending! (<Task pending name='Task-31211' coro=<Airtouch5Client._read_packets() running at /usr/local/lib/python3.12/site-packages/airtouch5py/airtouch5_client.py:116> wait_for=<Future pending cb=[Task.task_wakeup()]>>)\n```\n\n\n### Additional information\n\n_No response_\nUnable to connect to AirTouch5 with integration\n### The problem\n\nUnable to connect to Airtouch5 host via IP address.\n\n### What version of Home Assistant Core has the issue?\n\n2024.11.2\n\n### What was the last working version of Home Assistant Core?\n\n_No response_\n\n### What type of installation are you running?\n\nHome Assistant OS\n\n### Integration causing the issue\n\nairtouch5\n\n### Link to integration documentation on our website\n\nhttps://www.home-assistant.io/integrations/airtouch5\n\n### Diagnostics information\n\n_No response_\n\n### Example YAML snippet\n\n_No response_\n\n### Anything in the logs that might be useful for us?\n\n```txt\n2024-11-22 15:12:42.453 INFO (MainThread) [airtouch5py.airtouch5_client] Connecting to 192.168.0.119:9005\r\n2024-11-22 15:12:42.457 INFO (MainThread) [airtouch5py.airtouch5_client] Connected to 192.168.0.119:9005\r\n2024-11-22 15:12:42.458 DEBUG (MainThread) [airtouch5py.airtouch5_client] Sending data: b'555555aa90b0021f0002ff11b04c'\r\n2024-11-22 15:12:42.554 DEBUG (MainThread) [airtouch5py.airtouch5_client] Received data: b'555555ab000001120112555555aab090021f0106ff1100184c6976696e670000000000000000000000001f1d121e101e011844696e696e670000000000000000000000001f1d121e101e0218426173656d656e74000000000000000000001f1d121e101e03185374756479000000000000000000000000001f1d121e101e04184265643100000000000000000000000000001f1d121e101e0518456e737569746500000000000000000000001f1d121e101e06184b69647320706c61790000000000000000001f1d121e101e07184265642032000000000000000000000000001f1d121e101e08184265642033000000000000000000000000001f1d121e101e09184265642034000000000000000000000000001f1d121e101eb587'\r\n2024-11-22 15:12:42.554 DEBUG (MainThread) [airtouch5py.airtouch5_client] Sending data: b'555555aa90b0031f0002ff13a0cc'\r\n2024-11-22 15:12:42.648 DEBUG (MainThread) [airtouch5py.airtouch5_client] Received data: b'555555ab0000000e000e555555aab090031f0002ff137aef'\r\n2024-11-22 15:13:07.982 INFO (MainThread) [airtouch5py.airtouch5_client] Connecting to 192.168.0.119:9005\r\n2024-11-22 15:13:07.986 INFO (MainThread) [airtouch5py.airtouch5_client] Connected to 192.168.0.119:9005\r\n2024-11-22 15:13:07.986 DEBUG (MainThread) [airtouch5py.airtouch5_client] Sending data: b'555555aa90b0021f0002ff11b04c'\r\n2024-11-22 15:13:08.146 DEBUG (MainThread) [airtouch5py.airtouch5_client] Received data: b'555555ab000001120112555555aab090021f0106ff1100184c6976696e670000000000000000000000001f1d121e101e011844696e696e670000000000000000000000001f1d121e101e0218426173656d656e74000000000000000000001f1d121e101e03185374756479000000000000000000000000001f1d121e101e04184265643100000000000000000000000000001f1d121e101e0518456e737569746500000000000000000000001f1d121e101e06184b69647320706c61790000000000000000001f1d121e101e07184265642032000000000000000000000000001f1d121e101e08184265642033000000000000000000000000001f1d121e101e09184265642034000000000000000000000000001f1d121e101eb587'\r\n2024-11-22 15:13:08.146 DEBUG (MainThread) [airtouch5py.airtouch5_client] Sending data: b'555555aa90b0031f0002ff13a0cc'\r\n2024-11-22 15:13:08.239 DEBUG (MainThread) [airtouch5py.airtouch5_client] Received data: b'555555ab0000000e000e555555aab090031f0002ff137aef'\r\n2024-11-22 15:13:19.493 ERROR (MainThread) [homeassistant] Error doing job: Task was destroyed but it is pending! (<Task pending name='Task-31180' coro=<Airtouch5Client._read_packets() running at /usr/local/lib/python3.12/site-packages/airtouch5py/airtouch5_client.py:116> wait_for=<Future pending cb=[Task.task_wakeup()]>>)\r\n2024-11-22 15:13:19.494 ERROR (MainThread) [homeassistant] Error doing job: Task was destroyed but it is pending! (<Task pending name='Task-31211' coro=<Airtouch5Client._read_packets() running at /usr/local/lib/python3.12/site-packages/airtouch5py/airtouch5_client.py:116> wait_for=<Future pending cb=[Task.task_wakeup()]>>)\n```\n\n\n### Additional information\n\n_No response_\n", "hints_text": "\nHey there @danzel, mind taking a look at this issue as it has been labeled with an integration (`airtouch5`) you are listed as a [code owner](https://github.com/home-assistant/core/blob/dev/CODEOWNERS#L76) for? Thanks!\n\n<details>\n<summary>Code owner commands</summary>\n\n\nCode owners of `airtouch5` can trigger bot actions by commenting:\n\n- `@home-assistant close` Closes the issue.\n- `@home-assistant rename Awesome new title` Renames the issue.\n- `@home-assistant reopen` Reopen the issue.\n- `@home-assistant unassign airtouch5` Removes the current integration label and assignees on the issue, add the integration domain after the command.\n- `@home-assistant add-label needs-more-information` Add a label (needs-more-information, problem in dependency, problem in custom component) to the issue.\n- `@home-assistant remove-label needs-more-information` Remove a label (needs-more-information, problem in dependency, problem in custom component) on the issue.\n\n</details>\n\n\n<sub><sup>(message by CodeOwnersMention)</sup></sub>\n\n---\n\n[airtouch5 documentation](https://www.home-assistant.io/integrations/airtouch5)\n[airtouch5 source](https://github.com/home-assistant/core/tree/dev/homeassistant/components/airtouch5)\n<sub><sup>(message by IssueLinks)</sup></sub>\nWhat are the versions of the software on your AirTouch hardware?\r\nDoes the official AirTouch app work?\r\n________________________________\r\nFrom: home-assistant[bot] ***@***.***>\r\nSent: Friday, November 22, 2024 5:19:20 PM\r\nTo: home-assistant/core ***@***.***>\r\nCc: David Leaver ***@***.***>; Mention ***@***.***>\r\nSubject: Re: [home-assistant/core] Unable to connect to AirTouch5 with integration (Issue #131232)\r\n\r\n\r\nHey there @danzel<https://github.com/danzel>, mind taking a look at this issue as it has been labeled with an integration (airtouch5) you are listed as a code owner<https://github.com/home-assistant/core/blob/dev/CODEOWNERS#L76> for? Thanks!\r\n\r\nCode owner commands\r\n\r\nCode owners of airtouch5 can trigger bot actions by commenting:\r\n\r\n  *   @home-assistant close Closes the issue.\r\n  *   @home-assistant rename Awesome new title Renames the issue.\r\n  *   @home-assistant reopen Reopen the issue.\r\n  *   @home-assistant unassign airtouch5 Removes the current integration label and assignees on the issue, add the integration domain after the command.\r\n  *   @home-assistant add-label needs-more-information Add a label (needs-more-information, problem in dependency, problem in custom component) to the issue.\r\n  *   @home-assistant remove-label needs-more-information Remove a label (needs-more-information, problem in dependency, problem in custom component) on the issue.\r\n\r\n(message by CodeOwnersMention)\r\n\r\n________________________________\r\n\r\nairtouch5 documentation<https://www.home-assistant.io/integrations/airtouch5>\r\nairtouch5 source<https://github.com/home-assistant/core/tree/dev/homeassistant/components/airtouch5>\r\n(message by IssueLinks)\r\n\r\n\u2014\r\nReply to this email directly, view it on GitHub<https://github.com/home-assistant/core/issues/131232#issuecomment-2492844902>, or unsubscribe<https://github.com/notifications/unsubscribe-auth/AAC767X5MLUHKPSJ3QJVF3L2B2WERAVCNFSM6AAAAABSIPHCBWVHI2DSMVQWIX3LMV43OSLTON2WKQ3PNVWWK3TUHMZDIOJSHA2DIOJQGI>.\r\nYou are receiving this because you were mentioned.Message ID: ***@***.***>\r\n\n@danzel \r\n\r\n1. HW 2.3.0.E, module 2.0.1.4, console 1.2.1\r\n2. Official app works, as does Google Home integration\nThe last message you received doesn't decode, docs say we should be ignoring it but we aren't.\r\n\r\nWill send a fix, in the mean time you might be able to retry a few times :shrug:\n\nHey there @danzel, mind taking a look at this issue as it has been labeled with an integration (`airtouch5`) you are listed as a [code owner](https://github.com/home-assistant/core/blob/dev/CODEOWNERS#L76) for? Thanks!\n\n<details>\n<summary>Code owner commands</summary>\n\n\nCode owners of `airtouch5` can trigger bot actions by commenting:\n\n- `@home-assistant close` Closes the issue.\n- `@home-assistant rename Awesome new title` Renames the issue.\n- `@home-assistant reopen` Reopen the issue.\n- `@home-assistant unassign airtouch5` Removes the current integration label and assignees on the issue, add the integration domain after the command.\n- `@home-assistant add-label needs-more-information` Add a label (needs-more-information, problem in dependency, problem in custom component) to the issue.\n- `@home-assistant remove-label needs-more-information` Remove a label (needs-more-information, problem in dependency, problem in custom component) on the issue.\n\n</details>\n\n\n<sub><sup>(message by CodeOwnersMention)</sup></sub>\n\n---\n\n[airtouch5 documentation](https://www.home-assistant.io/integrations/airtouch5)\n[airtouch5 source](https://github.com/home-assistant/core/tree/dev/homeassistant/components/airtouch5)\n<sub><sup>(message by IssueLinks)</sup></sub>\nWhat are the versions of the software on your AirTouch hardware?\r\nDoes the official AirTouch app work?\r\n________________________________\r\nFrom: home-assistant[bot] ***@***.***>\r\nSent: Friday, November 22, 2024 5:19:20 PM\r\nTo: home-assistant/core ***@***.***>\r\nCc: David Leaver ***@***.***>; Mention ***@***.***>\r\nSubject: Re: [home-assistant/core] Unable to connect to AirTouch5 with integration (Issue #131232)\r\n\r\n\r\nHey there @danzel<https://github.com/danzel>, mind taking a look at this issue as it has been labeled with an integration (airtouch5) you are listed as a code owner<https://github.com/home-assistant/core/blob/dev/CODEOWNERS#L76> for? Thanks!\r\n\r\nCode owner commands\r\n\r\nCode owners of airtouch5 can trigger bot actions by commenting:\r\n\r\n  *   @home-assistant close Closes the issue.\r\n  *   @home-assistant rename Awesome new title Renames the issue.\r\n  *   @home-assistant reopen Reopen the issue.\r\n  *   @home-assistant unassign airtouch5 Removes the current integration label and assignees on the issue, add the integration domain after the command.\r\n  *   @home-assistant add-label needs-more-information Add a label (needs-more-information, problem in dependency, problem in custom component) to the issue.\r\n  *   @home-assistant remove-label needs-more-information Remove a label (needs-more-information, problem in dependency, problem in custom component) on the issue.\r\n\r\n(message by CodeOwnersMention)\r\n\r\n________________________________\r\n\r\nairtouch5 documentation<https://www.home-assistant.io/integrations/airtouch5>\r\nairtouch5 source<https://github.com/home-assistant/core/tree/dev/homeassistant/components/airtouch5>\r\n(message by IssueLinks)\r\n\r\n\u2014\r\nReply to this email directly, view it on GitHub<https://github.com/home-assistant/core/issues/131232#issuecomment-2492844902>, or unsubscribe<https://github.com/notifications/unsubscribe-auth/AAC767X5MLUHKPSJ3QJVF3L2B2WERAVCNFSM6AAAAABSIPHCBWVHI2DSMVQWIX3LMV43OSLTON2WKQ3PNVWWK3TUHMZDIOJSHA2DIOJQGI>.\r\nYou are receiving this because you were mentioned.Message ID: ***@***.***>\r\n\n@danzel \r\n\r\n1. HW 2.3.0.E, module 2.0.1.4, console 1.2.1\r\n2. Official app works, as does Google Home integration\nThe last message you received doesn't decode, docs say we should be ignoring it but we aren't.\r\n\r\nWill send a fix, in the mean time you might be able to retry a few times :shrug:", "created_at": "2024-11-24T07:24:12Z"}
{"repo": "home-assistant/core", "pull_number": 131423, "instance_id": "home-assistant__core-131423", "issue_numbers": ["131340"], "base_commit": "0a8dde3740d71df4a2d093b2ea9a446f94aa5655", "patch": "diff --git a/homeassistant/components/workday/config_flow.py b/homeassistant/components/workday/config_flow.py\nindex 727c4340ea3c7f..2036d685d3139e 100644\n--- a/homeassistant/components/workday/config_flow.py\n+++ b/homeassistant/components/workday/config_flow.py\n@@ -67,12 +67,14 @@ def add_province_and_language_to_schema(\n     _country = country_holidays(country=country)\n     if country_default_language := (_country.default_language):\n         selectable_languages = _country.supported_languages\n-        new_selectable_languages = [lang[:2] for lang in selectable_languages]\n+        new_selectable_languages = list(selectable_languages)\n         language_schema = {\n             vol.Optional(\n                 CONF_LANGUAGE, default=country_default_language\n             ): LanguageSelector(\n-                LanguageSelectorConfig(languages=new_selectable_languages)\n+                LanguageSelectorConfig(\n+                    languages=new_selectable_languages, native_name=True\n+                )\n             )\n         }\n \n", "test_patch": "diff --git a/tests/components/workday/test_config_flow.py b/tests/components/workday/test_config_flow.py\nindex cc83cee93a2613..1bf0f176fe9c67 100644\n--- a/tests/components/workday/test_config_flow.py\n+++ b/tests/components/workday/test_config_flow.py\n@@ -557,7 +557,7 @@ async def test_options_form_incorrect_date_ranges(hass: HomeAssistant) -> None:\n     (\"language\", \"holiday\"),\n     [\n         (\"de\", \"Weihnachtstag\"),\n-        (\"en\", \"Christmas\"),\n+        (\"en_US\", \"Christmas\"),\n     ],\n )\n async def test_language(\n", "problem_statement": "Integration Workday reporting \"Value en_AU is not a valid option\"\n### The problem\n\nWhen trying to add a Workday integration to 2024.11.2, with the country set to Australia, \r\nit reports the error \"Value en_AU is not a valid option\"\r\n\r\nTo reproduce:\r\n- Add integration: Workday\r\n- set country: Australia\r\n- leave all settings as-is\r\n- click [Submit]\r\n-> between [Remove holidays] and [Language for named holidays] a popup appears that reports\r\n-> (!) Value en_AU is not a valid option\r\n\r\nattached image of error:\r\n![image](https://github.com/user-attachments/assets/9b270b75-b31c-4030-a906-a113b1085b1e)\n\n### What version of Home Assistant Core has the issue?\n\ncore-2024.11.2\n\n### What was the last working version of Home Assistant Core?\n\n_No response_\n\n### What type of installation are you running?\n\nHome Assistant OS\n\n### Integration causing the issue\n\nWorkday\n\n### Link to integration documentation on our website\n\nhttps://www.home-assistant.io/integrations/workday/\n\n### Diagnostics information\n\n_No response_\n\n### Example YAML snippet\n\n_No response_\n\n### Anything in the logs that might be useful for us?\n\n```txt\n\"workday\" not found in the system logs\n```\n\n\n### Additional information\n\n_No response_\n", "hints_text": "\nHey there @fabaff, @gjohansson-st, mind taking a look at this issue as it has been labeled with an integration (`workday`) you are listed as a [code owner](https://github.com/home-assistant/core/blob/dev/CODEOWNERS#L1689) for? Thanks!\n\n<details>\n<summary>Code owner commands</summary>\n\n\nCode owners of `workday` can trigger bot actions by commenting:\n\n- `@home-assistant close` Closes the issue.\n- `@home-assistant rename Awesome new title` Renames the issue.\n- `@home-assistant reopen` Reopen the issue.\n- `@home-assistant unassign workday` Removes the current integration label and assignees on the issue, add the integration domain after the command.\n- `@home-assistant add-label needs-more-information` Add a label (needs-more-information, problem in dependency, problem in custom component) to the issue.\n- `@home-assistant remove-label needs-more-information` Remove a label (needs-more-information, problem in dependency, problem in custom component) on the issue.\n\n</details>\n\n\n<sub><sup>(message by CodeOwnersMention)</sup></sub>\n\n---\n\n[workday documentation](https://www.home-assistant.io/integrations/workday)\n[workday source](https://github.com/home-assistant/core/tree/dev/homeassistant/components/workday)\n<sub><sup>(message by IssueLinks)</sup></sub>", "created_at": "2024-11-23T23:10:30Z"}
{"repo": "home-assistant/core", "pull_number": 131373, "instance_id": "home-assistant__core-131373", "issue_numbers": ["130742"], "base_commit": "e856ba11d038dda82cf51b679cacd230194ae987", "patch": "diff --git a/homeassistant/components/solax/manifest.json b/homeassistant/components/solax/manifest.json\nindex 2ca246a4e77cff..631ace3792ffa1 100644\n--- a/homeassistant/components/solax/manifest.json\n+++ b/homeassistant/components/solax/manifest.json\n@@ -6,5 +6,5 @@\n   \"documentation\": \"https://www.home-assistant.io/integrations/solax\",\n   \"iot_class\": \"local_polling\",\n   \"loggers\": [\"solax\"],\n-  \"requirements\": [\"solax==3.1.1\"]\n+  \"requirements\": [\"solax==3.2.1\"]\n }\ndiff --git a/requirements_all.txt b/requirements_all.txt\nindex c9c17f5b6b8965..f7b8813f206b43 100644\n--- a/requirements_all.txt\n+++ b/requirements_all.txt\n@@ -2704,7 +2704,7 @@ solaredge-local==0.2.3\n solarlog_cli==0.3.2\n \n # homeassistant.components.solax\n-solax==3.1.1\n+solax==3.2.1\n \n # homeassistant.components.somfy_mylink\n somfy-mylink-synergy==1.0.6\n", "test_patch": "diff --git a/requirements_test_all.txt b/requirements_test_all.txt\nindex 943c919429a289..7cf39640ddd432 100644\n--- a/requirements_test_all.txt\n+++ b/requirements_test_all.txt\n@@ -2156,7 +2156,7 @@ soco==0.30.6\n solarlog_cli==0.3.2\n \n # homeassistant.components.solax\n-solax==3.1.1\n+solax==3.2.1\n \n # homeassistant.components.somfy_mylink\n somfy-mylink-synergy==1.0.6\n", "problem_statement": "Solax daily / total sensors mixed up and incorrectly marked as total_increasing \n### The problem\n\nFour sensor values are wrong on Solax X3-Hybrid-G4 - I don't have other solax inverters to compare.\r\n\r\nBoth Consumed energy and Feed in energy:\r\na) `_consumed_energy_total` and `_feed_in_energy_total`- this is not actually a **total** value, it's reset daily - daily value, wrong name.\r\nb) `_consumed_energy_total` and `_feed_in_energy_total` - as daily reset, it's `state` is market incorrectly as `total_increasing`.\r\nc)  _consumed_energy` and `_feed_in_energy` - lack a `_total` suffix, but actually this is a total increasing sensor. `state` **correctly** marked as `total_increasing`.\r\n\r\nSummary - total and daily are swapped, and both incorrectly `state: total_increasing`\r\n\r\nI'll try to find this in the code and open a PR if time allows.\n\n### What version of Home Assistant Core has the issue?\n\ncore-2024.11.2\n\n### What was the last working version of Home Assistant Core?\n\n_No response_\n\n### What type of installation are you running?\n\nHome Assistant OS\n\n### Integration causing the issue\n\nsolax\n\n### Link to integration documentation on our website\n\nhttps://www.home-assistant.io/integrations/solax\n\n### Diagnostics information\n\n_No response_\n\n### Example YAML snippet\n\n_No response_\n\n### Anything in the logs that might be useful for us?\n\n_No response_\n\n### Additional information\n\n_No response_\n", "hints_text": "\nHey there @squishykid, mind taking a look at this issue as it has been labeled with an integration (`solax`) you are listed as a [code owner](https://github.com/home-assistant/core/blob/dev/CODEOWNERS#L1387) for? Thanks!\n\n<details>\n<summary>Code owner commands</summary>\n\n\nCode owners of `solax` can trigger bot actions by commenting:\n\n- `@home-assistant close` Closes the issue.\n- `@home-assistant rename Awesome new title` Renames the issue.\n- `@home-assistant reopen` Reopen the issue.\n- `@home-assistant unassign solax` Removes the current integration label and assignees on the issue, add the integration domain after the command.\n- `@home-assistant add-label needs-more-information` Add a label (needs-more-information, problem in dependency, problem in custom component) to the issue.\n- `@home-assistant remove-label needs-more-information` Remove a label (needs-more-information, problem in dependency, problem in custom component) on the issue.\n\n</details>\n\n\n<sub><sup>(message by CodeOwnersMention)</sup></sub>\n\n---\n\n[solax documentation](https://www.home-assistant.io/integrations/solax)\n[solax source](https://github.com/home-assistant/core/tree/dev/homeassistant/components/solax)\n<sub><sup>(message by IssueLinks)</sup></sub>\nI suspect ~~while tagging the sensors with `state` set to `total_increasing` is done by the integartion,~~ the daily/total getting mixed up could've happened in [the solax library](https://github.com/squishykid/solax ) in [this line](https://github.com/squishykid/solax/blob/master/solax/inverters/x3_hybrid_g4.py#L122)\r\n\r\n```\r\n            \"Feed-in Energy\": (pack_u16(86, 87), Total(Units.KWH), div100),\r\n            \"Consumed Energy\": (pack_u16(88, 89), Total(Units.KWH), div100),\r\n            \"Feed-in Energy total\": (pack_u16(90, 91), Total(Units.KWH), div100),\r\n            \"Consumed Energy total\": (pack_u16(92, 93), Total(Units.KWH), div100),\r\n```\r\n\r\nThe initial issue might be from reverse engineered API data [here](https://github.com/nazar-pc/solax-local-api-docs/blob/master/Data2.txt#L252) \r\n\r\n```\r\n  FeedInEnergy: read32BitUnsigned(Data[86], Data[87]) / 100,\r\n  ConsumeEnergy: read32BitUnsigned(Data[88], Data[89]) / 100,\r\n```\r\n\r\nThe `total` values are missing in nazar-pc/solax-local-api-docs for Solax X3-Hybrid G4\r\n\r\nDaily reset sensors for feed-in and consumed energy seem to miss `today` postfix that is used by other daily reset sensors like `Battery Charge Energy today` or `EPS Energy today` which adds to confusion.\nAttempt to fix:\r\nhttps://github.com/squishykid/solax/pull/178", "created_at": "2024-11-23T15:28:27Z"}
{"repo": "home-assistant/core", "pull_number": 131351, "instance_id": "home-assistant__core-131351", "issue_numbers": ["128598"], "base_commit": "9db6f0ffc483e7fb3508c04704dc37552127d8b2", "patch": "diff --git a/homeassistant/components/bmw_connected_drive/config_flow.py b/homeassistant/components/bmw_connected_drive/config_flow.py\nindex 409bfdca6f189..8831895c71eff 100644\n--- a/homeassistant/components/bmw_connected_drive/config_flow.py\n+++ b/homeassistant/components/bmw_connected_drive/config_flow.py\n@@ -27,9 +27,18 @@\n from homeassistant.core import HomeAssistant, callback\n from homeassistant.exceptions import HomeAssistantError\n from homeassistant.helpers.selector import SelectSelector, SelectSelectorConfig\n+from homeassistant.util.ssl import get_default_context\n \n from . import DOMAIN\n-from .const import CONF_ALLOWED_REGIONS, CONF_GCID, CONF_READ_ONLY, CONF_REFRESH_TOKEN\n+from .const import (\n+    CONF_ALLOWED_REGIONS,\n+    CONF_CAPTCHA_REGIONS,\n+    CONF_CAPTCHA_TOKEN,\n+    CONF_CAPTCHA_URL,\n+    CONF_GCID,\n+    CONF_READ_ONLY,\n+    CONF_REFRESH_TOKEN,\n+)\n \n DATA_SCHEMA = vol.Schema(\n     {\n@@ -41,7 +50,14 @@\n                 translation_key=\"regions\",\n             )\n         ),\n-    }\n+    },\n+    extra=vol.REMOVE_EXTRA,\n+)\n+CAPTCHA_SCHEMA = vol.Schema(\n+    {\n+        vol.Required(CONF_CAPTCHA_TOKEN): str,\n+    },\n+    extra=vol.REMOVE_EXTRA,\n )\n \n \n@@ -54,6 +70,8 @@ async def validate_input(hass: HomeAssistant, data: dict[str, Any]) -> dict[str,\n         data[CONF_USERNAME],\n         data[CONF_PASSWORD],\n         get_region_from_name(data[CONF_REGION]),\n+        hcaptcha_token=data.get(CONF_CAPTCHA_TOKEN),\n+        verify=get_default_context(),\n     )\n \n     try:\n@@ -79,15 +97,17 @@ class BMWConfigFlow(ConfigFlow, domain=DOMAIN):\n \n     VERSION = 1\n \n+    data: dict[str, Any] = {}\n+\n     _existing_entry_data: Mapping[str, Any] | None = None\n \n     async def async_step_user(\n         self, user_input: dict[str, Any] | None = None\n     ) -> ConfigFlowResult:\n         \"\"\"Handle the initial step.\"\"\"\n-        errors: dict[str, str] = {}\n+        errors: dict[str, str] = self.data.pop(\"errors\", {})\n \n-        if user_input is not None:\n+        if user_input is not None and not errors:\n             unique_id = f\"{user_input[CONF_REGION]}-{user_input[CONF_USERNAME]}\"\n             await self.async_set_unique_id(unique_id)\n \n@@ -96,22 +116,35 @@ async def async_step_user(\n             else:\n                 self._abort_if_unique_id_configured()\n \n+            # Store user input for later use\n+            self.data.update(user_input)\n+\n+            # North America and Rest of World require captcha token\n+            if (\n+                self.data.get(CONF_REGION) in CONF_CAPTCHA_REGIONS\n+                and CONF_CAPTCHA_TOKEN not in self.data\n+            ):\n+                return await self.async_step_captcha()\n+\n             info = None\n             try:\n-                info = await validate_input(self.hass, user_input)\n-                entry_data = {\n-                    **user_input,\n-                    CONF_REFRESH_TOKEN: info.get(CONF_REFRESH_TOKEN),\n-                    CONF_GCID: info.get(CONF_GCID),\n-                }\n+                info = await validate_input(self.hass, self.data)\n             except MissingCaptcha:\n                 errors[\"base\"] = \"missing_captcha\"\n             except CannotConnect:\n                 errors[\"base\"] = \"cannot_connect\"\n             except InvalidAuth:\n                 errors[\"base\"] = \"invalid_auth\"\n+            finally:\n+                self.data.pop(CONF_CAPTCHA_TOKEN, None)\n \n             if info:\n+                entry_data = {\n+                    **self.data,\n+                    CONF_REFRESH_TOKEN: info.get(CONF_REFRESH_TOKEN),\n+                    CONF_GCID: info.get(CONF_GCID),\n+                }\n+\n                 if self.source == SOURCE_REAUTH:\n                     return self.async_update_reload_and_abort(\n                         self._get_reauth_entry(), data=entry_data\n@@ -128,7 +161,7 @@ async def async_step_user(\n \n         schema = self.add_suggested_values_to_schema(\n             DATA_SCHEMA,\n-            self._existing_entry_data,\n+            self._existing_entry_data or self.data,\n         )\n \n         return self.async_show_form(step_id=\"user\", data_schema=schema, errors=errors)\n@@ -147,6 +180,22 @@ async def async_step_reconfigure(\n         self._existing_entry_data = self._get_reconfigure_entry().data\n         return await self.async_step_user()\n \n+    async def async_step_captcha(\n+        self, user_input: dict[str, Any] | None = None\n+    ) -> ConfigFlowResult:\n+        \"\"\"Show captcha form.\"\"\"\n+        if user_input and user_input.get(CONF_CAPTCHA_TOKEN):\n+            self.data[CONF_CAPTCHA_TOKEN] = user_input[CONF_CAPTCHA_TOKEN].strip()\n+            return await self.async_step_user(self.data)\n+\n+        return self.async_show_form(\n+            step_id=\"captcha\",\n+            data_schema=CAPTCHA_SCHEMA,\n+            description_placeholders={\n+                \"captcha_url\": CONF_CAPTCHA_URL.format(region=self.data[CONF_REGION])\n+            },\n+        )\n+\n     @staticmethod\n     @callback\n     def async_get_options_flow(\ndiff --git a/homeassistant/components/bmw_connected_drive/const.py b/homeassistant/components/bmw_connected_drive/const.py\nindex 98d4acbfc91d8..750289e9d0a0d 100644\n--- a/homeassistant/components/bmw_connected_drive/const.py\n+++ b/homeassistant/components/bmw_connected_drive/const.py\n@@ -8,10 +8,15 @@\n ATTR_VIN = \"vin\"\n \n CONF_ALLOWED_REGIONS = [\"china\", \"north_america\", \"rest_of_world\"]\n+CONF_CAPTCHA_REGIONS = [\"north_america\", \"rest_of_world\"]\n CONF_READ_ONLY = \"read_only\"\n CONF_ACCOUNT = \"account\"\n CONF_REFRESH_TOKEN = \"refresh_token\"\n CONF_GCID = \"gcid\"\n+CONF_CAPTCHA_TOKEN = \"captcha_token\"\n+CONF_CAPTCHA_URL = (\n+    \"https://bimmer-connected.readthedocs.io/en/stable/captcha/{region}.html\"\n+)\n \n DATA_HASS_CONFIG = \"hass_config\"\n \ndiff --git a/homeassistant/components/bmw_connected_drive/coordinator.py b/homeassistant/components/bmw_connected_drive/coordinator.py\nindex d38b7ffacc2a7..4f560d16f9cd1 100644\n--- a/homeassistant/components/bmw_connected_drive/coordinator.py\n+++ b/homeassistant/components/bmw_connected_drive/coordinator.py\n@@ -84,11 +84,6 @@ async def _async_update_data(self) -> None:\n \n         if self.account.refresh_token != old_refresh_token:\n             self._update_config_entry_refresh_token(self.account.refresh_token)\n-            _LOGGER.debug(\n-                \"bimmer_connected: refresh token %s > %s\",\n-                old_refresh_token,\n-                self.account.refresh_token,\n-            )\n \n     def _update_config_entry_refresh_token(self, refresh_token: str | None) -> None:\n         \"\"\"Update or delete the refresh_token in the Config Entry.\"\"\"\ndiff --git a/homeassistant/components/bmw_connected_drive/strings.json b/homeassistant/components/bmw_connected_drive/strings.json\nindex 0e7a4a32ef45e..8078971acd170 100644\n--- a/homeassistant/components/bmw_connected_drive/strings.json\n+++ b/homeassistant/components/bmw_connected_drive/strings.json\n@@ -7,6 +7,16 @@\n           \"password\": \"[%key:common::config_flow::data::password%]\",\n           \"region\": \"ConnectedDrive Region\"\n         }\n+      },\n+      \"captcha\": {\n+        \"title\": \"Are you a robot?\",\n+        \"description\": \"A captcha is required for BMW login. Visit the external website to complete the challenge and submit the form. Copy the resulting token into the field below.\\n\\n{captcha_url}\\n\\nNo data will be exposed outside of your Home Assistant instance.\",\n+        \"data\": {\n+          \"captcha_token\": \"Captcha token\"\n+        },\n+        \"data_description\": {\n+          \"captcha_token\": \"One-time token retrieved from the captcha challenge.\"\n+        }\n       }\n     },\n     \"error\": {\n", "test_patch": "diff --git a/tests/components/bmw_connected_drive/__init__.py b/tests/components/bmw_connected_drive/__init__.py\nindex 4d280a1d0e5c8..f490b85474915 100644\n--- a/tests/components/bmw_connected_drive/__init__.py\n+++ b/tests/components/bmw_connected_drive/__init__.py\n@@ -9,6 +9,7 @@\n \n from homeassistant import config_entries\n from homeassistant.components.bmw_connected_drive.const import (\n+    CONF_CAPTCHA_TOKEN,\n     CONF_GCID,\n     CONF_READ_ONLY,\n     CONF_REFRESH_TOKEN,\n@@ -24,8 +25,12 @@\n     CONF_PASSWORD: \"p4ssw0rd\",\n     CONF_REGION: \"rest_of_world\",\n }\n-FIXTURE_REFRESH_TOKEN = \"SOME_REFRESH_TOKEN\"\n-FIXTURE_GCID = \"SOME_GCID\"\n+FIXTURE_CAPTCHA_INPUT = {\n+    CONF_CAPTCHA_TOKEN: \"captcha_token\",\n+}\n+FIXTURE_USER_INPUT_W_CAPTCHA = FIXTURE_USER_INPUT | FIXTURE_CAPTCHA_INPUT\n+FIXTURE_REFRESH_TOKEN = \"another_token_string\"\n+FIXTURE_GCID = \"DUMMY\"\n \n FIXTURE_CONFIG_ENTRY = {\n     \"entry_id\": \"1\",\ndiff --git a/tests/components/bmw_connected_drive/snapshots/test_diagnostics.ambr b/tests/components/bmw_connected_drive/snapshots/test_diagnostics.ambr\nindex 81ef122006976..b87da22a332ee 100644\n--- a/tests/components/bmw_connected_drive/snapshots/test_diagnostics.ambr\n+++ b/tests/components/bmw_connected_drive/snapshots/test_diagnostics.ambr\n@@ -4833,7 +4833,7 @@\n       }),\n     ]),\n     'info': dict({\n-      'gcid': 'SOME_GCID',\n+      'gcid': 'DUMMY',\n       'password': '**REDACTED**',\n       'refresh_token': '**REDACTED**',\n       'region': 'rest_of_world',\n@@ -7202,7 +7202,7 @@\n       }),\n     ]),\n     'info': dict({\n-      'gcid': 'SOME_GCID',\n+      'gcid': 'DUMMY',\n       'password': '**REDACTED**',\n       'refresh_token': '**REDACTED**',\n       'region': 'rest_of_world',\n@@ -8925,7 +8925,7 @@\n       }),\n     ]),\n     'info': dict({\n-      'gcid': 'SOME_GCID',\n+      'gcid': 'DUMMY',\n       'password': '**REDACTED**',\n       'refresh_token': '**REDACTED**',\n       'region': 'rest_of_world',\ndiff --git a/tests/components/bmw_connected_drive/test_config_flow.py b/tests/components/bmw_connected_drive/test_config_flow.py\nindex f57f1a304ac01..8fa9d9be22b64 100644\n--- a/tests/components/bmw_connected_drive/test_config_flow.py\n+++ b/tests/components/bmw_connected_drive/test_config_flow.py\n@@ -4,17 +4,14 @@\n from unittest.mock import patch\n \n from bimmer_connected.api.authentication import MyBMWAuthentication\n-from bimmer_connected.models import (\n-    MyBMWAPIError,\n-    MyBMWAuthError,\n-    MyBMWCaptchaMissingError,\n-)\n+from bimmer_connected.models import MyBMWAPIError, MyBMWAuthError\n from httpx import RequestError\n import pytest\n \n from homeassistant import config_entries\n from homeassistant.components.bmw_connected_drive.config_flow import DOMAIN\n from homeassistant.components.bmw_connected_drive.const import (\n+    CONF_CAPTCHA_TOKEN,\n     CONF_READ_ONLY,\n     CONF_REFRESH_TOKEN,\n )\n@@ -23,10 +20,12 @@\n from homeassistant.data_entry_flow import FlowResultType\n \n from . import (\n+    FIXTURE_CAPTCHA_INPUT,\n     FIXTURE_CONFIG_ENTRY,\n     FIXTURE_GCID,\n     FIXTURE_REFRESH_TOKEN,\n     FIXTURE_USER_INPUT,\n+    FIXTURE_USER_INPUT_W_CAPTCHA,\n )\n \n from tests.common import MockConfigEntry\n@@ -61,7 +60,7 @@ async def test_authentication_error(hass: HomeAssistant) -> None:\n         result = await hass.config_entries.flow.async_init(\n             DOMAIN,\n             context={\"source\": config_entries.SOURCE_USER},\n-            data=FIXTURE_USER_INPUT,\n+            data=deepcopy(FIXTURE_USER_INPUT_W_CAPTCHA),\n         )\n \n     assert result[\"type\"] is FlowResultType.FORM\n@@ -79,7 +78,7 @@ async def test_connection_error(hass: HomeAssistant) -> None:\n         result = await hass.config_entries.flow.async_init(\n             DOMAIN,\n             context={\"source\": config_entries.SOURCE_USER},\n-            data=FIXTURE_USER_INPUT,\n+            data=deepcopy(FIXTURE_USER_INPUT_W_CAPTCHA),\n         )\n \n     assert result[\"type\"] is FlowResultType.FORM\n@@ -97,7 +96,7 @@ async def test_api_error(hass: HomeAssistant) -> None:\n         result = await hass.config_entries.flow.async_init(\n             DOMAIN,\n             context={\"source\": config_entries.SOURCE_USER},\n-            data=deepcopy(FIXTURE_USER_INPUT),\n+            data=deepcopy(FIXTURE_USER_INPUT_W_CAPTCHA),\n         )\n \n     assert result[\"type\"] is FlowResultType.FORM\n@@ -105,6 +104,28 @@ async def test_api_error(hass: HomeAssistant) -> None:\n     assert result[\"errors\"] == {\"base\": \"cannot_connect\"}\n \n \n+@pytest.mark.usefixtures(\"bmw_fixture\")\n+async def test_captcha_flow_missing_error(hass: HomeAssistant) -> None:\n+    \"\"\"Test the external flow with captcha failing once and succeeding the second time.\"\"\"\n+\n+    result = await hass.config_entries.flow.async_init(\n+        DOMAIN,\n+        context={\"source\": config_entries.SOURCE_USER},\n+        data=deepcopy(FIXTURE_USER_INPUT),\n+    )\n+\n+    assert result[\"type\"] is FlowResultType.FORM\n+    assert result[\"step_id\"] == \"captcha\"\n+\n+    result = await hass.config_entries.flow.async_configure(\n+        result[\"flow_id\"], {CONF_CAPTCHA_TOKEN: \" \"}\n+    )\n+\n+    assert result[\"type\"] is FlowResultType.FORM\n+    assert result[\"step_id\"] == \"user\"\n+    assert result[\"errors\"] == {\"base\": \"missing_captcha\"}\n+\n+\n async def test_full_user_flow_implementation(hass: HomeAssistant) -> None:\n     \"\"\"Test registering an integration and finishing flow works.\"\"\"\n     with (\n@@ -118,14 +139,22 @@ async def test_full_user_flow_implementation(hass: HomeAssistant) -> None:\n             return_value=True,\n         ) as mock_setup_entry,\n     ):\n-        result2 = await hass.config_entries.flow.async_init(\n+        result = await hass.config_entries.flow.async_init(\n             DOMAIN,\n             context={\"source\": config_entries.SOURCE_USER},\n             data=deepcopy(FIXTURE_USER_INPUT),\n         )\n-        assert result2[\"type\"] is FlowResultType.CREATE_ENTRY\n-        assert result2[\"title\"] == FIXTURE_COMPLETE_ENTRY[CONF_USERNAME]\n-        assert result2[\"data\"] == FIXTURE_COMPLETE_ENTRY\n+\n+        assert result[\"type\"] is FlowResultType.FORM\n+        assert result[\"step_id\"] == \"captcha\"\n+\n+        result = await hass.config_entries.flow.async_configure(\n+            result[\"flow_id\"], FIXTURE_CAPTCHA_INPUT\n+        )\n+\n+        assert result[\"type\"] is FlowResultType.CREATE_ENTRY\n+        assert result[\"title\"] == FIXTURE_COMPLETE_ENTRY[CONF_USERNAME]\n+        assert result[\"data\"] == FIXTURE_COMPLETE_ENTRY\n \n         assert len(mock_setup_entry.mock_calls) == 1\n \n@@ -206,13 +235,20 @@ async def test_reauth(hass: HomeAssistant) -> None:\n         assert suggested_values[CONF_PASSWORD] == wrong_password\n         assert suggested_values[CONF_REGION] == FIXTURE_USER_INPUT[CONF_REGION]\n \n-        result2 = await hass.config_entries.flow.async_configure(\n-            result[\"flow_id\"], FIXTURE_USER_INPUT\n+        result = await hass.config_entries.flow.async_configure(\n+            result[\"flow_id\"], deepcopy(FIXTURE_USER_INPUT)\n         )\n         await hass.async_block_till_done()\n \n-        assert result2[\"type\"] is FlowResultType.ABORT\n-        assert result2[\"reason\"] == \"reauth_successful\"\n+        assert result[\"type\"] is FlowResultType.FORM\n+        assert result[\"step_id\"] == \"captcha\"\n+\n+        result = await hass.config_entries.flow.async_configure(\n+            result[\"flow_id\"], FIXTURE_CAPTCHA_INPUT\n+        )\n+\n+        assert result[\"type\"] is FlowResultType.ABORT\n+        assert result[\"reason\"] == \"reauth_successful\"\n         assert config_entry.data == FIXTURE_COMPLETE_ENTRY\n \n         assert len(mock_setup_entry.mock_calls) == 2\n@@ -243,13 +279,13 @@ async def test_reauth_unique_id_abort(hass: HomeAssistant) -> None:\n         assert result[\"step_id\"] == \"user\"\n         assert result[\"errors\"] == {}\n \n-        result2 = await hass.config_entries.flow.async_configure(\n+        result = await hass.config_entries.flow.async_configure(\n             result[\"flow_id\"], {**FIXTURE_USER_INPUT, CONF_REGION: \"north_america\"}\n         )\n         await hass.async_block_till_done()\n \n-        assert result2[\"type\"] is FlowResultType.ABORT\n-        assert result2[\"reason\"] == \"account_mismatch\"\n+        assert result[\"type\"] is FlowResultType.ABORT\n+        assert result[\"reason\"] == \"account_mismatch\"\n         assert config_entry.data == config_entry_with_wrong_password[\"data\"]\n \n \n@@ -279,13 +315,20 @@ async def test_reconfigure(hass: HomeAssistant) -> None:\n         assert suggested_values[CONF_PASSWORD] == FIXTURE_USER_INPUT[CONF_PASSWORD]\n         assert suggested_values[CONF_REGION] == FIXTURE_USER_INPUT[CONF_REGION]\n \n-        result2 = await hass.config_entries.flow.async_configure(\n+        result = await hass.config_entries.flow.async_configure(\n             result[\"flow_id\"], FIXTURE_USER_INPUT\n         )\n         await hass.async_block_till_done()\n \n-        assert result2[\"type\"] is FlowResultType.ABORT\n-        assert result2[\"reason\"] == \"reconfigure_successful\"\n+        assert result[\"type\"] is FlowResultType.FORM\n+        assert result[\"step_id\"] == \"captcha\"\n+\n+        result = await hass.config_entries.flow.async_configure(\n+            result[\"flow_id\"], FIXTURE_CAPTCHA_INPUT\n+        )\n+\n+        assert result[\"type\"] is FlowResultType.ABORT\n+        assert result[\"reason\"] == \"reconfigure_successful\"\n         assert config_entry.data == FIXTURE_COMPLETE_ENTRY\n \n \n@@ -307,40 +350,12 @@ async def test_reconfigure_unique_id_abort(hass: HomeAssistant) -> None:\n         assert result[\"step_id\"] == \"user\"\n         assert result[\"errors\"] == {}\n \n-        result2 = await hass.config_entries.flow.async_configure(\n+        result = await hass.config_entries.flow.async_configure(\n             result[\"flow_id\"],\n             {**FIXTURE_USER_INPUT, CONF_USERNAME: \"somebody@email.com\"},\n         )\n         await hass.async_block_till_done()\n \n-        assert result2[\"type\"] is FlowResultType.ABORT\n-        assert result2[\"reason\"] == \"account_mismatch\"\n+        assert result[\"type\"] is FlowResultType.ABORT\n+        assert result[\"reason\"] == \"account_mismatch\"\n         assert config_entry.data == FIXTURE_COMPLETE_ENTRY\n-\n-\n-@pytest.mark.usefixtures(\"bmw_fixture\")\n-async def test_captcha_flow_not_set(hass: HomeAssistant) -> None:\n-    \"\"\"Test the external flow with captcha failing once and succeeding the second time.\"\"\"\n-\n-    TEST_REGION = \"north_america\"\n-\n-    # Start flow and open form\n-    # Start flow and open form\n-    result = await hass.config_entries.flow.async_init(\n-        DOMAIN, context={\"source\": config_entries.SOURCE_USER}\n-    )\n-    assert result[\"type\"] is FlowResultType.FORM\n-    assert result[\"step_id\"] == \"user\"\n-\n-    # Add login data\n-    with patch(\n-        \"bimmer_connected.api.authentication.MyBMWAuthentication._login_row_na\",\n-        side_effect=MyBMWCaptchaMissingError(\n-            \"Missing hCaptcha token for North America login\"\n-        ),\n-    ):\n-        result = await hass.config_entries.flow.async_configure(\n-            result[\"flow_id\"],\n-            user_input={**FIXTURE_USER_INPUT, CONF_REGION: TEST_REGION},\n-        )\n-        assert result[\"errors\"][\"base\"] == \"missing_captcha\"\n", "problem_statement": "BMW login failure\n### The problem\n\nI am attempting to setup the integration first time. I have tried multiple times over the last couple days but I am getting authentication failed error. \r\n\r\nI have the MyBMW App working, as well as I can see my car on the bmw connected website just fine. I have change my password to ensure it's up to date but no luck. I tried using all regions as well, but none of them worked. I'm from Canada, and so is my account and car registered to Canadian region. \r\n\r\nI have noticed in the log that the URL the authentication module is using, doesnt seem to exist (404) based on the logs. \n\n### What version of Home Assistant Core has the issue?\n\n20241002.3\n\n### What was the last working version of Home Assistant Core?\n\n_No response_\n\n### What type of installation are you running?\n\nHome Assistant Container\n\n### Integration causing the issue\n\nBMW Connected Drive\n\n### Link to integration documentation on our website\n\nhttps://www.home-assistant.io/integrations/bmw_connected_drive/\n\n### Diagnostics information\n\n_No response_\n\n### Example YAML snippet\n\n_No response_\n\n### Anything in the logs that might be useful for us?\n\n```txt\n2024-10-16 11:34:26.634 WARNING (MainThread) [homeassistant.util.loop] Detected blocking call to load_verify_locations with args (<ssl.SSLContext object at 0x1480b727f150>,) inside the event loop by integration 'bmw_connected_drive' at homeassistant/components/bmw_connected_drive/config_flow.py, line 54: await auth.login() (offender: /usr/local/lib/python3.12/site-packages/httpx/_config.py, line 149: context.load_verify_locations(cafile=cafile)), please create a bug report at https://github.com/home-assistant/core/issues?q=is%3Aopen+is%3Aissue+label%3A%22integration%3A+bmw_connected_drive%22\r\nFile \"/usr/src/homeassistant/homeassistant/components/bmw_connected_drive/config_flow.py\", line 91, in async_step_user\r\nFile \"/usr/src/homeassistant/homeassistant/components/bmw_connected_drive/config_flow.py\", line 54, in validate_input\r\n2024-10-16 11:34:27.689 ERROR (MainThread) [bimmer_connected.api.authentication] MyBMWAuthError due to HTTPStatusError: { \"statusCode\": 404, \"message\": \"Resource not found\" }\r\n2024-10-16 11:34:30.749 ERROR (MainThread) [bimmer_connected.api.authentication] MyBMWAuthError due to HTTPStatusError: invalid_client - Client authentication failed (e.g., login failure, unknown client, no client authentication included or unsupported authentication method)\r\n2024-10-16 11:34:34.556 ERROR (MainThread) [bimmer_connected.api.authentication] MyBMWAuthError due to HTTPStatusError: invalid_client - Client authentication failed (e.g., login failure, unknown client, no client authentication included or unsupported authentication method)\n```\n\n\n### Additional information\n\n_No response_\n", "hints_text": "\nHey there @gerard33, @rikroe, mind taking a look at this issue as it has been labeled with an integration (`bmw_connected_drive`) you are listed as a [code owner](https://github.com/home-assistant/core/blob/dev/CODEOWNERS#L211) for? Thanks!\n\n<details>\n<summary>Code owner commands</summary>\n\n\nCode owners of `bmw_connected_drive` can trigger bot actions by commenting:\n\n- `@home-assistant close` Closes the issue.\n- `@home-assistant rename Awesome new title` Renames the issue.\n- `@home-assistant reopen` Reopen the issue.\n- `@home-assistant unassign bmw_connected_drive` Removes the current integration label and assignees on the issue, add the integration domain after the command.\n- `@home-assistant add-label needs-more-information` Add a label (needs-more-information, problem in dependency, problem in custom component) to the issue.\n- `@home-assistant remove-label needs-more-information` Remove a label (needs-more-information, problem in dependency, problem in custom component) on the issue.\n\n</details>\n\n\n<sub><sup>(message by CodeOwnersMention)</sup></sub>\n\n---\n\n[bmw_connected_drive documentation](https://www.home-assistant.io/integrations/bmw_connected_drive)\n[bmw_connected_drive source](https://github.com/home-assistant/core/tree/dev/homeassistant/components/bmw_connected_drive)\n<sub><sup>(message by IssueLinks)</sup></sub>\nI got this Error:\r\n\r\nLogger: bimmer_connected.api.authentication\r\nSource: components/bmw_connected_drive/config_flow.py:54\r\nFirst occurred: October 17, 2024 at 11:06:25 PM (3 occurrences)\r\nLast logged: October 17, 2024 at 11:07:00 PM\r\nMyBMWAuthError due to HTTPStatusError: invalid_client - Client authentication failed (e.g., login failure, unknown client, no client authentication included or unsupported authentication method)\r\n\r\nIt's the same Problem ?\nIt seems there are some issues.\r\n\r\nI will check for more details over the weekend. \nI think I'm getting the same issue.  I thought I'd broken something restoring backup of HA to new rasp pi, but it was coincidence, seeing same thing as Meli73 above . . .\r\n\r\n```\r\nLogger: bimmer_connected.api.authentication\r\nSource: components/bmw_connected_drive/config_flow.py:54\r\nFirst occurred: October 18, 2024 at 1:10:40 PM (4 occurrences)\r\nLast logged: 10:59:51 AM\r\n\r\nMyBMWAuthError due to HTTPStatusError: invalid_client - Client authentication failed (e.g., login failure, unknown client, no client authentication included or unsupported authentication method)\r\n```\r\n\r\nNorth America, HA Core: 2024.10.3\nSame issue here. Restored a back-up and now I can't login!\nI am having same issue - this might be related?\r\n\r\nhttps://g05.bimmerpost.com/forums/showthread.php?p=31550355  \nI was only able to confirm that currently authentication to North America is not possible.\r\nRest of world still seems fine.\r\n\r\nUnfortunately, I won't have the chance to look into it until next week (traveling). \n@home-assistant rename BMW North America unable to login\nI got the same with the log saying: MyBMWAuthError due to HTTPStatusError: invalid_client - Client authentication failed (e.g., login failure, unknown client, no client authentication included or unsupported authentication method)\nSame issue here\nSame issue. I had to restore a previous verstion of Homeassistant. Since then i lost the authentication. I removed the app and reinstalled. The issue continues in Homeassistant while logged into the Mini Connected app in NA\nI\u2019m having the same issue after it working for a long time.  It looks like MyBWM login is using a form of captcha now and it looks like the error might be from the login looking for a validation form that isn\u2019t there.  \nAs @bradarussell just mentioned, BMW have started using **hCaptcha** to protect their logins. Even if it doesn't show during login in the app, a captcha check is done in the background.\r\n\r\nIt seems that when no valid captcha token is preset, the login will be denied.\r\n\r\nFrom a very quick check I have no immediate idea how to solve this (except using external captcha solver services which cost money).\nSame issue here in north america. How much would the external captcha services cost?\nIt would be interesting to know if this was the first integration using cloud services to run into this problem. If not, it would be informative to learn if or how it was solved for another integration. I hope the answer is _not_ that the PTBs at hassio get all squeamish about captchas\nThere is no Captcha on the app or in the browser for the BMW Connected app.\r\n\r\nAt least I could not find something. The login in NA still fails, even after password change\r\n\r\n \r\n\r\n \r\n\r\nFrom: nilen98 ***@***.***> \r\nSent: Tuesday, October 29, 2024 10:52 AM\r\nTo: home-assistant/core ***@***.***>\r\nCc: joe-colorado ***@***.***>; Comment ***@***.***>\r\nSubject: Re: [home-assistant/core] BMW North America unable to login (Issue #128598)\r\n\r\n \r\n\r\nSame issue here in north america. How much would the external captcha services cost?\r\n\r\n\u2014\r\nReply to this email directly, view it on GitHub <https://github.com/home-assistant/core/issues/128598#issuecomment-2444834555> , or unsubscribe <https://github.com/notifications/unsubscribe-auth/AOOJBIEWRIYGZMLBDJYT6ETZ564MJAVCNFSM6AAAAABQEFIDVSVHI2DSMVQWIX3LMV43OSLTON2WKQ3PNVWWK3TUHMZDINBUHAZTINJVGU> .\r\nYou are receiving this because you commented.  <https://github.com/notifications/beacon/AOOJBIBQKLW22PAAP576KCTZ564MJA5CNFSM6AAAAABQEFIDVSWGG33NNVSW45C7OR4XAZNMJFZXG5LFINXW23LFNZ2KUY3PNVWWK3TUL5UWJTURXE3PW.gif> Message ID: ***@***.*** ***@***.***> >\r\n\r\n\nYeah when I log in on the app for myself or on the bmw website, I don't have any captchas currently\nActually just relogged into the bmw app, I have a captcha now so that theory is correct. On the website I have no captcha when I logged in the past few times this weekend but the app does. maybe the integration (if we want to avoid the captcha issues) has to be recoded as a web browser type of login instead of mimicking the app? Not sure - just theorizing \nFrom what I understand, it's mostly heuristic based. I doubt they throw up an actual captcha unless they absolutely have to.\r\n\r\nI wonder if instead of a login, the integration could ask for the auth token instead. While less user-friendly, at least someone could log in with a browser and then grab it out of local storage, or wherever they keep it. That would be more secure as well.\nThats not a bad idea, I've seen a homebridge integration for nest thermostats work that work and its not too difficult using the chrome developer tools. Under the \"using a google account\" section could be mimicked for this https://github.com/chrisjshull/homebridge-nest\r\n\nI will try using the web access token later.\r\nHowever from just looking at the oauth scopes, the app has much more scopes requested than the web page. \nSame issue here :(\nSame issue for `REST_OF_WORLD ` over here on multiple accounts. \nSome news: \r\n- I didn't have the issue on REST_OF_WORLD (yet)\r\n- I wasn't able to extract the token using the web flow, as this one directly creates a Cookie instead of a token\r\n- Using a dummy HTML site I seem to be able to get the required hcaptcha token that then can be used for login (yay!)\r\n- Still need to figure out a way to include this in Home Assistant\nThank you for your effort to figure this out\r\n\r\n \r\n\r\nFrom: Richard Kroegel ***@***.***> \r\nSent: Wednesday, October 30, 2024 1:49 PM\r\nTo: home-assistant/core ***@***.***>\r\nCc: joe-colorado ***@***.***>; Comment ***@***.***>\r\nSubject: Re: [home-assistant/core] BMW North America unable to login (Issue #128598)\r\n\r\n \r\n\r\nSome news:\r\n\r\n*        I didn't have the issue on REST_OF_WORLD (yet)\r\n\r\n*        Using a dummy HTML site I seem to be able to get the required hcaptcha token that then can be used for login (yay!)\r\n\r\n*        Still need to figure out a way to include this in Home Assistant\r\n\r\n\u2014\r\nReply to this email directly, view it on GitHub <https://github.com/home-assistant/core/issues/128598#issuecomment-2448226419> , or unsubscribe <https://github.com/notifications/unsubscribe-auth/AOOJBIDBZJBXTLDX2W5UQTDZ6EZ37AVCNFSM6AAAAABQEFIDVSVHI2DSMVQWIX3LMV43OSLTON2WKQ3PNVWWK3TUHMZDINBYGIZDMNBRHE> .\r\nYou are receiving this because you commented.  <https://github.com/notifications/beacon/AOOJBICADDZXENENH63F7KDZ6EZ37A5CNFSM6AAAAABQEFIDVSWGG33NNVSW45C7OR4XAZNMJFZXG5LFINXW23LFNZ2KUY3PNVWWK3TUL5UWJTUR5T4HG.gif> Message ID: ***@***.*** ***@***.***> >\r\n\r\n\nsame issue here, hope someone able to fix it soon.\nYeah I do want to say thank you to @rikroe and anyone else who helped with this integration, its honestly my favorite in Home assistant\nI still cannot log in to this application from Canada. I see that the issue seems to be resolved, but I don't know how to fix this problem in my system. Could someone please explain to me how to do this?\r\n\r\n![Screenshot 2024-11-07 151339](https://github.com/user-attachments/assets/219c30ac-6ea7-41f6-88be-28fa6db7a87c)\r\n\nI seen this as resolved, will we have to wait for 11.1 release for implementation?\nOnly the issue in the library itself is resolved. For Home Assistant, it's required that #129667 gets merged as well.\r\n\n> I seen this as resolved, will we have to wait for 11.1 release for implementation?\r\n\r\nI have installed the latest version 2024.11.1 and I'm still seeing the same autthentication issues.\r\n\r\n<img width=\"605\" alt=\"Screenshot 2024-11-08 at 4 22 17\u202fPM\" src=\"https://github.com/user-attachments/assets/a0143d7a-6dee-400d-a89a-5ec6fbe18619\">\r\n\r\n<img width=\"401\" alt=\"Screenshot 2024-11-08 at 4 23 00\u202fPM\" src=\"https://github.com/user-attachments/assets/bb96a1c0-008f-4d56-b723-5191a29f01f2\">\r\n\r\n<img width=\"403\" alt=\"Screenshot 2024-11-08 at 4 23 19\u202fPM\" src=\"https://github.com/user-attachments/assets/1278937a-4ce1-40d5-96ca-f4c6755377f4\">\r\n\r\n\r\n\n> I have installed the latest version 2024.11.1 and I'm still seeing the same autthentication issues.\r\n\r\nWhen I checked just now, the merge request cited in @rikroe's post just before yours looks like it's still under review, so I wouldn't expect to see the fix for at least one more dot version of HA.\nDo we know who has to review in order to get it in the next release?\n> Do we know who has to review in order to get it in the next release?\r\n\r\nIn the HomeAssistant core PR (where you're @ mentioned, BTW) the review is waiting for a review by @frenck who has been assigned by @frenck to review it. I'd guess he's either really busy or maybe a Mercedes-Benz guy. Ironic smiley face\r\n\n@frenck - how often do you review merge requests?\n@S10XtremeNLow Not sure how to answer your question, as it is an odd quantifier. I review probably around 150-250 PRs a week. But not sure how that matter to this issue.\n> @S10XtremeNLow Not sure how to answer your question, as it is an odd quantifier. I review probably around 150-250 PRs a week. But not sure how that matter to this issue.\r\n\r\nGood point. I guess I was trying to gauge when you thought you may be able to review the merge request and we could anticipate when it would be part of the next version release. \r\n\r\nHowever, your last comment makes me think the merge request is missing something to proceed to next step. Granted I\u2019m not familiar with the process, does a @rikroe need anything else or just waiting for your review?\r\n\r\ndisregard, saw your most recent reply. Thanks for the clarification. \r\n\n> > Do we know who has to review in order to get it in the next release?\r\n> \r\n> In the HomeAssistant core PR (where you're @ mentioned, BTW) the review is waiting for a review by @frenck who has been assigned by @frenck to review it. I'd guess he's either really busy or maybe a Mercedes-Benz guy. Ironic smiley face\r\n\r\nI actually drive a Peugeot \ud83d\ude09 \r\n\r\nAnyway, that PR needs core review/discussion, as the PR does include external javascript into the Home Assistant frontend. I want to validate that with the core team in the next architectural meeting later this week.\r\n\r\nThis has been discussed on the discussion on Discord on this PR and with Richard directly in DM as well.\r\n\r\n../Frenck\n@home-assistant rename BMW login failure\nAs per https://github.com/bimmerconnected/bimmer_connected/issues/671 (and verified myself), BMW now enforces a captcha for rest_of_world as well.\r\n\r\nThe same functionality of #129667 (with one changed variable) would be applicable as well (verified working in a quick-and-dirty test).\nYes, its been a problem in ROW (from Australia) for a day or two.\r\n![image](https://github.com/user-attachments/assets/58e70382-bb40-446c-b62c-a20e750c11d4)\r\n(core 2024.10.3)\nHaving the same problem in Europe (ROW). Core 2024.11.2.\nSame problem in Europe/Austria (ROW). Core 2024.11.2.\nI am glad its not just me.  Subbing to thread.\nSame for me in the uk , watching progress with interest\nCurrently in low earth orbit. Issue confirmed up here, too.\r\n\r\n\r\nOn Tue, Nov 19, 2024 at 5:06\u202fPM groove200 ***@***.***> wrote:\r\n\r\n> Same for me in the uk , watching progress with interest\r\n>\r\n> \u2014\r\n> Reply to this email directly, view it on GitHub\r\n> <https://github.com/home-assistant/core/issues/128598#issuecomment-2486930026>,\r\n> or unsubscribe\r\n> <https://github.com/notifications/unsubscribe-auth/AAXOGX7LGHFRNGCVSCVJ4A32BO77ZAVCNFSM6AAAAABQEFIDVSVHI2DSMVQWIX3LMV43OSLTON2WKQ3PNVWWK3TUHMZDIOBWHEZTAMBSGY>\r\n> .\r\n> You are receiving this because you are subscribed to this thread.Message\r\n> ID: ***@***.***>\r\n>\r\n\nSame issue!\r\nAfter installing a backup (from a few days ago) I cannot reauthorize the integration. So I deleted it and tried it again.\r\nNo chance, I got an error \"Invalid authentication\".\r\nI am located in Austria, rest of the world. No captcha needed to login with app or browser.\nJust as a hint. In ioBroker the adapter was modified and integrates the captcha. See:\r\n\r\n![BMW ConnDrive iobroker](https://github.com/user-attachments/assets/a67e60d2-404e-4a67-a18b-d0c0d5429cea)\r\n\nSame here, thought was because I've just changed cars, and was in a loop as removed old one from account, and added new one. But seems to be a larger issue from the looks (Europe region, so ROW)\nSame problem in Europe.\njust stopped working for me. ReAuth not possible. \n\r\n![IMG_9291](https://github.com/user-attachments/assets/c6be8545-08c0-4c8a-a584-d09061b4a612)\r\nAnd here in Europe. \nSame problem in Europe.\nI confirm, it's broken in Europe since 2 hours ago.\r\nNote that I had to login again on myBMW app 2 days ago, so it's likely something changed.\nSame problem over here since this afternoon. \nYes, the problem exists for all regions.\r\nRight now it is up to the HA Core team to decide if and how we can implement a fix (see https://github.com/home-assistant/core/issues/128598#issuecomment-2482874087). \nSame problem since today (Germany)\nsame problem since today, Belgium\nSame here, Denmark (ROW)\r\n\r\nLogger: bimmer_connected.api.authentication\r\nSource: components/bmw_connected_drive/config_flow.py:60\r\nFirst occurred: 18:06:32 (3 occurrences)\r\nLast logged: 20:42:07\r\n\r\nMyBMWAuthError due to HTTPStatusError: invalid_client - Client authentication failed (e.g., login failure, unknown client, no client authentication included or unsupported authentication method)\n**Please do not spam the thread with comments like \"same here\".**\r\n\r\nIf you want to follow the thread and let know if the problem affects you, please click the thumbs up button in the open post.\nI note the MyBMW App required me to login again today, the first time in many months and I use the App every day. So I conclude BMW changed something. A Mini on the same account does not work either. Both working yesterday.\nHas anybody of the maintainer looked at the comment \r\nhttps://github.com/home-assistant/core/issues/128598#issuecomment-2487988685\r\nIf its solved in an iobroker adapter you can get some ideas from there. Maybe they have deaper knowledge about the BMW API, while the core developer are located in Germany.  \n> Has anybody of the maintainer looked at the comment [#128598 (comment)](https://github.com/home-assistant/core/issues/128598#issuecomment-2487988685) If its solved in an iobroker adapter you can get some ideas from there. Maybe they have deaper knowledge about the BMW API, while the core developer are located in Germany.\r\n\r\nThere is already a PR made for North America with the same solution as iobroker has --> https://github.com/home-assistant/core/pull/129667\r\nThat PR is on the agenda of the HA core teams architectural meeting --> https://github.com/home-assistant/core/issues/128598#issuecomment-2482874087\nSomething is happening, as I get \"already in progress\" response now if I try add the integration\r\n\r\nOn Wed, 20 Nov 2024, 20:26 Gerard, ***@***.***> wrote:\r\n\r\n> Has anybody of the maintainer looked at the comment #128598 (comment)\r\n> <https://github.com/home-assistant/core/issues/128598#issuecomment-2487988685>\r\n> If its solved in an iobroker adapter you can get some ideas from there.\r\n> Maybe they have deaper knowledge about the BMW API, while the core\r\n> developer are located in Germany.\r\n>\r\n> There is already a PR made for North America with the same solution as\r\n> iobroker has --> #129667\r\n> <https://github.com/home-assistant/core/pull/129667>\r\n> That PR is on the agenda of the HA core teams architectural meeting --> #128598\r\n> (comment)\r\n> <https://github.com/home-assistant/core/issues/128598#issuecomment-2482874087>\r\n>\r\n> \u2014\r\n> Reply to this email directly, view it on GitHub\r\n> <https://github.com/home-assistant/core/issues/128598#issuecomment-2489481281>,\r\n> or unsubscribe\r\n> <https://github.com/notifications/unsubscribe-auth/AAJLZ55UHYJVTGQLE2OUYPD2BTWBDAVCNFSM6AAAAABQEFIDVSVHI2DSMVQWIX3LMV43OSLTON2WKQ3PNVWWK3TUHMZDIOBZGQ4DCMRYGE>\r\n> .\r\n> You are receiving this because you commented.Message ID:\r\n> ***@***.***>\r\n>\r\n\nNothing New in Italy Autenticazione non valida\nNot working also for me since yesterday for \u201crest of the world\u201d after a migration and restore from backup. Version 2024.11.2.\r\nIs working fine both in app and browser \r\n\r\n`MyBMWAuthError due to HTTPStatusError: invalid_client - Client authentication failed (e.g., login failure, unknown client, no client authentication included or unsupported authentication method)\r\nMyBMWAuthError due to HTTPStatusError: { \"statusCode\": 404, \"message\": \"Resource not found\" } `\nWeird thing is that I do have the issue in my BMW integration for my BMW 530e. (since yesterday) \r\nI do not have this issue (same integration) for our Mini (yet). \r\nRegion = Europe.  When using the App I do not have any issues and I also do not see the Captcha to log in.\r\n\r\nIf this post is not seen as valuable info, it can be deleted.  Sorry for the waste if this is the case.\nThe issue appeared here after I used the integration to set the charging limit multiple times at 10 min intervals (depending on solar panels production). So it might be related to how much commands you issue too.\nUnlikely this issue is caused by an API call limit.  In my experience, call limiters are reset on a e.g. daily basis.\r\nHere the authentication doesn't work once it needs to be renewed.\n> Unlikely this issue is caused by an API call limit. In my experience, call limiters are reset on a e.g. daily basis. Here the authentication doesn't work once it needs to be renewed.\r\n\r\nWhat I mean is that the captcha could appear earlier if you issue more commands. That would explain why some people are still able to login and others not.\r\nSo, it could be <10 day -> no captcha. between 10 and 100 -> captcha, over 100 -> block. (the figures are random, just for illustration)\n`2024-11-21 11:13:36.419 ERROR (MainThread) [bimmer_connected.api.authentication] MyBMWAuthError due to HTTPStatusError: invalid_client - Client authentication failed (e.g., login failure, unknown client, no client authentication included or unsupported authentication method)`\r\n\r\nCould `invalid_client` be part of the issue or is it just a generic message?\r\n\nI have the same error on both my Homeassistand and Homey.  Different platforms, same error message.  \r\nMy BMW app is working just fine.  BMW G31 530e, produced in June 2023.\nCan confirm issue:\r\n\r\n`MyBMWAuthError due to HTTPStatusError: invalid_client - Client authentication failed (e.g., login failure, unknown client, no client authentication included or unsupported authentication method)`\r\n\r\nSee also: https://github.com/evcc-io/evcc/issues/17332\nSame here in Belgium\r\n\r\nBut I also received this email from Engie, my electricity provider , my car is also connected in their app for the smart charging, it says to not disconnected my car in the app. If i disconnect it, i'll not be able to reconnect it again and they 're working with BMW to find a solution\r\n\r\nSo i think many services are impacted by the last change at bmw side\r\n![Capture d\u2019e\u0301cran 2024-11-21 a\u0300 12 34 12](https://github.com/user-attachments/assets/30283e37-4888-465d-82a5-e1e094f918e3)\r\n\nJust for Info: iobroker works just fine with BMW Adapter 2.8.3. The adapter requests a captcha during the set-up process and then everything runs as smooth as silk\u2026\nSame issue here. Region = Europe. Removed and readded integration. Still giving Invalid Authenticating. Able to log into BMW Connected Drive website without issue. Issue started 20 hours ago.\n> Same here in Belgium\r\n> \r\n> But I also received this email from Engie, my electricity provider , my car is also connected in their app for the smart charging, it says to not disconnected my car in the app. If i disconnect it, i'll not be able to reconnect it again and they 're working with BMW to find a solution\r\n\r\nThe question is if BMW didn't see that services were going to break or if they did it on purpose to get third party services to register their IPs with them? I am curious to know how Engie (and others) will solve this.\n> Same issue here. Region = Europe. Removed and readded integration. Still giving Invalid Authenticating. Able to log into BMW Connected Drive website without issue. Issue started 20 hours ago.\r\n\r\nSame issue for me\n@renaudallard I have raised a Support Request with BMW via their Customer Service Portal, explained the impact of their change and requested that they revert the change and open their API for third-party services more. Let's see if and how they respond.\nSame here, both my BMWs are disconnected since about 20 hours with an error that the authentication has expired: \"Authentifizierung f\u00fcr <email_address> abgelaufen\" (authentication for <email_address> expired). \r\nDomain: Rest of World (living in Europe)\r\nTrying to reconnect/authenticate results in an error: \"Ung\u00fcltige Authentifizierung\" (\"invalid authentication\").\r\nLogging into my Connected Drive Account via browser is however always working using the same credentials.\nSame here\r\n\r\n2024-11-21 19:22:18.640 ERROR (MainThread) [bimmer_connected.api.authentication] MyBMWAuthError due to HTTPStatusError: invalid_client - Client authentication failed (e.g., login failure, unknown client, no client authentication included or unsupported authentication method)\n## \ud83e\udd1a I have the same issue! \ud83d\udc47 Read below\r\n\r\nHi there! Sorry to read you are experiencing the same issue as more people here. Nobody likes having issues \ud83d\ude1e\r\n\r\nFinding an issue on a GitHub issue tracker that matches your problem is kinda nice: At least you know you are not alone. So, let's leave a commit with: \"Yeah, I have the same issue\", or \"+1!!!\". \ud83d\udeab **No!**\r\n\r\n### Please do not create \"I have the same issue\" comments!\r\n\r\nNot just this issue or this project, but anywhere on GitHub or any issue tracker on the internet even. It doesn't add to triaging the issue. It only generates noise when reading / triaging the case. \r\n\r\n### What to do instead?\r\n\r\nInstead, go to the top of the issue, and add a \ud83d\udc4d emoji reaction. That way, we can still see that you (and how many others) experience this issue while keeping the issue threads nice and clean.\r\n\r\nThanks! \u2764\ufe0f\r\n\r\n../Frenck\nI think at this stage everyone knows there's an issue and any further confirmation is futile!\nWhat an inappropriate reply!\r\nVon meinem iPhone gesendet\r\n\r\nAm 21.11.2024 um 20:00 schrieb G6EJD ***@***.***>:\r\n\r\n\ufeff\r\n\r\nI think at this stage everyone knows there's an issue and any further confirmation is futile!\r\n\r\n\u2014\r\nReply to this email directly, view it on GitHub<https://github.com/home-assistant/core/issues/128598#issuecomment-2492033473>, or unsubscribe<https://github.com/notifications/unsubscribe-auth/BID3R4CLUPKR524UY4V6V4L2BYUWHAVCNFSM6AAAAABQEFIDVSVHI2DSMVQWIX3LMV43OSLTON2WKQ3PNVWWK3TUHMZDIOJSGAZTGNBXGM>.\r\nYou are receiving this because you commented.Message ID: ***@***.***>\r\n\nWould it be possible to integrate the official BMW API?\r\nIt seems like there is one available: https://bmw-cardata.bmwgroup.com/thirdparty/public/car-data/technical-configuration/api-specification\r\n\r\nI know, that there a costs, but If I register me on my own, the pricing and payment should be done outside HA and the integration would only need the API key.\n> What an inappropriate reply!\n> \n> Von meinem iPhone gesendet\n> \n> \n> \n> Am 21.11.2024 um 20:00 schrieb G6EJD ***@***.***>:\n> \n> \n> \n> \ufeff\n> \n> \n> \n> I think at this stage everyone knows there's an issue and any further confirmation is futile!\n> \n> \n> \n> \u2014\n> \n> Reply to this email directly, view it on GitHub<https://github.com/home-assistant/core/issues/128598#issuecomment-2492033473>, or unsubscribe<https://github.com/notifications/unsubscribe-auth/BID3R4CLUPKR524UY4V6V4L2BYUWHAVCNFSM6AAAAABQEFIDVSVHI2DSMVQWIX3LMV43OSLTON2WKQ3PNVWWK3TUHMZDIOJSGAZTGNBXGM>.\n> \n> You are receiving this because you commented.Message ID: ***@***.***>\n> \n> \n\nWhat to do instead?\n\nInstead, go to the top of the issue, and add a \ud83d\udc4d emoji reaction. That way, we can still see that you (and how many others) experience this issue while keeping the issue threads nice and clean.\nI think it's still ok to pile on. It will make the powers that be more aware of the issue. \nI\u2019m getting the same error message as you. Everything worked perfectly for months on end.  \r\nIt might be a coincidence, but the day after I activated my climate control via an automation, the BMW integration in Home Assistant became unavailable. I can\u2019t prove a causal connection, which is why I\u2019m asking you: do you also use this integration to control things in your BMW via automation?\n> I\u2019m getting the same error message as you. Everything worked perfectly for months on end. It might be a coincidence, but the day after I activated my climate control via an automation, the BMW integration in Home Assistant became unavailable. I can\u2019t prove a causal connection, which is why I\u2019m asking you: do you also use this integration to control things in your BMW via automation?\r\n\r\nThe BMW API stopped working. There's no other cause inside HomeAssistant to be searched.\nI am having (what appears to be) the same issue.\r\nI am in Europe, using the 'rest of the world' region\r\n\n> Would it be possible to integrate the official BMW API? It seems like there is one available: https://bmw-cardata.bmwgroup.com/thirdparty/public/car-data/technical-configuration/api-specification\r\n> \r\n> I know, that there a costs, but If I register me on my own, the pricing and payment should be done outside HO and the integration would only need the API key.\r\n\r\nIt's not clear if this API provides more than car data. For example, I am not sure you will be able to open the doors, unlock the charging cable or start the AC, which are, I guess, the things used the most.\n> Would it be possible to integrate the official BMW API?\r\n\r\nFrom what we have seen, it would reduce the functionality massively, as it only displays values from cars and cannot control it (i.e. no remote services). \r\n\r\n\n> > Same here in Belgium\r\n> > But I also received this email from Engie, my electricity provider , my car is also connected in their app for the smart charging, it says to not disconnected my car in the app. If i disconnect it, i'll not be able to reconnect it again and they 're working with BMW to find a solution\r\n> \r\n> The question is if BMW didn't see that services were going to break or if they did it on purpose to get third party services to register their IPs with them? I am curious to know how Engie (and others) will solve this.\r\n\r\nI don't know but it seems that BMW also remotly disconnect all extern connections. When I received the email from Engie, my car was still connected in the APP and I was able to use the smart charging\r\nI just opened it now (11h30 Brussels time) and my 330e is not connected anymore\r\n\r\nIt seems BMW reject all connections that are able to send request to cars ( lids, door, climate, change charging time). And only read  request are allowed :( \r\nMy car is also connected in the EEVEE app ( an app just to read charging stats) and it's still connected (and also connected in the car data in my bmw account)\r\n\r\n![IMG_8216](https://github.com/user-attachments/assets/ce45f8bd-c021-4119-850c-6ea115d493e0)\r\n\r\n\r\n\nnot a problem, if the BMW app can do it, HA can do it also, just a change is needed :-)\nDaniele,\nI think there is no connection between our authentication problem and the fact that you switch the climate from HA. I do the same for one of my cars and never for the second car.\nDespite that, both cars show the same authentication problem since the same time.\nRegards Mario\n\nVon: Daniele Torelli ***@***.***>\nGesendet: Freitag, 22. November 2024 07:14\nAn: home-assistant/core ***@***.***>\nCc: Supermario3012 ***@***.***>; Comment ***@***.***>\nBetreff: Re: [home-assistant/core] BMW login failure (Issue #128598)\n\n\nI'm getting the same error message as you. Everything worked perfectly for months on end. It might be a coincidence, but the day after I activated my climate control via an automation, the BMW integration in Home Assistant became unavailable. I can't prove a causal connection, which is why I'm asking you: do you also use this integration to control things in your BMW via automation?\n\nThe BMW API stopped working. There's no other cause inside HomeAssistant to be searched.\n\n-\nReply to this email directly, view it on GitHub<https://github.com/home-assistant/core/issues/128598#issuecomment-2492947064>, or unsubscribe<https://github.com/notifications/unsubscribe-auth/BID3R4G7P4HHBC2XUWLVKR32B3DSVAVCNFSM6AAAAABQEFIDVSVHI2DSMVQWIX3LMV43OSLTON2WKQ3PNVWWK3TUHMZDIOJSHE2DOMBWGQ>.\nYou are receiving this because you commented.Message ID: ***@***.******@***.***>>\n\nThey've added a capta to prevent robot logins, the irony is probably because all these HA logins and continual API calls are consuming a lot of their resource in serving them, therefore they are trying to reduce the load. Maybe the integration here should reduce it's access to once/minute or less\n> They've added a capta to prevent robot logins, the irony is probably because all these HA logins and continual API calls are consuming a lot of their resource in serving them, therefore they are trying to reduce the load. Maybe the integration here should reduce it's access to once/minute or less\r\n\r\nThat's understandable. Anyway, the current minimum update time is 5 minutes so far I can see from [here](https://github.com/home-assistant/core/blob/dev/homeassistant/components/bmw_connected_drive/const.py#L25-L29).\nBesides, they already have rate limiting. Try sending a command more often than once every 10 minutes and you will get blocked.\n[like]  Marcel Horst reacted to your message:\r\n________________________________\r\nFrom: G6EJD ***@***.***>\r\nSent: Friday, November 22, 2024 1:22:10 PM\r\nTo: home-assistant/core ***@***.***>\r\nCc: Marcel Horst ***@***.***>; Comment ***@***.***>\r\nSubject: Re: [home-assistant/core] BMW login failure (Issue #128598)\r\n\r\n\r\nThey've added a capta to prevent robot logins, the irony is probably because all these HA logins and continual API calls are consuming a lot of their resource in serving them, therefore they are trying to reduce the load. Maybe the integration here should reduce it's access to once/minute or less\r\n\r\n\u2014\r\nReply to this email directly, view it on GitHub<https://github.com/home-assistant/core/issues/128598#issuecomment-2493758604>, or unsubscribe<https://github.com/notifications/unsubscribe-auth/AFUKLMGHE6B26W7D4EXFFUT2B4VYFAVCNFSM6AAAAABQEFIDVSVHI2DSMVQWIX3LMV43OSLTON2WKQ3PNVWWK3TUHMZDIOJTG42TQNRQGQ>.\r\nYou are receiving this because you commented.Message ID: ***@***.***>\r\n\nLooks like the Hassio core team has put the kibosh on the the PR that should have fixed the issue :(\r\n\r\nsee here for more info . . . https://github.com/home-assistant/core/pull/129667\nThat's because they can't change the HA core to solve an integration issue, because doing so would compromise the architecture, their decision was correct. This situation has probably arisen from an over-use of the API.\n> Looks like the Hassio core team has put the kibosh on the the PR that should have fixed the issue :(\n> \n> \n> \n> see here for more info . . . https://github.com/home-assistant/core/pull/129667\n\nSad news. Maybe it's time for a custom component.\nAgree. Right decision.  My main use was to start the climatisation as\r\nOctopus mess up the timers on intelligent go.  So now set up the bmw skill\r\non alexa to do it as a routine\r\n\r\nOn Fri, 22 Nov 2024, 20:52 G6EJD, ***@***.***> wrote:\r\n\r\n> That's because they can't change the HA core to solve an integration\r\n> issue, because doing so would compromise the architecture, their decision\r\n> was correct. This situation has probably arisen from an over-use of the API.\r\n>\r\n> \u2014\r\n> Reply to this email directly, view it on GitHub\r\n> <https://github.com/home-assistant/core/issues/128598#issuecomment-2494776269>,\r\n> or unsubscribe\r\n> <https://github.com/notifications/unsubscribe-auth/AB5R5XJOICQ36ZSULHHQHEL2B6KSXAVCNFSM6AAAAABQEFIDVSVHI2DSMVQWIX3LMV43OSLTON2WKQ3PNVWWK3TUHMZDIOJUG43TMMRWHE>\r\n> .\r\n> You are receiving this because you are subscribed to this thread.Message\r\n> ID: ***@***.***>\r\n>\r\n\n> Looks like the Hassio core team has put the kibosh on the the PR that should have fixed the issue :(\r\n\r\nAnd understandably so. But not all is lost. They promised to look into alternative approaches to enable make the integration work again. We need to exercise patience meanwhile, I\u2019m afraid.\nAgreed, all this may lead to a means to allow/enable 3rd party interfaces to use a captcha as the trend continues to climb.  \nIt's strange that I don't need todo any captcha at all in the bmw app, where is that coming from ??\n> It's strange that I don't need todo any captcha at all in the bmw app, where is that coming from ??\r\n\r\nRuns in the background. Same idea as recaptcha v3.\nWe have two accounts one for a BMW the other a Countryman, and both required a new login as of 2-days ago. We both use iPhone 16 and have the browsers set to no tracking and both required a captcha to be responded to enable a login. Whether a captcha is triggered depends on the IP address and usage of the BMW site, what the browser settings are such as the presence of a browser history and many other factors. In retrospect I should never have had background refresh enabled for 4 x iPhone, 4 x iPad as each one was keeping HA refreshed and so-on. It seems bluntly clear that over use of the BMW API has created this situation.\n\nSome will get a captcha others not.\nJust happened to me, I'm in Australia\n> This situation has probably arisen from an over-use of the API.\r\n\r\nYou've repeated that, but I still doubt it.\nconfirming same issue \u201cinvalid authentication\u201d connected drive region : rest of the world.\nWhat difference does it make, in terms of data traffic, if you use the myBMW App or HA?\n\nVon: robthebold ***@***.***>\nGesendet: Samstag, 23. November 2024 03:26\nAn: home-assistant/core ***@***.***>\nCc: Supermario3012 ***@***.***>; Comment ***@***.***>\nBetreff: Re: [home-assistant/core] BMW login failure (Issue #128598)\n\n\nThis situation has probably arisen from an over-use of the API.\n\nYou've repeated that, but I still doubt it.\n\n-\nReply to this email directly, view it on GitHub<https://github.com/home-assistant/core/issues/128598#issuecomment-2495226689>, or unsubscribe<https://github.com/notifications/unsubscribe-auth/BID3R4HEWPPJOZIXME2IDTL2B7RULAVCNFSM6AAAAABQEFIDVSVHI2DSMVQWIX3LMV43OSLTON2WKQ3PNVWWK3TUHMZDIOJVGIZDMNRYHE>.\nYou are receiving this because you commented.Message ID: ***@***.******@***.***>>\n\n**Regarding the way forward**\r\nAs frenck mentioned, we're in contact and evaluating other options to enable access.\r\nThis means both building another type of flow that passes the (very valid!) security concerns my first PR had as well as figuring out if NabuCasa's partnership team can help out here.\r\n\r\n**Why do some integrations still work**\r\nIf you have a valid `refresh_token` (part of the OAuth login spec also used by BMW), then your account will continue to work. The captcha is only required on first login. While some tokens seem to have been invalidated, we don't know.\r\n\r\n**Regarding traffic/number of calls**\r\nWhen using the MyBMW app, you only send requests (albeit a little more than we do) when you are actively using the app. Using the integration, we send requests every 5 (rest_of_world) or 10 (north_america) minutes. Nobody knows how BMW servers are set up and what percentage of load can be attributed to HA usage.\r\n\r\nI do plan to reduce the refresh interval to once every 15 minutes to lessen the total number of calls. Everybody is free to try to revert it back to 5 minutes using personal automations.\r\n\r\n**Please be patient, thank you!**\nHi @rikroe , thnx for the info, appreciated\r\nCan we use your PR as a custom component untill there is final solution? i see its closed, but we can still download it and run as custom \n@rikroe : sadly, as frenck also mentioned in your PR, the 'feature' has been deployed worldwide, and we all have issues now.\r\nI assume, mine broke when I performed core and OS updates, after which a reconnect suffered the captcha of death.\r\n\r\nHowever, I am thinking about a temporary solution, which could help without compromising HA security.\r\n\r\nSince all you need is a refresh_token, could one not edit the form so that you can enter a refresh_token ? \r\nOne could perform the oauth request with postman and enter the refresh_token in HA to get the integration working again.\r\n\r\nI know It requires some more steps, but could be a temporary solution (at least for those comfortable of using postman).\r\nDo you care to document the API requests (postman collection) and how to add the refresh_token manually in HA ?", "created_at": "2024-11-23T11:53:22Z"}
{"repo": "home-assistant/core", "pull_number": 131349, "instance_id": "home-assistant__core-131349", "issue_numbers": ["129375"], "base_commit": "52e6afdcca500da9fc2601bb29decdc181ab6a4d", "patch": "diff --git a/homeassistant/components/html5/strings.json b/homeassistant/components/html5/strings.json\nindex 40bdbb3626112f..2c68223581ac7d 100644\n--- a/homeassistant/components/html5/strings.json\n+++ b/homeassistant/components/html5/strings.json\n@@ -7,7 +7,7 @@\n           \"vapid_prv_key\": \"VAPID private key\"\n         },\n         \"data_description\": {\n-          \"vapid_email\": \"Email to use for html5 push notifications.\",\n+          \"vapid_email\": \"This contact address will be included in the metadata of each notification.\",\n           \"vapid_prv_key\": \"If not specified, one will be automatically generated.\"\n         }\n       }\n", "test_patch": "", "problem_statement": "HTML5 Push Notifications: Missing explanation for email address requirement\n### The problem\r\n\r\nWhen setting up HTML5 Push Notifications the first thing the user is presented with is this dialog:\r\n\r\n![image](https://github.com/user-attachments/assets/b9117982-70e1-48e4-bcf8-9c0a8d3792c0)\r\n\r\nThe only explanation for the email address here is currently\r\n\r\nhttps://github.com/home-assistant/core/blob/fe2260851e6eb14c2c3763aba320209d5a362fa5/homeassistant/components/html5/strings.json#L10\r\n\r\nbelow the email field which just tells that it is somehow required.\r\n\r\nUnfortunately the word \"email\" is mentioned not even once in the documentation:\r\nhttps://www.home-assistant.io/integrations/html5\r\n\r\nTo give a the user a better information what kind of email address to use here \u2013 especially not to use a personal address \u2013 this should be reworded as:\r\n\r\n     Contact address for HTML5 notification header\r\n\r\nFrom the [Mozilla docs](https://blog.mozilla.org/services/2016/08/23/sending-vapid-identified-webpush-notifications-via-mozillas-push-service/):\r\n\r\n_It\u2019s best if this email is not a personal email address, but rather a group email so that if a person leaves an organization, is unavailable for an extended period, or otherwise can\u2019t respond, someone else on the list can. Mozilla will only use this if we notice a problem with your feed and need to contact you._\r\n\r\nPerhaps you can add a similar note to the docs, too.\r\n\r\n### What version of Home Assistant Core has the issue?\r\n\r\n2024.10.4\r\n\r\n### Integration causing the issue\r\n\r\nHTML5 Push Notifications\r\n\r\n### Link to integration documentation on our website\r\n\r\nhttps://www.home-assistant.io/integrations/html5\r\n\n", "hints_text": "\nHey there @alexyao2015, mind taking a look at this issue as it has been labeled with an integration (`html5`) you are listed as a [code owner](https://github.com/home-assistant/core/blob/dev/CODEOWNERS#L646) for? Thanks!\n\n<details>\n<summary>Code owner commands</summary>\n\n\nCode owners of `html5` can trigger bot actions by commenting:\n\n- `@home-assistant close` Closes the issue.\n- `@home-assistant rename Awesome new title` Renames the issue.\n- `@home-assistant reopen` Reopen the issue.\n- `@home-assistant unassign html5` Removes the current integration label and assignees on the issue, add the integration domain after the command.\n- `@home-assistant add-label needs-more-information` Add a label (needs-more-information, problem in dependency, problem in custom component) to the issue.\n- `@home-assistant remove-label needs-more-information` Remove a label (needs-more-information, problem in dependency, problem in custom component) on the issue.\n\n</details>\n\n\n<sub><sup>(message by CodeOwnersMention)</sup></sub>\n\n---\n\n[html5 documentation](https://www.home-assistant.io/integrations/html5)\n[html5 source](https://github.com/home-assistant/core/tree/dev/homeassistant/components/html5)\n<sub><sup>(message by IssueLinks)</sup></sub>", "created_at": "2024-11-23T11:01:00Z"}
{"repo": "home-assistant/core", "pull_number": 131319, "instance_id": "home-assistant__core-131319", "issue_numbers": ["130464"], "base_commit": "954ac0d288d8768836803508a259060c4e22c2d3", "patch": "diff --git a/homeassistant/components/modbus/modbus.py b/homeassistant/components/modbus/modbus.py\nindex d85b4e0e67f42f..18d91f8dd3bfcf 100644\n--- a/homeassistant/components/modbus/modbus.py\n+++ b/homeassistant/components/modbus/modbus.py\n@@ -158,8 +158,6 @@ async def async_modbus_setup(\n \n     async def async_stop_modbus(event: Event) -> None:\n         \"\"\"Stop Modbus service.\"\"\"\n-\n-        async_dispatcher_send(hass, SIGNAL_STOP_ENTITY)\n         for client in hub_collect.values():\n             await client.async_close()\n \n", "test_patch": "", "problem_statement": "[Modbus] Switches do not keep their state across HA restarts\n### The problem\n\nNormal HA switches (e.g. for example, `input_boolean`) maintain their state across HA restarts (unless the `initial` parameter is set). This doesn't seem to be the case for switches configured in the Modbus YAML.\r\n\r\nThere is the `verify` functionality mentioned in the documentation. However, some Modbus devices do not support reading individual registers or coils [(click)](https://community.home-assistant.io/t/modbus-read-coils-not-as-binary/406901). The documentation says that *\"...If omitted, no verification is done, but the state of the switch is set with each toggle.\"*. Based on this, my expectation would be that the respective state is also kept across HA restarts, which doesn't seem to be the case.\r\n\r\nThis leads to confusion because after HA restart, Modbus switches suddenly have the `off` state (although in reality the respective Modbus slave function is on).\r\n\r\nTo summarize:\r\n\r\n### Expectation\r\nModbus switches (where verification is not configured) keep their state across HA restarts.\r\n\r\n### Actual result\r\nModbus switches (where verification is not configured) reset their state to `off` after HA restart.\r\n\r\n### Way to reproduce\r\n\r\n1) Configure a Modbus switch (that does something real on the slave)\r\n2) Turn the switch on.\r\n3) Verify that the respective functionality on the slave is on.\r\n4) Restart HA.\r\n5) Check the state of the switch.\n\n### What version of Home Assistant Core has the issue?\n\n2024.11.x\n\n### What was the last working version of Home Assistant Core?\n\n_No response_\n\n### What type of installation are you running?\n\nHome Assistant Supervised\n\n### Integration causing the issue\n\nModbus\n\n### Link to integration documentation on our website\n\nhttps://www.home-assistant.io/integrations/modbus/#configuring-switch-entities\n\n### Diagnostics information\n\n_No response_\n\n### Example YAML snippet\n\n```yaml\n- name: waveshare_port1\r\n  type: serial\r\n  method: rtu\r\n  port: /dev/serial/by-id/usb-xxxx\r\n  baudrate: 9600\r\n  bytesize: 8\r\n  parity: N\r\n  stopbits: 1\r\n  delay: 0\r\n  message_wait_milliseconds: 30\r\n  timeout: 5\r\n  switches:\r\n    - name: Waveshare relay channel 1\r\n      slave: 0x01\r\n      address: 0x0000\r\n      write_type: coil\r\n      command_on: 0xFF00\r\n      command_off: 0x0000\r\n    - name: Waveshare relay channel 2\r\n      slave: 0x01\r\n      address: 0x0001\r\n      write_type: coil\r\n      command_on: 0xFF00\r\n      command_off: 0x0000\r\n...\n```\n\n\n### Anything in the logs that might be useful for us?\n\n_No response_\n\n### Additional information\n\n_No response_\n", "hints_text": "[modbus documentation](https://www.home-assistant.io/integrations/modbus)\n[modbus source](https://github.com/home-assistant/core/tree/dev/homeassistant/components/modbus)\nHi @pspot2 , actually I cannot configure an environment to reproduce the error, but taking a look to the code, it seems that the modbus switch correctly tries to retrive the last stored state from HASS. In case of problems, it logs as warning. \r\nCan you enable the warning log from modbus, maybe it is possible to discover more info about that behaviour. \nTested the scenario and I can confirm the bug. HA saves the states every 15 minutes or on closing, but in case you restart HA before that the 15 minutes are left, the modbus integrations blocks the normal on close saving procedures then the state of the entity is saved as unavailable", "created_at": "2024-11-23T00:07:30Z"}
{"repo": "home-assistant/core", "pull_number": 131313, "instance_id": "home-assistant__core-131313", "issue_numbers": ["97563"], "base_commit": "8f9095ba67e6a8c29608b1d0d2b1e35648b5d168", "patch": "diff --git a/homeassistant/components/tuya/number.py b/homeassistant/components/tuya/number.py\nindex d2e381d998249b..8d5b5dbfa19e15 100644\n--- a/homeassistant/components/tuya/number.py\n+++ b/homeassistant/components/tuya/number.py\n@@ -292,6 +292,17 @@\n             device_class=NumberDeviceClass.TEMPERATURE,\n         ),\n     ),\n+    # CO2 Detector\n+    # https://developer.tuya.com/en/docs/iot/categoryco2bj?id=Kaiuz3wes7yuy\n+    \"co2bj\": (\n+        NumberEntityDescription(\n+            key=DPCode.ALARM_TIME,\n+            translation_key=\"alarm_duration\",\n+            native_unit_of_measurement=UnitOfTime.SECONDS,\n+            device_class=NumberDeviceClass.DURATION,\n+            entity_category=EntityCategory.CONFIG,\n+        ),\n+    ),\n }\n \n \ndiff --git a/homeassistant/components/tuya/select.py b/homeassistant/components/tuya/select.py\nindex abc5e4c496b474..831d3cb3e0c918 100644\n--- a/homeassistant/components/tuya/select.py\n+++ b/homeassistant/components/tuya/select.py\n@@ -307,6 +307,15 @@\n             entity_category=EntityCategory.CONFIG,\n         ),\n     ),\n+    # CO2 Detector\n+    # https://developer.tuya.com/en/docs/iot/categoryco2bj?id=Kaiuz3wes7yuy\n+    \"co2bj\": (\n+        SelectEntityDescription(\n+            key=DPCode.ALARM_VOLUME,\n+            translation_key=\"volume\",\n+            entity_category=EntityCategory.CONFIG,\n+        ),\n+    ),\n }\n \n # Socket (duplicate of `kg`)\ndiff --git a/homeassistant/components/tuya/sensor.py b/homeassistant/components/tuya/sensor.py\nindex b9677037b7eddc..390aa3a0130d06 100644\n--- a/homeassistant/components/tuya/sensor.py\n+++ b/homeassistant/components/tuya/sensor.py\n@@ -214,6 +214,12 @@ class TuyaSensorEntityDescription(SensorEntityDescription):\n             device_class=SensorDeviceClass.VOLATILE_ORGANIC_COMPOUNDS,\n             state_class=SensorStateClass.MEASUREMENT,\n         ),\n+        TuyaSensorEntityDescription(\n+            key=DPCode.PM25_VALUE,\n+            translation_key=\"pm25\",\n+            device_class=SensorDeviceClass.PM25,\n+            state_class=SensorStateClass.MEASUREMENT,\n+        ),\n         *BATTERY_SENSORS,\n     ),\n     # Two-way temperature and humidity switch\ndiff --git a/homeassistant/components/tuya/siren.py b/homeassistant/components/tuya/siren.py\nindex 334dced134d3e8..6f7dfe4c96c10e 100644\n--- a/homeassistant/components/tuya/siren.py\n+++ b/homeassistant/components/tuya/siren.py\n@@ -11,6 +11,7 @@\n     SirenEntityDescription,\n     SirenEntityFeature,\n )\n+from homeassistant.const import EntityCategory\n from homeassistant.core import HomeAssistant, callback\n from homeassistant.helpers.dispatcher import async_dispatcher_connect\n from homeassistant.helpers.entity_platform import AddEntitiesCallback\n@@ -43,6 +44,14 @@\n             key=DPCode.SIREN_SWITCH,\n         ),\n     ),\n+    # CO2 Detector\n+    # https://developer.tuya.com/en/docs/iot/categoryco2bj?id=Kaiuz3wes7yuy\n+    \"co2bj\": (\n+        SirenEntityDescription(\n+            key=DPCode.ALARM_SWITCH,\n+            entity_category=EntityCategory.CONFIG,\n+        ),\n+    ),\n }\n \n \ndiff --git a/homeassistant/components/tuya/strings.json b/homeassistant/components/tuya/strings.json\nindex 0f005821cbb012..8ec61cc8aa51d2 100644\n--- a/homeassistant/components/tuya/strings.json\n+++ b/homeassistant/components/tuya/strings.json\n@@ -119,6 +119,9 @@\n       }\n     },\n     \"number\": {\n+      \"alarm_duration\": {\n+        \"name\": \"Alarm duration\"\n+      },\n       \"temperature\": {\n         \"name\": \"[%key:component::sensor::entity_component::temperature::name%]\"\n       },\n", "test_patch": "", "problem_statement": "Missing sensors from AIR_DETECTOR (yrr3eiyiacm31ski) \n### The problem\n\nI use an Air Quality detector compatible with Tuya integration.\r\n\r\nThis device in Tuya IoT portal has the following Standard Status set\r\n\r\n|Code | Type | Values|\r\n|-- | -- | --|\r\n|co2_state | Enum | {\"range\": [\"alarm\", \"normal\"]}|\r\n|co2_value | Integer | {\"unit\": \"ppm\", \"min\": 0, \"max\": 5000, \"scale\": 0, \"step\": 1}|\r\n|alarm_volume | Enum | {\"range\": [\"low\", \"middle\", \"high\", \"mute\"]}|\r\n|alarm_time | Integer | {\"unit\": \"s\", \"min\": 1, \"max\": 60, \"scale\": 0, \"step\": 1}|\r\n|alarm_switch | Boolean | \"{true,false}\"|\r\n|battery_percentage | Integer | {\"unit\": \"%\", \"min\": 0, \"max\": 100, \"scale\": 0, \"step\": 1}|\r\n|alarm_bright | Integer | {\"unit\": \"%\", \"min\": 0, \"max\": 100, \"scale\": 0, \"step\": 1}|\r\n|temp_current | Integer | {\"unit\": \"\\u2103\", \"min\": -9, \"max\": 199, \"scale\": 0, \"step\": 1}|\r\n|humidity_value | Integer | {\"unit\": \"%\", \"min\": 0, \"max\": 100, \"scale\": 0, \"step\": 1}|\r\n|pm25_value | Integer | {\"unit\": \"\\u03bcg/m3\", \"min\": 0, \"max\": 1000, \"scale\": 0, \"step\": 1}|\r\n|voc_value | Integer | {\"unit\":\"mg/m3\",\"min\":\"0\",\"max\":\"9999\",\"scale\":\"3\",\"step\":\"1\"}|\r\n|ch2o_value | Integer | {\"unit\":\"mg/m3\",\"min\":\"0\",\"max\":\"9999\",\"scale\":\"3\",\"step\":\"1\"}|\r\n\r\nAnd Instruction set:\r\n\r\n|Code | Type | Values|\r\n|-- | -- | --|\r\n|alarm_volume | Enum | {\"range\": [\"low\", \"middle\", \"high\", \"mute\"]}|\r\n|alarm_time | Integer | {\"unit\": \"s\", \"min\": 1, \"max\": 60, \"scale\": 0, \"step\": 1}|\r\n|alarm_switch | Boolean | \"{true,false}\"|\r\n|alarm_bright | Integer | {\"unit\": \"%\", \"min\": 0, \"max\": 100, \"scale\": 0, \"step\": 1}|\r\n\r\nSadly, in Home Assistant it this device is being recognized as having only:\r\n- Sensors:\r\n  - CO2 value\r\n  - Safety\r\n  - Temperature\r\n  - Humidity\r\n- Diagnostics:\r\n   - Battery level\r\n\r\nSo it's missing all othert sensors and actions\n\n### What version of Home Assistant Core has the issue?\n\ncore-2023.7.3\n\n### What was the last working version of Home Assistant Core?\n\n_No response_\n\n### What type of installation are you running?\n\nHome Assistant OS\n\n### Integration causing the issue\n\n_No response_\n\n### Link to integration documentation on our website\n\nhttps://www.home-assistant.io/integrations/tuya/\n\n### Diagnostics information\n\n[tuya-c7a83243205e3ca9260a803540f48447-Air detector-c5c5a2f0cf512cbb7d9d97d173c21240.json.txt](https://github.com/home-assistant/core/files/12227392/tuya-c7a83243205e3ca9260a803540f48447-Air.detector-c5c5a2f0cf512cbb7d9d97d173c21240.json.txt)\r\n\n\n### Example YAML snippet\n\n_No response_\n\n### Anything in the logs that might be useful for us?\n\n_No response_\n\n### Additional information\n\n_No response_\n", "hints_text": "\nHey there @tuya, @zlinoliver, @frenck, mind taking a look at this issue as it has been labeled with an integration (`tuya`) you are listed as a [code owner](https://github.com/home-assistant/core/blob/dev/CODEOWNERS#L1309) for? Thanks!\n\n<details>\n<summary>Code owner commands</summary>\n\n\nCode owners of `tuya` can trigger bot actions by commenting:\n\n- `@home-assistant close` Closes the issue.\n- `@home-assistant rename Awesome new title` Renames the issue.\n- `@home-assistant reopen` Reopen the issue.\n- `@home-assistant unassign tuya` Removes the current integration label and assignees on the issue, add the integration domain after the command.\n\n</details>\n\n\n<sub><sup>(message by CodeOwnersMention)</sup></sub>\n\n---\n\n[tuya documentation](https://www.home-assistant.io/integrations/tuya)\n[tuya source](https://github.com/home-assistant/core/tree/dev/homeassistant/components/tuya)\n<sub><sup>(message by IssueLinks)</sup></sub>\nSame problem here with the same device.\nSame here (same device)\n> Same here (same device)\n\nI reached out to @frenck in discord on this to ask if I could get some guidance to help fixing but he told me he couldn't.\n\nI'm not sure if:\n- it's a tuya/device issue\n- an enhancement on Home assistant\n\nI really would like to have the remaining values to create an autonation with air purifier.\n\nMy guess is that there are other critical issues to deal with.\nWith Local Tuya you can get all the sensors. \nLocaltuya somehow does not see my fingerbot with bluetooth gateway. But I\r\nwill give it one more try as I changed HA installation to hassos from\r\ndocker ....\r\n\r\n\u0432\u0441, 1 \u043e\u043a\u0442. 2023\u202f\u0433. \u0432 20:30, zevayo ***@***.***>:\r\n\r\n> With Local Tuya you can get all the sensors.\r\n>\r\n> \u2014\r\n> Reply to this email directly, view it on GitHub\r\n> <https://github.com/home-assistant/core/issues/97563#issuecomment-1742146797>,\r\n> or unsubscribe\r\n> <https://github.com/notifications/unsubscribe-auth/ABU7SKEKHJBIEYACDOBCDVTX5GSDVANCNFSM6AAAAAA27RRZLU>\r\n> .\r\n> You are receiving this because you commented.Message ID:\r\n> ***@***.***>\r\n>\r\n\n> With Local Tuya you can get all the sensors. \n\nthat's a good shout, but I'm curious why it doesn't work with built-in integration\n> > With Local Tuya you can get all the sensors. \n> \n> that's a good shout, but I'm curious why it doesn't work with built-in integration\n\n@zevayo I did tried it, but it's giving an error trying to add the device, you had any issue? if so, could share any tips?\n\nupdate : for some reason the device was not allowing connections, had to reset it, and then I was able to use with localtuya \nIn my case localtuya still does not give me all values like tvoc and hcho.\n\nI guess I have to wait until this is sorted out\nThere hasn't been any activity on this issue recently. Due to the high number of incoming GitHub notifications, we have to clean some of the old issues, as many of them have already been resolved with the latest updates.\nPlease make sure to update to the latest Home Assistant version and check if that solves the issue. Let us know if that works for you by adding a comment \ud83d\udc4d\nThis issue has now been marked as stale and will be closed if no further activity occurs. Thank you for your contributions.\nNot even a single response about this being fixable or not, and the result was being posed without any reply from main contributors\nI have same issue with AIR_DETECTOR (yrr3eiyiacm31ski) using module Tuya.  I could see only co2, temperature , humidity  but no PM messure .\r\n\nAdding to the list of affected users. I have the same issue, only temp / humidity / co2 are visible.\nI've a feeling that it won't get any kind of fix.\r\n\r\n\r\nA segunda, 12/02/2024, 16:33, Igor Ramadas ***@***.***>\r\nescreveu:\r\n\r\n> Adding to the list of affected users. I have the same issue, only temp /\r\n> humidity / co2 are visible.\r\n>\r\n> \u2014\r\n> Reply to this email directly, view it on GitHub\r\n> <https://github.com/home-assistant/core/issues/97563#issuecomment-1939092265>,\r\n> or unsubscribe\r\n> <https://github.com/notifications/unsubscribe-auth/AM6OPV3NXA5BPQQGJH4ODADYTI75HAVCNFSM6AAAAAA27RRZLWVHI2DSMVQWIX3LMV43OSLTON2WKQ3PNVWWK3TUHMYTSMZZGA4TEMRWGU>\r\n> .\r\n> You are receiving this because you authored the thread.Message ID:\r\n> ***@***.***>\r\n>\r\n\nI have created a ticket with Tuya directly asking them to validate (and apply) the following change: https://github.com/igoramadas/core/commit/95ee23747c22ddef7283b707de3d101ec5ef81d8\r\n\r\nHopefully this will come out on the next 2024.03 release.\nTuya is not very helpful. The device has a category \"co2bj\" which in theory should not support the extra sensors. The correct category is \"dgnbj\". But anyhow, the sensors are there and they even work in the Tuya / Smart Life apps. So I guess it should be fine to just extend \"co2bj\" with the new properties.\r\n\r\nAnyone experienced with home-assistant development willing to test and possibly open a PR with the following changes:\r\nhttps://github.com/igoramadas/core/commit/95ee23747c22ddef7283b707de3d101ec5ef81d8\r\n\r\nUnfortunately I won't have access to my hass Docker deployment at least for another 2 weeks, so I can't test this myself at the moment.", "created_at": "2024-11-22T21:39:18Z"}
{"repo": "home-assistant/core", "pull_number": 131298, "instance_id": "home-assistant__core-131298", "issue_numbers": ["130879"], "base_commit": "7621012ee69ea379b77887dc251e0c7ddc1d624c", "patch": "diff --git a/homeassistant/components/enphase_envoy/sensor.py b/homeassistant/components/enphase_envoy/sensor.py\nindex 20d610e4b71fcd..655a813baf3ac8 100644\n--- a/homeassistant/components/enphase_envoy/sensor.py\n+++ b/homeassistant/components/enphase_envoy/sensor.py\n@@ -10,6 +10,8 @@\n from typing import TYPE_CHECKING\n \n from pyenphase import (\n+    EnvoyACBPower,\n+    EnvoyBatteryAggregate,\n     EnvoyEncharge,\n     EnvoyEnchargeAggregate,\n     EnvoyEnchargePower,\n@@ -721,6 +723,78 @@ class EnvoyEnchargeAggregateSensorEntityDescription(SensorEntityDescription):\n )\n \n \n+@dataclass(frozen=True, kw_only=True)\n+class EnvoyAcbBatterySensorEntityDescription(SensorEntityDescription):\n+    \"\"\"Describes an Envoy ACB Battery sensor entity.\"\"\"\n+\n+    value_fn: Callable[[EnvoyACBPower], int | str]\n+\n+\n+ACB_BATTERY_POWER_SENSORS = (\n+    EnvoyAcbBatterySensorEntityDescription(\n+        key=\"acb_power\",\n+        native_unit_of_measurement=UnitOfPower.WATT,\n+        device_class=SensorDeviceClass.POWER,\n+        value_fn=attrgetter(\"power\"),\n+    ),\n+    EnvoyAcbBatterySensorEntityDescription(\n+        key=\"acb_soc\",\n+        native_unit_of_measurement=PERCENTAGE,\n+        device_class=SensorDeviceClass.BATTERY,\n+        value_fn=attrgetter(\"state_of_charge\"),\n+    ),\n+    EnvoyAcbBatterySensorEntityDescription(\n+        key=\"acb_battery_state\",\n+        translation_key=\"acb_battery_state\",\n+        device_class=SensorDeviceClass.ENUM,\n+        options=[\"discharging\", \"idle\", \"charging\", \"full\"],\n+        value_fn=attrgetter(\"state\"),\n+    ),\n+)\n+\n+ACB_BATTERY_ENERGY_SENSORS = (\n+    EnvoyAcbBatterySensorEntityDescription(\n+        key=\"acb_available_energy\",\n+        translation_key=\"acb_available_energy\",\n+        native_unit_of_measurement=UnitOfEnergy.WATT_HOUR,\n+        device_class=SensorDeviceClass.ENERGY_STORAGE,\n+        value_fn=attrgetter(\"charge_wh\"),\n+    ),\n+)\n+\n+\n+@dataclass(frozen=True, kw_only=True)\n+class EnvoyAggregateBatterySensorEntityDescription(SensorEntityDescription):\n+    \"\"\"Describes an Envoy aggregate Ensemble and ACB Battery sensor entity.\"\"\"\n+\n+    value_fn: Callable[[EnvoyBatteryAggregate], int]\n+\n+\n+AGGREGATE_BATTERY_SENSORS = (\n+    EnvoyAggregateBatterySensorEntityDescription(\n+        key=\"aggregated_soc\",\n+        translation_key=\"aggregated_soc\",\n+        native_unit_of_measurement=PERCENTAGE,\n+        device_class=SensorDeviceClass.BATTERY,\n+        value_fn=attrgetter(\"state_of_charge\"),\n+    ),\n+    EnvoyAggregateBatterySensorEntityDescription(\n+        key=\"aggregated_available_energy\",\n+        translation_key=\"aggregated_available_energy\",\n+        native_unit_of_measurement=UnitOfEnergy.WATT_HOUR,\n+        device_class=SensorDeviceClass.ENERGY_STORAGE,\n+        value_fn=attrgetter(\"available_energy\"),\n+    ),\n+    EnvoyAggregateBatterySensorEntityDescription(\n+        key=\"aggregated_max_battery_capacity\",\n+        translation_key=\"aggregated_max_capacity\",\n+        native_unit_of_measurement=UnitOfEnergy.WATT_HOUR,\n+        device_class=SensorDeviceClass.ENERGY_STORAGE,\n+        value_fn=attrgetter(\"max_available_capacity\"),\n+    ),\n+)\n+\n+\n async def async_setup_entry(\n     hass: HomeAssistant,\n     config_entry: EnphaseConfigEntry,\n@@ -845,6 +919,20 @@ async def async_setup_entry(\n             EnvoyEnpowerEntity(coordinator, description)\n             for description in ENPOWER_SENSORS\n         )\n+    if envoy_data.acb_power:\n+        entities.extend(\n+            EnvoyAcbBatteryPowerEntity(coordinator, description)\n+            for description in ACB_BATTERY_POWER_SENSORS\n+        )\n+        entities.extend(\n+            EnvoyAcbBatteryEnergyEntity(coordinator, description)\n+            for description in ACB_BATTERY_ENERGY_SENSORS\n+        )\n+    if envoy_data.battery_aggregate:\n+        entities.extend(\n+            AggregateBatteryEntity(coordinator, description)\n+            for description in AGGREGATE_BATTERY_SENSORS\n+        )\n \n     async_add_entities(entities)\n \n@@ -1226,3 +1314,60 @@ def native_value(self) -> datetime.datetime | int | float | None:\n         enpower = self.data.enpower\n         assert enpower is not None\n         return self.entity_description.value_fn(enpower)\n+\n+\n+class EnvoyAcbBatteryPowerEntity(EnvoySensorBaseEntity):\n+    \"\"\"Envoy ACB Battery power sensor entity.\"\"\"\n+\n+    entity_description: EnvoyAcbBatterySensorEntityDescription\n+\n+    def __init__(\n+        self,\n+        coordinator: EnphaseUpdateCoordinator,\n+        description: EnvoyAcbBatterySensorEntityDescription,\n+    ) -> None:\n+        \"\"\"Initialize ACB Battery entity.\"\"\"\n+        super().__init__(coordinator, description)\n+        acb_data = self.data.acb_power\n+        assert acb_data is not None\n+        self._attr_unique_id = f\"{self.envoy_serial_num}_{description.key}\"\n+        self._attr_device_info = DeviceInfo(\n+            identifiers={(DOMAIN, f\"{self.envoy_serial_num}_acb\")},\n+            manufacturer=\"Enphase\",\n+            model=\"ACB\",\n+            name=f\"ACB {self.envoy_serial_num}\",\n+            via_device=(DOMAIN, self.envoy_serial_num),\n+        )\n+\n+    @property\n+    def native_value(self) -> int | str | None:\n+        \"\"\"Return the state of the ACB Battery power sensors.\"\"\"\n+        acb = self.data.acb_power\n+        assert acb is not None\n+        return self.entity_description.value_fn(acb)\n+\n+\n+class EnvoyAcbBatteryEnergyEntity(EnvoySystemSensorEntity):\n+    \"\"\"Envoy combined ACB and Ensemble Battery Aggregate energy sensor entity.\"\"\"\n+\n+    entity_description: EnvoyAcbBatterySensorEntityDescription\n+\n+    @property\n+    def native_value(self) -> int | str:\n+        \"\"\"Return the state of the aggregate energy sensors.\"\"\"\n+        acb = self.data.acb_power\n+        assert acb is not None\n+        return self.entity_description.value_fn(acb)\n+\n+\n+class AggregateBatteryEntity(EnvoySystemSensorEntity):\n+    \"\"\"Envoy combined ACB and Ensemble Battery Aggregate sensor entity.\"\"\"\n+\n+    entity_description: EnvoyAggregateBatterySensorEntityDescription\n+\n+    @property\n+    def native_value(self) -> int:\n+        \"\"\"Return the state of the aggregate sensors.\"\"\"\n+        battery_aggregate = self.data.battery_aggregate\n+        assert battery_aggregate is not None\n+        return self.entity_description.value_fn(battery_aggregate)\ndiff --git a/homeassistant/components/enphase_envoy/strings.json b/homeassistant/components/enphase_envoy/strings.json\nindex 2d91b3b0960c3c..a338deb96389d9 100644\n--- a/homeassistant/components/enphase_envoy/strings.json\n+++ b/homeassistant/components/enphase_envoy/strings.json\n@@ -337,6 +337,30 @@\n       },\n       \"configured_reserve_soc\": {\n         \"name\": \"Configured reserve battery level\"\n+      },\n+      \"acb_battery_state\": {\n+        \"name\": \"Battery state\",\n+        \"state\": {\n+          \"discharging\": \"Discharging\",\n+          \"idle\": \"[%key:common::state::idle%]\",\n+          \"charging\": \"Charging\",\n+          \"full\": \"Full\"\n+        }\n+      },\n+      \"acb_available_energy\": {\n+        \"name\": \"Available ACB battery energy\"\n+      },\n+      \"acb_max_capacity\": {\n+        \"name\": \"ACB Battery capacity\"\n+      },\n+      \"aggregated_available_energy\": {\n+        \"name\": \"Aggregated available battery energy\"\n+      },\n+      \"aggregated_max_capacity\": {\n+        \"name\": \"Aggregated Battery capacity\"\n+      },\n+      \"aggregated_soc\": {\n+        \"name\": \"Aggregated battery soc\"\n       }\n     },\n     \"switch\": {\n", "test_patch": "diff --git a/tests/components/enphase_envoy/conftest.py b/tests/components/enphase_envoy/conftest.py\nindex 541b6f96e19400..b860d49aa6b526 100644\n--- a/tests/components/enphase_envoy/conftest.py\n+++ b/tests/components/enphase_envoy/conftest.py\n@@ -6,6 +6,8 @@\n \n import jwt\n from pyenphase import (\n+    EnvoyACBPower,\n+    EnvoyBatteryAggregate,\n     EnvoyData,\n     EnvoyEncharge,\n     EnvoyEnchargeAggregate,\n@@ -172,6 +174,8 @@ def _load_json_2_production_data(\n             mocked_data.system_production_phases[sub_item] = EnvoySystemProduction(\n                 **item_data\n             )\n+    if item := json_fixture[\"data\"].get(\"acb_power\"):\n+        mocked_data.acb_power = EnvoyACBPower(**item)\n \n \n def _load_json_2_meter_data(\n@@ -245,6 +249,8 @@ def _load_json_2_encharge_enpower_data(\n             mocked_data.dry_contact_settings[sub_item] = EnvoyDryContactSettings(\n                 **item_data\n             )\n+    if item := json_fixture[\"data\"].get(\"battery_aggregate\"):\n+        mocked_data.battery_aggregate = EnvoyBatteryAggregate(**item)\n \n \n def _load_json_2_raw_data(mocked_data: EnvoyData, json_fixture: dict[str, Any]) -> None:\ndiff --git a/tests/components/enphase_envoy/fixtures/envoy_acb_batt.json b/tests/components/enphase_envoy/fixtures/envoy_acb_batt.json\nnew file mode 100644\nindex 00000000000000..618b40027b8a79\n--- /dev/null\n+++ b/tests/components/enphase_envoy/fixtures/envoy_acb_batt.json\n@@ -0,0 +1,274 @@\n+{\n+  \"serial_number\": \"1234\",\n+  \"firmware\": \"7.6.358\",\n+  \"part_number\": \"800-00654-r08\",\n+  \"envoy_model\": \"Envoy, phases: 3, phase mode: three, net-consumption CT, production CT\",\n+  \"supported_features\": 1759,\n+  \"phase_mode\": \"three\",\n+  \"phase_count\": 3,\n+  \"active_phase_count\": 0,\n+  \"ct_meter_count\": 2,\n+  \"consumption_meter_type\": \"net-consumption\",\n+  \"production_meter_type\": \"production\",\n+  \"storage_meter_type\": null,\n+  \"data\": {\n+    \"encharge_inventory\": {\n+      \"123456\": {\n+        \"admin_state\": 6,\n+        \"admin_state_str\": \"ENCHG_STATE_READY\",\n+        \"bmu_firmware_version\": \"2.1.16\",\n+        \"comm_level_2_4_ghz\": 4,\n+        \"comm_level_sub_ghz\": 4,\n+        \"communicating\": true,\n+        \"dc_switch_off\": false,\n+        \"encharge_capacity\": 3500,\n+        \"encharge_revision\": 2,\n+        \"firmware_loaded_date\": 1714736645,\n+        \"firmware_version\": \"2.6.6618_rel/22.11\",\n+        \"installed_date\": 1714736645,\n+        \"last_report_date\": 1714804173,\n+        \"led_status\": 17,\n+        \"max_cell_temp\": 16,\n+        \"operating\": true,\n+        \"part_number\": \"830-01760-r46\",\n+        \"percent_full\": 54,\n+        \"serial_number\": \"122327081322\",\n+        \"temperature\": 16,\n+        \"temperature_unit\": \"C\",\n+        \"zigbee_dongle_fw_version\": \"100F\"\n+      }\n+    },\n+    \"encharge_power\": {\n+      \"123456\": {\n+        \"apparent_power_mva\": 105,\n+        \"real_power_mw\": 105,\n+        \"soc\": 54\n+      }\n+    },\n+    \"encharge_aggregate\": {\n+      \"available_energy\": 1890,\n+      \"backup_reserve\": 0,\n+      \"state_of_charge\": 54,\n+      \"reserve_state_of_charge\": 0,\n+      \"configured_reserve_state_of_charge\": 0,\n+      \"max_available_capacity\": 3500\n+    },\n+    \"enpower\": null,\n+    \"acb_power\": {\n+      \"power\": 260,\n+      \"charge_wh\": 930,\n+      \"state_of_charge\": 25,\n+      \"state\": \"discharging\",\n+      \"batteries\": 3\n+    },\n+    \"battery_aggregate\": {\n+      \"available_energy\": 2820,\n+      \"state_of_charge\": 39,\n+      \"max_available_capacity\": 7220\n+    },\n+    \"system_consumption\": {\n+      \"watt_hours_lifetime\": 1234,\n+      \"watt_hours_last_7_days\": 1234,\n+      \"watt_hours_today\": 1234,\n+      \"watts_now\": 1234\n+    },\n+    \"system_production\": {\n+      \"watt_hours_lifetime\": 1234,\n+      \"watt_hours_last_7_days\": 1234,\n+      \"watt_hours_today\": 1234,\n+      \"watts_now\": 1234\n+    },\n+    \"system_consumption_phases\": null,\n+    \"system_production_phases\": null,\n+    \"system_net_consumption\": {\n+      \"watt_hours_lifetime\": 4321,\n+      \"watt_hours_last_7_days\": -1,\n+      \"watt_hours_today\": -1,\n+      \"watts_now\": 2341\n+    },\n+    \"system_net_consumption_phases\": null,\n+    \"ctmeter_production\": {\n+      \"eid\": \"100000010\",\n+      \"timestamp\": 1708006110,\n+      \"energy_delivered\": 11234,\n+      \"energy_received\": 12345,\n+      \"active_power\": 100,\n+      \"power_factor\": 0.11,\n+      \"voltage\": 111,\n+      \"current\": 0.2,\n+      \"frequency\": 50.1,\n+      \"state\": \"enabled\",\n+      \"measurement_type\": \"production\",\n+      \"metering_status\": \"normal\",\n+      \"status_flags\": [\"production-imbalance\", \"power-on-unused-phase\"]\n+    },\n+    \"ctmeter_consumption\": {\n+      \"eid\": \"100000020\",\n+      \"timestamp\": 1708006120,\n+      \"energy_delivered\": 21234,\n+      \"energy_received\": 22345,\n+      \"active_power\": 101,\n+      \"power_factor\": 0.21,\n+      \"voltage\": 112,\n+      \"current\": 0.3,\n+      \"frequency\": 50.2,\n+      \"state\": \"enabled\",\n+      \"measurement_type\": \"net-consumption\",\n+      \"metering_status\": \"normal\",\n+      \"status_flags\": []\n+    },\n+    \"ctmeter_storage\": null,\n+    \"ctmeter_production_phases\": {\n+      \"L1\": {\n+        \"eid\": \"100000011\",\n+        \"timestamp\": 1708006111,\n+        \"energy_delivered\": 112341,\n+        \"energy_received\": 123451,\n+        \"active_power\": 20,\n+        \"power_factor\": 0.12,\n+        \"voltage\": 111,\n+        \"current\": 0.2,\n+        \"frequency\": 50.1,\n+        \"state\": \"enabled\",\n+        \"measurement_type\": \"production\",\n+        \"metering_status\": \"normal\",\n+        \"status_flags\": [\"production-imbalance\"]\n+      },\n+      \"L2\": {\n+        \"eid\": \"100000012\",\n+        \"timestamp\": 1708006112,\n+        \"energy_delivered\": 112342,\n+        \"energy_received\": 123452,\n+        \"active_power\": 30,\n+        \"power_factor\": 0.13,\n+        \"voltage\": 111,\n+        \"current\": 0.2,\n+        \"frequency\": 50.1,\n+        \"state\": \"enabled\",\n+        \"measurement_type\": \"production\",\n+        \"metering_status\": \"normal\",\n+        \"status_flags\": [\"power-on-unused-phase\"]\n+      },\n+      \"L3\": {\n+        \"eid\": \"100000013\",\n+        \"timestamp\": 1708006113,\n+        \"energy_delivered\": 112343,\n+        \"energy_received\": 123453,\n+        \"active_power\": 50,\n+        \"power_factor\": 0.14,\n+        \"voltage\": 111,\n+        \"current\": 0.2,\n+        \"frequency\": 50.1,\n+        \"state\": \"enabled\",\n+        \"measurement_type\": \"production\",\n+        \"metering_status\": \"normal\",\n+        \"status_flags\": []\n+      }\n+    },\n+    \"ctmeter_consumption_phases\": {\n+      \"L1\": {\n+        \"eid\": \"100000021\",\n+        \"timestamp\": 1708006121,\n+        \"energy_delivered\": 212341,\n+        \"energy_received\": 223451,\n+        \"active_power\": 21,\n+        \"power_factor\": 0.22,\n+        \"voltage\": 112,\n+        \"current\": 0.3,\n+        \"frequency\": 50.2,\n+        \"state\": \"enabled\",\n+        \"measurement_type\": \"net-consumption\",\n+        \"metering_status\": \"normal\",\n+        \"status_flags\": []\n+      },\n+      \"L2\": {\n+        \"eid\": \"100000022\",\n+        \"timestamp\": 1708006122,\n+        \"energy_delivered\": 212342,\n+        \"energy_received\": 223452,\n+        \"active_power\": 31,\n+        \"power_factor\": 0.23,\n+        \"voltage\": 112,\n+        \"current\": 0.3,\n+        \"frequency\": 50.2,\n+        \"state\": \"enabled\",\n+        \"measurement_type\": \"net-consumption\",\n+        \"metering_status\": \"normal\",\n+        \"status_flags\": []\n+      },\n+      \"L3\": {\n+        \"eid\": \"100000023\",\n+        \"timestamp\": 1708006123,\n+        \"energy_delivered\": 212343,\n+        \"energy_received\": 223453,\n+        \"active_power\": 51,\n+        \"power_factor\": 0.24,\n+        \"voltage\": 112,\n+        \"current\": 0.3,\n+        \"frequency\": 50.2,\n+        \"state\": \"enabled\",\n+        \"measurement_type\": \"net-consumption\",\n+        \"metering_status\": \"normal\",\n+        \"status_flags\": []\n+      }\n+    },\n+    \"ctmeter_storage_phases\": null,\n+    \"dry_contact_status\": {},\n+    \"dry_contact_settings\": {},\n+    \"inverters\": {\n+      \"1\": {\n+        \"serial_number\": \"1\",\n+        \"last_report_date\": 1,\n+        \"last_report_watts\": 1,\n+        \"max_report_watts\": 1\n+      }\n+    },\n+    \"tariff\": {\n+      \"currency\": {\n+        \"code\": \"EUR\"\n+      },\n+      \"logger\": \"mylogger\",\n+      \"date\": \"1714749724\",\n+      \"storage_settings\": {\n+        \"mode\": \"self-consumption\",\n+        \"operation_mode_sub_type\": \"\",\n+        \"reserved_soc\": 0.0,\n+        \"very_low_soc\": 5,\n+        \"charge_from_grid\": true,\n+        \"date\": \"1714749724\"\n+      },\n+      \"single_rate\": {\n+        \"rate\": 0.0,\n+        \"sell\": 0.0\n+      },\n+      \"seasons\": [\n+        {\n+          \"id\": \"all_year_long\",\n+          \"start\": \"1/1\",\n+          \"days\": [\n+            {\n+              \"id\": \"all_days\",\n+              \"days\": \"Mon,Tue,Wed,Thu,Fri,Sat,Sun\",\n+              \"must_charge_start\": 0,\n+              \"must_charge_duration\": 0,\n+              \"must_charge_mode\": \"CP\",\n+              \"enable_discharge_to_grid\": false,\n+              \"periods\": [\n+                {\n+                  \"id\": \"period_1\",\n+                  \"start\": 0,\n+                  \"rate\": 0.0\n+                }\n+              ]\n+            }\n+          ],\n+          \"tiers\": []\n+        }\n+      ],\n+      \"seasons_sell\": []\n+    },\n+    \"raw\": {\n+      \"varies_by\": \"firmware_version\"\n+    }\n+  }\n+}\ndiff --git a/tests/components/enphase_envoy/snapshots/test_sensor.ambr b/tests/components/enphase_envoy/snapshots/test_sensor.ambr\nindex c43325a639d83c..d6a523a3e15924 100644\n--- a/tests/components/enphase_envoy/snapshots/test_sensor.ambr\n+++ b/tests/components/enphase_envoy/snapshots/test_sensor.ambr\n@@ -1838,6 +1838,4860 @@\n     'state': '1970-01-01T00:00:01+00:00',\n   })\n # ---\n+# name: test_sensor[envoy_acb_batt][sensor.acb_1234_battery-entry]\n+  EntityRegistryEntrySnapshot({\n+    'aliases': set({\n+    }),\n+    'area_id': None,\n+    'capabilities': None,\n+    'config_entry_id': <ANY>,\n+    'device_class': None,\n+    'device_id': <ANY>,\n+    'disabled_by': None,\n+    'domain': 'sensor',\n+    'entity_category': None,\n+    'entity_id': 'sensor.acb_1234_battery',\n+    'has_entity_name': True,\n+    'hidden_by': None,\n+    'icon': None,\n+    'id': <ANY>,\n+    'labels': set({\n+    }),\n+    'name': None,\n+    'options': dict({\n+    }),\n+    'original_device_class': <SensorDeviceClass.BATTERY: 'battery'>,\n+    'original_icon': None,\n+    'original_name': 'Battery',\n+    'platform': 'enphase_envoy',\n+    'previous_unique_id': None,\n+    'supported_features': 0,\n+    'translation_key': None,\n+    'unique_id': '1234_acb_soc',\n+    'unit_of_measurement': '%',\n+  })\n+# ---\n+# name: test_sensor[envoy_acb_batt][sensor.acb_1234_battery-state]\n+  StateSnapshot({\n+    'attributes': ReadOnlyDict({\n+      'device_class': 'battery',\n+      'friendly_name': 'ACB 1234 Battery',\n+      'unit_of_measurement': '%',\n+    }),\n+    'context': <ANY>,\n+    'entity_id': 'sensor.acb_1234_battery',\n+    'last_changed': <ANY>,\n+    'last_reported': <ANY>,\n+    'last_updated': <ANY>,\n+    'state': '25',\n+  })\n+# ---\n+# name: test_sensor[envoy_acb_batt][sensor.acb_1234_battery_state-entry]\n+  EntityRegistryEntrySnapshot({\n+    'aliases': set({\n+    }),\n+    'area_id': None,\n+    'capabilities': dict({\n+      'options': list([\n+        'discharging',\n+        'idle',\n+        'charging',\n+        'full',\n+      ]),\n+    }),\n+    'config_entry_id': <ANY>,\n+    'device_class': None,\n+    'device_id': <ANY>,\n+    'disabled_by': None,\n+    'domain': 'sensor',\n+    'entity_category': None,\n+    'entity_id': 'sensor.acb_1234_battery_state',\n+    'has_entity_name': True,\n+    'hidden_by': None,\n+    'icon': None,\n+    'id': <ANY>,\n+    'labels': set({\n+    }),\n+    'name': None,\n+    'options': dict({\n+    }),\n+    'original_device_class': <SensorDeviceClass.ENUM: 'enum'>,\n+    'original_icon': None,\n+    'original_name': 'Battery state',\n+    'platform': 'enphase_envoy',\n+    'previous_unique_id': None,\n+    'supported_features': 0,\n+    'translation_key': 'acb_battery_state',\n+    'unique_id': '1234_acb_battery_state',\n+    'unit_of_measurement': None,\n+  })\n+# ---\n+# name: test_sensor[envoy_acb_batt][sensor.acb_1234_battery_state-state]\n+  StateSnapshot({\n+    'attributes': ReadOnlyDict({\n+      'device_class': 'enum',\n+      'friendly_name': 'ACB 1234 Battery state',\n+      'options': list([\n+        'discharging',\n+        'idle',\n+        'charging',\n+        'full',\n+      ]),\n+    }),\n+    'context': <ANY>,\n+    'entity_id': 'sensor.acb_1234_battery_state',\n+    'last_changed': <ANY>,\n+    'last_reported': <ANY>,\n+    'last_updated': <ANY>,\n+    'state': 'discharging',\n+  })\n+# ---\n+# name: test_sensor[envoy_acb_batt][sensor.acb_1234_power-entry]\n+  EntityRegistryEntrySnapshot({\n+    'aliases': set({\n+    }),\n+    'area_id': None,\n+    'capabilities': None,\n+    'config_entry_id': <ANY>,\n+    'device_class': None,\n+    'device_id': <ANY>,\n+    'disabled_by': None,\n+    'domain': 'sensor',\n+    'entity_category': None,\n+    'entity_id': 'sensor.acb_1234_power',\n+    'has_entity_name': True,\n+    'hidden_by': None,\n+    'icon': None,\n+    'id': <ANY>,\n+    'labels': set({\n+    }),\n+    'name': None,\n+    'options': dict({\n+    }),\n+    'original_device_class': <SensorDeviceClass.POWER: 'power'>,\n+    'original_icon': None,\n+    'original_name': 'Power',\n+    'platform': 'enphase_envoy',\n+    'previous_unique_id': None,\n+    'supported_features': 0,\n+    'translation_key': None,\n+    'unique_id': '1234_acb_power',\n+    'unit_of_measurement': <UnitOfPower.WATT: 'W'>,\n+  })\n+# ---\n+# name: test_sensor[envoy_acb_batt][sensor.acb_1234_power-state]\n+  StateSnapshot({\n+    'attributes': ReadOnlyDict({\n+      'device_class': 'power',\n+      'friendly_name': 'ACB 1234 Power',\n+      'unit_of_measurement': <UnitOfPower.WATT: 'W'>,\n+    }),\n+    'context': <ANY>,\n+    'entity_id': 'sensor.acb_1234_power',\n+    'last_changed': <ANY>,\n+    'last_reported': <ANY>,\n+    'last_updated': <ANY>,\n+    'state': '260',\n+  })\n+# ---\n+# name: test_sensor[envoy_acb_batt][sensor.encharge_123456_apparent_power-entry]\n+  EntityRegistryEntrySnapshot({\n+    'aliases': set({\n+    }),\n+    'area_id': None,\n+    'capabilities': None,\n+    'config_entry_id': <ANY>,\n+    'device_class': None,\n+    'device_id': <ANY>,\n+    'disabled_by': None,\n+    'domain': 'sensor',\n+    'entity_category': None,\n+    'entity_id': 'sensor.encharge_123456_apparent_power',\n+    'has_entity_name': True,\n+    'hidden_by': None,\n+    'icon': None,\n+    'id': <ANY>,\n+    'labels': set({\n+    }),\n+    'name': None,\n+    'options': dict({\n+    }),\n+    'original_device_class': <SensorDeviceClass.APPARENT_POWER: 'apparent_power'>,\n+    'original_icon': None,\n+    'original_name': 'Apparent power',\n+    'platform': 'enphase_envoy',\n+    'previous_unique_id': None,\n+    'supported_features': 0,\n+    'translation_key': None,\n+    'unique_id': '123456_apparent_power_mva',\n+    'unit_of_measurement': <UnitOfApparentPower.VOLT_AMPERE: 'VA'>,\n+  })\n+# ---\n+# name: test_sensor[envoy_acb_batt][sensor.encharge_123456_apparent_power-state]\n+  StateSnapshot({\n+    'attributes': ReadOnlyDict({\n+      'device_class': 'apparent_power',\n+      'friendly_name': 'Encharge 123456 Apparent power',\n+      'unit_of_measurement': <UnitOfApparentPower.VOLT_AMPERE: 'VA'>,\n+    }),\n+    'context': <ANY>,\n+    'entity_id': 'sensor.encharge_123456_apparent_power',\n+    'last_changed': <ANY>,\n+    'last_reported': <ANY>,\n+    'last_updated': <ANY>,\n+    'state': '0.105',\n+  })\n+# ---\n+# name: test_sensor[envoy_acb_batt][sensor.encharge_123456_battery-entry]\n+  EntityRegistryEntrySnapshot({\n+    'aliases': set({\n+    }),\n+    'area_id': None,\n+    'capabilities': None,\n+    'config_entry_id': <ANY>,\n+    'device_class': None,\n+    'device_id': <ANY>,\n+    'disabled_by': None,\n+    'domain': 'sensor',\n+    'entity_category': None,\n+    'entity_id': 'sensor.encharge_123456_battery',\n+    'has_entity_name': True,\n+    'hidden_by': None,\n+    'icon': None,\n+    'id': <ANY>,\n+    'labels': set({\n+    }),\n+    'name': None,\n+    'options': dict({\n+    }),\n+    'original_device_class': <SensorDeviceClass.BATTERY: 'battery'>,\n+    'original_icon': None,\n+    'original_name': 'Battery',\n+    'platform': 'enphase_envoy',\n+    'previous_unique_id': None,\n+    'supported_features': 0,\n+    'translation_key': None,\n+    'unique_id': '123456_soc',\n+    'unit_of_measurement': '%',\n+  })\n+# ---\n+# name: test_sensor[envoy_acb_batt][sensor.encharge_123456_battery-state]\n+  StateSnapshot({\n+    'attributes': ReadOnlyDict({\n+      'device_class': 'battery',\n+      'friendly_name': 'Encharge 123456 Battery',\n+      'unit_of_measurement': '%',\n+    }),\n+    'context': <ANY>,\n+    'entity_id': 'sensor.encharge_123456_battery',\n+    'last_changed': <ANY>,\n+    'last_reported': <ANY>,\n+    'last_updated': <ANY>,\n+    'state': '54',\n+  })\n+# ---\n+# name: test_sensor[envoy_acb_batt][sensor.encharge_123456_last_reported-entry]\n+  EntityRegistryEntrySnapshot({\n+    'aliases': set({\n+    }),\n+    'area_id': None,\n+    'capabilities': None,\n+    'config_entry_id': <ANY>,\n+    'device_class': None,\n+    'device_id': <ANY>,\n+    'disabled_by': None,\n+    'domain': 'sensor',\n+    'entity_category': None,\n+    'entity_id': 'sensor.encharge_123456_last_reported',\n+    'has_entity_name': True,\n+    'hidden_by': None,\n+    'icon': None,\n+    'id': <ANY>,\n+    'labels': set({\n+    }),\n+    'name': None,\n+    'options': dict({\n+    }),\n+    'original_device_class': <SensorDeviceClass.TIMESTAMP: 'timestamp'>,\n+    'original_icon': None,\n+    'original_name': 'Last reported',\n+    'platform': 'enphase_envoy',\n+    'previous_unique_id': None,\n+    'supported_features': 0,\n+    'translation_key': 'last_reported',\n+    'unique_id': '123456_last_reported',\n+    'unit_of_measurement': None,\n+  })\n+# ---\n+# name: test_sensor[envoy_acb_batt][sensor.encharge_123456_last_reported-state]\n+  StateSnapshot({\n+    'attributes': ReadOnlyDict({\n+      'device_class': 'timestamp',\n+      'friendly_name': 'Encharge 123456 Last reported',\n+    }),\n+    'context': <ANY>,\n+    'entity_id': 'sensor.encharge_123456_last_reported',\n+    'last_changed': <ANY>,\n+    'last_reported': <ANY>,\n+    'last_updated': <ANY>,\n+    'state': '2024-05-04T06:29:33+00:00',\n+  })\n+# ---\n+# name: test_sensor[envoy_acb_batt][sensor.encharge_123456_power-entry]\n+  EntityRegistryEntrySnapshot({\n+    'aliases': set({\n+    }),\n+    'area_id': None,\n+    'capabilities': None,\n+    'config_entry_id': <ANY>,\n+    'device_class': None,\n+    'device_id': <ANY>,\n+    'disabled_by': None,\n+    'domain': 'sensor',\n+    'entity_category': None,\n+    'entity_id': 'sensor.encharge_123456_power',\n+    'has_entity_name': True,\n+    'hidden_by': None,\n+    'icon': None,\n+    'id': <ANY>,\n+    'labels': set({\n+    }),\n+    'name': None,\n+    'options': dict({\n+    }),\n+    'original_device_class': <SensorDeviceClass.POWER: 'power'>,\n+    'original_icon': None,\n+    'original_name': 'Power',\n+    'platform': 'enphase_envoy',\n+    'previous_unique_id': None,\n+    'supported_features': 0,\n+    'translation_key': None,\n+    'unique_id': '123456_real_power_mw',\n+    'unit_of_measurement': <UnitOfPower.WATT: 'W'>,\n+  })\n+# ---\n+# name: test_sensor[envoy_acb_batt][sensor.encharge_123456_power-state]\n+  StateSnapshot({\n+    'attributes': ReadOnlyDict({\n+      'device_class': 'power',\n+      'friendly_name': 'Encharge 123456 Power',\n+      'unit_of_measurement': <UnitOfPower.WATT: 'W'>,\n+    }),\n+    'context': <ANY>,\n+    'entity_id': 'sensor.encharge_123456_power',\n+    'last_changed': <ANY>,\n+    'last_reported': <ANY>,\n+    'last_updated': <ANY>,\n+    'state': '0.105',\n+  })\n+# ---\n+# name: test_sensor[envoy_acb_batt][sensor.encharge_123456_temperature-entry]\n+  EntityRegistryEntrySnapshot({\n+    'aliases': set({\n+    }),\n+    'area_id': None,\n+    'capabilities': None,\n+    'config_entry_id': <ANY>,\n+    'device_class': None,\n+    'device_id': <ANY>,\n+    'disabled_by': None,\n+    'domain': 'sensor',\n+    'entity_category': None,\n+    'entity_id': 'sensor.encharge_123456_temperature',\n+    'has_entity_name': True,\n+    'hidden_by': None,\n+    'icon': None,\n+    'id': <ANY>,\n+    'labels': set({\n+    }),\n+    'name': None,\n+    'options': dict({\n+    }),\n+    'original_device_class': <SensorDeviceClass.TEMPERATURE: 'temperature'>,\n+    'original_icon': None,\n+    'original_name': 'Temperature',\n+    'platform': 'enphase_envoy',\n+    'previous_unique_id': None,\n+    'supported_features': 0,\n+    'translation_key': None,\n+    'unique_id': '123456_temperature',\n+    'unit_of_measurement': <UnitOfTemperature.CELSIUS: '\u00b0C'>,\n+  })\n+# ---\n+# name: test_sensor[envoy_acb_batt][sensor.encharge_123456_temperature-state]\n+  StateSnapshot({\n+    'attributes': ReadOnlyDict({\n+      'device_class': 'temperature',\n+      'friendly_name': 'Encharge 123456 Temperature',\n+      'unit_of_measurement': <UnitOfTemperature.CELSIUS: '\u00b0C'>,\n+    }),\n+    'context': <ANY>,\n+    'entity_id': 'sensor.encharge_123456_temperature',\n+    'last_changed': <ANY>,\n+    'last_reported': <ANY>,\n+    'last_updated': <ANY>,\n+    'state': '16',\n+  })\n+# ---\n+# name: test_sensor[envoy_acb_batt][sensor.envoy_1234_aggregated_available_battery_energy-entry]\n+  EntityRegistryEntrySnapshot({\n+    'aliases': set({\n+    }),\n+    'area_id': None,\n+    'capabilities': None,\n+    'config_entry_id': <ANY>,\n+    'device_class': None,\n+    'device_id': <ANY>,\n+    'disabled_by': None,\n+    'domain': 'sensor',\n+    'entity_category': None,\n+    'entity_id': 'sensor.envoy_1234_aggregated_available_battery_energy',\n+    'has_entity_name': True,\n+    'hidden_by': None,\n+    'icon': None,\n+    'id': <ANY>,\n+    'labels': set({\n+    }),\n+    'name': None,\n+    'options': dict({\n+    }),\n+    'original_device_class': <SensorDeviceClass.ENERGY_STORAGE: 'energy_storage'>,\n+    'original_icon': 'mdi:flash',\n+    'original_name': 'Aggregated available battery energy',\n+    'platform': 'enphase_envoy',\n+    'previous_unique_id': None,\n+    'supported_features': 0,\n+    'translation_key': 'aggregated_available_energy',\n+    'unique_id': '1234_aggregated_available_energy',\n+    'unit_of_measurement': <UnitOfEnergy.WATT_HOUR: 'Wh'>,\n+  })\n+# ---\n+# name: test_sensor[envoy_acb_batt][sensor.envoy_1234_aggregated_available_battery_energy-state]\n+  StateSnapshot({\n+    'attributes': ReadOnlyDict({\n+      'device_class': 'energy_storage',\n+      'friendly_name': 'Envoy 1234 Aggregated available battery energy',\n+      'icon': 'mdi:flash',\n+      'unit_of_measurement': <UnitOfEnergy.WATT_HOUR: 'Wh'>,\n+    }),\n+    'context': <ANY>,\n+    'entity_id': 'sensor.envoy_1234_aggregated_available_battery_energy',\n+    'last_changed': <ANY>,\n+    'last_reported': <ANY>,\n+    'last_updated': <ANY>,\n+    'state': '2820',\n+  })\n+# ---\n+# name: test_sensor[envoy_acb_batt][sensor.envoy_1234_aggregated_battery_capacity-entry]\n+  EntityRegistryEntrySnapshot({\n+    'aliases': set({\n+    }),\n+    'area_id': None,\n+    'capabilities': None,\n+    'config_entry_id': <ANY>,\n+    'device_class': None,\n+    'device_id': <ANY>,\n+    'disabled_by': None,\n+    'domain': 'sensor',\n+    'entity_category': None,\n+    'entity_id': 'sensor.envoy_1234_aggregated_battery_capacity',\n+    'has_entity_name': True,\n+    'hidden_by': None,\n+    'icon': None,\n+    'id': <ANY>,\n+    'labels': set({\n+    }),\n+    'name': None,\n+    'options': dict({\n+    }),\n+    'original_device_class': <SensorDeviceClass.ENERGY_STORAGE: 'energy_storage'>,\n+    'original_icon': 'mdi:flash',\n+    'original_name': 'Aggregated Battery capacity',\n+    'platform': 'enphase_envoy',\n+    'previous_unique_id': None,\n+    'supported_features': 0,\n+    'translation_key': 'aggregated_max_capacity',\n+    'unique_id': '1234_aggregated_max_battery_capacity',\n+    'unit_of_measurement': <UnitOfEnergy.WATT_HOUR: 'Wh'>,\n+  })\n+# ---\n+# name: test_sensor[envoy_acb_batt][sensor.envoy_1234_aggregated_battery_capacity-state]\n+  StateSnapshot({\n+    'attributes': ReadOnlyDict({\n+      'device_class': 'energy_storage',\n+      'friendly_name': 'Envoy 1234 Aggregated Battery capacity',\n+      'icon': 'mdi:flash',\n+      'unit_of_measurement': <UnitOfEnergy.WATT_HOUR: 'Wh'>,\n+    }),\n+    'context': <ANY>,\n+    'entity_id': 'sensor.envoy_1234_aggregated_battery_capacity',\n+    'last_changed': <ANY>,\n+    'last_reported': <ANY>,\n+    'last_updated': <ANY>,\n+    'state': '7220',\n+  })\n+# ---\n+# name: test_sensor[envoy_acb_batt][sensor.envoy_1234_aggregated_battery_soc-entry]\n+  EntityRegistryEntrySnapshot({\n+    'aliases': set({\n+    }),\n+    'area_id': None,\n+    'capabilities': None,\n+    'config_entry_id': <ANY>,\n+    'device_class': None,\n+    'device_id': <ANY>,\n+    'disabled_by': None,\n+    'domain': 'sensor',\n+    'entity_category': None,\n+    'entity_id': 'sensor.envoy_1234_aggregated_battery_soc',\n+    'has_entity_name': True,\n+    'hidden_by': None,\n+    'icon': None,\n+    'id': <ANY>,\n+    'labels': set({\n+    }),\n+    'name': None,\n+    'options': dict({\n+    }),\n+    'original_device_class': <SensorDeviceClass.BATTERY: 'battery'>,\n+    'original_icon': 'mdi:flash',\n+    'original_name': 'Aggregated battery soc',\n+    'platform': 'enphase_envoy',\n+    'previous_unique_id': None,\n+    'supported_features': 0,\n+    'translation_key': 'aggregated_soc',\n+    'unique_id': '1234_aggregated_soc',\n+    'unit_of_measurement': '%',\n+  })\n+# ---\n+# name: test_sensor[envoy_acb_batt][sensor.envoy_1234_aggregated_battery_soc-state]\n+  StateSnapshot({\n+    'attributes': ReadOnlyDict({\n+      'device_class': 'battery',\n+      'friendly_name': 'Envoy 1234 Aggregated battery soc',\n+      'icon': 'mdi:flash',\n+      'unit_of_measurement': '%',\n+    }),\n+    'context': <ANY>,\n+    'entity_id': 'sensor.envoy_1234_aggregated_battery_soc',\n+    'last_changed': <ANY>,\n+    'last_reported': <ANY>,\n+    'last_updated': <ANY>,\n+    'state': '39',\n+  })\n+# ---\n+# name: test_sensor[envoy_acb_batt][sensor.envoy_1234_available_acb_battery_energy-entry]\n+  EntityRegistryEntrySnapshot({\n+    'aliases': set({\n+    }),\n+    'area_id': None,\n+    'capabilities': None,\n+    'config_entry_id': <ANY>,\n+    'device_class': None,\n+    'device_id': <ANY>,\n+    'disabled_by': None,\n+    'domain': 'sensor',\n+    'entity_category': None,\n+    'entity_id': 'sensor.envoy_1234_available_acb_battery_energy',\n+    'has_entity_name': True,\n+    'hidden_by': None,\n+    'icon': None,\n+    'id': <ANY>,\n+    'labels': set({\n+    }),\n+    'name': None,\n+    'options': dict({\n+    }),\n+    'original_device_class': <SensorDeviceClass.ENERGY_STORAGE: 'energy_storage'>,\n+    'original_icon': 'mdi:flash',\n+    'original_name': 'Available ACB battery energy',\n+    'platform': 'enphase_envoy',\n+    'previous_unique_id': None,\n+    'supported_features': 0,\n+    'translation_key': 'acb_available_energy',\n+    'unique_id': '1234_acb_available_energy',\n+    'unit_of_measurement': <UnitOfEnergy.WATT_HOUR: 'Wh'>,\n+  })\n+# ---\n+# name: test_sensor[envoy_acb_batt][sensor.envoy_1234_available_acb_battery_energy-state]\n+  StateSnapshot({\n+    'attributes': ReadOnlyDict({\n+      'device_class': 'energy_storage',\n+      'friendly_name': 'Envoy 1234 Available ACB battery energy',\n+      'icon': 'mdi:flash',\n+      'unit_of_measurement': <UnitOfEnergy.WATT_HOUR: 'Wh'>,\n+    }),\n+    'context': <ANY>,\n+    'entity_id': 'sensor.envoy_1234_available_acb_battery_energy',\n+    'last_changed': <ANY>,\n+    'last_reported': <ANY>,\n+    'last_updated': <ANY>,\n+    'state': '930',\n+  })\n+# ---\n+# name: test_sensor[envoy_acb_batt][sensor.envoy_1234_available_battery_energy-entry]\n+  EntityRegistryEntrySnapshot({\n+    'aliases': set({\n+    }),\n+    'area_id': None,\n+    'capabilities': None,\n+    'config_entry_id': <ANY>,\n+    'device_class': None,\n+    'device_id': <ANY>,\n+    'disabled_by': None,\n+    'domain': 'sensor',\n+    'entity_category': None,\n+    'entity_id': 'sensor.envoy_1234_available_battery_energy',\n+    'has_entity_name': True,\n+    'hidden_by': None,\n+    'icon': None,\n+    'id': <ANY>,\n+    'labels': set({\n+    }),\n+    'name': None,\n+    'options': dict({\n+    }),\n+    'original_device_class': <SensorDeviceClass.ENERGY: 'energy'>,\n+    'original_icon': 'mdi:flash',\n+    'original_name': 'Available battery energy',\n+    'platform': 'enphase_envoy',\n+    'previous_unique_id': None,\n+    'supported_features': 0,\n+    'translation_key': 'available_energy',\n+    'unique_id': '1234_available_energy',\n+    'unit_of_measurement': <UnitOfEnergy.WATT_HOUR: 'Wh'>,\n+  })\n+# ---\n+# name: test_sensor[envoy_acb_batt][sensor.envoy_1234_available_battery_energy-state]\n+  StateSnapshot({\n+    'attributes': ReadOnlyDict({\n+      'device_class': 'energy',\n+      'friendly_name': 'Envoy 1234 Available battery energy',\n+      'icon': 'mdi:flash',\n+      'unit_of_measurement': <UnitOfEnergy.WATT_HOUR: 'Wh'>,\n+    }),\n+    'context': <ANY>,\n+    'entity_id': 'sensor.envoy_1234_available_battery_energy',\n+    'last_changed': <ANY>,\n+    'last_reported': <ANY>,\n+    'last_updated': <ANY>,\n+    'state': '1890',\n+  })\n+# ---\n+# name: test_sensor[envoy_acb_batt][sensor.envoy_1234_balanced_net_power_consumption-entry]\n+  EntityRegistryEntrySnapshot({\n+    'aliases': set({\n+    }),\n+    'area_id': None,\n+    'capabilities': dict({\n+      'state_class': <SensorStateClass.MEASUREMENT: 'measurement'>,\n+    }),\n+    'config_entry_id': <ANY>,\n+    'device_class': None,\n+    'device_id': <ANY>,\n+    'disabled_by': None,\n+    'domain': 'sensor',\n+    'entity_category': None,\n+    'entity_id': 'sensor.envoy_1234_balanced_net_power_consumption',\n+    'has_entity_name': True,\n+    'hidden_by': None,\n+    'icon': None,\n+    'id': <ANY>,\n+    'labels': set({\n+    }),\n+    'name': None,\n+    'options': dict({\n+      'sensor': dict({\n+        'suggested_display_precision': 3,\n+      }),\n+      'sensor.private': dict({\n+        'suggested_unit_of_measurement': <UnitOfPower.KILO_WATT: 'kW'>,\n+      }),\n+    }),\n+    'original_device_class': <SensorDeviceClass.POWER: 'power'>,\n+    'original_icon': 'mdi:flash',\n+    'original_name': 'balanced net power consumption',\n+    'platform': 'enphase_envoy',\n+    'previous_unique_id': None,\n+    'supported_features': 0,\n+    'translation_key': 'balanced_net_consumption',\n+    'unique_id': '1234_balanced_net_consumption',\n+    'unit_of_measurement': <UnitOfPower.KILO_WATT: 'kW'>,\n+  })\n+# ---\n+# name: test_sensor[envoy_acb_batt][sensor.envoy_1234_balanced_net_power_consumption-state]\n+  StateSnapshot({\n+    'attributes': ReadOnlyDict({\n+      'device_class': 'power',\n+      'friendly_name': 'Envoy 1234 balanced net power consumption',\n+      'icon': 'mdi:flash',\n+      'state_class': <SensorStateClass.MEASUREMENT: 'measurement'>,\n+      'unit_of_measurement': <UnitOfPower.KILO_WATT: 'kW'>,\n+    }),\n+    'context': <ANY>,\n+    'entity_id': 'sensor.envoy_1234_balanced_net_power_consumption',\n+    'last_changed': <ANY>,\n+    'last_reported': <ANY>,\n+    'last_updated': <ANY>,\n+    'state': '2.341',\n+  })\n+# ---\n+# name: test_sensor[envoy_acb_batt][sensor.envoy_1234_battery-entry]\n+  EntityRegistryEntrySnapshot({\n+    'aliases': set({\n+    }),\n+    'area_id': None,\n+    'capabilities': None,\n+    'config_entry_id': <ANY>,\n+    'device_class': None,\n+    'device_id': <ANY>,\n+    'disabled_by': None,\n+    'domain': 'sensor',\n+    'entity_category': None,\n+    'entity_id': 'sensor.envoy_1234_battery',\n+    'has_entity_name': True,\n+    'hidden_by': None,\n+    'icon': None,\n+    'id': <ANY>,\n+    'labels': set({\n+    }),\n+    'name': None,\n+    'options': dict({\n+    }),\n+    'original_device_class': <SensorDeviceClass.BATTERY: 'battery'>,\n+    'original_icon': 'mdi:flash',\n+    'original_name': 'Battery',\n+    'platform': 'enphase_envoy',\n+    'previous_unique_id': None,\n+    'supported_features': 0,\n+    'translation_key': None,\n+    'unique_id': '1234_battery_level',\n+    'unit_of_measurement': '%',\n+  })\n+# ---\n+# name: test_sensor[envoy_acb_batt][sensor.envoy_1234_battery-state]\n+  StateSnapshot({\n+    'attributes': ReadOnlyDict({\n+      'device_class': 'battery',\n+      'friendly_name': 'Envoy 1234 Battery',\n+      'icon': 'mdi:flash',\n+      'unit_of_measurement': '%',\n+    }),\n+    'context': <ANY>,\n+    'entity_id': 'sensor.envoy_1234_battery',\n+    'last_changed': <ANY>,\n+    'last_reported': <ANY>,\n+    'last_updated': <ANY>,\n+    'state': '54',\n+  })\n+# ---\n+# name: test_sensor[envoy_acb_batt][sensor.envoy_1234_battery_capacity-entry]\n+  EntityRegistryEntrySnapshot({\n+    'aliases': set({\n+    }),\n+    'area_id': None,\n+    'capabilities': None,\n+    'config_entry_id': <ANY>,\n+    'device_class': None,\n+    'device_id': <ANY>,\n+    'disabled_by': None,\n+    'domain': 'sensor',\n+    'entity_category': None,\n+    'entity_id': 'sensor.envoy_1234_battery_capacity',\n+    'has_entity_name': True,\n+    'hidden_by': None,\n+    'icon': None,\n+    'id': <ANY>,\n+    'labels': set({\n+    }),\n+    'name': None,\n+    'options': dict({\n+    }),\n+    'original_device_class': <SensorDeviceClass.ENERGY: 'energy'>,\n+    'original_icon': 'mdi:flash',\n+    'original_name': 'Battery capacity',\n+    'platform': 'enphase_envoy',\n+    'previous_unique_id': None,\n+    'supported_features': 0,\n+    'translation_key': 'max_capacity',\n+    'unique_id': '1234_max_capacity',\n+    'unit_of_measurement': <UnitOfEnergy.WATT_HOUR: 'Wh'>,\n+  })\n+# ---\n+# name: test_sensor[envoy_acb_batt][sensor.envoy_1234_battery_capacity-state]\n+  StateSnapshot({\n+    'attributes': ReadOnlyDict({\n+      'device_class': 'energy',\n+      'friendly_name': 'Envoy 1234 Battery capacity',\n+      'icon': 'mdi:flash',\n+      'unit_of_measurement': <UnitOfEnergy.WATT_HOUR: 'Wh'>,\n+    }),\n+    'context': <ANY>,\n+    'entity_id': 'sensor.envoy_1234_battery_capacity',\n+    'last_changed': <ANY>,\n+    'last_reported': <ANY>,\n+    'last_updated': <ANY>,\n+    'state': '3500',\n+  })\n+# ---\n+# name: test_sensor[envoy_acb_batt][sensor.envoy_1234_current_net_power_consumption-entry]\n+  EntityRegistryEntrySnapshot({\n+    'aliases': set({\n+    }),\n+    'area_id': None,\n+    'capabilities': dict({\n+      'state_class': <SensorStateClass.MEASUREMENT: 'measurement'>,\n+    }),\n+    'config_entry_id': <ANY>,\n+    'device_class': None,\n+    'device_id': <ANY>,\n+    'disabled_by': None,\n+    'domain': 'sensor',\n+    'entity_category': None,\n+    'entity_id': 'sensor.envoy_1234_current_net_power_consumption',\n+    'has_entity_name': True,\n+    'hidden_by': None,\n+    'icon': None,\n+    'id': <ANY>,\n+    'labels': set({\n+    }),\n+    'name': None,\n+    'options': dict({\n+      'sensor': dict({\n+        'suggested_display_precision': 3,\n+      }),\n+      'sensor.private': dict({\n+        'suggested_unit_of_measurement': <UnitOfPower.KILO_WATT: 'kW'>,\n+      }),\n+    }),\n+    'original_device_class': <SensorDeviceClass.POWER: 'power'>,\n+    'original_icon': 'mdi:flash',\n+    'original_name': 'Current net power consumption',\n+    'platform': 'enphase_envoy',\n+    'previous_unique_id': None,\n+    'supported_features': 0,\n+    'translation_key': 'net_consumption',\n+    'unique_id': '1234_net_consumption',\n+    'unit_of_measurement': <UnitOfPower.KILO_WATT: 'kW'>,\n+  })\n+# ---\n+# name: test_sensor[envoy_acb_batt][sensor.envoy_1234_current_net_power_consumption-state]\n+  StateSnapshot({\n+    'attributes': ReadOnlyDict({\n+      'device_class': 'power',\n+      'friendly_name': 'Envoy 1234 Current net power consumption',\n+      'icon': 'mdi:flash',\n+      'state_class': <SensorStateClass.MEASUREMENT: 'measurement'>,\n+      'unit_of_measurement': <UnitOfPower.KILO_WATT: 'kW'>,\n+    }),\n+    'context': <ANY>,\n+    'entity_id': 'sensor.envoy_1234_current_net_power_consumption',\n+    'last_changed': <ANY>,\n+    'last_reported': <ANY>,\n+    'last_updated': <ANY>,\n+    'state': '0.101',\n+  })\n+# ---\n+# name: test_sensor[envoy_acb_batt][sensor.envoy_1234_current_net_power_consumption_l1-entry]\n+  EntityRegistryEntrySnapshot({\n+    'aliases': set({\n+    }),\n+    'area_id': None,\n+    'capabilities': dict({\n+      'state_class': <SensorStateClass.MEASUREMENT: 'measurement'>,\n+    }),\n+    'config_entry_id': <ANY>,\n+    'device_class': None,\n+    'device_id': <ANY>,\n+    'disabled_by': None,\n+    'domain': 'sensor',\n+    'entity_category': None,\n+    'entity_id': 'sensor.envoy_1234_current_net_power_consumption_l1',\n+    'has_entity_name': True,\n+    'hidden_by': None,\n+    'icon': None,\n+    'id': <ANY>,\n+    'labels': set({\n+    }),\n+    'name': None,\n+    'options': dict({\n+      'sensor': dict({\n+        'suggested_display_precision': 3,\n+      }),\n+      'sensor.private': dict({\n+        'suggested_unit_of_measurement': <UnitOfPower.KILO_WATT: 'kW'>,\n+      }),\n+    }),\n+    'original_device_class': <SensorDeviceClass.POWER: 'power'>,\n+    'original_icon': 'mdi:flash',\n+    'original_name': 'Current net power consumption l1',\n+    'platform': 'enphase_envoy',\n+    'previous_unique_id': None,\n+    'supported_features': 0,\n+    'translation_key': 'net_consumption_phase',\n+    'unique_id': '1234_net_consumption_l1',\n+    'unit_of_measurement': <UnitOfPower.KILO_WATT: 'kW'>,\n+  })\n+# ---\n+# name: test_sensor[envoy_acb_batt][sensor.envoy_1234_current_net_power_consumption_l1-state]\n+  StateSnapshot({\n+    'attributes': ReadOnlyDict({\n+      'device_class': 'power',\n+      'friendly_name': 'Envoy 1234 Current net power consumption l1',\n+      'icon': 'mdi:flash',\n+      'state_class': <SensorStateClass.MEASUREMENT: 'measurement'>,\n+      'unit_of_measurement': <UnitOfPower.KILO_WATT: 'kW'>,\n+    }),\n+    'context': <ANY>,\n+    'entity_id': 'sensor.envoy_1234_current_net_power_consumption_l1',\n+    'last_changed': <ANY>,\n+    'last_reported': <ANY>,\n+    'last_updated': <ANY>,\n+    'state': '0.021',\n+  })\n+# ---\n+# name: test_sensor[envoy_acb_batt][sensor.envoy_1234_current_net_power_consumption_l2-entry]\n+  EntityRegistryEntrySnapshot({\n+    'aliases': set({\n+    }),\n+    'area_id': None,\n+    'capabilities': dict({\n+      'state_class': <SensorStateClass.MEASUREMENT: 'measurement'>,\n+    }),\n+    'config_entry_id': <ANY>,\n+    'device_class': None,\n+    'device_id': <ANY>,\n+    'disabled_by': None,\n+    'domain': 'sensor',\n+    'entity_category': None,\n+    'entity_id': 'sensor.envoy_1234_current_net_power_consumption_l2',\n+    'has_entity_name': True,\n+    'hidden_by': None,\n+    'icon': None,\n+    'id': <ANY>,\n+    'labels': set({\n+    }),\n+    'name': None,\n+    'options': dict({\n+      'sensor': dict({\n+        'suggested_display_precision': 3,\n+      }),\n+      'sensor.private': dict({\n+        'suggested_unit_of_measurement': <UnitOfPower.KILO_WATT: 'kW'>,\n+      }),\n+    }),\n+    'original_device_class': <SensorDeviceClass.POWER: 'power'>,\n+    'original_icon': 'mdi:flash',\n+    'original_name': 'Current net power consumption l2',\n+    'platform': 'enphase_envoy',\n+    'previous_unique_id': None,\n+    'supported_features': 0,\n+    'translation_key': 'net_consumption_phase',\n+    'unique_id': '1234_net_consumption_l2',\n+    'unit_of_measurement': <UnitOfPower.KILO_WATT: 'kW'>,\n+  })\n+# ---\n+# name: test_sensor[envoy_acb_batt][sensor.envoy_1234_current_net_power_consumption_l2-state]\n+  StateSnapshot({\n+    'attributes': ReadOnlyDict({\n+      'device_class': 'power',\n+      'friendly_name': 'Envoy 1234 Current net power consumption l2',\n+      'icon': 'mdi:flash',\n+      'state_class': <SensorStateClass.MEASUREMENT: 'measurement'>,\n+      'unit_of_measurement': <UnitOfPower.KILO_WATT: 'kW'>,\n+    }),\n+    'context': <ANY>,\n+    'entity_id': 'sensor.envoy_1234_current_net_power_consumption_l2',\n+    'last_changed': <ANY>,\n+    'last_reported': <ANY>,\n+    'last_updated': <ANY>,\n+    'state': '0.031',\n+  })\n+# ---\n+# name: test_sensor[envoy_acb_batt][sensor.envoy_1234_current_net_power_consumption_l3-entry]\n+  EntityRegistryEntrySnapshot({\n+    'aliases': set({\n+    }),\n+    'area_id': None,\n+    'capabilities': dict({\n+      'state_class': <SensorStateClass.MEASUREMENT: 'measurement'>,\n+    }),\n+    'config_entry_id': <ANY>,\n+    'device_class': None,\n+    'device_id': <ANY>,\n+    'disabled_by': None,\n+    'domain': 'sensor',\n+    'entity_category': None,\n+    'entity_id': 'sensor.envoy_1234_current_net_power_consumption_l3',\n+    'has_entity_name': True,\n+    'hidden_by': None,\n+    'icon': None,\n+    'id': <ANY>,\n+    'labels': set({\n+    }),\n+    'name': None,\n+    'options': dict({\n+      'sensor': dict({\n+        'suggested_display_precision': 3,\n+      }),\n+      'sensor.private': dict({\n+        'suggested_unit_of_measurement': <UnitOfPower.KILO_WATT: 'kW'>,\n+      }),\n+    }),\n+    'original_device_class': <SensorDeviceClass.POWER: 'power'>,\n+    'original_icon': 'mdi:flash',\n+    'original_name': 'Current net power consumption l3',\n+    'platform': 'enphase_envoy',\n+    'previous_unique_id': None,\n+    'supported_features': 0,\n+    'translation_key': 'net_consumption_phase',\n+    'unique_id': '1234_net_consumption_l3',\n+    'unit_of_measurement': <UnitOfPower.KILO_WATT: 'kW'>,\n+  })\n+# ---\n+# name: test_sensor[envoy_acb_batt][sensor.envoy_1234_current_net_power_consumption_l3-state]\n+  StateSnapshot({\n+    'attributes': ReadOnlyDict({\n+      'device_class': 'power',\n+      'friendly_name': 'Envoy 1234 Current net power consumption l3',\n+      'icon': 'mdi:flash',\n+      'state_class': <SensorStateClass.MEASUREMENT: 'measurement'>,\n+      'unit_of_measurement': <UnitOfPower.KILO_WATT: 'kW'>,\n+    }),\n+    'context': <ANY>,\n+    'entity_id': 'sensor.envoy_1234_current_net_power_consumption_l3',\n+    'last_changed': <ANY>,\n+    'last_reported': <ANY>,\n+    'last_updated': <ANY>,\n+    'state': '0.051',\n+  })\n+# ---\n+# name: test_sensor[envoy_acb_batt][sensor.envoy_1234_current_power_consumption-entry]\n+  EntityRegistryEntrySnapshot({\n+    'aliases': set({\n+    }),\n+    'area_id': None,\n+    'capabilities': dict({\n+      'state_class': <SensorStateClass.MEASUREMENT: 'measurement'>,\n+    }),\n+    'config_entry_id': <ANY>,\n+    'device_class': None,\n+    'device_id': <ANY>,\n+    'disabled_by': None,\n+    'domain': 'sensor',\n+    'entity_category': None,\n+    'entity_id': 'sensor.envoy_1234_current_power_consumption',\n+    'has_entity_name': True,\n+    'hidden_by': None,\n+    'icon': None,\n+    'id': <ANY>,\n+    'labels': set({\n+    }),\n+    'name': None,\n+    'options': dict({\n+      'sensor': dict({\n+        'suggested_display_precision': 3,\n+      }),\n+      'sensor.private': dict({\n+        'suggested_unit_of_measurement': <UnitOfPower.KILO_WATT: 'kW'>,\n+      }),\n+    }),\n+    'original_device_class': <SensorDeviceClass.POWER: 'power'>,\n+    'original_icon': 'mdi:flash',\n+    'original_name': 'Current power consumption',\n+    'platform': 'enphase_envoy',\n+    'previous_unique_id': None,\n+    'supported_features': 0,\n+    'translation_key': 'current_power_consumption',\n+    'unique_id': '1234_consumption',\n+    'unit_of_measurement': <UnitOfPower.KILO_WATT: 'kW'>,\n+  })\n+# ---\n+# name: test_sensor[envoy_acb_batt][sensor.envoy_1234_current_power_consumption-state]\n+  StateSnapshot({\n+    'attributes': ReadOnlyDict({\n+      'device_class': 'power',\n+      'friendly_name': 'Envoy 1234 Current power consumption',\n+      'icon': 'mdi:flash',\n+      'state_class': <SensorStateClass.MEASUREMENT: 'measurement'>,\n+      'unit_of_measurement': <UnitOfPower.KILO_WATT: 'kW'>,\n+    }),\n+    'context': <ANY>,\n+    'entity_id': 'sensor.envoy_1234_current_power_consumption',\n+    'last_changed': <ANY>,\n+    'last_reported': <ANY>,\n+    'last_updated': <ANY>,\n+    'state': '1.234',\n+  })\n+# ---\n+# name: test_sensor[envoy_acb_batt][sensor.envoy_1234_current_power_production-entry]\n+  EntityRegistryEntrySnapshot({\n+    'aliases': set({\n+    }),\n+    'area_id': None,\n+    'capabilities': dict({\n+      'state_class': <SensorStateClass.MEASUREMENT: 'measurement'>,\n+    }),\n+    'config_entry_id': <ANY>,\n+    'device_class': None,\n+    'device_id': <ANY>,\n+    'disabled_by': None,\n+    'domain': 'sensor',\n+    'entity_category': None,\n+    'entity_id': 'sensor.envoy_1234_current_power_production',\n+    'has_entity_name': True,\n+    'hidden_by': None,\n+    'icon': None,\n+    'id': <ANY>,\n+    'labels': set({\n+    }),\n+    'name': None,\n+    'options': dict({\n+      'sensor': dict({\n+        'suggested_display_precision': 3,\n+      }),\n+      'sensor.private': dict({\n+        'suggested_unit_of_measurement': <UnitOfPower.KILO_WATT: 'kW'>,\n+      }),\n+    }),\n+    'original_device_class': <SensorDeviceClass.POWER: 'power'>,\n+    'original_icon': 'mdi:flash',\n+    'original_name': 'Current power production',\n+    'platform': 'enphase_envoy',\n+    'previous_unique_id': None,\n+    'supported_features': 0,\n+    'translation_key': 'current_power_production',\n+    'unique_id': '1234_production',\n+    'unit_of_measurement': <UnitOfPower.KILO_WATT: 'kW'>,\n+  })\n+# ---\n+# name: test_sensor[envoy_acb_batt][sensor.envoy_1234_current_power_production-state]\n+  StateSnapshot({\n+    'attributes': ReadOnlyDict({\n+      'device_class': 'power',\n+      'friendly_name': 'Envoy 1234 Current power production',\n+      'icon': 'mdi:flash',\n+      'state_class': <SensorStateClass.MEASUREMENT: 'measurement'>,\n+      'unit_of_measurement': <UnitOfPower.KILO_WATT: 'kW'>,\n+    }),\n+    'context': <ANY>,\n+    'entity_id': 'sensor.envoy_1234_current_power_production',\n+    'last_changed': <ANY>,\n+    'last_reported': <ANY>,\n+    'last_updated': <ANY>,\n+    'state': '1.234',\n+  })\n+# ---\n+# name: test_sensor[envoy_acb_batt][sensor.envoy_1234_energy_consumption_last_seven_days-entry]\n+  EntityRegistryEntrySnapshot({\n+    'aliases': set({\n+    }),\n+    'area_id': None,\n+    'capabilities': None,\n+    'config_entry_id': <ANY>,\n+    'device_class': None,\n+    'device_id': <ANY>,\n+    'disabled_by': None,\n+    'domain': 'sensor',\n+    'entity_category': None,\n+    'entity_id': 'sensor.envoy_1234_energy_consumption_last_seven_days',\n+    'has_entity_name': True,\n+    'hidden_by': None,\n+    'icon': None,\n+    'id': <ANY>,\n+    'labels': set({\n+    }),\n+    'name': None,\n+    'options': dict({\n+      'sensor': dict({\n+        'suggested_display_precision': 1,\n+      }),\n+      'sensor.private': dict({\n+        'suggested_unit_of_measurement': <UnitOfEnergy.KILO_WATT_HOUR: 'kWh'>,\n+      }),\n+    }),\n+    'original_device_class': <SensorDeviceClass.ENERGY: 'energy'>,\n+    'original_icon': 'mdi:flash',\n+    'original_name': 'Energy consumption last seven days',\n+    'platform': 'enphase_envoy',\n+    'previous_unique_id': None,\n+    'supported_features': 0,\n+    'translation_key': 'seven_days_consumption',\n+    'unique_id': '1234_seven_days_consumption',\n+    'unit_of_measurement': <UnitOfEnergy.KILO_WATT_HOUR: 'kWh'>,\n+  })\n+# ---\n+# name: test_sensor[envoy_acb_batt][sensor.envoy_1234_energy_consumption_last_seven_days-state]\n+  StateSnapshot({\n+    'attributes': ReadOnlyDict({\n+      'device_class': 'energy',\n+      'friendly_name': 'Envoy 1234 Energy consumption last seven days',\n+      'icon': 'mdi:flash',\n+      'unit_of_measurement': <UnitOfEnergy.KILO_WATT_HOUR: 'kWh'>,\n+    }),\n+    'context': <ANY>,\n+    'entity_id': 'sensor.envoy_1234_energy_consumption_last_seven_days',\n+    'last_changed': <ANY>,\n+    'last_reported': <ANY>,\n+    'last_updated': <ANY>,\n+    'state': '1.234',\n+  })\n+# ---\n+# name: test_sensor[envoy_acb_batt][sensor.envoy_1234_energy_consumption_today-entry]\n+  EntityRegistryEntrySnapshot({\n+    'aliases': set({\n+    }),\n+    'area_id': None,\n+    'capabilities': dict({\n+      'state_class': <SensorStateClass.TOTAL_INCREASING: 'total_increasing'>,\n+    }),\n+    'config_entry_id': <ANY>,\n+    'device_class': None,\n+    'device_id': <ANY>,\n+    'disabled_by': None,\n+    'domain': 'sensor',\n+    'entity_category': None,\n+    'entity_id': 'sensor.envoy_1234_energy_consumption_today',\n+    'has_entity_name': True,\n+    'hidden_by': None,\n+    'icon': None,\n+    'id': <ANY>,\n+    'labels': set({\n+    }),\n+    'name': None,\n+    'options': dict({\n+      'sensor': dict({\n+        'suggested_display_precision': 2,\n+      }),\n+      'sensor.private': dict({\n+        'suggested_unit_of_measurement': <UnitOfEnergy.KILO_WATT_HOUR: 'kWh'>,\n+      }),\n+    }),\n+    'original_device_class': <SensorDeviceClass.ENERGY: 'energy'>,\n+    'original_icon': 'mdi:flash',\n+    'original_name': 'Energy consumption today',\n+    'platform': 'enphase_envoy',\n+    'previous_unique_id': None,\n+    'supported_features': 0,\n+    'translation_key': 'daily_consumption',\n+    'unique_id': '1234_daily_consumption',\n+    'unit_of_measurement': <UnitOfEnergy.KILO_WATT_HOUR: 'kWh'>,\n+  })\n+# ---\n+# name: test_sensor[envoy_acb_batt][sensor.envoy_1234_energy_consumption_today-state]\n+  StateSnapshot({\n+    'attributes': ReadOnlyDict({\n+      'device_class': 'energy',\n+      'friendly_name': 'Envoy 1234 Energy consumption today',\n+      'icon': 'mdi:flash',\n+      'state_class': <SensorStateClass.TOTAL_INCREASING: 'total_increasing'>,\n+      'unit_of_measurement': <UnitOfEnergy.KILO_WATT_HOUR: 'kWh'>,\n+    }),\n+    'context': <ANY>,\n+    'entity_id': 'sensor.envoy_1234_energy_consumption_today',\n+    'last_changed': <ANY>,\n+    'last_reported': <ANY>,\n+    'last_updated': <ANY>,\n+    'state': '1.234',\n+  })\n+# ---\n+# name: test_sensor[envoy_acb_batt][sensor.envoy_1234_energy_production_last_seven_days-entry]\n+  EntityRegistryEntrySnapshot({\n+    'aliases': set({\n+    }),\n+    'area_id': None,\n+    'capabilities': None,\n+    'config_entry_id': <ANY>,\n+    'device_class': None,\n+    'device_id': <ANY>,\n+    'disabled_by': None,\n+    'domain': 'sensor',\n+    'entity_category': None,\n+    'entity_id': 'sensor.envoy_1234_energy_production_last_seven_days',\n+    'has_entity_name': True,\n+    'hidden_by': None,\n+    'icon': None,\n+    'id': <ANY>,\n+    'labels': set({\n+    }),\n+    'name': None,\n+    'options': dict({\n+      'sensor': dict({\n+        'suggested_display_precision': 1,\n+      }),\n+      'sensor.private': dict({\n+        'suggested_unit_of_measurement': <UnitOfEnergy.KILO_WATT_HOUR: 'kWh'>,\n+      }),\n+    }),\n+    'original_device_class': <SensorDeviceClass.ENERGY: 'energy'>,\n+    'original_icon': 'mdi:flash',\n+    'original_name': 'Energy production last seven days',\n+    'platform': 'enphase_envoy',\n+    'previous_unique_id': None,\n+    'supported_features': 0,\n+    'translation_key': 'seven_days_production',\n+    'unique_id': '1234_seven_days_production',\n+    'unit_of_measurement': <UnitOfEnergy.KILO_WATT_HOUR: 'kWh'>,\n+  })\n+# ---\n+# name: test_sensor[envoy_acb_batt][sensor.envoy_1234_energy_production_last_seven_days-state]\n+  StateSnapshot({\n+    'attributes': ReadOnlyDict({\n+      'device_class': 'energy',\n+      'friendly_name': 'Envoy 1234 Energy production last seven days',\n+      'icon': 'mdi:flash',\n+      'unit_of_measurement': <UnitOfEnergy.KILO_WATT_HOUR: 'kWh'>,\n+    }),\n+    'context': <ANY>,\n+    'entity_id': 'sensor.envoy_1234_energy_production_last_seven_days',\n+    'last_changed': <ANY>,\n+    'last_reported': <ANY>,\n+    'last_updated': <ANY>,\n+    'state': '1.234',\n+  })\n+# ---\n+# name: test_sensor[envoy_acb_batt][sensor.envoy_1234_energy_production_today-entry]\n+  EntityRegistryEntrySnapshot({\n+    'aliases': set({\n+    }),\n+    'area_id': None,\n+    'capabilities': dict({\n+      'state_class': <SensorStateClass.TOTAL_INCREASING: 'total_increasing'>,\n+    }),\n+    'config_entry_id': <ANY>,\n+    'device_class': None,\n+    'device_id': <ANY>,\n+    'disabled_by': None,\n+    'domain': 'sensor',\n+    'entity_category': None,\n+    'entity_id': 'sensor.envoy_1234_energy_production_today',\n+    'has_entity_name': True,\n+    'hidden_by': None,\n+    'icon': None,\n+    'id': <ANY>,\n+    'labels': set({\n+    }),\n+    'name': None,\n+    'options': dict({\n+      'sensor': dict({\n+        'suggested_display_precision': 2,\n+      }),\n+      'sensor.private': dict({\n+        'suggested_unit_of_measurement': <UnitOfEnergy.KILO_WATT_HOUR: 'kWh'>,\n+      }),\n+    }),\n+    'original_device_class': <SensorDeviceClass.ENERGY: 'energy'>,\n+    'original_icon': 'mdi:flash',\n+    'original_name': 'Energy production today',\n+    'platform': 'enphase_envoy',\n+    'previous_unique_id': None,\n+    'supported_features': 0,\n+    'translation_key': 'daily_production',\n+    'unique_id': '1234_daily_production',\n+    'unit_of_measurement': <UnitOfEnergy.KILO_WATT_HOUR: 'kWh'>,\n+  })\n+# ---\n+# name: test_sensor[envoy_acb_batt][sensor.envoy_1234_energy_production_today-state]\n+  StateSnapshot({\n+    'attributes': ReadOnlyDict({\n+      'device_class': 'energy',\n+      'friendly_name': 'Envoy 1234 Energy production today',\n+      'icon': 'mdi:flash',\n+      'state_class': <SensorStateClass.TOTAL_INCREASING: 'total_increasing'>,\n+      'unit_of_measurement': <UnitOfEnergy.KILO_WATT_HOUR: 'kWh'>,\n+    }),\n+    'context': <ANY>,\n+    'entity_id': 'sensor.envoy_1234_energy_production_today',\n+    'last_changed': <ANY>,\n+    'last_reported': <ANY>,\n+    'last_updated': <ANY>,\n+    'state': '1.234',\n+  })\n+# ---\n+# name: test_sensor[envoy_acb_batt][sensor.envoy_1234_frequency_net_consumption_ct-entry]\n+  EntityRegistryEntrySnapshot({\n+    'aliases': set({\n+    }),\n+    'area_id': None,\n+    'capabilities': dict({\n+      'state_class': <SensorStateClass.MEASUREMENT: 'measurement'>,\n+    }),\n+    'config_entry_id': <ANY>,\n+    'device_class': None,\n+    'device_id': <ANY>,\n+    'disabled_by': None,\n+    'domain': 'sensor',\n+    'entity_category': None,\n+    'entity_id': 'sensor.envoy_1234_frequency_net_consumption_ct',\n+    'has_entity_name': True,\n+    'hidden_by': None,\n+    'icon': None,\n+    'id': <ANY>,\n+    'labels': set({\n+    }),\n+    'name': None,\n+    'options': dict({\n+      'sensor': dict({\n+        'suggested_display_precision': 1,\n+      }),\n+    }),\n+    'original_device_class': <SensorDeviceClass.FREQUENCY: 'frequency'>,\n+    'original_icon': 'mdi:flash',\n+    'original_name': 'Frequency net consumption CT',\n+    'platform': 'enphase_envoy',\n+    'previous_unique_id': None,\n+    'supported_features': 0,\n+    'translation_key': 'net_ct_frequency',\n+    'unique_id': '1234_frequency',\n+    'unit_of_measurement': <UnitOfFrequency.HERTZ: 'Hz'>,\n+  })\n+# ---\n+# name: test_sensor[envoy_acb_batt][sensor.envoy_1234_frequency_net_consumption_ct-state]\n+  StateSnapshot({\n+    'attributes': ReadOnlyDict({\n+      'device_class': 'frequency',\n+      'friendly_name': 'Envoy 1234 Frequency net consumption CT',\n+      'icon': 'mdi:flash',\n+      'state_class': <SensorStateClass.MEASUREMENT: 'measurement'>,\n+      'unit_of_measurement': <UnitOfFrequency.HERTZ: 'Hz'>,\n+    }),\n+    'context': <ANY>,\n+    'entity_id': 'sensor.envoy_1234_frequency_net_consumption_ct',\n+    'last_changed': <ANY>,\n+    'last_reported': <ANY>,\n+    'last_updated': <ANY>,\n+    'state': '50.2',\n+  })\n+# ---\n+# name: test_sensor[envoy_acb_batt][sensor.envoy_1234_frequency_net_consumption_ct_l1-entry]\n+  EntityRegistryEntrySnapshot({\n+    'aliases': set({\n+    }),\n+    'area_id': None,\n+    'capabilities': dict({\n+      'state_class': <SensorStateClass.MEASUREMENT: 'measurement'>,\n+    }),\n+    'config_entry_id': <ANY>,\n+    'device_class': None,\n+    'device_id': <ANY>,\n+    'disabled_by': None,\n+    'domain': 'sensor',\n+    'entity_category': None,\n+    'entity_id': 'sensor.envoy_1234_frequency_net_consumption_ct_l1',\n+    'has_entity_name': True,\n+    'hidden_by': None,\n+    'icon': None,\n+    'id': <ANY>,\n+    'labels': set({\n+    }),\n+    'name': None,\n+    'options': dict({\n+      'sensor': dict({\n+        'suggested_display_precision': 1,\n+      }),\n+    }),\n+    'original_device_class': <SensorDeviceClass.FREQUENCY: 'frequency'>,\n+    'original_icon': 'mdi:flash',\n+    'original_name': 'Frequency net consumption CT l1',\n+    'platform': 'enphase_envoy',\n+    'previous_unique_id': None,\n+    'supported_features': 0,\n+    'translation_key': 'net_ct_frequency_phase',\n+    'unique_id': '1234_frequency_l1',\n+    'unit_of_measurement': <UnitOfFrequency.HERTZ: 'Hz'>,\n+  })\n+# ---\n+# name: test_sensor[envoy_acb_batt][sensor.envoy_1234_frequency_net_consumption_ct_l1-state]\n+  StateSnapshot({\n+    'attributes': ReadOnlyDict({\n+      'device_class': 'frequency',\n+      'friendly_name': 'Envoy 1234 Frequency net consumption CT l1',\n+      'icon': 'mdi:flash',\n+      'state_class': <SensorStateClass.MEASUREMENT: 'measurement'>,\n+      'unit_of_measurement': <UnitOfFrequency.HERTZ: 'Hz'>,\n+    }),\n+    'context': <ANY>,\n+    'entity_id': 'sensor.envoy_1234_frequency_net_consumption_ct_l1',\n+    'last_changed': <ANY>,\n+    'last_reported': <ANY>,\n+    'last_updated': <ANY>,\n+    'state': '50.2',\n+  })\n+# ---\n+# name: test_sensor[envoy_acb_batt][sensor.envoy_1234_frequency_net_consumption_ct_l2-entry]\n+  EntityRegistryEntrySnapshot({\n+    'aliases': set({\n+    }),\n+    'area_id': None,\n+    'capabilities': dict({\n+      'state_class': <SensorStateClass.MEASUREMENT: 'measurement'>,\n+    }),\n+    'config_entry_id': <ANY>,\n+    'device_class': None,\n+    'device_id': <ANY>,\n+    'disabled_by': None,\n+    'domain': 'sensor',\n+    'entity_category': None,\n+    'entity_id': 'sensor.envoy_1234_frequency_net_consumption_ct_l2',\n+    'has_entity_name': True,\n+    'hidden_by': None,\n+    'icon': None,\n+    'id': <ANY>,\n+    'labels': set({\n+    }),\n+    'name': None,\n+    'options': dict({\n+      'sensor': dict({\n+        'suggested_display_precision': 1,\n+      }),\n+    }),\n+    'original_device_class': <SensorDeviceClass.FREQUENCY: 'frequency'>,\n+    'original_icon': 'mdi:flash',\n+    'original_name': 'Frequency net consumption CT l2',\n+    'platform': 'enphase_envoy',\n+    'previous_unique_id': None,\n+    'supported_features': 0,\n+    'translation_key': 'net_ct_frequency_phase',\n+    'unique_id': '1234_frequency_l2',\n+    'unit_of_measurement': <UnitOfFrequency.HERTZ: 'Hz'>,\n+  })\n+# ---\n+# name: test_sensor[envoy_acb_batt][sensor.envoy_1234_frequency_net_consumption_ct_l2-state]\n+  StateSnapshot({\n+    'attributes': ReadOnlyDict({\n+      'device_class': 'frequency',\n+      'friendly_name': 'Envoy 1234 Frequency net consumption CT l2',\n+      'icon': 'mdi:flash',\n+      'state_class': <SensorStateClass.MEASUREMENT: 'measurement'>,\n+      'unit_of_measurement': <UnitOfFrequency.HERTZ: 'Hz'>,\n+    }),\n+    'context': <ANY>,\n+    'entity_id': 'sensor.envoy_1234_frequency_net_consumption_ct_l2',\n+    'last_changed': <ANY>,\n+    'last_reported': <ANY>,\n+    'last_updated': <ANY>,\n+    'state': '50.2',\n+  })\n+# ---\n+# name: test_sensor[envoy_acb_batt][sensor.envoy_1234_frequency_net_consumption_ct_l3-entry]\n+  EntityRegistryEntrySnapshot({\n+    'aliases': set({\n+    }),\n+    'area_id': None,\n+    'capabilities': dict({\n+      'state_class': <SensorStateClass.MEASUREMENT: 'measurement'>,\n+    }),\n+    'config_entry_id': <ANY>,\n+    'device_class': None,\n+    'device_id': <ANY>,\n+    'disabled_by': None,\n+    'domain': 'sensor',\n+    'entity_category': None,\n+    'entity_id': 'sensor.envoy_1234_frequency_net_consumption_ct_l3',\n+    'has_entity_name': True,\n+    'hidden_by': None,\n+    'icon': None,\n+    'id': <ANY>,\n+    'labels': set({\n+    }),\n+    'name': None,\n+    'options': dict({\n+      'sensor': dict({\n+        'suggested_display_precision': 1,\n+      }),\n+    }),\n+    'original_device_class': <SensorDeviceClass.FREQUENCY: 'frequency'>,\n+    'original_icon': 'mdi:flash',\n+    'original_name': 'Frequency net consumption CT l3',\n+    'platform': 'enphase_envoy',\n+    'previous_unique_id': None,\n+    'supported_features': 0,\n+    'translation_key': 'net_ct_frequency_phase',\n+    'unique_id': '1234_frequency_l3',\n+    'unit_of_measurement': <UnitOfFrequency.HERTZ: 'Hz'>,\n+  })\n+# ---\n+# name: test_sensor[envoy_acb_batt][sensor.envoy_1234_frequency_net_consumption_ct_l3-state]\n+  StateSnapshot({\n+    'attributes': ReadOnlyDict({\n+      'device_class': 'frequency',\n+      'friendly_name': 'Envoy 1234 Frequency net consumption CT l3',\n+      'icon': 'mdi:flash',\n+      'state_class': <SensorStateClass.MEASUREMENT: 'measurement'>,\n+      'unit_of_measurement': <UnitOfFrequency.HERTZ: 'Hz'>,\n+    }),\n+    'context': <ANY>,\n+    'entity_id': 'sensor.envoy_1234_frequency_net_consumption_ct_l3',\n+    'last_changed': <ANY>,\n+    'last_reported': <ANY>,\n+    'last_updated': <ANY>,\n+    'state': '50.2',\n+  })\n+# ---\n+# name: test_sensor[envoy_acb_batt][sensor.envoy_1234_frequency_production_ct-entry]\n+  EntityRegistryEntrySnapshot({\n+    'aliases': set({\n+    }),\n+    'area_id': None,\n+    'capabilities': dict({\n+      'state_class': <SensorStateClass.MEASUREMENT: 'measurement'>,\n+    }),\n+    'config_entry_id': <ANY>,\n+    'device_class': None,\n+    'device_id': <ANY>,\n+    'disabled_by': None,\n+    'domain': 'sensor',\n+    'entity_category': None,\n+    'entity_id': 'sensor.envoy_1234_frequency_production_ct',\n+    'has_entity_name': True,\n+    'hidden_by': None,\n+    'icon': None,\n+    'id': <ANY>,\n+    'labels': set({\n+    }),\n+    'name': None,\n+    'options': dict({\n+      'sensor': dict({\n+        'suggested_display_precision': 1,\n+      }),\n+    }),\n+    'original_device_class': <SensorDeviceClass.FREQUENCY: 'frequency'>,\n+    'original_icon': 'mdi:flash',\n+    'original_name': 'Frequency production CT',\n+    'platform': 'enphase_envoy',\n+    'previous_unique_id': None,\n+    'supported_features': 0,\n+    'translation_key': 'production_ct_frequency',\n+    'unique_id': '1234_production_ct_frequency',\n+    'unit_of_measurement': <UnitOfFrequency.HERTZ: 'Hz'>,\n+  })\n+# ---\n+# name: test_sensor[envoy_acb_batt][sensor.envoy_1234_frequency_production_ct-state]\n+  StateSnapshot({\n+    'attributes': ReadOnlyDict({\n+      'device_class': 'frequency',\n+      'friendly_name': 'Envoy 1234 Frequency production CT',\n+      'icon': 'mdi:flash',\n+      'state_class': <SensorStateClass.MEASUREMENT: 'measurement'>,\n+      'unit_of_measurement': <UnitOfFrequency.HERTZ: 'Hz'>,\n+    }),\n+    'context': <ANY>,\n+    'entity_id': 'sensor.envoy_1234_frequency_production_ct',\n+    'last_changed': <ANY>,\n+    'last_reported': <ANY>,\n+    'last_updated': <ANY>,\n+    'state': '50.1',\n+  })\n+# ---\n+# name: test_sensor[envoy_acb_batt][sensor.envoy_1234_frequency_production_ct_l1-entry]\n+  EntityRegistryEntrySnapshot({\n+    'aliases': set({\n+    }),\n+    'area_id': None,\n+    'capabilities': dict({\n+      'state_class': <SensorStateClass.MEASUREMENT: 'measurement'>,\n+    }),\n+    'config_entry_id': <ANY>,\n+    'device_class': None,\n+    'device_id': <ANY>,\n+    'disabled_by': None,\n+    'domain': 'sensor',\n+    'entity_category': None,\n+    'entity_id': 'sensor.envoy_1234_frequency_production_ct_l1',\n+    'has_entity_name': True,\n+    'hidden_by': None,\n+    'icon': None,\n+    'id': <ANY>,\n+    'labels': set({\n+    }),\n+    'name': None,\n+    'options': dict({\n+      'sensor': dict({\n+        'suggested_display_precision': 1,\n+      }),\n+    }),\n+    'original_device_class': <SensorDeviceClass.FREQUENCY: 'frequency'>,\n+    'original_icon': 'mdi:flash',\n+    'original_name': 'Frequency production CT l1',\n+    'platform': 'enphase_envoy',\n+    'previous_unique_id': None,\n+    'supported_features': 0,\n+    'translation_key': 'production_ct_frequency_phase',\n+    'unique_id': '1234_production_ct_frequency_l1',\n+    'unit_of_measurement': <UnitOfFrequency.HERTZ: 'Hz'>,\n+  })\n+# ---\n+# name: test_sensor[envoy_acb_batt][sensor.envoy_1234_frequency_production_ct_l1-state]\n+  StateSnapshot({\n+    'attributes': ReadOnlyDict({\n+      'device_class': 'frequency',\n+      'friendly_name': 'Envoy 1234 Frequency production CT l1',\n+      'icon': 'mdi:flash',\n+      'state_class': <SensorStateClass.MEASUREMENT: 'measurement'>,\n+      'unit_of_measurement': <UnitOfFrequency.HERTZ: 'Hz'>,\n+    }),\n+    'context': <ANY>,\n+    'entity_id': 'sensor.envoy_1234_frequency_production_ct_l1',\n+    'last_changed': <ANY>,\n+    'last_reported': <ANY>,\n+    'last_updated': <ANY>,\n+    'state': '50.1',\n+  })\n+# ---\n+# name: test_sensor[envoy_acb_batt][sensor.envoy_1234_frequency_production_ct_l2-entry]\n+  EntityRegistryEntrySnapshot({\n+    'aliases': set({\n+    }),\n+    'area_id': None,\n+    'capabilities': dict({\n+      'state_class': <SensorStateClass.MEASUREMENT: 'measurement'>,\n+    }),\n+    'config_entry_id': <ANY>,\n+    'device_class': None,\n+    'device_id': <ANY>,\n+    'disabled_by': None,\n+    'domain': 'sensor',\n+    'entity_category': None,\n+    'entity_id': 'sensor.envoy_1234_frequency_production_ct_l2',\n+    'has_entity_name': True,\n+    'hidden_by': None,\n+    'icon': None,\n+    'id': <ANY>,\n+    'labels': set({\n+    }),\n+    'name': None,\n+    'options': dict({\n+      'sensor': dict({\n+        'suggested_display_precision': 1,\n+      }),\n+    }),\n+    'original_device_class': <SensorDeviceClass.FREQUENCY: 'frequency'>,\n+    'original_icon': 'mdi:flash',\n+    'original_name': 'Frequency production CT l2',\n+    'platform': 'enphase_envoy',\n+    'previous_unique_id': None,\n+    'supported_features': 0,\n+    'translation_key': 'production_ct_frequency_phase',\n+    'unique_id': '1234_production_ct_frequency_l2',\n+    'unit_of_measurement': <UnitOfFrequency.HERTZ: 'Hz'>,\n+  })\n+# ---\n+# name: test_sensor[envoy_acb_batt][sensor.envoy_1234_frequency_production_ct_l2-state]\n+  StateSnapshot({\n+    'attributes': ReadOnlyDict({\n+      'device_class': 'frequency',\n+      'friendly_name': 'Envoy 1234 Frequency production CT l2',\n+      'icon': 'mdi:flash',\n+      'state_class': <SensorStateClass.MEASUREMENT: 'measurement'>,\n+      'unit_of_measurement': <UnitOfFrequency.HERTZ: 'Hz'>,\n+    }),\n+    'context': <ANY>,\n+    'entity_id': 'sensor.envoy_1234_frequency_production_ct_l2',\n+    'last_changed': <ANY>,\n+    'last_reported': <ANY>,\n+    'last_updated': <ANY>,\n+    'state': '50.1',\n+  })\n+# ---\n+# name: test_sensor[envoy_acb_batt][sensor.envoy_1234_frequency_production_ct_l3-entry]\n+  EntityRegistryEntrySnapshot({\n+    'aliases': set({\n+    }),\n+    'area_id': None,\n+    'capabilities': dict({\n+      'state_class': <SensorStateClass.MEASUREMENT: 'measurement'>,\n+    }),\n+    'config_entry_id': <ANY>,\n+    'device_class': None,\n+    'device_id': <ANY>,\n+    'disabled_by': None,\n+    'domain': 'sensor',\n+    'entity_category': None,\n+    'entity_id': 'sensor.envoy_1234_frequency_production_ct_l3',\n+    'has_entity_name': True,\n+    'hidden_by': None,\n+    'icon': None,\n+    'id': <ANY>,\n+    'labels': set({\n+    }),\n+    'name': None,\n+    'options': dict({\n+      'sensor': dict({\n+        'suggested_display_precision': 1,\n+      }),\n+    }),\n+    'original_device_class': <SensorDeviceClass.FREQUENCY: 'frequency'>,\n+    'original_icon': 'mdi:flash',\n+    'original_name': 'Frequency production CT l3',\n+    'platform': 'enphase_envoy',\n+    'previous_unique_id': None,\n+    'supported_features': 0,\n+    'translation_key': 'production_ct_frequency_phase',\n+    'unique_id': '1234_production_ct_frequency_l3',\n+    'unit_of_measurement': <UnitOfFrequency.HERTZ: 'Hz'>,\n+  })\n+# ---\n+# name: test_sensor[envoy_acb_batt][sensor.envoy_1234_frequency_production_ct_l3-state]\n+  StateSnapshot({\n+    'attributes': ReadOnlyDict({\n+      'device_class': 'frequency',\n+      'friendly_name': 'Envoy 1234 Frequency production CT l3',\n+      'icon': 'mdi:flash',\n+      'state_class': <SensorStateClass.MEASUREMENT: 'measurement'>,\n+      'unit_of_measurement': <UnitOfFrequency.HERTZ: 'Hz'>,\n+    }),\n+    'context': <ANY>,\n+    'entity_id': 'sensor.envoy_1234_frequency_production_ct_l3',\n+    'last_changed': <ANY>,\n+    'last_reported': <ANY>,\n+    'last_updated': <ANY>,\n+    'state': '50.1',\n+  })\n+# ---\n+# name: test_sensor[envoy_acb_batt][sensor.envoy_1234_lifetime_balanced_net_energy_consumption-entry]\n+  EntityRegistryEntrySnapshot({\n+    'aliases': set({\n+    }),\n+    'area_id': None,\n+    'capabilities': dict({\n+      'state_class': <SensorStateClass.TOTAL: 'total'>,\n+    }),\n+    'config_entry_id': <ANY>,\n+    'device_class': None,\n+    'device_id': <ANY>,\n+    'disabled_by': None,\n+    'domain': 'sensor',\n+    'entity_category': None,\n+    'entity_id': 'sensor.envoy_1234_lifetime_balanced_net_energy_consumption',\n+    'has_entity_name': True,\n+    'hidden_by': None,\n+    'icon': None,\n+    'id': <ANY>,\n+    'labels': set({\n+    }),\n+    'name': None,\n+    'options': dict({\n+      'sensor': dict({\n+        'suggested_display_precision': 3,\n+      }),\n+      'sensor.private': dict({\n+        'suggested_unit_of_measurement': <UnitOfEnergy.KILO_WATT_HOUR: 'kWh'>,\n+      }),\n+    }),\n+    'original_device_class': <SensorDeviceClass.ENERGY: 'energy'>,\n+    'original_icon': 'mdi:flash',\n+    'original_name': 'Lifetime balanced net energy consumption',\n+    'platform': 'enphase_envoy',\n+    'previous_unique_id': None,\n+    'supported_features': 0,\n+    'translation_key': 'lifetime_balanced_net_consumption',\n+    'unique_id': '1234_lifetime_balanced_net_consumption',\n+    'unit_of_measurement': <UnitOfEnergy.KILO_WATT_HOUR: 'kWh'>,\n+  })\n+# ---\n+# name: test_sensor[envoy_acb_batt][sensor.envoy_1234_lifetime_balanced_net_energy_consumption-state]\n+  StateSnapshot({\n+    'attributes': ReadOnlyDict({\n+      'device_class': 'energy',\n+      'friendly_name': 'Envoy 1234 Lifetime balanced net energy consumption',\n+      'icon': 'mdi:flash',\n+      'state_class': <SensorStateClass.TOTAL: 'total'>,\n+      'unit_of_measurement': <UnitOfEnergy.KILO_WATT_HOUR: 'kWh'>,\n+    }),\n+    'context': <ANY>,\n+    'entity_id': 'sensor.envoy_1234_lifetime_balanced_net_energy_consumption',\n+    'last_changed': <ANY>,\n+    'last_reported': <ANY>,\n+    'last_updated': <ANY>,\n+    'state': '4.321',\n+  })\n+# ---\n+# name: test_sensor[envoy_acb_batt][sensor.envoy_1234_lifetime_energy_consumption-entry]\n+  EntityRegistryEntrySnapshot({\n+    'aliases': set({\n+    }),\n+    'area_id': None,\n+    'capabilities': dict({\n+      'state_class': <SensorStateClass.TOTAL_INCREASING: 'total_increasing'>,\n+    }),\n+    'config_entry_id': <ANY>,\n+    'device_class': None,\n+    'device_id': <ANY>,\n+    'disabled_by': None,\n+    'domain': 'sensor',\n+    'entity_category': None,\n+    'entity_id': 'sensor.envoy_1234_lifetime_energy_consumption',\n+    'has_entity_name': True,\n+    'hidden_by': None,\n+    'icon': None,\n+    'id': <ANY>,\n+    'labels': set({\n+    }),\n+    'name': None,\n+    'options': dict({\n+      'sensor': dict({\n+        'suggested_display_precision': 3,\n+      }),\n+      'sensor.private': dict({\n+        'suggested_unit_of_measurement': <UnitOfEnergy.MEGA_WATT_HOUR: 'MWh'>,\n+      }),\n+    }),\n+    'original_device_class': <SensorDeviceClass.ENERGY: 'energy'>,\n+    'original_icon': 'mdi:flash',\n+    'original_name': 'Lifetime energy consumption',\n+    'platform': 'enphase_envoy',\n+    'previous_unique_id': None,\n+    'supported_features': 0,\n+    'translation_key': 'lifetime_consumption',\n+    'unique_id': '1234_lifetime_consumption',\n+    'unit_of_measurement': <UnitOfEnergy.MEGA_WATT_HOUR: 'MWh'>,\n+  })\n+# ---\n+# name: test_sensor[envoy_acb_batt][sensor.envoy_1234_lifetime_energy_consumption-state]\n+  StateSnapshot({\n+    'attributes': ReadOnlyDict({\n+      'device_class': 'energy',\n+      'friendly_name': 'Envoy 1234 Lifetime energy consumption',\n+      'icon': 'mdi:flash',\n+      'state_class': <SensorStateClass.TOTAL_INCREASING: 'total_increasing'>,\n+      'unit_of_measurement': <UnitOfEnergy.MEGA_WATT_HOUR: 'MWh'>,\n+    }),\n+    'context': <ANY>,\n+    'entity_id': 'sensor.envoy_1234_lifetime_energy_consumption',\n+    'last_changed': <ANY>,\n+    'last_reported': <ANY>,\n+    'last_updated': <ANY>,\n+    'state': '0.001234',\n+  })\n+# ---\n+# name: test_sensor[envoy_acb_batt][sensor.envoy_1234_lifetime_energy_production-entry]\n+  EntityRegistryEntrySnapshot({\n+    'aliases': set({\n+    }),\n+    'area_id': None,\n+    'capabilities': dict({\n+      'state_class': <SensorStateClass.TOTAL_INCREASING: 'total_increasing'>,\n+    }),\n+    'config_entry_id': <ANY>,\n+    'device_class': None,\n+    'device_id': <ANY>,\n+    'disabled_by': None,\n+    'domain': 'sensor',\n+    'entity_category': None,\n+    'entity_id': 'sensor.envoy_1234_lifetime_energy_production',\n+    'has_entity_name': True,\n+    'hidden_by': None,\n+    'icon': None,\n+    'id': <ANY>,\n+    'labels': set({\n+    }),\n+    'name': None,\n+    'options': dict({\n+      'sensor': dict({\n+        'suggested_display_precision': 3,\n+      }),\n+      'sensor.private': dict({\n+        'suggested_unit_of_measurement': <UnitOfEnergy.MEGA_WATT_HOUR: 'MWh'>,\n+      }),\n+    }),\n+    'original_device_class': <SensorDeviceClass.ENERGY: 'energy'>,\n+    'original_icon': 'mdi:flash',\n+    'original_name': 'Lifetime energy production',\n+    'platform': 'enphase_envoy',\n+    'previous_unique_id': None,\n+    'supported_features': 0,\n+    'translation_key': 'lifetime_production',\n+    'unique_id': '1234_lifetime_production',\n+    'unit_of_measurement': <UnitOfEnergy.MEGA_WATT_HOUR: 'MWh'>,\n+  })\n+# ---\n+# name: test_sensor[envoy_acb_batt][sensor.envoy_1234_lifetime_energy_production-state]\n+  StateSnapshot({\n+    'attributes': ReadOnlyDict({\n+      'device_class': 'energy',\n+      'friendly_name': 'Envoy 1234 Lifetime energy production',\n+      'icon': 'mdi:flash',\n+      'state_class': <SensorStateClass.TOTAL_INCREASING: 'total_increasing'>,\n+      'unit_of_measurement': <UnitOfEnergy.MEGA_WATT_HOUR: 'MWh'>,\n+    }),\n+    'context': <ANY>,\n+    'entity_id': 'sensor.envoy_1234_lifetime_energy_production',\n+    'last_changed': <ANY>,\n+    'last_reported': <ANY>,\n+    'last_updated': <ANY>,\n+    'state': '0.001234',\n+  })\n+# ---\n+# name: test_sensor[envoy_acb_batt][sensor.envoy_1234_lifetime_net_energy_consumption-entry]\n+  EntityRegistryEntrySnapshot({\n+    'aliases': set({\n+    }),\n+    'area_id': None,\n+    'capabilities': dict({\n+      'state_class': <SensorStateClass.TOTAL_INCREASING: 'total_increasing'>,\n+    }),\n+    'config_entry_id': <ANY>,\n+    'device_class': None,\n+    'device_id': <ANY>,\n+    'disabled_by': None,\n+    'domain': 'sensor',\n+    'entity_category': None,\n+    'entity_id': 'sensor.envoy_1234_lifetime_net_energy_consumption',\n+    'has_entity_name': True,\n+    'hidden_by': None,\n+    'icon': None,\n+    'id': <ANY>,\n+    'labels': set({\n+    }),\n+    'name': None,\n+    'options': dict({\n+      'sensor': dict({\n+        'suggested_display_precision': 3,\n+      }),\n+      'sensor.private': dict({\n+        'suggested_unit_of_measurement': <UnitOfEnergy.MEGA_WATT_HOUR: 'MWh'>,\n+      }),\n+    }),\n+    'original_device_class': <SensorDeviceClass.ENERGY: 'energy'>,\n+    'original_icon': 'mdi:flash',\n+    'original_name': 'Lifetime net energy consumption',\n+    'platform': 'enphase_envoy',\n+    'previous_unique_id': None,\n+    'supported_features': 0,\n+    'translation_key': 'lifetime_net_consumption',\n+    'unique_id': '1234_lifetime_net_consumption',\n+    'unit_of_measurement': <UnitOfEnergy.MEGA_WATT_HOUR: 'MWh'>,\n+  })\n+# ---\n+# name: test_sensor[envoy_acb_batt][sensor.envoy_1234_lifetime_net_energy_consumption-state]\n+  StateSnapshot({\n+    'attributes': ReadOnlyDict({\n+      'device_class': 'energy',\n+      'friendly_name': 'Envoy 1234 Lifetime net energy consumption',\n+      'icon': 'mdi:flash',\n+      'state_class': <SensorStateClass.TOTAL_INCREASING: 'total_increasing'>,\n+      'unit_of_measurement': <UnitOfEnergy.MEGA_WATT_HOUR: 'MWh'>,\n+    }),\n+    'context': <ANY>,\n+    'entity_id': 'sensor.envoy_1234_lifetime_net_energy_consumption',\n+    'last_changed': <ANY>,\n+    'last_reported': <ANY>,\n+    'last_updated': <ANY>,\n+    'state': '0.021234',\n+  })\n+# ---\n+# name: test_sensor[envoy_acb_batt][sensor.envoy_1234_lifetime_net_energy_consumption_l1-entry]\n+  EntityRegistryEntrySnapshot({\n+    'aliases': set({\n+    }),\n+    'area_id': None,\n+    'capabilities': dict({\n+      'state_class': <SensorStateClass.TOTAL_INCREASING: 'total_increasing'>,\n+    }),\n+    'config_entry_id': <ANY>,\n+    'device_class': None,\n+    'device_id': <ANY>,\n+    'disabled_by': None,\n+    'domain': 'sensor',\n+    'entity_category': None,\n+    'entity_id': 'sensor.envoy_1234_lifetime_net_energy_consumption_l1',\n+    'has_entity_name': True,\n+    'hidden_by': None,\n+    'icon': None,\n+    'id': <ANY>,\n+    'labels': set({\n+    }),\n+    'name': None,\n+    'options': dict({\n+      'sensor': dict({\n+        'suggested_display_precision': 3,\n+      }),\n+      'sensor.private': dict({\n+        'suggested_unit_of_measurement': <UnitOfEnergy.MEGA_WATT_HOUR: 'MWh'>,\n+      }),\n+    }),\n+    'original_device_class': <SensorDeviceClass.ENERGY: 'energy'>,\n+    'original_icon': 'mdi:flash',\n+    'original_name': 'Lifetime net energy consumption l1',\n+    'platform': 'enphase_envoy',\n+    'previous_unique_id': None,\n+    'supported_features': 0,\n+    'translation_key': 'lifetime_net_consumption_phase',\n+    'unique_id': '1234_lifetime_net_consumption_l1',\n+    'unit_of_measurement': <UnitOfEnergy.MEGA_WATT_HOUR: 'MWh'>,\n+  })\n+# ---\n+# name: test_sensor[envoy_acb_batt][sensor.envoy_1234_lifetime_net_energy_consumption_l1-state]\n+  StateSnapshot({\n+    'attributes': ReadOnlyDict({\n+      'device_class': 'energy',\n+      'friendly_name': 'Envoy 1234 Lifetime net energy consumption l1',\n+      'icon': 'mdi:flash',\n+      'state_class': <SensorStateClass.TOTAL_INCREASING: 'total_increasing'>,\n+      'unit_of_measurement': <UnitOfEnergy.MEGA_WATT_HOUR: 'MWh'>,\n+    }),\n+    'context': <ANY>,\n+    'entity_id': 'sensor.envoy_1234_lifetime_net_energy_consumption_l1',\n+    'last_changed': <ANY>,\n+    'last_reported': <ANY>,\n+    'last_updated': <ANY>,\n+    'state': '0.212341',\n+  })\n+# ---\n+# name: test_sensor[envoy_acb_batt][sensor.envoy_1234_lifetime_net_energy_consumption_l2-entry]\n+  EntityRegistryEntrySnapshot({\n+    'aliases': set({\n+    }),\n+    'area_id': None,\n+    'capabilities': dict({\n+      'state_class': <SensorStateClass.TOTAL_INCREASING: 'total_increasing'>,\n+    }),\n+    'config_entry_id': <ANY>,\n+    'device_class': None,\n+    'device_id': <ANY>,\n+    'disabled_by': None,\n+    'domain': 'sensor',\n+    'entity_category': None,\n+    'entity_id': 'sensor.envoy_1234_lifetime_net_energy_consumption_l2',\n+    'has_entity_name': True,\n+    'hidden_by': None,\n+    'icon': None,\n+    'id': <ANY>,\n+    'labels': set({\n+    }),\n+    'name': None,\n+    'options': dict({\n+      'sensor': dict({\n+        'suggested_display_precision': 3,\n+      }),\n+      'sensor.private': dict({\n+        'suggested_unit_of_measurement': <UnitOfEnergy.MEGA_WATT_HOUR: 'MWh'>,\n+      }),\n+    }),\n+    'original_device_class': <SensorDeviceClass.ENERGY: 'energy'>,\n+    'original_icon': 'mdi:flash',\n+    'original_name': 'Lifetime net energy consumption l2',\n+    'platform': 'enphase_envoy',\n+    'previous_unique_id': None,\n+    'supported_features': 0,\n+    'translation_key': 'lifetime_net_consumption_phase',\n+    'unique_id': '1234_lifetime_net_consumption_l2',\n+    'unit_of_measurement': <UnitOfEnergy.MEGA_WATT_HOUR: 'MWh'>,\n+  })\n+# ---\n+# name: test_sensor[envoy_acb_batt][sensor.envoy_1234_lifetime_net_energy_consumption_l2-state]\n+  StateSnapshot({\n+    'attributes': ReadOnlyDict({\n+      'device_class': 'energy',\n+      'friendly_name': 'Envoy 1234 Lifetime net energy consumption l2',\n+      'icon': 'mdi:flash',\n+      'state_class': <SensorStateClass.TOTAL_INCREASING: 'total_increasing'>,\n+      'unit_of_measurement': <UnitOfEnergy.MEGA_WATT_HOUR: 'MWh'>,\n+    }),\n+    'context': <ANY>,\n+    'entity_id': 'sensor.envoy_1234_lifetime_net_energy_consumption_l2',\n+    'last_changed': <ANY>,\n+    'last_reported': <ANY>,\n+    'last_updated': <ANY>,\n+    'state': '0.212342',\n+  })\n+# ---\n+# name: test_sensor[envoy_acb_batt][sensor.envoy_1234_lifetime_net_energy_consumption_l3-entry]\n+  EntityRegistryEntrySnapshot({\n+    'aliases': set({\n+    }),\n+    'area_id': None,\n+    'capabilities': dict({\n+      'state_class': <SensorStateClass.TOTAL_INCREASING: 'total_increasing'>,\n+    }),\n+    'config_entry_id': <ANY>,\n+    'device_class': None,\n+    'device_id': <ANY>,\n+    'disabled_by': None,\n+    'domain': 'sensor',\n+    'entity_category': None,\n+    'entity_id': 'sensor.envoy_1234_lifetime_net_energy_consumption_l3',\n+    'has_entity_name': True,\n+    'hidden_by': None,\n+    'icon': None,\n+    'id': <ANY>,\n+    'labels': set({\n+    }),\n+    'name': None,\n+    'options': dict({\n+      'sensor': dict({\n+        'suggested_display_precision': 3,\n+      }),\n+      'sensor.private': dict({\n+        'suggested_unit_of_measurement': <UnitOfEnergy.MEGA_WATT_HOUR: 'MWh'>,\n+      }),\n+    }),\n+    'original_device_class': <SensorDeviceClass.ENERGY: 'energy'>,\n+    'original_icon': 'mdi:flash',\n+    'original_name': 'Lifetime net energy consumption l3',\n+    'platform': 'enphase_envoy',\n+    'previous_unique_id': None,\n+    'supported_features': 0,\n+    'translation_key': 'lifetime_net_consumption_phase',\n+    'unique_id': '1234_lifetime_net_consumption_l3',\n+    'unit_of_measurement': <UnitOfEnergy.MEGA_WATT_HOUR: 'MWh'>,\n+  })\n+# ---\n+# name: test_sensor[envoy_acb_batt][sensor.envoy_1234_lifetime_net_energy_consumption_l3-state]\n+  StateSnapshot({\n+    'attributes': ReadOnlyDict({\n+      'device_class': 'energy',\n+      'friendly_name': 'Envoy 1234 Lifetime net energy consumption l3',\n+      'icon': 'mdi:flash',\n+      'state_class': <SensorStateClass.TOTAL_INCREASING: 'total_increasing'>,\n+      'unit_of_measurement': <UnitOfEnergy.MEGA_WATT_HOUR: 'MWh'>,\n+    }),\n+    'context': <ANY>,\n+    'entity_id': 'sensor.envoy_1234_lifetime_net_energy_consumption_l3',\n+    'last_changed': <ANY>,\n+    'last_reported': <ANY>,\n+    'last_updated': <ANY>,\n+    'state': '0.212343',\n+  })\n+# ---\n+# name: test_sensor[envoy_acb_batt][sensor.envoy_1234_lifetime_net_energy_production-entry]\n+  EntityRegistryEntrySnapshot({\n+    'aliases': set({\n+    }),\n+    'area_id': None,\n+    'capabilities': dict({\n+      'state_class': <SensorStateClass.TOTAL_INCREASING: 'total_increasing'>,\n+    }),\n+    'config_entry_id': <ANY>,\n+    'device_class': None,\n+    'device_id': <ANY>,\n+    'disabled_by': None,\n+    'domain': 'sensor',\n+    'entity_category': None,\n+    'entity_id': 'sensor.envoy_1234_lifetime_net_energy_production',\n+    'has_entity_name': True,\n+    'hidden_by': None,\n+    'icon': None,\n+    'id': <ANY>,\n+    'labels': set({\n+    }),\n+    'name': None,\n+    'options': dict({\n+      'sensor': dict({\n+        'suggested_display_precision': 3,\n+      }),\n+      'sensor.private': dict({\n+        'suggested_unit_of_measurement': <UnitOfEnergy.MEGA_WATT_HOUR: 'MWh'>,\n+      }),\n+    }),\n+    'original_device_class': <SensorDeviceClass.ENERGY: 'energy'>,\n+    'original_icon': 'mdi:flash',\n+    'original_name': 'Lifetime net energy production',\n+    'platform': 'enphase_envoy',\n+    'previous_unique_id': None,\n+    'supported_features': 0,\n+    'translation_key': 'lifetime_net_production',\n+    'unique_id': '1234_lifetime_net_production',\n+    'unit_of_measurement': <UnitOfEnergy.MEGA_WATT_HOUR: 'MWh'>,\n+  })\n+# ---\n+# name: test_sensor[envoy_acb_batt][sensor.envoy_1234_lifetime_net_energy_production-state]\n+  StateSnapshot({\n+    'attributes': ReadOnlyDict({\n+      'device_class': 'energy',\n+      'friendly_name': 'Envoy 1234 Lifetime net energy production',\n+      'icon': 'mdi:flash',\n+      'state_class': <SensorStateClass.TOTAL_INCREASING: 'total_increasing'>,\n+      'unit_of_measurement': <UnitOfEnergy.MEGA_WATT_HOUR: 'MWh'>,\n+    }),\n+    'context': <ANY>,\n+    'entity_id': 'sensor.envoy_1234_lifetime_net_energy_production',\n+    'last_changed': <ANY>,\n+    'last_reported': <ANY>,\n+    'last_updated': <ANY>,\n+    'state': '0.022345',\n+  })\n+# ---\n+# name: test_sensor[envoy_acb_batt][sensor.envoy_1234_lifetime_net_energy_production_l1-entry]\n+  EntityRegistryEntrySnapshot({\n+    'aliases': set({\n+    }),\n+    'area_id': None,\n+    'capabilities': dict({\n+      'state_class': <SensorStateClass.TOTAL_INCREASING: 'total_increasing'>,\n+    }),\n+    'config_entry_id': <ANY>,\n+    'device_class': None,\n+    'device_id': <ANY>,\n+    'disabled_by': None,\n+    'domain': 'sensor',\n+    'entity_category': None,\n+    'entity_id': 'sensor.envoy_1234_lifetime_net_energy_production_l1',\n+    'has_entity_name': True,\n+    'hidden_by': None,\n+    'icon': None,\n+    'id': <ANY>,\n+    'labels': set({\n+    }),\n+    'name': None,\n+    'options': dict({\n+      'sensor': dict({\n+        'suggested_display_precision': 3,\n+      }),\n+      'sensor.private': dict({\n+        'suggested_unit_of_measurement': <UnitOfEnergy.MEGA_WATT_HOUR: 'MWh'>,\n+      }),\n+    }),\n+    'original_device_class': <SensorDeviceClass.ENERGY: 'energy'>,\n+    'original_icon': 'mdi:flash',\n+    'original_name': 'Lifetime net energy production l1',\n+    'platform': 'enphase_envoy',\n+    'previous_unique_id': None,\n+    'supported_features': 0,\n+    'translation_key': 'lifetime_net_production_phase',\n+    'unique_id': '1234_lifetime_net_production_l1',\n+    'unit_of_measurement': <UnitOfEnergy.MEGA_WATT_HOUR: 'MWh'>,\n+  })\n+# ---\n+# name: test_sensor[envoy_acb_batt][sensor.envoy_1234_lifetime_net_energy_production_l1-state]\n+  StateSnapshot({\n+    'attributes': ReadOnlyDict({\n+      'device_class': 'energy',\n+      'friendly_name': 'Envoy 1234 Lifetime net energy production l1',\n+      'icon': 'mdi:flash',\n+      'state_class': <SensorStateClass.TOTAL_INCREASING: 'total_increasing'>,\n+      'unit_of_measurement': <UnitOfEnergy.MEGA_WATT_HOUR: 'MWh'>,\n+    }),\n+    'context': <ANY>,\n+    'entity_id': 'sensor.envoy_1234_lifetime_net_energy_production_l1',\n+    'last_changed': <ANY>,\n+    'last_reported': <ANY>,\n+    'last_updated': <ANY>,\n+    'state': '0.223451',\n+  })\n+# ---\n+# name: test_sensor[envoy_acb_batt][sensor.envoy_1234_lifetime_net_energy_production_l2-entry]\n+  EntityRegistryEntrySnapshot({\n+    'aliases': set({\n+    }),\n+    'area_id': None,\n+    'capabilities': dict({\n+      'state_class': <SensorStateClass.TOTAL_INCREASING: 'total_increasing'>,\n+    }),\n+    'config_entry_id': <ANY>,\n+    'device_class': None,\n+    'device_id': <ANY>,\n+    'disabled_by': None,\n+    'domain': 'sensor',\n+    'entity_category': None,\n+    'entity_id': 'sensor.envoy_1234_lifetime_net_energy_production_l2',\n+    'has_entity_name': True,\n+    'hidden_by': None,\n+    'icon': None,\n+    'id': <ANY>,\n+    'labels': set({\n+    }),\n+    'name': None,\n+    'options': dict({\n+      'sensor': dict({\n+        'suggested_display_precision': 3,\n+      }),\n+      'sensor.private': dict({\n+        'suggested_unit_of_measurement': <UnitOfEnergy.MEGA_WATT_HOUR: 'MWh'>,\n+      }),\n+    }),\n+    'original_device_class': <SensorDeviceClass.ENERGY: 'energy'>,\n+    'original_icon': 'mdi:flash',\n+    'original_name': 'Lifetime net energy production l2',\n+    'platform': 'enphase_envoy',\n+    'previous_unique_id': None,\n+    'supported_features': 0,\n+    'translation_key': 'lifetime_net_production_phase',\n+    'unique_id': '1234_lifetime_net_production_l2',\n+    'unit_of_measurement': <UnitOfEnergy.MEGA_WATT_HOUR: 'MWh'>,\n+  })\n+# ---\n+# name: test_sensor[envoy_acb_batt][sensor.envoy_1234_lifetime_net_energy_production_l2-state]\n+  StateSnapshot({\n+    'attributes': ReadOnlyDict({\n+      'device_class': 'energy',\n+      'friendly_name': 'Envoy 1234 Lifetime net energy production l2',\n+      'icon': 'mdi:flash',\n+      'state_class': <SensorStateClass.TOTAL_INCREASING: 'total_increasing'>,\n+      'unit_of_measurement': <UnitOfEnergy.MEGA_WATT_HOUR: 'MWh'>,\n+    }),\n+    'context': <ANY>,\n+    'entity_id': 'sensor.envoy_1234_lifetime_net_energy_production_l2',\n+    'last_changed': <ANY>,\n+    'last_reported': <ANY>,\n+    'last_updated': <ANY>,\n+    'state': '0.223452',\n+  })\n+# ---\n+# name: test_sensor[envoy_acb_batt][sensor.envoy_1234_lifetime_net_energy_production_l3-entry]\n+  EntityRegistryEntrySnapshot({\n+    'aliases': set({\n+    }),\n+    'area_id': None,\n+    'capabilities': dict({\n+      'state_class': <SensorStateClass.TOTAL_INCREASING: 'total_increasing'>,\n+    }),\n+    'config_entry_id': <ANY>,\n+    'device_class': None,\n+    'device_id': <ANY>,\n+    'disabled_by': None,\n+    'domain': 'sensor',\n+    'entity_category': None,\n+    'entity_id': 'sensor.envoy_1234_lifetime_net_energy_production_l3',\n+    'has_entity_name': True,\n+    'hidden_by': None,\n+    'icon': None,\n+    'id': <ANY>,\n+    'labels': set({\n+    }),\n+    'name': None,\n+    'options': dict({\n+      'sensor': dict({\n+        'suggested_display_precision': 3,\n+      }),\n+      'sensor.private': dict({\n+        'suggested_unit_of_measurement': <UnitOfEnergy.MEGA_WATT_HOUR: 'MWh'>,\n+      }),\n+    }),\n+    'original_device_class': <SensorDeviceClass.ENERGY: 'energy'>,\n+    'original_icon': 'mdi:flash',\n+    'original_name': 'Lifetime net energy production l3',\n+    'platform': 'enphase_envoy',\n+    'previous_unique_id': None,\n+    'supported_features': 0,\n+    'translation_key': 'lifetime_net_production_phase',\n+    'unique_id': '1234_lifetime_net_production_l3',\n+    'unit_of_measurement': <UnitOfEnergy.MEGA_WATT_HOUR: 'MWh'>,\n+  })\n+# ---\n+# name: test_sensor[envoy_acb_batt][sensor.envoy_1234_lifetime_net_energy_production_l3-state]\n+  StateSnapshot({\n+    'attributes': ReadOnlyDict({\n+      'device_class': 'energy',\n+      'friendly_name': 'Envoy 1234 Lifetime net energy production l3',\n+      'icon': 'mdi:flash',\n+      'state_class': <SensorStateClass.TOTAL_INCREASING: 'total_increasing'>,\n+      'unit_of_measurement': <UnitOfEnergy.MEGA_WATT_HOUR: 'MWh'>,\n+    }),\n+    'context': <ANY>,\n+    'entity_id': 'sensor.envoy_1234_lifetime_net_energy_production_l3',\n+    'last_changed': <ANY>,\n+    'last_reported': <ANY>,\n+    'last_updated': <ANY>,\n+    'state': '0.223453',\n+  })\n+# ---\n+# name: test_sensor[envoy_acb_batt][sensor.envoy_1234_meter_status_flags_active_net_consumption_ct-entry]\n+  EntityRegistryEntrySnapshot({\n+    'aliases': set({\n+    }),\n+    'area_id': None,\n+    'capabilities': None,\n+    'config_entry_id': <ANY>,\n+    'device_class': None,\n+    'device_id': <ANY>,\n+    'disabled_by': None,\n+    'domain': 'sensor',\n+    'entity_category': None,\n+    'entity_id': 'sensor.envoy_1234_meter_status_flags_active_net_consumption_ct',\n+    'has_entity_name': True,\n+    'hidden_by': None,\n+    'icon': None,\n+    'id': <ANY>,\n+    'labels': set({\n+    }),\n+    'name': None,\n+    'options': dict({\n+    }),\n+    'original_device_class': None,\n+    'original_icon': 'mdi:flash',\n+    'original_name': 'Meter status flags active net consumption CT',\n+    'platform': 'enphase_envoy',\n+    'previous_unique_id': None,\n+    'supported_features': 0,\n+    'translation_key': 'net_ct_status_flags',\n+    'unique_id': '1234_net_consumption_ct_status_flags',\n+    'unit_of_measurement': None,\n+  })\n+# ---\n+# name: test_sensor[envoy_acb_batt][sensor.envoy_1234_meter_status_flags_active_net_consumption_ct-state]\n+  StateSnapshot({\n+    'attributes': ReadOnlyDict({\n+      'friendly_name': 'Envoy 1234 Meter status flags active net consumption CT',\n+      'icon': 'mdi:flash',\n+    }),\n+    'context': <ANY>,\n+    'entity_id': 'sensor.envoy_1234_meter_status_flags_active_net_consumption_ct',\n+    'last_changed': <ANY>,\n+    'last_reported': <ANY>,\n+    'last_updated': <ANY>,\n+    'state': '0',\n+  })\n+# ---\n+# name: test_sensor[envoy_acb_batt][sensor.envoy_1234_meter_status_flags_active_net_consumption_ct_l1-entry]\n+  EntityRegistryEntrySnapshot({\n+    'aliases': set({\n+    }),\n+    'area_id': None,\n+    'capabilities': None,\n+    'config_entry_id': <ANY>,\n+    'device_class': None,\n+    'device_id': <ANY>,\n+    'disabled_by': None,\n+    'domain': 'sensor',\n+    'entity_category': None,\n+    'entity_id': 'sensor.envoy_1234_meter_status_flags_active_net_consumption_ct_l1',\n+    'has_entity_name': True,\n+    'hidden_by': None,\n+    'icon': None,\n+    'id': <ANY>,\n+    'labels': set({\n+    }),\n+    'name': None,\n+    'options': dict({\n+    }),\n+    'original_device_class': None,\n+    'original_icon': 'mdi:flash',\n+    'original_name': 'Meter status flags active net consumption CT l1',\n+    'platform': 'enphase_envoy',\n+    'previous_unique_id': None,\n+    'supported_features': 0,\n+    'translation_key': 'net_ct_status_flags_phase',\n+    'unique_id': '1234_net_consumption_ct_status_flags_l1',\n+    'unit_of_measurement': None,\n+  })\n+# ---\n+# name: test_sensor[envoy_acb_batt][sensor.envoy_1234_meter_status_flags_active_net_consumption_ct_l1-state]\n+  StateSnapshot({\n+    'attributes': ReadOnlyDict({\n+      'friendly_name': 'Envoy 1234 Meter status flags active net consumption CT l1',\n+      'icon': 'mdi:flash',\n+    }),\n+    'context': <ANY>,\n+    'entity_id': 'sensor.envoy_1234_meter_status_flags_active_net_consumption_ct_l1',\n+    'last_changed': <ANY>,\n+    'last_reported': <ANY>,\n+    'last_updated': <ANY>,\n+    'state': '0',\n+  })\n+# ---\n+# name: test_sensor[envoy_acb_batt][sensor.envoy_1234_meter_status_flags_active_net_consumption_ct_l2-entry]\n+  EntityRegistryEntrySnapshot({\n+    'aliases': set({\n+    }),\n+    'area_id': None,\n+    'capabilities': None,\n+    'config_entry_id': <ANY>,\n+    'device_class': None,\n+    'device_id': <ANY>,\n+    'disabled_by': None,\n+    'domain': 'sensor',\n+    'entity_category': None,\n+    'entity_id': 'sensor.envoy_1234_meter_status_flags_active_net_consumption_ct_l2',\n+    'has_entity_name': True,\n+    'hidden_by': None,\n+    'icon': None,\n+    'id': <ANY>,\n+    'labels': set({\n+    }),\n+    'name': None,\n+    'options': dict({\n+    }),\n+    'original_device_class': None,\n+    'original_icon': 'mdi:flash',\n+    'original_name': 'Meter status flags active net consumption CT l2',\n+    'platform': 'enphase_envoy',\n+    'previous_unique_id': None,\n+    'supported_features': 0,\n+    'translation_key': 'net_ct_status_flags_phase',\n+    'unique_id': '1234_net_consumption_ct_status_flags_l2',\n+    'unit_of_measurement': None,\n+  })\n+# ---\n+# name: test_sensor[envoy_acb_batt][sensor.envoy_1234_meter_status_flags_active_net_consumption_ct_l2-state]\n+  StateSnapshot({\n+    'attributes': ReadOnlyDict({\n+      'friendly_name': 'Envoy 1234 Meter status flags active net consumption CT l2',\n+      'icon': 'mdi:flash',\n+    }),\n+    'context': <ANY>,\n+    'entity_id': 'sensor.envoy_1234_meter_status_flags_active_net_consumption_ct_l2',\n+    'last_changed': <ANY>,\n+    'last_reported': <ANY>,\n+    'last_updated': <ANY>,\n+    'state': '0',\n+  })\n+# ---\n+# name: test_sensor[envoy_acb_batt][sensor.envoy_1234_meter_status_flags_active_net_consumption_ct_l3-entry]\n+  EntityRegistryEntrySnapshot({\n+    'aliases': set({\n+    }),\n+    'area_id': None,\n+    'capabilities': None,\n+    'config_entry_id': <ANY>,\n+    'device_class': None,\n+    'device_id': <ANY>,\n+    'disabled_by': None,\n+    'domain': 'sensor',\n+    'entity_category': None,\n+    'entity_id': 'sensor.envoy_1234_meter_status_flags_active_net_consumption_ct_l3',\n+    'has_entity_name': True,\n+    'hidden_by': None,\n+    'icon': None,\n+    'id': <ANY>,\n+    'labels': set({\n+    }),\n+    'name': None,\n+    'options': dict({\n+    }),\n+    'original_device_class': None,\n+    'original_icon': 'mdi:flash',\n+    'original_name': 'Meter status flags active net consumption CT l3',\n+    'platform': 'enphase_envoy',\n+    'previous_unique_id': None,\n+    'supported_features': 0,\n+    'translation_key': 'net_ct_status_flags_phase',\n+    'unique_id': '1234_net_consumption_ct_status_flags_l3',\n+    'unit_of_measurement': None,\n+  })\n+# ---\n+# name: test_sensor[envoy_acb_batt][sensor.envoy_1234_meter_status_flags_active_net_consumption_ct_l3-state]\n+  StateSnapshot({\n+    'attributes': ReadOnlyDict({\n+      'friendly_name': 'Envoy 1234 Meter status flags active net consumption CT l3',\n+      'icon': 'mdi:flash',\n+    }),\n+    'context': <ANY>,\n+    'entity_id': 'sensor.envoy_1234_meter_status_flags_active_net_consumption_ct_l3',\n+    'last_changed': <ANY>,\n+    'last_reported': <ANY>,\n+    'last_updated': <ANY>,\n+    'state': '0',\n+  })\n+# ---\n+# name: test_sensor[envoy_acb_batt][sensor.envoy_1234_meter_status_flags_active_production_ct-entry]\n+  EntityRegistryEntrySnapshot({\n+    'aliases': set({\n+    }),\n+    'area_id': None,\n+    'capabilities': None,\n+    'config_entry_id': <ANY>,\n+    'device_class': None,\n+    'device_id': <ANY>,\n+    'disabled_by': None,\n+    'domain': 'sensor',\n+    'entity_category': None,\n+    'entity_id': 'sensor.envoy_1234_meter_status_flags_active_production_ct',\n+    'has_entity_name': True,\n+    'hidden_by': None,\n+    'icon': None,\n+    'id': <ANY>,\n+    'labels': set({\n+    }),\n+    'name': None,\n+    'options': dict({\n+    }),\n+    'original_device_class': None,\n+    'original_icon': 'mdi:flash',\n+    'original_name': 'Meter status flags active production CT',\n+    'platform': 'enphase_envoy',\n+    'previous_unique_id': None,\n+    'supported_features': 0,\n+    'translation_key': 'production_ct_status_flags',\n+    'unique_id': '1234_production_ct_status_flags',\n+    'unit_of_measurement': None,\n+  })\n+# ---\n+# name: test_sensor[envoy_acb_batt][sensor.envoy_1234_meter_status_flags_active_production_ct-state]\n+  StateSnapshot({\n+    'attributes': ReadOnlyDict({\n+      'friendly_name': 'Envoy 1234 Meter status flags active production CT',\n+      'icon': 'mdi:flash',\n+    }),\n+    'context': <ANY>,\n+    'entity_id': 'sensor.envoy_1234_meter_status_flags_active_production_ct',\n+    'last_changed': <ANY>,\n+    'last_reported': <ANY>,\n+    'last_updated': <ANY>,\n+    'state': '2',\n+  })\n+# ---\n+# name: test_sensor[envoy_acb_batt][sensor.envoy_1234_meter_status_flags_active_production_ct_l1-entry]\n+  EntityRegistryEntrySnapshot({\n+    'aliases': set({\n+    }),\n+    'area_id': None,\n+    'capabilities': None,\n+    'config_entry_id': <ANY>,\n+    'device_class': None,\n+    'device_id': <ANY>,\n+    'disabled_by': None,\n+    'domain': 'sensor',\n+    'entity_category': None,\n+    'entity_id': 'sensor.envoy_1234_meter_status_flags_active_production_ct_l1',\n+    'has_entity_name': True,\n+    'hidden_by': None,\n+    'icon': None,\n+    'id': <ANY>,\n+    'labels': set({\n+    }),\n+    'name': None,\n+    'options': dict({\n+    }),\n+    'original_device_class': None,\n+    'original_icon': 'mdi:flash',\n+    'original_name': 'Meter status flags active production CT l1',\n+    'platform': 'enphase_envoy',\n+    'previous_unique_id': None,\n+    'supported_features': 0,\n+    'translation_key': 'production_ct_status_flags_phase',\n+    'unique_id': '1234_production_ct_status_flags_l1',\n+    'unit_of_measurement': None,\n+  })\n+# ---\n+# name: test_sensor[envoy_acb_batt][sensor.envoy_1234_meter_status_flags_active_production_ct_l1-state]\n+  StateSnapshot({\n+    'attributes': ReadOnlyDict({\n+      'friendly_name': 'Envoy 1234 Meter status flags active production CT l1',\n+      'icon': 'mdi:flash',\n+    }),\n+    'context': <ANY>,\n+    'entity_id': 'sensor.envoy_1234_meter_status_flags_active_production_ct_l1',\n+    'last_changed': <ANY>,\n+    'last_reported': <ANY>,\n+    'last_updated': <ANY>,\n+    'state': '1',\n+  })\n+# ---\n+# name: test_sensor[envoy_acb_batt][sensor.envoy_1234_meter_status_flags_active_production_ct_l2-entry]\n+  EntityRegistryEntrySnapshot({\n+    'aliases': set({\n+    }),\n+    'area_id': None,\n+    'capabilities': None,\n+    'config_entry_id': <ANY>,\n+    'device_class': None,\n+    'device_id': <ANY>,\n+    'disabled_by': None,\n+    'domain': 'sensor',\n+    'entity_category': None,\n+    'entity_id': 'sensor.envoy_1234_meter_status_flags_active_production_ct_l2',\n+    'has_entity_name': True,\n+    'hidden_by': None,\n+    'icon': None,\n+    'id': <ANY>,\n+    'labels': set({\n+    }),\n+    'name': None,\n+    'options': dict({\n+    }),\n+    'original_device_class': None,\n+    'original_icon': 'mdi:flash',\n+    'original_name': 'Meter status flags active production CT l2',\n+    'platform': 'enphase_envoy',\n+    'previous_unique_id': None,\n+    'supported_features': 0,\n+    'translation_key': 'production_ct_status_flags_phase',\n+    'unique_id': '1234_production_ct_status_flags_l2',\n+    'unit_of_measurement': None,\n+  })\n+# ---\n+# name: test_sensor[envoy_acb_batt][sensor.envoy_1234_meter_status_flags_active_production_ct_l2-state]\n+  StateSnapshot({\n+    'attributes': ReadOnlyDict({\n+      'friendly_name': 'Envoy 1234 Meter status flags active production CT l2',\n+      'icon': 'mdi:flash',\n+    }),\n+    'context': <ANY>,\n+    'entity_id': 'sensor.envoy_1234_meter_status_flags_active_production_ct_l2',\n+    'last_changed': <ANY>,\n+    'last_reported': <ANY>,\n+    'last_updated': <ANY>,\n+    'state': '1',\n+  })\n+# ---\n+# name: test_sensor[envoy_acb_batt][sensor.envoy_1234_meter_status_flags_active_production_ct_l3-entry]\n+  EntityRegistryEntrySnapshot({\n+    'aliases': set({\n+    }),\n+    'area_id': None,\n+    'capabilities': None,\n+    'config_entry_id': <ANY>,\n+    'device_class': None,\n+    'device_id': <ANY>,\n+    'disabled_by': None,\n+    'domain': 'sensor',\n+    'entity_category': None,\n+    'entity_id': 'sensor.envoy_1234_meter_status_flags_active_production_ct_l3',\n+    'has_entity_name': True,\n+    'hidden_by': None,\n+    'icon': None,\n+    'id': <ANY>,\n+    'labels': set({\n+    }),\n+    'name': None,\n+    'options': dict({\n+    }),\n+    'original_device_class': None,\n+    'original_icon': 'mdi:flash',\n+    'original_name': 'Meter status flags active production CT l3',\n+    'platform': 'enphase_envoy',\n+    'previous_unique_id': None,\n+    'supported_features': 0,\n+    'translation_key': 'production_ct_status_flags_phase',\n+    'unique_id': '1234_production_ct_status_flags_l3',\n+    'unit_of_measurement': None,\n+  })\n+# ---\n+# name: test_sensor[envoy_acb_batt][sensor.envoy_1234_meter_status_flags_active_production_ct_l3-state]\n+  StateSnapshot({\n+    'attributes': ReadOnlyDict({\n+      'friendly_name': 'Envoy 1234 Meter status flags active production CT l3',\n+      'icon': 'mdi:flash',\n+    }),\n+    'context': <ANY>,\n+    'entity_id': 'sensor.envoy_1234_meter_status_flags_active_production_ct_l3',\n+    'last_changed': <ANY>,\n+    'last_reported': <ANY>,\n+    'last_updated': <ANY>,\n+    'state': '0',\n+  })\n+# ---\n+# name: test_sensor[envoy_acb_batt][sensor.envoy_1234_metering_status_net_consumption_ct-entry]\n+  EntityRegistryEntrySnapshot({\n+    'aliases': set({\n+    }),\n+    'area_id': None,\n+    'capabilities': dict({\n+      'options': list([\n+        <CtMeterStatus.NORMAL: 'normal'>,\n+        <CtMeterStatus.NOT_METERING: 'not-metering'>,\n+        <CtMeterStatus.CHECK_WIRING: 'check-wiring'>,\n+      ]),\n+    }),\n+    'config_entry_id': <ANY>,\n+    'device_class': None,\n+    'device_id': <ANY>,\n+    'disabled_by': None,\n+    'domain': 'sensor',\n+    'entity_category': None,\n+    'entity_id': 'sensor.envoy_1234_metering_status_net_consumption_ct',\n+    'has_entity_name': True,\n+    'hidden_by': None,\n+    'icon': None,\n+    'id': <ANY>,\n+    'labels': set({\n+    }),\n+    'name': None,\n+    'options': dict({\n+    }),\n+    'original_device_class': <SensorDeviceClass.ENUM: 'enum'>,\n+    'original_icon': 'mdi:flash',\n+    'original_name': 'Metering status net consumption CT',\n+    'platform': 'enphase_envoy',\n+    'previous_unique_id': None,\n+    'supported_features': 0,\n+    'translation_key': 'net_ct_metering_status',\n+    'unique_id': '1234_net_consumption_ct_metering_status',\n+    'unit_of_measurement': None,\n+  })\n+# ---\n+# name: test_sensor[envoy_acb_batt][sensor.envoy_1234_metering_status_net_consumption_ct-state]\n+  StateSnapshot({\n+    'attributes': ReadOnlyDict({\n+      'device_class': 'enum',\n+      'friendly_name': 'Envoy 1234 Metering status net consumption CT',\n+      'icon': 'mdi:flash',\n+      'options': list([\n+        <CtMeterStatus.NORMAL: 'normal'>,\n+        <CtMeterStatus.NOT_METERING: 'not-metering'>,\n+        <CtMeterStatus.CHECK_WIRING: 'check-wiring'>,\n+      ]),\n+    }),\n+    'context': <ANY>,\n+    'entity_id': 'sensor.envoy_1234_metering_status_net_consumption_ct',\n+    'last_changed': <ANY>,\n+    'last_reported': <ANY>,\n+    'last_updated': <ANY>,\n+    'state': 'normal',\n+  })\n+# ---\n+# name: test_sensor[envoy_acb_batt][sensor.envoy_1234_metering_status_net_consumption_ct_l1-entry]\n+  EntityRegistryEntrySnapshot({\n+    'aliases': set({\n+    }),\n+    'area_id': None,\n+    'capabilities': dict({\n+      'options': list([\n+        <CtMeterStatus.NORMAL: 'normal'>,\n+        <CtMeterStatus.NOT_METERING: 'not-metering'>,\n+        <CtMeterStatus.CHECK_WIRING: 'check-wiring'>,\n+      ]),\n+    }),\n+    'config_entry_id': <ANY>,\n+    'device_class': None,\n+    'device_id': <ANY>,\n+    'disabled_by': None,\n+    'domain': 'sensor',\n+    'entity_category': None,\n+    'entity_id': 'sensor.envoy_1234_metering_status_net_consumption_ct_l1',\n+    'has_entity_name': True,\n+    'hidden_by': None,\n+    'icon': None,\n+    'id': <ANY>,\n+    'labels': set({\n+    }),\n+    'name': None,\n+    'options': dict({\n+    }),\n+    'original_device_class': <SensorDeviceClass.ENUM: 'enum'>,\n+    'original_icon': 'mdi:flash',\n+    'original_name': 'Metering status net consumption CT l1',\n+    'platform': 'enphase_envoy',\n+    'previous_unique_id': None,\n+    'supported_features': 0,\n+    'translation_key': 'net_ct_metering_status_phase',\n+    'unique_id': '1234_net_consumption_ct_metering_status_l1',\n+    'unit_of_measurement': None,\n+  })\n+# ---\n+# name: test_sensor[envoy_acb_batt][sensor.envoy_1234_metering_status_net_consumption_ct_l1-state]\n+  StateSnapshot({\n+    'attributes': ReadOnlyDict({\n+      'device_class': 'enum',\n+      'friendly_name': 'Envoy 1234 Metering status net consumption CT l1',\n+      'icon': 'mdi:flash',\n+      'options': list([\n+        <CtMeterStatus.NORMAL: 'normal'>,\n+        <CtMeterStatus.NOT_METERING: 'not-metering'>,\n+        <CtMeterStatus.CHECK_WIRING: 'check-wiring'>,\n+      ]),\n+    }),\n+    'context': <ANY>,\n+    'entity_id': 'sensor.envoy_1234_metering_status_net_consumption_ct_l1',\n+    'last_changed': <ANY>,\n+    'last_reported': <ANY>,\n+    'last_updated': <ANY>,\n+    'state': 'normal',\n+  })\n+# ---\n+# name: test_sensor[envoy_acb_batt][sensor.envoy_1234_metering_status_net_consumption_ct_l2-entry]\n+  EntityRegistryEntrySnapshot({\n+    'aliases': set({\n+    }),\n+    'area_id': None,\n+    'capabilities': dict({\n+      'options': list([\n+        <CtMeterStatus.NORMAL: 'normal'>,\n+        <CtMeterStatus.NOT_METERING: 'not-metering'>,\n+        <CtMeterStatus.CHECK_WIRING: 'check-wiring'>,\n+      ]),\n+    }),\n+    'config_entry_id': <ANY>,\n+    'device_class': None,\n+    'device_id': <ANY>,\n+    'disabled_by': None,\n+    'domain': 'sensor',\n+    'entity_category': None,\n+    'entity_id': 'sensor.envoy_1234_metering_status_net_consumption_ct_l2',\n+    'has_entity_name': True,\n+    'hidden_by': None,\n+    'icon': None,\n+    'id': <ANY>,\n+    'labels': set({\n+    }),\n+    'name': None,\n+    'options': dict({\n+    }),\n+    'original_device_class': <SensorDeviceClass.ENUM: 'enum'>,\n+    'original_icon': 'mdi:flash',\n+    'original_name': 'Metering status net consumption CT l2',\n+    'platform': 'enphase_envoy',\n+    'previous_unique_id': None,\n+    'supported_features': 0,\n+    'translation_key': 'net_ct_metering_status_phase',\n+    'unique_id': '1234_net_consumption_ct_metering_status_l2',\n+    'unit_of_measurement': None,\n+  })\n+# ---\n+# name: test_sensor[envoy_acb_batt][sensor.envoy_1234_metering_status_net_consumption_ct_l2-state]\n+  StateSnapshot({\n+    'attributes': ReadOnlyDict({\n+      'device_class': 'enum',\n+      'friendly_name': 'Envoy 1234 Metering status net consumption CT l2',\n+      'icon': 'mdi:flash',\n+      'options': list([\n+        <CtMeterStatus.NORMAL: 'normal'>,\n+        <CtMeterStatus.NOT_METERING: 'not-metering'>,\n+        <CtMeterStatus.CHECK_WIRING: 'check-wiring'>,\n+      ]),\n+    }),\n+    'context': <ANY>,\n+    'entity_id': 'sensor.envoy_1234_metering_status_net_consumption_ct_l2',\n+    'last_changed': <ANY>,\n+    'last_reported': <ANY>,\n+    'last_updated': <ANY>,\n+    'state': 'normal',\n+  })\n+# ---\n+# name: test_sensor[envoy_acb_batt][sensor.envoy_1234_metering_status_net_consumption_ct_l3-entry]\n+  EntityRegistryEntrySnapshot({\n+    'aliases': set({\n+    }),\n+    'area_id': None,\n+    'capabilities': dict({\n+      'options': list([\n+        <CtMeterStatus.NORMAL: 'normal'>,\n+        <CtMeterStatus.NOT_METERING: 'not-metering'>,\n+        <CtMeterStatus.CHECK_WIRING: 'check-wiring'>,\n+      ]),\n+    }),\n+    'config_entry_id': <ANY>,\n+    'device_class': None,\n+    'device_id': <ANY>,\n+    'disabled_by': None,\n+    'domain': 'sensor',\n+    'entity_category': None,\n+    'entity_id': 'sensor.envoy_1234_metering_status_net_consumption_ct_l3',\n+    'has_entity_name': True,\n+    'hidden_by': None,\n+    'icon': None,\n+    'id': <ANY>,\n+    'labels': set({\n+    }),\n+    'name': None,\n+    'options': dict({\n+    }),\n+    'original_device_class': <SensorDeviceClass.ENUM: 'enum'>,\n+    'original_icon': 'mdi:flash',\n+    'original_name': 'Metering status net consumption CT l3',\n+    'platform': 'enphase_envoy',\n+    'previous_unique_id': None,\n+    'supported_features': 0,\n+    'translation_key': 'net_ct_metering_status_phase',\n+    'unique_id': '1234_net_consumption_ct_metering_status_l3',\n+    'unit_of_measurement': None,\n+  })\n+# ---\n+# name: test_sensor[envoy_acb_batt][sensor.envoy_1234_metering_status_net_consumption_ct_l3-state]\n+  StateSnapshot({\n+    'attributes': ReadOnlyDict({\n+      'device_class': 'enum',\n+      'friendly_name': 'Envoy 1234 Metering status net consumption CT l3',\n+      'icon': 'mdi:flash',\n+      'options': list([\n+        <CtMeterStatus.NORMAL: 'normal'>,\n+        <CtMeterStatus.NOT_METERING: 'not-metering'>,\n+        <CtMeterStatus.CHECK_WIRING: 'check-wiring'>,\n+      ]),\n+    }),\n+    'context': <ANY>,\n+    'entity_id': 'sensor.envoy_1234_metering_status_net_consumption_ct_l3',\n+    'last_changed': <ANY>,\n+    'last_reported': <ANY>,\n+    'last_updated': <ANY>,\n+    'state': 'normal',\n+  })\n+# ---\n+# name: test_sensor[envoy_acb_batt][sensor.envoy_1234_metering_status_production_ct-entry]\n+  EntityRegistryEntrySnapshot({\n+    'aliases': set({\n+    }),\n+    'area_id': None,\n+    'capabilities': dict({\n+      'options': list([\n+        <CtMeterStatus.NORMAL: 'normal'>,\n+        <CtMeterStatus.NOT_METERING: 'not-metering'>,\n+        <CtMeterStatus.CHECK_WIRING: 'check-wiring'>,\n+      ]),\n+    }),\n+    'config_entry_id': <ANY>,\n+    'device_class': None,\n+    'device_id': <ANY>,\n+    'disabled_by': None,\n+    'domain': 'sensor',\n+    'entity_category': None,\n+    'entity_id': 'sensor.envoy_1234_metering_status_production_ct',\n+    'has_entity_name': True,\n+    'hidden_by': None,\n+    'icon': None,\n+    'id': <ANY>,\n+    'labels': set({\n+    }),\n+    'name': None,\n+    'options': dict({\n+    }),\n+    'original_device_class': <SensorDeviceClass.ENUM: 'enum'>,\n+    'original_icon': 'mdi:flash',\n+    'original_name': 'Metering status production CT',\n+    'platform': 'enphase_envoy',\n+    'previous_unique_id': None,\n+    'supported_features': 0,\n+    'translation_key': 'production_ct_metering_status',\n+    'unique_id': '1234_production_ct_metering_status',\n+    'unit_of_measurement': None,\n+  })\n+# ---\n+# name: test_sensor[envoy_acb_batt][sensor.envoy_1234_metering_status_production_ct-state]\n+  StateSnapshot({\n+    'attributes': ReadOnlyDict({\n+      'device_class': 'enum',\n+      'friendly_name': 'Envoy 1234 Metering status production CT',\n+      'icon': 'mdi:flash',\n+      'options': list([\n+        <CtMeterStatus.NORMAL: 'normal'>,\n+        <CtMeterStatus.NOT_METERING: 'not-metering'>,\n+        <CtMeterStatus.CHECK_WIRING: 'check-wiring'>,\n+      ]),\n+    }),\n+    'context': <ANY>,\n+    'entity_id': 'sensor.envoy_1234_metering_status_production_ct',\n+    'last_changed': <ANY>,\n+    'last_reported': <ANY>,\n+    'last_updated': <ANY>,\n+    'state': 'normal',\n+  })\n+# ---\n+# name: test_sensor[envoy_acb_batt][sensor.envoy_1234_metering_status_production_ct_l1-entry]\n+  EntityRegistryEntrySnapshot({\n+    'aliases': set({\n+    }),\n+    'area_id': None,\n+    'capabilities': dict({\n+      'options': list([\n+        <CtMeterStatus.NORMAL: 'normal'>,\n+        <CtMeterStatus.NOT_METERING: 'not-metering'>,\n+        <CtMeterStatus.CHECK_WIRING: 'check-wiring'>,\n+      ]),\n+    }),\n+    'config_entry_id': <ANY>,\n+    'device_class': None,\n+    'device_id': <ANY>,\n+    'disabled_by': None,\n+    'domain': 'sensor',\n+    'entity_category': None,\n+    'entity_id': 'sensor.envoy_1234_metering_status_production_ct_l1',\n+    'has_entity_name': True,\n+    'hidden_by': None,\n+    'icon': None,\n+    'id': <ANY>,\n+    'labels': set({\n+    }),\n+    'name': None,\n+    'options': dict({\n+    }),\n+    'original_device_class': <SensorDeviceClass.ENUM: 'enum'>,\n+    'original_icon': 'mdi:flash',\n+    'original_name': 'Metering status production CT l1',\n+    'platform': 'enphase_envoy',\n+    'previous_unique_id': None,\n+    'supported_features': 0,\n+    'translation_key': 'production_ct_metering_status_phase',\n+    'unique_id': '1234_production_ct_metering_status_l1',\n+    'unit_of_measurement': None,\n+  })\n+# ---\n+# name: test_sensor[envoy_acb_batt][sensor.envoy_1234_metering_status_production_ct_l1-state]\n+  StateSnapshot({\n+    'attributes': ReadOnlyDict({\n+      'device_class': 'enum',\n+      'friendly_name': 'Envoy 1234 Metering status production CT l1',\n+      'icon': 'mdi:flash',\n+      'options': list([\n+        <CtMeterStatus.NORMAL: 'normal'>,\n+        <CtMeterStatus.NOT_METERING: 'not-metering'>,\n+        <CtMeterStatus.CHECK_WIRING: 'check-wiring'>,\n+      ]),\n+    }),\n+    'context': <ANY>,\n+    'entity_id': 'sensor.envoy_1234_metering_status_production_ct_l1',\n+    'last_changed': <ANY>,\n+    'last_reported': <ANY>,\n+    'last_updated': <ANY>,\n+    'state': 'normal',\n+  })\n+# ---\n+# name: test_sensor[envoy_acb_batt][sensor.envoy_1234_metering_status_production_ct_l2-entry]\n+  EntityRegistryEntrySnapshot({\n+    'aliases': set({\n+    }),\n+    'area_id': None,\n+    'capabilities': dict({\n+      'options': list([\n+        <CtMeterStatus.NORMAL: 'normal'>,\n+        <CtMeterStatus.NOT_METERING: 'not-metering'>,\n+        <CtMeterStatus.CHECK_WIRING: 'check-wiring'>,\n+      ]),\n+    }),\n+    'config_entry_id': <ANY>,\n+    'device_class': None,\n+    'device_id': <ANY>,\n+    'disabled_by': None,\n+    'domain': 'sensor',\n+    'entity_category': None,\n+    'entity_id': 'sensor.envoy_1234_metering_status_production_ct_l2',\n+    'has_entity_name': True,\n+    'hidden_by': None,\n+    'icon': None,\n+    'id': <ANY>,\n+    'labels': set({\n+    }),\n+    'name': None,\n+    'options': dict({\n+    }),\n+    'original_device_class': <SensorDeviceClass.ENUM: 'enum'>,\n+    'original_icon': 'mdi:flash',\n+    'original_name': 'Metering status production CT l2',\n+    'platform': 'enphase_envoy',\n+    'previous_unique_id': None,\n+    'supported_features': 0,\n+    'translation_key': 'production_ct_metering_status_phase',\n+    'unique_id': '1234_production_ct_metering_status_l2',\n+    'unit_of_measurement': None,\n+  })\n+# ---\n+# name: test_sensor[envoy_acb_batt][sensor.envoy_1234_metering_status_production_ct_l2-state]\n+  StateSnapshot({\n+    'attributes': ReadOnlyDict({\n+      'device_class': 'enum',\n+      'friendly_name': 'Envoy 1234 Metering status production CT l2',\n+      'icon': 'mdi:flash',\n+      'options': list([\n+        <CtMeterStatus.NORMAL: 'normal'>,\n+        <CtMeterStatus.NOT_METERING: 'not-metering'>,\n+        <CtMeterStatus.CHECK_WIRING: 'check-wiring'>,\n+      ]),\n+    }),\n+    'context': <ANY>,\n+    'entity_id': 'sensor.envoy_1234_metering_status_production_ct_l2',\n+    'last_changed': <ANY>,\n+    'last_reported': <ANY>,\n+    'last_updated': <ANY>,\n+    'state': 'normal',\n+  })\n+# ---\n+# name: test_sensor[envoy_acb_batt][sensor.envoy_1234_metering_status_production_ct_l3-entry]\n+  EntityRegistryEntrySnapshot({\n+    'aliases': set({\n+    }),\n+    'area_id': None,\n+    'capabilities': dict({\n+      'options': list([\n+        <CtMeterStatus.NORMAL: 'normal'>,\n+        <CtMeterStatus.NOT_METERING: 'not-metering'>,\n+        <CtMeterStatus.CHECK_WIRING: 'check-wiring'>,\n+      ]),\n+    }),\n+    'config_entry_id': <ANY>,\n+    'device_class': None,\n+    'device_id': <ANY>,\n+    'disabled_by': None,\n+    'domain': 'sensor',\n+    'entity_category': None,\n+    'entity_id': 'sensor.envoy_1234_metering_status_production_ct_l3',\n+    'has_entity_name': True,\n+    'hidden_by': None,\n+    'icon': None,\n+    'id': <ANY>,\n+    'labels': set({\n+    }),\n+    'name': None,\n+    'options': dict({\n+    }),\n+    'original_device_class': <SensorDeviceClass.ENUM: 'enum'>,\n+    'original_icon': 'mdi:flash',\n+    'original_name': 'Metering status production CT l3',\n+    'platform': 'enphase_envoy',\n+    'previous_unique_id': None,\n+    'supported_features': 0,\n+    'translation_key': 'production_ct_metering_status_phase',\n+    'unique_id': '1234_production_ct_metering_status_l3',\n+    'unit_of_measurement': None,\n+  })\n+# ---\n+# name: test_sensor[envoy_acb_batt][sensor.envoy_1234_metering_status_production_ct_l3-state]\n+  StateSnapshot({\n+    'attributes': ReadOnlyDict({\n+      'device_class': 'enum',\n+      'friendly_name': 'Envoy 1234 Metering status production CT l3',\n+      'icon': 'mdi:flash',\n+      'options': list([\n+        <CtMeterStatus.NORMAL: 'normal'>,\n+        <CtMeterStatus.NOT_METERING: 'not-metering'>,\n+        <CtMeterStatus.CHECK_WIRING: 'check-wiring'>,\n+      ]),\n+    }),\n+    'context': <ANY>,\n+    'entity_id': 'sensor.envoy_1234_metering_status_production_ct_l3',\n+    'last_changed': <ANY>,\n+    'last_reported': <ANY>,\n+    'last_updated': <ANY>,\n+    'state': 'normal',\n+  })\n+# ---\n+# name: test_sensor[envoy_acb_batt][sensor.envoy_1234_net_consumption_ct_current-entry]\n+  EntityRegistryEntrySnapshot({\n+    'aliases': set({\n+    }),\n+    'area_id': None,\n+    'capabilities': dict({\n+      'state_class': <SensorStateClass.MEASUREMENT: 'measurement'>,\n+    }),\n+    'config_entry_id': <ANY>,\n+    'device_class': None,\n+    'device_id': <ANY>,\n+    'disabled_by': None,\n+    'domain': 'sensor',\n+    'entity_category': None,\n+    'entity_id': 'sensor.envoy_1234_net_consumption_ct_current',\n+    'has_entity_name': True,\n+    'hidden_by': None,\n+    'icon': None,\n+    'id': <ANY>,\n+    'labels': set({\n+    }),\n+    'name': None,\n+    'options': dict({\n+      'sensor': dict({\n+        'suggested_display_precision': 3,\n+      }),\n+      'sensor.private': dict({\n+        'suggested_unit_of_measurement': <UnitOfElectricCurrent.AMPERE: 'A'>,\n+      }),\n+    }),\n+    'original_device_class': <SensorDeviceClass.CURRENT: 'current'>,\n+    'original_icon': 'mdi:flash',\n+    'original_name': 'Net consumption CT current',\n+    'platform': 'enphase_envoy',\n+    'previous_unique_id': None,\n+    'supported_features': 0,\n+    'translation_key': 'net_ct_current',\n+    'unique_id': '1234_net_ct_current',\n+    'unit_of_measurement': <UnitOfElectricCurrent.AMPERE: 'A'>,\n+  })\n+# ---\n+# name: test_sensor[envoy_acb_batt][sensor.envoy_1234_net_consumption_ct_current-state]\n+  StateSnapshot({\n+    'attributes': ReadOnlyDict({\n+      'device_class': 'current',\n+      'friendly_name': 'Envoy 1234 Net consumption CT current',\n+      'icon': 'mdi:flash',\n+      'state_class': <SensorStateClass.MEASUREMENT: 'measurement'>,\n+      'unit_of_measurement': <UnitOfElectricCurrent.AMPERE: 'A'>,\n+    }),\n+    'context': <ANY>,\n+    'entity_id': 'sensor.envoy_1234_net_consumption_ct_current',\n+    'last_changed': <ANY>,\n+    'last_reported': <ANY>,\n+    'last_updated': <ANY>,\n+    'state': '0.3',\n+  })\n+# ---\n+# name: test_sensor[envoy_acb_batt][sensor.envoy_1234_net_consumption_ct_current_l1-entry]\n+  EntityRegistryEntrySnapshot({\n+    'aliases': set({\n+    }),\n+    'area_id': None,\n+    'capabilities': dict({\n+      'state_class': <SensorStateClass.MEASUREMENT: 'measurement'>,\n+    }),\n+    'config_entry_id': <ANY>,\n+    'device_class': None,\n+    'device_id': <ANY>,\n+    'disabled_by': None,\n+    'domain': 'sensor',\n+    'entity_category': None,\n+    'entity_id': 'sensor.envoy_1234_net_consumption_ct_current_l1',\n+    'has_entity_name': True,\n+    'hidden_by': None,\n+    'icon': None,\n+    'id': <ANY>,\n+    'labels': set({\n+    }),\n+    'name': None,\n+    'options': dict({\n+      'sensor': dict({\n+        'suggested_display_precision': 3,\n+      }),\n+      'sensor.private': dict({\n+        'suggested_unit_of_measurement': <UnitOfElectricCurrent.AMPERE: 'A'>,\n+      }),\n+    }),\n+    'original_device_class': <SensorDeviceClass.CURRENT: 'current'>,\n+    'original_icon': 'mdi:flash',\n+    'original_name': 'Net consumption CT current l1',\n+    'platform': 'enphase_envoy',\n+    'previous_unique_id': None,\n+    'supported_features': 0,\n+    'translation_key': 'net_ct_current_phase',\n+    'unique_id': '1234_net_ct_current_l1',\n+    'unit_of_measurement': <UnitOfElectricCurrent.AMPERE: 'A'>,\n+  })\n+# ---\n+# name: test_sensor[envoy_acb_batt][sensor.envoy_1234_net_consumption_ct_current_l1-state]\n+  StateSnapshot({\n+    'attributes': ReadOnlyDict({\n+      'device_class': 'current',\n+      'friendly_name': 'Envoy 1234 Net consumption CT current l1',\n+      'icon': 'mdi:flash',\n+      'state_class': <SensorStateClass.MEASUREMENT: 'measurement'>,\n+      'unit_of_measurement': <UnitOfElectricCurrent.AMPERE: 'A'>,\n+    }),\n+    'context': <ANY>,\n+    'entity_id': 'sensor.envoy_1234_net_consumption_ct_current_l1',\n+    'last_changed': <ANY>,\n+    'last_reported': <ANY>,\n+    'last_updated': <ANY>,\n+    'state': '0.3',\n+  })\n+# ---\n+# name: test_sensor[envoy_acb_batt][sensor.envoy_1234_net_consumption_ct_current_l2-entry]\n+  EntityRegistryEntrySnapshot({\n+    'aliases': set({\n+    }),\n+    'area_id': None,\n+    'capabilities': dict({\n+      'state_class': <SensorStateClass.MEASUREMENT: 'measurement'>,\n+    }),\n+    'config_entry_id': <ANY>,\n+    'device_class': None,\n+    'device_id': <ANY>,\n+    'disabled_by': None,\n+    'domain': 'sensor',\n+    'entity_category': None,\n+    'entity_id': 'sensor.envoy_1234_net_consumption_ct_current_l2',\n+    'has_entity_name': True,\n+    'hidden_by': None,\n+    'icon': None,\n+    'id': <ANY>,\n+    'labels': set({\n+    }),\n+    'name': None,\n+    'options': dict({\n+      'sensor': dict({\n+        'suggested_display_precision': 3,\n+      }),\n+      'sensor.private': dict({\n+        'suggested_unit_of_measurement': <UnitOfElectricCurrent.AMPERE: 'A'>,\n+      }),\n+    }),\n+    'original_device_class': <SensorDeviceClass.CURRENT: 'current'>,\n+    'original_icon': 'mdi:flash',\n+    'original_name': 'Net consumption CT current l2',\n+    'platform': 'enphase_envoy',\n+    'previous_unique_id': None,\n+    'supported_features': 0,\n+    'translation_key': 'net_ct_current_phase',\n+    'unique_id': '1234_net_ct_current_l2',\n+    'unit_of_measurement': <UnitOfElectricCurrent.AMPERE: 'A'>,\n+  })\n+# ---\n+# name: test_sensor[envoy_acb_batt][sensor.envoy_1234_net_consumption_ct_current_l2-state]\n+  StateSnapshot({\n+    'attributes': ReadOnlyDict({\n+      'device_class': 'current',\n+      'friendly_name': 'Envoy 1234 Net consumption CT current l2',\n+      'icon': 'mdi:flash',\n+      'state_class': <SensorStateClass.MEASUREMENT: 'measurement'>,\n+      'unit_of_measurement': <UnitOfElectricCurrent.AMPERE: 'A'>,\n+    }),\n+    'context': <ANY>,\n+    'entity_id': 'sensor.envoy_1234_net_consumption_ct_current_l2',\n+    'last_changed': <ANY>,\n+    'last_reported': <ANY>,\n+    'last_updated': <ANY>,\n+    'state': '0.3',\n+  })\n+# ---\n+# name: test_sensor[envoy_acb_batt][sensor.envoy_1234_net_consumption_ct_current_l3-entry]\n+  EntityRegistryEntrySnapshot({\n+    'aliases': set({\n+    }),\n+    'area_id': None,\n+    'capabilities': dict({\n+      'state_class': <SensorStateClass.MEASUREMENT: 'measurement'>,\n+    }),\n+    'config_entry_id': <ANY>,\n+    'device_class': None,\n+    'device_id': <ANY>,\n+    'disabled_by': None,\n+    'domain': 'sensor',\n+    'entity_category': None,\n+    'entity_id': 'sensor.envoy_1234_net_consumption_ct_current_l3',\n+    'has_entity_name': True,\n+    'hidden_by': None,\n+    'icon': None,\n+    'id': <ANY>,\n+    'labels': set({\n+    }),\n+    'name': None,\n+    'options': dict({\n+      'sensor': dict({\n+        'suggested_display_precision': 3,\n+      }),\n+      'sensor.private': dict({\n+        'suggested_unit_of_measurement': <UnitOfElectricCurrent.AMPERE: 'A'>,\n+      }),\n+    }),\n+    'original_device_class': <SensorDeviceClass.CURRENT: 'current'>,\n+    'original_icon': 'mdi:flash',\n+    'original_name': 'Net consumption CT current l3',\n+    'platform': 'enphase_envoy',\n+    'previous_unique_id': None,\n+    'supported_features': 0,\n+    'translation_key': 'net_ct_current_phase',\n+    'unique_id': '1234_net_ct_current_l3',\n+    'unit_of_measurement': <UnitOfElectricCurrent.AMPERE: 'A'>,\n+  })\n+# ---\n+# name: test_sensor[envoy_acb_batt][sensor.envoy_1234_net_consumption_ct_current_l3-state]\n+  StateSnapshot({\n+    'attributes': ReadOnlyDict({\n+      'device_class': 'current',\n+      'friendly_name': 'Envoy 1234 Net consumption CT current l3',\n+      'icon': 'mdi:flash',\n+      'state_class': <SensorStateClass.MEASUREMENT: 'measurement'>,\n+      'unit_of_measurement': <UnitOfElectricCurrent.AMPERE: 'A'>,\n+    }),\n+    'context': <ANY>,\n+    'entity_id': 'sensor.envoy_1234_net_consumption_ct_current_l3',\n+    'last_changed': <ANY>,\n+    'last_reported': <ANY>,\n+    'last_updated': <ANY>,\n+    'state': '0.3',\n+  })\n+# ---\n+# name: test_sensor[envoy_acb_batt][sensor.envoy_1234_powerfactor_net_consumption_ct-entry]\n+  EntityRegistryEntrySnapshot({\n+    'aliases': set({\n+    }),\n+    'area_id': None,\n+    'capabilities': dict({\n+      'state_class': <SensorStateClass.MEASUREMENT: 'measurement'>,\n+    }),\n+    'config_entry_id': <ANY>,\n+    'device_class': None,\n+    'device_id': <ANY>,\n+    'disabled_by': None,\n+    'domain': 'sensor',\n+    'entity_category': None,\n+    'entity_id': 'sensor.envoy_1234_powerfactor_net_consumption_ct',\n+    'has_entity_name': True,\n+    'hidden_by': None,\n+    'icon': None,\n+    'id': <ANY>,\n+    'labels': set({\n+    }),\n+    'name': None,\n+    'options': dict({\n+      'sensor': dict({\n+        'suggested_display_precision': 2,\n+      }),\n+    }),\n+    'original_device_class': <SensorDeviceClass.POWER_FACTOR: 'power_factor'>,\n+    'original_icon': 'mdi:flash',\n+    'original_name': 'Powerfactor net consumption CT',\n+    'platform': 'enphase_envoy',\n+    'previous_unique_id': None,\n+    'supported_features': 0,\n+    'translation_key': 'net_ct_powerfactor',\n+    'unique_id': '1234_net_ct_powerfactor',\n+    'unit_of_measurement': None,\n+  })\n+# ---\n+# name: test_sensor[envoy_acb_batt][sensor.envoy_1234_powerfactor_net_consumption_ct-state]\n+  StateSnapshot({\n+    'attributes': ReadOnlyDict({\n+      'device_class': 'power_factor',\n+      'friendly_name': 'Envoy 1234 Powerfactor net consumption CT',\n+      'icon': 'mdi:flash',\n+      'state_class': <SensorStateClass.MEASUREMENT: 'measurement'>,\n+    }),\n+    'context': <ANY>,\n+    'entity_id': 'sensor.envoy_1234_powerfactor_net_consumption_ct',\n+    'last_changed': <ANY>,\n+    'last_reported': <ANY>,\n+    'last_updated': <ANY>,\n+    'state': '0.21',\n+  })\n+# ---\n+# name: test_sensor[envoy_acb_batt][sensor.envoy_1234_powerfactor_net_consumption_ct_l1-entry]\n+  EntityRegistryEntrySnapshot({\n+    'aliases': set({\n+    }),\n+    'area_id': None,\n+    'capabilities': dict({\n+      'state_class': <SensorStateClass.MEASUREMENT: 'measurement'>,\n+    }),\n+    'config_entry_id': <ANY>,\n+    'device_class': None,\n+    'device_id': <ANY>,\n+    'disabled_by': None,\n+    'domain': 'sensor',\n+    'entity_category': None,\n+    'entity_id': 'sensor.envoy_1234_powerfactor_net_consumption_ct_l1',\n+    'has_entity_name': True,\n+    'hidden_by': None,\n+    'icon': None,\n+    'id': <ANY>,\n+    'labels': set({\n+    }),\n+    'name': None,\n+    'options': dict({\n+      'sensor': dict({\n+        'suggested_display_precision': 2,\n+      }),\n+    }),\n+    'original_device_class': <SensorDeviceClass.POWER_FACTOR: 'power_factor'>,\n+    'original_icon': 'mdi:flash',\n+    'original_name': 'Powerfactor net consumption CT l1',\n+    'platform': 'enphase_envoy',\n+    'previous_unique_id': None,\n+    'supported_features': 0,\n+    'translation_key': 'net_ct_powerfactor_phase',\n+    'unique_id': '1234_net_ct_powerfactor_l1',\n+    'unit_of_measurement': None,\n+  })\n+# ---\n+# name: test_sensor[envoy_acb_batt][sensor.envoy_1234_powerfactor_net_consumption_ct_l1-state]\n+  StateSnapshot({\n+    'attributes': ReadOnlyDict({\n+      'device_class': 'power_factor',\n+      'friendly_name': 'Envoy 1234 Powerfactor net consumption CT l1',\n+      'icon': 'mdi:flash',\n+      'state_class': <SensorStateClass.MEASUREMENT: 'measurement'>,\n+    }),\n+    'context': <ANY>,\n+    'entity_id': 'sensor.envoy_1234_powerfactor_net_consumption_ct_l1',\n+    'last_changed': <ANY>,\n+    'last_reported': <ANY>,\n+    'last_updated': <ANY>,\n+    'state': '0.22',\n+  })\n+# ---\n+# name: test_sensor[envoy_acb_batt][sensor.envoy_1234_powerfactor_net_consumption_ct_l2-entry]\n+  EntityRegistryEntrySnapshot({\n+    'aliases': set({\n+    }),\n+    'area_id': None,\n+    'capabilities': dict({\n+      'state_class': <SensorStateClass.MEASUREMENT: 'measurement'>,\n+    }),\n+    'config_entry_id': <ANY>,\n+    'device_class': None,\n+    'device_id': <ANY>,\n+    'disabled_by': None,\n+    'domain': 'sensor',\n+    'entity_category': None,\n+    'entity_id': 'sensor.envoy_1234_powerfactor_net_consumption_ct_l2',\n+    'has_entity_name': True,\n+    'hidden_by': None,\n+    'icon': None,\n+    'id': <ANY>,\n+    'labels': set({\n+    }),\n+    'name': None,\n+    'options': dict({\n+      'sensor': dict({\n+        'suggested_display_precision': 2,\n+      }),\n+    }),\n+    'original_device_class': <SensorDeviceClass.POWER_FACTOR: 'power_factor'>,\n+    'original_icon': 'mdi:flash',\n+    'original_name': 'Powerfactor net consumption CT l2',\n+    'platform': 'enphase_envoy',\n+    'previous_unique_id': None,\n+    'supported_features': 0,\n+    'translation_key': 'net_ct_powerfactor_phase',\n+    'unique_id': '1234_net_ct_powerfactor_l2',\n+    'unit_of_measurement': None,\n+  })\n+# ---\n+# name: test_sensor[envoy_acb_batt][sensor.envoy_1234_powerfactor_net_consumption_ct_l2-state]\n+  StateSnapshot({\n+    'attributes': ReadOnlyDict({\n+      'device_class': 'power_factor',\n+      'friendly_name': 'Envoy 1234 Powerfactor net consumption CT l2',\n+      'icon': 'mdi:flash',\n+      'state_class': <SensorStateClass.MEASUREMENT: 'measurement'>,\n+    }),\n+    'context': <ANY>,\n+    'entity_id': 'sensor.envoy_1234_powerfactor_net_consumption_ct_l2',\n+    'last_changed': <ANY>,\n+    'last_reported': <ANY>,\n+    'last_updated': <ANY>,\n+    'state': '0.23',\n+  })\n+# ---\n+# name: test_sensor[envoy_acb_batt][sensor.envoy_1234_powerfactor_net_consumption_ct_l3-entry]\n+  EntityRegistryEntrySnapshot({\n+    'aliases': set({\n+    }),\n+    'area_id': None,\n+    'capabilities': dict({\n+      'state_class': <SensorStateClass.MEASUREMENT: 'measurement'>,\n+    }),\n+    'config_entry_id': <ANY>,\n+    'device_class': None,\n+    'device_id': <ANY>,\n+    'disabled_by': None,\n+    'domain': 'sensor',\n+    'entity_category': None,\n+    'entity_id': 'sensor.envoy_1234_powerfactor_net_consumption_ct_l3',\n+    'has_entity_name': True,\n+    'hidden_by': None,\n+    'icon': None,\n+    'id': <ANY>,\n+    'labels': set({\n+    }),\n+    'name': None,\n+    'options': dict({\n+      'sensor': dict({\n+        'suggested_display_precision': 2,\n+      }),\n+    }),\n+    'original_device_class': <SensorDeviceClass.POWER_FACTOR: 'power_factor'>,\n+    'original_icon': 'mdi:flash',\n+    'original_name': 'Powerfactor net consumption CT l3',\n+    'platform': 'enphase_envoy',\n+    'previous_unique_id': None,\n+    'supported_features': 0,\n+    'translation_key': 'net_ct_powerfactor_phase',\n+    'unique_id': '1234_net_ct_powerfactor_l3',\n+    'unit_of_measurement': None,\n+  })\n+# ---\n+# name: test_sensor[envoy_acb_batt][sensor.envoy_1234_powerfactor_net_consumption_ct_l3-state]\n+  StateSnapshot({\n+    'attributes': ReadOnlyDict({\n+      'device_class': 'power_factor',\n+      'friendly_name': 'Envoy 1234 Powerfactor net consumption CT l3',\n+      'icon': 'mdi:flash',\n+      'state_class': <SensorStateClass.MEASUREMENT: 'measurement'>,\n+    }),\n+    'context': <ANY>,\n+    'entity_id': 'sensor.envoy_1234_powerfactor_net_consumption_ct_l3',\n+    'last_changed': <ANY>,\n+    'last_reported': <ANY>,\n+    'last_updated': <ANY>,\n+    'state': '0.24',\n+  })\n+# ---\n+# name: test_sensor[envoy_acb_batt][sensor.envoy_1234_powerfactor_production_ct-entry]\n+  EntityRegistryEntrySnapshot({\n+    'aliases': set({\n+    }),\n+    'area_id': None,\n+    'capabilities': dict({\n+      'state_class': <SensorStateClass.MEASUREMENT: 'measurement'>,\n+    }),\n+    'config_entry_id': <ANY>,\n+    'device_class': None,\n+    'device_id': <ANY>,\n+    'disabled_by': None,\n+    'domain': 'sensor',\n+    'entity_category': None,\n+    'entity_id': 'sensor.envoy_1234_powerfactor_production_ct',\n+    'has_entity_name': True,\n+    'hidden_by': None,\n+    'icon': None,\n+    'id': <ANY>,\n+    'labels': set({\n+    }),\n+    'name': None,\n+    'options': dict({\n+      'sensor': dict({\n+        'suggested_display_precision': 2,\n+      }),\n+    }),\n+    'original_device_class': <SensorDeviceClass.POWER_FACTOR: 'power_factor'>,\n+    'original_icon': 'mdi:flash',\n+    'original_name': 'powerfactor production CT',\n+    'platform': 'enphase_envoy',\n+    'previous_unique_id': None,\n+    'supported_features': 0,\n+    'translation_key': 'production_ct_powerfactor',\n+    'unique_id': '1234_production_ct_powerfactor',\n+    'unit_of_measurement': None,\n+  })\n+# ---\n+# name: test_sensor[envoy_acb_batt][sensor.envoy_1234_powerfactor_production_ct-state]\n+  StateSnapshot({\n+    'attributes': ReadOnlyDict({\n+      'device_class': 'power_factor',\n+      'friendly_name': 'Envoy 1234 powerfactor production CT',\n+      'icon': 'mdi:flash',\n+      'state_class': <SensorStateClass.MEASUREMENT: 'measurement'>,\n+    }),\n+    'context': <ANY>,\n+    'entity_id': 'sensor.envoy_1234_powerfactor_production_ct',\n+    'last_changed': <ANY>,\n+    'last_reported': <ANY>,\n+    'last_updated': <ANY>,\n+    'state': '0.11',\n+  })\n+# ---\n+# name: test_sensor[envoy_acb_batt][sensor.envoy_1234_powerfactor_production_ct_l1-entry]\n+  EntityRegistryEntrySnapshot({\n+    'aliases': set({\n+    }),\n+    'area_id': None,\n+    'capabilities': dict({\n+      'state_class': <SensorStateClass.MEASUREMENT: 'measurement'>,\n+    }),\n+    'config_entry_id': <ANY>,\n+    'device_class': None,\n+    'device_id': <ANY>,\n+    'disabled_by': None,\n+    'domain': 'sensor',\n+    'entity_category': None,\n+    'entity_id': 'sensor.envoy_1234_powerfactor_production_ct_l1',\n+    'has_entity_name': True,\n+    'hidden_by': None,\n+    'icon': None,\n+    'id': <ANY>,\n+    'labels': set({\n+    }),\n+    'name': None,\n+    'options': dict({\n+      'sensor': dict({\n+        'suggested_display_precision': 2,\n+      }),\n+    }),\n+    'original_device_class': <SensorDeviceClass.POWER_FACTOR: 'power_factor'>,\n+    'original_icon': 'mdi:flash',\n+    'original_name': 'Powerfactor production CT l1',\n+    'platform': 'enphase_envoy',\n+    'previous_unique_id': None,\n+    'supported_features': 0,\n+    'translation_key': 'production_ct_powerfactor_phase',\n+    'unique_id': '1234_production_ct_powerfactor_l1',\n+    'unit_of_measurement': None,\n+  })\n+# ---\n+# name: test_sensor[envoy_acb_batt][sensor.envoy_1234_powerfactor_production_ct_l1-state]\n+  StateSnapshot({\n+    'attributes': ReadOnlyDict({\n+      'device_class': 'power_factor',\n+      'friendly_name': 'Envoy 1234 Powerfactor production CT l1',\n+      'icon': 'mdi:flash',\n+      'state_class': <SensorStateClass.MEASUREMENT: 'measurement'>,\n+    }),\n+    'context': <ANY>,\n+    'entity_id': 'sensor.envoy_1234_powerfactor_production_ct_l1',\n+    'last_changed': <ANY>,\n+    'last_reported': <ANY>,\n+    'last_updated': <ANY>,\n+    'state': '0.12',\n+  })\n+# ---\n+# name: test_sensor[envoy_acb_batt][sensor.envoy_1234_powerfactor_production_ct_l2-entry]\n+  EntityRegistryEntrySnapshot({\n+    'aliases': set({\n+    }),\n+    'area_id': None,\n+    'capabilities': dict({\n+      'state_class': <SensorStateClass.MEASUREMENT: 'measurement'>,\n+    }),\n+    'config_entry_id': <ANY>,\n+    'device_class': None,\n+    'device_id': <ANY>,\n+    'disabled_by': None,\n+    'domain': 'sensor',\n+    'entity_category': None,\n+    'entity_id': 'sensor.envoy_1234_powerfactor_production_ct_l2',\n+    'has_entity_name': True,\n+    'hidden_by': None,\n+    'icon': None,\n+    'id': <ANY>,\n+    'labels': set({\n+    }),\n+    'name': None,\n+    'options': dict({\n+      'sensor': dict({\n+        'suggested_display_precision': 2,\n+      }),\n+    }),\n+    'original_device_class': <SensorDeviceClass.POWER_FACTOR: 'power_factor'>,\n+    'original_icon': 'mdi:flash',\n+    'original_name': 'Powerfactor production CT l2',\n+    'platform': 'enphase_envoy',\n+    'previous_unique_id': None,\n+    'supported_features': 0,\n+    'translation_key': 'production_ct_powerfactor_phase',\n+    'unique_id': '1234_production_ct_powerfactor_l2',\n+    'unit_of_measurement': None,\n+  })\n+# ---\n+# name: test_sensor[envoy_acb_batt][sensor.envoy_1234_powerfactor_production_ct_l2-state]\n+  StateSnapshot({\n+    'attributes': ReadOnlyDict({\n+      'device_class': 'power_factor',\n+      'friendly_name': 'Envoy 1234 Powerfactor production CT l2',\n+      'icon': 'mdi:flash',\n+      'state_class': <SensorStateClass.MEASUREMENT: 'measurement'>,\n+    }),\n+    'context': <ANY>,\n+    'entity_id': 'sensor.envoy_1234_powerfactor_production_ct_l2',\n+    'last_changed': <ANY>,\n+    'last_reported': <ANY>,\n+    'last_updated': <ANY>,\n+    'state': '0.13',\n+  })\n+# ---\n+# name: test_sensor[envoy_acb_batt][sensor.envoy_1234_powerfactor_production_ct_l3-entry]\n+  EntityRegistryEntrySnapshot({\n+    'aliases': set({\n+    }),\n+    'area_id': None,\n+    'capabilities': dict({\n+      'state_class': <SensorStateClass.MEASUREMENT: 'measurement'>,\n+    }),\n+    'config_entry_id': <ANY>,\n+    'device_class': None,\n+    'device_id': <ANY>,\n+    'disabled_by': None,\n+    'domain': 'sensor',\n+    'entity_category': None,\n+    'entity_id': 'sensor.envoy_1234_powerfactor_production_ct_l3',\n+    'has_entity_name': True,\n+    'hidden_by': None,\n+    'icon': None,\n+    'id': <ANY>,\n+    'labels': set({\n+    }),\n+    'name': None,\n+    'options': dict({\n+      'sensor': dict({\n+        'suggested_display_precision': 2,\n+      }),\n+    }),\n+    'original_device_class': <SensorDeviceClass.POWER_FACTOR: 'power_factor'>,\n+    'original_icon': 'mdi:flash',\n+    'original_name': 'Powerfactor production CT l3',\n+    'platform': 'enphase_envoy',\n+    'previous_unique_id': None,\n+    'supported_features': 0,\n+    'translation_key': 'production_ct_powerfactor_phase',\n+    'unique_id': '1234_production_ct_powerfactor_l3',\n+    'unit_of_measurement': None,\n+  })\n+# ---\n+# name: test_sensor[envoy_acb_batt][sensor.envoy_1234_powerfactor_production_ct_l3-state]\n+  StateSnapshot({\n+    'attributes': ReadOnlyDict({\n+      'device_class': 'power_factor',\n+      'friendly_name': 'Envoy 1234 Powerfactor production CT l3',\n+      'icon': 'mdi:flash',\n+      'state_class': <SensorStateClass.MEASUREMENT: 'measurement'>,\n+    }),\n+    'context': <ANY>,\n+    'entity_id': 'sensor.envoy_1234_powerfactor_production_ct_l3',\n+    'last_changed': <ANY>,\n+    'last_reported': <ANY>,\n+    'last_updated': <ANY>,\n+    'state': '0.14',\n+  })\n+# ---\n+# name: test_sensor[envoy_acb_batt][sensor.envoy_1234_production_ct_current-entry]\n+  EntityRegistryEntrySnapshot({\n+    'aliases': set({\n+    }),\n+    'area_id': None,\n+    'capabilities': dict({\n+      'state_class': <SensorStateClass.MEASUREMENT: 'measurement'>,\n+    }),\n+    'config_entry_id': <ANY>,\n+    'device_class': None,\n+    'device_id': <ANY>,\n+    'disabled_by': None,\n+    'domain': 'sensor',\n+    'entity_category': None,\n+    'entity_id': 'sensor.envoy_1234_production_ct_current',\n+    'has_entity_name': True,\n+    'hidden_by': None,\n+    'icon': None,\n+    'id': <ANY>,\n+    'labels': set({\n+    }),\n+    'name': None,\n+    'options': dict({\n+      'sensor': dict({\n+        'suggested_display_precision': 3,\n+      }),\n+      'sensor.private': dict({\n+        'suggested_unit_of_measurement': <UnitOfElectricCurrent.AMPERE: 'A'>,\n+      }),\n+    }),\n+    'original_device_class': <SensorDeviceClass.CURRENT: 'current'>,\n+    'original_icon': 'mdi:flash',\n+    'original_name': 'Production CT current',\n+    'platform': 'enphase_envoy',\n+    'previous_unique_id': None,\n+    'supported_features': 0,\n+    'translation_key': 'production_ct_current',\n+    'unique_id': '1234_production_ct_current',\n+    'unit_of_measurement': <UnitOfElectricCurrent.AMPERE: 'A'>,\n+  })\n+# ---\n+# name: test_sensor[envoy_acb_batt][sensor.envoy_1234_production_ct_current-state]\n+  StateSnapshot({\n+    'attributes': ReadOnlyDict({\n+      'device_class': 'current',\n+      'friendly_name': 'Envoy 1234 Production CT current',\n+      'icon': 'mdi:flash',\n+      'state_class': <SensorStateClass.MEASUREMENT: 'measurement'>,\n+      'unit_of_measurement': <UnitOfElectricCurrent.AMPERE: 'A'>,\n+    }),\n+    'context': <ANY>,\n+    'entity_id': 'sensor.envoy_1234_production_ct_current',\n+    'last_changed': <ANY>,\n+    'last_reported': <ANY>,\n+    'last_updated': <ANY>,\n+    'state': '0.2',\n+  })\n+# ---\n+# name: test_sensor[envoy_acb_batt][sensor.envoy_1234_production_ct_current_l1-entry]\n+  EntityRegistryEntrySnapshot({\n+    'aliases': set({\n+    }),\n+    'area_id': None,\n+    'capabilities': dict({\n+      'state_class': <SensorStateClass.MEASUREMENT: 'measurement'>,\n+    }),\n+    'config_entry_id': <ANY>,\n+    'device_class': None,\n+    'device_id': <ANY>,\n+    'disabled_by': None,\n+    'domain': 'sensor',\n+    'entity_category': None,\n+    'entity_id': 'sensor.envoy_1234_production_ct_current_l1',\n+    'has_entity_name': True,\n+    'hidden_by': None,\n+    'icon': None,\n+    'id': <ANY>,\n+    'labels': set({\n+    }),\n+    'name': None,\n+    'options': dict({\n+      'sensor': dict({\n+        'suggested_display_precision': 3,\n+      }),\n+      'sensor.private': dict({\n+        'suggested_unit_of_measurement': <UnitOfElectricCurrent.AMPERE: 'A'>,\n+      }),\n+    }),\n+    'original_device_class': <SensorDeviceClass.CURRENT: 'current'>,\n+    'original_icon': 'mdi:flash',\n+    'original_name': 'Production CT current l1',\n+    'platform': 'enphase_envoy',\n+    'previous_unique_id': None,\n+    'supported_features': 0,\n+    'translation_key': 'production_ct_current_phase',\n+    'unique_id': '1234_production_ct_current_l1',\n+    'unit_of_measurement': <UnitOfElectricCurrent.AMPERE: 'A'>,\n+  })\n+# ---\n+# name: test_sensor[envoy_acb_batt][sensor.envoy_1234_production_ct_current_l1-state]\n+  StateSnapshot({\n+    'attributes': ReadOnlyDict({\n+      'device_class': 'current',\n+      'friendly_name': 'Envoy 1234 Production CT current l1',\n+      'icon': 'mdi:flash',\n+      'state_class': <SensorStateClass.MEASUREMENT: 'measurement'>,\n+      'unit_of_measurement': <UnitOfElectricCurrent.AMPERE: 'A'>,\n+    }),\n+    'context': <ANY>,\n+    'entity_id': 'sensor.envoy_1234_production_ct_current_l1',\n+    'last_changed': <ANY>,\n+    'last_reported': <ANY>,\n+    'last_updated': <ANY>,\n+    'state': '0.2',\n+  })\n+# ---\n+# name: test_sensor[envoy_acb_batt][sensor.envoy_1234_production_ct_current_l2-entry]\n+  EntityRegistryEntrySnapshot({\n+    'aliases': set({\n+    }),\n+    'area_id': None,\n+    'capabilities': dict({\n+      'state_class': <SensorStateClass.MEASUREMENT: 'measurement'>,\n+    }),\n+    'config_entry_id': <ANY>,\n+    'device_class': None,\n+    'device_id': <ANY>,\n+    'disabled_by': None,\n+    'domain': 'sensor',\n+    'entity_category': None,\n+    'entity_id': 'sensor.envoy_1234_production_ct_current_l2',\n+    'has_entity_name': True,\n+    'hidden_by': None,\n+    'icon': None,\n+    'id': <ANY>,\n+    'labels': set({\n+    }),\n+    'name': None,\n+    'options': dict({\n+      'sensor': dict({\n+        'suggested_display_precision': 3,\n+      }),\n+      'sensor.private': dict({\n+        'suggested_unit_of_measurement': <UnitOfElectricCurrent.AMPERE: 'A'>,\n+      }),\n+    }),\n+    'original_device_class': <SensorDeviceClass.CURRENT: 'current'>,\n+    'original_icon': 'mdi:flash',\n+    'original_name': 'Production CT current l2',\n+    'platform': 'enphase_envoy',\n+    'previous_unique_id': None,\n+    'supported_features': 0,\n+    'translation_key': 'production_ct_current_phase',\n+    'unique_id': '1234_production_ct_current_l2',\n+    'unit_of_measurement': <UnitOfElectricCurrent.AMPERE: 'A'>,\n+  })\n+# ---\n+# name: test_sensor[envoy_acb_batt][sensor.envoy_1234_production_ct_current_l2-state]\n+  StateSnapshot({\n+    'attributes': ReadOnlyDict({\n+      'device_class': 'current',\n+      'friendly_name': 'Envoy 1234 Production CT current l2',\n+      'icon': 'mdi:flash',\n+      'state_class': <SensorStateClass.MEASUREMENT: 'measurement'>,\n+      'unit_of_measurement': <UnitOfElectricCurrent.AMPERE: 'A'>,\n+    }),\n+    'context': <ANY>,\n+    'entity_id': 'sensor.envoy_1234_production_ct_current_l2',\n+    'last_changed': <ANY>,\n+    'last_reported': <ANY>,\n+    'last_updated': <ANY>,\n+    'state': '0.2',\n+  })\n+# ---\n+# name: test_sensor[envoy_acb_batt][sensor.envoy_1234_production_ct_current_l3-entry]\n+  EntityRegistryEntrySnapshot({\n+    'aliases': set({\n+    }),\n+    'area_id': None,\n+    'capabilities': dict({\n+      'state_class': <SensorStateClass.MEASUREMENT: 'measurement'>,\n+    }),\n+    'config_entry_id': <ANY>,\n+    'device_class': None,\n+    'device_id': <ANY>,\n+    'disabled_by': None,\n+    'domain': 'sensor',\n+    'entity_category': None,\n+    'entity_id': 'sensor.envoy_1234_production_ct_current_l3',\n+    'has_entity_name': True,\n+    'hidden_by': None,\n+    'icon': None,\n+    'id': <ANY>,\n+    'labels': set({\n+    }),\n+    'name': None,\n+    'options': dict({\n+      'sensor': dict({\n+        'suggested_display_precision': 3,\n+      }),\n+      'sensor.private': dict({\n+        'suggested_unit_of_measurement': <UnitOfElectricCurrent.AMPERE: 'A'>,\n+      }),\n+    }),\n+    'original_device_class': <SensorDeviceClass.CURRENT: 'current'>,\n+    'original_icon': 'mdi:flash',\n+    'original_name': 'Production CT current l3',\n+    'platform': 'enphase_envoy',\n+    'previous_unique_id': None,\n+    'supported_features': 0,\n+    'translation_key': 'production_ct_current_phase',\n+    'unique_id': '1234_production_ct_current_l3',\n+    'unit_of_measurement': <UnitOfElectricCurrent.AMPERE: 'A'>,\n+  })\n+# ---\n+# name: test_sensor[envoy_acb_batt][sensor.envoy_1234_production_ct_current_l3-state]\n+  StateSnapshot({\n+    'attributes': ReadOnlyDict({\n+      'device_class': 'current',\n+      'friendly_name': 'Envoy 1234 Production CT current l3',\n+      'icon': 'mdi:flash',\n+      'state_class': <SensorStateClass.MEASUREMENT: 'measurement'>,\n+      'unit_of_measurement': <UnitOfElectricCurrent.AMPERE: 'A'>,\n+    }),\n+    'context': <ANY>,\n+    'entity_id': 'sensor.envoy_1234_production_ct_current_l3',\n+    'last_changed': <ANY>,\n+    'last_reported': <ANY>,\n+    'last_updated': <ANY>,\n+    'state': '0.2',\n+  })\n+# ---\n+# name: test_sensor[envoy_acb_batt][sensor.envoy_1234_reserve_battery_energy-entry]\n+  EntityRegistryEntrySnapshot({\n+    'aliases': set({\n+    }),\n+    'area_id': None,\n+    'capabilities': None,\n+    'config_entry_id': <ANY>,\n+    'device_class': None,\n+    'device_id': <ANY>,\n+    'disabled_by': None,\n+    'domain': 'sensor',\n+    'entity_category': None,\n+    'entity_id': 'sensor.envoy_1234_reserve_battery_energy',\n+    'has_entity_name': True,\n+    'hidden_by': None,\n+    'icon': None,\n+    'id': <ANY>,\n+    'labels': set({\n+    }),\n+    'name': None,\n+    'options': dict({\n+    }),\n+    'original_device_class': <SensorDeviceClass.ENERGY: 'energy'>,\n+    'original_icon': 'mdi:flash',\n+    'original_name': 'Reserve battery energy',\n+    'platform': 'enphase_envoy',\n+    'previous_unique_id': None,\n+    'supported_features': 0,\n+    'translation_key': 'reserve_energy',\n+    'unique_id': '1234_reserve_energy',\n+    'unit_of_measurement': <UnitOfEnergy.WATT_HOUR: 'Wh'>,\n+  })\n+# ---\n+# name: test_sensor[envoy_acb_batt][sensor.envoy_1234_reserve_battery_energy-state]\n+  StateSnapshot({\n+    'attributes': ReadOnlyDict({\n+      'device_class': 'energy',\n+      'friendly_name': 'Envoy 1234 Reserve battery energy',\n+      'icon': 'mdi:flash',\n+      'unit_of_measurement': <UnitOfEnergy.WATT_HOUR: 'Wh'>,\n+    }),\n+    'context': <ANY>,\n+    'entity_id': 'sensor.envoy_1234_reserve_battery_energy',\n+    'last_changed': <ANY>,\n+    'last_reported': <ANY>,\n+    'last_updated': <ANY>,\n+    'state': '0',\n+  })\n+# ---\n+# name: test_sensor[envoy_acb_batt][sensor.envoy_1234_reserve_battery_level-entry]\n+  EntityRegistryEntrySnapshot({\n+    'aliases': set({\n+    }),\n+    'area_id': None,\n+    'capabilities': None,\n+    'config_entry_id': <ANY>,\n+    'device_class': None,\n+    'device_id': <ANY>,\n+    'disabled_by': None,\n+    'domain': 'sensor',\n+    'entity_category': None,\n+    'entity_id': 'sensor.envoy_1234_reserve_battery_level',\n+    'has_entity_name': True,\n+    'hidden_by': None,\n+    'icon': None,\n+    'id': <ANY>,\n+    'labels': set({\n+    }),\n+    'name': None,\n+    'options': dict({\n+    }),\n+    'original_device_class': <SensorDeviceClass.BATTERY: 'battery'>,\n+    'original_icon': 'mdi:flash',\n+    'original_name': 'Reserve battery level',\n+    'platform': 'enphase_envoy',\n+    'previous_unique_id': None,\n+    'supported_features': 0,\n+    'translation_key': 'reserve_soc',\n+    'unique_id': '1234_reserve_soc',\n+    'unit_of_measurement': '%',\n+  })\n+# ---\n+# name: test_sensor[envoy_acb_batt][sensor.envoy_1234_reserve_battery_level-state]\n+  StateSnapshot({\n+    'attributes': ReadOnlyDict({\n+      'device_class': 'battery',\n+      'friendly_name': 'Envoy 1234 Reserve battery level',\n+      'icon': 'mdi:flash',\n+      'unit_of_measurement': '%',\n+    }),\n+    'context': <ANY>,\n+    'entity_id': 'sensor.envoy_1234_reserve_battery_level',\n+    'last_changed': <ANY>,\n+    'last_reported': <ANY>,\n+    'last_updated': <ANY>,\n+    'state': '0',\n+  })\n+# ---\n+# name: test_sensor[envoy_acb_batt][sensor.envoy_1234_voltage_net_consumption_ct-entry]\n+  EntityRegistryEntrySnapshot({\n+    'aliases': set({\n+    }),\n+    'area_id': None,\n+    'capabilities': dict({\n+      'state_class': <SensorStateClass.MEASUREMENT: 'measurement'>,\n+    }),\n+    'config_entry_id': <ANY>,\n+    'device_class': None,\n+    'device_id': <ANY>,\n+    'disabled_by': None,\n+    'domain': 'sensor',\n+    'entity_category': None,\n+    'entity_id': 'sensor.envoy_1234_voltage_net_consumption_ct',\n+    'has_entity_name': True,\n+    'hidden_by': None,\n+    'icon': None,\n+    'id': <ANY>,\n+    'labels': set({\n+    }),\n+    'name': None,\n+    'options': dict({\n+      'sensor': dict({\n+        'suggested_display_precision': 1,\n+      }),\n+      'sensor.private': dict({\n+        'suggested_unit_of_measurement': <UnitOfElectricPotential.VOLT: 'V'>,\n+      }),\n+    }),\n+    'original_device_class': <SensorDeviceClass.VOLTAGE: 'voltage'>,\n+    'original_icon': 'mdi:flash',\n+    'original_name': 'Voltage net consumption CT',\n+    'platform': 'enphase_envoy',\n+    'previous_unique_id': None,\n+    'supported_features': 0,\n+    'translation_key': 'net_ct_voltage',\n+    'unique_id': '1234_voltage',\n+    'unit_of_measurement': <UnitOfElectricPotential.VOLT: 'V'>,\n+  })\n+# ---\n+# name: test_sensor[envoy_acb_batt][sensor.envoy_1234_voltage_net_consumption_ct-state]\n+  StateSnapshot({\n+    'attributes': ReadOnlyDict({\n+      'device_class': 'voltage',\n+      'friendly_name': 'Envoy 1234 Voltage net consumption CT',\n+      'icon': 'mdi:flash',\n+      'state_class': <SensorStateClass.MEASUREMENT: 'measurement'>,\n+      'unit_of_measurement': <UnitOfElectricPotential.VOLT: 'V'>,\n+    }),\n+    'context': <ANY>,\n+    'entity_id': 'sensor.envoy_1234_voltage_net_consumption_ct',\n+    'last_changed': <ANY>,\n+    'last_reported': <ANY>,\n+    'last_updated': <ANY>,\n+    'state': '112',\n+  })\n+# ---\n+# name: test_sensor[envoy_acb_batt][sensor.envoy_1234_voltage_net_consumption_ct_l1-entry]\n+  EntityRegistryEntrySnapshot({\n+    'aliases': set({\n+    }),\n+    'area_id': None,\n+    'capabilities': dict({\n+      'state_class': <SensorStateClass.MEASUREMENT: 'measurement'>,\n+    }),\n+    'config_entry_id': <ANY>,\n+    'device_class': None,\n+    'device_id': <ANY>,\n+    'disabled_by': None,\n+    'domain': 'sensor',\n+    'entity_category': None,\n+    'entity_id': 'sensor.envoy_1234_voltage_net_consumption_ct_l1',\n+    'has_entity_name': True,\n+    'hidden_by': None,\n+    'icon': None,\n+    'id': <ANY>,\n+    'labels': set({\n+    }),\n+    'name': None,\n+    'options': dict({\n+      'sensor': dict({\n+        'suggested_display_precision': 1,\n+      }),\n+      'sensor.private': dict({\n+        'suggested_unit_of_measurement': <UnitOfElectricPotential.VOLT: 'V'>,\n+      }),\n+    }),\n+    'original_device_class': <SensorDeviceClass.VOLTAGE: 'voltage'>,\n+    'original_icon': 'mdi:flash',\n+    'original_name': 'Voltage net consumption CT l1',\n+    'platform': 'enphase_envoy',\n+    'previous_unique_id': None,\n+    'supported_features': 0,\n+    'translation_key': 'net_ct_voltage_phase',\n+    'unique_id': '1234_voltage_l1',\n+    'unit_of_measurement': <UnitOfElectricPotential.VOLT: 'V'>,\n+  })\n+# ---\n+# name: test_sensor[envoy_acb_batt][sensor.envoy_1234_voltage_net_consumption_ct_l1-state]\n+  StateSnapshot({\n+    'attributes': ReadOnlyDict({\n+      'device_class': 'voltage',\n+      'friendly_name': 'Envoy 1234 Voltage net consumption CT l1',\n+      'icon': 'mdi:flash',\n+      'state_class': <SensorStateClass.MEASUREMENT: 'measurement'>,\n+      'unit_of_measurement': <UnitOfElectricPotential.VOLT: 'V'>,\n+    }),\n+    'context': <ANY>,\n+    'entity_id': 'sensor.envoy_1234_voltage_net_consumption_ct_l1',\n+    'last_changed': <ANY>,\n+    'last_reported': <ANY>,\n+    'last_updated': <ANY>,\n+    'state': '112',\n+  })\n+# ---\n+# name: test_sensor[envoy_acb_batt][sensor.envoy_1234_voltage_net_consumption_ct_l2-entry]\n+  EntityRegistryEntrySnapshot({\n+    'aliases': set({\n+    }),\n+    'area_id': None,\n+    'capabilities': dict({\n+      'state_class': <SensorStateClass.MEASUREMENT: 'measurement'>,\n+    }),\n+    'config_entry_id': <ANY>,\n+    'device_class': None,\n+    'device_id': <ANY>,\n+    'disabled_by': None,\n+    'domain': 'sensor',\n+    'entity_category': None,\n+    'entity_id': 'sensor.envoy_1234_voltage_net_consumption_ct_l2',\n+    'has_entity_name': True,\n+    'hidden_by': None,\n+    'icon': None,\n+    'id': <ANY>,\n+    'labels': set({\n+    }),\n+    'name': None,\n+    'options': dict({\n+      'sensor': dict({\n+        'suggested_display_precision': 1,\n+      }),\n+      'sensor.private': dict({\n+        'suggested_unit_of_measurement': <UnitOfElectricPotential.VOLT: 'V'>,\n+      }),\n+    }),\n+    'original_device_class': <SensorDeviceClass.VOLTAGE: 'voltage'>,\n+    'original_icon': 'mdi:flash',\n+    'original_name': 'Voltage net consumption CT l2',\n+    'platform': 'enphase_envoy',\n+    'previous_unique_id': None,\n+    'supported_features': 0,\n+    'translation_key': 'net_ct_voltage_phase',\n+    'unique_id': '1234_voltage_l2',\n+    'unit_of_measurement': <UnitOfElectricPotential.VOLT: 'V'>,\n+  })\n+# ---\n+# name: test_sensor[envoy_acb_batt][sensor.envoy_1234_voltage_net_consumption_ct_l2-state]\n+  StateSnapshot({\n+    'attributes': ReadOnlyDict({\n+      'device_class': 'voltage',\n+      'friendly_name': 'Envoy 1234 Voltage net consumption CT l2',\n+      'icon': 'mdi:flash',\n+      'state_class': <SensorStateClass.MEASUREMENT: 'measurement'>,\n+      'unit_of_measurement': <UnitOfElectricPotential.VOLT: 'V'>,\n+    }),\n+    'context': <ANY>,\n+    'entity_id': 'sensor.envoy_1234_voltage_net_consumption_ct_l2',\n+    'last_changed': <ANY>,\n+    'last_reported': <ANY>,\n+    'last_updated': <ANY>,\n+    'state': '112',\n+  })\n+# ---\n+# name: test_sensor[envoy_acb_batt][sensor.envoy_1234_voltage_net_consumption_ct_l3-entry]\n+  EntityRegistryEntrySnapshot({\n+    'aliases': set({\n+    }),\n+    'area_id': None,\n+    'capabilities': dict({\n+      'state_class': <SensorStateClass.MEASUREMENT: 'measurement'>,\n+    }),\n+    'config_entry_id': <ANY>,\n+    'device_class': None,\n+    'device_id': <ANY>,\n+    'disabled_by': None,\n+    'domain': 'sensor',\n+    'entity_category': None,\n+    'entity_id': 'sensor.envoy_1234_voltage_net_consumption_ct_l3',\n+    'has_entity_name': True,\n+    'hidden_by': None,\n+    'icon': None,\n+    'id': <ANY>,\n+    'labels': set({\n+    }),\n+    'name': None,\n+    'options': dict({\n+      'sensor': dict({\n+        'suggested_display_precision': 1,\n+      }),\n+      'sensor.private': dict({\n+        'suggested_unit_of_measurement': <UnitOfElectricPotential.VOLT: 'V'>,\n+      }),\n+    }),\n+    'original_device_class': <SensorDeviceClass.VOLTAGE: 'voltage'>,\n+    'original_icon': 'mdi:flash',\n+    'original_name': 'Voltage net consumption CT l3',\n+    'platform': 'enphase_envoy',\n+    'previous_unique_id': None,\n+    'supported_features': 0,\n+    'translation_key': 'net_ct_voltage_phase',\n+    'unique_id': '1234_voltage_l3',\n+    'unit_of_measurement': <UnitOfElectricPotential.VOLT: 'V'>,\n+  })\n+# ---\n+# name: test_sensor[envoy_acb_batt][sensor.envoy_1234_voltage_net_consumption_ct_l3-state]\n+  StateSnapshot({\n+    'attributes': ReadOnlyDict({\n+      'device_class': 'voltage',\n+      'friendly_name': 'Envoy 1234 Voltage net consumption CT l3',\n+      'icon': 'mdi:flash',\n+      'state_class': <SensorStateClass.MEASUREMENT: 'measurement'>,\n+      'unit_of_measurement': <UnitOfElectricPotential.VOLT: 'V'>,\n+    }),\n+    'context': <ANY>,\n+    'entity_id': 'sensor.envoy_1234_voltage_net_consumption_ct_l3',\n+    'last_changed': <ANY>,\n+    'last_reported': <ANY>,\n+    'last_updated': <ANY>,\n+    'state': '112',\n+  })\n+# ---\n+# name: test_sensor[envoy_acb_batt][sensor.envoy_1234_voltage_production_ct-entry]\n+  EntityRegistryEntrySnapshot({\n+    'aliases': set({\n+    }),\n+    'area_id': None,\n+    'capabilities': dict({\n+      'state_class': <SensorStateClass.MEASUREMENT: 'measurement'>,\n+    }),\n+    'config_entry_id': <ANY>,\n+    'device_class': None,\n+    'device_id': <ANY>,\n+    'disabled_by': None,\n+    'domain': 'sensor',\n+    'entity_category': None,\n+    'entity_id': 'sensor.envoy_1234_voltage_production_ct',\n+    'has_entity_name': True,\n+    'hidden_by': None,\n+    'icon': None,\n+    'id': <ANY>,\n+    'labels': set({\n+    }),\n+    'name': None,\n+    'options': dict({\n+      'sensor': dict({\n+        'suggested_display_precision': 1,\n+      }),\n+      'sensor.private': dict({\n+        'suggested_unit_of_measurement': <UnitOfElectricPotential.VOLT: 'V'>,\n+      }),\n+    }),\n+    'original_device_class': <SensorDeviceClass.VOLTAGE: 'voltage'>,\n+    'original_icon': 'mdi:flash',\n+    'original_name': 'Voltage production CT',\n+    'platform': 'enphase_envoy',\n+    'previous_unique_id': None,\n+    'supported_features': 0,\n+    'translation_key': 'production_ct_voltage',\n+    'unique_id': '1234_production_ct_voltage',\n+    'unit_of_measurement': <UnitOfElectricPotential.VOLT: 'V'>,\n+  })\n+# ---\n+# name: test_sensor[envoy_acb_batt][sensor.envoy_1234_voltage_production_ct-state]\n+  StateSnapshot({\n+    'attributes': ReadOnlyDict({\n+      'device_class': 'voltage',\n+      'friendly_name': 'Envoy 1234 Voltage production CT',\n+      'icon': 'mdi:flash',\n+      'state_class': <SensorStateClass.MEASUREMENT: 'measurement'>,\n+      'unit_of_measurement': <UnitOfElectricPotential.VOLT: 'V'>,\n+    }),\n+    'context': <ANY>,\n+    'entity_id': 'sensor.envoy_1234_voltage_production_ct',\n+    'last_changed': <ANY>,\n+    'last_reported': <ANY>,\n+    'last_updated': <ANY>,\n+    'state': '111',\n+  })\n+# ---\n+# name: test_sensor[envoy_acb_batt][sensor.envoy_1234_voltage_production_ct_l1-entry]\n+  EntityRegistryEntrySnapshot({\n+    'aliases': set({\n+    }),\n+    'area_id': None,\n+    'capabilities': dict({\n+      'state_class': <SensorStateClass.MEASUREMENT: 'measurement'>,\n+    }),\n+    'config_entry_id': <ANY>,\n+    'device_class': None,\n+    'device_id': <ANY>,\n+    'disabled_by': None,\n+    'domain': 'sensor',\n+    'entity_category': None,\n+    'entity_id': 'sensor.envoy_1234_voltage_production_ct_l1',\n+    'has_entity_name': True,\n+    'hidden_by': None,\n+    'icon': None,\n+    'id': <ANY>,\n+    'labels': set({\n+    }),\n+    'name': None,\n+    'options': dict({\n+      'sensor': dict({\n+        'suggested_display_precision': 1,\n+      }),\n+      'sensor.private': dict({\n+        'suggested_unit_of_measurement': <UnitOfElectricPotential.VOLT: 'V'>,\n+      }),\n+    }),\n+    'original_device_class': <SensorDeviceClass.VOLTAGE: 'voltage'>,\n+    'original_icon': 'mdi:flash',\n+    'original_name': 'Voltage production CT l1',\n+    'platform': 'enphase_envoy',\n+    'previous_unique_id': None,\n+    'supported_features': 0,\n+    'translation_key': 'production_ct_voltage_phase',\n+    'unique_id': '1234_production_ct_voltage_l1',\n+    'unit_of_measurement': <UnitOfElectricPotential.VOLT: 'V'>,\n+  })\n+# ---\n+# name: test_sensor[envoy_acb_batt][sensor.envoy_1234_voltage_production_ct_l1-state]\n+  StateSnapshot({\n+    'attributes': ReadOnlyDict({\n+      'device_class': 'voltage',\n+      'friendly_name': 'Envoy 1234 Voltage production CT l1',\n+      'icon': 'mdi:flash',\n+      'state_class': <SensorStateClass.MEASUREMENT: 'measurement'>,\n+      'unit_of_measurement': <UnitOfElectricPotential.VOLT: 'V'>,\n+    }),\n+    'context': <ANY>,\n+    'entity_id': 'sensor.envoy_1234_voltage_production_ct_l1',\n+    'last_changed': <ANY>,\n+    'last_reported': <ANY>,\n+    'last_updated': <ANY>,\n+    'state': '111',\n+  })\n+# ---\n+# name: test_sensor[envoy_acb_batt][sensor.envoy_1234_voltage_production_ct_l2-entry]\n+  EntityRegistryEntrySnapshot({\n+    'aliases': set({\n+    }),\n+    'area_id': None,\n+    'capabilities': dict({\n+      'state_class': <SensorStateClass.MEASUREMENT: 'measurement'>,\n+    }),\n+    'config_entry_id': <ANY>,\n+    'device_class': None,\n+    'device_id': <ANY>,\n+    'disabled_by': None,\n+    'domain': 'sensor',\n+    'entity_category': None,\n+    'entity_id': 'sensor.envoy_1234_voltage_production_ct_l2',\n+    'has_entity_name': True,\n+    'hidden_by': None,\n+    'icon': None,\n+    'id': <ANY>,\n+    'labels': set({\n+    }),\n+    'name': None,\n+    'options': dict({\n+      'sensor': dict({\n+        'suggested_display_precision': 1,\n+      }),\n+      'sensor.private': dict({\n+        'suggested_unit_of_measurement': <UnitOfElectricPotential.VOLT: 'V'>,\n+      }),\n+    }),\n+    'original_device_class': <SensorDeviceClass.VOLTAGE: 'voltage'>,\n+    'original_icon': 'mdi:flash',\n+    'original_name': 'Voltage production CT l2',\n+    'platform': 'enphase_envoy',\n+    'previous_unique_id': None,\n+    'supported_features': 0,\n+    'translation_key': 'production_ct_voltage_phase',\n+    'unique_id': '1234_production_ct_voltage_l2',\n+    'unit_of_measurement': <UnitOfElectricPotential.VOLT: 'V'>,\n+  })\n+# ---\n+# name: test_sensor[envoy_acb_batt][sensor.envoy_1234_voltage_production_ct_l2-state]\n+  StateSnapshot({\n+    'attributes': ReadOnlyDict({\n+      'device_class': 'voltage',\n+      'friendly_name': 'Envoy 1234 Voltage production CT l2',\n+      'icon': 'mdi:flash',\n+      'state_class': <SensorStateClass.MEASUREMENT: 'measurement'>,\n+      'unit_of_measurement': <UnitOfElectricPotential.VOLT: 'V'>,\n+    }),\n+    'context': <ANY>,\n+    'entity_id': 'sensor.envoy_1234_voltage_production_ct_l2',\n+    'last_changed': <ANY>,\n+    'last_reported': <ANY>,\n+    'last_updated': <ANY>,\n+    'state': '111',\n+  })\n+# ---\n+# name: test_sensor[envoy_acb_batt][sensor.envoy_1234_voltage_production_ct_l3-entry]\n+  EntityRegistryEntrySnapshot({\n+    'aliases': set({\n+    }),\n+    'area_id': None,\n+    'capabilities': dict({\n+      'state_class': <SensorStateClass.MEASUREMENT: 'measurement'>,\n+    }),\n+    'config_entry_id': <ANY>,\n+    'device_class': None,\n+    'device_id': <ANY>,\n+    'disabled_by': None,\n+    'domain': 'sensor',\n+    'entity_category': None,\n+    'entity_id': 'sensor.envoy_1234_voltage_production_ct_l3',\n+    'has_entity_name': True,\n+    'hidden_by': None,\n+    'icon': None,\n+    'id': <ANY>,\n+    'labels': set({\n+    }),\n+    'name': None,\n+    'options': dict({\n+      'sensor': dict({\n+        'suggested_display_precision': 1,\n+      }),\n+      'sensor.private': dict({\n+        'suggested_unit_of_measurement': <UnitOfElectricPotential.VOLT: 'V'>,\n+      }),\n+    }),\n+    'original_device_class': <SensorDeviceClass.VOLTAGE: 'voltage'>,\n+    'original_icon': 'mdi:flash',\n+    'original_name': 'Voltage production CT l3',\n+    'platform': 'enphase_envoy',\n+    'previous_unique_id': None,\n+    'supported_features': 0,\n+    'translation_key': 'production_ct_voltage_phase',\n+    'unique_id': '1234_production_ct_voltage_l3',\n+    'unit_of_measurement': <UnitOfElectricPotential.VOLT: 'V'>,\n+  })\n+# ---\n+# name: test_sensor[envoy_acb_batt][sensor.envoy_1234_voltage_production_ct_l3-state]\n+  StateSnapshot({\n+    'attributes': ReadOnlyDict({\n+      'device_class': 'voltage',\n+      'friendly_name': 'Envoy 1234 Voltage production CT l3',\n+      'icon': 'mdi:flash',\n+      'state_class': <SensorStateClass.MEASUREMENT: 'measurement'>,\n+      'unit_of_measurement': <UnitOfElectricPotential.VOLT: 'V'>,\n+    }),\n+    'context': <ANY>,\n+    'entity_id': 'sensor.envoy_1234_voltage_production_ct_l3',\n+    'last_changed': <ANY>,\n+    'last_reported': <ANY>,\n+    'last_updated': <ANY>,\n+    'state': '111',\n+  })\n+# ---\n+# name: test_sensor[envoy_acb_batt][sensor.inverter_1-entry]\n+  EntityRegistryEntrySnapshot({\n+    'aliases': set({\n+    }),\n+    'area_id': None,\n+    'capabilities': dict({\n+      'state_class': <SensorStateClass.MEASUREMENT: 'measurement'>,\n+    }),\n+    'config_entry_id': <ANY>,\n+    'device_class': None,\n+    'device_id': <ANY>,\n+    'disabled_by': None,\n+    'domain': 'sensor',\n+    'entity_category': None,\n+    'entity_id': 'sensor.inverter_1',\n+    'has_entity_name': True,\n+    'hidden_by': None,\n+    'icon': None,\n+    'id': <ANY>,\n+    'labels': set({\n+    }),\n+    'name': None,\n+    'options': dict({\n+    }),\n+    'original_device_class': <SensorDeviceClass.POWER: 'power'>,\n+    'original_icon': 'mdi:flash',\n+    'original_name': None,\n+    'platform': 'enphase_envoy',\n+    'previous_unique_id': None,\n+    'supported_features': 0,\n+    'translation_key': None,\n+    'unique_id': '1',\n+    'unit_of_measurement': <UnitOfPower.WATT: 'W'>,\n+  })\n+# ---\n+# name: test_sensor[envoy_acb_batt][sensor.inverter_1-state]\n+  StateSnapshot({\n+    'attributes': ReadOnlyDict({\n+      'device_class': 'power',\n+      'friendly_name': 'Inverter 1',\n+      'icon': 'mdi:flash',\n+      'state_class': <SensorStateClass.MEASUREMENT: 'measurement'>,\n+      'unit_of_measurement': <UnitOfPower.WATT: 'W'>,\n+    }),\n+    'context': <ANY>,\n+    'entity_id': 'sensor.inverter_1',\n+    'last_changed': <ANY>,\n+    'last_reported': <ANY>,\n+    'last_updated': <ANY>,\n+    'state': '1',\n+  })\n+# ---\n+# name: test_sensor[envoy_acb_batt][sensor.inverter_1_last_reported-entry]\n+  EntityRegistryEntrySnapshot({\n+    'aliases': set({\n+    }),\n+    'area_id': None,\n+    'capabilities': None,\n+    'config_entry_id': <ANY>,\n+    'device_class': None,\n+    'device_id': <ANY>,\n+    'disabled_by': None,\n+    'domain': 'sensor',\n+    'entity_category': None,\n+    'entity_id': 'sensor.inverter_1_last_reported',\n+    'has_entity_name': True,\n+    'hidden_by': None,\n+    'icon': None,\n+    'id': <ANY>,\n+    'labels': set({\n+    }),\n+    'name': None,\n+    'options': dict({\n+    }),\n+    'original_device_class': <SensorDeviceClass.TIMESTAMP: 'timestamp'>,\n+    'original_icon': 'mdi:flash',\n+    'original_name': 'Last reported',\n+    'platform': 'enphase_envoy',\n+    'previous_unique_id': None,\n+    'supported_features': 0,\n+    'translation_key': 'last_reported',\n+    'unique_id': '1_last_reported',\n+    'unit_of_measurement': None,\n+  })\n+# ---\n+# name: test_sensor[envoy_acb_batt][sensor.inverter_1_last_reported-state]\n+  StateSnapshot({\n+    'attributes': ReadOnlyDict({\n+      'device_class': 'timestamp',\n+      'friendly_name': 'Inverter 1 Last reported',\n+      'icon': 'mdi:flash',\n+    }),\n+    'context': <ANY>,\n+    'entity_id': 'sensor.inverter_1_last_reported',\n+    'last_changed': <ANY>,\n+    'last_reported': <ANY>,\n+    'last_updated': <ANY>,\n+    'state': '1970-01-01T00:00:01+00:00',\n+  })\n+# ---\n # name: test_sensor[envoy_eu_batt][sensor.encharge_123456_apparent_power-entry]\n   EntityRegistryEntrySnapshot({\n     'aliases': set({\ndiff --git a/tests/components/enphase_envoy/test_sensor.py b/tests/components/enphase_envoy/test_sensor.py\nindex 784dfe5407388a..89f28c74514e90 100644\n--- a/tests/components/enphase_envoy/test_sensor.py\n+++ b/tests/components/enphase_envoy/test_sensor.py\n@@ -31,6 +31,7 @@\n         \"envoy_metered_batt_relay\",\n         \"envoy_nobatt_metered_3p\",\n         \"envoy_tot_cons_metered\",\n+        \"envoy_acb_batt\",\n     ],\n     indirect=[\"mock_envoy\"],\n )\n@@ -65,6 +66,7 @@ async def test_sensor(\n         \"envoy_metered_batt_relay\",\n         \"envoy_nobatt_metered_3p\",\n         \"envoy_tot_cons_metered\",\n+        \"envoy_acb_batt\",\n     ],\n     indirect=[\"mock_envoy\"],\n )\n@@ -154,6 +156,7 @@ async def test_sensor_production_phase_data(\n         \"envoy_eu_batt\",\n         \"envoy_metered_batt_relay\",\n         \"envoy_nobatt_metered_3p\",\n+        \"envoy_acb_batt\",\n     ],\n     indirect=[\"mock_envoy\"],\n )\n@@ -197,6 +200,7 @@ async def test_sensor_consumption_data(\n         \"envoy_metered_batt_relay\",\n         \"envoy_nobatt_metered_3p\",\n         \"envoy_tot_cons_metered\",\n+        \"envoy_acb_batt\",\n     ],\n     indirect=[\"mock_envoy\"],\n )\n@@ -803,6 +807,7 @@ async def test_sensor_inverter_disabled_by_integration(\n     (\"mock_envoy\"),\n     [\n         \"envoy_metered_batt_relay\",\n+        \"envoy_acb_batt\",\n     ],\n     indirect=[\"mock_envoy\"],\n )\n@@ -873,6 +878,7 @@ async def test_sensor_encharge_enpower_data(\n     (\"mock_envoy\"),\n     [\n         \"envoy_metered_batt_relay\",\n+        \"envoy_acb_batt\",\n     ],\n     indirect=[\"mock_envoy\"],\n )\n@@ -930,6 +936,101 @@ async def test_sensor_encharge_power_data(\n         )\n \n \n+ACB_POWER_INT_NAMES: tuple[str, ...] = (\n+    \"power\",\n+    \"battery\",\n+)\n+ACB_POWER_STR_NAMES: tuple[str, ...] = (\"battery_state\",)\n+\n+\n+@pytest.mark.parametrize(\n+    (\"mock_envoy\"),\n+    [\n+        \"envoy_acb_batt\",\n+    ],\n+    indirect=[\"mock_envoy\"],\n+)\n+async def test_sensor_acb_power_data(\n+    hass: HomeAssistant,\n+    config_entry: MockConfigEntry,\n+    mock_envoy: AsyncMock,\n+) -> None:\n+    \"\"\"Test enphase_envoy acb battery power entities values.\"\"\"\n+    with patch(\"homeassistant.components.enphase_envoy.PLATFORMS\", [Platform.SENSOR]):\n+        await setup_integration(hass, config_entry)\n+\n+    sn = mock_envoy.serial_number\n+    ENTITY_BASE: str = f\"{Platform.SENSOR}.acb_{sn}\"\n+\n+    data = mock_envoy.data.acb_power\n+    ACB_POWER_INT_TARGETS: tuple[int, ...] = (\n+        data.power,\n+        data.state_of_charge,\n+    )\n+    ACB_POWER_STR_TARGETS: tuple[int, ...] = (data.state,)\n+\n+    for name, target in list(\n+        zip(ACB_POWER_INT_NAMES, ACB_POWER_INT_TARGETS, strict=False)\n+    ):\n+        assert (entity_state := hass.states.get(f\"{ENTITY_BASE}_{name}\"))\n+        assert int(entity_state.state) == target\n+\n+    for name, target in list(\n+        zip(ACB_POWER_STR_NAMES, ACB_POWER_STR_TARGETS, strict=False)\n+    ):\n+        assert (entity_state := hass.states.get(f\"{ENTITY_BASE}_{name}\"))\n+        assert entity_state.state == target\n+\n+\n+AGGREGATED_BATTERY_NAMES: tuple[str, ...] = (\n+    \"aggregated_battery_soc\",\n+    \"aggregated_available_battery_energy\",\n+    \"aggregated_battery_capacity\",\n+)\n+AGGREGATED_ACB_BATTERY_NAMES: tuple[str, ...] = (\"available_acb_battery_energy\",)\n+\n+\n+@pytest.mark.parametrize(\n+    (\"mock_envoy\"),\n+    [\n+        \"envoy_acb_batt\",\n+    ],\n+    indirect=[\"mock_envoy\"],\n+)\n+async def test_sensor_aggegated_battery_data(\n+    hass: HomeAssistant,\n+    config_entry: MockConfigEntry,\n+    mock_envoy: AsyncMock,\n+) -> None:\n+    \"\"\"Test enphase_envoy aggregated batteries entities values.\"\"\"\n+    with patch(\"homeassistant.components.enphase_envoy.PLATFORMS\", [Platform.SENSOR]):\n+        await setup_integration(hass, config_entry)\n+\n+    sn = mock_envoy.serial_number\n+    ENTITY_BASE: str = f\"{Platform.SENSOR}.envoy_{sn}\"\n+\n+    data = mock_envoy.data.battery_aggregate\n+    AGGREGATED_TARGETS: tuple[int, ...] = (\n+        data.state_of_charge,\n+        data.available_energy,\n+        data.max_available_capacity,\n+    )\n+\n+    for name, target in list(\n+        zip(AGGREGATED_BATTERY_NAMES, AGGREGATED_TARGETS, strict=False)\n+    ):\n+        assert (entity_state := hass.states.get(f\"{ENTITY_BASE}_{name}\"))\n+        assert int(entity_state.state) == target\n+\n+    data = mock_envoy.data.acb_power\n+    AGGREGATED_ACB_TARGETS: tuple[int, ...] = (data.charge_wh,)\n+    for name, target in list(\n+        zip(AGGREGATED_ACB_BATTERY_NAMES, AGGREGATED_ACB_TARGETS, strict=False)\n+    ):\n+        assert (entity_state := hass.states.get(f\"{ENTITY_BASE}_{name}\"))\n+        assert int(entity_state.state) == target\n+\n+\n def integration_disabled_entities(\n     entity_registry: er.EntityRegistry, config_entry: MockConfigEntry\n ) -> list[str]:\n", "problem_statement": "Envoy Enphase integration : managing both ACB and Encharge batteries ?\n### The problem\n\nI have an Enphase set-up with both ACB batteries and Encharge 3T  batteries.\r\nI can see only 1 battery level in HA which seems to be only the Encharge one.\r\n\n\n### What version of Home Assistant Core has the issue?\n\ncore-2024.11.1\n\n### What was the last working version of Home Assistant Core?\n\n_No response_\n\n### What type of installation are you running?\n\nHome Assistant Container\n\n### Integration causing the issue\n\nEnphase Envoy\n\n### Link to integration documentation on our website\n\nhttps://www.home-assistant.io/integrations/enphase_envoy\n\n### Diagnostics information\n\n[config_entry-enphase_envoy-01JC3CMDVGSWMRNRM4JVWTB6WF.json](https://github.com/user-attachments/files/17802822/config_entry-enphase_envoy-01JC3CMDVGSWMRNRM4JVWTB6WF.json)\r\n\n\n### Example YAML snippet\n\n_No response_\n\n### Anything in the logs that might be useful for us?\n\n_No response_\n\n### Additional information\n\nI can tell (from Domoticz Enphase plugin integration) that the answer lies into the enphase API : /ivp/livedata/status\r\n\r\ncb_agg_soc : % level of ACB batteries\r\nenc_agg_soc : % level of Encharge IQ 3T batteries\r\nsoc : average\r\n\r\nI am interested in the average of my 2 differents batteries.\n", "hints_text": "\nHey there @bdraco, @cgarwood, @joostlek, @catsmanac, mind taking a look at this issue as it has been labeled with an integration (`enphase_envoy`) you are listed as a [code owner](https://github.com/home-assistant/core/blob/dev/CODEOWNERS#L422) for? Thanks!\n\n<details>\n<summary>Code owner commands</summary>\n\n\nCode owners of `enphase_envoy` can trigger bot actions by commenting:\n\n- `@home-assistant close` Closes the issue.\n- `@home-assistant rename Awesome new title` Renames the issue.\n- `@home-assistant reopen` Reopen the issue.\n- `@home-assistant unassign enphase_envoy` Removes the current integration label and assignees on the issue, add the integration domain after the command.\n- `@home-assistant add-label needs-more-information` Add a label (needs-more-information, problem in dependency, problem in custom component) to the issue.\n- `@home-assistant remove-label needs-more-information` Remove a label (needs-more-information, problem in dependency, problem in custom component) on the issue.\n\n</details>\n\n\n<sub><sup>(message by CodeOwnersMention)</sup></sub>\n\n---\n\n[enphase_envoy documentation](https://www.home-assistant.io/integrations/enphase_envoy)\n[enphase_envoy source](https://github.com/home-assistant/core/tree/dev/homeassistant/components/enphase_envoy)\n<sub><sup>(message by IssueLinks)</sup></sub>\nHi @rezzalex, your the first one I know of asking for these ACB batteries. We don't have these currently in the data model, but I see the data in the raw data requested from the Envoy.\r\n\r\nWhich means it's gonna take some code changes. Before we embark on that can you answer some exploring questions so we can move in the right direction.\r\n\r\nIn the Envoy production report in your diagnostics file I see:\r\n```json\r\n\"storage\": [\r\n  {\r\n    \"type\": \"acb\",\r\n    \"activeCount\": 3,\r\n    \"readingTime\": 1731943992,\r\n    \"wNow\": 260,\r\n    \"whNow\": 930,\r\n    \"state\": \"discharging\",\r\n    \"percentFull\": 25\r\n  }\r\n]\r\n```\r\nAnd in the Encharge data, the ACB soc and energy content is included as well.\r\n```JSON\r\n\"ACB_agg_soc\": 25,\r\n\"ACB_agg_energy\": 930,\r\n```\r\n\r\nI think all this translate to: \r\n- you have 3 ACB batteries, current combined charge is 930Wh which is 25% full?\r\n- each of the ACB battery has a full capacity of 1240 Wh, combined 3720 Wh?\r\n\r\nFor the Encharge batteries I see\r\n\r\n```json\r\n\"percentFull\": 54,\r\n```\r\nAnd\r\n```json\r\n\"ENC_agg_soc\": 54,\r\n\r\n\"ENC_agg_avail_energy\": 1890,\r\n\"Enc_commissioned_capacity\": 3500,\r\n\"Enc_max_available_capacity\": 3500,\r\n```\r\n- So this is 1 3T batteries containing 1890 Wh at 54% and total capacity of 3500.\r\n\r\nCombined capacity is then 3500 + 3720 = 7220 Wh. The latter is also reported by Encharge\r\n\r\n```json\r\n\"agg_soc\": 39,\r\n\"Max_energy\": 7220,\r\n```\r\nAgg_soc of 39% of 7220 is 2815 Wh  which is roughly the ACB 930 Wh + the Encharge 1890 Wh\r\n\r\nCan you confirm these numbers?\r\n\r\n\nHello @catsmanac ,\r\n\r\nthanks a lot for your quick answer, already performed investigation and the will to take into account my probably rare enphase set-up.\r\n\r\nALL your hypothesis and numbers are correct, except that in the API I have mentioned (/ivp/livedata/status), there is no `agg_soc`, only `soc`\r\n\r\nif it can help : https://github.com/domoticz/domoticz/issues/5798\nThanks for the link @rezzalex, that contains lot's of background info. We won't use the /ivp/livedata/status as that does not provide any data if no CT are installed (as on my PV Only Envoy non-metered). Since I found the same information in what we collect already that should not be an issue.\r\n\r\nSince ACB batteries report aggregated and not like Encharge, each individual, I would think to add these as a single ACB device with current Power, Capacity, soc and state.\r\n\r\nAnd then, if both Encharge and ACB batteries exist, add an Aggregate SOC to to the envoy device showing the combined soc of encharge and ACB batteries.\r\n\r\nDoes that match with what you have in mind?\nThat would be perfect indeed.\r\n\r\nIn my case, I am only interested in the aggregated state of charge (SOC), specifically the percentage of charge and the \"instant\" power that can flow in and out.\r\n\r\nHowever, what you described seems to cover all possible Envoy Enphase possible set_up\nTo test any new code for this case, I would appreciate if you can provide a diagnostics file that includes test fixture data. To provide such data, if you are willing to, go to settings / devices & services / Enphase Envoy  and click the `configure` option for the Envoy.\r\n\r\nThen enable the option to include test fixture data in the diagnostic report. \r\n![afbeelding](https://github.com/user-attachments/assets/97f12156-ffdd-4df6-bd2a-32abb4f4f813)\r\n\r\nThen geta fresh diagnostics report that now will include the needed data to build test cases. Afterwards undo the configured option again as gathering the test data makes report creation somewhat slower and is not required for standard troubleshooting.\nHello @catsmanac ,\r\n\r\nis it what you are looking for ?\r\n[config_entry-enphase_envoy-01JC3CMDVGSWMRNRM4JVWTB6WF (1).json](https://github.com/user-attachments/files/17827772/config_entry-enphase_envoy-01JC3CMDVGSWMRNRM4JVWTB6WF.1.json)\r\n\nThanks @rezzalex, that's exactly it.  \r\n\r\nWhat will happen next:\r\n- code change and test and apply the change to the [pyenphase](https://github.com/pyenphase/pyenphase), the underlying code. - the code change will require review and approval. \r\n- once that is done the updated pyenphase library will be included in HA. \r\n- when that is done, the integration in HA will be updated and a PR  requiring review for HA will be issued.\r\n- And a change to HA documentation will also be issued. \r\n- As this is not a bug fix, but functional change it will be included in an upcoming HA major release, so 2024.12, 2025.1, ...\r\n\r\nAs you can see from the list, it will take some steps and time. Sometimes all moves quickly, something it takes longer. All involved are volunteers so availability varies. \nthanks for the transparency\nLooking at the data it seems the ACB batteries are currently empty and in idle state. Is that correct?\r\n\r\n```json\r\n    \"storage\": [\r\n        {\r\n            \"type\": \"acb\",\r\n            \"activeCount\": 3,\r\n            \"readingTime\": 1732089607,\r\n            \"wNow\": -15,\r\n            \"whNow\": 0,\r\n            \"state\": \"idle\",\r\n            \"percentFull\": 0\r\n        }\r\n    ]\r\n````\r\n\r\nCombined overall SOC is at 4%, the 3T Encharge battery SOC at 10%. Combined avaialble energy at 350Wh (from the 3T)\r\n\r\n```json\r\n    \"agg_soc\": 4,\r\n    \"Max_energy\": 7220,\r\n    \"ENC_agg_soc\": 10,\r\n    \"ENC_agg_soh\": 100,\r\n    \"ENC_agg_backup_energy\": 0,\r\n    \"ENC_agg_avail_energy\": 350,\r\n    \"Enc_commissioned_capacity\": 3500,\r\n    \"Enc_max_available_capacity\": 3500,\r\n    \"ACB_agg_soc\": 0,\r\n    \"ACB_agg_energy\": 0,\r\n```\nright now, enphase mobile app show me  7% on the livestatus screen and 5% on the first \"state\" screen\r\n\r\nthe battery details screen shows\r\nGLOBAL : 5%, and \r\navailable energy : 0,45 of 7,22kwh\r\npower : 1,28 of 1,28 kwh\r\n\r\neach ACB battery is at 1% \r\n\r\nencharge at 12%\r\navailable energy : 0,42 of 3,5 kwh\r\n\r\nI hope it helps\nYes, those numbers are close enough to match what is in the diagnostics and build some test cases from.\nFirst 2 [steps](https://github.com/home-assistant/core/issues/130879#issuecomment-2488001219) completed.\nThis would be the concept, @rezzalex.\r\n\r\nThere's an ACB device that shows soc, state en power for the ACB batteries.\r\nThe existing Encharge batteries remain unchanged.\r\nThe Envoy data now has 4 new entities, 3 for the overall aggregated data from ACB and Encharge baterries and 1 for the current available ACB batteries energy.\r\n\r\n![Schermafbeelding 2024-11-22 131654](https://github.com/user-attachments/assets/48dba510-711f-4eb6-af88-3474aaf22e3e)\r\n", "created_at": "2024-11-22T17:52:22Z"}
{"repo": "home-assistant/core", "pull_number": 131249, "instance_id": "home-assistant__core-131249", "issue_numbers": ["130809"], "base_commit": "f3964596de543f28601040fd83565fae4b5b97c0", "patch": "diff --git a/homeassistant/components/tplink/manifest.json b/homeassistant/components/tplink/manifest.json\nindex 67ae1af90034ce..3f19f50cdb6845 100644\n--- a/homeassistant/components/tplink/manifest.json\n+++ b/homeassistant/components/tplink/manifest.json\n@@ -300,5 +300,5 @@\n   \"documentation\": \"https://www.home-assistant.io/integrations/tplink\",\n   \"iot_class\": \"local_polling\",\n   \"loggers\": [\"kasa\"],\n-  \"requirements\": [\"python-kasa[speedups]==0.7.7\"]\n+  \"requirements\": [\"python-kasa[speedups]==0.8.0\"]\n }\ndiff --git a/requirements_all.txt b/requirements_all.txt\nindex 7911e16f316e79..01df605ec3e330 100644\n--- a/requirements_all.txt\n+++ b/requirements_all.txt\n@@ -2362,7 +2362,7 @@ python-join-api==0.0.9\n python-juicenet==1.1.0\n \n # homeassistant.components.tplink\n-python-kasa[speedups]==0.7.7\n+python-kasa[speedups]==0.8.0\n \n # homeassistant.components.linkplay\n python-linkplay==0.0.20\n", "test_patch": "diff --git a/requirements_test_all.txt b/requirements_test_all.txt\nindex 30f31ea6af4d27..308e15788090c9 100644\n--- a/requirements_test_all.txt\n+++ b/requirements_test_all.txt\n@@ -1889,7 +1889,7 @@ python-izone==1.2.9\n python-juicenet==1.1.0\n \n # homeassistant.components.tplink\n-python-kasa[speedups]==0.7.7\n+python-kasa[speedups]==0.8.0\n \n # homeassistant.components.linkplay\n python-linkplay==0.0.20\n", "problem_statement": "Warning from kasa.discover\n### The problem\r\n\r\n`Logger: kasa.discover\r\nSource: runner.py:189\r\nFirst occurred: November 16, 2024 at 6:07:50 PM (286 occurrences)\r\nLast logged: 8:37:51 AM\r\n\r\nGot unsupported connection type: {'device_family': 'SMART.IPCAMERA', 'encryption_type': 'AES', 'https': True}`\r\n\r\n### What version of Home Assistant Core has the issue?\r\n\r\ncore-2024.11.2\r\n\r\n### What was the last working version of Home Assistant Core?\r\n\r\ncore-2024.10.* but not sure\r\n\r\n### What type of installation are you running?\r\n\r\nHome Assistant OS\r\n\r\n### Integration causing the issue\r\n\r\ntp-link\r\n\r\n### Link to integration documentation on our website\r\n\r\n_No response_\r\n\r\n### Diagnostics information\r\n\r\n_No response_\r\n\r\n### Example YAML snippet\r\n\r\n_No response_\r\n\r\n### Anything in the logs that might be useful for us?\r\n\r\n_No response_\r\n\r\n### Additional information\r\n\r\n_No response_\n", "hints_text": "I too have this issue\nSome further info...\r\nI use the TP-Link integration for four Kasa wifi wall switches.\r\nI also have 5 Tapo cameras that are connected to HA via ONVIF integration.\r\nThese devices are not new and have been working great for well over a year.\r\nThe above error started after updating to Core 2024.11.0\r\nThe above log entry happens every few minutes.\r\nThere are no other log entries.\nI see this a lot also.\r\nI only have one switch, HS100, through TP-link Smart home integration.\r\nBut I also have 3 Tapo cameras in HACS integration TAPO: Cameras Control, if that is what is picked up!\nSame issue here. I have a Tapo camera which I am pretty sure is the source of this error.\n\nHey there @rytilahti, @bdraco, @sdb9696, mind taking a look at this issue as it has been labeled with an integration (`tplink`) you are listed as a [code owner](https://github.com/home-assistant/core/blob/dev/CODEOWNERS#L1534) for? Thanks!\n\n<details>\n<summary>Code owner commands</summary>\n\n\nCode owners of `tplink` can trigger bot actions by commenting:\n\n- `@home-assistant close` Closes the issue.\n- `@home-assistant rename Awesome new title` Renames the issue.\n- `@home-assistant reopen` Reopen the issue.\n- `@home-assistant unassign tplink` Removes the current integration label and assignees on the issue, add the integration domain after the command.\n- `@home-assistant add-label needs-more-information` Add a label (needs-more-information, problem in dependency, problem in custom component) to the issue.\n- `@home-assistant remove-label needs-more-information` Remove a label (needs-more-information, problem in dependency, problem in custom component) on the issue.\n\n</details>\n\n\n<sub><sup>(message by CodeOwnersMention)</sup></sub>\n\n---\n\n[tplink documentation](https://www.home-assistant.io/integrations/tplink)\n[tplink source](https://github.com/home-assistant/core/tree/dev/homeassistant/components/tplink)\n<sub><sup>(message by IssueLinks)</sup></sub>\nSome recent library restructuring made unfortunately the discovery process a bit noisier than expected, this is being tracked upstream at https://github.com/python-kasa/python-kasa/issues/1267 .\r\n\r\nUntil a new version of python-kasa gets released and the dependency bumped, you can suppress the warning by [configuring homeassistant's logger to use log level `error` for `kasa`](https://www.home-assistant.io/integrations/logger/).", "created_at": "2024-11-22T10:32:28Z"}
{"repo": "home-assistant/core", "pull_number": 131206, "instance_id": "home-assistant__core-131206", "issue_numbers": ["130818"], "base_commit": "797eb606fe0cb40cccaaa06c3cbed9d622ce1934", "patch": "diff --git a/homeassistant/components/fibaro/cover.py b/homeassistant/components/fibaro/cover.py\nindex c787ca702726c5..0898d1c931842a 100644\n--- a/homeassistant/components/fibaro/cover.py\n+++ b/homeassistant/components/fibaro/cover.py\n@@ -69,37 +69,29 @@ def _is_open_close_only(self) -> bool:\n         # so if it is missing we have a device which supports open / close only\n         return not self.fibaro_device.value.has_value\n \n-    @property\n-    def current_cover_position(self) -> int | None:\n-        \"\"\"Return current position of cover. 0 is closed, 100 is open.\"\"\"\n-        return self.bound(self.level)\n-\n-    @property\n-    def current_cover_tilt_position(self) -> int | None:\n-        \"\"\"Return the current tilt position for venetian blinds.\"\"\"\n-        return self.bound(self.level2)\n-\n-    @property\n-    def is_opening(self) -> bool | None:\n-        \"\"\"Return if the cover is opening or not.\n-\n-        Be aware that this property is only available for some modern devices.\n-        For example the Fibaro Roller Shutter 4 reports this correctly.\n-        \"\"\"\n-        if self.fibaro_device.state.has_value:\n-            return self.fibaro_device.state.str_value().lower() == \"opening\"\n-        return None\n-\n-    @property\n-    def is_closing(self) -> bool | None:\n-        \"\"\"Return if the cover is closing or not.\n-\n-        Be aware that this property is only available for some modern devices.\n-        For example the Fibaro Roller Shutter 4 reports this correctly.\n-        \"\"\"\n-        if self.fibaro_device.state.has_value:\n-            return self.fibaro_device.state.str_value().lower() == \"closing\"\n-        return None\n+    def update(self) -> None:\n+        \"\"\"Update the state.\"\"\"\n+        super().update()\n+\n+        self._attr_current_cover_position = self.bound(self.level)\n+        self._attr_current_cover_tilt_position = self.bound(self.level2)\n+\n+        device_state = self.fibaro_device.state\n+\n+        # Be aware that opening and closing is only available for some modern\n+        # devices.\n+        # For example the Fibaro Roller Shutter 4 reports this correctly.\n+        if device_state.has_value:\n+            self._attr_is_opening = device_state.str_value().lower() == \"opening\"\n+            self._attr_is_closing = device_state.str_value().lower() == \"closing\"\n+\n+        closed: bool | None = None\n+        if self._is_open_close_only():\n+            if device_state.has_value and device_state.str_value().lower() != \"unknown\":\n+                closed = device_state.str_value().lower() == \"closed\"\n+        elif self.current_cover_position is not None:\n+            closed = self.current_cover_position == 0\n+        self._attr_is_closed = closed\n \n     def set_cover_position(self, **kwargs: Any) -> None:\n         \"\"\"Move the cover to a specific position.\"\"\"\n@@ -109,19 +101,6 @@ def set_cover_tilt_position(self, **kwargs: Any) -> None:\n         \"\"\"Move the cover to a specific position.\"\"\"\n         self.set_level2(cast(int, kwargs.get(ATTR_TILT_POSITION)))\n \n-    @property\n-    def is_closed(self) -> bool | None:\n-        \"\"\"Return if the cover is closed.\"\"\"\n-        if self._is_open_close_only():\n-            state = self.fibaro_device.state\n-            if not state.has_value or state.str_value().lower() == \"unknown\":\n-                return None\n-            return state.str_value().lower() == \"closed\"\n-\n-        if self.current_cover_position is None:\n-            return None\n-        return self.current_cover_position == 0\n-\n     def open_cover(self, **kwargs: Any) -> None:\n         \"\"\"Open the cover.\"\"\"\n         self.action(\"open\")\n", "test_patch": "", "problem_statement": "Fibaro HC3L integration Cover when is not completely open/closed is showing wrong state\n### The problem\n\nThanks to @rappenze. \r\nHe add state opening/closeing to fibaro integration. We disguss it in #126830.\r\nNow I have one problem. \r\nWhen i stop fibaro shutter while it is moveing. State of entity don't change. It is opening/closeing - but it is now stopped now.\r\nIs there any change to add stopped state to it ?\n\n### What version of Home Assistant Core has the issue?\n\n2024.11.1\n\n### What was the last working version of Home Assistant Core?\n\n_No response_\n\n### What type of installation are you running?\n\nHome Assistant OS\n\n### Integration causing the issue\n\nFibaro\n\n### Link to integration documentation on our website\n\nhttps://www.home-assistant.io/integrations/fibaro\n\n### Diagnostics information\n\n_No response_\n\n### Example YAML snippet\n\n_No response_\n\n### Anything in the logs that might be useful for us?\n\n_No response_\n\n### Additional information\n\n_No response_\n", "hints_text": "\nHey there @rappenze, mind taking a look at this issue as it has been labeled with an integration (`fibaro`) you are listed as a [code owner](https://github.com/home-assistant/core/blob/dev/CODEOWNERS#L458) for? Thanks!\n\n<details>\n<summary>Code owner commands</summary>\n\n\nCode owners of `fibaro` can trigger bot actions by commenting:\n\n- `@home-assistant close` Closes the issue.\n- `@home-assistant rename Awesome new title` Renames the issue.\n- `@home-assistant reopen` Reopen the issue.\n- `@home-assistant unassign fibaro` Removes the current integration label and assignees on the issue, add the integration domain after the command.\n- `@home-assistant add-label needs-more-information` Add a label (needs-more-information, problem in dependency, problem in custom component) to the issue.\n- `@home-assistant remove-label needs-more-information` Remove a label (needs-more-information, problem in dependency, problem in custom component) on the issue.\n\n</details>\n\n\n<sub><sup>(message by CodeOwnersMention)</sup></sub>\n\n---\n\n[fibaro documentation](https://www.home-assistant.io/integrations/fibaro)\n[fibaro source](https://github.com/home-assistant/core/tree/dev/homeassistant/components/fibaro)\n<sub><sup>(message by IssueLinks)</sup></sub>\nThanks for your report. Unsure why it does not work. In the last issue you just added a small part of the log. Can you provide a full log? For example: fully opened, stopped in the middle -> fully closed -> fully opened again. Then I should see what states and positions for each case is reported from fibaro home center and hopefully fix it.\nOf course! Here it is: Fully open- close - stop - close - open - stop - open  and fully close - fully open :) \r\n[home-assistant_fibaro_2024-11-18T12-44-42.536Z.log](https://github.com/user-attachments/files/17800426/home-assistant_fibaro_2024-11-18T12-44-42.536Z.log)\r\n\r\n\r\n\nThanks for your log.\r\n\r\nSo basically what I can see is that fibaro correctly sends the state \"Unknown\" when you stop it in the middle and sets the value to the position in percent.\r\n\r\nThis should be processed in HA correctly. I tried to reproduce it  on my side by changing the state with some debug code, but cannot reproduce the behaviour. So what I have done is setting the state to `Closing` when close is pressed and set it to `Unknown` when stop is pressed. This is the same as shown in the log. As soon as I set the state to `Unknown`, HA change the state from `Closing` to `Open` in the UI. So all seems fine here.\r\n\r\nI'm not sure why it does not work on your side, maybe some timing issues? Do you have any idea what else we can try? If you do it several times does it sometimes work (which would then clarify that it is a timing issue)?\r\n\r\n**Unrelated to this issue:**\r\nYou can see a response with\r\n```\r\n{'type': 'PluginProcessCrashedEvent', 'created': 1731933845, 'createdMillis': 1731933845403, \r\n'data': {'deviceId': 84, 'error': \"./include/main.lua:208: attempt to concatenate a nil value (local 'value')\"}\r\n```\r\nin the log, so it looks like you have an invalid scene or quick app which you should fix.\nIn my configuration theres no Unknown state (when it's stopped' - it is opening) \r\nIn attributes of entity i see this:`friendly_name: 116 Zas\u0142ona (Salon)\r\nsupported_features: 255\r\nviewXml: false\r\nbaseType: com.fibaro.baseShutter\r\nroomID: 219\r\ninterfaces: calibratable, energy, favoritePosition, fibaroFirmwareUpdate, levelChange, zwave, zwaveAlarm, zwaveIndicator, zwaveMultiChannelAssociation, zwaveProtection\r\ntype: com.fibaro.FGR224\r\nenabled: true\r\nroomName: Salon\r\nsortOrder: 73\r\nmodified: 1731595403\r\nhasUIView: true\r\ncreated: 1731595218\r\nvisible: true\r\nparentId: 116\r\nid: 117\r\nactions: \r\nopen: 0\r\nretryUpdate: 1\r\nsetValue: 1\r\nsetValue2: 1\r\nreset: 0\r\nstartUpdate: 1\r\nsetFavoritePosition: 1\r\nclose: 0\r\nstopLevelChange: 0\r\nstartCalibration: 1\r\nstartLevelDecrease: 0\r\nstartLevelIncrease: 0\r\nabortUpdate: 1\r\nsetIndicatorValue: 1\r\nupdateFirmware: 1\r\nstop: 0\r\nreconfigure: 0\r\nconfigureFavoritePositions: 1\r\n\r\nconfigXml: false\r\nproperties: \r\nstate: Unknown\r\nprotectionState: 0\r\nslatsRotationTime: 1500\r\nnodeId: 6\r\nRFProtectionSupport: 3\r\nenergy: 0\r\nvirtualBottomLimit: 0\r\nvalue2: 0\r\nlocalProtectionSupport: 5\r\nzwaveCompany: Fibargroup\r\nlog: ''\r\nzwaveInfo: 3,7,18\r\nmovingUpTime: 10500\r\nprotectionExclusiveControlSupport: false\r\nRFProtectionState: 0\r\nuseTemplate: true\r\nupdateVersion: ''\r\nfavoritePositionsNativeSupport: true\r\nproductInfo: 1,15,3,4,16,0,8,2\r\ncalibrated: true\r\nmanufacturer: ''\r\ntargetValue: 35\r\nprotectionTimeout: 0\r\nfavoritePositions:\r\n  - label: Favorite position\r\n    name: FavoritePosition1\r\n    value: 50\r\nsupportedDeviceRoles:\r\n  - BlindsWithPositioning\r\n  - Awning\r\n  - Curtain\r\n  - Pergola\r\n  - VenetianBlinds\r\nstoreEnergyData: true\r\ndeviceIcon: 340\r\nslatsRange: 0\r\nconfigured: true\r\nalarmLevel: 0\r\nfirmwareUpdate:\r\n  progress: 0\r\n  status: UpToDate\r\n  info: ''\r\n  updateVersion: '8.2'\r\nlogTemp: ''\r\ndeadReason: ''\r\nindicatorValue:\r\n  - id: 0\r\n    properties:\r\n      '0': 0\r\nserialNumber: h'0000000000000e16\r\nsaveToEnergyPanel: true\r\nlocalProtectionState: 0\r\ndeviceControlType: 53\r\nsaveLogs: true\r\ncategories:\r\n  - blinds\r\nendPointId: 0\r\npollingTimeSec: 0\r\ncalibrationVariants:\r\n  - rollerShutterCalibration\r\nuserDescription: ''\r\ndeviceRole: Curtain\r\nprotectionExclusiveControl: 0\r\nalarmType: 0\r\nparametersTemplate: 1006\r\nbuttonsType: none\r\nicon:\r\n  source: HC\r\n  path: /assets/icon/fibaro/Curtain/Curtain40.svg\r\nmotorInversion: false\r\nmovingDownTime: 9500\r\nmodel: ''\r\nmarkAsDead: true\r\nvalue: 35\r\nsteeringInversion: false\r\nzwaveVersion: '8.2'\r\nprotectionTimeoutSupport: false\r\nindicatorSupportedProperties: []\r\ncalculatedState: Opened\r\ndead: false\r\n\r\nisPlugin: false\r\nview: \r\n- assetsPath: dynamic-plugins/com.fibaro.rollerShutter\r\n  type: ts\r\n  name: com.fibaro.rollerShutter\r\n  translatesPath: /assets/i18n/com.fibaro.rollerShutter\r\n- assetsPath: dynamic-plugins/energy\r\n  type: ts\r\n  name: energy\r\n  translatesPath: /assets/i18n/energy\r\n- assetsPath: dynamic-plugins/favorite-positions\r\n  type: ts\r\n  name: favorite-positions\r\n  translatesPath: /assets/i18n/favorite-positions\r\n- assetsPath: ''\r\n  type: ts\r\n  name: level-change\r\n  translatesPath: /assets/i18n/level-change\r\n\r\ncurrent_position: 77\r\ncurrent_tilt_position: 0`\r\n\r\nI Try to reAdd this roller shutter in Fibaro but it doesn't help.\r\nDo you have what I can check what i'm doing wrong ? \r\n\r\nP.S. Yes my fibaro has some invalid scenes :D I'm trying to work with my modbus TCP in it but it's not going to cooperate with me :<\r\n", "created_at": "2024-11-21T19:46:41Z"}
{"repo": "home-assistant/core", "pull_number": 131196, "instance_id": "home-assistant__core-131196", "issue_numbers": ["128109"], "base_commit": "b60f981c3ebfcbee135daf809322192bb7b909b2", "patch": "diff --git a/homeassistant/components/utility_meter/strings.json b/homeassistant/components/utility_meter/strings.json\nindex e05789aece16f6..4a8ae415a835e8 100644\n--- a/homeassistant/components/utility_meter/strings.json\n+++ b/homeassistant/components/utility_meter/strings.json\n@@ -3,7 +3,7 @@\n   \"config\": {\n     \"step\": {\n       \"user\": {\n-        \"title\": \"Add Utility Meter\",\n+        \"title\": \"Create Utility Meter\",\n         \"description\": \"Create a sensor which tracks consumption of various utilities (e.g., energy, gas, water, heating) over a configured period of time, typically monthly. The utility meter sensor optionally supports splitting the consumption by tariffs, in that case one sensor for each tariff is created as well as a select entity to choose the current tariff.\",\n         \"data\": {\n           \"always_available\": \"Sensor always available\",\n", "test_patch": "", "problem_statement": "Small inconsistencies in Create/Add dialogs for different Helper types\n### The problem\r\n\r\nI ran into this while reviewing the German translation of these strings, because one localizer preferred to simply alter the German translations instead of reporting this as a bug for the English orginals.\r\n\r\nI reverted those edits in Lokalise to report this here instead so we keep a close 1:1 relation between the different languages.\r\n\r\nIt's all keys with\r\n\r\n     config::step::user::title\r\n\r\nin them, so they should be easily locatable.\r\n\r\nMost of the headlines for creating helpers start with \"Create \u2026\"\r\nbut there are a few exceptions that should be made consistent:\r\n\r\n     component::generic_thermostat::config::step::user::title\r\n     Add generic thermostat                                     Done\r\n\r\n     component::generic_hygrostat::config::step::user::title \r\n     Add generic hygrostat                                      Done\r\n\r\n     component::derivative::config::step::user::title\r\n     Add Derivative sensor                                      Done\r\n\r\n     component::integration::config::step::user::title\r\n     Add Riemann sum integral sensor                            Done\r\n\r\n     component::threshold::config::step::user::title\r\n     Add Threshold Sensor                                       Done\r\n\r\n     component::group::config::step::user::title\r\n     Add Group                                                  Done\r\n\r\n     component::utility_meter::config::step::user::title \r\n     Add Utility Meter                                          PR filed\r\n\r\nThose above should be changed to \"Create \u2026\" to match the others.\r\n\r\nThis will help all translators to use a consistent wording, too.\r\n\r\n\r\n### What version of Home Assistant Core has the issue?\r\n\r\ncore-2024.10.1\r\n\r\n\n", "hints_text": "[helpers documentation](https://www.home-assistant.io/integrations/helpers)\n[helpers source](https://github.com/home-assistant/core/tree/dev/homeassistant/components/helpers)", "created_at": "2024-11-21T17:44:07Z"}
{"repo": "home-assistant/core", "pull_number": 131160, "instance_id": "home-assistant__core-131160", "issue_numbers": ["129212"], "base_commit": "afe986b39c082f37e8a37b3b25f263c36e32fa0e", "patch": "diff --git a/homeassistant/components/calendar/strings.json b/homeassistant/components/calendar/strings.json\nindex 76e6c42b6663d8..c0127c20d052d4 100644\n--- a/homeassistant/components/calendar/strings.json\n+++ b/homeassistant/components/calendar/strings.json\n@@ -82,11 +82,11 @@\n         },\n         \"end_date_time\": {\n           \"name\": \"End time\",\n-          \"description\": \"Returns active events before this time (exclusive). Cannot be used with 'duration'.\"\n+          \"description\": \"Returns active events before this time (exclusive). Cannot be used with Duration.\"\n         },\n         \"duration\": {\n           \"name\": \"Duration\",\n-          \"description\": \"Returns active events from start_date_time until the specified duration.\"\n+          \"description\": \"Returns active events from Start time for the specified duration.\"\n         }\n       }\n     }\n", "test_patch": "", "problem_statement": "Calendar: \"start_date_time\" in Get Events action should be replaced by the actual name of the field\n### The problem\r\n\r\nThere is a variable name in this description that should be the actual name of the option instead:\r\n\r\n![Screenshot 2024-10-26 12 17 18](https://github.com/user-attachments/assets/d424afbc-6a88-4feb-9ae9-6b91927edb6d)\r\n\r\nhttps://github.com/home-assistant/core/blob/65ee4e191658676f586182ed48708f7db62d1b78/homeassistant/components/calendar/strings.json#L87-L89\r\n\r\nGiven that the string for 'end time' uses apostrophes to refer to 'duration'  this should become\r\n\r\n    Returns active events from 'start time' until the specified duration.\r\n\r\nbut, if my German grammar does not fool me here, this should actually become:\r\n\r\n    Returns active events from 'start time' for the specified duration.\r\n\r\nor\r\n\r\n    Returns active events from 'start time' until the specified duration ends.\r\n\r\n\r\n\r\n### What version of Home Assistant Core has the issue?\r\n\r\n2024.10.4\r\n\r\n### Integration causing the issue\r\n\r\nCalendar\r\n\r\n### Link to integration documentation on our website\r\n\r\nhttps://www.home-assistant.io/integrations/calendar\r\n\r\n\n", "hints_text": "\nHey there @home-assistant/core, mind taking a look at this issue as it has been labeled with an integration (`calendar`) you are listed as a [code owner](https://github.com/home-assistant/core/blob/dev/CODEOWNERS#L240) for? Thanks!\n\n<details>\n<summary>Code owner commands</summary>\n\n\nCode owners of `calendar` can trigger bot actions by commenting:\n\n- `@home-assistant close` Closes the issue.\n- `@home-assistant rename Awesome new title` Renames the issue.\n- `@home-assistant reopen` Reopen the issue.\n- `@home-assistant unassign calendar` Removes the current integration label and assignees on the issue, add the integration domain after the command.\n- `@home-assistant add-label needs-more-information` Add a label (needs-more-information, problem in dependency, problem in custom component) to the issue.\n- `@home-assistant remove-label needs-more-information` Remove a label (needs-more-information, problem in dependency, problem in custom component) on the issue.\n\n</details>\n\n\n<sub><sup>(message by CodeOwnersMention)</sup></sub>\n\n---\n\n[calendar documentation](https://www.home-assistant.io/integrations/calendar)\n[calendar source](https://github.com/home-assistant/core/tree/dev/homeassistant/components/calendar)\n<sub><sup>(message by IssueLinks)</sup></sub>\nHey, can I help resolving this issue?", "created_at": "2024-11-21T10:36:50Z"}
{"repo": "home-assistant/core", "pull_number": 131157, "instance_id": "home-assistant__core-131157", "issue_numbers": ["129722"], "base_commit": "afe986b39c082f37e8a37b3b25f263c36e32fa0e", "patch": "diff --git a/homeassistant/components/alarm_control_panel/strings.json b/homeassistant/components/alarm_control_panel/strings.json\nindex 6dac4d069a18f..733e02954c107 100644\n--- a/homeassistant/components/alarm_control_panel/strings.json\n+++ b/homeassistant/components/alarm_control_panel/strings.json\n@@ -130,7 +130,7 @@\n     },\n     \"alarm_trigger\": {\n       \"name\": \"Trigger\",\n-      \"description\": \"Enables an external alarm trigger.\",\n+      \"description\": \"Trigger the alarm manually.\",\n       \"fields\": {\n         \"code\": {\n           \"name\": \"[%key:component::alarm_control_panel::services::alarm_disarm::fields::code::name%]\",\n", "test_patch": "", "problem_statement": "Alarm control panel: Misleading description of 'Trigger'\n### The problem\r\n\r\nBasically the purpose of the \"Trigger\" action for the Alarm control panel is pretty obvious, but once you read the description you start to scratch your head if you actually misunderstood it - especially after being \"lost in translation\" (see below):\r\n\r\nhttps://github.com/home-assistant/core/blob/eddab96a69aecb79711b73a9ed2d35aca70b92f5/homeassistant/components/alarm_control_panel/strings.json#L131-L133\r\n\r\nIn the documentation the description is simply:\r\n\r\n    Trigger the alarm manually.\r\n\r\nand that should be used here as well. Avoids any misunderstanding and is consistent with the docs.\r\n\r\n\r\n_Note that this also created some translation problem:\r\nIn German  we translate \"Arms the alarm control panel\" as  \"**Aktiviert die Alarmzentrale**\". But \"aktivieren\" is also the German translation of \"enable\" and now you have it with \"Enables an external alarm trigger\" becoming \"**Aktiviert einen externen Alarmausl\u00f6ser**\".\r\nIn the end this now sounds like you activate some potential alarm trigger on top of activating the alarm control panel itself._\r\n\r\n\r\n### What version of Home Assistant Core has the issue?\r\n\r\n2024.11.0b2\r\n\r\n### What was the last working version of Home Assistant Core?\r\n\r\nn/a\r\n\r\n### What type of installation are you running?\r\n\r\nHome Assistant OS\r\n\r\n### Integration causing the issue\r\n\r\nAlarm control panel\r\n\r\n### Link to integration documentation on our website\r\n\r\nhttps://rc.home-assistant.io/integrations/alarm_control_panel\r\n\r\n\n", "hints_text": "\nHey there @home-assistant/core, mind taking a look at this issue as it has been labeled with an integration (`alarm_control_panel`) you are listed as a [code owner](https://github.com/home-assistant/core/blob/dev/CODEOWNERS#L84) for? Thanks!\n\n<details>\n<summary>Code owner commands</summary>\n\n\nCode owners of `alarm_control_panel` can trigger bot actions by commenting:\n\n- `@home-assistant close` Closes the issue.\n- `@home-assistant rename Awesome new title` Renames the issue.\n- `@home-assistant reopen` Reopen the issue.\n- `@home-assistant unassign alarm_control_panel` Removes the current integration label and assignees on the issue, add the integration domain after the command.\n- `@home-assistant add-label needs-more-information` Add a label (needs-more-information, problem in dependency, problem in custom component) to the issue.\n- `@home-assistant remove-label needs-more-information` Remove a label (needs-more-information, problem in dependency, problem in custom component) on the issue.\n\n</details>\n\n\n<sub><sup>(message by CodeOwnersMention)</sup></sub>\n\n---\n\n[alarm_control_panel documentation](https://www.home-assistant.io/integrations/alarm_control_panel)\n[alarm_control_panel source](https://github.com/home-assistant/core/tree/dev/homeassistant/components/alarm_control_panel)\n<sub><sup>(message by IssueLinks)</sup></sub>", "created_at": "2024-11-21T10:27:13Z"}
{"repo": "home-assistant/core", "pull_number": 131156, "instance_id": "home-assistant__core-131156", "issue_numbers": ["129618"], "base_commit": "afe986b39c082f37e8a37b3b25f263c36e32fa0e", "patch": "diff --git a/homeassistant/components/cast/strings.json b/homeassistant/components/cast/strings.json\nindex 12f2edeee9a982..9c49813bd830da 100644\n--- a/homeassistant/components/cast/strings.json\n+++ b/homeassistant/components/cast/strings.json\n@@ -53,7 +53,7 @@\n         },\n         \"view_path\": {\n           \"name\": \"View path\",\n-          \"description\": \"The path of the dashboard view to show.\"\n+          \"description\": \"The URL path of the dashboard view to show.\"\n         }\n       }\n     }\n", "test_patch": "", "problem_statement": "Cast: Add \"URL\" to description and names of \"View path\" and \"Dashboard path\" for consistency\n### The problem\r\n\r\nIn the description of \"View path\" the word \"URL\" is missing:\r\n\r\nhttps://github.com/home-assistant/core/blob/5900413c08e27a4402a0a24f64185d0269a8e8d2/homeassistant/components/cast/strings.json#L50-L56\r\n\r\nShould be\r\n\r\n     \"description\": \"The URL path of the dashboard view to show.\" \r\n\r\nas that field is just labelled \"URL\" in the dashboard editor UI:\r\n\r\n![image](https://github.com/user-attachments/assets/01bc73ad-afa6-4066-a385-d355dd235606)\r\n\r\n\r\n_Note:\r\nI stumbled over this a bit harder as the German translators had turned \"view path\" into \"viewing a path\" which made things even worse. I fixed that in Lokalise yesterday._\r\n\r\n### What version of Home Assistant Core has the issue?\r\n\r\n2024.11.0b1\r\n\r\n### What was the last working version of Home Assistant Core?\r\n\r\nn/a\r\n\r\n### What type of installation are you running?\r\n\r\nHome Assistant OS\r\n\r\n### Integration causing the issue\r\n\r\nhttps://rc.home-assistant.io/integrations/cast\r\n\r\n\n", "hints_text": "\nHey there @emontnemery, mind taking a look at this issue as it has been labeled with an integration (`cast`) you are listed as a [code owner](https://github.com/home-assistant/core/blob/dev/CODEOWNERS#L246) for? Thanks!\n\n<details>\n<summary>Code owner commands</summary>\n\n\nCode owners of `cast` can trigger bot actions by commenting:\n\n- `@home-assistant close` Closes the issue.\n- `@home-assistant rename Awesome new title` Renames the issue.\n- `@home-assistant reopen` Reopen the issue.\n- `@home-assistant unassign cast` Removes the current integration label and assignees on the issue, add the integration domain after the command.\n- `@home-assistant add-label needs-more-information` Add a label (needs-more-information, problem in dependency, problem in custom component) to the issue.\n- `@home-assistant remove-label needs-more-information` Remove a label (needs-more-information, problem in dependency, problem in custom component) on the issue.\n\n</details>\n\n\n<sub><sup>(message by CodeOwnersMention)</sup></sub>\n\n---\n\n[cast documentation](https://www.home-assistant.io/integrations/cast)\n[cast source](https://github.com/home-assistant/core/tree/dev/homeassistant/components/cast)\n<sub><sup>(message by IssueLinks)</sup></sub>", "created_at": "2024-11-21T10:13:41Z"}
{"repo": "home-assistant/core", "pull_number": 131154, "instance_id": "home-assistant__core-131154", "issue_numbers": ["128367"], "base_commit": "deb82cf072d324e87a35e6b9672faf1c89a88840", "patch": "diff --git a/homeassistant/components/xiaomi_miio/strings.json b/homeassistant/components/xiaomi_miio/strings.json\nindex 31fe547b1625bf..bafc1ec543b260 100644\n--- a/homeassistant/components/xiaomi_miio/strings.json\n+++ b/homeassistant/components/xiaomi_miio/strings.json\n@@ -216,22 +216,22 @@\n         \"name\": \"Air quality index\"\n       },\n       \"filter_life_remaining\": {\n-        \"name\": \"Filter lifetime remaining\"\n+        \"name\": \"Filter life remaining\"\n       },\n       \"filter_hours_used\": {\n         \"name\": \"Filter use\"\n       },\n       \"filter_left_time\": {\n-        \"name\": \"Filter lifetime left\"\n+        \"name\": \"Filter lifetime remaining\"\n       },\n       \"dust_filter_life_remaining\": {\n-        \"name\": \"Dust filter lifetime remaining\"\n+        \"name\": \"Dust filter life remaining\"\n       },\n       \"dust_filter_life_remaining_days\": {\n         \"name\": \"Dust filter lifetime remaining days\"\n       },\n       \"upper_filter_life_remaining\": {\n-        \"name\": \"Upper filter lifetime remaining\"\n+        \"name\": \"Upper filter life remaining\"\n       },\n       \"upper_filter_life_remaining_days\": {\n         \"name\": \"Upper filter lifetime remaining days\"\n@@ -276,16 +276,16 @@\n         \"name\": \"Total dust collection count\"\n       },\n       \"main_brush_left\": {\n-        \"name\": \"Main brush left\"\n+        \"name\": \"Main brush remaining\"\n       },\n       \"side_brush_left\": {\n-        \"name\": \"Side brush left\"\n+        \"name\": \"Side brush remaining\"\n       },\n       \"filter_left\": {\n-        \"name\": \"Filter left\"\n+        \"name\": \"Filter remaining\"\n       },\n       \"sensor_dirty_left\": {\n-        \"name\": \"Sensor dirty left\"\n+        \"name\": \"Sensor dirty remaining\"\n       }\n     },\n     \"switch\": {\n", "test_patch": "", "problem_statement": "Xiaomi Miio: Wrong naming of \"filter_life_remaining\" percentages as time spans\n### The problem\r\n\r\nThe following \"filter life\" variables don't show up as time spans but rather as percentages in the UI.\r\n\r\nSo these three lines need to be changed from \"lifetime\" to just \"life\":\r\n\r\nhttps://github.com/home-assistant/core/blob/cdb1b1df15c65ecee815d8a14bde574fa7b47cfd/homeassistant/components/xiaomi_miio/strings.json#L218-L219\r\n\r\nhttps://github.com/home-assistant/core/blob/cdb1b1df15c65ecee815d8a14bde574fa7b47cfd/homeassistant/components/xiaomi_miio/strings.json#L227-L228\r\n\r\nhttps://github.com/home-assistant/core/blob/cdb1b1df15c65ecee815d8a14bde574fa7b47cfd/homeassistant/components/xiaomi_miio/strings.json#L233-L234\r\n\r\nInterestingly the variables themselves are already named correctly as \"filter_life_remaining\".\r\n\r\nHere's an actual screenshot from my Xiaomi Air Purifier showing the wrong \"lifetime\" and the percentage in red.\r\nAs you can see there is a second entity that does in fact provide the time remaining (marked in green):\r\n\r\n![Screenshot 2024-10-14 15 29 05](https://github.com/user-attachments/assets/f3d9fe31-5735-4db8-852e-3ca5acf8cd91)\r\n\r\nThat one is correct and comes from here (just for reference):\r\n\r\nhttps://github.com/home-assistant/core/blob/cdb1b1df15c65ecee815d8a14bde574fa7b47cfd/homeassistant/components/xiaomi_miio/strings.json#L224-L225\r\n\r\n### What version of Home Assistant Core has the issue?\r\n\r\ncore-2024.10.2\r\n\r\n### What was the last working version of Home Assistant Core?\r\n\r\nn/a\r\n\r\n### What type of installation are you running?\r\n\r\nHome Assistant OS\r\n\r\n### Integration causing the issue\r\n\r\nXiaomi Miio\r\n\r\n### Link to integration documentation on our website\r\n\r\nhttps://www.home-assistant.io/integrations/xiaomi_miio/\r\n\n", "hints_text": "\nHey there @rytilahti, @syssi, @starkillerog, mind taking a look at this issue as it has been labeled with an integration (`xiaomi_miio`) you are listed as a [code owner](https://github.com/home-assistant/core/blob/dev/CODEOWNERS#L1687) for? Thanks!\n\n<details>\n<summary>Code owner commands</summary>\n\n\nCode owners of `xiaomi_miio` can trigger bot actions by commenting:\n\n- `@home-assistant close` Closes the issue.\n- `@home-assistant rename Awesome new title` Renames the issue.\n- `@home-assistant reopen` Reopen the issue.\n- `@home-assistant unassign xiaomi_miio` Removes the current integration label and assignees on the issue, add the integration domain after the command.\n- `@home-assistant add-label needs-more-information` Add a label (needs-more-information, problem in dependency, problem in custom component) to the issue.\n- `@home-assistant remove-label needs-more-information` Remove a label (needs-more-information, problem in dependency, problem in custom component) on the issue.\n\n</details>\n\n\n<sub><sup>(message by CodeOwnersMention)</sup></sub>\n\n---\n\n[xiaomi_miio documentation](https://www.home-assistant.io/integrations/xiaomi_miio)\n[xiaomi_miio source](https://github.com/home-assistant/core/tree/dev/homeassistant/components/xiaomi_miio)\n<sub><sup>(message by IssueLinks)</sup></sub>\nThere are four more strings that need clarification, too:\r\n\r\nhttps://github.com/home-assistant/core/blob/cdb1b1df15c65ecee815d8a14bde574fa7b47cfd/homeassistant/components/xiaomi_miio/strings.json#L278-L288\r\n\r\nThese are highly misleading, translators will most likely pick \"left\" as the opposite of \"right\" here.\r\nPlease change to \"remaining\" as in the strings in the initial bug report to remove this ambiguity.\r\nThat adds some very welcome consistency, too.\nAll sounds very reasonable.\r\nPlease make a PR where you change the strings.json names, you can tag me and I will review and can merge.", "created_at": "2024-11-21T09:49:44Z"}
{"repo": "home-assistant/core", "pull_number": 131151, "instance_id": "home-assistant__core-131151", "issue_numbers": ["129932"], "base_commit": "51e592f4507af17123b15d21ccbfcd05f05deece", "patch": "diff --git a/homeassistant/components/elkm1/strings.json b/homeassistant/components/elkm1/strings.json\nindex 6318231c281ad..bf02d7272800b 100644\n--- a/homeassistant/components/elkm1/strings.json\n+++ b/homeassistant/components/elkm1/strings.json\n@@ -68,7 +68,7 @@\n       }\n     },\n     \"alarm_arm_home_instant\": {\n-      \"name\": \"Alarm are home instant\",\n+      \"name\": \"Alarm arm home instant\",\n       \"description\": \"Arms the ElkM1 in home instant mode.\",\n       \"fields\": {\n         \"code\": {\n", "test_patch": "", "problem_statement": "Elk-M1 Control: Typo \"are\" instead of \"arm\"\n### The problem\r\n\r\nThere is a typo in this string:\r\n\r\nhttps://github.com/home-assistant/core/blob/2eb2bdd61558760439240205f448b6eb7befa252/homeassistant/components/elkm1/strings.json#L70-L71\r\n\r\nshould be \r\n\r\n    Alarm arm home instant\r\n\r\n\r\n\r\n### What version of Home Assistant Core has the issue?\r\n\r\n2024.11.0b7\r\n\r\n\r\n### What type of installation are you running?\r\n\r\nHome Assistant OS\r\n\r\n### Integration causing the issue\r\n\r\nElk-M1 Control\r\n\r\n### Link to integration documentation on our website\r\n\r\nhttps://www.home-assistant.io/integrations/elkm1/\r\n\r\n\n", "hints_text": "\nHey there @gwww, @bdraco, mind taking a look at this issue as it has been labeled with an integration (`elkm1`) you are listed as a [code owner](https://github.com/home-assistant/core/blob/dev/CODEOWNERS#L394) for? Thanks!\n\n<details>\n<summary>Code owner commands</summary>\n\n\nCode owners of `elkm1` can trigger bot actions by commenting:\n\n- `@home-assistant close` Closes the issue.\n- `@home-assistant rename Awesome new title` Renames the issue.\n- `@home-assistant reopen` Reopen the issue.\n- `@home-assistant unassign elkm1` Removes the current integration label and assignees on the issue, add the integration domain after the command.\n- `@home-assistant add-label needs-more-information` Add a label (needs-more-information, problem in dependency, problem in custom component) to the issue.\n- `@home-assistant remove-label needs-more-information` Remove a label (needs-more-information, problem in dependency, problem in custom component) on the issue.\n\n</details>\n\n\n<sub><sup>(message by CodeOwnersMention)</sup></sub>\n\n---\n\n[elkm1 documentation](https://www.home-assistant.io/integrations/elkm1)\n[elkm1 source](https://github.com/home-assistant/core/tree/dev/homeassistant/components/elkm1)\n<sub><sup>(message by IssueLinks)</sup></sub>\n@joostlek I see that this bug was addressed in https://github.com/home-assistant/core/pull/129962 but hasn't landed in Lokalise, yet.\r\n\r\nCan you check what went wrong? The PR is locked so I cannot comment there.\nThe PR was closed, not merged. No clue why the author closed it\nOK, then I just create a new one for that one letter fix. \ud83d\ude04 ", "created_at": "2024-11-21T09:19:13Z"}
{"repo": "home-assistant/core", "pull_number": 131150, "instance_id": "home-assistant__core-131150", "issue_numbers": ["129054"], "base_commit": "27695095dd2deda7798251495cbad78d6ec4ca2b", "patch": "diff --git a/homeassistant/components/group/strings.json b/homeassistant/components/group/strings.json\nindex dbb6fb01f7b0c..cf694af0d98ad 100644\n--- a/homeassistant/components/group/strings.json\n+++ b/homeassistant/components/group/strings.json\n@@ -3,7 +3,7 @@\n   \"config\": {\n     \"step\": {\n       \"user\": {\n-        \"title\": \"Add Group\",\n+        \"title\": \"Create Group\",\n         \"description\": \"Groups allow you to create a new entity that represents multiple entities of the same type.\",\n         \"menu_options\": {\n           \"binary_sensor\": \"Binary sensor group\",\n@@ -283,20 +283,20 @@\n   },\n   \"issues\": {\n     \"uoms_not_matching_device_class\": {\n-      \"title\": \"Unit of measurements are not correct\",\n-      \"description\": \"Unit of measurements `{uoms}` of input sensors `{source_entities}` are not compatible and can't be converted with the device class `{device_class}` of sensor group `{entity_id}`.\\n\\nPlease correct the unit of measurements on the source entities and reload the group sensor to fix this issue.\"\n+      \"title\": \"Units of measurement are not correct\",\n+      \"description\": \"Units of measurement `{uoms}` of input sensors `{source_entities}` are not compatible and can't be converted with the device class `{device_class}` of sensor group `{entity_id}`.\\n\\nPlease correct the unit of measurement on the source entities and reload the group sensor to fix this issue.\"\n     },\n     \"uoms_not_matching_no_device_class\": {\n-      \"title\": \"Unit of measurements is not correct\",\n-      \"description\": \"Unit of measurements `{uoms}` of input sensors `{source_entities}` are not compatible when not using a device class on sensor group `{entity_id}`.\\n\\nPlease correct the unit of measurements on the source entities or set a proper device class on the sensor group and reload the group sensor to fix this issue.\"\n+      \"title\": \"Units of measurement are not correct\",\n+      \"description\": \"Units of measurement `{uoms}` of input sensors `{source_entities}` are not compatible when not using a device class on sensor group `{entity_id}`.\\n\\nPlease correct the unit of measurement on the source entities or set a proper device class on the sensor group and reload the group sensor to fix this issue.\"\n     },\n     \"device_classes_not_matching\": {\n-      \"title\": \"Device classes is not correct\",\n-      \"description\": \"Device classes `{device_classes}` on source entities `{source_entities}` needs to be same for sensor group `{entity_id}`.\\n\\nPlease correct the device classes on the source entities and reload the group sensor to fix this issue.\"\n+      \"title\": \"Device classes are not correct\",\n+      \"description\": \"Device classes `{device_classes}` on source entities `{source_entities}` need to be identical for sensor group `{entity_id}`.\\n\\nPlease correct the device classes on the source entities and reload the group sensor to fix this issue.\"\n     },\n     \"state_classes_not_matching\": {\n-      \"title\": \"State classes is not correct\",\n-      \"description\": \"State classes `{state_classes}` on source entities `{source_entities}` needs to be same for sensor group `{entity_id}`.\\n\\nPlease correct the state classes on the source entities and reload the group sensor to fix this issue.\"\n+      \"title\": \"State classes are not correct\",\n+      \"description\": \"State classes `{state_classes}` on source entities `{source_entities}` need to be identical for sensor group `{entity_id}`.\\n\\nPlease correct the state classes on the source entities and reload the group sensor to fix this issue.\"\n     }\n   }\n }\n", "test_patch": "", "problem_statement": "Groups: Broken grammar in several issues strings, room for improving the details\n### The problem\r\n\r\nRepair messages for group sensors contain several grammar bugs. Here just two I was able to trigger easily:\r\n\r\n![Screenshot 2024-10-23 22 16 55](https://github.com/user-attachments/assets/9db71322-01d4-44cc-bc01-fa45625b63ca)\r\n\r\nFirst of all the correct term to use is found here:\r\n\r\nhttps://github.com/home-assistant/core/blob/6ee6a8a74fa1542f3cae532b4c893a60bc62df04/homeassistant/components/group/strings.json#L107\r\n\r\nBelow almost all strings have broken grammar in English and are in need of a makeover:\r\n\r\nhttps://github.com/home-assistant/core/blob/6ee6a8a74fa1542f3cae532b4c893a60bc62df04/homeassistant/components/group/strings.json#L284-L302\r\n\r\nShould be\r\n\r\n      Units of measurement are not correct\r\n      Unit of measurement is not correct\r\n      Device classes are not correct\r\n      State classes are not correct\r\n\r\nIn the explanations correct all occurrences of \"unit of measurements\" to \"units of measurement\"  or \"unit of measurement\" (depending on the \"are\" or \"is\" that follows).\r\n\r\nAnd have a good look over the rest of the wording, I think there is room for improvement, too.\r\n\r\n### What version of Home Assistant Core has the issue?\r\n\r\n2024.10.3\r\n\r\n\r\n\n", "hints_text": "\nHey there @home-assistant/core, mind taking a look at this issue as it has been labeled with an integration (`group`) you are listed as a [code owner](https://github.com/home-assistant/core/blob/dev/CODEOWNERS#L585) for? Thanks!\n\n<details>\n<summary>Code owner commands</summary>\n\n\nCode owners of `group` can trigger bot actions by commenting:\n\n- `@home-assistant close` Closes the issue.\n- `@home-assistant rename Awesome new title` Renames the issue.\n- `@home-assistant reopen` Reopen the issue.\n- `@home-assistant unassign group` Removes the current integration label and assignees on the issue, add the integration domain after the command.\n- `@home-assistant add-label needs-more-information` Add a label (needs-more-information, problem in dependency, problem in custom component) to the issue.\n- `@home-assistant remove-label needs-more-information` Remove a label (needs-more-information, problem in dependency, problem in custom component) on the issue.\n\n</details>\n\n\n<sub><sup>(message by CodeOwnersMention)</sup></sub>\n\n---\n\n[group documentation](https://www.home-assistant.io/integrations/group)\n[group source](https://github.com/home-assistant/core/tree/dev/homeassistant/components/group)\n<sub><sup>(message by IssueLinks)</sup></sub>", "created_at": "2024-11-21T08:59:01Z"}
{"repo": "home-assistant/core", "pull_number": 131129, "instance_id": "home-assistant__core-131129", "issue_numbers": ["128528", "128528"], "base_commit": "b8e0d928485fd6784d1fd7579a1df0a74ec5fd78", "patch": "diff --git a/homeassistant/components/lutron_caseta/manifest.json b/homeassistant/components/lutron_caseta/manifest.json\nindex e96778f0a31a7..ec27861574331 100644\n--- a/homeassistant/components/lutron_caseta/manifest.json\n+++ b/homeassistant/components/lutron_caseta/manifest.json\n@@ -9,7 +9,7 @@\n   },\n   \"iot_class\": \"local_push\",\n   \"loggers\": [\"pylutron_caseta\"],\n-  \"requirements\": [\"pylutron-caseta==0.21.1\"],\n+  \"requirements\": [\"pylutron-caseta==0.22.0\"],\n   \"zeroconf\": [\n     {\n       \"type\": \"_lutron._tcp.local.\",\ndiff --git a/requirements_all.txt b/requirements_all.txt\nindex 6868e58e2e5c0..42d7dc1a0ca8b 100644\n--- a/requirements_all.txt\n+++ b/requirements_all.txt\n@@ -2048,7 +2048,7 @@ pylitejet==0.6.3\n pylitterbot==2023.5.0\n \n # homeassistant.components.lutron_caseta\n-pylutron-caseta==0.21.1\n+pylutron-caseta==0.22.0\n \n # homeassistant.components.lutron\n pylutron==0.2.16\n", "test_patch": "diff --git a/requirements_test_all.txt b/requirements_test_all.txt\nindex 4099ae34896b5..7917023545e1d 100644\n--- a/requirements_test_all.txt\n+++ b/requirements_test_all.txt\n@@ -1653,7 +1653,7 @@ pylitejet==0.6.3\n pylitterbot==2023.5.0\n \n # homeassistant.components.lutron_caseta\n-pylutron-caseta==0.21.1\n+pylutron-caseta==0.22.0\n \n # homeassistant.components.lutron\n pylutron==0.2.16\n", "problem_statement": "Update requirements to add support for Lutron Triathlon Essentials shades\n### The problem\r\n\r\nLutron's Triathalon Essentials roller shades don't work with Home Assistant out of box. Support upstream was added with a trivial patch to `pylutron-caseta v0.22.0` (literally only the product name was added to an array). \r\n\r\nhttps://github.com/home-assistant/core/blob/15fc4a8ae4ade17200bf490841b339dcbb249d4b/homeassistant/components/lutron_caseta/manifest.json#L12\r\n\r\n### What version of Home Assistant Core has the issue?\r\n\r\ncore-2024.10.2\r\n\r\n### What was the last working version of Home Assistant Core?\r\n\r\n_No response_\r\n\r\n### What type of installation are you running?\r\n\r\nHome Assistant OS\r\n\r\n### Integration causing the issue\r\n\r\nlutron_caseta\r\n\r\n### Link to integration documentation on our website\r\n\r\nhttps://www.home-assistant.io/integrations/lutron_caseta\r\n\r\n### Diagnostics information\r\n\r\n_No response_\r\n\r\n### Example YAML snippet\r\n\r\n_No response_\r\n\r\n### Anything in the logs that might be useful for us?\r\n\r\n_No response_\r\n\r\n### Additional information\r\n\r\nCurrently users can open a terminal on home assistant and upgrade pylutron-caseta, followed by restarting home assistant:\r\n\r\n```\r\ndocker exec -it homeassistant sed -i 's/\"pylutron-caseta==0.21.1\"/\"pylutron-caseta==0.22.0\"/' /usr/src/homeassistant/homeassistant/components/lutron_caseta/manifest.json\r\n```\nUpdate requirements to add support for Lutron Triathlon Essentials shades\n### The problem\r\n\r\nLutron's Triathalon Essentials roller shades don't work with Home Assistant out of box. Support upstream was added with a trivial patch to `pylutron-caseta v0.22.0` (literally only the product name was added to an array). \r\n\r\nhttps://github.com/home-assistant/core/blob/15fc4a8ae4ade17200bf490841b339dcbb249d4b/homeassistant/components/lutron_caseta/manifest.json#L12\r\n\r\n### What version of Home Assistant Core has the issue?\r\n\r\ncore-2024.10.2\r\n\r\n### What was the last working version of Home Assistant Core?\r\n\r\n_No response_\r\n\r\n### What type of installation are you running?\r\n\r\nHome Assistant OS\r\n\r\n### Integration causing the issue\r\n\r\nlutron_caseta\r\n\r\n### Link to integration documentation on our website\r\n\r\nhttps://www.home-assistant.io/integrations/lutron_caseta\r\n\r\n### Diagnostics information\r\n\r\n_No response_\r\n\r\n### Example YAML snippet\r\n\r\n_No response_\r\n\r\n### Anything in the logs that might be useful for us?\r\n\r\n_No response_\r\n\r\n### Additional information\r\n\r\nCurrently users can open a terminal on home assistant and upgrade pylutron-caseta, followed by restarting home assistant:\r\n\r\n```\r\ndocker exec -it homeassistant sed -i 's/\"pylutron-caseta==0.21.1\"/\"pylutron-caseta==0.22.0\"/' /usr/src/homeassistant/homeassistant/components/lutron_caseta/manifest.json\r\n```\n", "hints_text": "\nHey there @swails, @danaues, @eclair4151, mind taking a look at this issue as it has been labeled with an integration (`lutron_caseta`) you are listed as a [code owner](https://github.com/home-assistant/core/blob/dev/CODEOWNERS#L866) for? Thanks!\n\n<details>\n<summary>Code owner commands</summary>\n\n\nCode owners of `lutron_caseta` can trigger bot actions by commenting:\n\n- `@home-assistant close` Closes the issue.\n- `@home-assistant rename Awesome new title` Renames the issue.\n- `@home-assistant reopen` Reopen the issue.\n- `@home-assistant unassign lutron_caseta` Removes the current integration label and assignees on the issue, add the integration domain after the command.\n- `@home-assistant add-label needs-more-information` Add a label (needs-more-information, problem in dependency, problem in custom component) to the issue.\n- `@home-assistant remove-label needs-more-information` Remove a label (needs-more-information, problem in dependency, problem in custom component) on the issue.\n\n</details>\n\n\n<sub><sup>(message by CodeOwnersMention)</sup></sub>\n\n---\n\n[lutron_caseta documentation](https://www.home-assistant.io/integrations/lutron_caseta)\n[lutron_caseta source](https://github.com/home-assistant/core/tree/dev/homeassistant/components/lutron_caseta)\n<sub><sup>(message by IssueLinks)</sup></sub>\n\nHey there @swails, @danaues, @eclair4151, mind taking a look at this issue as it has been labeled with an integration (`lutron_caseta`) you are listed as a [code owner](https://github.com/home-assistant/core/blob/dev/CODEOWNERS#L866) for? Thanks!\n\n<details>\n<summary>Code owner commands</summary>\n\n\nCode owners of `lutron_caseta` can trigger bot actions by commenting:\n\n- `@home-assistant close` Closes the issue.\n- `@home-assistant rename Awesome new title` Renames the issue.\n- `@home-assistant reopen` Reopen the issue.\n- `@home-assistant unassign lutron_caseta` Removes the current integration label and assignees on the issue, add the integration domain after the command.\n- `@home-assistant add-label needs-more-information` Add a label (needs-more-information, problem in dependency, problem in custom component) to the issue.\n- `@home-assistant remove-label needs-more-information` Remove a label (needs-more-information, problem in dependency, problem in custom component) on the issue.\n\n</details>\n\n\n<sub><sup>(message by CodeOwnersMention)</sup></sub>\n\n---\n\n[lutron_caseta documentation](https://www.home-assistant.io/integrations/lutron_caseta)\n[lutron_caseta source](https://github.com/home-assistant/core/tree/dev/homeassistant/components/lutron_caseta)\n<sub><sup>(message by IssueLinks)</sup></sub>", "created_at": "2024-11-21T01:39:55Z"}
{"repo": "home-assistant/core", "pull_number": 131115, "instance_id": "home-assistant__core-131115", "issue_numbers": ["124717"], "base_commit": "d03fc71bfb75bd05dc2db7797baa288789aae47c", "patch": "diff --git a/homeassistant/components/unifiprotect/number.py b/homeassistant/components/unifiprotect/number.py\nindex f6aacf81161107..767128337badd3 100644\n--- a/homeassistant/components/unifiprotect/number.py\n+++ b/homeassistant/components/unifiprotect/number.py\n@@ -124,7 +124,7 @@ def _get_chime_duration(obj: Camera) -> int:\n         name=\"Infrared custom lux trigger\",\n         icon=\"mdi:white-balance-sunny\",\n         entity_category=EntityCategory.CONFIG,\n-        ufp_min=1,\n+        ufp_min=0,\n         ufp_max=30,\n         ufp_step=1,\n         ufp_required_field=\"feature_flags.has_led_ir\",\n", "test_patch": "", "problem_statement": "Exception while running subscription handler\n### The problem\r\n\r\nI have since at least the 2024.8 release the follwing 3 ERROR messages in my error log;\r\n\r\n\r\n`Logger: uiprotect.api\r\nBron: /usr/local/lib/python3.12/site-packages/uiprotect/api.py:862\r\nEerst voorgekomen: 16:31:58 (10 gebeurtenissen)\r\nLaatst gelogd: 16:51:45\r\n\r\nException while running subscription handler\r\nTraceback (most recent call last):\r\n  File \"/usr/local/lib/python3.12/site-packages/uiprotect/api.py\", line 860, in emit_message\r\n    sub(msg)\r\n  File \"/usr/src/homeassistant/homeassistant/components/unifiprotect/data.py\", line 295, in _async_process_ws_message\r\n    self._async_update_device(new_obj, message.changed_data)\r\n  File \"/usr/src/homeassistant/homeassistant/components/unifiprotect/data.py\", line 232, in _async_update_device\r\n    self._async_signal_device_update(device)\r\n  File \"/usr/src/homeassistant/homeassistant/components/unifiprotect/data.py\", line 339, in _async_signal_device_update\r\n    update_callback(device)\r\n  File \"/usr/src/homeassistant/homeassistant/components/unifiprotect/entity.py\", line 226, in _async_updated_event\r\n    self._async_update_device_from_protect(device)\r\n  File \"/usr/src/homeassistant/homeassistant/components/unifiprotect/number.py\", line 272, in _async_update_device_from_protect\r\n    self._attr_native_value = self.entity_description.get_ufp_value(self.device)\r\n                              ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/local/lib/python3.12/site-packages/uiprotect/data/devices.py\", line 1155, in icr_lux_display\r\n    return LUX_MAPPING_VALUES[10 - self.isp_settings.icr_custom_value]\r\n           ~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\nIndexError: list index out of range`\r\n\r\n\r\n\r\nnext to this one;\r\n\r\n\r\n`Logger: homeassistant\r\nBron: components/unifiprotect/number.py:272\r\nEerst voorgekomen: 15:35:14 (6 gebeurtenissen)\r\nLaatst gelogd: 16:50:14\r\n\r\nError doing job: Task exception was never retrieved (None)\r\nTraceback (most recent call last):\r\n  File \"/usr/src/homeassistant/homeassistant/components/unifiprotect/data.py\", line 195, in async_refresh\r\n    self._async_update_change(True, force_update=True)\r\n  File \"/usr/src/homeassistant/homeassistant/components/unifiprotect/data.py\", line 170, in _async_update_change\r\n    self._async_process_updates()\r\n  File \"/usr/src/homeassistant/homeassistant/components/unifiprotect/data.py\", line 302, in _async_process_updates\r\n    self._async_signal_device_update(device)\r\n  File \"/usr/src/homeassistant/homeassistant/components/unifiprotect/data.py\", line 339, in _async_signal_device_update\r\n    update_callback(device)\r\n  File \"/usr/src/homeassistant/homeassistant/components/unifiprotect/entity.py\", line 226, in _async_updated_event\r\n    self._async_update_device_from_protect(device)\r\n  File \"/usr/src/homeassistant/homeassistant/components/unifiprotect/number.py\", line 272, in _async_update_device_from_protect\r\n    self._attr_native_value = self.entity_description.get_ufp_value(self.device)\r\n                              ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/local/lib/python3.12/site-packages/uiprotect/data/devices.py\", line 1155, in icr_lux_display\r\n    return LUX_MAPPING_VALUES[10 - self.isp_settings.icr_custom_value]\r\n           ~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\nIndexError: list index out of range`\r\n\r\nAND THIS, WHICH LOOK LIKE RELATED;\r\n\r\n\r\nLogger: homeassistant.components.number\r\nBron: helpers/entity_platform.py:598\r\nintegratie: Nummer ([documentatie](https://www.home-assistant.io/integrations/number), [problemen](https://github.com/home-assistant/core/issues?q=is%3Aissue+is%3Aopen+label%3A%22integration%3A+number%22))\r\nEerst voorgekomen: 15:20:17 (1 gebeurtenissen)\r\nLaatst gelogd: 15:20:17\r\n\r\nError adding entity number.woonkamer_infrared_custom_lux_trigger for domain number with platform unifiprotect\r\nTraceback (most recent call last):\r\n  File \"/usr/src/homeassistant/homeassistant/helpers/entity_platform.py\", line 598, in _async_add_entities\r\n    await coro\r\n  File \"/usr/src/homeassistant/homeassistant/helpers/entity_platform.py\", line 912, in _async_add_entity\r\n    await entity.add_to_platform_finish()\r\n  File \"/usr/src/homeassistant/homeassistant/helpers/entity.py\", line 1365, in add_to_platform_finish\r\n    await self.async_added_to_hass()\r\n  File \"/usr/src/homeassistant/homeassistant/components/unifiprotect/entity.py\", line 254, in async_added_to_hass\r\n    self._async_update_device_from_protect(self.device)\r\n  File \"/usr/src/homeassistant/homeassistant/components/unifiprotect/number.py\", line 272, in _async_update_device_from_protect\r\n    self._attr_native_value = self.entity_description.get_ufp_value(self.device)\r\n                              ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/local/lib/python3.12/site-packages/uiprotect/data/devices.py\", line 1155, in icr_lux_display\r\n    return LUX_MAPPING_VALUES[10 - self.isp_settings.icr_custom_value]\r\n           ~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\nIndexError: list index out of range\r\n\r\nAlso tried removing and reinstalling/setting up the the integration, but this does not resolve.\r\n\r\n### What version of Home Assistant Core has the issue?\r\n\r\n2024.8\r\n\r\n### What was the last working version of Home Assistant Core?\r\n\r\n2024.6\r\n\r\n### What type of installation are you running?\r\n\r\nHome Assistant OS\r\n\r\n### Integration causing the issue\r\n\r\nunifi protect\r\n\r\n### Link to integration documentation on our website\r\n\r\n_No response_\r\n\r\n### Diagnostics information\r\n\r\n_No response_\r\n\r\n### Example YAML snippet\r\n\r\n_No response_\r\n\r\n### Anything in the logs that might be useful for us?\r\n\r\n_No response_\r\n\r\n### Additional information\r\n\r\n_No response_\n", "hints_text": "[unifiprotect documentation](https://www.home-assistant.io/integrations/unifiprotect)\n[unifiprotect source](https://github.com/home-assistant/core/tree/dev/homeassistant/components/unifiprotect)", "created_at": "2024-11-20T22:25:11Z"}
{"repo": "home-assistant/core", "pull_number": 131095, "instance_id": "home-assistant__core-131095", "issue_numbers": ["130033"], "base_commit": "e6225e3dcc0cb2c99128e27313c1e136f39d4d88", "patch": "diff --git a/homeassistant/components/device_tracker/strings.json b/homeassistant/components/device_tracker/strings.json\nindex d6e36d92300022..294333a5d8068c 100644\n--- a/homeassistant/components/device_tracker/strings.json\n+++ b/homeassistant/components/device_tracker/strings.json\n@@ -48,7 +48,7 @@\n   \"services\": {\n     \"see\": {\n       \"name\": \"See\",\n-      \"description\": \"Records a seen tracked device.\",\n+      \"description\": \"Manually update the records of a seen legacy device tracker in the known_devices.yaml file.\",\n       \"fields\": {\n         \"mac\": {\n           \"name\": \"MAC address\",\n", "test_patch": "", "problem_statement": "Device Tracker: UI description of 'see' action impossible to understand\n### The problem\n\nWhen you select the 'See' action for Device Trackers the UI currently explains it this way:\r\n\r\n![image](https://github.com/user-attachments/assets/71f9aef4-eadb-4240-9da6-15162c15d733)\r\n\r\nThis is really close to impossible to understand. It should match the explanation given in the online docs\r\n\r\n    The device_tracker.see action can be used to manually update the state of a device tracker.\r\n\r\nSo rephrase this\r\n\r\nhttps://github.com/home-assistant/core/blob/a3ba7803db895b5e083c7f7d84fd3bb0e70bad25/homeassistant/components/device_tracker/strings.json#L51\r\n\r\nto read\r\n\r\n    Manually update the records of a device tracker that you have seen.\r\n\r\nCorrect me if that's wrong, any help in properly translating this helps.\r\nEspecially why it's called \"see\" \u2026\n\n### What version of Home Assistant Core has the issue?\n\ncore-2024.11.0\n\n### What was the last working version of Home Assistant Core?\n\n_No response_\n\n### What type of installation are you running?\n\nHome Assistant OS\n\n### Integration causing the issue\n\nDevice tracker\n\n### Link to integration documentation on our website\n\nhttps://www.home-assistant.io/integrations/device_tracker\n\n### Diagnostics information\n\n_No response_\n\n### Example YAML snippet\n\n_No response_\n\n### Anything in the logs that might be useful for us?\n\n_No response_\n\n### Additional information\n\n_No response_\n", "hints_text": "\nHey there @home-assistant/core, mind taking a look at this issue as it has been labeled with an integration (`device_tracker`) you are listed as a [code owner](https://github.com/home-assistant/core/blob/dev/CODEOWNERS#L323) for? Thanks!\n\n<details>\n<summary>Code owner commands</summary>\n\n\nCode owners of `device_tracker` can trigger bot actions by commenting:\n\n- `@home-assistant close` Closes the issue.\n- `@home-assistant rename Awesome new title` Renames the issue.\n- `@home-assistant reopen` Reopen the issue.\n- `@home-assistant unassign device_tracker` Removes the current integration label and assignees on the issue, add the integration domain after the command.\n- `@home-assistant add-label needs-more-information` Add a label (needs-more-information, problem in dependency, problem in custom component) to the issue.\n- `@home-assistant remove-label needs-more-information` Remove a label (needs-more-information, problem in dependency, problem in custom component) on the issue.\n\n</details>\n\n\n<sub><sup>(message by CodeOwnersMention)</sup></sub>\n\n---\n\n[device_tracker documentation](https://www.home-assistant.io/integrations/device_tracker)\n[device_tracker source](https://github.com/home-assistant/core/tree/dev/homeassistant/components/device_tracker)\n<sub><sup>(message by IssueLinks)</sup></sub>", "created_at": "2024-11-20T20:33:33Z"}
{"repo": "home-assistant/core", "pull_number": 131092, "instance_id": "home-assistant__core-131092", "issue_numbers": ["130153"], "base_commit": "e6225e3dcc0cb2c99128e27313c1e136f39d4d88", "patch": "diff --git a/homeassistant/components/random/strings.json b/homeassistant/components/random/strings.json\nindex ef19dd6dd670e0..ff44290d36821c 100644\n--- a/homeassistant/components/random/strings.json\n+++ b/homeassistant/components/random/strings.json\n@@ -20,7 +20,7 @@\n         \"title\": \"Random sensor\"\n       },\n       \"user\": {\n-        \"description\": \"This helper allows you to create a helper that emits a random value.\",\n+        \"description\": \"This helper allows you to create an entity that emits a random value.\",\n         \"menu_options\": {\n           \"binary_sensor\": \"Random binary sensor\",\n           \"sensor\": \"Random sensor\"\n", "test_patch": "", "problem_statement": "Random Helper: Better explanation avoiding a useless repetition\n### The problem\r\n\r\nWhen creating a Random Helper the user is presented with the \"explanation\" that this helper creates a helper \u2026:\r\n\r\n![image](https://github.com/user-attachments/assets/797ddfe0-004b-4120-ae4d-5eb3d518a469)\r\n\r\n\r\nhttps://github.com/home-assistant/core/blob/2dc81ed866d2437dc2454cb73031a7eb2f00d762/homeassistant/components/random/strings.json#L23\r\n\r\nThis should at least be changed to\r\n\r\n`This helper allows you to create a sensor entity that emits a random value.\r\n`\r\n\r\nEven better addressing the choice to be made in the next step:\r\n\r\n`This helper allows you to create a sensor entity that emits a random value. This can be either just binary or a number within a specified minimum to maximum range.`\r\n\r\n\r\n\r\n### What version of Home Assistant Core has the issue?\r\n\r\ncore-2024.11.0\r\n\r\n### What type of installation are you running?\r\n\r\nHome Assistant OS\r\n\r\n### Integration causing the issue\r\n\r\nRandom\r\n\r\n### Link to integration documentation on our website\r\n\r\nhttps://www.home-assistant.io/integrations/random/\r\n\n", "hints_text": "\nHey there @fabaff, mind taking a look at this issue as it has been labeled with an integration (`random`) you are listed as a [code owner](https://github.com/home-assistant/core/blob/dev/CODEOWNERS#L1202) for? Thanks!\n\n<details>\n<summary>Code owner commands</summary>\n\n\nCode owners of `random` can trigger bot actions by commenting:\n\n- `@home-assistant close` Closes the issue.\n- `@home-assistant rename Awesome new title` Renames the issue.\n- `@home-assistant reopen` Reopen the issue.\n- `@home-assistant unassign random` Removes the current integration label and assignees on the issue, add the integration domain after the command.\n- `@home-assistant add-label needs-more-information` Add a label (needs-more-information, problem in dependency, problem in custom component) to the issue.\n- `@home-assistant remove-label needs-more-information` Remove a label (needs-more-information, problem in dependency, problem in custom component) on the issue.\n\n</details>\n\n\n<sub><sup>(message by CodeOwnersMention)</sup></sub>\n\n---\n\n[random documentation](https://www.home-assistant.io/integrations/random)\n[random source](https://github.com/home-assistant/core/tree/dev/homeassistant/components/random)\n<sub><sup>(message by IssueLinks)</sup></sub>\n> `This helper allows you to create a sensor entity that emits a random value` \r\n\r\nMeh, when we have a binary sensor and sensor, we don't combine that to say sensors. (as in, 1 A + 1 AB != 2A). We would rather say `entity` here.\r\n\r\n> his helper allows you to create a sensor entity that emits a random value. This can be either just binary or a number within a specified minimum to maximum range.\r\n\r\nWe could add a description to the individual pages\n@joostlek OK, so then just\r\n\r\n     This helper allows you to create an entity that emits a random value.\r\n\r\nright?\r\n", "created_at": "2024-11-20T20:24:34Z"}
{"repo": "home-assistant/core", "pull_number": 131089, "instance_id": "home-assistant__core-131089", "issue_numbers": ["129815"], "base_commit": "e6225e3dcc0cb2c99128e27313c1e136f39d4d88", "patch": "diff --git a/homeassistant/components/input_number/strings.json b/homeassistant/components/input_number/strings.json\nindex 8a2351ebad46b4..ed6b6fad2081da 100644\n--- a/homeassistant/components/input_number/strings.json\n+++ b/homeassistant/components/input_number/strings.json\n@@ -41,7 +41,7 @@\n     },\n     \"increment\": {\n       \"name\": \"Increment\",\n-      \"description\": \"Increments the value by 1 step.\"\n+      \"description\": \"Increments the current value by 1 step.\"\n     },\n     \"set_value\": {\n       \"name\": \"Set\",\n", "test_patch": "", "problem_statement": "Input number: Inconsistent descriptions of increase and decrease actions\n### The problem\r\n\r\nThere is a small inconsistency between these two that causes irritation in the UI:\r\n\r\nhttps://github.com/home-assistant/core/blob/365f8046ace7a4d7aa401fcf0aba54dd8347f3e3/homeassistant/components/input_number/strings.json#L37-L45\r\n\r\nThe latter should also contain \"current\":\r\n\r\n    Increments the current value by 1 step.\r\n\r\n\r\nJust a very small issue but when reviewing your translation work it keeps raising the error flag every time you notice it in the UI.\r\n\r\n### What version of Home Assistant Core has the issue?\r\n\r\n2024.11.0b3\r\n\r\n\r\n### What type of installation are you running?\r\n\r\nHome Assistant OS\r\n\r\n### Integration causing the issue\r\n\r\nInput number\r\n\r\n### Link to integration documentation on our website\r\n\r\nhttps://www.home-assistant.io/integrations/input_number/\r\n\r\n\n", "hints_text": "\nHey there @home-assistant/core, mind taking a look at this issue as it has been labeled with an integration (`input_number`) you are listed as a [code owner](https://github.com/home-assistant/core/blob/dev/CODEOWNERS#L709) for? Thanks!\n\n<details>\n<summary>Code owner commands</summary>\n\n\nCode owners of `input_number` can trigger bot actions by commenting:\n\n- `@home-assistant close` Closes the issue.\n- `@home-assistant rename Awesome new title` Renames the issue.\n- `@home-assistant reopen` Reopen the issue.\n- `@home-assistant unassign input_number` Removes the current integration label and assignees on the issue, add the integration domain after the command.\n- `@home-assistant add-label needs-more-information` Add a label (needs-more-information, problem in dependency, problem in custom component) to the issue.\n- `@home-assistant remove-label needs-more-information` Remove a label (needs-more-information, problem in dependency, problem in custom component) on the issue.\n\n</details>\n\n\n<sub><sup>(message by CodeOwnersMention)</sup></sub>\n\n---\n\n[input_number documentation](https://www.home-assistant.io/integrations/input_number)\n[input_number source](https://github.com/home-assistant/core/tree/dev/homeassistant/components/input_number)\n<sub><sup>(message by IssueLinks)</sup></sub>", "created_at": "2024-11-20T20:16:35Z"}
{"repo": "home-assistant/core", "pull_number": 131088, "instance_id": "home-assistant__core-131088", "issue_numbers": ["130816"], "base_commit": "e6225e3dcc0cb2c99128e27313c1e136f39d4d88", "patch": "diff --git a/homeassistant/components/touchline_sl/manifest.json b/homeassistant/components/touchline_sl/manifest.json\nindex 063f772658715b..ca3136f55c05c2 100644\n--- a/homeassistant/components/touchline_sl/manifest.json\n+++ b/homeassistant/components/touchline_sl/manifest.json\n@@ -6,5 +6,5 @@\n   \"documentation\": \"https://www.home-assistant.io/integrations/touchline_sl\",\n   \"integration_type\": \"hub\",\n   \"iot_class\": \"cloud_polling\",\n-  \"requirements\": [\"pytouchlinesl==0.1.9\"]\n+  \"requirements\": [\"pytouchlinesl==0.2.0\"]\n }\ndiff --git a/requirements_all.txt b/requirements_all.txt\nindex 9bcc9f0515b654..af9a1c8e1510fe 100644\n--- a/requirements_all.txt\n+++ b/requirements_all.txt\n@@ -2435,7 +2435,7 @@ pytomorrowio==0.3.6\n pytouchline==0.7\n \n # homeassistant.components.touchline_sl\n-pytouchlinesl==0.1.9\n+pytouchlinesl==0.2.0\n \n # homeassistant.components.traccar\n # homeassistant.components.traccar_server\n", "test_patch": "diff --git a/requirements_test_all.txt b/requirements_test_all.txt\nindex 8a0841903f34ab..a099c96d38e3d0 100644\n--- a/requirements_test_all.txt\n+++ b/requirements_test_all.txt\n@@ -1947,7 +1947,7 @@ pytile==2023.12.0\n pytomorrowio==0.3.6\n \n # homeassistant.components.touchline_sl\n-pytouchlinesl==0.1.9\n+pytouchlinesl==0.2.0\n \n # homeassistant.components.traccar\n # homeassistant.components.traccar_server\n", "problem_statement": "Unexpected error fetching Touchline SL (\u2026\u2026) data\n### The problem\r\n\r\nwhen a thermostat is out with a dead battery. Then integration fails. Will it be possible to correct integration so that the sensors that are available work even if a sensor is not available.\r\n\r\n\r\nLogger: homeassistant.components.touchline_sl.coordinator\r\nSource: helpers/update_coordinator.py:382\r\nintegration: Roth Touchline SL (documentation, issues)\r\nFirst occurred: 14:56:41 (8 occurrences)\r\nLast logged: 15:06:18\r\n\r\nUnexpected error fetching Touchline SL (Gulvvarme hjemme) data\r\nTraceback (most recent call last):\r\n  File \"/usr/src/homeassistant/homeassistant/helpers/update_coordinator.py\", line 382, in _async_refresh\r\n    self.data = await self._async_update_data()\r\n                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/src/homeassistant/homeassistant/components/touchline_sl/coordinator.py\", line 46, in _async_update_data\r\n    zones = await self.module.zones()\r\n            ^^^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/local/lib/python3.12/site-packages/pytouchlinesl/module.py\", line 100, in zones\r\n    data = await self._data(refresh=refresh)\r\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/local/lib/python3.12/site-packages/pytouchlinesl/module.py\", line 81, in _data\r\n    self._raw_data = await self._client.module(self.id)\r\n                     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/local/lib/python3.12/site-packages/pytouchlinesl/client/client.py\", line 106, in module\r\n    return ModuleModel(**resp)\r\n           ^^^^^^^^^^^^^^^^^^^\r\n  File \"pydantic/main.py\", line 341, in pydantic.main.BaseModel.__init__\r\npydantic.error_wrappers.ValidationError: 1 validation error for ModuleModel\r\nzones -> elements -> 23 -> zone -> zoneState\r\n  unexpected value; permitted: 'zoneOff', 'noAlarm', 'zoneUnregistered' (type=value_error.const; given=noCommunication; permitted=('zoneOff', 'noAlarm', 'zoneUnregistered'))\r\n\r\n\r\n### What version of Home Assistant Core has the issue?\r\n\r\n2024.11.2\r\n\r\n### What was the last working version of Home Assistant Core?\r\n\r\n_No response_\r\n\r\n### What type of installation are you running?\r\n\r\nHome Assistant OS\r\n\r\n### Integration causing the issue\r\n\r\n_No response_\r\n\r\n### Link to integration documentation on our website\r\n\r\n_No response_\r\n\r\n### Diagnostics information\r\n\r\n_No response_\r\n\r\n### Example YAML snippet\r\n\r\n_No response_\r\n\r\n### Anything in the logs that might be useful for us?\r\n\r\n_No response_\r\n\r\n### Additional information\r\n\r\n_No response_\n", "hints_text": "Integration: Roth Touchline SL\n\nHey there @jnsgruk, mind taking a look at this issue as it has been labeled with an integration (`touchline_sl`) you are listed as a [code owner](https://github.com/home-assistant/core/blob/dev/CODEOWNERS#L1532) for? Thanks!\n\n<details>\n<summary>Code owner commands</summary>\n\n\nCode owners of `touchline_sl` can trigger bot actions by commenting:\n\n- `@home-assistant close` Closes the issue.\n- `@home-assistant rename Awesome new title` Renames the issue.\n- `@home-assistant reopen` Reopen the issue.\n- `@home-assistant unassign touchline_sl` Removes the current integration label and assignees on the issue, add the integration domain after the command.\n- `@home-assistant add-label needs-more-information` Add a label (needs-more-information, problem in dependency, problem in custom component) to the issue.\n- `@home-assistant remove-label needs-more-information` Remove a label (needs-more-information, problem in dependency, problem in custom component) on the issue.\n\n</details>\n\n\n<sub><sup>(message by CodeOwnersMention)</sup></sub>\n\n---\n\n[touchline_sl documentation](https://www.home-assistant.io/integrations/touchline_sl)\n[touchline_sl source](https://github.com/home-assistant/core/tree/dev/homeassistant/components/touchline_sl)\n<sub><sup>(message by IssueLinks)</sup></sub>\nThis was fixed in the underlying library (`pytouchlinesl`) by this commit: https://github.com/jnsgruk/pytouchlinesl/commit/aff12cb39880349da6409f0b2f7f521c4d55a54d.\r\n\r\nThe author of that commit is currently preparing a pull request to Home Assistant that will bring the later version in.\r\n\r\n@peroo - when you create your PR which should bump the `pytouchlinesl` version to `0.2.0`, can you ensure to link it to this issue? \ud83d\ude42 \n@jnsgruk The fix was merged in with your previous version bump, so this can probably be closed. https://github.com/home-assistant/core/pull/130867 \nAgreed! (I can't close it though ;-))\nAh, I'll link it when I bump to 0.2.0 so it hopefully(?) gets closed.", "created_at": "2024-11-20T20:15:29Z"}
{"repo": "home-assistant/core", "pull_number": 131087, "instance_id": "home-assistant__core-131087", "issue_numbers": ["130772"], "base_commit": "e6225e3dcc0cb2c99128e27313c1e136f39d4d88", "patch": "diff --git a/homeassistant/components/nexia/strings.json b/homeassistant/components/nexia/strings.json\nindex aec145b8806f8c..4e0b095289cfab 100644\n--- a/homeassistant/components/nexia/strings.json\n+++ b/homeassistant/components/nexia/strings.json\n@@ -64,7 +64,7 @@\n   \"services\": {\n     \"set_aircleaner_mode\": {\n       \"name\": \"Set air cleaner mode\",\n-      \"description\": \"The air cleaner mode.\",\n+      \"description\": \"Sets the air cleaner mode.\",\n       \"fields\": {\n         \"aircleaner_mode\": {\n           \"name\": \"Air cleaner mode\",\n@@ -74,7 +74,7 @@\n     },\n     \"set_humidify_setpoint\": {\n       \"name\": \"Set humidify set point\",\n-      \"description\": \"The humidification set point.\",\n+      \"description\": \"Sets the target humidity.\",\n       \"fields\": {\n         \"humidity\": {\n           \"name\": \"Humidify\",\n@@ -84,7 +84,7 @@\n     },\n     \"set_hvac_run_mode\": {\n       \"name\": \"Set hvac run mode\",\n-      \"description\": \"The HVAC run mode.\",\n+      \"description\": \"Sets the HVAC operation mode.\",\n       \"fields\": {\n         \"run_mode\": {\n           \"name\": \"Run mode\",\n", "test_patch": "", "problem_statement": "Nexia: Wrong description keys for all services\n### The problem\r\n\r\nThe description keys for all three services / actions of the Nexia integration are wrong.\r\n\r\nThey show up when calling up the action and should explain the purpose of each action. Instead they try to explain some data field they supply, which is actually found in the \"description\" keys below them in the \"fields\" section.\r\n\r\nhttps://github.com/home-assistant/core/blob/9711816542b581d7c40a3d69668c3711d5af7c23/homeassistant/components/nexia/strings.json#L64-L67\r\n\r\n    Sets the air cleaner mode of the thermostat.\r\n\r\nhttps://github.com/home-assistant/core/blob/9711816542b581d7c40a3d69668c3711d5af7c23/homeassistant/components/nexia/strings.json#L75-L77\r\n\r\n    Sets the target humidity of the thermostat.\r\n\r\nhttps://github.com/home-assistant/core/blob/9711816542b581d7c40a3d69668c3711d5af7c23/homeassistant/components/nexia/strings.json#L85-L87\r\n\r\n    Sets the HVAC operation mode of the thermostat.\r\n\r\n\r\n_I stumbled over these strings several times trying to translate them into German. We will probably never encounter these devices over here, but we still need to provide all translations for consistency._ ;-)\r\n\r\n### What version of Home Assistant Core has the issue?\r\n\r\ncore-2024.11.2\r\n\r\n### Integration causing the issue\r\n\r\nNexia/American Standard/Trane\r\n\r\n### Link to integration documentation on our website\r\n\r\nhttps://www.home-assistant.io/integrations/nexia/\r\n\r\n\n", "hints_text": "\nHey there @bdraco, mind taking a look at this issue as it has been labeled with an integration (`nexia`) you are listed as a [code owner](https://github.com/home-assistant/core/blob/dev/CODEOWNERS#L993) for? Thanks!\n\n<details>\n<summary>Code owner commands</summary>\n\n\nCode owners of `nexia` can trigger bot actions by commenting:\n\n- `@home-assistant close` Closes the issue.\n- `@home-assistant rename Awesome new title` Renames the issue.\n- `@home-assistant reopen` Reopen the issue.\n- `@home-assistant unassign nexia` Removes the current integration label and assignees on the issue, add the integration domain after the command.\n- `@home-assistant add-label needs-more-information` Add a label (needs-more-information, problem in dependency, problem in custom component) to the issue.\n- `@home-assistant remove-label needs-more-information` Remove a label (needs-more-information, problem in dependency, problem in custom component) on the issue.\n\n</details>\n\n\n<sub><sup>(message by CodeOwnersMention)</sup></sub>\n\n---\n\n[nexia documentation](https://www.home-assistant.io/integrations/nexia)\n[nexia source](https://github.com/home-assistant/core/tree/dev/homeassistant/components/nexia)\n<sub><sup>(message by IssueLinks)</sup></sub>", "created_at": "2024-11-20T20:09:37Z"}
{"repo": "home-assistant/core", "pull_number": 131070, "instance_id": "home-assistant__core-131070", "issue_numbers": ["131015"], "base_commit": "75e15ec6eabac2bcf6e1af4e0a1c989cdac00762", "patch": "diff --git a/homeassistant/components/nina/binary_sensor.py b/homeassistant/components/nina/binary_sensor.py\nindex 397ced0f5d34c..10d3008fd8236 100644\n--- a/homeassistant/components/nina/binary_sensor.py\n+++ b/homeassistant/components/nina/binary_sensor.py\n@@ -25,6 +25,7 @@\n     ATTR_SENT,\n     ATTR_SEVERITY,\n     ATTR_START,\n+    ATTR_WEB,\n     CONF_MESSAGE_SLOTS,\n     CONF_REGIONS,\n     DOMAIN,\n@@ -103,6 +104,7 @@ def extra_state_attributes(self) -> dict[str, Any]:\n             ATTR_SEVERITY: data.severity,\n             ATTR_RECOMMENDED_ACTIONS: data.recommended_actions,\n             ATTR_AFFECTED_AREAS: data.affected_areas,\n+            ATTR_WEB: data.web,\n             ATTR_ID: data.id,\n             ATTR_SENT: data.sent,\n             ATTR_START: data.start,\ndiff --git a/homeassistant/components/nina/const.py b/homeassistant/components/nina/const.py\nindex 1e7550560796f..47194c4c2dedf 100644\n--- a/homeassistant/components/nina/const.py\n+++ b/homeassistant/components/nina/const.py\n@@ -27,6 +27,7 @@\n ATTR_SEVERITY: str = \"severity\"\n ATTR_RECOMMENDED_ACTIONS: str = \"recommended_actions\"\n ATTR_AFFECTED_AREAS: str = \"affected_areas\"\n+ATTR_WEB: str = \"web\"\n ATTR_ID: str = \"id\"\n ATTR_SENT: str = \"sent\"\n ATTR_START: str = \"start\"\ndiff --git a/homeassistant/components/nina/coordinator.py b/homeassistant/components/nina/coordinator.py\nindex c731c7a62d7fd..2d9548f3d121c 100644\n--- a/homeassistant/components/nina/coordinator.py\n+++ b/homeassistant/components/nina/coordinator.py\n@@ -27,6 +27,7 @@ class NinaWarningData:\n     severity: str\n     recommended_actions: str\n     affected_areas: str\n+    web: str\n     sent: str\n     start: str\n     expires: str\n@@ -127,6 +128,7 @@ def _parse_data(self) -> dict[str, list[NinaWarningData]]:\n                     raw_warn.severity,\n                     \" \".join([str(action) for action in raw_warn.recommended_actions]),\n                     affected_areas_string,\n+                    raw_warn.web or \"\",\n                     raw_warn.sent or \"\",\n                     raw_warn.start or \"\",\n                     raw_warn.expires or \"\",\n", "test_patch": "diff --git a/tests/components/nina/test_binary_sensor.py b/tests/components/nina/test_binary_sensor.py\nindex a7f9a980960ce..6ed1aee7e9ddb 100644\n--- a/tests/components/nina/test_binary_sensor.py\n+++ b/tests/components/nina/test_binary_sensor.py\n@@ -17,6 +17,7 @@\n     ATTR_SENT,\n     ATTR_SEVERITY,\n     ATTR_START,\n+    ATTR_WEB,\n     DOMAIN,\n )\n from homeassistant.config_entries import ConfigEntryState\n@@ -77,6 +78,7 @@ async def test_sensors(hass: HomeAssistant, entity_registry: er.EntityRegistry)\n         assert state_w1.attributes.get(ATTR_SENDER) == \"Deutscher Wetterdienst\"\n         assert state_w1.attributes.get(ATTR_SEVERITY) == \"Minor\"\n         assert state_w1.attributes.get(ATTR_RECOMMENDED_ACTIONS) == \"\"\n+        assert state_w1.attributes.get(ATTR_WEB) == \"https://www.wettergefahren.de\"\n         assert (\n             state_w1.attributes.get(ATTR_AFFECTED_AREAS)\n             == \"Gemeinde Oberreichenbach, Gemeinde Neuweiler, Stadt Nagold, Stadt Neubulach, Gemeinde Sch\u00f6mberg, Gemeinde Simmersfeld, Gemeinde Simmozheim, Gemeinde Rohrdorf, Gemeinde Ostelsheim, Gemeinde Ebhausen, Gemeinde Egenhausen, Gemeinde Dobel, Stadt Bad Liebenzell, Stadt Solingen, Stadt Haiterbach, Stadt Bad Herrenalb, Gemeinde H\u00f6fen an der Enz, Gemeinde Gechingen, Gemeinde Enzkl\u00f6sterle, Gemeinde Gutach (Schwarzwaldbahn) und 3392 weitere.\"\n@@ -98,6 +100,7 @@ async def test_sensors(hass: HomeAssistant, entity_registry: er.EntityRegistry)\n         assert state_w2.attributes.get(ATTR_SENDER) is None\n         assert state_w2.attributes.get(ATTR_SEVERITY) is None\n         assert state_w2.attributes.get(ATTR_RECOMMENDED_ACTIONS) is None\n+        assert state_w2.attributes.get(ATTR_WEB) is None\n         assert state_w2.attributes.get(ATTR_AFFECTED_AREAS) is None\n         assert state_w2.attributes.get(ATTR_ID) is None\n         assert state_w2.attributes.get(ATTR_SENT) is None\n@@ -116,6 +119,7 @@ async def test_sensors(hass: HomeAssistant, entity_registry: er.EntityRegistry)\n         assert state_w3.attributes.get(ATTR_SENDER) is None\n         assert state_w3.attributes.get(ATTR_SEVERITY) is None\n         assert state_w3.attributes.get(ATTR_RECOMMENDED_ACTIONS) is None\n+        assert state_w3.attributes.get(ATTR_WEB) is None\n         assert state_w3.attributes.get(ATTR_AFFECTED_AREAS) is None\n         assert state_w3.attributes.get(ATTR_ID) is None\n         assert state_w3.attributes.get(ATTR_SENT) is None\n@@ -134,6 +138,7 @@ async def test_sensors(hass: HomeAssistant, entity_registry: er.EntityRegistry)\n         assert state_w4.attributes.get(ATTR_SENDER) is None\n         assert state_w4.attributes.get(ATTR_SEVERITY) is None\n         assert state_w4.attributes.get(ATTR_RECOMMENDED_ACTIONS) is None\n+        assert state_w4.attributes.get(ATTR_WEB) is None\n         assert state_w4.attributes.get(ATTR_AFFECTED_AREAS) is None\n         assert state_w4.attributes.get(ATTR_ID) is None\n         assert state_w4.attributes.get(ATTR_SENT) is None\n@@ -152,6 +157,7 @@ async def test_sensors(hass: HomeAssistant, entity_registry: er.EntityRegistry)\n         assert state_w5.attributes.get(ATTR_SENDER) is None\n         assert state_w5.attributes.get(ATTR_SEVERITY) is None\n         assert state_w5.attributes.get(ATTR_RECOMMENDED_ACTIONS) is None\n+        assert state_w5.attributes.get(ATTR_WEB) is None\n         assert state_w5.attributes.get(ATTR_AFFECTED_AREAS) is None\n         assert state_w5.attributes.get(ATTR_ID) is None\n         assert state_w5.attributes.get(ATTR_SENT) is None\n@@ -199,6 +205,7 @@ async def test_sensors_without_corona_filter(\n             state_w1.attributes.get(ATTR_RECOMMENDED_ACTIONS)\n             == \"Waschen sich regelm\u00e4\u00dfig und gr\u00fcndlich die H\u00e4nde.\"\n         )\n+        assert state_w1.attributes.get(ATTR_WEB) == \"\"\n         assert (\n             state_w1.attributes.get(ATTR_AFFECTED_AREAS)\n             == \"Bundesland: Freie Hansestadt Bremen, Land Berlin, Land Hessen, Land Nordrhein-Westfalen, Land Brandenburg, Freistaat Bayern, Land Mecklenburg-Vorpommern, Land Rheinland-Pfalz, Freistaat Sachsen, Land Schleswig-Holstein, Freie und Hansestadt Hamburg, Freistaat Th\u00fcringen, Land Niedersachsen, Land Saarland, Land Sachsen-Anhalt, Land Baden-W\u00fcrttemberg\"\n@@ -227,6 +234,7 @@ async def test_sensors_without_corona_filter(\n         assert state_w2.attributes.get(ATTR_SENDER) == \"Deutscher Wetterdienst\"\n         assert state_w2.attributes.get(ATTR_SEVERITY) == \"Minor\"\n         assert state_w2.attributes.get(ATTR_RECOMMENDED_ACTIONS) == \"\"\n+        assert state_w2.attributes.get(ATTR_WEB) == \"https://www.wettergefahren.de\"\n         assert state_w2.attributes.get(ATTR_ID) == \"mow.DE-NW-BN-SE030-20201014-30-000\"\n         assert state_w2.attributes.get(ATTR_SENT) == \"2021-10-11T05:20:00+01:00\"\n         assert state_w2.attributes.get(ATTR_START) == \"2021-11-01T05:20:00+01:00\"\n@@ -244,6 +252,7 @@ async def test_sensors_without_corona_filter(\n         assert state_w3.attributes.get(ATTR_SENDER) is None\n         assert state_w3.attributes.get(ATTR_SEVERITY) is None\n         assert state_w3.attributes.get(ATTR_RECOMMENDED_ACTIONS) is None\n+        assert state_w3.attributes.get(ATTR_WEB) is None\n         assert state_w3.attributes.get(ATTR_AFFECTED_AREAS) is None\n         assert state_w3.attributes.get(ATTR_ID) is None\n         assert state_w3.attributes.get(ATTR_SENT) is None\n@@ -262,6 +271,7 @@ async def test_sensors_without_corona_filter(\n         assert state_w4.attributes.get(ATTR_SENDER) is None\n         assert state_w4.attributes.get(ATTR_SEVERITY) is None\n         assert state_w4.attributes.get(ATTR_RECOMMENDED_ACTIONS) is None\n+        assert state_w4.attributes.get(ATTR_WEB) is None\n         assert state_w4.attributes.get(ATTR_AFFECTED_AREAS) is None\n         assert state_w4.attributes.get(ATTR_ID) is None\n         assert state_w4.attributes.get(ATTR_SENT) is None\n@@ -280,6 +290,7 @@ async def test_sensors_without_corona_filter(\n         assert state_w5.attributes.get(ATTR_SENDER) is None\n         assert state_w5.attributes.get(ATTR_SEVERITY) is None\n         assert state_w5.attributes.get(ATTR_RECOMMENDED_ACTIONS) is None\n+        assert state_w5.attributes.get(ATTR_WEB) is None\n         assert state_w5.attributes.get(ATTR_AFFECTED_AREAS) is None\n         assert state_w5.attributes.get(ATTR_ID) is None\n         assert state_w5.attributes.get(ATTR_SENT) is None\n", "problem_statement": "NINA: URL for more informations missing\n### The problem\n\nGot a warning about Hochwasser, attributes from the developer tools:\r\n\r\n```yaml\r\nheadline: \"Warnung: Hochwasser\"\r\ndescription: >-\r\n  Es liegt eine Warnung vor Hochwasser f\u00fcr das genannte Gebiet vor. Bitte\r\n  informieren Sie sich unter dem aufgef\u00fchrten Link.\r\nsender: Landesamt f\u00fcr Natur, Umwelt und Verbraucherschutz NRW\r\nseverity: Moderate\r\nrecommended_actions: >-\r\n  Informieren Sie sich unbedingt \u00fcber die aktuelle Wetter- und\r\n  Hochwasserentwicklung und die Ausgabe von amtlichen Warnungen. Achten Sie auf\r\n  Ihre eigene Sicherheit! Halten Sie sich von Gew\u00e4ssern fern! Entfernen Sie Ihr\r\n  Auto aus hochwassergef\u00e4hrdeten Bereichen. \u00dcberpr\u00fcfen Sie Ihre Vorsorge- und\r\n  Schutzma\u00dfnahmen.\r\naffected_areas: Lippeeinzugsgebiet\r\nid: lhp.LHP.NW.nw10719\r\nsent: \"2024-11-19T17:11:00+01:00\"\r\nstart: \"2024-11-19T16:58:00+01:00\"\r\nexpires: \"\"\r\ndevice_class: safety\r\nfriendly_name: \"Warning: Castrop-Rauxel, Stadt (Recklinghausen - Nordrhein-Westfalen) 1\"\r\n```\r\n\r\nA link in the description is mentionend (\"unter dem aufgef\u00fchrten Link\"), which is not available in the entity.\r\n\r\nThis is the [json response](https://nina.api.proxy.bund.dev/api31/warnings/lhp.LHP.NW.nw10719.json\r\n) from the NINA Api, the URL from the description is under info > web.\r\n\r\n```json\r\n{\r\n  \"identifier\": \"lhp.LHP.NW.nw10719\",\r\n  \"sender\": \"HID.Leitung@lanuv.nrw.de\",\r\n  \"sent\": \"2024-11-19T17:11:00+01:00\",\r\n  \"status\": \"Actual\",\r\n  \"msgType\": \"Alert\",\r\n  \"scope\": \"Public\",\r\n  \"code\": [\r\n    \"DVN:5\"\r\n  ],\r\n  \"info\": [\r\n    {\r\n      \"language\": \"de-DE\",\r\n      \"category\": [\r\n        \"Met\"\r\n      ],\r\n      \"event\": \"Flood\",\r\n      \"responseType\": [\r\n        \"None\"\r\n      ],\r\n      \"urgency\": \"Immediate\",\r\n      \"severity\": \"Moderate\",\r\n      \"certainty\": \"Observed\",\r\n      \"effective\": \"2024-11-19T16:58:00+01:00\",\r\n      \"onset\": \"2024-11-19T16:58:00+01:00\",\r\n      \"senderName\": \"Landesamt f\u00fcr Natur, Umwelt und Verbraucherschutz NRW\",\r\n      \"headline\": \"Warnung: Hochwasser\",\r\n      \"description\": \"Es liegt eine Warnung vor Hochwasser f\u00fcr das genannte Gebiet vor. Bitte informieren Sie sich unter dem aufgef\u00fchrten Link.\",\r\n      \"instruction\": \"Informieren Sie sich unbedingt \u00fcber die aktuelle Wetter- und Hochwasserentwicklung und die Ausgabe von amtlichen Warnungen.<br/>Achten Sie auf Ihre eigene Sicherheit!<br/>Halten Sie sich von Gew\u00e4ssern fern!<br/>Entfernen Sie Ihr Auto aus hochwassergef\u00e4hrdeten Bereichen.<br/>\u00dcberpr\u00fcfen Sie Ihre Vorsorge- und Schutzma\u00dfnahmen.\",\r\n      \"web\": \"https://hochwasserportal.nrw/lanuv/webpublic/index.html#/Lageberichte\",\r\n      \"contact\": \"Landesamt f\u00fcr Natur, Umwelt und Verbraucherschutz NRW\",\r\n      \"parameter\": [\r\n        {\r\n          \"valueName\": \"sender_langname\",\r\n          \"value\": \"Landesamt f\u00fcr Natur, Umwelt und Verbraucherschutz NRW\"\r\n        },\r\n        {\r\n          \"valueName\": \"PHGEM\",\r\n          \"value\": \"3422+1,3434,3444,3446+1,3465+1,3468+3,3473+5,3483+1,3489,3496+29,3527,3529+3,3535+1,3538,3545,3548,3558+9,3570,3613,3615+1\"\r\n        },\r\n        {\r\n          \"valueName\": \"ZGEM\",\r\n          \"value\": \"3422+1,3434,3444,3446+1,3465+1,3468+3,3473+5,3483+1,3489,3496+29,3527,3529+3,3535+1,3538,3545,3548,3558+9,3570,3613,3615+1\"\r\n        }\r\n      ],\r\n      \"area\": [\r\n        {\r\n          \"areaDesc\": \"Lippeeinzugsgebiet\",\r\n          \"geocode\": [\r\n            {\r\n              \"valueName\": \"AreaId\",\r\n              \"value\": \"0\"\r\n            }\r\n          ]\r\n        }\r\n      ]\r\n    }\r\n  ]\r\n}\r\n```\r\n\r\nSomehow related to [#66926](https://github.com/home-assistant/core/issues/66926), where the warnings json is mentioned.\n\n### What version of Home Assistant Core has the issue?\n\ncore-2024.11.2\n\n### What was the last working version of Home Assistant Core?\n\n_No response_\n\n### What type of installation are you running?\n\nHome Assistant OS\n\n### Integration causing the issue\n\nNINA\n\n### Link to integration documentation on our website\n\nhttps://www.home-assistant.io/integrations/nina/\n\n### Diagnostics information\n\n[home-assistant_nina_2024-11-20T08-10-36.068Z.log](https://github.com/user-attachments/files/17827181/home-assistant_nina_2024-11-20T08-10-36.068Z.log)\r\n\n\n### Example YAML snippet\n\n_No response_\n\n### Anything in the logs that might be useful for us?\n\n_No response_\n\n### Additional information\n\n_No response_\n", "hints_text": "\nHey there @deermaximum, mind taking a look at this issue as it has been labeled with an integration (`nina`) you are listed as a [code owner](https://github.com/home-assistant/core/blob/dev/CODEOWNERS#L1008) for? Thanks!\n\n<details>\n<summary>Code owner commands</summary>\n\n\nCode owners of `nina` can trigger bot actions by commenting:\n\n- `@home-assistant close` Closes the issue.\n- `@home-assistant rename Awesome new title` Renames the issue.\n- `@home-assistant reopen` Reopen the issue.\n- `@home-assistant unassign nina` Removes the current integration label and assignees on the issue, add the integration domain after the command.\n- `@home-assistant add-label needs-more-information` Add a label (needs-more-information, problem in dependency, problem in custom component) to the issue.\n- `@home-assistant remove-label needs-more-information` Remove a label (needs-more-information, problem in dependency, problem in custom component) on the issue.\n\n</details>\n\n\n<sub><sup>(message by CodeOwnersMention)</sup></sub>\n\n---\n\n[nina documentation](https://www.home-assistant.io/integrations/nina)\n[nina source](https://github.com/home-assistant/core/tree/dev/homeassistant/components/nina)\n<sub><sup>(message by IssueLinks)</sup></sub>", "created_at": "2024-11-20T19:10:04Z"}
{"repo": "home-assistant/core", "pull_number": 131009, "instance_id": "home-assistant__core-131009", "issue_numbers": ["128279"], "base_commit": "2a1cdf6ff28cc4f6ae85c03216cb712664e9c880", "patch": "diff --git a/homeassistant/components/unifiprotect/strings.json b/homeassistant/components/unifiprotect/strings.json\nindex 9238c825390d4..7b2a06dfef72e 100644\n--- a/homeassistant/components/unifiprotect/strings.json\n+++ b/homeassistant/components/unifiprotect/strings.json\n@@ -182,7 +182,7 @@\n       \"fields\": {\n         \"device_id\": {\n           \"name\": \"Chime\",\n-          \"description\": \"The chimes to link to the doorbells to.\"\n+          \"description\": \"The chimes to link to the doorbells.\"\n         },\n         \"doorbells\": {\n           \"name\": \"Doorbells\",\n", "test_patch": "", "problem_statement": "UniFi Protect Integration: Duplicated \"to\" in description string\n### The problem\r\n\r\nIn the string\r\n\r\nhttps://github.com/home-assistant/core/blob/a0f73bd30f02b411946556b1ae514ea15938a8d6/homeassistant/components/unifiprotect/strings.json#L185\r\n\r\nthe word \"**to**\" is duplicated so it's completely unclear which direction this is meant to work:\r\n\r\n     The chimes to link **to** the doorbells **to**.\r\n\r\nJudging from the description in \r\n\r\nhttps://github.com/home-assistant/core/blob/a0f73bd30f02b411946556b1ae514ea15938a8d6/homeassistant/components/unifiprotect/strings.json#L189\r\n\r\nthat plural in \"chimes\" is also wrong, so this should be\r\n\r\n      The chime to link to the doorbells.\r\n\r\n\r\n### What version of Home Assistant Core has the issue?\r\n\r\ncore-2024.10.4\r\n\n", "hints_text": "[unifiprotect documentation](https://www.home-assistant.io/integrations/unifiprotect)\n[unifiprotect source](https://github.com/home-assistant/core/tree/dev/homeassistant/components/unifiprotect)\nNo comments? - This is a rather simple bug and fix \u2026", "created_at": "2024-11-20T06:24:52Z"}
{"repo": "home-assistant/core", "pull_number": 130985, "instance_id": "home-assistant__core-130985", "issue_numbers": ["130943"], "base_commit": "8b4983087bac984041f223adc311751b2a53df08", "patch": "diff --git a/homeassistant/components/remote/strings.json b/homeassistant/components/remote/strings.json\nindex e3df487a57bd3f..09b270b968766e 100644\n--- a/homeassistant/components/remote/strings.json\n+++ b/homeassistant/components/remote/strings.json\n@@ -28,7 +28,7 @@\n   \"services\": {\n     \"turn_on\": {\n       \"name\": \"[%key:common::action::turn_on%]\",\n-      \"description\": \"Sends the power on command.\",\n+      \"description\": \"Sends the turn on command.\",\n       \"fields\": {\n         \"activity\": {\n           \"name\": \"Activity\",\n@@ -38,11 +38,11 @@\n     },\n     \"toggle\": {\n       \"name\": \"[%key:common::action::toggle%]\",\n-      \"description\": \"Toggles a device on/off.\"\n+      \"description\": \"Sends the toggle command.\"\n     },\n     \"turn_off\": {\n       \"name\": \"[%key:common::action::turn_off%]\",\n-      \"description\": \"Turns the device off.\"\n+      \"description\": \"Sends the turn off command.\"\n     },\n     \"send_command\": {\n       \"name\": \"Send command\",\n", "test_patch": "", "problem_statement": "Remote integration: Make descriptions for \"turn on\", \"turn off\" and \"toggle\" consistent\n### The problem\r\n\r\nThe descriptions of the \"turn on\", \"turn off\" and \"toggle\" actions of the Remote integration are all slightly different making it hard to find a consistent set of translations:\r\n\r\nhttps://github.com/home-assistant/core/blob/7dc2102545bd09299e90055a3d87b3fc1fa34a70/homeassistant/components/remote/strings.json#L28-L45\r\n\r\nHere compressed in a shorter list to see them side-by-side:\r\n\r\n    Sends the power on command.\r\n    Turns the device off.\r\n    Toggles a device on/off.\r\n\r\n\r\nAs you can see they don't agree on \"a device\" or \"the device\" and differ in the way they explain the action.\r\n\r\nThis should be made consistent by using:\r\n\r\n    Sends the turn on command to a device.\r\n    Sends the turn off command to a device.\r\n    Sends the toggle command to a device to turn it on or off.\r\n\r\nUsing \"turn on\" and \"turn off\" in the description instead of \"power on\" also better matches the online documentation:\r\n\r\n    Registers actions remote.turn_on, remote.turn_off, remote.toggle, and remote.send_command to control remotes.\r\n\r\n\r\nThis change allows more consistent translations like in German:\r\n\r\n    Sendet den Einschalten-Befehl an ein Ger\u00e4t.\r\n    Sendet den Ausschalten-Befehl an ein Ger\u00e4t.\r\n    Sendet den Umschalten-Befehl an ein Ger\u00e4t, um es ein- oder auszuschalten.\r\n\r\n\r\n\r\n### What version of Home Assistant Core has the issue?\r\n\r\ncore-2024.11.2\r\n\r\n### What type of installation are you running?\r\n\r\nHome Assistant OS\r\n\r\n### Integration causing the issue\r\n\r\nRemote\r\n\r\n### Link to integration documentation on our website\r\n\r\nhttps://www.home-assistant.io/integrations/remote/\r\n\n", "hints_text": "\nHey there @home-assistant/core, mind taking a look at this issue as it has been labeled with an integration (`remote`) you are listed as a [code owner](https://github.com/home-assistant/core/blob/dev/CODEOWNERS#L1218) for? Thanks!\n\n<details>\n<summary>Code owner commands</summary>\n\n\nCode owners of `remote` can trigger bot actions by commenting:\n\n- `@home-assistant close` Closes the issue.\n- `@home-assistant rename Awesome new title` Renames the issue.\n- `@home-assistant reopen` Reopen the issue.\n- `@home-assistant unassign remote` Removes the current integration label and assignees on the issue, add the integration domain after the command.\n- `@home-assistant add-label needs-more-information` Add a label (needs-more-information, problem in dependency, problem in custom component) to the issue.\n- `@home-assistant remove-label needs-more-information` Remove a label (needs-more-information, problem in dependency, problem in custom component) on the issue.\n\n</details>\n\n\n<sub><sup>(message by CodeOwnersMention)</sup></sub>\n\n---\n\n[remote documentation](https://www.home-assistant.io/integrations/remote)\n[remote source](https://github.com/home-assistant/core/tree/dev/homeassistant/components/remote)\n<sub><sup>(message by IssueLinks)</sup></sub>", "created_at": "2024-11-19T18:57:56Z"}
{"repo": "home-assistant/core", "pull_number": 130983, "instance_id": "home-assistant__core-130983", "issue_numbers": ["130937"], "base_commit": "3a8a8861d2eaebe64b99976d8a3c66ab77317880", "patch": "diff --git a/homeassistant/components/workday/strings.json b/homeassistant/components/workday/strings.json\nindex f3b966e28ea5e5..e74dc0160d9c49 100644\n--- a/homeassistant/components/workday/strings.json\n+++ b/homeassistant/components/workday/strings.json\n@@ -86,18 +86,19 @@\n       \"options\": {\n         \"armed_forces\": \"Armed forces\",\n         \"bank\": \"Bank\",\n+        \"catholic\": \"Catholic\",\n+        \"chinese\": \"Chinese\",\n+        \"christian\": \"Christian\",\n         \"government\": \"Government\",\n         \"half_day\": \"Half day\",\n+        \"hebrew\": \"Hebrew\",\n+        \"hindu\": \"Hindu\",\n+        \"islamic\": \"Islamic\",\n         \"optional\": \"Optional\",\n         \"public\": \"Public\",\n         \"school\": \"School\",\n         \"unofficial\": \"Unofficial\",\n-        \"workday\": \"Workday\",\n-        \"chinese\": \"Chinese\",\n-        \"christian\": \"Christian\",\n-        \"hebrew\": \"Hebrew\",\n-        \"hindu\": \"Hindu\",\n-        \"islamic\": \"Islamic\"\n+        \"workday\": \"Workday\"\n       }\n     },\n     \"days\": {\n", "test_patch": "", "problem_statement": "Workday integration: Missing translation for 'catholic' category\n### The problem\r\n\r\nThe Workday integration contains a list of categories for holiday categories:\r\n\r\n    \"category\": {\r\n      \"options\": {\r\n        \"armed_forces\": \"Armed forces\",\r\n        \"bank\": \"Bank\",\r\n        \"government\": \"Government\",\r\n        \"half_day\": \"Half day\",\r\n        \"optional\": \"Optional\",\r\n        \"public\": \"Public\",\r\n        \"school\": \"School\",\r\n        \"unofficial\": \"Unofficial\",\r\n        \"workday\": \"Workday\",\r\n        \"chinese\": \"Chinese\",\r\n        \"christian\": \"Christian\",\r\n        \"hebrew\": \"Hebrew\",\r\n        \"hindu\": \"Hindu\",\r\n        \"islamic\": \"Islamic\"\r\n\r\nThis is missing \"catholic\" so this does not show up translated:\r\n\r\n![Screenshot 2024-11-19 08 26 14](https://github.com/user-attachments/assets/5d0f5cf9-8d4e-4d6b-8fca-64fae289b8e9)\r\n\r\nAccording to https://pypi.org/project/holidays/ this selector seems to be limited to Germany where we have this option that some holidays are only obeyed in the catholic regions of a state. But it's also the only selector that is not mapped in the above list.\r\n\r\n### What version of Home Assistant Core has the issue?\r\n\r\ncore-2024.11.2\r\n\r\n### Integration causing the issue\r\n\r\nWorkday\r\n\r\n### Link to integration documentation on our website\r\n\r\nhttps://www.home-assistant.io/integrations/workday\r\n\n", "hints_text": "\nHey there @fabaff, @gjohansson-st, mind taking a look at this issue as it has been labeled with an integration (`workday`) you are listed as a [code owner](https://github.com/home-assistant/core/blob/dev/CODEOWNERS#L1687) for? Thanks!\n\n<details>\n<summary>Code owner commands</summary>\n\n\nCode owners of `workday` can trigger bot actions by commenting:\n\n- `@home-assistant close` Closes the issue.\n- `@home-assistant rename Awesome new title` Renames the issue.\n- `@home-assistant reopen` Reopen the issue.\n- `@home-assistant unassign workday` Removes the current integration label and assignees on the issue, add the integration domain after the command.\n- `@home-assistant add-label needs-more-information` Add a label (needs-more-information, problem in dependency, problem in custom component) to the issue.\n- `@home-assistant remove-label needs-more-information` Remove a label (needs-more-information, problem in dependency, problem in custom component) on the issue.\n\n</details>\n\n\n<sub><sup>(message by CodeOwnersMention)</sup></sub>\n\n---\n\n[workday documentation](https://www.home-assistant.io/integrations/workday)\n[workday source](https://github.com/home-assistant/core/tree/dev/homeassistant/components/workday)\n<sub><sup>(message by IssueLinks)</sup></sub>", "created_at": "2024-11-19T18:41:46Z"}
{"repo": "home-assistant/core", "pull_number": 130971, "instance_id": "home-assistant__core-130971", "issue_numbers": ["130452"], "base_commit": "42bba24247dab3af26d858a84e09613e09ed201d", "patch": "diff --git a/homeassistant/components/hassio/strings.json b/homeassistant/components/hassio/strings.json\nindex 09ed45bd5bc2c..de42a317cc7d1 100644\n--- a/homeassistant/components/hassio/strings.json\n+++ b/homeassistant/components/hassio/strings.json\n@@ -274,7 +274,7 @@\n       \"fields\": {\n         \"addon\": {\n           \"name\": \"Add-on\",\n-          \"description\": \"The add-on slug.\"\n+          \"description\": \"The add-on to start.\"\n         }\n       }\n     },\n@@ -284,17 +284,17 @@\n       \"fields\": {\n         \"addon\": {\n           \"name\": \"[%key:component::hassio::services::addon_start::fields::addon::name%]\",\n-          \"description\": \"[%key:component::hassio::services::addon_start::fields::addon::description%]\"\n+          \"description\": \"The add-on to restart.\"\n         }\n       }\n     },\n     \"addon_stdin\": {\n       \"name\": \"Write data to add-on stdin.\",\n-      \"description\": \"Writes data to add-on stdin.\",\n+      \"description\": \"Writes data to the add-on's standard input.\",\n       \"fields\": {\n         \"addon\": {\n           \"name\": \"[%key:component::hassio::services::addon_start::fields::addon::name%]\",\n-          \"description\": \"[%key:component::hassio::services::addon_start::fields::addon::description%]\"\n+          \"description\": \"The add-on to write to.\"\n         }\n       }\n     },\n@@ -304,7 +304,7 @@\n       \"fields\": {\n         \"addon\": {\n           \"name\": \"[%key:component::hassio::services::addon_start::fields::addon::name%]\",\n-          \"description\": \"[%key:component::hassio::services::addon_start::fields::addon::description%]\"\n+          \"description\": \"The add-on to stop.\"\n         }\n       }\n     },\n@@ -314,7 +314,7 @@\n       \"fields\": {\n         \"addon\": {\n           \"name\": \"[%key:component::hassio::services::addon_start::fields::addon::name%]\",\n-          \"description\": \"[%key:component::hassio::services::addon_start::fields::addon::description%]\"\n+          \"description\": \"The add-on to update.\"\n         }\n       }\n     },\n", "test_patch": "", "problem_statement": "Home Assistant Supervisor: Outdated field description \"The add-on slug\" for actions etc.\n### The problem\n\nFor the five Supervisor actions `addon_start`, `addon_restart`, `addon_stdin`, `addon_stop`, `addon_update` the description of the popup menu to select the target Add-on is labeled:\r\n\r\nhttps://github.com/home-assistant/core/blob/ac0c75a598e4e7ee2c27b37e19a9ec5cefb8cd5e/homeassistant/components/hassio/strings.json#L277\r\n\r\nThe other four reference this string.\r\n\r\nAs far as I can tell there is no way to type in the slug here, the user does pick the Add-on from a popup menu:\r\n\r\n![Screenshot 2024-11-12 16 57 21](https://github.com/user-attachments/assets/0a2aa2c3-9788-4d0b-8cff-dc95f694bba2)\r\n\r\nSo this can be changed to something like\r\n\r\n    The add-on for this action\r\n\r\nThis makes it much easier to translate, too. ;-)\r\n\r\nIn addition the description of the `addon_stdin` action needs some clarification.\r\nCurrently it is just an almost 1:1 copy of the name:\r\n\r\nhttps://github.com/home-assistant/core/blob/ac0c75a598e4e7ee2c27b37e19a9ec5cefb8cd5e/homeassistant/components/hassio/strings.json#L292-L293\r\n\r\nI have really no clue what the current description is supposed to mean and where that \"data\" is entered \u2026\r\n\n\n### What version of Home Assistant Core has the issue?\n\ncore-2024.11.1\n\n### What was the last working version of Home Assistant Core?\n\n_No response_\n\n### What type of installation are you running?\n\nHome Assistant OS\n\n### Integration causing the issue\n\nHome Assistant Supervisor\n\n### Link to integration documentation on our website\n\nhttps://www.home-assistant.io/integrations/hassio\n\n### Diagnostics information\n\n_No response_\n\n### Example YAML snippet\n\n_No response_\n\n### Anything in the logs that might be useful for us?\n\n_No response_\n\n### Additional information\n\n_No response_\n", "hints_text": "\nHey there @home-assistant/supervisor, mind taking a look at this issue as it has been labeled with an integration (`hassio`) you are listed as a [code owner](https://github.com/home-assistant/core/blob/dev/CODEOWNERS#L597) for? Thanks!\n\n<details>\n<summary>Code owner commands</summary>\n\n\nCode owners of `hassio` can trigger bot actions by commenting:\n\n- `@home-assistant close` Closes the issue.\n- `@home-assistant rename Awesome new title` Renames the issue.\n- `@home-assistant reopen` Reopen the issue.\n- `@home-assistant unassign hassio` Removes the current integration label and assignees on the issue, add the integration domain after the command.\n- `@home-assistant add-label needs-more-information` Add a label (needs-more-information, problem in dependency, problem in custom component) to the issue.\n- `@home-assistant remove-label needs-more-information` Remove a label (needs-more-information, problem in dependency, problem in custom component) on the issue.\n\n</details>\n\n\n<sub><sup>(message by CodeOwnersMention)</sup></sub>\n\n---\n\n[hassio documentation](https://www.home-assistant.io/integrations/hassio)\n[hassio source](https://github.com/home-assistant/core/tree/dev/homeassistant/components/hassio)\n<sub><sup>(message by IssueLinks)</sup></sub>", "created_at": "2024-11-19T17:48:33Z"}
{"repo": "home-assistant/core", "pull_number": 130970, "instance_id": "home-assistant__core-130970", "issue_numbers": ["130952"], "base_commit": "42bba24247dab3af26d858a84e09613e09ed201d", "patch": "diff --git a/homeassistant/components/ping/config_flow.py b/homeassistant/components/ping/config_flow.py\nindex 4f2adb0d2c0fa9..27cb3f62bcda4c 100644\n--- a/homeassistant/components/ping/config_flow.py\n+++ b/homeassistant/components/ping/config_flow.py\n@@ -27,6 +27,12 @@\n _LOGGER = logging.getLogger(__name__)\n \n \n+def _clean_user_input(user_input: dict[str, Any]) -> dict[str, Any]:\n+    \"\"\"Clean up the user input.\"\"\"\n+    user_input[CONF_HOST] = user_input[CONF_HOST].strip()\n+    return user_input\n+\n+\n class PingConfigFlow(ConfigFlow, domain=DOMAIN):\n     \"\"\"Handle a config flow for Ping.\"\"\"\n \n@@ -46,6 +52,7 @@ async def async_step_user(\n                 ),\n             )\n \n+        user_input = _clean_user_input(user_input)\n         if not is_ip_address(user_input[CONF_HOST]):\n             self.async_abort(reason=\"invalid_ip_address\")\n \n@@ -77,7 +84,7 @@ async def async_step_init(\n     ) -> ConfigFlowResult:\n         \"\"\"Manage the options.\"\"\"\n         if user_input is not None:\n-            return self.async_create_entry(title=\"\", data=user_input)\n+            return self.async_create_entry(title=\"\", data=_clean_user_input(user_input))\n \n         return self.async_show_form(\n             step_id=\"init\",\n", "test_patch": "diff --git a/tests/components/ping/test_config_flow.py b/tests/components/ping/test_config_flow.py\nindex 8204a000f29b48..bc13030647eb09 100644\n--- a/tests/components/ping/test_config_flow.py\n+++ b/tests/components/ping/test_config_flow.py\n@@ -13,11 +13,15 @@\n \n \n @pytest.mark.parametrize(\n-    (\"host\", \"expected_title\"),\n-    [(\"192.618.178.1\", \"192.618.178.1\")],\n+    (\"host\", \"expected\"),\n+    [\n+        (\"192.618.178.1\", \"192.618.178.1\"),\n+        (\" 192.618.178.1 \", \"192.618.178.1\"),\n+        (\" demo.host \", \"demo.host\"),\n+    ],\n )\n @pytest.mark.usefixtures(\"patch_setup\")\n-async def test_form(hass: HomeAssistant, host, expected_title) -> None:\n+async def test_form(hass: HomeAssistant, host, expected) -> None:\n     \"\"\"Test we get the form.\"\"\"\n \n     result = await hass.config_entries.flow.async_init(\n@@ -35,21 +39,25 @@ async def test_form(hass: HomeAssistant, host, expected_title) -> None:\n     await hass.async_block_till_done()\n \n     assert result[\"type\"] is FlowResultType.CREATE_ENTRY\n-    assert result[\"title\"] == expected_title\n+    assert result[\"title\"] == expected\n     assert result[\"data\"] == {}\n     assert result[\"options\"] == {\n         \"count\": 5,\n-        \"host\": host,\n+        \"host\": expected,\n         \"consider_home\": 180,\n     }\n \n \n @pytest.mark.parametrize(\n-    (\"host\", \"count\", \"expected_title\"),\n-    [(\"192.618.178.1\", 10, \"192.618.178.1\")],\n+    (\"host\", \"expected_host\"),\n+    [\n+        (\"192.618.178.1\", \"192.618.178.1\"),\n+        (\" 192.618.178.1 \", \"192.618.178.1\"),\n+        (\" demo.host \", \"demo.host\"),\n+    ],\n )\n @pytest.mark.usefixtures(\"patch_setup\")\n-async def test_options(hass: HomeAssistant, host, count, expected_title) -> None:\n+async def test_options(hass: HomeAssistant, host: str, expected_host: str) -> None:\n     \"\"\"Test options flow.\"\"\"\n \n     config_entry = MockConfigEntry(\n@@ -57,8 +65,8 @@ async def test_options(hass: HomeAssistant, host, count, expected_title) -> None\n         source=config_entries.SOURCE_USER,\n         data={},\n         domain=DOMAIN,\n-        options={\"count\": count, \"host\": host, \"consider_home\": 180},\n-        title=expected_title,\n+        options={\"count\": 1, \"host\": \"192.168.1.1\", \"consider_home\": 180},\n+        title=\"192.168.1.1\",\n     )\n     config_entry.add_to_hass(hass)\n \n@@ -72,15 +80,15 @@ async def test_options(hass: HomeAssistant, host, count, expected_title) -> None\n     result = await hass.config_entries.options.async_configure(\n         result[\"flow_id\"],\n         {\n-            \"host\": \"10.10.10.1\",\n-            \"count\": count,\n+            \"host\": host,\n+            \"count\": 10,\n         },\n     )\n     await hass.async_block_till_done()\n \n     assert result[\"type\"] is FlowResultType.CREATE_ENTRY\n     assert result[\"data\"] == {\n-        \"count\": count,\n-        \"host\": \"10.10.10.1\",\n+        \"count\": 10,\n+        \"host\": expected_host,\n         \"consider_home\": 180,\n     }\n", "problem_statement": "Whitespace in ping host causes ping to never be Connected state\n### The problem\n\nWhitespace in the ping host causes the ping integration to not work as expected, silently resulting in the Disconnected state forever. There is no other indication that the host is \"invalid\" as there are no errors messages etc. Easy to miss when looking at the Integration Entries IP address list, as the spaces don't show there (HTML will just eat up the spaces).\r\n\r\nThe white space can be before or after the host. Would be great to sanitise the input and remove any whitespace (spaces, tabs etc.) to prevent this silent problem from occurring, especially when it quite often creeps in during cut and paste operations or at least error/warn. \r\n\r\nNote: It is also currently possible to insert spaces in the host name and this doesn't throw up an error either.\n\n### What version of Home Assistant Core has the issue?\n\ncore-2024.11.2\n\n### What was the last working version of Home Assistant Core?\n\n_No response_\n\n### What type of installation are you running?\n\nHome Assistant OS\n\n### Integration causing the issue\n\nping\n\n### Link to integration documentation on our website\n\nhttps://www.home-assistant.io/integrations/ping\n\n### Diagnostics information\n\n_No response_\n\n### Example YAML snippet\n\n_No response_\n\n### Anything in the logs that might be useful for us?\n\n_No response_\n\n### Additional information\n\n_No response_\n", "hints_text": "\nHey there @jpbede, mind taking a look at this issue as it has been labeled with an integration (`ping`) you are listed as a [code owner](https://github.com/home-assistant/core/blob/dev/CODEOWNERS#L1120) for? Thanks!\n\n<details>\n<summary>Code owner commands</summary>\n\n\nCode owners of `ping` can trigger bot actions by commenting:\n\n- `@home-assistant close` Closes the issue.\n- `@home-assistant rename Awesome new title` Renames the issue.\n- `@home-assistant reopen` Reopen the issue.\n- `@home-assistant unassign ping` Removes the current integration label and assignees on the issue, add the integration domain after the command.\n- `@home-assistant add-label needs-more-information` Add a label (needs-more-information, problem in dependency, problem in custom component) to the issue.\n- `@home-assistant remove-label needs-more-information` Remove a label (needs-more-information, problem in dependency, problem in custom component) on the issue.\n\n</details>\n\n\n<sub><sup>(message by CodeOwnersMention)</sup></sub>\n\n---\n\n[ping documentation](https://www.home-assistant.io/integrations/ping)\n[ping source](https://github.com/home-assistant/core/tree/dev/homeassistant/components/ping)\n<sub><sup>(message by IssueLinks)</sup></sub>\nThank you for bringing this up again, I had completely forgotten about this but. I'll have a look at it tonight and prepare a fix for it.", "created_at": "2024-11-19T17:47:14Z"}
{"repo": "home-assistant/core", "pull_number": 130967, "instance_id": "home-assistant__core-130967", "issue_numbers": ["130762"], "base_commit": "42bba24247dab3af26d858a84e09613e09ed201d", "patch": "diff --git a/homeassistant/components/climate/strings.json b/homeassistant/components/climate/strings.json\nindex 26a06821d84e7e..f607419195e182 100644\n--- a/homeassistant/components/climate/strings.json\n+++ b/homeassistant/components/climate/strings.json\n@@ -161,19 +161,19 @@\n     },\n     \"set_temperature\": {\n       \"name\": \"Set target temperature\",\n-      \"description\": \"Sets target temperature.\",\n+      \"description\": \"Sets the temperature setpoint.\",\n       \"fields\": {\n         \"temperature\": {\n-          \"name\": \"Temperature\",\n-          \"description\": \"Target temperature.\"\n+          \"name\": \"Target temperature\",\n+          \"description\": \"The temperature setpoint.\"\n         },\n         \"target_temp_high\": {\n-          \"name\": \"Target temperature high\",\n-          \"description\": \"High target temperature.\"\n+          \"name\": \"Upper target temperature\",\n+          \"description\": \"The max temperature setpoint.\"\n         },\n         \"target_temp_low\": {\n-          \"name\": \"Target temperature low\",\n-          \"description\": \"Low target temperature.\"\n+          \"name\": \"Lower target temperature\",\n+          \"description\": \"The min temperature setpoint.\"\n         },\n         \"hvac_mode\": {\n           \"name\": \"HVAC mode\",\n", "test_patch": "", "problem_statement": "Climate: Improve descriptions of target temperatures in `set_temperature` action\n### The problem\r\n\r\nCurrently the descriptions of the `set_temperature` action and its different data attributes don't really explain anything but simply repeat the names in a different word order:\r\n\r\nhttps://github.com/home-assistant/core/blob/0ada59a4fedf2c2c1b35543857e627594b0dbd1b/homeassistant/components/climate/strings.json#L162-L176\r\n\r\nThis should be fixed by following [the explanations from the documentation](https://www.home-assistant.io/integrations/climate/#action-climateset_temperature):\r\n\r\n    New target temperature for climate device (commonly referred to as a setpoint).\r\n\r\n    The highest temperature that the climate device will allow. \r\n\r\n    The lowest temperature that the climate device will allow.\r\n\r\nAnd by using the labels defined in the `entity component`section of the file:\r\n\r\nhttps://github.com/home-assistant/core/blob/b1260dc4ece301fc4b753428a839c733c6b66d25/homeassistant/components/climate/strings.json#L126-L136\r\n\r\nCombined this becomes:\r\n\r\n    Target temperature\r\n    The setpoint for the climate device.\r\n\r\n    Upper target temperature\r\n    The highest temperature that the climate device will allow.\r\n\r\n    Lower target temperature\r\n    The lowest temperature that the climate device will allow.\r\n\r\n\r\nWith these three strings I also know how to properly translate that into German. ;-)\r\n\r\n### What version of Home Assistant Core has the issue?\r\n\r\ncore-2024.11.2\r\n\r\n### Integration causing the issue\r\n\r\nClimate\r\n\r\n### Link to integration documentation on our website\r\n\r\nhttps://www.home-assistant.io/integrations/climate/\r\n\n", "hints_text": "\nHey there @home-assistant/core, mind taking a look at this issue as it has been labeled with an integration (`climate`) you are listed as a [code owner](https://github.com/home-assistant/core/blob/dev/CODEOWNERS#L259) for? Thanks!\n\n<details>\n<summary>Code owner commands</summary>\n\n\nCode owners of `climate` can trigger bot actions by commenting:\n\n- `@home-assistant close` Closes the issue.\n- `@home-assistant rename Awesome new title` Renames the issue.\n- `@home-assistant reopen` Reopen the issue.\n- `@home-assistant unassign climate` Removes the current integration label and assignees on the issue, add the integration domain after the command.\n- `@home-assistant add-label needs-more-information` Add a label (needs-more-information, problem in dependency, problem in custom component) to the issue.\n- `@home-assistant remove-label needs-more-information` Remove a label (needs-more-information, problem in dependency, problem in custom component) on the issue.\n\n</details>\n\n\n<sub><sup>(message by CodeOwnersMention)</sup></sub>\n\n---\n\n[climate documentation](https://www.home-assistant.io/integrations/climate)\n[climate source](https://github.com/home-assistant/core/tree/dev/homeassistant/components/climate)\n<sub><sup>(message by IssueLinks)</sup></sub>", "created_at": "2024-11-19T16:22:42Z"}
{"repo": "home-assistant/core", "pull_number": 130963, "instance_id": "home-assistant__core-130963", "issue_numbers": ["130344", "130344"], "base_commit": "48703db78a9458739819d9062f1b7ec4f4931352", "patch": "diff --git a/homeassistant/components/airq/manifest.json b/homeassistant/components/airq/manifest.json\nindex 2b23928aba87d7..1ae7da14875323 100644\n--- a/homeassistant/components/airq/manifest.json\n+++ b/homeassistant/components/airq/manifest.json\n@@ -7,5 +7,5 @@\n   \"integration_type\": \"hub\",\n   \"iot_class\": \"local_polling\",\n   \"loggers\": [\"aioairq\"],\n-  \"requirements\": [\"aioairq==0.3.2\"]\n+  \"requirements\": [\"aioairq==0.4.3\"]\n }\ndiff --git a/requirements_all.txt b/requirements_all.txt\nindex 5d9e8b9b4f1332..59f3da1ee899a1 100644\n--- a/requirements_all.txt\n+++ b/requirements_all.txt\n@@ -176,7 +176,7 @@ aio-georss-gdacs==0.10\n aioacaia==0.1.6\n \n # homeassistant.components.airq\n-aioairq==0.3.2\n+aioairq==0.4.3\n \n # homeassistant.components.airzone_cloud\n aioairzone-cloud==0.6.10\n", "test_patch": "diff --git a/requirements_test_all.txt b/requirements_test_all.txt\nindex dd6ecb1c30e0aa..089b53ebd60cae 100644\n--- a/requirements_test_all.txt\n+++ b/requirements_test_all.txt\n@@ -164,7 +164,7 @@ aio-georss-gdacs==0.10\n aioacaia==0.1.6\n \n # homeassistant.components.airq\n-aioairq==0.3.2\n+aioairq==0.4.3\n \n # homeassistant.components.airzone_cloud\n aioairzone-cloud==0.6.10\n", "problem_statement": "Missing PM entities from airQ radon science additional sensor\n### The problem\n\nHi! I recently aquired two airQ devices: an airQ pro and an [airQ radon science with additional sensors (CO2 + PM)](https://shop.air-q.com/air-Q-radon-science-air-analyser-5-sensors-science-option-additional-CO2-and-PM-sensor)\r\n\r\nThe only entities missing from these two devices are the PM entities on the radon science, everything else works well.\r\n\r\nOf note:\r\n\r\n- airQ radon science PM data shows up on the airQ mobile app, so the sensor is working and the device has access to this data\r\n- the airQ radon science has two additional sensors: CO2 and PM. CO2 is available as an entity in HA so the issue doesn't seem to lie with the fact that the PM sensor is \"additional\"\r\n\r\nIf there is anything I can do on my end to help the investigation, let me know, I'm new to HA so this post is probably missing some important tidbits.\n\n### What version of Home Assistant Core has the issue?\n\ncore-2024.11.1\n\n### What was the last working version of Home Assistant Core?\n\n_No response_\n\n### What type of installation are you running?\n\nHome Assistant OS\n\n### Integration causing the issue\n\nairq\n\n### Link to integration documentation on our website\n\nhttps://www.home-assistant.io/integrations/airq\n\n### Diagnostics information\n\nDebug logging did not show anything interesting (only success info).\n\n### Example YAML snippet\n\n_No response_\n\n### Anything in the logs that might be useful for us?\n\n_No response_\n\n### Additional information\n\n_No response_\nMissing PM entities from airQ radon science additional sensor\n### The problem\n\nHi! I recently aquired two airQ devices: an airQ pro and an [airQ radon science with additional sensors (CO2 + PM)](https://shop.air-q.com/air-Q-radon-science-air-analyser-5-sensors-science-option-additional-CO2-and-PM-sensor)\r\n\r\nThe only entities missing from these two devices are the PM entities on the radon science, everything else works well.\r\n\r\nOf note:\r\n\r\n- airQ radon science PM data shows up on the airQ mobile app, so the sensor is working and the device has access to this data\r\n- the airQ radon science has two additional sensors: CO2 and PM. CO2 is available as an entity in HA so the issue doesn't seem to lie with the fact that the PM sensor is \"additional\"\r\n\r\nIf there is anything I can do on my end to help the investigation, let me know, I'm new to HA so this post is probably missing some important tidbits.\n\n### What version of Home Assistant Core has the issue?\n\ncore-2024.11.1\n\n### What was the last working version of Home Assistant Core?\n\n_No response_\n\n### What type of installation are you running?\n\nHome Assistant OS\n\n### Integration causing the issue\n\nairq\n\n### Link to integration documentation on our website\n\nhttps://www.home-assistant.io/integrations/airq\n\n### Diagnostics information\n\nDebug logging did not show anything interesting (only success info).\n\n### Example YAML snippet\n\n_No response_\n\n### Anything in the logs that might be useful for us?\n\n_No response_\n\n### Additional information\n\n_No response_\n", "hints_text": "\nHey there @sibgatulin, @dl2080, mind taking a look at this issue as it has been labeled with an integration (`airq`) you are listed as a [code owner](https://github.com/home-assistant/core/blob/dev/CODEOWNERS#L66) for? Thanks!\n\n<details>\n<summary>Code owner commands</summary>\n\n\nCode owners of `airq` can trigger bot actions by commenting:\n\n- `@home-assistant close` Closes the issue.\n- `@home-assistant rename Awesome new title` Renames the issue.\n- `@home-assistant reopen` Reopen the issue.\n- `@home-assistant unassign airq` Removes the current integration label and assignees on the issue, add the integration domain after the command.\n- `@home-assistant add-label needs-more-information` Add a label (needs-more-information, problem in dependency, problem in custom component) to the issue.\n- `@home-assistant remove-label needs-more-information` Remove a label (needs-more-information, problem in dependency, problem in custom component) on the issue.\n\n</details>\n\n\n<sub><sup>(message by CodeOwnersMention)</sup></sub>\n\n---\n\n[airq documentation](https://www.home-assistant.io/integrations/airq)\n[airq source](https://github.com/home-assistant/core/tree/dev/homeassistant/components/airq)\n<sub><sup>(message by IssueLinks)</sup></sub>\nHi @pioul , thanks for reporting. There is [a PR](https://github.com/home-assistant/core/pull/130026) in progress addressing precisely this. We'll try to address it this week \ud83d\udc4c and I'll update the issue as soon as there is anything new\n@Sibgatulin That is the best reply anyone opening an issue can ever hope for lol, awesome to hear you're already on it! \ud83e\udd73\n\nHey there @sibgatulin, @dl2080, mind taking a look at this issue as it has been labeled with an integration (`airq`) you are listed as a [code owner](https://github.com/home-assistant/core/blob/dev/CODEOWNERS#L66) for? Thanks!\n\n<details>\n<summary>Code owner commands</summary>\n\n\nCode owners of `airq` can trigger bot actions by commenting:\n\n- `@home-assistant close` Closes the issue.\n- `@home-assistant rename Awesome new title` Renames the issue.\n- `@home-assistant reopen` Reopen the issue.\n- `@home-assistant unassign airq` Removes the current integration label and assignees on the issue, add the integration domain after the command.\n- `@home-assistant add-label needs-more-information` Add a label (needs-more-information, problem in dependency, problem in custom component) to the issue.\n- `@home-assistant remove-label needs-more-information` Remove a label (needs-more-information, problem in dependency, problem in custom component) on the issue.\n\n</details>\n\n\n<sub><sup>(message by CodeOwnersMention)</sup></sub>\n\n---\n\n[airq documentation](https://www.home-assistant.io/integrations/airq)\n[airq source](https://github.com/home-assistant/core/tree/dev/homeassistant/components/airq)\n<sub><sup>(message by IssueLinks)</sup></sub>\nHi @pioul , thanks for reporting. There is [a PR](https://github.com/home-assistant/core/pull/130026) in progress addressing precisely this. We'll try to address it this week \ud83d\udc4c and I'll update the issue as soon as there is anything new\n@Sibgatulin That is the best reply anyone opening an issue can ever hope for lol, awesome to hear you're already on it! \ud83e\udd73", "created_at": "2024-11-19T15:57:15Z"}
{"repo": "home-assistant/core", "pull_number": 130954, "instance_id": "home-assistant__core-130954", "issue_numbers": ["130878"], "base_commit": "7dc2102545bd09299e90055a3d87b3fc1fa34a70", "patch": "diff --git a/homeassistant/components/husqvarna_automower/strings.json b/homeassistant/components/husqvarna_automower/strings.json\nindex 0f06e9c521e6b9..50048d19c457c5 100644\n--- a/homeassistant/components/husqvarna_automower/strings.json\n+++ b/homeassistant/components/husqvarna_automower/strings.json\n@@ -314,7 +314,7 @@\n   \"issues\": {\n     \"deprecated_entity\": {\n       \"title\": \"The Husqvarna Automower {entity_name} sensor is deprecated\",\n-      \"description\": \"The Husqavarna Automower entity `{entity}` is deprecated and will be removed in a future release.\\nYou can use the new returning state of the lawn mower entity instead.\\nPlease update your automations and scripts to replace the sensor entity with the newly added todo entity.\\nWhen you are done migrating you can disable `{entity}`.\"\n+      \"description\": \"The Husqvarna Automower entity `{entity}` is deprecated and will be removed in a future release.\\nYou can use the new returning state of the lawn mower entity instead.\\nPlease update your automations and scripts to replace the sensor entity with the newly added todo entity.\\nWhen you are done migrating you can disable `{entity}`.\"\n     }\n   },\n   \"services\": {\n", "test_patch": "", "problem_statement": "Husqvarna Automower: Typo in `deprecated_entity::description`\n### The problem\r\n\r\nThere is a typo (one \"a\" too many) in:\r\n\r\nhttps://github.com/home-assistant/core/blob/efa86293aa47f8f7b5395cd0b48f72ea8002b674/homeassistant/components/husqvarna_automower/strings.json#L317\r\n\r\nShould be\r\n\r\n    The Husqvarna Automower entity \u2026\r\n\r\n\r\n\r\n### What version of Home Assistant Core has the issue?\r\n\r\ncore-2024.11.2\r\n\r\n### Integration causing the issue\r\n\r\nHusqavarna Automower\r\n\r\n### Link to integration documentation on our website\r\n\r\nhttps://www.home-assistant.io/integrations/husqvarna_automower/\r\n\n", "hints_text": "\nHey there @thomas55555, mind taking a look at this issue as it has been labeled with an integration (`husqvarna_automower`) you are listed as a [code owner](https://github.com/home-assistant/core/blob/dev/CODEOWNERS#L662) for? Thanks!\n\n<details>\n<summary>Code owner commands</summary>\n\n\nCode owners of `husqvarna_automower` can trigger bot actions by commenting:\n\n- `@home-assistant close` Closes the issue.\n- `@home-assistant rename Awesome new title` Renames the issue.\n- `@home-assistant reopen` Reopen the issue.\n- `@home-assistant unassign husqvarna_automower` Removes the current integration label and assignees on the issue, add the integration domain after the command.\n- `@home-assistant add-label needs-more-information` Add a label (needs-more-information, problem in dependency, problem in custom component) to the issue.\n- `@home-assistant remove-label needs-more-information` Remove a label (needs-more-information, problem in dependency, problem in custom component) on the issue.\n\n</details>\n\n\n<sub><sup>(message by CodeOwnersMention)</sup></sub>\n\n---\n\n[husqvarna_automower documentation](https://www.home-assistant.io/integrations/husqvarna_automower)\n[husqvarna_automower source](https://github.com/home-assistant/core/tree/dev/homeassistant/components/husqvarna_automower)\n<sub><sup>(message by IssueLinks)</sup></sub>", "created_at": "2024-11-19T14:13:31Z"}
{"repo": "home-assistant/core", "pull_number": 130917, "instance_id": "home-assistant__core-130917", "issue_numbers": ["131216"], "base_commit": "158b0c8ce2722c591522015c1d947dc6640e89c4", "patch": "diff --git a/homeassistant/components/elmax/manifest.json b/homeassistant/components/elmax/manifest.json\nindex c57b707906b35e..efa97a9f6b958b 100644\n--- a/homeassistant/components/elmax/manifest.json\n+++ b/homeassistant/components/elmax/manifest.json\n@@ -6,7 +6,7 @@\n   \"documentation\": \"https://www.home-assistant.io/integrations/elmax\",\n   \"iot_class\": \"cloud_polling\",\n   \"loggers\": [\"elmax_api\"],\n-  \"requirements\": [\"elmax-api==0.0.5\"],\n+  \"requirements\": [\"elmax-api==0.0.6.1\"],\n   \"zeroconf\": [\n     {\n       \"type\": \"_elmax-ssl._tcp.local.\"\ndiff --git a/requirements_all.txt b/requirements_all.txt\nindex 0a4b66f18ce749..90246a9a94695d 100644\n--- a/requirements_all.txt\n+++ b/requirements_all.txt\n@@ -824,7 +824,7 @@ eliqonline==1.2.2\n elkm1-lib==2.2.10\n \n # homeassistant.components.elmax\n-elmax-api==0.0.5\n+elmax-api==0.0.6.1\n \n # homeassistant.components.elvia\n elvia==0.1.0\n", "test_patch": "diff --git a/requirements_test_all.txt b/requirements_test_all.txt\nindex 56f67f8541a7aa..b57ee79bd0eae5 100644\n--- a/requirements_test_all.txt\n+++ b/requirements_test_all.txt\n@@ -699,7 +699,7 @@ elgato==5.1.2\n elkm1-lib==2.2.10\n \n # homeassistant.components.elmax\n-elmax-api==0.0.5\n+elmax-api==0.0.6.1\n \n # homeassistant.components.elvia\n elvia==0.1.0\n", "problem_statement": "Elmax API Websocket connection error\n### The problem\n\nThe current version of elmax addon relies on an outdated version of elmax-api, which uses websockets 12+. Last HA core has upgraded the version to 13.X which is not compatible with websockets 12.X (some function named parameters were renamed).\n\n### What version of Home Assistant Core has the issue?\n\ncore-2024.11.2\n\n### What was the last working version of Home Assistant Core?\n\n_No response_\n\n### What type of installation are you running?\n\nHome Assistant OS\n\n### Integration causing the issue\n\nelmax\n\n### Link to integration documentation on our website\n\n_No response_\n\n### Diagnostics information\n\n![image](https://github.com/user-attachments/assets/961ed54b-4687-4a08-b68b-5f31c8475f4f)\r\n\n\n### Example YAML snippet\n\n_No response_\n\n### Anything in the logs that might be useful for us?\n\n_No response_\n\n### Additional information\n\n_No response_\n", "hints_text": "", "created_at": "2024-11-18T22:54:28Z"}
{"repo": "home-assistant/core", "pull_number": 130903, "instance_id": "home-assistant__core-130903", "issue_numbers": ["124318"], "base_commit": "e48857987bbd96c21b3fc13f6abeae6895173ae7", "patch": "diff --git a/homeassistant/components/google_travel_time/sensor.py b/homeassistant/components/google_travel_time/sensor.py\nindex 618dda50bd4aa..a764036321b5a 100644\n--- a/homeassistant/components/google_travel_time/sensor.py\n+++ b/homeassistant/components/google_travel_time/sensor.py\n@@ -7,6 +7,7 @@\n \n from googlemaps import Client\n from googlemaps.distance_matrix import distance_matrix\n+from googlemaps.exceptions import ApiError, Timeout, TransportError\n \n from homeassistant.components.sensor import (\n     SensorDeviceClass,\n@@ -172,9 +173,13 @@ def update(self) -> None:\n             self._resolved_destination,\n         )\n         if self._resolved_destination is not None and self._resolved_origin is not None:\n-            self._matrix = distance_matrix(\n-                self._client,\n-                self._resolved_origin,\n-                self._resolved_destination,\n-                **options_copy,\n-            )\n+            try:\n+                self._matrix = distance_matrix(\n+                    self._client,\n+                    self._resolved_origin,\n+                    self._resolved_destination,\n+                    **options_copy,\n+                )\n+            except (ApiError, TransportError, Timeout) as ex:\n+                _LOGGER.error(\"Error getting travel time: %s\", ex)\n+                self._matrix = None\n", "test_patch": "diff --git a/tests/components/google_travel_time/test_sensor.py b/tests/components/google_travel_time/test_sensor.py\nindex 5ac9ecad4828b..9ee6ebbbc7b06 100644\n--- a/tests/components/google_travel_time/test_sensor.py\n+++ b/tests/components/google_travel_time/test_sensor.py\n@@ -3,6 +3,7 @@\n from collections.abc import Generator\n from unittest.mock import MagicMock, patch\n \n+from googlemaps.exceptions import ApiError, Timeout, TransportError\n import pytest\n \n from homeassistant.components.google_travel_time.config_flow import default_options\n@@ -13,7 +14,9 @@\n     UNITS_IMPERIAL,\n     UNITS_METRIC,\n )\n+from homeassistant.components.google_travel_time.sensor import SCAN_INTERVAL\n from homeassistant.core import HomeAssistant\n+from homeassistant.util import dt as dt_util\n from homeassistant.util.unit_system import (\n     METRIC_SYSTEM,\n     US_CUSTOMARY_SYSTEM,\n@@ -22,7 +25,7 @@\n \n from .const import MOCK_CONFIG\n \n-from tests.common import MockConfigEntry\n+from tests.common import MockConfigEntry, async_fire_time_changed\n \n \n @pytest.fixture(name=\"mock_update\")\n@@ -240,3 +243,25 @@ async def test_sensor_unit_system(\n \n     distance_matrix_mock.assert_called_once()\n     assert distance_matrix_mock.call_args.kwargs[\"units\"] == expected_unit_option\n+\n+\n+@pytest.mark.parametrize(\n+    (\"exception\"),\n+    [(ApiError), (TransportError), (Timeout)],\n+)\n+@pytest.mark.parametrize(\n+    (\"data\", \"options\"),\n+    [(MOCK_CONFIG, {})],\n+)\n+async def test_sensor_exception(\n+    hass: HomeAssistant,\n+    caplog: pytest.LogCaptureFixture,\n+    mock_update: MagicMock,\n+    mock_config: MagicMock,\n+    exception: Exception,\n+) -> None:\n+    \"\"\"Test that exception gets caught.\"\"\"\n+    mock_update.side_effect = exception(\"Errormessage\")\n+    async_fire_time_changed(hass, dt_util.utcnow() + SCAN_INTERVAL)\n+    await hass.async_block_till_done()\n+    assert \"Error getting travel time\" in caplog.text\n", "problem_statement": "Google maps travel distance is taking more than 10 sec then fails\n### The problem\n\nseveral error logs from google maps integration: \"ERROR (MainThread) [homeassistant.helpers.entity] Update for sensor.xxxxx fails\"\n\n### What version of Home Assistant Core has the issue?\n\ncore-2024.8.2\n\n### What was the last working version of Home Assistant Core?\n\n_No response_\n\n### What type of installation are you running?\n\nHome Assistant Supervised\n\n### Integration causing the issue\n\nGoogle Maps\n\n### Link to integration documentation on our website\n\nhttps://www.home-assistant.io/integrations/google_travel_time\n\n### Diagnostics information\n\n[home-assistant_google_travel_time_2024-08-20T16-49-14.653Z.log](https://github.com/user-attachments/files/16679144/home-assistant_google_travel_time_2024-08-20T16-49-14.653Z.log)\r\n\n\n### Example YAML snippet\n\n_No response_\n\n### Anything in the logs that might be useful for us?\n\n```txt\n2024-08-20 19:32:11.197 WARNING (MainThread) [homeassistant.helpers.entity] Update of sensor.mirela_driving_home_time is taking over 10 seconds\r\n2024-08-20 19:33:14.065 ERROR (MainThread) [homeassistant.helpers.entity] Update for sensor.mirela_driving_home_time fails\r\nTraceback (most recent call last):\r\n  File \"/usr/local/lib/python3.12/site-packages/googlemaps/client.py\", line 253, in _request\r\n    result = self._get_body(response)\r\n             ^^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/local/lib/python3.12/site-packages/googlemaps/client.py\", line 276, in _get_body\r\n    raise googlemaps.exceptions._RetriableRequest()\r\ngooglemaps.exceptions._RetriableRequest\r\n\r\nDuring handling of the above exception, another exception occurred:\r\n\r\nTraceback (most recent call last):\r\n  File \"/usr/local/lib/python3.12/site-packages/googlemaps/client.py\", line 253, in _request\r\n    result = self._get_body(response)\r\n             ^^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/local/lib/python3.12/site-packages/googlemaps/client.py\", line 276, in _get_body\r\n    raise googlemaps.exceptions._RetriableRequest()\r\ngooglemaps.exceptions._RetriableRequest\r\n\r\nDuring handling of the above exception, another exception occurred:\r\n\r\nTraceback (most recent call last):\r\n  File \"/usr/local/lib/python3.12/site-packages/googlemaps/client.py\", line 253, in _request\r\n    result = self._get_body(response)\r\n             ^^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/local/lib/python3.12/site-packages/googlemaps/client.py\", line 276, in _get_body\r\n    raise googlemaps.exceptions._RetriableRequest()\r\ngooglemaps.exceptions._RetriableRequest\r\n\r\nDuring handling of the above exception, another exception occurred:\r\n\r\nTraceback (most recent call last):\r\n  File \"/usr/local/lib/python3.12/site-packages/googlemaps/client.py\", line 253, in _request\r\n    result = self._get_body(response)\r\n             ^^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/local/lib/python3.12/site-packages/googlemaps/client.py\", line 276, in _get_body\r\n    raise googlemaps.exceptions._RetriableRequest()\r\ngooglemaps.exceptions._RetriableRequest\r\n\r\nDuring handling of the above exception, another exception occurred:\r\n\r\nTraceback (most recent call last):\r\n  File \"/usr/local/lib/python3.12/site-packages/googlemaps/client.py\", line 253, in _request\r\n    result = self._get_body(response)\r\n             ^^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/local/lib/python3.12/site-packages/googlemaps/client.py\", line 276, in _get_body\r\n    raise googlemaps.exceptions._RetriableRequest()\r\ngooglemaps.exceptions._RetriableRequest\r\n\r\nDuring handling of the above exception, another exception occurred:\r\n\r\nTraceback (most recent call last):\r\n  File \"/usr/local/lib/python3.12/site-packages/googlemaps/client.py\", line 253, in _request\r\n    result = self._get_body(response)\r\n             ^^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/local/lib/python3.12/site-packages/googlemaps/client.py\", line 276, in _get_body\r\n    raise googlemaps.exceptions._RetriableRequest()\r\ngooglemaps.exceptions._RetriableRequest\r\n\r\nDuring handling of the above exception, another exception occurred:\r\n\r\nTraceback (most recent call last):\r\n  File \"/usr/local/lib/python3.12/site-packages/googlemaps/client.py\", line 253, in _request\r\n    result = self._get_body(response)\r\n             ^^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/local/lib/python3.12/site-packages/googlemaps/client.py\", line 276, in _get_body\r\n    raise googlemaps.exceptions._RetriableRequest()\r\ngooglemaps.exceptions._RetriableRequest\r\n\r\nDuring handling of the above exception, another exception occurred:\r\n\r\nTraceback (most recent call last):\r\n  File \"/usr/local/lib/python3.12/site-packages/googlemaps/client.py\", line 253, in _request\r\n    result = self._get_body(response)\r\n             ^^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/local/lib/python3.12/site-packages/googlemaps/client.py\", line 276, in _get_body\r\n    raise googlemaps.exceptions._RetriableRequest()\r\ngooglemaps.exceptions._RetriableRequest\r\n\r\nDuring handling of the above exception, another exception occurred:\r\n\r\nTraceback (most recent call last):\r\n  File \"/usr/local/lib/python3.12/site-packages/googlemaps/client.py\", line 253, in _request\r\n    result = self._get_body(response)\r\n             ^^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/local/lib/python3.12/site-packages/googlemaps/client.py\", line 276, in _get_body\r\n    raise googlemaps.exceptions._RetriableRequest()\r\ngooglemaps.exceptions._RetriableRequest\r\n\r\nDuring handling of the above exception, another exception occurred:\r\n\r\nTraceback (most recent call last):\r\n  File \"/usr/local/lib/python3.12/site-packages/googlemaps/client.py\", line 253, in _request\r\n    result = self._get_body(response)\r\n             ^^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/local/lib/python3.12/site-packages/googlemaps/client.py\", line 276, in _get_body\r\n    raise googlemaps.exceptions._RetriableRequest()\r\ngooglemaps.exceptions._RetriableRequest\r\n\r\nDuring handling of the above exception, another exception occurred:\r\n\r\nTraceback (most recent call last):\r\n  File \"/usr/local/lib/python3.12/site-packages/googlemaps/client.py\", line 253, in _request\r\n    result = self._get_body(response)\r\n             ^^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/local/lib/python3.12/site-packages/googlemaps/client.py\", line 276, in _get_body\r\n    raise googlemaps.exceptions._RetriableRequest()\r\ngooglemaps.exceptions._RetriableRequest\r\n\r\nDuring handling of the above exception, another exception occurred:\r\n\r\nTraceback (most recent call last):\r\n  File \"/usr/src/homeassistant/homeassistant/helpers/entity.py\", line 942, in async_update_ha_state\r\n    await self.async_device_update()\r\n  File \"/usr/src/homeassistant/homeassistant/helpers/entity.py\", line 1302, in async_device_update\r\n    await hass.async_add_executor_job(self.update)\r\n  File \"/usr/local/lib/python3.12/concurrent/futures/thread.py\", line 58, in run\r\n    result = self.fn(*self.args, **self.kwargs)\r\n             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/src/homeassistant/homeassistant/components/google_travel_time/sensor.py\", line 175, in update\r\n    self._matrix = distance_matrix(\r\n                   ^^^^^^^^^^^^^^^^\r\n  File \"/usr/local/lib/python3.12/site-packages/googlemaps/distance_matrix.py\", line 130, in distance_matrix\r\n    return client._request(\"/maps/api/distancematrix/json\", params)\r\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/local/lib/python3.12/site-packages/googlemaps/client.py\", line 258, in _request\r\n    return self._request(url, params, first_request_time,\r\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/local/lib/python3.12/site-packages/googlemaps/client.py\", line 258, in _request\r\n    return self._request(url, params, first_request_time,\r\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/local/lib/python3.12/site-packages/googlemaps/client.py\", line 258, in _request\r\n    return self._request(url, params, first_request_time,\r\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n  [Previous line repeated 8 more times]\r\n  File \"/usr/local/lib/python3.12/site-packages/googlemaps/client.py\", line 203, in _request\r\n    raise googlemaps.exceptions.Timeout()\r\ngooglemaps.exceptions.Timeout\n```\n\n\n### Additional information\n\n_No response_\n", "hints_text": "\nHey there @eifinger, mind taking a look at this issue as it has been labeled with an integration (`google_travel_time`) you are listed as a [code owner](https://github.com/home-assistant/core/blob/dev/CODEOWNERS#L559) for? Thanks!\n\n<details>\n<summary>Code owner commands</summary>\n\n\nCode owners of `google_travel_time` can trigger bot actions by commenting:\n\n- `@home-assistant close` Closes the issue.\n- `@home-assistant rename Awesome new title` Renames the issue.\n- `@home-assistant reopen` Reopen the issue.\n- `@home-assistant unassign google_travel_time` Removes the current integration label and assignees on the issue, add the integration domain after the command.\n- `@home-assistant add-label needs-more-information` Add a label (needs-more-information, problem in dependency, problem in custom component) to the issue.\n- `@home-assistant remove-label needs-more-information` Remove a label (needs-more-information, problem in dependency, problem in custom component) on the issue.\n\n</details>\n\n\n<sub><sup>(message by CodeOwnersMention)</sup></sub>\n\n---\n\n[google_travel_time documentation](https://www.home-assistant.io/integrations/google_travel_time)\n[google_travel_time source](https://github.com/home-assistant/core/tree/dev/homeassistant/components/google_travel_time)\n<sub><sup>(message by IssueLinks)</sup></sub>\nThere hasn't been any activity on this issue recently. Due to the high number of incoming GitHub notifications, we have to clean some of the old issues, as many of them have already been resolved with the latest updates.\nPlease make sure to update to the latest Home Assistant version and check if that solves the issue. Let us know if that works for you by adding a comment \ud83d\udc4d\nThis issue has now been marked as stale and will be closed if no further activity occurs. Thank you for your contributions.", "created_at": "2024-11-18T19:41:44Z"}
{"repo": "home-assistant/core", "pull_number": 130900, "instance_id": "home-assistant__core-130900", "issue_numbers": ["130807"], "base_commit": "52887759410e72b27c1ad755555c27b9c9091826", "patch": "diff --git a/homeassistant/components/myuplink/strings.json b/homeassistant/components/myuplink/strings.json\nindex 9ec5c355d7820e..997c6fe54b6a35 100644\n--- a/homeassistant/components/myuplink/strings.json\n+++ b/homeassistant/components/myuplink/strings.json\n@@ -1,6 +1,6 @@\n {\n   \"application_credentials\": {\n-    \"description\": \"Follow the [instructions]({more_info_url}) to give Home Assistant access to your myUplink account. You also need to create application credentials linked to your account:\\n1. Go to [Applications at myUplink developer site]({create_creds_url}) and get credentials from an existing application or select **Create New Application**.\\n1. Set appropriate Application name and Description\\n2. Enter `{callback_url}` as Callback Url\"\n+    \"description\": \"Follow the [instructions]({more_info_url}) to give Home Assistant access to your myUplink account. You also need to create application credentials linked to your account:\\n1. Go to [Applications at myUplink developer site]({create_creds_url}) and get credentials from an existing application or select **Create New Application**.\\n1. Set appropriate Application name and Description\\n1. Enter `{callback_url}` as Callback URL\"\n   },\n   \"config\": {\n     \"step\": {\n", "test_patch": "", "problem_statement": "myUplink: Small inaccuracy in `description` string\n### The problem\r\n\r\nThe description string at\r\n\r\nhttps://github.com/home-assistant/core/blob/db3d3854478086292e98a57af9522f79dc75eede/homeassistant/components/myuplink/strings.json#L2-L3\r\n\r\ncurrently looks like this:\r\n\r\n```\r\nFollow the [instructions]({more_info_url}) to give Home Assistant access to your myUplink account. You also need to create application credentials linked to your account:\r\n1. Go to [Applications at myUplink developer site]({create_creds_url}) and get credentials from an existing application or select **Create New Application**.\r\n1. Set appropriate Application name and Description\r\n2. Enter `{callback_url}` as Callback Url\r\n```\r\n\r\nAs you can see the numbering is a bit confusing with 1., 1., 2.\r\n\r\nIt does not show up in the UI as this is rendered correctly as 1., 2., 3.\r\n\r\n![image](https://github.com/user-attachments/assets/2e3398eb-d3c8-4300-b7e2-0c6c67a4ed40)\r\n\r\nbut for us translators this is confusing.\r\n\r\nBest if you changed the last \"2.\" to a \"1.\" as well so we know that we can keep that in translations.\r\n\r\nAnd while we're at it: Also fix that wrong \"Url\" - should be \"URL\":\r\n\r\n    1. Enter `{callback_url}` as Callback URL\r\n\r\n\r\n### What version of Home Assistant Core has the issue?\r\n\r\ncore-2024.11.2\r\n\r\n### Integration causing the issue\r\n\r\nmyUplink\r\n\r\n### Link to integration documentation on our website\r\n\r\nhttps://www.home-assistant.io/integrations/myuplink/\r\n\r\n\n", "hints_text": "\nHey there @pajzo, @astrandb, mind taking a look at this issue as it has been labeled with an integration (`myuplink`) you are listed as a [code owner](https://github.com/home-assistant/core/blob/dev/CODEOWNERS#L969) for? Thanks!\n\n<details>\n<summary>Code owner commands</summary>\n\n\nCode owners of `myuplink` can trigger bot actions by commenting:\n\n- `@home-assistant close` Closes the issue.\n- `@home-assistant rename Awesome new title` Renames the issue.\n- `@home-assistant reopen` Reopen the issue.\n- `@home-assistant unassign myuplink` Removes the current integration label and assignees on the issue, add the integration domain after the command.\n- `@home-assistant add-label needs-more-information` Add a label (needs-more-information, problem in dependency, problem in custom component) to the issue.\n- `@home-assistant remove-label needs-more-information` Remove a label (needs-more-information, problem in dependency, problem in custom component) on the issue.\n\n</details>\n\n\n<sub><sup>(message by CodeOwnersMention)</sup></sub>\n\n---\n\n[myuplink documentation](https://www.home-assistant.io/integrations/myuplink)\n[myuplink source](https://github.com/home-assistant/core/tree/dev/homeassistant/components/myuplink)\n<sub><sup>(message by IssueLinks)</sup></sub>\nMind if I make the quick fix? It should just be this, right?\r\n\r\n```\r\n\"application_credentials\": {\r\n    \"description\": \"Follow the [instructions]({more_info_url}) to give Home Assistant access to your myUplink account. You also need to create application credentials linked to your account:\\n1. Go to [Applications at myUplink developer site]({create_creds_url}) and get credentials from an existing application or select **Create New Application**.\\n1. Set appropriate Application name and Description\\n1. Enter `{callback_url}` as Callback URL\"\r\n  }\r\n```\nLooks good\nCorrect! @CharlesYuan02  Will you submit a PR?\nOf course!", "created_at": "2024-11-18T19:09:19Z"}
{"repo": "home-assistant/core", "pull_number": 130896, "instance_id": "home-assistant__core-130896", "issue_numbers": ["129802"], "base_commit": "a37953512708a9a569fdd119ec478132ca060e54", "patch": "diff --git a/homeassistant/components/mill/sensor.py b/homeassistant/components/mill/sensor.py\nindex 64b9008a82b81..c4b975ab03973 100644\n--- a/homeassistant/components/mill/sensor.py\n+++ b/homeassistant/components/mill/sensor.py\n@@ -57,6 +57,19 @@\n         native_unit_of_measurement=UnitOfEnergy.KILO_WATT_HOUR,\n         state_class=SensorStateClass.TOTAL_INCREASING,\n     ),\n+    SensorEntityDescription(\n+        key=\"current_power\",\n+        translation_key=\"current_power\",\n+        device_class=SensorDeviceClass.POWER,\n+        native_unit_of_measurement=UnitOfPower.WATT,\n+        state_class=SensorStateClass.MEASUREMENT,\n+    ),\n+    SensorEntityDescription(\n+        key=\"control_signal\",\n+        translation_key=\"control_signal\",\n+        native_unit_of_measurement=PERCENTAGE,\n+        state_class=SensorStateClass.MEASUREMENT,\n+    ),\n )\n \n SENSOR_TYPES: tuple[SensorEntityDescription, ...] = (\n@@ -118,6 +131,16 @@\n     ),\n )\n \n+SOCKET_SENSOR_TYPES: tuple[SensorEntityDescription, ...] = (\n+    SensorEntityDescription(\n+        key=HUMIDITY,\n+        device_class=SensorDeviceClass.HUMIDITY,\n+        native_unit_of_measurement=PERCENTAGE,\n+        state_class=SensorStateClass.MEASUREMENT,\n+    ),\n+    *HEATER_SENSOR_TYPES,\n+)\n+\n \n async def async_setup_entry(\n     hass: HomeAssistant, entry: ConfigEntry, async_add_entities: AddEntitiesCallback\n@@ -145,7 +168,9 @@ async def async_setup_entry(\n         )\n         for mill_device in mill_data_coordinator.data.values()\n         for entity_description in (\n-            HEATER_SENSOR_TYPES\n+            SOCKET_SENSOR_TYPES\n+            if isinstance(mill_device, mill.Socket)\n+            else HEATER_SENSOR_TYPES\n             if isinstance(mill_device, mill.Heater)\n             else SENSOR_TYPES\n         )\n", "test_patch": "", "problem_statement": "Mill WiFi Socket doesn't expose humidity data\n### The problem\n\nContrary to the standard heaters, the Mill Mill WiFi Socket has an humidity sensor, but this humidity sensor is not currently supported by the Mill integration:\r\n\r\n![photo_2024-11-04 11 46 08](https://github.com/user-attachments/assets/be83035f-dab7-4e39-8fbc-2a329ef89b81)\r\n\r\nWould it be possible to completely support this device's features?\n\n### What version of Home Assistant Core has the issue?\n\ncore-2024.10.4\n\n### What was the last working version of Home Assistant Core?\n\n_No response_\n\n### What type of installation are you running?\n\nHome Assistant OS\n\n### Integration causing the issue\n\nMill\n\n### Link to integration documentation on our website\n\nhttps://www.home-assistant.io/integrations/mill/\n\n### Diagnostics information\n\n_No response_\n\n### Example YAML snippet\n\n_No response_\n\n### Anything in the logs that might be useful for us?\n\n_No response_\n\n### Additional information\n\n_No response_\n", "hints_text": "\nHey there @danielhiversen, mind taking a look at this issue as it has been labeled with an integration (`mill`) you are listed as a [code owner](https://github.com/home-assistant/core/blob/dev/CODEOWNERS#L916) for? Thanks!\n\n<details>\n<summary>Code owner commands</summary>\n\n\nCode owners of `mill` can trigger bot actions by commenting:\n\n- `@home-assistant close` Closes the issue.\n- `@home-assistant rename Awesome new title` Renames the issue.\n- `@home-assistant reopen` Reopen the issue.\n- `@home-assistant unassign mill` Removes the current integration label and assignees on the issue, add the integration domain after the command.\n- `@home-assistant add-label needs-more-information` Add a label (needs-more-information, problem in dependency, problem in custom component) to the issue.\n- `@home-assistant remove-label needs-more-information` Remove a label (needs-more-information, problem in dependency, problem in custom component) on the issue.\n\n</details>\n\n\n<sub><sup>(message by CodeOwnersMention)</sup></sub>\n\n---\n\n[mill documentation](https://www.home-assistant.io/integrations/mill)\n[mill source](https://github.com/home-assistant/core/tree/dev/homeassistant/components/mill)\n<sub><sup>(message by IssueLinks)</sup></sub>\nI do not have any Mill socket.\r\nWould you be willing to give me access to yours for a short time?\r\n\r\ngithub@dahoiv.net\nHere is the changes: https://github.com/home-assistant/core/compare/mill?expand=1\r\nWill probably be part of next HA release", "created_at": "2024-11-18T18:28:26Z"}
{"repo": "home-assistant/core", "pull_number": 130877, "instance_id": "home-assistant__core-130877", "issue_numbers": ["130432"], "base_commit": "efa86293aa47f8f7b5395cd0b48f72ea8002b674", "patch": "diff --git a/homeassistant/components/bluetooth/manifest.json b/homeassistant/components/bluetooth/manifest.json\nindex fe16bd73a9e7c8..e25c077b57fa43 100644\n--- a/homeassistant/components/bluetooth/manifest.json\n+++ b/homeassistant/components/bluetooth/manifest.json\n@@ -16,7 +16,7 @@\n   \"requirements\": [\n     \"bleak==0.22.3\",\n     \"bleak-retry-connector==3.6.0\",\n-    \"bluetooth-adapters==0.20.0\",\n+    \"bluetooth-adapters==0.20.2\",\n     \"bluetooth-auto-recovery==1.4.2\",\n     \"bluetooth-data-tools==1.20.0\",\n     \"dbus-fast==2.24.3\",\ndiff --git a/homeassistant/package_constraints.txt b/homeassistant/package_constraints.txt\nindex 63425c967e0b55..0ccf1395a88012 100644\n--- a/homeassistant/package_constraints.txt\n+++ b/homeassistant/package_constraints.txt\n@@ -19,7 +19,7 @@ awesomeversion==24.6.0\n bcrypt==4.2.0\n bleak-retry-connector==3.6.0\n bleak==0.22.3\n-bluetooth-adapters==0.20.0\n+bluetooth-adapters==0.20.2\n bluetooth-auto-recovery==1.4.2\n bluetooth-data-tools==1.20.0\n cached-ipaddress==0.8.0\ndiff --git a/requirements_all.txt b/requirements_all.txt\nindex f2646cfd446617..2a3a68ea9b2e55 100644\n--- a/requirements_all.txt\n+++ b/requirements_all.txt\n@@ -617,7 +617,7 @@ bluemaestro-ble==0.2.3\n # bluepy==1.3.0\n \n # homeassistant.components.bluetooth\n-bluetooth-adapters==0.20.0\n+bluetooth-adapters==0.20.2\n \n # homeassistant.components.bluetooth\n bluetooth-auto-recovery==1.4.2\n", "test_patch": "diff --git a/requirements_test_all.txt b/requirements_test_all.txt\nindex eb232521dd3c90..55c51828afe27d 100644\n--- a/requirements_test_all.txt\n+++ b/requirements_test_all.txt\n@@ -541,7 +541,7 @@ bluecurrent-api==1.2.3\n bluemaestro-ble==0.2.3\n \n # homeassistant.components.bluetooth\n-bluetooth-adapters==0.20.0\n+bluetooth-adapters==0.20.2\n \n # homeassistant.components.bluetooth\n bluetooth-auto-recovery==1.4.2\n", "problem_statement": "Bluetooth manager saves and restores stale adverts in `bluetooth.remote_scanners`\n### The problem\r\n\r\nI maintain [Bermuda](https://github.com/agittins/bermuda) and I've had a few cases where folks have had enormous `/config/.storage/bluetooth.remote_scanners` files (9MB or so), containing several *months* worth of advertisement data from a non-core integration, even after that integration has been uninstalled.\r\n\r\nI haven't yet been able to confirm which integration is causing the issue, but I do have a lead I haven't yet tested, so I don't feel comfortable publicly naming it if it's not the one at fault.\r\n\r\nThe issue for me is that Bermuda tries to process all known device advertisements, but when it hits this (in-memory) cache of over 10,000 adverts systems are bogging down and becoming non-responsive. To be clear - **this is my own fault** because I am accessing private members of the bluetooth.manager class rather than a proper API, so naturally I get to keep the smouldering consequences of my own questionable choices. I'll be changing Bermuda to harden itself against this issue in either case.\r\n\r\nThe issue for HA is that some systems are carrying this extra in-memory cache of very stale adverts, presumably indefinitely. I don't know if it only applies to adverts gathered between a certain range of HA versions, or if it's specific to a particuar custom integration's behaviour.\r\n\r\nManually solving the \"issue\" involves shutting down HA, renaming/removing the `bluetooth.remote_scanners` file and starting HA again - which is not ideal for folks not familiar with ssh etc.\r\n\r\nI think the expire adverts functions are not working in these cases because the adverts belong to a no-longer-present scanner, so they are sitting in the manager's `_all_histories` but not assigned to any extant scanner. I think this is also why the data persists, because HA might be modifying the saved data only for present scanners, and leaves the not-present scanner's cache data intact - but I haven't dug too deeply into the bluetooth_adaptors/storage.py to be sure.\r\n\r\nI have an example file of about 9MB, but as it comes from a user I'd rather not share it publicly, but [I have their permission](https://github.com/agittins/bermuda/issues/317) to email or provide a link via dm to my nextcloud - I'm on the discord so can be contacted there, or my email is ash@ajg.net.au (I gave up on my own privacy decades ago!)\r\n\r\nSome redacted excerpts of the `bluetooth.remote_scanners` file:\r\n\r\n![image](https://github.com/user-attachments/assets/bab6d63f-035f-4dd1-bcf8-27fb436102f2)\r\n\r\nTimestamps:\r\n![image](https://github.com/user-attachments/assets/3bc4bc06-afdf-462b-8f78-290adc25e454)\r\n\r\nAdverts:\r\n![image](https://github.com/user-attachments/assets/e0f5616d-fde6-44a4-8ef2-058829a87c53)\r\n\r\nRunning the file through ` jq '.data.\"52e3fd636f144605f7665a0ae49aca33\".discovered_device_advertisement_datas.[].device.address'` gives 12585 lines.\r\n\r\n\r\n### What version of Home Assistant Core has the issue?\r\n\r\ncore-2024.11.1\r\n\r\n### What was the last working version of Home Assistant Core?\r\n\r\n_No response_\r\n\r\n### What type of installation are you running?\r\n\r\nHome Assistant Container\r\n\r\n### Integration causing the issue\r\n\r\nbluetooth\r\n\r\n### Link to integration documentation on our website\r\n\r\nhttps://www.home-assistant.io/integrations/bluetooth/\r\n\r\n### Diagnostics information\r\n\r\n_No response_\r\n\r\n### Example YAML snippet\r\n\r\n_No response_\r\n\r\n### Anything in the logs that might be useful for us?\r\n\r\n```txt\r\n2024-11-11 17:45:07.854 INFO (MainThread) [homeassistant.setup] Setup of domain dhcp took 0.00 seconds\r\n2024-11-11 17:45:07.871 INFO (MainThread) [homeassistant.setup] Setting up usb\r\n2024-11-11 17:45:07.872 INFO (MainThread) [homeassistant.setup] Setup of domain usb took 0.00 seconds\r\n2024-11-11 17:45:07.913 INFO (MainThread) [homeassistant.setup] Setting up zeroconf\r\n2024-11-11 17:45:07.932 INFO (MainThread) [homeassistant.components.zeroconf] Starting Zeroconf broadcast\r\n2024-11-11 17:45:07.936 INFO (MainThread) [homeassistant.setup] Setup of domain zeroconf took 0.02 seconds\r\n2024-11-11 17:45:08.035 INFO (MainThread) [homeassistant.setup] Setting up bluetooth\r\n2024-11-11 17:45:10.800 INFO (MainThread) [homeassistant.setup] Setup of domain bluetooth took 2.76 seconds\r\n2024-11-11 17:45:10.801 WARNING (MainThread) [asyncio] Executing <Task finished name='setup component bluetooth' coro=<async_setup_component() done, defined at /workspaces/homeassistant-core/homeassistant/setup.py:145> result=True created at /workspaces/homeassistant-core/homeassistant/util/async_.py:45> took 2.726 seconds\r\n2024-11-11 17:45:10.812 INFO (MainThread) [homeassistant.bootstrap] Setting up stage 2: {'device_automation', 'search', 'backup', 'timer', 'bermuda', 'stt', 'input_button', 'assist_pipeline', 'blueprint', 'onboarding', 'radio_browser', 'media_source', 'mobile_app', 'input_datetime', 'schedule', 'input_select', 'logbook', 'tag', 'scene', 'homeassistant_alerts', 'tts', 'sun', 'ffmpeg', 'go2rtc', 'file_upload', 'zone', 'met', 'kegtron', 'diagnostics', 'config', 'analytics', 'camera', 'inkbird', 'application_credentials', 'input_number', 'xiaomi_ble', 'hardware', 'trace', 'private_ble_device', 'wake_word', 'stream', 'image_upload', 'my', 'system_health', 'counter', 'energy', 'shopping_list', 'input_text', 'lovelace', 'script', 'bluetooth_adapters', 'conversation', 'default_config', 'esphome', 'intent', 'automation', 'input_boolean', 'google_translate', 'device_tracker', 'history', 'person'}\r\n2024-11-11 17:45:10.814 INFO (MainThread) [homeassistant.setup] Setting up wake_word\r\n2024-11-11 17:45:10.815 INFO (MainThread) [homeassistant.setup] Setup of domain wake_word took 0.00 seconds\r\n2024-11-11 17:45:10.815 INFO (MainThread) [homeassistant.setup] Setting up stt\r\n2024-11-11 17:45:10.817 INFO (MainThread) [homeassistant.setup] Setup of domain stt took 0.00 seconds\r\n```\r\n\r\n\r\n### Additional information\r\n\r\nNote the bluetooth integration taking 2.76 seconds to load. This is on my dev machine with SSD, 32GB RAM, running 2024.11.0 in a devcontainer in vscode.\r\n\r\nMy apologies for not being able to provide complete diagnostics due to it being client data (and bluetooth diags not being redacted for MACs), but happy to provide them privately.\r\n\r\nI have experimented with a \"repair\" locally, and it does clean the in-memory cache by identifying *any* unclaimed scanner's adverts, but doesn't affect the on-disk cache after a restart, plus this is probably not suitable for general use since a user might reboot multiple times while a scanner is not present, but still want the history restored later. The timestamps from the sample data appear to be unix epoch timestamps (vs monotonic).\r\n\r\n```\r\n        deleteme=[]\r\n        for devkey, device in self.manager._all_history.items():  # noqa: SLF001\r\n            if device.source not in self.manager._connectable_scanners | self.manager._non_connectable_scanners:\r\n                deleteme.append(devkey)\r\n        for key in deleteme:\r\n            del self.manager._all_history[key]\r\n```\r\n\n", "hints_text": "\nHey there @bdraco, mind taking a look at this issue as it has been labeled with an integration (`bluetooth`) you are listed as a [code owner](https://github.com/home-assistant/core/blob/dev/CODEOWNERS#L207) for? Thanks!\n\n<details>\n<summary>Code owner commands</summary>\n\n\nCode owners of `bluetooth` can trigger bot actions by commenting:\n\n- `@home-assistant close` Closes the issue.\n- `@home-assistant rename Awesome new title` Renames the issue.\n- `@home-assistant reopen` Reopen the issue.\n- `@home-assistant unassign bluetooth` Removes the current integration label and assignees on the issue, add the integration domain after the command.\n- `@home-assistant add-label needs-more-information` Add a label (needs-more-information, problem in dependency, problem in custom component) to the issue.\n- `@home-assistant remove-label needs-more-information` Remove a label (needs-more-information, problem in dependency, problem in custom component) on the issue.\n\n</details>\n\n\n<sub><sup>(message by CodeOwnersMention)</sup></sub>\n\n---\n\n[bluetooth documentation](https://www.home-assistant.io/integrations/bluetooth)\n[bluetooth source](https://github.com/home-assistant/core/tree/dev/homeassistant/components/bluetooth)\n<sub><sup>(message by IssueLinks)</sup></sub>\nSince monotonic time is only guaranteed to be the same per run we have to convert to epoch when saving\n\nIt looks like we don't have good guards for the host system experiencing time travel (time suddenly moving forwards or suddenly moving backwards), however it's unclear if that's the issue until I see the data\n\nYou can share the data to my Dropbox nick@koston.org or my gdrive bdraco@gmail.com\nI'm also bdraco on discord if that works better but I may be slow to respond there as it's a busy day for me \nGreat, I have shared it to your dropbox (my account there is agittins@purple.dropbear.id.au). Also mentioned in a comment on the file the integration I think might be doing the thing.\nI'll try to look at it soon, unfortunately today is also turning out to be another very busy day\nWas hoping to be able to investigate this week but sadly I'm going to run out of time since I'm working on the aiohttp 3.11 release this week.\r\n\r\nHopefully I'll be able to give this a look next week.\nThe rouge scanner is storing the timestamps in milliseconds instead of seconds so they never expire\n```\r\n>>> datetime.datetime.fromtimestamp(1729905162218.4646)\r\nTraceback (most recent call last):\r\n  File \"<python-input-3>\", line 1, in <module>\r\n    datetime.datetime.fromtimestamp(1729905162218.4646)\r\n    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^\r\nValueError: year 56788 is out of range\r\n```\n> I haven't yet been able to confirm which integration is causing the issue, but I do have a lead I haven't yet tested, so I don't feel comfortable publicly naming it if it's not the one at fault.\r\n\r\n@agittins Please name it here so it can get fixed. \nhttps://github.com/Bluetooth-Devices/bluetooth-adapters/pull/177 will prevent restoring them so at least they will stop building up but it won't handle the case where the integration is injecting incorrect timestamps at run time which will never expire and pollute the whole stack", "created_at": "2024-11-18T15:34:53Z"}
{"repo": "home-assistant/core", "pull_number": 130865, "instance_id": "home-assistant__core-130865", "issue_numbers": ["130773", "130773"], "base_commit": "75199a901f76b7b8958bd3ef7179a606f0757000", "patch": "diff --git a/homeassistant/components/rachio/coordinator.py b/homeassistant/components/rachio/coordinator.py\nindex 25c40bd6656de0..62d42f2afdae18 100644\n--- a/homeassistant/components/rachio/coordinator.py\n+++ b/homeassistant/components/rachio/coordinator.py\n@@ -8,6 +8,7 @@\n from rachiopy import Rachio\n from requests.exceptions import Timeout\n \n+from homeassistant.config_entries import ConfigEntry\n from homeassistant.core import HomeAssistant\n from homeassistant.helpers.debounce import Debouncer\n from homeassistant.helpers.update_coordinator import DataUpdateCoordinator, UpdateFailed\n@@ -38,6 +39,7 @@ def __init__(\n         self,\n         hass: HomeAssistant,\n         rachio: Rachio,\n+        config_entry: ConfigEntry,\n         base_station,\n         base_count: int,\n     ) -> None:\n@@ -48,6 +50,7 @@ def __init__(\n         super().__init__(\n             hass,\n             _LOGGER,\n+            config_entry=config_entry,\n             name=f\"{DOMAIN} update coordinator\",\n             # To avoid exceeding the rate limit, increase polling interval for\n             # each additional base station on the account\n@@ -76,6 +79,7 @@ def __init__(\n         self,\n         hass: HomeAssistant,\n         rachio: Rachio,\n+        config_entry: ConfigEntry,\n         base_station,\n     ) -> None:\n         \"\"\"Initialize a Rachio schedule coordinator.\"\"\"\n@@ -85,6 +89,7 @@ def __init__(\n         super().__init__(\n             hass,\n             _LOGGER,\n+            config_entry=config_entry,\n             name=f\"{DOMAIN} schedule update coordinator\",\n             update_interval=timedelta(minutes=30),\n         )\ndiff --git a/homeassistant/components/rachio/device.py b/homeassistant/components/rachio/device.py\nindex f06910cd505103..179e5f5ec0d81c 100644\n--- a/homeassistant/components/rachio/device.py\n+++ b/homeassistant/components/rachio/device.py\n@@ -189,8 +189,10 @@ def _setup(self, hass: HomeAssistant) -> None:\n             RachioBaseStation(\n                 rachio,\n                 base,\n-                RachioUpdateCoordinator(hass, rachio, base, base_count),\n-                RachioScheduleUpdateCoordinator(hass, rachio, base),\n+                RachioUpdateCoordinator(\n+                    hass, rachio, self.config_entry, base, base_count\n+                ),\n+                RachioScheduleUpdateCoordinator(hass, rachio, self.config_entry, base),\n             )\n             for base in base_stations\n         )\n", "test_patch": "", "problem_statement": "Rachio uses async_config_entry_first_refresh warning\n### The problem\n\nDetected that integration 'rachio' uses `async_config_entry_first_refresh`, which is only supported for coordinators with a config entry and will stop working in Home Assistant 2025.11.\r\n\r\nThis is logged on every start.\n\n### What version of Home Assistant Core has the issue?\n\n2024.11.1\n\n### What was the last working version of Home Assistant Core?\n\n2024.10.X\n\n### What type of installation are you running?\n\nHome Assistant OS\n\n### Integration causing the issue\n\nRachio\n\n### Link to integration documentation on our website\n\nhttps://www.home-assistant.io/integrations/rachio/\n\n### Diagnostics information\n\nDetected that integration 'rachio' uses `async_config_entry_first_refresh`, which is only supported for coordinators with a config entry and will stop working in Home Assistant 2025.11 at homeassistant/components/rachio/__init__.py, line 96: await base.status_coordinator.async_config_entry_first_refresh(), please create a bug report at https://github.com/home-assistant/core/issues?q=is%3Aopen+is%3Aissue+label%3A%22integration%3A+rachio%22\n\n### Example YAML snippet\n\n_No response_\n\n### Anything in the logs that might be useful for us?\n\n_No response_\n\n### Additional information\n\nThe coordinators are part of the config entry, so I'm not sure what is supposed to be used here...\r\nMaybe just `coordinator.async_refresh()`? \r\n\r\nI didn't see anything in the dev blog that mentioned this change.\nRachio uses async_config_entry_first_refresh warning\n### The problem\n\nDetected that integration 'rachio' uses `async_config_entry_first_refresh`, which is only supported for coordinators with a config entry and will stop working in Home Assistant 2025.11.\r\n\r\nThis is logged on every start.\n\n### What version of Home Assistant Core has the issue?\n\n2024.11.1\n\n### What was the last working version of Home Assistant Core?\n\n2024.10.X\n\n### What type of installation are you running?\n\nHome Assistant OS\n\n### Integration causing the issue\n\nRachio\n\n### Link to integration documentation on our website\n\nhttps://www.home-assistant.io/integrations/rachio/\n\n### Diagnostics information\n\nDetected that integration 'rachio' uses `async_config_entry_first_refresh`, which is only supported for coordinators with a config entry and will stop working in Home Assistant 2025.11 at homeassistant/components/rachio/__init__.py, line 96: await base.status_coordinator.async_config_entry_first_refresh(), please create a bug report at https://github.com/home-assistant/core/issues?q=is%3Aopen+is%3Aissue+label%3A%22integration%3A+rachio%22\n\n### Example YAML snippet\n\n_No response_\n\n### Anything in the logs that might be useful for us?\n\n_No response_\n\n### Additional information\n\nThe coordinators are part of the config entry, so I'm not sure what is supposed to be used here...\r\nMaybe just `coordinator.async_refresh()`? \r\n\r\nI didn't see anything in the dev blog that mentioned this change.\n", "hints_text": "\nHey there @bdraco, @rfverbruggen, mind taking a look at this issue as it has been labeled with an integration (`rachio`) you are listed as a [code owner](https://github.com/home-assistant/core/blob/dev/CODEOWNERS#L1187) for? Thanks!\n\n<details>\n<summary>Code owner commands</summary>\n\n\nCode owners of `rachio` can trigger bot actions by commenting:\n\n- `@home-assistant close` Closes the issue.\n- `@home-assistant rename Awesome new title` Renames the issue.\n- `@home-assistant reopen` Reopen the issue.\n- `@home-assistant unassign rachio` Removes the current integration label and assignees on the issue, add the integration domain after the command.\n- `@home-assistant add-label needs-more-information` Add a label (needs-more-information, problem in dependency, problem in custom component) to the issue.\n- `@home-assistant remove-label needs-more-information` Remove a label (needs-more-information, problem in dependency, problem in custom component) on the issue.\n\n</details>\n\n\n<sub><sup>(message by CodeOwnersMention)</sup></sub>\n\n---\n\n[rachio documentation](https://www.home-assistant.io/integrations/rachio)\n[rachio source](https://github.com/home-assistant/core/tree/dev/homeassistant/components/rachio)\n<sub><sup>(message by IssueLinks)</sup></sub>\n\nHey there @bdraco, @rfverbruggen, mind taking a look at this issue as it has been labeled with an integration (`rachio`) you are listed as a [code owner](https://github.com/home-assistant/core/blob/dev/CODEOWNERS#L1187) for? Thanks!\n\n<details>\n<summary>Code owner commands</summary>\n\n\nCode owners of `rachio` can trigger bot actions by commenting:\n\n- `@home-assistant close` Closes the issue.\n- `@home-assistant rename Awesome new title` Renames the issue.\n- `@home-assistant reopen` Reopen the issue.\n- `@home-assistant unassign rachio` Removes the current integration label and assignees on the issue, add the integration domain after the command.\n- `@home-assistant add-label needs-more-information` Add a label (needs-more-information, problem in dependency, problem in custom component) to the issue.\n- `@home-assistant remove-label needs-more-information` Remove a label (needs-more-information, problem in dependency, problem in custom component) on the issue.\n\n</details>\n\n\n<sub><sup>(message by CodeOwnersMention)</sup></sub>\n\n---\n\n[rachio documentation](https://www.home-assistant.io/integrations/rachio)\n[rachio source](https://github.com/home-assistant/core/tree/dev/homeassistant/components/rachio)\n<sub><sup>(message by IssueLinks)</sup></sub>", "created_at": "2024-11-18T11:06:29Z"}
{"repo": "home-assistant/core", "pull_number": 130846, "instance_id": "home-assistant__core-130846", "issue_numbers": ["125841"], "base_commit": "43235713c7010c8f3676e53a780b792ee4fbad36", "patch": "diff --git a/homeassistant/components/alexa/capabilities.py b/homeassistant/components/alexa/capabilities.py\nindex 09b461428ac4e..b2cda8ad76e75 100644\n--- a/homeassistant/components/alexa/capabilities.py\n+++ b/homeassistant/components/alexa/capabilities.py\n@@ -816,13 +816,19 @@ def supported_operations(self) -> list[str]:\n         \"\"\"\n         supported_features = self.entity.attributes.get(ATTR_SUPPORTED_FEATURES, 0)\n \n-        operations = {\n-            media_player.MediaPlayerEntityFeature.NEXT_TRACK: \"Next\",\n-            media_player.MediaPlayerEntityFeature.PAUSE: \"Pause\",\n-            media_player.MediaPlayerEntityFeature.PLAY: \"Play\",\n-            media_player.MediaPlayerEntityFeature.PREVIOUS_TRACK: \"Previous\",\n-            media_player.MediaPlayerEntityFeature.STOP: \"Stop\",\n-        }\n+        operations: dict[\n+            cover.CoverEntityFeature | media_player.MediaPlayerEntityFeature, str\n+        ]\n+        if self.entity.domain == cover.DOMAIN:\n+            operations = {cover.CoverEntityFeature.STOP: \"Stop\"}\n+        else:\n+            operations = {\n+                media_player.MediaPlayerEntityFeature.NEXT_TRACK: \"Next\",\n+                media_player.MediaPlayerEntityFeature.PAUSE: \"Pause\",\n+                media_player.MediaPlayerEntityFeature.PLAY: \"Play\",\n+                media_player.MediaPlayerEntityFeature.PREVIOUS_TRACK: \"Previous\",\n+                media_player.MediaPlayerEntityFeature.STOP: \"Stop\",\n+            }\n \n         return [\n             value\ndiff --git a/homeassistant/components/alexa/entities.py b/homeassistant/components/alexa/entities.py\nindex ca7b389a0f1b0..8c139d66369de 100644\n--- a/homeassistant/components/alexa/entities.py\n+++ b/homeassistant/components/alexa/entities.py\n@@ -559,6 +559,10 @@ def interfaces(self) -> Generator[AlexaCapability]:\n             )\n         if supported & cover.CoverEntityFeature.SET_TILT_POSITION:\n             yield AlexaRangeController(self.entity, instance=f\"{cover.DOMAIN}.tilt\")\n+        if supported & (\n+            cover.CoverEntityFeature.STOP | cover.CoverEntityFeature.STOP_TILT\n+        ):\n+            yield AlexaPlaybackController(self.entity, instance=f\"{cover.DOMAIN}.stop\")\n         yield AlexaEndpointHealth(self.hass, self.entity)\n         yield Alexa(self.entity)\n \ndiff --git a/homeassistant/components/alexa/handlers.py b/homeassistant/components/alexa/handlers.py\nindex 8ea61ddbceb10..89e47673f0796 100644\n--- a/homeassistant/components/alexa/handlers.py\n+++ b/homeassistant/components/alexa/handlers.py\n@@ -2,6 +2,7 @@\n \n from __future__ import annotations\n \n+import asyncio\n from collections.abc import Callable, Coroutine\n import logging\n import math\n@@ -764,9 +765,25 @@ async def async_api_stop(\n     entity = directive.entity\n     data: dict[str, Any] = {ATTR_ENTITY_ID: entity.entity_id}\n \n-    await hass.services.async_call(\n-        entity.domain, SERVICE_MEDIA_STOP, data, blocking=False, context=context\n-    )\n+    if entity.domain == cover.DOMAIN:\n+        supported: int = entity.attributes.get(ATTR_SUPPORTED_FEATURES, 0)\n+        feature_services: dict[int, str] = {\n+            cover.CoverEntityFeature.STOP.value: cover.SERVICE_STOP_COVER,\n+            cover.CoverEntityFeature.STOP_TILT.value: cover.SERVICE_STOP_COVER_TILT,\n+        }\n+        await asyncio.gather(\n+            *(\n+                hass.services.async_call(\n+                    entity.domain, service, data, blocking=False, context=context\n+                )\n+                for feature, service in feature_services.items()\n+                if feature & supported\n+            )\n+        )\n+    else:\n+        await hass.services.async_call(\n+            entity.domain, SERVICE_MEDIA_STOP, data, blocking=False, context=context\n+        )\n \n     return directive.response()\n \n", "test_patch": "diff --git a/tests/components/alexa/test_smart_home.py b/tests/components/alexa/test_smart_home.py\nindex 68010a6a7111c..e4a46db7d3449 100644\n--- a/tests/components/alexa/test_smart_home.py\n+++ b/tests/components/alexa/test_smart_home.py\n@@ -4546,6 +4546,7 @@ async def test_presence_sensor(hass: HomeAssistant) -> None:\n         \"tilt_position_attr_in_service_call\",\n         \"supported_features\",\n         \"service_call\",\n+        \"stop_feature_enabled\",\n     ),\n     [\n         (\n@@ -4556,6 +4557,7 @@ async def test_presence_sensor(hass: HomeAssistant) -> None:\n             | CoverEntityFeature.CLOSE_TILT\n             | CoverEntityFeature.STOP_TILT,\n             \"cover.set_cover_tilt_position\",\n+            True,\n         ),\n         (\n             0,\n@@ -4565,6 +4567,7 @@ async def test_presence_sensor(hass: HomeAssistant) -> None:\n             | CoverEntityFeature.CLOSE_TILT\n             | CoverEntityFeature.STOP_TILT,\n             \"cover.close_cover_tilt\",\n+            True,\n         ),\n         (\n             99,\n@@ -4574,6 +4577,7 @@ async def test_presence_sensor(hass: HomeAssistant) -> None:\n             | CoverEntityFeature.CLOSE_TILT\n             | CoverEntityFeature.STOP_TILT,\n             \"cover.set_cover_tilt_position\",\n+            True,\n         ),\n         (\n             100,\n@@ -4583,36 +4587,42 @@ async def test_presence_sensor(hass: HomeAssistant) -> None:\n             | CoverEntityFeature.CLOSE_TILT\n             | CoverEntityFeature.STOP_TILT,\n             \"cover.open_cover_tilt\",\n+            True,\n         ),\n         (\n             0,\n             0,\n             CoverEntityFeature.SET_TILT_POSITION,\n             \"cover.set_cover_tilt_position\",\n+            False,\n         ),\n         (\n             60,\n             60,\n             CoverEntityFeature.SET_TILT_POSITION,\n             \"cover.set_cover_tilt_position\",\n+            False,\n         ),\n         (\n             100,\n             100,\n             CoverEntityFeature.SET_TILT_POSITION,\n             \"cover.set_cover_tilt_position\",\n+            False,\n         ),\n         (\n             0,\n             0,\n             CoverEntityFeature.SET_TILT_POSITION | CoverEntityFeature.OPEN_TILT,\n             \"cover.set_cover_tilt_position\",\n+            False,\n         ),\n         (\n             100,\n             100,\n             CoverEntityFeature.SET_TILT_POSITION | CoverEntityFeature.CLOSE_TILT,\n             \"cover.set_cover_tilt_position\",\n+            False,\n         ),\n     ],\n     ids=[\n@@ -4633,6 +4643,7 @@ async def test_cover_tilt_position(\n     tilt_position_attr_in_service_call: int | None,\n     supported_features: CoverEntityFeature,\n     service_call: str,\n+    stop_feature_enabled: bool,\n ) -> None:\n     \"\"\"Test cover discovery and tilt position using rangeController.\"\"\"\n     device = (\n@@ -4651,12 +4662,24 @@ async def test_cover_tilt_position(\n     assert appliance[\"displayCategories\"][0] == \"INTERIOR_BLIND\"\n     assert appliance[\"friendlyName\"] == \"Test cover tilt range\"\n \n+    expected_interfaces: dict[bool, list[str]] = {\n+        False: [\n+            \"Alexa.PowerController\",\n+            \"Alexa.RangeController\",\n+            \"Alexa.EndpointHealth\",\n+            \"Alexa\",\n+        ],\n+        True: [\n+            \"Alexa.PowerController\",\n+            \"Alexa.RangeController\",\n+            \"Alexa.PlaybackController\",\n+            \"Alexa.EndpointHealth\",\n+            \"Alexa\",\n+        ],\n+    }\n+\n     capabilities = assert_endpoint_capabilities(\n-        appliance,\n-        \"Alexa.PowerController\",\n-        \"Alexa.RangeController\",\n-        \"Alexa.EndpointHealth\",\n-        \"Alexa\",\n+        appliance, *expected_interfaces[stop_feature_enabled]\n     )\n \n     range_capability = get_capability(capabilities, \"Alexa.RangeController\")\n@@ -4713,6 +4736,7 @@ async def test_cover_tilt_position_range(hass: HomeAssistant) -> None:\n         appliance,\n         \"Alexa.PowerController\",\n         \"Alexa.RangeController\",\n+        \"Alexa.PlaybackController\",\n         \"Alexa.EndpointHealth\",\n         \"Alexa\",\n     )\n@@ -4767,6 +4791,66 @@ async def test_cover_tilt_position_range(hass: HomeAssistant) -> None:\n     )\n \n \n+@pytest.mark.parametrize(\n+    (\"supported_stop_features\", \"cover_stop_calls\", \"cover_stop_tilt_calls\"),\n+    [\n+        (CoverEntityFeature(0), 0, 0),\n+        (CoverEntityFeature.STOP, 1, 0),\n+        (CoverEntityFeature.STOP_TILT, 0, 1),\n+        (CoverEntityFeature.STOP | CoverEntityFeature.STOP_TILT, 1, 1),\n+    ],\n+    ids=[\"no_stop\", \"stop_cover\", \"stop_cover_tilt\", \"stop_cover_and_stop_cover_tilt\"],\n+)\n+async def test_cover_stop(\n+    hass: HomeAssistant,\n+    supported_stop_features: CoverEntityFeature,\n+    cover_stop_calls: int,\n+    cover_stop_tilt_calls: int,\n+) -> None:\n+    \"\"\"Test cover and cover tilt can be stopped.\"\"\"\n+\n+    base_features = (\n+        CoverEntityFeature.OPEN\n+        | CoverEntityFeature.CLOSE\n+        | CoverEntityFeature.OPEN_TILT\n+        | CoverEntityFeature.CLOSE_TILT\n+        | CoverEntityFeature.SET_POSITION\n+        | CoverEntityFeature.SET_TILT_POSITION\n+    )\n+\n+    device = (\n+        \"cover.test_semantics\",\n+        \"open\",\n+        {\n+            \"friendly_name\": \"Test cover semantics\",\n+            \"device_class\": \"blind\",\n+            \"supported_features\": int(base_features | supported_stop_features),\n+            \"current_position\": 30,\n+            \"tilt_position\": 30,\n+        },\n+    )\n+    appliance = await discovery_test(device, hass)\n+\n+    assert appliance[\"endpointId\"] == \"cover#test_semantics\"\n+    assert appliance[\"displayCategories\"][0] == \"INTERIOR_BLIND\"\n+    assert appliance[\"friendlyName\"] == \"Test cover semantics\"\n+\n+    calls_stop = async_mock_service(hass, \"cover\", \"stop_cover\")\n+    calls_stop_tilt = async_mock_service(hass, \"cover\", \"stop_cover_tilt\")\n+\n+    context = Context()\n+    request = get_new_request(\n+        \"Alexa.PlaybackController\", \"Stop\", \"cover#test_semantics\"\n+    )\n+    await smart_home.async_handle_message(\n+        hass, get_default_config(hass), request, context\n+    )\n+    await hass.async_block_till_done()\n+\n+    assert len(calls_stop) == cover_stop_calls\n+    assert len(calls_stop_tilt) == cover_stop_tilt_calls\n+\n+\n async def test_cover_semantics_position_and_tilt(hass: HomeAssistant) -> None:\n     \"\"\"Test cover discovery and semantics with position and tilt support.\"\"\"\n     device = (\n@@ -4790,10 +4874,30 @@ async def test_cover_semantics_position_and_tilt(hass: HomeAssistant) -> None:\n         appliance,\n         \"Alexa.PowerController\",\n         \"Alexa.RangeController\",\n+        \"Alexa.PlaybackController\",\n         \"Alexa.EndpointHealth\",\n         \"Alexa\",\n     )\n \n+    playback_controller_capability = get_capability(\n+        capabilities, \"Alexa.PlaybackController\"\n+    )\n+    assert playback_controller_capability is not None\n+    assert playback_controller_capability[\"supportedOperations\"] == [\"Stop\"]\n+\n+    # Assert both the cover and tilt stop calls are invoked\n+    stop_cover_tilt_calls = async_mock_service(hass, \"cover\", \"stop_cover_tilt\")\n+    await assert_request_calls_service(\n+        \"Alexa.PlaybackController\",\n+        \"Stop\",\n+        \"cover#test_semantics\",\n+        \"cover.stop_cover\",\n+        hass,\n+    )\n+    assert len(stop_cover_tilt_calls) == 1\n+    call = stop_cover_tilt_calls[0]\n+    assert call.data == {\"entity_id\": \"cover.test_semantics\"}\n+\n     # Assert for Position Semantics\n     position_capability = get_capability(\n         capabilities, \"Alexa.RangeController\", \"cover.position\"\n", "problem_statement": "Alexa is unable to stop cover movement\n### The problem\n\nTelling Alexa to stop a cover sends a \"TurnOff\" command to the cover, which Homeassistant interprets as closing the cover, thus there is no way to stop cover movement halfway through.\n\n### What version of Home Assistant Core has the issue?\n\ncore-2024.9.1\n\n### What was the last working version of Home Assistant Core?\n\n_No response_\n\n### What type of installation are you running?\n\nHome Assistant OS\n\n### Integration causing the issue\n\nAlexa\n\n### Link to integration documentation on our website\n\nhttps://www.home-assistant.io/integrations/alexa/\n\n### Diagnostics information\n\n<not available>\n\n### Example YAML snippet\n\n_No response_\n\n### Anything in the logs that might be useful for us?\n\n_No response_\n\n### Additional information\n\nThis issue seems to have been around for quite some time, reported here first: https://community.home-assistant.io/t/is-cover-stop-not-supported-by-alexa-smart-home-skill/381376/3\n", "hints_text": "\nHey there @home-assistant/cloud, @ochlocracy, @jbouwh, mind taking a look at this issue as it has been labeled with an integration (`alexa`) you are listed as a [code owner](https://github.com/home-assistant/core/blob/dev/CODEOWNERS#L87) for? Thanks!\n\n<details>\n<summary>Code owner commands</summary>\n\n\nCode owners of `alexa` can trigger bot actions by commenting:\n\n- `@home-assistant close` Closes the issue.\n- `@home-assistant rename Awesome new title` Renames the issue.\n- `@home-assistant reopen` Reopen the issue.\n- `@home-assistant unassign alexa` Removes the current integration label and assignees on the issue, add the integration domain after the command.\n- `@home-assistant add-label needs-more-information` Add a label (needs-more-information, problem in dependency, problem in custom component) to the issue.\n- `@home-assistant remove-label needs-more-information` Remove a label (needs-more-information, problem in dependency, problem in custom component) on the issue.\n\n</details>\n\n\n<sub><sup>(message by CodeOwnersMention)</sup></sub>\n\n---\n\n[alexa documentation](https://www.home-assistant.io/integrations/alexa)\n[alexa source](https://github.com/home-assistant/core/tree/dev/homeassistant/components/alexa)\n<sub><sup>(message by IssueLinks)</sup></sub>\nRelevant code:\r\nhttps://github.com/home-assistant/core/blob/6ef1dd56f582e1887af11ecf95adf812e5ef1a5b/homeassistant/components/alexa/handlers.py#L235\nWhat is the state of your cover when you are trying to stop it and it's capabilities. You can get the state and yaml attributes from the developer tools state tab.\nIt's a mqtt cover I defined myself - it supports open, close and stop. The state is somewhat inaccurate, because if the cover is controlled via source other than home assistant the assumed state is wrong (and the cover doesn't report its state).", "created_at": "2024-11-17T22:18:05Z"}
{"repo": "home-assistant/core", "pull_number": 130841, "instance_id": "home-assistant__core-130841", "issue_numbers": ["130664"], "base_commit": "43235713c7010c8f3676e53a780b792ee4fbad36", "patch": "diff --git a/homeassistant/components/sensibo/sensor.py b/homeassistant/components/sensibo/sensor.py\nindex a6a70ea6c4936..b395f8eb1eeb5 100644\n--- a/homeassistant/components/sensibo/sensor.py\n+++ b/homeassistant/components/sensibo/sensor.py\n@@ -178,6 +178,7 @@ class SensiboDeviceSensorEntityDescription(SensorEntityDescription):\n         value_fn=lambda data: data.co2,\n         extra_fn=None,\n     ),\n+    *DEVICE_SENSOR_TYPES,\n )\n \n ELEMENT_SENSOR_TYPES: tuple[SensiboDeviceSensorEntityDescription, ...] = (\n", "test_patch": "", "problem_statement": "Sensibo Sky, Air or Air Pro not Equally Integrated\n### The problem\n\nI have 3 HVAC in the house, and I have three Sensibo controllers, a Sky, an Air and an Air Pro. It appears that the Air Pro integration on Home Assistant does NOT bring the Climate React function from Sensibo. The Sky and Air units both have this ability in HA, and all three have the functionality in the Sensibo App, but only the Air Pro does not port the Climate React from the Sensibo App to HA.\r\n\r\nI have swapped the Sky and Air Pro to different HVAC, and the Climate React is only impacted by the Air Pro, not the make of HVAC (I have Daikin, and Mitsubishi Heavy Industries.)\r\n\r\nIs there a reason that the integration does not implement the Climate React for the Air Pro?\r\n\r\nSee: https://community.home-assistant.io/t/sensibo-sky-air-or-air-pro-not-equally-integrated/794571\n\n### What version of Home Assistant Core has the issue?\n\ncore-2024.11.1\n\n### What was the last working version of Home Assistant Core?\n\n_No response_\n\n### What type of installation are you running?\n\nHome Assistant OS\n\n### Integration causing the issue\n\nSensibo\n\n### Link to integration documentation on our website\n\nhttps://www.home-assistant.io/integrations/sensibo/\n\n### Diagnostics information\n\n[config_entry-sensibo-01J40WKFPAQ5Z9Q2Q2DXVQ2TT9.json](https://github.com/user-attachments/files/17759944/config_entry-sensibo-01J40WKFPAQ5Z9Q2Q2DXVQ2TT9.json)\r\n\n\n### Example YAML snippet\n\n_No response_\n\n### Anything in the logs that might be useful for us?\n\n_No response_\n\n### Additional information\n\n![Sensibo Air Pro](https://github.com/user-attachments/assets/64410eae-861d-4152-964e-190e6750b39e)\r\n![Sensibo Air](https://github.com/user-attachments/assets/7eda81b3-100d-4379-9b44-57ca0cef7ab8)\r\n![Screenshot (15 Nov 2024 11 53 40)](https://github.com/user-attachments/assets/0b193ae7-1a04-401c-9ad2-c202e717ac23)\r\nThe Air Pro photo shows the integration without Climate React, the Air show with Climate React, and the App shows that Air Pro has climate react.\n", "hints_text": "\nHey there @andrey-git, @gjohansson-st, mind taking a look at this issue as it has been labeled with an integration (`sensibo`) you are listed as a [code owner](https://github.com/home-assistant/core/blob/dev/CODEOWNERS#L1303) for? Thanks!\n\n<details>\n<summary>Code owner commands</summary>\n\n\nCode owners of `sensibo` can trigger bot actions by commenting:\n\n- `@home-assistant close` Closes the issue.\n- `@home-assistant rename Awesome new title` Renames the issue.\n- `@home-assistant reopen` Reopen the issue.\n- `@home-assistant unassign sensibo` Removes the current integration label and assignees on the issue, add the integration domain after the command.\n- `@home-assistant add-label needs-more-information` Add a label (needs-more-information, problem in dependency, problem in custom component) to the issue.\n- `@home-assistant remove-label needs-more-information` Remove a label (needs-more-information, problem in dependency, problem in custom component) on the issue.\n\n</details>\n\n\n<sub><sup>(message by CodeOwnersMention)</sup></sub>\n\n---\n\n[sensibo documentation](https://www.home-assistant.io/integrations/sensibo)\n[sensibo source](https://github.com/home-assistant/core/tree/dev/homeassistant/components/sensibo)\n<sub><sup>(message by IssueLinks)</sup></sub>\nCan you provide an screenshot of the entities from the air pro?\r\nI am a bit confused exactly which sensors you seem to miss.\r\n\r\nThanks\nHere is the Sensibo Air, with working Climate React.\r\n![Sensibo Air](https://github.com/user-attachments/assets/d2cf350f-c66a-438e-bce7-19079f82c136)\r\n\r\n\nand here is the Sensibo Air Pro, which is missing the sensors (not entities) for Climate React type, Climate React High and Low Temperature Thresholds.\r\n![Sensibo Air Pro](https://github.com/user-attachments/assets/9f8a0e06-aec2-4e34-88db-8aa0a10271ba)\r\nIncluded about is an image of the Sensibo App, for the Air Pro, exactly the same as the Air.  Hope this helps.\r\n\r\n", "created_at": "2024-11-17T21:27:53Z"}
{"repo": "home-assistant/core", "pull_number": 130828, "instance_id": "home-assistant__core-130828", "issue_numbers": ["123893"], "base_commit": "db3d3854478086292e98a57af9522f79dc75eede", "patch": "diff --git a/homeassistant/components/fitbit/sensor.py b/homeassistant/components/fitbit/sensor.py\nindex 2218454bd6186..d58dad4ca6720 100644\n--- a/homeassistant/components/fitbit/sensor.py\n+++ b/homeassistant/components/fitbit/sensor.py\n@@ -24,7 +24,7 @@\n     UnitOfVolume,\n )\n from homeassistant.core import HomeAssistant, callback\n-from homeassistant.helpers.device_registry import DeviceInfo\n+from homeassistant.helpers.device_registry import DeviceEntryType, DeviceInfo\n from homeassistant.helpers.entity_platform import AddEntitiesCallback\n from homeassistant.helpers.icon import icon_for_battery_level\n from homeassistant.helpers.update_coordinator import CoordinatorEntity\n@@ -41,6 +41,8 @@\n \n SCAN_INTERVAL: Final = datetime.timedelta(minutes=30)\n \n+FITBIT_TRACKER_SUBSTRING = \"/tracker/\"\n+\n \n def _default_value_fn(result: dict[str, Any]) -> str:\n     \"\"\"Parse a Fitbit timeseries API responses.\"\"\"\n@@ -122,11 +124,34 @@ class FitbitSensorEntityDescription(SensorEntityDescription):\n     unit_fn: Callable[[FitbitUnitSystem], str | None] = lambda x: None\n     scope: FitbitScope | None = None\n \n+    @property\n+    def is_tracker(self) -> bool:\n+        \"\"\"Return if the entity is a tracker.\"\"\"\n+        return FITBIT_TRACKER_SUBSTRING in self.key\n+\n+\n+def _build_device_info(\n+    config_entry: ConfigEntry, entity_description: FitbitSensorEntityDescription\n+) -> DeviceInfo:\n+    \"\"\"Build device info for sensor entities info across devices.\"\"\"\n+    unique_id = cast(str, config_entry.unique_id)\n+    if entity_description.is_tracker:\n+        return DeviceInfo(\n+            entry_type=DeviceEntryType.SERVICE,\n+            identifiers={(DOMAIN, f\"{unique_id}_tracker\")},\n+            translation_key=\"tracker\",\n+            translation_placeholders={\"display_name\": config_entry.title},\n+        )\n+    return DeviceInfo(\n+        entry_type=DeviceEntryType.SERVICE,\n+        identifiers={(DOMAIN, unique_id)},\n+    )\n+\n \n FITBIT_RESOURCES_LIST: Final[tuple[FitbitSensorEntityDescription, ...]] = (\n     FitbitSensorEntityDescription(\n         key=\"activities/activityCalories\",\n-        name=\"Activity Calories\",\n+        translation_key=\"activity_calories\",\n         native_unit_of_measurement=\"cal\",\n         icon=\"mdi:fire\",\n         scope=FitbitScope.ACTIVITY,\n@@ -135,7 +160,7 @@ class FitbitSensorEntityDescription(SensorEntityDescription):\n     ),\n     FitbitSensorEntityDescription(\n         key=\"activities/calories\",\n-        name=\"Calories\",\n+        translation_key=\"calories\",\n         native_unit_of_measurement=\"cal\",\n         icon=\"mdi:fire\",\n         scope=FitbitScope.ACTIVITY,\n@@ -143,7 +168,7 @@ class FitbitSensorEntityDescription(SensorEntityDescription):\n     ),\n     FitbitSensorEntityDescription(\n         key=\"activities/caloriesBMR\",\n-        name=\"Calories BMR\",\n+        translation_key=\"calories_bmr\",\n         native_unit_of_measurement=\"cal\",\n         icon=\"mdi:fire\",\n         scope=FitbitScope.ACTIVITY,\n@@ -153,7 +178,6 @@ class FitbitSensorEntityDescription(SensorEntityDescription):\n     ),\n     FitbitSensorEntityDescription(\n         key=\"activities/distance\",\n-        name=\"Distance\",\n         icon=\"mdi:map-marker\",\n         device_class=SensorDeviceClass.DISTANCE,\n         value_fn=_distance_value_fn,\n@@ -163,7 +187,7 @@ class FitbitSensorEntityDescription(SensorEntityDescription):\n     ),\n     FitbitSensorEntityDescription(\n         key=\"activities/elevation\",\n-        name=\"Elevation\",\n+        translation_key=\"elevation\",\n         icon=\"mdi:walk\",\n         device_class=SensorDeviceClass.DISTANCE,\n         unit_fn=_elevation_unit,\n@@ -173,7 +197,7 @@ class FitbitSensorEntityDescription(SensorEntityDescription):\n     ),\n     FitbitSensorEntityDescription(\n         key=\"activities/floors\",\n-        name=\"Floors\",\n+        translation_key=\"floors\",\n         native_unit_of_measurement=\"floors\",\n         icon=\"mdi:walk\",\n         scope=FitbitScope.ACTIVITY,\n@@ -182,7 +206,7 @@ class FitbitSensorEntityDescription(SensorEntityDescription):\n     ),\n     FitbitSensorEntityDescription(\n         key=\"activities/heart\",\n-        name=\"Resting Heart Rate\",\n+        translation_key=\"resting_heart_rate\",\n         native_unit_of_measurement=\"bpm\",\n         icon=\"mdi:heart-pulse\",\n         value_fn=_int_value_or_none(\"restingHeartRate\"),\n@@ -191,7 +215,7 @@ class FitbitSensorEntityDescription(SensorEntityDescription):\n     ),\n     FitbitSensorEntityDescription(\n         key=\"activities/minutesFairlyActive\",\n-        name=\"Minutes Fairly Active\",\n+        translation_key=\"minutes_fairly_active\",\n         native_unit_of_measurement=UnitOfTime.MINUTES,\n         icon=\"mdi:walk\",\n         device_class=SensorDeviceClass.DURATION,\n@@ -201,7 +225,7 @@ class FitbitSensorEntityDescription(SensorEntityDescription):\n     ),\n     FitbitSensorEntityDescription(\n         key=\"activities/minutesLightlyActive\",\n-        name=\"Minutes Lightly Active\",\n+        translation_key=\"minutes_lightly_active\",\n         native_unit_of_measurement=UnitOfTime.MINUTES,\n         icon=\"mdi:walk\",\n         device_class=SensorDeviceClass.DURATION,\n@@ -211,7 +235,7 @@ class FitbitSensorEntityDescription(SensorEntityDescription):\n     ),\n     FitbitSensorEntityDescription(\n         key=\"activities/minutesSedentary\",\n-        name=\"Minutes Sedentary\",\n+        translation_key=\"minutes_sedentary\",\n         native_unit_of_measurement=UnitOfTime.MINUTES,\n         icon=\"mdi:seat-recline-normal\",\n         device_class=SensorDeviceClass.DURATION,\n@@ -221,7 +245,7 @@ class FitbitSensorEntityDescription(SensorEntityDescription):\n     ),\n     FitbitSensorEntityDescription(\n         key=\"activities/minutesVeryActive\",\n-        name=\"Minutes Very Active\",\n+        translation_key=\"minutes_very_active\",\n         native_unit_of_measurement=UnitOfTime.MINUTES,\n         icon=\"mdi:run\",\n         device_class=SensorDeviceClass.DURATION,\n@@ -231,7 +255,7 @@ class FitbitSensorEntityDescription(SensorEntityDescription):\n     ),\n     FitbitSensorEntityDescription(\n         key=\"activities/steps\",\n-        name=\"Steps\",\n+        translation_key=\"steps\",\n         native_unit_of_measurement=\"steps\",\n         icon=\"mdi:walk\",\n         scope=FitbitScope.ACTIVITY,\n@@ -239,7 +263,7 @@ class FitbitSensorEntityDescription(SensorEntityDescription):\n     ),\n     FitbitSensorEntityDescription(\n         key=\"activities/tracker/activityCalories\",\n-        name=\"Tracker Activity Calories\",\n+        translation_key=\"activity_calories\",\n         native_unit_of_measurement=\"cal\",\n         icon=\"mdi:fire\",\n         scope=FitbitScope.ACTIVITY,\n@@ -249,7 +273,7 @@ class FitbitSensorEntityDescription(SensorEntityDescription):\n     ),\n     FitbitSensorEntityDescription(\n         key=\"activities/tracker/calories\",\n-        name=\"Tracker Calories\",\n+        translation_key=\"calories\",\n         native_unit_of_measurement=\"cal\",\n         icon=\"mdi:fire\",\n         scope=FitbitScope.ACTIVITY,\n@@ -259,7 +283,6 @@ class FitbitSensorEntityDescription(SensorEntityDescription):\n     ),\n     FitbitSensorEntityDescription(\n         key=\"activities/tracker/distance\",\n-        name=\"Tracker Distance\",\n         icon=\"mdi:map-marker\",\n         device_class=SensorDeviceClass.DISTANCE,\n         value_fn=_distance_value_fn,\n@@ -271,7 +294,7 @@ class FitbitSensorEntityDescription(SensorEntityDescription):\n     ),\n     FitbitSensorEntityDescription(\n         key=\"activities/tracker/elevation\",\n-        name=\"Tracker Elevation\",\n+        translation_key=\"elevation\",\n         icon=\"mdi:walk\",\n         device_class=SensorDeviceClass.DISTANCE,\n         unit_fn=_elevation_unit,\n@@ -282,7 +305,7 @@ class FitbitSensorEntityDescription(SensorEntityDescription):\n     ),\n     FitbitSensorEntityDescription(\n         key=\"activities/tracker/floors\",\n-        name=\"Tracker Floors\",\n+        translation_key=\"floors\",\n         native_unit_of_measurement=\"floors\",\n         icon=\"mdi:walk\",\n         scope=FitbitScope.ACTIVITY,\n@@ -292,7 +315,7 @@ class FitbitSensorEntityDescription(SensorEntityDescription):\n     ),\n     FitbitSensorEntityDescription(\n         key=\"activities/tracker/minutesFairlyActive\",\n-        name=\"Tracker Minutes Fairly Active\",\n+        translation_key=\"minutes_fairly_active\",\n         native_unit_of_measurement=UnitOfTime.MINUTES,\n         icon=\"mdi:walk\",\n         device_class=SensorDeviceClass.DURATION,\n@@ -303,7 +326,7 @@ class FitbitSensorEntityDescription(SensorEntityDescription):\n     ),\n     FitbitSensorEntityDescription(\n         key=\"activities/tracker/minutesLightlyActive\",\n-        name=\"Tracker Minutes Lightly Active\",\n+        translation_key=\"minutes_lightly_active\",\n         native_unit_of_measurement=UnitOfTime.MINUTES,\n         icon=\"mdi:walk\",\n         device_class=SensorDeviceClass.DURATION,\n@@ -314,7 +337,7 @@ class FitbitSensorEntityDescription(SensorEntityDescription):\n     ),\n     FitbitSensorEntityDescription(\n         key=\"activities/tracker/minutesSedentary\",\n-        name=\"Tracker Minutes Sedentary\",\n+        translation_key=\"minutes_sedentary\",\n         native_unit_of_measurement=UnitOfTime.MINUTES,\n         icon=\"mdi:seat-recline-normal\",\n         device_class=SensorDeviceClass.DURATION,\n@@ -325,7 +348,7 @@ class FitbitSensorEntityDescription(SensorEntityDescription):\n     ),\n     FitbitSensorEntityDescription(\n         key=\"activities/tracker/minutesVeryActive\",\n-        name=\"Tracker Minutes Very Active\",\n+        translation_key=\"minutes_very_active\",\n         native_unit_of_measurement=UnitOfTime.MINUTES,\n         icon=\"mdi:run\",\n         device_class=SensorDeviceClass.DURATION,\n@@ -336,7 +359,7 @@ class FitbitSensorEntityDescription(SensorEntityDescription):\n     ),\n     FitbitSensorEntityDescription(\n         key=\"activities/tracker/steps\",\n-        name=\"Tracker Steps\",\n+        translation_key=\"steps\",\n         native_unit_of_measurement=\"steps\",\n         icon=\"mdi:walk\",\n         scope=FitbitScope.ACTIVITY,\n@@ -346,7 +369,7 @@ class FitbitSensorEntityDescription(SensorEntityDescription):\n     ),\n     FitbitSensorEntityDescription(\n         key=\"body/bmi\",\n-        name=\"BMI\",\n+        translation_key=\"bmi\",\n         native_unit_of_measurement=\"BMI\",\n         icon=\"mdi:human\",\n         state_class=SensorStateClass.MEASUREMENT,\n@@ -357,7 +380,7 @@ class FitbitSensorEntityDescription(SensorEntityDescription):\n     ),\n     FitbitSensorEntityDescription(\n         key=\"body/fat\",\n-        name=\"Body Fat\",\n+        translation_key=\"body_fat\",\n         native_unit_of_measurement=PERCENTAGE,\n         icon=\"mdi:human\",\n         state_class=SensorStateClass.MEASUREMENT,\n@@ -368,7 +391,6 @@ class FitbitSensorEntityDescription(SensorEntityDescription):\n     ),\n     FitbitSensorEntityDescription(\n         key=\"body/weight\",\n-        name=\"Weight\",\n         icon=\"mdi:human\",\n         state_class=SensorStateClass.MEASUREMENT,\n         device_class=SensorDeviceClass.WEIGHT,\n@@ -378,7 +400,7 @@ class FitbitSensorEntityDescription(SensorEntityDescription):\n     ),\n     FitbitSensorEntityDescription(\n         key=\"sleep/awakeningsCount\",\n-        name=\"Awakenings Count\",\n+        translation_key=\"awakenings_count\",\n         native_unit_of_measurement=\"times awaken\",\n         icon=\"mdi:sleep\",\n         scope=FitbitScope.SLEEP,\n@@ -387,7 +409,7 @@ class FitbitSensorEntityDescription(SensorEntityDescription):\n     ),\n     FitbitSensorEntityDescription(\n         key=\"sleep/efficiency\",\n-        name=\"Sleep Efficiency\",\n+        translation_key=\"sleep_efficiency\",\n         native_unit_of_measurement=PERCENTAGE,\n         icon=\"mdi:sleep\",\n         state_class=SensorStateClass.MEASUREMENT,\n@@ -396,7 +418,7 @@ class FitbitSensorEntityDescription(SensorEntityDescription):\n     ),\n     FitbitSensorEntityDescription(\n         key=\"sleep/minutesAfterWakeup\",\n-        name=\"Minutes After Wakeup\",\n+        translation_key=\"minutes_after_wakeup\",\n         native_unit_of_measurement=UnitOfTime.MINUTES,\n         icon=\"mdi:sleep\",\n         device_class=SensorDeviceClass.DURATION,\n@@ -406,7 +428,7 @@ class FitbitSensorEntityDescription(SensorEntityDescription):\n     ),\n     FitbitSensorEntityDescription(\n         key=\"sleep/minutesAsleep\",\n-        name=\"Sleep Minutes Asleep\",\n+        translation_key=\"sleep_minutes_asleep\",\n         native_unit_of_measurement=UnitOfTime.MINUTES,\n         icon=\"mdi:sleep\",\n         device_class=SensorDeviceClass.DURATION,\n@@ -416,7 +438,7 @@ class FitbitSensorEntityDescription(SensorEntityDescription):\n     ),\n     FitbitSensorEntityDescription(\n         key=\"sleep/minutesAwake\",\n-        name=\"Sleep Minutes Awake\",\n+        translation_key=\"sleep_minutes_awake\",\n         native_unit_of_measurement=UnitOfTime.MINUTES,\n         icon=\"mdi:sleep\",\n         device_class=SensorDeviceClass.DURATION,\n@@ -426,7 +448,7 @@ class FitbitSensorEntityDescription(SensorEntityDescription):\n     ),\n     FitbitSensorEntityDescription(\n         key=\"sleep/minutesToFallAsleep\",\n-        name=\"Sleep Minutes to Fall Asleep\",\n+        translation_key=\"sleep_minutes_to_fall_asleep\",\n         native_unit_of_measurement=UnitOfTime.MINUTES,\n         icon=\"mdi:sleep\",\n         device_class=SensorDeviceClass.DURATION,\n@@ -436,7 +458,7 @@ class FitbitSensorEntityDescription(SensorEntityDescription):\n     ),\n     FitbitSensorEntityDescription(\n         key=\"sleep/timeInBed\",\n-        name=\"Sleep Time in Bed\",\n+        translation_key=\"sleep_time_in_bed\",\n         native_unit_of_measurement=UnitOfTime.MINUTES,\n         icon=\"mdi:hotel\",\n         device_class=SensorDeviceClass.DURATION,\n@@ -446,7 +468,7 @@ class FitbitSensorEntityDescription(SensorEntityDescription):\n     ),\n     FitbitSensorEntityDescription(\n         key=\"foods/log/caloriesIn\",\n-        name=\"Calories In\",\n+        translation_key=\"calories_in\",\n         native_unit_of_measurement=\"cal\",\n         icon=\"mdi:food-apple\",\n         state_class=SensorStateClass.TOTAL_INCREASING,\n@@ -455,7 +477,7 @@ class FitbitSensorEntityDescription(SensorEntityDescription):\n     ),\n     FitbitSensorEntityDescription(\n         key=\"foods/log/water\",\n-        name=\"Water\",\n+        translation_key=\"water\",\n         icon=\"mdi:cup-water\",\n         unit_fn=_water_unit,\n         state_class=SensorStateClass.TOTAL_INCREASING,\n@@ -467,14 +489,14 @@ class FitbitSensorEntityDescription(SensorEntityDescription):\n # Different description depending on clock format\n SLEEP_START_TIME = FitbitSensorEntityDescription(\n     key=\"sleep/startTime\",\n-    name=\"Sleep Start Time\",\n+    translation_key=\"sleep_start_time\",\n     icon=\"mdi:clock\",\n     scope=FitbitScope.SLEEP,\n     entity_category=EntityCategory.DIAGNOSTIC,\n )\n SLEEP_START_TIME_12HR = FitbitSensorEntityDescription(\n     key=\"sleep/startTime\",\n-    name=\"Sleep Start Time\",\n+    translation_key=\"sleep_start_time\",\n     icon=\"mdi:clock\",\n     value_fn=_clock_format_12h,\n     scope=FitbitScope.SLEEP,\n@@ -540,6 +562,7 @@ def is_allowed_resource(description: FitbitSensorEntityDescription) -> bool:\n             description,\n             units=description.unit_fn(unit_system),\n             enable_default_override=is_explicit_enable(description),\n+            device_info=_build_device_info(entry, description),\n         )\n         for description in resource_list\n         if is_allowed_resource(description)\n@@ -574,6 +597,7 @@ class FitbitSensor(SensorEntity):\n \n     entity_description: FitbitSensorEntityDescription\n     _attr_attribution = ATTRIBUTION\n+    _attr_has_entity_name = True\n \n     def __init__(\n         self,\n@@ -583,6 +607,7 @@ def __init__(\n         description: FitbitSensorEntityDescription,\n         units: str | None,\n         enable_default_override: bool,\n+        device_info: DeviceInfo,\n     ) -> None:\n         \"\"\"Initialize the Fitbit sensor.\"\"\"\n         self.config_entry = config_entry\n@@ -590,6 +615,7 @@ def __init__(\n         self.api = api\n \n         self._attr_unique_id = f\"{user_profile_id}_{description.key}\"\n+        self._attr_device_info = device_info\n \n         if units is not None:\n             self._attr_native_unit_of_measurement = units\ndiff --git a/homeassistant/components/fitbit/strings.json b/homeassistant/components/fitbit/strings.json\nindex 2df6fa14b0789..9029a8265bb6e 100644\n--- a/homeassistant/components/fitbit/strings.json\n+++ b/homeassistant/components/fitbit/strings.json\n@@ -38,7 +38,82 @@\n       },\n       \"battery_level\": {\n         \"name\": \"Battery level\"\n+      },\n+      \"activity_calories\": {\n+        \"name\": \"Activity calories\"\n+      },\n+      \"calories\": {\n+        \"name\": \"Calories\"\n+      },\n+      \"calories_bmr\": {\n+        \"name\": \"Calories BMR\"\n+      },\n+      \"elevation\": {\n+        \"name\": \"Elevation\"\n+      },\n+      \"floors\": {\n+        \"name\": \"Floors\"\n+      },\n+      \"resting_heart_rate\": {\n+        \"name\": \"Resting heart rate\"\n+      },\n+      \"minutes_fairly_active\": {\n+        \"name\": \"Minutes fairly active\"\n+      },\n+      \"minutes_lightly_active\": {\n+        \"name\": \"Minutes lightly active\"\n+      },\n+      \"minutes_sedentary\": {\n+        \"name\": \"Minutes sedentary\"\n+      },\n+      \"minutes_very_active\": {\n+        \"name\": \"Minutes very active\"\n+      },\n+      \"sleep_start_time\": {\n+        \"name\": \"Sleep start time\"\n+      },\n+      \"steps\": {\n+        \"name\": \"Steps\"\n+      },\n+      \"bmi\": {\n+        \"name\": \"BMI\"\n+      },\n+      \"body_fat\": {\n+        \"name\": \"Body fat\"\n+      },\n+      \"awakenings_count\": {\n+        \"name\": \"Awakenings count\"\n+      },\n+      \"sleep_efficiency\": {\n+        \"name\": \"Sleep efficiency\"\n+      },\n+      \"minutes_after_wakeup\": {\n+        \"name\": \"Minutes after wakeup\"\n+      },\n+      \"sleep_minutes_asleep\": {\n+        \"name\": \"Sleep minutes asleep\"\n+      },\n+      \"sleep_minutes_awake\": {\n+        \"name\": \"Sleep minutes awake\"\n+      },\n+      \"sleep_minutes_to_fall_asleep\": {\n+        \"name\": \"Sleep minutes to fall asleep\"\n+      },\n+      \"sleep_time_in_bed\": {\n+        \"name\": \"Sleep time in bed\"\n+      },\n+      \"calories_in\": {\n+        \"name\": \"Calories in\"\n+      },\n+      \"water\": {\n+        \"name\": \"Water\"\n       }\n     }\n+  },\n+\n+  \"device\": {\n+    \"tracker\": {\n+      \"name\": \"{display_name} tracker\"\n+    }\n   }\n }\n", "test_patch": "diff --git a/tests/components/fitbit/conftest.py b/tests/components/fitbit/conftest.py\nindex 48ceca02d0e63..8a408748f16a3 100644\n--- a/tests/components/fitbit/conftest.py\n+++ b/tests/components/fitbit/conftest.py\n@@ -90,6 +90,7 @@ def mock_config_entry(\n             **imported_config_data,\n         },\n         unique_id=PROFILE_USER_ID,\n+        title=DISPLAY_NAME,\n     )\n \n \ndiff --git a/tests/components/fitbit/snapshots/test_sensor.ambr b/tests/components/fitbit/snapshots/test_sensor.ambr\nindex 55b2639a56da3..068df25454d25 100644\n--- a/tests/components/fitbit/snapshots/test_sensor.ambr\n+++ b/tests/components/fitbit/snapshots/test_sensor.ambr\n@@ -4,7 +4,7 @@\n     '99',\n     ReadOnlyDict({\n       'attribution': 'Data provided by Fitbit.com',\n-      'friendly_name': 'Water',\n+      'friendly_name': 'First L. Water',\n       'icon': 'mdi:cup-water',\n       'state_class': <SensorStateClass.TOTAL_INCREASING: 'total_increasing'>,\n       'unit_of_measurement': <UnitOfVolume.MILLILITERS: 'mL'>,\n@@ -16,7 +16,7 @@\n     '1600',\n     ReadOnlyDict({\n       'attribution': 'Data provided by Fitbit.com',\n-      'friendly_name': 'Calories In',\n+      'friendly_name': 'First L. Calories in',\n       'icon': 'mdi:food-apple',\n       'state_class': <SensorStateClass.TOTAL_INCREASING: 'total_increasing'>,\n       'unit_of_measurement': 'cal',\n@@ -28,7 +28,7 @@\n     '99',\n     ReadOnlyDict({\n       'attribution': 'Data provided by Fitbit.com',\n-      'friendly_name': 'Water',\n+      'friendly_name': 'First L. Water',\n       'icon': 'mdi:cup-water',\n       'state_class': <SensorStateClass.TOTAL_INCREASING: 'total_increasing'>,\n       'unit_of_measurement': <UnitOfVolume.FLUID_OUNCES: 'fl. oz.'>,\n@@ -40,19 +40,19 @@\n     '1600',\n     ReadOnlyDict({\n       'attribution': 'Data provided by Fitbit.com',\n-      'friendly_name': 'Calories In',\n+      'friendly_name': 'First L. Calories in',\n       'icon': 'mdi:food-apple',\n       'state_class': <SensorStateClass.TOTAL_INCREASING: 'total_increasing'>,\n       'unit_of_measurement': 'cal',\n     }),\n   )\n # ---\n-# name: test_sensors[monitored_resources0-sensor.activity_calories-activities/activityCalories-135]\n+# name: test_sensors[monitored_resources0-sensor.first_l_activity_calories-activities/activityCalories-135]\n   tuple(\n     '135',\n     ReadOnlyDict({\n       'attribution': 'Data provided by Fitbit.com',\n-      'friendly_name': 'Activity Calories',\n+      'friendly_name': 'First L. Activity calories',\n       'icon': 'mdi:fire',\n       'state_class': <SensorStateClass.TOTAL_INCREASING: 'total_increasing'>,\n       'unit_of_measurement': 'cal',\n@@ -60,25 +60,67 @@\n     'fitbit-api-user-id-1_activities/activityCalories',\n   )\n # ---\n-# name: test_sensors[monitored_resources1-sensor.calories-activities/calories-139]\n+# name: test_sensors[monitored_resources1-sensor.first_l_tracker_activity_calories-activities/tracker/activityCalories-135]\n   tuple(\n-    '139',\n+    '135',\n     ReadOnlyDict({\n       'attribution': 'Data provided by Fitbit.com',\n-      'friendly_name': 'Calories',\n+      'friendly_name': 'First L. tracker Activity calories',\n       'icon': 'mdi:fire',\n       'state_class': <SensorStateClass.TOTAL_INCREASING: 'total_increasing'>,\n       'unit_of_measurement': 'cal',\n     }),\n-    'fitbit-api-user-id-1_activities/calories',\n+    'fitbit-api-user-id-1_activities/tracker/activityCalories',\n+  )\n+# ---\n+# name: test_sensors[monitored_resources10-sensor.first_l_minutes_lightly_active-activities/minutesLightlyActive-95]\n+  tuple(\n+    '95',\n+    ReadOnlyDict({\n+      'attribution': 'Data provided by Fitbit.com',\n+      'device_class': 'duration',\n+      'friendly_name': 'First L. Minutes lightly active',\n+      'icon': 'mdi:walk',\n+      'state_class': <SensorStateClass.MEASUREMENT: 'measurement'>,\n+      'unit_of_measurement': <UnitOfTime.MINUTES: 'min'>,\n+    }),\n+    'fitbit-api-user-id-1_activities/minutesLightlyActive',\n   )\n # ---\n-# name: test_sensors[monitored_resources10-sensor.steps-activities/steps-5600]\n+# name: test_sensors[monitored_resources11-sensor.first_l_minutes_sedentary-activities/minutesSedentary-18]\n+  tuple(\n+    '18',\n+    ReadOnlyDict({\n+      'attribution': 'Data provided by Fitbit.com',\n+      'device_class': 'duration',\n+      'friendly_name': 'First L. Minutes sedentary',\n+      'icon': 'mdi:seat-recline-normal',\n+      'state_class': <SensorStateClass.MEASUREMENT: 'measurement'>,\n+      'unit_of_measurement': <UnitOfTime.MINUTES: 'min'>,\n+    }),\n+    'fitbit-api-user-id-1_activities/minutesSedentary',\n+  )\n+# ---\n+# name: test_sensors[monitored_resources12-sensor.first_l_minutes_very_active-activities/minutesVeryActive-20]\n+  tuple(\n+    '20',\n+    ReadOnlyDict({\n+      'attribution': 'Data provided by Fitbit.com',\n+      'device_class': 'duration',\n+      'friendly_name': 'First L. Minutes very active',\n+      'icon': 'mdi:run',\n+      'state_class': <SensorStateClass.MEASUREMENT: 'measurement'>,\n+      'unit_of_measurement': <UnitOfTime.MINUTES: 'min'>,\n+    }),\n+    'fitbit-api-user-id-1_activities/minutesVeryActive',\n+  )\n+# ---\n+# name: test_sensors[monitored_resources13-sensor.first_l_steps-activities/steps-5600]\n   tuple(\n     '5600',\n     ReadOnlyDict({\n       'attribution': 'Data provided by Fitbit.com',\n-      'friendly_name': 'Steps',\n+      'friendly_name': 'First L. Steps',\n       'icon': 'mdi:walk',\n       'state_class': <SensorStateClass.TOTAL_INCREASING: 'total_increasing'>,\n       'unit_of_measurement': 'steps',\n@@ -86,13 +128,13 @@\n     'fitbit-api-user-id-1_activities/steps',\n   )\n # ---\n-# name: test_sensors[monitored_resources11-sensor.weight-body/weight-175]\n+# name: test_sensors[monitored_resources14-sensor.first_l_weight-body/weight-175]\n   tuple(\n     '175.0',\n     ReadOnlyDict({\n       'attribution': 'Data provided by Fitbit.com',\n       'device_class': 'weight',\n-      'friendly_name': 'Weight',\n+      'friendly_name': 'First L. Weight',\n       'icon': 'mdi:human',\n       'state_class': <SensorStateClass.MEASUREMENT: 'measurement'>,\n       'unit_of_measurement': <UnitOfMass.KILOGRAMS: 'kg'>,\n@@ -100,12 +142,12 @@\n     'fitbit-api-user-id-1_body/weight',\n   )\n # ---\n-# name: test_sensors[monitored_resources12-sensor.body_fat-body/fat-18]\n+# name: test_sensors[monitored_resources15-sensor.first_l_body_fat-body/fat-18]\n   tuple(\n     '18.0',\n     ReadOnlyDict({\n       'attribution': 'Data provided by Fitbit.com',\n-      'friendly_name': 'Body Fat',\n+      'friendly_name': 'First L. Body fat',\n       'icon': 'mdi:human',\n       'state_class': <SensorStateClass.MEASUREMENT: 'measurement'>,\n       'unit_of_measurement': '%',\n@@ -113,12 +155,12 @@\n     'fitbit-api-user-id-1_body/fat',\n   )\n # ---\n-# name: test_sensors[monitored_resources13-sensor.bmi-body/bmi-23.7]\n+# name: test_sensors[monitored_resources16-sensor.first_l_bmi-body/bmi-23.7]\n   tuple(\n     '23.7',\n     ReadOnlyDict({\n       'attribution': 'Data provided by Fitbit.com',\n-      'friendly_name': 'BMI',\n+      'friendly_name': 'First L. BMI',\n       'icon': 'mdi:human',\n       'state_class': <SensorStateClass.MEASUREMENT: 'measurement'>,\n       'unit_of_measurement': 'BMI',\n@@ -126,12 +168,12 @@\n     'fitbit-api-user-id-1_body/bmi',\n   )\n # ---\n-# name: test_sensors[monitored_resources14-sensor.awakenings_count-sleep/awakeningsCount-7]\n+# name: test_sensors[monitored_resources17-sensor.first_l_awakenings_count-sleep/awakeningsCount-7]\n   tuple(\n     '7',\n     ReadOnlyDict({\n       'attribution': 'Data provided by Fitbit.com',\n-      'friendly_name': 'Awakenings Count',\n+      'friendly_name': 'First L. Awakenings count',\n       'icon': 'mdi:sleep',\n       'state_class': <SensorStateClass.TOTAL_INCREASING: 'total_increasing'>,\n       'unit_of_measurement': 'times awaken',\n@@ -139,12 +181,12 @@\n     'fitbit-api-user-id-1_sleep/awakeningsCount',\n   )\n # ---\n-# name: test_sensors[monitored_resources15-sensor.sleep_efficiency-sleep/efficiency-80]\n+# name: test_sensors[monitored_resources18-sensor.first_l_sleep_efficiency-sleep/efficiency-80]\n   tuple(\n     '80',\n     ReadOnlyDict({\n       'attribution': 'Data provided by Fitbit.com',\n-      'friendly_name': 'Sleep Efficiency',\n+      'friendly_name': 'First L. Sleep efficiency',\n       'icon': 'mdi:sleep',\n       'state_class': <SensorStateClass.MEASUREMENT: 'measurement'>,\n       'unit_of_measurement': '%',\n@@ -152,13 +194,13 @@\n     'fitbit-api-user-id-1_sleep/efficiency',\n   )\n # ---\n-# name: test_sensors[monitored_resources16-sensor.minutes_after_wakeup-sleep/minutesAfterWakeup-17]\n+# name: test_sensors[monitored_resources19-sensor.first_l_minutes_after_wakeup-sleep/minutesAfterWakeup-17]\n   tuple(\n     '17',\n     ReadOnlyDict({\n       'attribution': 'Data provided by Fitbit.com',\n       'device_class': 'duration',\n-      'friendly_name': 'Minutes After Wakeup',\n+      'friendly_name': 'First L. Minutes after wakeup',\n       'icon': 'mdi:sleep',\n       'state_class': <SensorStateClass.MEASUREMENT: 'measurement'>,\n       'unit_of_measurement': <UnitOfTime.MINUTES: 'min'>,\n@@ -166,13 +208,26 @@\n     'fitbit-api-user-id-1_sleep/minutesAfterWakeup',\n   )\n # ---\n-# name: test_sensors[monitored_resources17-sensor.sleep_minutes_asleep-sleep/minutesAsleep-360]\n+# name: test_sensors[monitored_resources2-sensor.first_l_calories-activities/calories-139]\n+  tuple(\n+    '139',\n+    ReadOnlyDict({\n+      'attribution': 'Data provided by Fitbit.com',\n+      'friendly_name': 'First L. Calories',\n+      'icon': 'mdi:fire',\n+      'state_class': <SensorStateClass.TOTAL_INCREASING: 'total_increasing'>,\n+      'unit_of_measurement': 'cal',\n+    }),\n+    'fitbit-api-user-id-1_activities/calories',\n+  )\n+# ---\n+# name: test_sensors[monitored_resources20-sensor.first_l_sleep_minutes_asleep-sleep/minutesAsleep-360]\n   tuple(\n     '360',\n     ReadOnlyDict({\n       'attribution': 'Data provided by Fitbit.com',\n       'device_class': 'duration',\n-      'friendly_name': 'Sleep Minutes Asleep',\n+      'friendly_name': 'First L. Sleep minutes asleep',\n       'icon': 'mdi:sleep',\n       'state_class': <SensorStateClass.TOTAL_INCREASING: 'total_increasing'>,\n       'unit_of_measurement': <UnitOfTime.MINUTES: 'min'>,\n@@ -180,13 +235,13 @@\n     'fitbit-api-user-id-1_sleep/minutesAsleep',\n   )\n # ---\n-# name: test_sensors[monitored_resources18-sensor.sleep_minutes_awake-sleep/minutesAwake-35]\n+# name: test_sensors[monitored_resources21-sensor.first_l_sleep_minutes_awake-sleep/minutesAwake-35]\n   tuple(\n     '35',\n     ReadOnlyDict({\n       'attribution': 'Data provided by Fitbit.com',\n       'device_class': 'duration',\n-      'friendly_name': 'Sleep Minutes Awake',\n+      'friendly_name': 'First L. Sleep minutes awake',\n       'icon': 'mdi:sleep',\n       'state_class': <SensorStateClass.TOTAL_INCREASING: 'total_increasing'>,\n       'unit_of_measurement': <UnitOfTime.MINUTES: 'min'>,\n@@ -194,13 +249,13 @@\n     'fitbit-api-user-id-1_sleep/minutesAwake',\n   )\n # ---\n-# name: test_sensors[monitored_resources19-sensor.sleep_minutes_to_fall_asleep-sleep/minutesToFallAsleep-35]\n+# name: test_sensors[monitored_resources22-sensor.first_l_sleep_minutes_to_fall_asleep-sleep/minutesToFallAsleep-35]\n   tuple(\n     '35',\n     ReadOnlyDict({\n       'attribution': 'Data provided by Fitbit.com',\n       'device_class': 'duration',\n-      'friendly_name': 'Sleep Minutes to Fall Asleep',\n+      'friendly_name': 'First L. Sleep minutes to fall asleep',\n       'icon': 'mdi:sleep',\n       'state_class': <SensorStateClass.TOTAL_INCREASING: 'total_increasing'>,\n       'unit_of_measurement': <UnitOfTime.MINUTES: 'min'>,\n@@ -208,38 +263,24 @@\n     'fitbit-api-user-id-1_sleep/minutesToFallAsleep',\n   )\n # ---\n-# name: test_sensors[monitored_resources2-sensor.distance-activities/distance-12.7]\n-  tuple(\n-    '12.70',\n-    ReadOnlyDict({\n-      'attribution': 'Data provided by Fitbit.com',\n-      'device_class': 'distance',\n-      'friendly_name': 'Distance',\n-      'icon': 'mdi:map-marker',\n-      'state_class': <SensorStateClass.TOTAL_INCREASING: 'total_increasing'>,\n-      'unit_of_measurement': <UnitOfLength.KILOMETERS: 'km'>,\n-    }),\n-    'fitbit-api-user-id-1_activities/distance',\n-  )\n-# ---\n-# name: test_sensors[monitored_resources20-sensor.sleep_start_time-sleep/startTime-2020-01-27T00:17:30.000]\n+# name: test_sensors[monitored_resources23-sensor.first_l_sleep_start_time-sleep/startTime-2020-01-27T00:17:30.000]\n   tuple(\n     '2020-01-27T00:17:30.000',\n     ReadOnlyDict({\n       'attribution': 'Data provided by Fitbit.com',\n-      'friendly_name': 'Sleep Start Time',\n+      'friendly_name': 'First L. Sleep start time',\n       'icon': 'mdi:clock',\n     }),\n     'fitbit-api-user-id-1_sleep/startTime',\n   )\n # ---\n-# name: test_sensors[monitored_resources21-sensor.sleep_time_in_bed-sleep/timeInBed-462]\n+# name: test_sensors[monitored_resources24-sensor.first_l_sleep_time_in_bed-sleep/timeInBed-462]\n   tuple(\n     '462',\n     ReadOnlyDict({\n       'attribution': 'Data provided by Fitbit.com',\n       'device_class': 'duration',\n-      'friendly_name': 'Sleep Time in Bed',\n+      'friendly_name': 'First L. Sleep time in bed',\n       'icon': 'mdi:hotel',\n       'state_class': <SensorStateClass.TOTAL_INCREASING: 'total_increasing'>,\n       'unit_of_measurement': <UnitOfTime.MINUTES: 'min'>,\n@@ -247,99 +288,98 @@\n     'fitbit-api-user-id-1_sleep/timeInBed',\n   )\n # ---\n-# name: test_sensors[monitored_resources3-sensor.elevation-activities/elevation-7600.24]\n+# name: test_sensors[monitored_resources3-sensor.first_l_tracker_calories-activities/tracker/calories-139]\n   tuple(\n-    '7600.24',\n+    '139',\n     ReadOnlyDict({\n       'attribution': 'Data provided by Fitbit.com',\n-      'device_class': 'distance',\n-      'friendly_name': 'Elevation',\n-      'icon': 'mdi:walk',\n-      'state_class': <SensorStateClass.MEASUREMENT: 'measurement'>,\n-      'unit_of_measurement': <UnitOfLength.METERS: 'm'>,\n+      'friendly_name': 'First L. tracker Calories',\n+      'icon': 'mdi:fire',\n+      'state_class': <SensorStateClass.TOTAL_INCREASING: 'total_increasing'>,\n+      'unit_of_measurement': 'cal',\n     }),\n-    'fitbit-api-user-id-1_activities/elevation',\n+    'fitbit-api-user-id-1_activities/tracker/calories',\n   )\n # ---\n-# name: test_sensors[monitored_resources4-sensor.floors-activities/floors-8]\n+# name: test_sensors[monitored_resources4-sensor.first_l_distance-activities/distance-12.7]\n   tuple(\n-    '8',\n+    '12.70',\n     ReadOnlyDict({\n       'attribution': 'Data provided by Fitbit.com',\n-      'friendly_name': 'Floors',\n-      'icon': 'mdi:walk',\n+      'device_class': 'distance',\n+      'friendly_name': 'First L. Distance',\n+      'icon': 'mdi:map-marker',\n       'state_class': <SensorStateClass.TOTAL_INCREASING: 'total_increasing'>,\n-      'unit_of_measurement': 'floors',\n+      'unit_of_measurement': <UnitOfLength.KILOMETERS: 'km'>,\n     }),\n-    'fitbit-api-user-id-1_activities/floors',\n+    'fitbit-api-user-id-1_activities/distance',\n   )\n # ---\n-# name: test_sensors[monitored_resources5-sensor.resting_heart_rate-activities/heart-api_value5]\n+# name: test_sensors[monitored_resources5-sensor.first_l_tracker_distance-activities/distance-12.7]\n   tuple(\n-    '76',\n+    'unknown',\n     ReadOnlyDict({\n       'attribution': 'Data provided by Fitbit.com',\n-      'friendly_name': 'Resting Heart Rate',\n-      'icon': 'mdi:heart-pulse',\n-      'state_class': <SensorStateClass.MEASUREMENT: 'measurement'>,\n-      'unit_of_measurement': 'bpm',\n+      'device_class': 'distance',\n+      'friendly_name': 'First L. tracker Distance',\n+      'icon': 'mdi:map-marker',\n+      'state_class': <SensorStateClass.TOTAL_INCREASING: 'total_increasing'>,\n+      'unit_of_measurement': <UnitOfLength.KILOMETERS: 'km'>,\n     }),\n-    'fitbit-api-user-id-1_activities/heart',\n+    'fitbit-api-user-id-1_activities/tracker/distance',\n   )\n # ---\n-# name: test_sensors[monitored_resources6-sensor.minutes_fairly_active-activities/minutesFairlyActive-35]\n+# name: test_sensors[monitored_resources6-sensor.first_l_elevation-activities/elevation-7600.24]\n   tuple(\n-    '35',\n+    '7600.24',\n     ReadOnlyDict({\n       'attribution': 'Data provided by Fitbit.com',\n-      'device_class': 'duration',\n-      'friendly_name': 'Minutes Fairly Active',\n+      'device_class': 'distance',\n+      'friendly_name': 'First L. Elevation',\n       'icon': 'mdi:walk',\n       'state_class': <SensorStateClass.MEASUREMENT: 'measurement'>,\n-      'unit_of_measurement': <UnitOfTime.MINUTES: 'min'>,\n+      'unit_of_measurement': <UnitOfLength.METERS: 'm'>,\n     }),\n-    'fitbit-api-user-id-1_activities/minutesFairlyActive',\n+    'fitbit-api-user-id-1_activities/elevation',\n   )\n # ---\n-# name: test_sensors[monitored_resources7-sensor.minutes_lightly_active-activities/minutesLightlyActive-95]\n+# name: test_sensors[monitored_resources7-sensor.first_l_floors-activities/floors-8]\n   tuple(\n-    '95',\n+    '8',\n     ReadOnlyDict({\n       'attribution': 'Data provided by Fitbit.com',\n-      'device_class': 'duration',\n-      'friendly_name': 'Minutes Lightly Active',\n+      'friendly_name': 'First L. Floors',\n       'icon': 'mdi:walk',\n-      'state_class': <SensorStateClass.MEASUREMENT: 'measurement'>,\n-      'unit_of_measurement': <UnitOfTime.MINUTES: 'min'>,\n+      'state_class': <SensorStateClass.TOTAL_INCREASING: 'total_increasing'>,\n+      'unit_of_measurement': 'floors',\n     }),\n-    'fitbit-api-user-id-1_activities/minutesLightlyActive',\n+    'fitbit-api-user-id-1_activities/floors',\n   )\n # ---\n-# name: test_sensors[monitored_resources8-sensor.minutes_sedentary-activities/minutesSedentary-18]\n+# name: test_sensors[monitored_resources8-sensor.first_l_resting_heart_rate-activities/heart-api_value8]\n   tuple(\n-    '18',\n+    '76',\n     ReadOnlyDict({\n       'attribution': 'Data provided by Fitbit.com',\n-      'device_class': 'duration',\n-      'friendly_name': 'Minutes Sedentary',\n-      'icon': 'mdi:seat-recline-normal',\n+      'friendly_name': 'First L. Resting heart rate',\n+      'icon': 'mdi:heart-pulse',\n       'state_class': <SensorStateClass.MEASUREMENT: 'measurement'>,\n-      'unit_of_measurement': <UnitOfTime.MINUTES: 'min'>,\n+      'unit_of_measurement': 'bpm',\n     }),\n-    'fitbit-api-user-id-1_activities/minutesSedentary',\n+    'fitbit-api-user-id-1_activities/heart',\n   )\n # ---\n-# name: test_sensors[monitored_resources9-sensor.minutes_very_active-activities/minutesVeryActive-20]\n+# name: test_sensors[monitored_resources9-sensor.first_l_minutes_fairly_active-activities/minutesFairlyActive-35]\n   tuple(\n-    '20',\n+    '35',\n     ReadOnlyDict({\n       'attribution': 'Data provided by Fitbit.com',\n       'device_class': 'duration',\n-      'friendly_name': 'Minutes Very Active',\n-      'icon': 'mdi:run',\n+      'friendly_name': 'First L. Minutes fairly active',\n+      'icon': 'mdi:walk',\n       'state_class': <SensorStateClass.MEASUREMENT: 'measurement'>,\n       'unit_of_measurement': <UnitOfTime.MINUTES: 'min'>,\n     }),\n-    'fitbit-api-user-id-1_activities/minutesVeryActive',\n+    'fitbit-api-user-id-1_activities/minutesFairlyActive',\n   )\n # ---\ndiff --git a/tests/components/fitbit/test_sensor.py b/tests/components/fitbit/test_sensor.py\nindex d67bd75396fc7..cee9835f89fce 100644\n--- a/tests/components/fitbit/test_sensor.py\n+++ b/tests/components/fitbit/test_sensor.py\n@@ -78,133 +78,151 @@ def mock_token_refresh(requests_mock: Mocker) -> None:\n     [\n         (\n             [\"activities/activityCalories\"],\n-            \"sensor.activity_calories\",\n+            \"sensor.first_l_activity_calories\",\n             \"activities/activityCalories\",\n             \"135\",\n         ),\n+        (\n+            [\"activities/tracker/activityCalories\"],\n+            \"sensor.first_l_tracker_activity_calories\",\n+            \"activities/tracker/activityCalories\",\n+            \"135\",\n+        ),\n         (\n             [\"activities/calories\"],\n-            \"sensor.calories\",\n+            \"sensor.first_l_calories\",\n             \"activities/calories\",\n             \"139\",\n         ),\n+        (\n+            [\"activities/tracker/calories\"],\n+            \"sensor.first_l_tracker_calories\",\n+            \"activities/tracker/calories\",\n+            \"139\",\n+        ),\n         (\n             [\"activities/distance\"],\n-            \"sensor.distance\",\n+            \"sensor.first_l_distance\",\n+            \"activities/distance\",\n+            \"12.7\",\n+        ),\n+        (\n+            [\"activities/tracker/distance\"],\n+            \"sensor.first_l_tracker_distance\",\n             \"activities/distance\",\n             \"12.7\",\n         ),\n         (\n             [\"activities/elevation\"],\n-            \"sensor.elevation\",\n+            \"sensor.first_l_elevation\",\n             \"activities/elevation\",\n             \"7600.24\",\n         ),\n         (\n             [\"activities/floors\"],\n-            \"sensor.floors\",\n+            \"sensor.first_l_floors\",\n             \"activities/floors\",\n             \"8\",\n         ),\n         (\n             [\"activities/heart\"],\n-            \"sensor.resting_heart_rate\",\n+            \"sensor.first_l_resting_heart_rate\",\n             \"activities/heart\",\n             {\"restingHeartRate\": 76},\n         ),\n         (\n             [\"activities/minutesFairlyActive\"],\n-            \"sensor.minutes_fairly_active\",\n+            \"sensor.first_l_minutes_fairly_active\",\n             \"activities/minutesFairlyActive\",\n             35,\n         ),\n         (\n             [\"activities/minutesLightlyActive\"],\n-            \"sensor.minutes_lightly_active\",\n+            \"sensor.first_l_minutes_lightly_active\",\n             \"activities/minutesLightlyActive\",\n             95,\n         ),\n         (\n             [\"activities/minutesSedentary\"],\n-            \"sensor.minutes_sedentary\",\n+            \"sensor.first_l_minutes_sedentary\",\n             \"activities/minutesSedentary\",\n             18,\n         ),\n         (\n             [\"activities/minutesVeryActive\"],\n-            \"sensor.minutes_very_active\",\n+            \"sensor.first_l_minutes_very_active\",\n             \"activities/minutesVeryActive\",\n             20,\n         ),\n         (\n             [\"activities/steps\"],\n-            \"sensor.steps\",\n+            \"sensor.first_l_steps\",\n             \"activities/steps\",\n             \"5600\",\n         ),\n         (\n             [\"body/weight\"],\n-            \"sensor.weight\",\n+            \"sensor.first_l_weight\",\n             \"body/weight\",\n             \"175\",\n         ),\n         (\n             [\"body/fat\"],\n-            \"sensor.body_fat\",\n+            \"sensor.first_l_body_fat\",\n             \"body/fat\",\n             \"18\",\n         ),\n         (\n             [\"body/bmi\"],\n-            \"sensor.bmi\",\n+            \"sensor.first_l_bmi\",\n             \"body/bmi\",\n             \"23.7\",\n         ),\n         (\n             [\"sleep/awakeningsCount\"],\n-            \"sensor.awakenings_count\",\n+            \"sensor.first_l_awakenings_count\",\n             \"sleep/awakeningsCount\",\n             \"7\",\n         ),\n         (\n             [\"sleep/efficiency\"],\n-            \"sensor.sleep_efficiency\",\n+            \"sensor.first_l_sleep_efficiency\",\n             \"sleep/efficiency\",\n             \"80\",\n         ),\n         (\n             [\"sleep/minutesAfterWakeup\"],\n-            \"sensor.minutes_after_wakeup\",\n+            \"sensor.first_l_minutes_after_wakeup\",\n             \"sleep/minutesAfterWakeup\",\n             \"17\",\n         ),\n         (\n             [\"sleep/minutesAsleep\"],\n-            \"sensor.sleep_minutes_asleep\",\n+            \"sensor.first_l_sleep_minutes_asleep\",\n             \"sleep/minutesAsleep\",\n             \"360\",\n         ),\n         (\n             [\"sleep/minutesAwake\"],\n-            \"sensor.sleep_minutes_awake\",\n+            \"sensor.first_l_sleep_minutes_awake\",\n             \"sleep/minutesAwake\",\n             \"35\",\n         ),\n         (\n             [\"sleep/minutesToFallAsleep\"],\n-            \"sensor.sleep_minutes_to_fall_asleep\",\n+            \"sensor.first_l_sleep_minutes_to_fall_asleep\",\n             \"sleep/minutesToFallAsleep\",\n             \"35\",\n         ),\n         (\n             [\"sleep/startTime\"],\n-            \"sensor.sleep_start_time\",\n+            \"sensor.first_l_sleep_start_time\",\n             \"sleep/startTime\",\n             \"2020-01-27T00:17:30.000\",\n         ),\n         (\n             [\"sleep/timeInBed\"],\n-            \"sensor.sleep_time_in_bed\",\n+            \"sensor.first_l_sleep_time_in_bed\",\n             \"sleep/timeInBed\",\n             \"462\",\n         ),\n@@ -359,7 +377,7 @@ async def test_profile_local(\n     entries = hass.config_entries.async_entries(DOMAIN)\n     assert len(entries) == 1\n \n-    state = hass.states.get(\"sensor.weight\")\n+    state = hass.states.get(\"sensor.first_l_weight\")\n     assert state\n     assert state.attributes.get(\"unit_of_measurement\") == expected_unit\n \n@@ -409,7 +427,7 @@ async def test_sleep_time_clock_format(\n     )\n     assert await integration_setup()\n \n-    state = hass.states.get(\"sensor.sleep_start_time\")\n+    state = hass.states.get(\"sensor.first_l_sleep_start_time\")\n     assert state\n     assert state.state == expected_state\n \n@@ -445,16 +463,16 @@ async def test_activity_scope_config_entry(\n \n     states = hass.states.async_all()\n     assert {s.entity_id for s in states} == {\n-        \"sensor.activity_calories\",\n-        \"sensor.calories\",\n-        \"sensor.distance\",\n-        \"sensor.elevation\",\n-        \"sensor.floors\",\n-        \"sensor.minutes_fairly_active\",\n-        \"sensor.minutes_lightly_active\",\n-        \"sensor.minutes_sedentary\",\n-        \"sensor.minutes_very_active\",\n-        \"sensor.steps\",\n+        \"sensor.first_l_activity_calories\",\n+        \"sensor.first_l_calories\",\n+        \"sensor.first_l_distance\",\n+        \"sensor.first_l_elevation\",\n+        \"sensor.first_l_floors\",\n+        \"sensor.first_l_minutes_fairly_active\",\n+        \"sensor.first_l_minutes_lightly_active\",\n+        \"sensor.first_l_minutes_sedentary\",\n+        \"sensor.first_l_minutes_very_active\",\n+        \"sensor.first_l_steps\",\n     }\n \n \n@@ -478,7 +496,7 @@ async def test_heartrate_scope_config_entry(\n \n     states = hass.states.async_all()\n     assert {s.entity_id for s in states} == {\n-        \"sensor.resting_heart_rate\",\n+        \"sensor.first_l_resting_heart_rate\",\n     }\n \n \n@@ -506,11 +524,11 @@ async def test_nutrition_scope_config_entry(\n     )\n     assert await integration_setup()\n \n-    state = hass.states.get(\"sensor.water\")\n+    state = hass.states.get(\"sensor.first_l_water\")\n     assert state\n     assert (state.state, state.attributes) == snapshot\n \n-    state = hass.states.get(\"sensor.calories_in\")\n+    state = hass.states.get(\"sensor.first_l_calories_in\")\n     assert state\n     assert (state.state, state.attributes) == snapshot\n \n@@ -545,14 +563,14 @@ async def test_sleep_scope_config_entry(\n \n     states = hass.states.async_all()\n     assert {s.entity_id for s in states} == {\n-        \"sensor.awakenings_count\",\n-        \"sensor.sleep_efficiency\",\n-        \"sensor.minutes_after_wakeup\",\n-        \"sensor.sleep_minutes_asleep\",\n-        \"sensor.sleep_minutes_awake\",\n-        \"sensor.sleep_minutes_to_fall_asleep\",\n-        \"sensor.sleep_time_in_bed\",\n-        \"sensor.sleep_start_time\",\n+        \"sensor.first_l_awakenings_count\",\n+        \"sensor.first_l_sleep_efficiency\",\n+        \"sensor.first_l_minutes_after_wakeup\",\n+        \"sensor.first_l_sleep_minutes_asleep\",\n+        \"sensor.first_l_sleep_minutes_awake\",\n+        \"sensor.first_l_sleep_minutes_to_fall_asleep\",\n+        \"sensor.first_l_sleep_time_in_bed\",\n+        \"sensor.first_l_sleep_start_time\",\n     }\n \n \n@@ -573,7 +591,7 @@ async def test_weight_scope_config_entry(\n \n     states = hass.states.async_all()\n     assert [s.entity_id for s in states] == [\n-        \"sensor.weight\",\n+        \"sensor.first_l_weight\",\n     ]\n \n \n@@ -623,7 +641,7 @@ async def test_sensor_update_failed(\n \n     assert await integration_setup()\n \n-    state = hass.states.get(\"sensor.resting_heart_rate\")\n+    state = hass.states.get(\"sensor.first_l_resting_heart_rate\")\n     assert state\n     assert state.state == \"unavailable\"\n \n@@ -655,7 +673,7 @@ async def test_sensor_update_failed_requires_reauth(\n \n     assert await integration_setup()\n \n-    state = hass.states.get(\"sensor.resting_heart_rate\")\n+    state = hass.states.get(\"sensor.first_l_resting_heart_rate\")\n     assert state\n     assert state.state == \"unavailable\"\n \n@@ -698,14 +716,14 @@ async def test_sensor_update_success(\n \n     assert await integration_setup()\n \n-    state = hass.states.get(\"sensor.resting_heart_rate\")\n+    state = hass.states.get(\"sensor.first_l_resting_heart_rate\")\n     assert state\n     assert state.state == \"60\"\n \n-    await async_update_entity(hass, \"sensor.resting_heart_rate\")\n+    await async_update_entity(hass, \"sensor.first_l_resting_heart_rate\")\n     await hass.async_block_till_done()\n \n-    state = hass.states.get(\"sensor.resting_heart_rate\")\n+    state = hass.states.get(\"sensor.first_l_resting_heart_rate\")\n     assert state\n     assert state.state == \"70\"\n \n@@ -867,6 +885,6 @@ async def test_resting_heart_rate_responses(\n     )\n     assert await integration_setup()\n \n-    state = hass.states.get(\"sensor.resting_heart_rate\")\n+    state = hass.states.get(\"sensor.first_l_resting_heart_rate\")\n     assert state\n     assert state.state == expected_state\n", "problem_statement": "Fitbit integration and multiple accounts: devices and entities have no account identifier in names\n### The problem\n\nWhen adding multiple fitbit accounts to retrieve data for multiple peple, the devices and entities that get created do not contain the 'Application Credentials' name. \r\n\r\nIf I create Fitbit Application Credentials named <b>User1</b> and <b>User2</b>, the devices and entities do not include these in the names.\r\n\r\nThe first item configured will have entities created such as  <b>sensor.steps</b> and the second one will have <b>sensor.steps_2</b> making it difficult to know which is which. The integration should create objects with a name that includes an identifier to understand which crednetials are being used, either by using the credentials name or something retrieved from the api being called. \r\n \r\n\r\n\n\n### What version of Home Assistant Core has the issue?\n\ncore-2024.8.1\n\n### What was the last working version of Home Assistant Core?\n\n_No response_\n\n### What type of installation are you running?\n\nHome Assistant Container\n\n### Integration causing the issue\n\nFitbit\n\n### Link to integration documentation on our website\n\nhttps://www.home-assistant.io/integrations/fitbit/\n\n### Diagnostics information\n\n_No response_\n\n### Example YAML snippet\n\n_No response_\n\n### Anything in the logs that might be useful for us?\n\n_No response_\n\n### Additional information\n\n_No response_\n", "hints_text": "\nHey there @allenporter, mind taking a look at this issue as it has been labeled with an integration (`fitbit`) you are listed as a [code owner](https://github.com/home-assistant/core/blob/dev/CODEOWNERS#L461) for? Thanks!\n\n<details>\n<summary>Code owner commands</summary>\n\n\nCode owners of `fitbit` can trigger bot actions by commenting:\n\n- `@home-assistant close` Closes the issue.\n- `@home-assistant rename Awesome new title` Renames the issue.\n- `@home-assistant reopen` Reopen the issue.\n- `@home-assistant unassign fitbit` Removes the current integration label and assignees on the issue, add the integration domain after the command.\n- `@home-assistant add-label needs-more-information` Add a label (needs-more-information, problem in dependency, problem in custom component) to the issue.\n- `@home-assistant remove-label needs-more-information` Remove a label (needs-more-information, problem in dependency, problem in custom component) on the issue.\n\n</details>\n\n\n<sub><sup>(message by CodeOwnersMention)</sup></sub>\n\n---\n\n[fitbit documentation](https://www.home-assistant.io/integrations/fitbit)\n[fitbit source](https://github.com/home-assistant/core/tree/dev/homeassistant/components/fitbit)\n<sub><sup>(message by IssueLinks)</sup></sub>\nThere hasn't been any activity on this issue recently. Due to the high number of incoming GitHub notifications, we have to clean some of the old issues, as many of them have already been resolved with the latest updates.\nPlease make sure to update to the latest Home Assistant version and check if that solves the issue. Let us know if that works for you by adding a comment \ud83d\udc4d\nThis issue has now been marked as stale and will be closed if no further activity occurs. Thank you for your contributions.\nThanks for the report.  Perhaps we need to use the config entry title name or make a device name based on the config entry title.\r\n\r\nI think a couple sensors like battery level have this naming scheme but the others do not.", "created_at": "2024-11-17T17:20:44Z"}
{"repo": "home-assistant/core", "pull_number": 130824, "instance_id": "home-assistant__core-130824", "issue_numbers": ["130678"], "base_commit": "db3d3854478086292e98a57af9522f79dc75eede", "patch": "diff --git a/homeassistant/components/homematicip_cloud/manifest.json b/homeassistant/components/homematicip_cloud/manifest.json\nindex b3e7eb9a72adba..97af964ffc7826 100644\n--- a/homeassistant/components/homematicip_cloud/manifest.json\n+++ b/homeassistant/components/homematicip_cloud/manifest.json\n@@ -7,5 +7,5 @@\n   \"iot_class\": \"cloud_push\",\n   \"loggers\": [\"homematicip\"],\n   \"quality_scale\": \"silver\",\n-  \"requirements\": [\"homematicip==1.1.2\"]\n+  \"requirements\": [\"homematicip==1.1.3\"]\n }\ndiff --git a/requirements_all.txt b/requirements_all.txt\nindex c7a97f4e8d449e..e5f14e062d6547 100644\n--- a/requirements_all.txt\n+++ b/requirements_all.txt\n@@ -1139,7 +1139,7 @@ home-assistant-intents==2024.11.13\n homeconnect==0.8.0\n \n # homeassistant.components.homematicip_cloud\n-homematicip==1.1.2\n+homematicip==1.1.3\n \n # homeassistant.components.horizon\n horimote==0.4.1\n", "test_patch": "diff --git a/requirements_test_all.txt b/requirements_test_all.txt\nindex 5390fc4a872154..cdfb20e2295b7e 100644\n--- a/requirements_test_all.txt\n+++ b/requirements_test_all.txt\n@@ -965,7 +965,7 @@ home-assistant-intents==2024.11.13\n homeconnect==0.8.0\n \n # homeassistant.components.homematicip_cloud\n-homematicip==1.1.2\n+homematicip==1.1.3\n \n # homeassistant.components.remember_the_milk\n httplib2==0.20.4\n", "problem_statement": "Connection to HomematicIP Cloud fails with unexpected keyword argument 'extra_headers'\n### The problem\n\nStarting around the time I upgraded to 2024.11.01, I've had issues with the official Homematic IP integration. I get messages from the Homematic IP app that due to excessive use of the REST API, my access is throttled. In the Home Assistant logs I can see messages showing the exponential backoff:\r\n\r\n```\r\nError connecting to HomematicIP with HAP <redacted>. Retrying in 16 seconds\r\nError connecting to HomematicIP with HAP <redacted>. Retrying in 32 seconds\r\nError connecting to HomematicIP with HAP <redacted>. Retrying in 64 seconds\r\nError connecting to HomematicIP with HAP <redacted>. Retrying in 128 seconds\r\nError connecting to HomematicIP with HAP <redacted>. Retrying in 256 seconds\r\n```\r\n\r\nAdditionally I can see these log entries, which I think might be what's causing the excessive requests to the Homematic IP API:\r\n\r\n```\r\nLogger: homematicip.aio.connection\r\nQuelle: /usr/local/lib/python3.12/site-packages/homematicip/aio/connection.py:127\r\nErstmals aufgetreten: 08:45:11 (14 Vorkommnisse)\r\nZuletzt protokolliert: 09:10:49\r\n\r\nBaseEventLoop.create_connection() got an unexpected keyword argument 'extra_headers'\r\nTraceback (most recent call last):\r\n  File \"/usr/local/lib/python3.12/site-packages/homematicip/aio/connection.py\", line 114, in _connect_to_websocket\r\n    self.socket_connection = await asyncio.wait_for(\r\n                             ^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/local/lib/python3.12/asyncio/tasks.py\", line 520, in wait_for\r\n    return await fut\r\n           ^^^^^^^^^\r\n  File \"/usr/local/lib/python3.12/site-packages/websockets/asyncio/client.py\", line 441, in __await_impl__\r\n    self.connection = await self.create_connection()\r\n                      ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/local/lib/python3.12/site-packages/websockets/asyncio/client.py\", line 367, in create_connection\r\n    _, connection = await loop.create_connection(factory, **kwargs)\r\n                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\nTypeError: BaseEventLoop.create_connection() got an unexpected keyword argument 'extra_headers'\r\n```\n\n### What version of Home Assistant Core has the issue?\n\ncore-2024.11.1\n\n### What was the last working version of Home Assistant Core?\n\ncore-2024.10.4\n\n### What type of installation are you running?\n\nHome Assistant OS\n\n### Integration causing the issue\n\nHomematicIP Cloud\n\n### Link to integration documentation on our website\n\nhttps://www.home-assistant.io/integrations/homematicip_cloud/\n\n### Diagnostics information\n\n[home-assistant_homematicip_cloud_2024-11-15T07-36-32.846Z.log](https://github.com/user-attachments/files/17771696/home-assistant_homematicip_cloud_2024-11-15T07-36-32.846Z.log)\r\n\n\n### Example YAML snippet\n\n_No response_\n\n### Anything in the logs that might be useful for us?\n\n```txt\n2024-11-14 08:38:20.296 ERROR (MainThread) [homematicip.aio.connection] BaseEventLoop.create_connection() got an unexpected keyword argument 'extra_headers'\r\nTraceback (most recent call last):\r\n  File \"/usr/local/lib/python3.12/site-packages/homematicip/aio/connection.py\", line 114, in _connect_to_websocket\r\n    self.socket_connection = await asyncio.wait_for(\r\n                             ^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/local/lib/python3.12/asyncio/tasks.py\", line 520, in wait_for\r\n    return await fut\r\n           ^^^^^^^^^\r\n  File \"/usr/local/lib/python3.12/site-packages/websockets/asyncio/client.py\", line 441, in __await_impl__\r\n    self.connection = await self.create_connection()\r\n                      ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/local/lib/python3.12/site-packages/websockets/asyncio/client.py\", line 367, in create_connection\r\n    _, connection = await loop.create_connection(factory, **kwargs)\r\n                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\nTypeError: BaseEventLoop.create_connection() got an unexpected keyword argument 'extra_headers'\r\n2024-11-14 08:38:20.300 ERROR (MainThread) [homeassistant.components.homematicip_cloud.hap] Error connecting to HomematicIP with HAP 3014F711A00003D709A4AECE. Retrying in 256 seconds\n```\n\n\n### Additional information\n\n_No response_\n", "hints_text": "\nHey there @hahn-th, mind taking a look at this issue as it has been labeled with an integration (`homematicip_cloud`) you are listed as a [code owner](https://github.com/home-assistant/core/blob/dev/CODEOWNERS#L642) for? Thanks!\n\n<details>\n<summary>Code owner commands</summary>\n\n\nCode owners of `homematicip_cloud` can trigger bot actions by commenting:\n\n- `@home-assistant close` Closes the issue.\n- `@home-assistant rename Awesome new title` Renames the issue.\n- `@home-assistant reopen` Reopen the issue.\n- `@home-assistant unassign homematicip_cloud` Removes the current integration label and assignees on the issue, add the integration domain after the command.\n- `@home-assistant add-label needs-more-information` Add a label (needs-more-information, problem in dependency, problem in custom component) to the issue.\n- `@home-assistant remove-label needs-more-information` Remove a label (needs-more-information, problem in dependency, problem in custom component) on the issue.\n\n</details>\n\n\n<sub><sup>(message by CodeOwnersMention)</sup></sub>\n\n---\n\n[homematicip_cloud documentation](https://www.home-assistant.io/integrations/homematicip_cloud)\n[homematicip_cloud source](https://github.com/home-assistant/core/tree/dev/homeassistant/components/homematicip_cloud)\n<sub><sup>(message by IssueLinks)</sup></sub>\nDuplicate of #130592\nI got the problem too after updating from 2024.10 to 2024.11.02.\r\n\r\nI temporarily solved this **downgrading the websockets to version 13.1**! So something has changed in websockets 14.", "created_at": "2024-11-17T16:37:38Z"}
{"repo": "home-assistant/core", "pull_number": 130815, "instance_id": "home-assistant__core-130815", "issue_numbers": ["130415"], "base_commit": "4ba8db1de47552856207bd36a8c1d35c8094f1da", "patch": "diff --git a/homeassistant/components/bluesound/media_player.py b/homeassistant/components/bluesound/media_player.py\nindex 97985a74300c5..38ef78fad3a7d 100644\n--- a/homeassistant/components/bluesound/media_player.py\n+++ b/homeassistant/components/bluesound/media_player.py\n@@ -292,14 +292,6 @@ async def async_update_status(self) -> None:\n             self._last_status_update = dt_util.utcnow()\n             self._status = status\n \n-            group_name = status.group_name\n-            if group_name != self._group_name:\n-                _LOGGER.debug(\"Group name change detected on device: %s\", self.id)\n-                self._group_name = group_name\n-\n-                # rebuild ordered list of entity_ids that are in the group, master is first\n-                self._group_list = self.rebuild_bluesound_group()\n-\n             self.async_write_ha_state()\n         except PlayerUnreachableError:\n             self._attr_available = False\n@@ -323,6 +315,8 @@ async def update_sync_status(self) -> None:\n \n         self._sync_status = sync_status\n \n+        self._group_list = self.rebuild_bluesound_group()\n+\n         if sync_status.master is not None:\n             self._is_master = False\n             master_id = f\"{sync_status.master.ip}:{sync_status.master.port}\"\n@@ -619,21 +613,32 @@ def extra_state_attributes(self) -> dict[str, Any] | None:\n \n     def rebuild_bluesound_group(self) -> list[str]:\n         \"\"\"Rebuild the list of entities in speaker group.\"\"\"\n-        if self._group_name is None:\n+        if self.sync_status.master is None and self.sync_status.slaves is None:\n             return []\n \n-        device_group = self._group_name.split(\"+\")\n+        player_entities: list[BluesoundPlayer] = self.hass.data[DATA_BLUESOUND]\n \n-        sorted_entities: list[BluesoundPlayer] = sorted(\n-            self.hass.data[DATA_BLUESOUND],\n-            key=lambda entity: entity.is_master,\n-            reverse=True,\n-        )\n-        return [\n-            entity.sync_status.name\n-            for entity in sorted_entities\n-            if entity.bluesound_device_name in device_group\n+        leader_sync_status: SyncStatus | None = None\n+        if self.sync_status.master is None:\n+            leader_sync_status = self.sync_status\n+        else:\n+            required_id = f\"{self.sync_status.master.ip}:{self.sync_status.master.port}\"\n+            for x in player_entities:\n+                if x.sync_status.id == required_id:\n+                    leader_sync_status = x.sync_status\n+                    break\n+\n+        if leader_sync_status is None or leader_sync_status.slaves is None:\n+            return []\n+\n+        follower_ids = [f\"{x.ip}:{x.port}\" for x in leader_sync_status.slaves]\n+        follower_names = [\n+            x.sync_status.name\n+            for x in player_entities\n+            if x.sync_status.id in follower_ids\n         ]\n+        follower_names.insert(0, leader_sync_status.name)\n+        return follower_names\n \n     async def async_unjoin(self) -> None:\n         \"\"\"Unjoin the player from a group.\"\"\"\n", "test_patch": "diff --git a/tests/components/bluesound/test_media_player.py b/tests/components/bluesound/test_media_player.py\nindex 0bf615de3da87..217225628f29d 100644\n--- a/tests/components/bluesound/test_media_player.py\n+++ b/tests/components/bluesound/test_media_player.py\n@@ -325,17 +325,17 @@ async def test_attr_bluesound_group(\n     setup_config_entry_secondary: None,\n     player_mocks: PlayerMocks,\n ) -> None:\n-    \"\"\"Test the media player grouping.\"\"\"\n+    \"\"\"Test the media player grouping for leader.\"\"\"\n     attr_bluesound_group = hass.states.get(\n         \"media_player.player_name1111\"\n     ).attributes.get(\"bluesound_group\")\n     assert attr_bluesound_group is None\n \n-    updated_status = dataclasses.replace(\n-        player_mocks.player_data.status_long_polling_mock.get(),\n-        group_name=\"player-name1111+player-name2222\",\n+    updated_sync_status = dataclasses.replace(\n+        player_mocks.player_data.sync_status_long_polling_mock.get(),\n+        slaves=[PairedPlayer(\"2.2.2.2\", 11000)],\n     )\n-    player_mocks.player_data.status_long_polling_mock.set(updated_status)\n+    player_mocks.player_data.sync_status_long_polling_mock.set(updated_sync_status)\n \n     # give the long polling loop a chance to update the state; this could be any async call\n     await hass.async_block_till_done()\n@@ -347,6 +347,45 @@ async def test_attr_bluesound_group(\n     assert attr_bluesound_group == [\"player-name1111\", \"player-name2222\"]\n \n \n+async def test_attr_bluesound_group_for_follower(\n+    hass: HomeAssistant,\n+    setup_config_entry: None,\n+    setup_config_entry_secondary: None,\n+    player_mocks: PlayerMocks,\n+) -> None:\n+    \"\"\"Test the media player grouping for follower.\"\"\"\n+    attr_bluesound_group = hass.states.get(\n+        \"media_player.player_name2222\"\n+    ).attributes.get(\"bluesound_group\")\n+    assert attr_bluesound_group is None\n+\n+    updated_sync_status = dataclasses.replace(\n+        player_mocks.player_data.sync_status_long_polling_mock.get(),\n+        slaves=[PairedPlayer(\"2.2.2.2\", 11000)],\n+    )\n+    player_mocks.player_data.sync_status_long_polling_mock.set(updated_sync_status)\n+\n+    # give the long polling loop a chance to update the state; this could be any async call\n+    await hass.async_block_till_done()\n+\n+    updated_sync_status = dataclasses.replace(\n+        player_mocks.player_data_secondary.sync_status_long_polling_mock.get(),\n+        master=PairedPlayer(\"1.1.1.1\", 11000),\n+    )\n+    player_mocks.player_data_secondary.sync_status_long_polling_mock.set(\n+        updated_sync_status\n+    )\n+\n+    # give the long polling loop a chance to update the state; this could be any async call\n+    await hass.async_block_till_done()\n+\n+    attr_bluesound_group = hass.states.get(\n+        \"media_player.player_name2222\"\n+    ).attributes.get(\"bluesound_group\")\n+\n+    assert attr_bluesound_group == [\"player-name1111\", \"player-name2222\"]\n+\n+\n async def test_volume_up_from_6_to_7(\n     hass: HomeAssistant,\n     setup_config_entry: None,\n", "problem_statement": "`bluesound_group` attribute only present in groups of two\n### The problem\n\nWhen I join one Bluesound node to the master, the following attribute appears in the state of both nodes:\r\n\r\n    bluesound_group: [\"Dining Room\", \"Kitchen\"]\r\n\r\nWhen I join a third node to the existing group, the attribute disappears.\r\n\r\nCurrently there is no way that I can see to determine whether a node is part of a group of more than two nodes.\r\n\r\n\n\n### What version of Home Assistant Core has the issue?\n\ncore-2024.11.1\n\n### What was the last working version of Home Assistant Core?\n\n_No response_\n\n### What type of installation are you running?\n\nHome Assistant OS\n\n### Integration causing the issue\n\nBluesound\n\n### Link to integration documentation on our website\n\nhttps://www.home-assistant.io/integrations/bluesound/\n\n### Diagnostics information\n\n_No response_\n\n### Example YAML snippet\n\n_No response_\n\n### Anything in the logs that might be useful for us?\n\n```txt\nNothing terribly interesting in the debug logs:\r\n\r\n    2024-11-12 10:08:23.903 DEBUG (MainThread) [homeassistant.components.bluesound.media_player] Group name change detected on device: 192.168.87.153:11000\r\n    2024-11-12 10:08:23.993 DEBUG (MainThread) [homeassistant.components.bluesound.media_player] Group name change detected on device: 192.168.87.153:11000\r\n    2024-11-12 10:08:24.019 DEBUG (MainThread) [homeassistant.components.bluesound.media_player] Group name change detected on device: 192.168.87.154:11000\r\n    2024-11-12 10:08:30.759 DEBUG (MainThread) [homeassistant.components.bluesound.media_player] Group name change detected on device: 192.168.87.154:11000\r\n    2024-11-12 10:08:30.764 DEBUG (MainThread) [homeassistant.components.bluesound.media_player] Group name change detected on device: 192.168.87.153:11000\r\n    2024-11-12 10:08:30.774 DEBUG (MainThread) [homeassistant.components.bluesound.media_player] Group name change detected on device: 192.168.87.155:11000\n```\n\n\n### Additional information\n\n_No response_\n", "hints_text": "\nHey there @thrawnarn, @louischrist, mind taking a look at this issue as it has been labeled with an integration (`bluesound`) you are listed as a [code owner](https://github.com/home-assistant/core/blob/dev/CODEOWNERS#L205) for? Thanks!\n\n<details>\n<summary>Code owner commands</summary>\n\n\nCode owners of `bluesound` can trigger bot actions by commenting:\n\n- `@home-assistant close` Closes the issue.\n- `@home-assistant rename Awesome new title` Renames the issue.\n- `@home-assistant reopen` Reopen the issue.\n- `@home-assistant unassign bluesound` Removes the current integration label and assignees on the issue, add the integration domain after the command.\n- `@home-assistant add-label needs-more-information` Add a label (needs-more-information, problem in dependency, problem in custom component) to the issue.\n- `@home-assistant remove-label needs-more-information` Remove a label (needs-more-information, problem in dependency, problem in custom component) on the issue.\n\n</details>\n\n\n<sub><sup>(message by CodeOwnersMention)</sup></sub>\n\n---\n\n[bluesound documentation](https://www.home-assistant.io/integrations/bluesound)\n[bluesound source](https://github.com/home-assistant/core/tree/dev/homeassistant/components/bluesound)\n<sub><sup>(message by IssueLinks)</sup></sub>", "created_at": "2024-11-17T14:06:06Z"}
{"repo": "home-assistant/core", "pull_number": 130776, "instance_id": "home-assistant__core-130776", "issue_numbers": ["130703"], "base_commit": "9711816542b581d7c40a3d69668c3711d5af7c23", "patch": "diff --git a/homeassistant/components/waze_travel_time/__init__.py b/homeassistant/components/waze_travel_time/__init__.py\nindex 1abcf9d391dde5..34f22c9218fff9 100644\n--- a/homeassistant/components/waze_travel_time/__init__.py\n+++ b/homeassistant/components/waze_travel_time/__init__.py\n@@ -3,12 +3,13 @@\n import asyncio\n from collections.abc import Collection\n import logging\n+from typing import Literal\n \n from pywaze.route_calculator import CalcRoutesResponse, WazeRouteCalculator, WRCError\n import voluptuous as vol\n \n from homeassistant.config_entries import ConfigEntry\n-from homeassistant.const import CONF_REGION, Platform\n+from homeassistant.const import CONF_REGION, Platform, UnitOfLength\n from homeassistant.core import (\n     HomeAssistant,\n     ServiceCall,\n@@ -22,7 +23,10 @@\n     SelectSelectorConfig,\n     SelectSelectorMode,\n     TextSelector,\n+    TextSelectorConfig,\n+    TextSelectorType,\n )\n+from homeassistant.util.unit_conversion import DistanceConverter\n \n from .const import (\n     CONF_AVOID_FERRIES,\n@@ -38,6 +42,7 @@\n     DEFAULT_FILTER,\n     DEFAULT_VEHICLE_TYPE,\n     DOMAIN,\n+    IMPERIAL_UNITS,\n     METRIC_UNITS,\n     REGIONS,\n     SEMAPHORE,\n@@ -80,6 +85,18 @@\n         vol.Optional(CONF_AVOID_TOLL_ROADS, default=False): BooleanSelector(),\n         vol.Optional(CONF_AVOID_SUBSCRIPTION_ROADS, default=False): BooleanSelector(),\n         vol.Optional(CONF_AVOID_FERRIES, default=False): BooleanSelector(),\n+        vol.Optional(CONF_INCL_FILTER): TextSelector(\n+            TextSelectorConfig(\n+                type=TextSelectorType.TEXT,\n+                multiple=True,\n+            ),\n+        ),\n+        vol.Optional(CONF_EXCL_FILTER): TextSelector(\n+            TextSelectorConfig(\n+                type=TextSelectorType.TEXT,\n+                multiple=True,\n+            ),\n+        ),\n     }\n )\n \n@@ -107,6 +124,9 @@ async def async_get_travel_times_service(service: ServiceCall) -> ServiceRespons\n             avoid_subscription_roads=service.data[CONF_AVOID_SUBSCRIPTION_ROADS],\n             avoid_ferries=service.data[CONF_AVOID_FERRIES],\n             realtime=service.data[CONF_REALTIME],\n+            units=service.data[CONF_UNITS],\n+            incl_filters=service.data.get(CONF_INCL_FILTER, DEFAULT_FILTER),\n+            excl_filters=service.data.get(CONF_EXCL_FILTER, DEFAULT_FILTER),\n         )\n         return {\"routes\": [vars(route) for route in response]} if response else None\n \n@@ -129,6 +149,7 @@ async def async_get_travel_times(\n     avoid_subscription_roads: bool,\n     avoid_ferries: bool,\n     realtime: bool,\n+    units: Literal[\"metric\", \"imperial\"] = \"metric\",\n     incl_filters: Collection[str] | None = None,\n     excl_filters: Collection[str] | None = None,\n ) -> list[CalcRoutesResponse] | None:\n@@ -194,6 +215,20 @@ def should_exclude_route(route: CalcRoutesResponse) -> bool:\n             route for route in incl_routes if not should_exclude_route(route)\n         ]\n \n+        if units == IMPERIAL_UNITS:\n+            filtered_routes = [\n+                CalcRoutesResponse(\n+                    name=route.name,\n+                    distance=DistanceConverter.convert(\n+                        route.distance, UnitOfLength.KILOMETERS, UnitOfLength.MILES\n+                    ),\n+                    duration=route.duration,\n+                    street_names=route.street_names,\n+                )\n+                for route in filtered_routes\n+                if route.distance is not None\n+            ]\n+\n         if len(filtered_routes) < 1:\n             _LOGGER.warning(\"No routes found\")\n             return None\ndiff --git a/homeassistant/components/waze_travel_time/sensor.py b/homeassistant/components/waze_travel_time/sensor.py\nindex c2d3ee12cf8438..a216a02f61ea2d 100644\n--- a/homeassistant/components/waze_travel_time/sensor.py\n+++ b/homeassistant/components/waze_travel_time/sensor.py\n@@ -20,7 +20,6 @@\n     CONF_NAME,\n     CONF_REGION,\n     EVENT_HOMEASSISTANT_STARTED,\n-    UnitOfLength,\n     UnitOfTime,\n )\n from homeassistant.core import CoreState, HomeAssistant\n@@ -28,7 +27,6 @@\n from homeassistant.helpers.entity_platform import AddEntitiesCallback\n from homeassistant.helpers.httpx_client import get_async_client\n from homeassistant.helpers.location import find_coordinates\n-from homeassistant.util.unit_conversion import DistanceConverter\n \n from . import async_get_travel_times\n from .const import (\n@@ -44,7 +42,6 @@\n     CONF_VEHICLE_TYPE,\n     DEFAULT_NAME,\n     DOMAIN,\n-    IMPERIAL_UNITS,\n     SEMAPHORE,\n )\n \n@@ -201,6 +198,7 @@ async def async_update(self):\n                 avoid_subscription_roads,\n                 avoid_ferries,\n                 realtime,\n+                self.config_entry.options[CONF_UNITS],\n                 incl_filter,\n                 excl_filter,\n             )\n@@ -211,14 +209,5 @@ async def async_update(self):\n                 return\n \n             self.duration = route.duration\n-            distance = route.distance\n-\n-            if self.config_entry.options[CONF_UNITS] == IMPERIAL_UNITS:\n-                # Convert to miles.\n-                self.distance = DistanceConverter.convert(\n-                    distance, UnitOfLength.KILOMETERS, UnitOfLength.MILES\n-                )\n-            else:\n-                self.distance = distance\n-\n+            self.distance = route.distance\n             self.route = route.name\ndiff --git a/homeassistant/components/waze_travel_time/services.yaml b/homeassistant/components/waze_travel_time/services.yaml\nindex 7fba565dd47b27..fd5f2e9adea6a7 100644\n--- a/homeassistant/components/waze_travel_time/services.yaml\n+++ b/homeassistant/components/waze_travel_time/services.yaml\n@@ -55,3 +55,13 @@ get_travel_times:\n       required: false\n       selector:\n         boolean:\n+    incl_filter:\n+      required: false\n+      selector:\n+        text:\n+          multiple: true\n+    excl_filter:\n+      required: false\n+      selector:\n+        text:\n+          multiple: true\ndiff --git a/homeassistant/components/waze_travel_time/strings.json b/homeassistant/components/waze_travel_time/strings.json\nindex f053f033307768..cca1789bf7e54a 100644\n--- a/homeassistant/components/waze_travel_time/strings.json\n+++ b/homeassistant/components/waze_travel_time/strings.json\n@@ -101,6 +101,14 @@\n         \"avoid_subscription_roads\": {\n           \"name\": \"[%key:component::waze_travel_time::options::step::init::data::avoid_subscription_roads%]\",\n           \"description\": \"Whether to avoid subscription roads.\"\n+        },\n+        \"incl_filter\": {\n+          \"name\": \"[%key:component::waze_travel_time::options::step::init::data::incl_filter%]\",\n+          \"description\": \"Exact streetname which must be part of the selected route.\"\n+        },\n+        \"excl_filter\": {\n+          \"name\": \"[%key:component::waze_travel_time::options::step::init::data::excl_filter%]\",\n+          \"description\": \"Exact streetname which must NOT be part of the selected route.\"\n         }\n       }\n     }\n", "test_patch": "diff --git a/tests/components/waze_travel_time/test_init.py b/tests/components/waze_travel_time/test_init.py\nindex 9c59278ff99eca..89bccc00985f9b 100644\n--- a/tests/components/waze_travel_time/test_init.py\n+++ b/tests/components/waze_travel_time/test_init.py\n@@ -44,6 +44,8 @@ async def test_service_get_travel_times(hass: HomeAssistant) -> None:\n             \"destination\": \"location2\",\n             \"vehicle_type\": \"car\",\n             \"region\": \"us\",\n+            \"units\": \"imperial\",\n+            \"incl_filter\": [\"IncludeThis\"],\n         },\n         blocking=True,\n         return_response=True,\n@@ -51,17 +53,11 @@ async def test_service_get_travel_times(hass: HomeAssistant) -> None:\n     assert response_data == {\n         \"routes\": [\n             {\n-                \"distance\": 300,\n+                \"distance\": pytest.approx(186.4113),\n                 \"duration\": 150,\n                 \"name\": \"E1337 - Teststreet\",\n                 \"street_names\": [\"E1337\", \"IncludeThis\", \"Teststreet\"],\n             },\n-            {\n-                \"distance\": 500,\n-                \"duration\": 600,\n-                \"name\": \"E0815 - Otherstreet\",\n-                \"street_names\": [\"E0815\", \"ExcludeThis\", \"Otherstreet\"],\n-            },\n         ]\n     }\n \n", "problem_statement": "Waze get_travel_times service does not support all parameters listed in docs\n### The problem\r\n\r\nAccording to waze travel times [docs](https://www.home-assistant.io/integrations/waze_travel_time#action-waze_travel_timeget_travel_times), the `get_travel_times` service accepts parameters like `incl_filter` and `excl_filter` but in practice they do not show up in the developer tools actions UI and trying to set them via yaml reports the error:\r\n```\r\nFailed to perform the action waze_travel_time.get_travel_times. extra keys not allowed @ data['incl_filter']. Got None\r\n```\r\nI think other parameters listed in the docs are not supported. Might as well align and support all of them\r\n\r\n\r\n\r\n### What version of Home Assistant Core has the issue?\r\n\r\ncore-2024.11.1\r\n\r\n### What was the last working version of Home Assistant Core?\r\n\r\n_No response_\r\n\r\n### What type of installation are you running?\r\n\r\nHome Assistant Container\r\n\r\n### Integration causing the issue\r\n\r\nwaze travel time\r\n\r\n### Link to integration documentation on our website\r\n\r\nhttps://www.home-assistant.io/integrations/waze_travel_time#action-waze_travel_timeget_travel_times\r\n\r\n### Diagnostics information\r\n\r\n_No response_\r\n\r\n### Example YAML snippet\r\n\r\n_No response_\r\n\r\n### Anything in the logs that might be useful for us?\r\n\r\n_No response_\r\n\r\n### Additional information\r\n\r\n_No response_\n", "hints_text": "\nHey there @eifinger, mind taking a look at this issue as it has been labeled with an integration (`waze_travel_time`) you are listed as a [code owner](https://github.com/home-assistant/core/blob/dev/CODEOWNERS#L1648) for? Thanks!\n\n<details>\n<summary>Code owner commands</summary>\n\n\nCode owners of `waze_travel_time` can trigger bot actions by commenting:\n\n- `@home-assistant close` Closes the issue.\n- `@home-assistant rename Awesome new title` Renames the issue.\n- `@home-assistant reopen` Reopen the issue.\n- `@home-assistant unassign waze_travel_time` Removes the current integration label and assignees on the issue, add the integration domain after the command.\n- `@home-assistant add-label needs-more-information` Add a label (needs-more-information, problem in dependency, problem in custom component) to the issue.\n- `@home-assistant remove-label needs-more-information` Remove a label (needs-more-information, problem in dependency, problem in custom component) on the issue.\n\n</details>\n\n\n<sub><sup>(message by CodeOwnersMention)</sup></sub>\n\n---\n\n[waze_travel_time documentation](https://www.home-assistant.io/integrations/waze_travel_time)\n[waze_travel_time source](https://github.com/home-assistant/core/tree/dev/homeassistant/components/waze_travel_time)\n<sub><sup>(message by IssueLinks)</sup></sub>\nBased on the service schema, it looks like `incl_filter` and `excl_filter` are the only two unsupported (and were never supported).\r\n\r\n`units` shows up in the service schema, but doesn't appear to be used in the code.\nThank you for reporting this.\r\n\r\nI am thinking whether to adjust the documentation or the implementation.\r\n\r\n**Option 1 - Implementation is wrong**: Giving support for filters allows to test the responses the integration configuration would return with the exact same values.\r\n\r\n**Option 2 - Documentation is wrong**: The users calling the action currently get access to all available routes in the result and can apply their own filters. No need to implement something \"extra\".\nI would really prefer you adjust the implementation. \r\nI think it should be easy to do since it is already supported by the sensor and it gives great power to users since it will allow me to call the service in specific cases with specific settings without needing to parse the results\r\n", "created_at": "2024-11-16T18:26:06Z"}
{"repo": "home-assistant/core", "pull_number": 130759, "instance_id": "home-assistant__core-130759", "issue_numbers": ["130131"], "base_commit": "0ada59a4fedf2c2c1b35543857e627594b0dbd1b", "patch": "diff --git a/homeassistant/components/hydrawise/const.py b/homeassistant/components/hydrawise/const.py\nindex 633c00ce65907e..6d846dd612702d 100644\n--- a/homeassistant/components/hydrawise/const.py\n+++ b/homeassistant/components/hydrawise/const.py\n@@ -10,7 +10,7 @@\n \n MANUFACTURER = \"Hydrawise\"\n \n-MAIN_SCAN_INTERVAL = timedelta(seconds=60)\n+MAIN_SCAN_INTERVAL = timedelta(minutes=5)\n WATER_USE_SCAN_INTERVAL = timedelta(minutes=60)\n \n SIGNAL_UPDATE_HYDRAWISE = \"hydrawise_update\"\n", "test_patch": "", "problem_statement": "Hydrawise still polls too often and causes HTTP 429 errors\n### The problem\n\nthe problem was already [reported ](https://github.com/home-assistant/core/issues/128069 )and tried to be fixed via https://github.com/home-assistant/core/pull/128090, but I still get the errors in the log from time to time. This causes 1 error each 60 seconds.\r\nThe only way out I found is to deactivate the integration for at least 30 minutes and then activate again, but it comes back after a while.\r\n\r\nMight the interval be increased further or could the `nextpoll` attribute be used to throttle the integration? See this document from hunter: [Hydrawise REST API Ver 1.6_0.pdf](https://www.hunterindustries.com/sites/default/files/2024-10/Hydrawise%20REST%20API%20Ver%201.6_0.pdf)\n\n### What version of Home Assistant Core has the issue?\n\n2024.10.4\n\n### What was the last working version of Home Assistant Core?\n\n_No response_\n\n### What type of installation are you running?\n\nHome Assistant OS\n\n### Integration causing the issue\n\nhydrawise\n\n### Link to integration documentation on our website\n\nhttps://www.home-assistant.io/integrations/hydrawise\n\n### Diagnostics information\n\n_No response_\n\n### Example YAML snippet\n\n_No response_\n\n### Anything in the logs that might be useful for us?\n\n```txt\n2024-11-08 13:42:22.078 ERROR (MainThread) [homeassistant.components.hydrawise] Unexpected error fetching hydrawise data\r\nTraceback (most recent call last):\r\nFile \"/usr/local/lib/python3.12/site-packages/gql/transport/aiohttp.py\", line 319, in raise_response_error\r\nresp.raise_for_status()\r\nFile \"/usr/local/lib/python3.12/site-packages/aiohttp/client_reqrep.py\", line 1121, in raise_for_status\r\nraise ClientResponseError(\r\naiohttp.client_exceptions.ClientResponseError: 429, message='Too Many Requests', url='https://app.hydrawise.com/api/v2/graph'\r\nThe above exception was the direct cause of the following exception:\r\nTraceback (most recent call last):\r\nFile \"/usr/src/homeassistant/homeassistant/helpers/update_coordinator.py\", line 354, in _async_refresh\r\nself.data = await self._async_update_data()\r\n^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\nFile \"/usr/src/homeassistant/homeassistant/components/hydrawise/coordinator.py\", line 46, in _async_update_data\r\nuser = await self.api.get_user(fetch_zones=False)\r\n^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\nFile \"/usr/local/lib/python3.12/site-packages/pydrawise/client.py\", line 109, in get_user\r\nresult = await self._query(\r\n^^^^^^^^^^^^^^^^^^\r\nFile \"/usr/local/lib/python3.12/site-packages/pydrawise/client.py\", line 88, in _query\r\nreturn await session.execute(dsl_gql(DSLQuery(selector)))\r\n^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\nFile \"/usr/local/lib/python3.12/site-packages/gql/client.py\", line 1628, in execute\r\nresult = await self._execute(\r\n^^^^^^^^^^^^^^^^^^^^\r\nFile \"/usr/local/lib/python3.12/site-packages/gql/client.py\", line 1537, in _execute\r\nresult = await self.transport.execute(\r\n^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\nFile \"/usr/local/lib/python3.12/site-packages/gql/transport/aiohttp.py\", line 341, in execute\r\nawait raise_response_error(resp, \"Not a JSON answer\")\r\nFile \"/usr/local/lib/python3.12/site-packages/gql/transport/aiohttp.py\", line 321, in raise_response_error\r\nraise TransportServerError(str(e), e.status) from e\r\ngql.transport.exceptions.TransportServerError: 429, message='Too Many Requests', url='https://app.hydrawise.com/api/v2/graph'\r\n```\r\n\r\n```\r\n2024-11-08 13:43:23.089 ERROR (MainThread) [homeassistant.components.hydrawise] Unexpected error fetching hydrawise data\r\nTraceback (most recent call last):\r\nFile \"/usr/local/lib/python3.12/site-packages/gql/transport/aiohttp.py\", line 319, in raise_response_error\r\nresp.raise_for_status()\r\nFile \"/usr/local/lib/python3.12/site-packages/aiohttp/client_reqrep.py\", line 1121, in raise_for_status\r\nraise ClientResponseError(\r\naiohttp.client_exceptions.ClientResponseError: 429, message='Too Many Requests', url='https://app.hydrawise.com/api/v2/graph'\r\nThe above exception was the direct cause of the following exception:\r\nTraceback (most recent call last):\r\nFile \"/usr/src/homeassistant/homeassistant/helpers/update_coordinator.py\", line 354, in _async_refresh\r\nself.data = await self._async_update_data()\r\n^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\nFile \"/usr/src/homeassistant/homeassistant/components/hydrawise/coordinator.py\", line 46, in _async_update_data\r\nuser = await self.api.get_user(fetch_zones=False)\r\n^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\nFile \"/usr/local/lib/python3.12/site-packages/pydrawise/client.py\", line 109, in get_user\r\nresult = await self._query(\r\n^^^^^^^^^^^^^^^^^^\r\nFile \"/usr/local/lib/python3.12/site-packages/pydrawise/client.py\", line 88, in _query\r\nreturn await session.execute(dsl_gql(DSLQuery(selector)))\r\n^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\nFile \"/usr/local/lib/python3.12/site-packages/gql/client.py\", line 1628, in execute\r\nresult = await self._execute(\r\n^^^^^^^^^^^^^^^^^^^^\r\nFile \"/usr/local/lib/python3.12/site-packages/gql/client.py\", line 1537, in _execute\r\nresult = await self.transport.execute(\r\n^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\nFile \"/usr/local/lib/python3.12/site-packages/gql/transport/aiohttp.py\", line 341, in execute\r\nawait raise_response_error(resp, \"Not a JSON answer\")\r\nFile \"/usr/local/lib/python3.12/site-packages/gql/transport/aiohttp.py\", line 321, in raise_response_error\r\nraise TransportServerError(str(e), e.status) from e\r\ngql.transport.exceptions.TransportServerError: 429, message='Too Many Requests', url='https://app.hydrawise.com/api/v2/graph'\r\n```\n```\n\n\n### Additional information\n\n_No response_\n", "hints_text": "\nHey there @dknowles2, @thomaskistler, @ptcryan, mind taking a look at this issue as it has been labeled with an integration (`hydrawise`) you are listed as a [code owner](https://github.com/home-assistant/core/blob/dev/CODEOWNERS#L668) for? Thanks!\n\n<details>\n<summary>Code owner commands</summary>\n\n\nCode owners of `hydrawise` can trigger bot actions by commenting:\n\n- `@home-assistant close` Closes the issue.\n- `@home-assistant rename Awesome new title` Renames the issue.\n- `@home-assistant reopen` Reopen the issue.\n- `@home-assistant unassign hydrawise` Removes the current integration label and assignees on the issue, add the integration domain after the command.\n- `@home-assistant add-label needs-more-information` Add a label (needs-more-information, problem in dependency, problem in custom component) to the issue.\n- `@home-assistant remove-label needs-more-information` Remove a label (needs-more-information, problem in dependency, problem in custom component) on the issue.\n\n</details>\n\n\n<sub><sup>(message by CodeOwnersMention)</sup></sub>\n\n---\n\n[hydrawise documentation](https://www.home-assistant.io/integrations/hydrawise)\n[hydrawise source](https://github.com/home-assistant/core/tree/dev/homeassistant/components/hydrawise)\n<sub><sup>(message by IssueLinks)</sup></sub>\nI\u2019m having this issue too, on 2024.10.3. \nSame thing here. I deactivated polling for entity updates so I can at least control the valves.\nHow do you do that?\nIn the Hydrawise Integration Panel press the three dots and select system options. There you can disable it.\nGot it. Thank you.\nSame issue, I have disabled for now.\nAlso noticed the same thing - I have a rain sensor... is there any chance that polling of that might be causing this? I do not have any flow sensors which I believe was the issue in the last fix. The logbook shows it detecting a clear state in the rain sensor, then going unavailable, then repeating again.\nRain sensor here too. \nMy rain sensor is currently disconnected (wiring), so I don't think a single sensor is the issue.\nI don\u2018t have a rain sensor but a flow sensor. \nI think we should significantly decrease the rate that we're pulling water use summaries. Those are expensive to compute on our end, so I can only imagine they're causing problems on the Hydrawise server-side as well. They're also *daily* summaries, so they don't need to be polled every 60s. \nI\u2019m seeing those errors frequently and I don\u2019t have either rain or flow sensors. \r\n\r\nSince I\u2019m in the northern hemisphere, I disabled the integration until next spring to prevent the excessive noise in my logs and contributing to a load on their servers. \r\n\r\nIf the polling isn\u2019t reduced or made smarter there is always the risk of hyrdawise blocking the integration.  Note that a contributing factor with MyQ was that the integration polled so much that it wound up on their radar.\r\n\r\nalso it wound be good for this condition to not generate a stack trace.\n> I\u2019m seeing those errors frequently and I don\u2019t have either rain or flow sensors.\r\n\r\nThe presence of the sensors don't matter. The integration is still requesting that the server re-compute usage summaries between start-of-day and time-of-refresh for every controller on every polling period.\nSame issue here. Many 429s. No sensors - one 8-valve system.\nFollowing, persistent issue for me also. \nFollowing, having this issue for the last 2 weeks at least. \nFollowing, having the same issue again, starting on 11/6/24.  I also updated Supervisor from 2024.10.3 to 2024.11.2 around the same time.  HA Core is still 2024.10.3.  Thanks.\nFollowing as well as I've also been having the same issue.  As a workaround, I've disabled manual polling and instead, I've set an automation to refresh the Hydrawise integration once every hour.  I just set this automation up and I may increase this time longer if it still has polling issues.  This can be achieved by setting an automation to trigger every hour or however long you want it to, and then the action is to perform a \"Home Assistant Core Integration 'Reload config entry' \", and then set the Config entry ID to Hydrawise.  I'm unsure if the Config entry ID is the same or different for everyone, but the entry ID can be found in the core.config_entries file under config/.storage/.  Hope this helps someone else out there.\r\n\r\n![Capture](https://github.com/user-attachments/assets/8928af60-fe24-4fe6-b3d7-03e2ade07c4c)\nSeeing this as well. As a result my controller is in a disconnected state more often than than in a connected state.  12 valve system\nFollowing - also having this issue. Good lead on disabling polling as a temporary workaround, but would rather just poll less frequently\nSince my last comment, I've decreased the polling time on my automation from 1 hour down to 15, 5, 1, and then up to 2 minutes.  1 minute seems to cause the 429 error again, but 2 minutes seems to be working fine.  This workaround is a viable way to manually choose polling frequency for this issue.  I'm using a Hydrawise controller with a 4 valve system, a rain clik sensor, and am on the latest versions of HA, core, etc.\r\n\r\n**Edit:** 2 minute polling also causes 429 error. Polling frequency has been increased to 5 minutes. Joys of trial and error I guess.\nAs this issue seems to have come up somewhat suddenly (and despite changes in polling freq, continues), it may almost be in the best interest of the HA community for the Hydrawise maintainer(s) to perhaps reach out to Hunter and ensure that the Home Assistant integration is working with their API and system constraints for home users and ensure that Hunter knows we exist.\r\n\r\nAs @rct mentioned, this could possibly turn in to a MyQ scenario which did not play out well for anyone (except maybe the guy making the ratgdo's) and ultimately meant the removal of the MyQ integration. As home automation becomes more and more prevalent, I'm holding some hope that perhaps Hunter may be open to accepting its Home Assistant community and work with the integration maintainer(s) in ensuring continued support.\nAs a next step let's identify a polling frequency that is stable and then we (or I) can create a PR to change the default to this value.\r\n\r\nAll integrations in HA core that use http/https (like this one) identify the source as home-assistant in the user-agent tag which makes the origin visible to Hunter.\r\n\r\nTo contact them, we'd need an email for their product manager.  LinkedIn hunting?\nThere's a PR in review to fix the issue: https://github.com/home-assistant/core/pull/130289\nWhen is this issue getting resolved? \nJust upgraded to HA 2024.11.2 and I'm still having the exact same issue.\r\n\r\n2024-11-15 21:54:35.958 ERROR (MainThread) [homeassistant.components.hydrawise] Unexpected error fetching hydrawise data\r\nTraceback (most recent call last):\r\n  File \"/usr/local/lib/python3.12/site-packages/gql/transport/aiohttp.py\", line 319, in raise_response_error\r\n    resp.raise_for_status()\r\n  File \"/usr/local/lib/python3.12/site-packages/aiohttp/client_reqrep.py\", line 1158, in raise_for_status\r\n    raise ClientResponseError(\r\naiohttp.client_exceptions.ClientResponseError: 429, message='Too Many Requests', url='https://app.hydrawise.com/api/v2/graph'\r\n\r\nThe above exception was the direct cause of the following exception:\r\n\r\nTraceback (most recent call last):\r\n  File \"/usr/src/homeassistant/homeassistant/helpers/update_coordinator.py\", line 382, in _async_refresh\r\n    self.data = await self._async_update_data()\r\n                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/src/homeassistant/homeassistant/components/hydrawise/coordinator.py\", line 62, in _async_update_data\r\n    data = HydrawiseData(user=await self.api.get_user(fetch_zones=False))\r\n                              ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/local/lib/python3.12/site-packages/pydrawise/client.py\", line 109, in get_user\r\n    result = await self._query(\r\n             ^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/local/lib/python3.12/site-packages/pydrawise/client.py\", line 88, in _query\r\n    return await session.execute(dsl_gql(DSLQuery(selector)))\r\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/local/lib/python3.12/site-packages/gql/client.py\", line 1628, in execute\r\n    result = await self._execute(\r\n             ^^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/local/lib/python3.12/site-packages/gql/client.py\", line 1537, in _execute\r\n    result = await self.transport.execute(\r\n             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/local/lib/python3.12/site-packages/gql/transport/aiohttp.py\", line 341, in execute\r\n    await raise_response_error(resp, \"Not a JSON answer\")\r\n  File \"/usr/local/lib/python3.12/site-packages/gql/transport/aiohttp.py\", line 321, in raise_response_error\r\n    raise TransportServerError(str(e), e.status) from e\r\ngql.transport.exceptions.TransportServerError: 429, message='Too Many Requests', url='https://app.hydrawise.com/api/v2/graph'\r\n\n@dknowles2 \r\nSame here. I would assume the server closes the connection based on the number of requests no matter what data is fetched. The error 429 Too many requests suggests that. \r\n\r\nI found this documentation stating there is a nextpoll field in the REST api. Maybe something similar can be done here. https://www.hunterindustries.com/sites/default/files/2024-10/Hydrawise%20REST%20API%20Ver%201.6_0.pdf\r\n\r\nAnd in this comment \r\n\r\nhttps://github.com/martijndierckx/homebridge-hydrawise/issues/36#issuecomment-1901075598\r\n\r\nthey got a more specific error Message 429 \u201eExceeded maximum number of requests. You cannot make more than 10 requests in any 5 minute period to this endpoint\u201c I see that I have less connections than that but maybe they changed the limit recently now causing this trouble. \nI tried disabling polling, waiting, restarted, but it returns the same error. I disabled the integration, waited 2 hours, re-enabled the integration. still an error. Uninstalled the integration. reset HA, attempted to reinstall the Hydarwise integration and it returns an error saying \"unknown error occured\". now I cannot install it. \nSame here, I tried to restart, wait. Nothing helped. In the end I removed the integration and tried to set it up again and get unknown error occurred(429 in background). Also after waiting a couple of hours still the same. Seems it's no longer able to connect. \nSame here. After deleting the Integration I can not install it back again. Even another user did not solve the problem. The integration is from my point of view complete broken\nThe simplest way for them to implement rate limiting is on a per ip address basis. In this case changing the user name would not change behavior.  It's also possible that after they implemented rate limiting several weeks ago that has given them visibility into chatty clients (like HA) and they may have implemented a permanent ip ban or a longer duration ban (24 hours).\r\n\r\nTry disabling the integration come back in a day and see if then you can connect.\n> The simplest way for them to implement rate limiting is on a per ip address basis. In this case changing the user name would not change behavior. It's also possible that after they implemented rate limiting several weeks ago that has given them visibility into chatty clients (like HA) and they may have implemented a permanent ip ban or a longer duration ban (24 hours).\r\n> \r\n> Try disabling the integration come back in a day and see if then you can connect.\r\n\r\nI did this during the week.  First disabled polling for updates ( not necessary for my needs ).  Then disabled the integration and went to bed.  Next day I enabled the integration, it logged in first time and haven't had an issue since", "created_at": "2024-11-16T15:00:09Z"}
{"repo": "home-assistant/core", "pull_number": 130756, "instance_id": "home-assistant__core-130756", "issue_numbers": ["130714"], "base_commit": "a047abd51088ae60e54ce423371f47f3b52cc3f3", "patch": "diff --git a/homeassistant/components/sonos/media_player.py b/homeassistant/components/sonos/media_player.py\nindex 7711a1e88eaa4a..8d0917c5dbaee9 100644\n--- a/homeassistant/components/sonos/media_player.py\n+++ b/homeassistant/components/sonos/media_player.py\n@@ -782,9 +782,9 @@ def get_queue(self) -> list[dict]:\n         queue: list[DidlMusicTrack] = self.coordinator.soco.get_queue(max_items=0)\n         return [\n             {\n-                ATTR_MEDIA_TITLE: track.title,\n-                ATTR_MEDIA_ALBUM_NAME: track.album,\n-                ATTR_MEDIA_ARTIST: track.creator,\n+                ATTR_MEDIA_TITLE: getattr(track, \"title\", None),\n+                ATTR_MEDIA_ALBUM_NAME: getattr(track, \"album\", None),\n+                ATTR_MEDIA_ARTIST: getattr(track, \"creator\", None),\n                 ATTR_MEDIA_CONTENT_ID: track.get_uri(),\n             }\n             for track in queue\n", "test_patch": "diff --git a/tests/components/sonos/fixtures/sonos_queue.json b/tests/components/sonos/fixtures/sonos_queue.json\nindex 50689a00e1d36c..ffe08fc2b08248 100644\n--- a/tests/components/sonos/fixtures/sonos_queue.json\n+++ b/tests/components/sonos/fixtures/sonos_queue.json\n@@ -26,5 +26,17 @@\n         \"protocol_info\": \"file:*:audio/mpegurl:*\"\n       }\n     ]\n+  },\n+  {\n+    \"title\": \"Track with no album or creator\",\n+    \"item_id\": \"Q:0/3\",\n+    \"parent_id\": \"Q:0\",\n+    \"original_track_number\": 1,\n+    \"resources\": [\n+      {\n+        \"uri\": \"x-file-cifs://192.168.42.10/music/TrackWithNoAlbumOrCreator.mp3\",\n+        \"protocol_info\": \"file:*:audio/mpegurl:*\"\n+      }\n+    ]\n   }\n ]\ndiff --git a/tests/components/sonos/snapshots/test_media_player.ambr b/tests/components/sonos/snapshots/test_media_player.ambr\nindex f382d341de6674..8ef298de3db197 100644\n--- a/tests/components/sonos/snapshots/test_media_player.ambr\n+++ b/tests/components/sonos/snapshots/test_media_player.ambr\n@@ -71,6 +71,12 @@\n         'media_content_id': 'x-file-cifs://192.168.42.10/music/The%20Beatles/Abbey%20Road/01%20Come%20Together.mp3',\n         'media_title': 'Come Together',\n       }),\n+      dict({\n+        'media_album_name': None,\n+        'media_artist': None,\n+        'media_content_id': 'x-file-cifs://192.168.42.10/music/TrackWithNoAlbumOrCreator.mp3',\n+        'media_title': 'Track with no album or creator',\n+      }),\n     ]),\n   })\n # ---\n", "problem_statement": "Sonos - cue is not always available\n### The problem\r\n\r\nWith Sonos integration and you tube some of my playlists I can get a cue and some will not return a cue.    If I clear songs from playlist and just add a few songs cue is available, but once I add a lot of songs cue no longer shows.\r\n\r\n### What version of Home Assistant Core has the issue?\r\n\r\n2024.11.0\r\n\r\n### What was the last working version of Home Assistant Core?\r\n\r\n2024.11 0\r\n\r\n### What type of installation are you running?\r\n\r\nHome Assistant OS\r\n\r\n### Integration causing the issue\r\n\r\nSonos\r\n\r\n### Link to integration documentation on our website\r\n\r\n_No response_\r\n\r\n### Diagnostics information\r\n\r\n_No response_\r\n\r\n### Example YAML snippet\r\n\r\naction: sonos.get_queue\r\ntarget:\r\n  entity_id: media_player.master_bedroom_sonos\r\ndata: {}\r\n\r\n\r\n### Anything in the logs that might be useful for us?\r\n\r\nFailed to perform the action sonos.get_queue. Unknown error\r\n\r\n### Additional information\r\n\r\n_No response_\n", "hints_text": "\nHey there @jjlawren, @peterager, mind taking a look at this issue as it has been labeled with an integration (`sonos`) you are listed as a [code owner](https://github.com/home-assistant/core/blob/dev/CODEOWNERS#L1395) for? Thanks!\n\n<details>\n<summary>Code owner commands</summary>\n\n\nCode owners of `sonos` can trigger bot actions by commenting:\n\n- `@home-assistant close` Closes the issue.\n- `@home-assistant rename Awesome new title` Renames the issue.\n- `@home-assistant reopen` Reopen the issue.\n- `@home-assistant unassign sonos` Removes the current integration label and assignees on the issue, add the integration domain after the command.\n- `@home-assistant add-label needs-more-information` Add a label (needs-more-information, problem in dependency, problem in custom component) to the issue.\n- `@home-assistant remove-label needs-more-information` Remove a label (needs-more-information, problem in dependency, problem in custom component) on the issue.\n\n</details>\n\n\n<sub><sup>(message by CodeOwnersMention)</sup></sub>\n\n---\n\n[sonos documentation](https://www.home-assistant.io/integrations/sonos)\n[sonos source](https://github.com/home-assistant/core/tree/dev/homeassistant/components/sonos)\n<sub><sup>(message by IssueLinks)</sup></sub>\nPlease attach the home-assistant.log that contains the error.  \nHi Pete,\r\n\r\nI\u2019m not really sure what log you would need so I apologize as I\u2019m not too clear.   Basically, what is happening is I have different playlists in You Tube some of them will let me see the cue like this:\r\n\r\n***@***.***\r\n\r\n\r\n\r\nand some playlists I cannot pull the que.  If I delete all the songs and add a few it will work.  So I\u2019m thinking somehow there are certain songs that are causing this problem?\r\n\r\n***@***.***\r\n\r\nIn the log below I see this \u201cattribute error\u201d so not sure if this would tell me the problem?  Sorry if I\u2019m not getting you the information correctly on the log.  Just never exported them before and don\u2019t see a way to really do it.  Let me know\r\n\r\nAttributeError: 'DidlMusicTrack' object has no attribute 'album'\r\n2024-11-15 23:48:00.933 ERROR (MainThread) [homeassistant.components.websocket_api.http.connection] [140005536665312] Error handling message: Unknown error (unknown_error) Desktop from 192.168.0.229 (Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/130.0.0.0 Safari/537.36)\r\nTraceback (most recent call last):\r\n  File \"/usr/src/homeassistant/homeassistant/components/websocket_api/decorators.py\", line 28, in _handle_async_response\r\n    await func(hass, connection, msg)\r\n  File \"/usr/src/homeassistant/homeassistant/components/websocket_api/commands.py\", line 816, in handle_execute_script\r\n    script_result = await script_obj.async_run(\r\n                    ^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/src/homeassistant/homeassistant/helpers/script.py\", line 1801, in async_run\r\n    return await asyncio.shield(create_eager_task(run.async_run()))\r\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/src/homeassistant/homeassistant/helpers/script.py\", line 464, in async_run\r\n    await self._async_step(log_exceptions=False)\r\n  File \"/usr/src/homeassistant/homeassistant/helpers/script.py\", line 528, in _async_step\r\n    self._handle_exception(\r\n  File \"/usr/src/homeassistant/homeassistant/helpers/script.py\", line 558, in _handle_exception\r\n    raise exception\r\n  File \"/usr/src/homeassistant/homeassistant/helpers/script.py\", line 526, in _async_step\r\n    await getattr(self, handler)()\r\n  File \"/usr/src/homeassistant/homeassistant/helpers/script.py\", line 764, in _async_call_service_step\r\n    response_data = await self._async_run_long_action(\r\n                    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/src/homeassistant/homeassistant/helpers/script.py\", line 727, in _async_run_long_action\r\n    return await long_task\r\n           ^^^^^^^^^^^^^^^\r\n  File \"/usr/src/homeassistant/homeassistant/core.py\", line 2802, in async_call\r\n    response_data = await coro\r\n                    ^^^^^^^^^^\r\n  File \"/usr/src/homeassistant/homeassistant/core.py\", line 2845, in _execute_service\r\n    return await target(service_call)\r\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/src/homeassistant/homeassistant/helpers/service.py\", line 1007, in entity_service_call\r\n    single_response = await _handle_entity_call(\r\n                      ^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/src/homeassistant/homeassistant/helpers/service.py\", line 1079, in _handle_entity_call\r\n    result = await task\r\n             ^^^^^^^^^^\r\n  File \"/usr/local/lib/python3.12/concurrent/futures/thread.py\", line 58, in run\r\n    result = self.fn(*self.args, **self.kwargs)\r\n             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/src/homeassistant/homeassistant/components/sonos/helpers.py\", line 60, in wrapper\r\n    result = funct(self, *args, **kwargs)\r\n             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/src/homeassistant/homeassistant/components/sonos/media_player.py\", line 786, in get_queue\r\n    ATTR_MEDIA_ALBUM_NAME: track.album\r\n\r\nThanks,\r\nJohn\r\n\r\nFrom: Pete Sage ***@***.***>\r\nSent: 15 November 2024 22:40\r\nTo: home-assistant/core ***@***.***>\r\nCc: John DeKoven ***@***.***>; Author ***@***.***>\r\nSubject: Re: [home-assistant/core] Sonos - cue is not always available (Issue #130714)\r\n\r\n\r\nPlease attach the home-assistant.log that contains the error.\r\n\r\n\u2014\r\nReply to this email directly, view it on GitHub<https://github.com/home-assistant/core/issues/130714#issuecomment-2480064036>, or unsubscribe<https://github.com/notifications/unsubscribe-auth/ATF7TO5ENWCWKT6ONX4ANMT2AZZ4FAVCNFSM6AAAAABR32N4SOVHI2DSMVQWIX3LMV43OSLTON2WKQ3PNVWWK3TUHMZDIOBQGA3DIMBTGY>.\r\nYou are receiving this because you authored the thread.Message ID: ***@***.******@***.***>>\r\n\nIt looks like an item in your queue does not have an album name and that is causing the action to fail.\r\n\r\nWe'll need to update the code to not crash when this happens.\nOk thanks that\u2019s what I was thinking.  Not sure if there is a way for me t find out what track that is.  When I go through them they all show albums so it must be in some coding I assume.  Thanks again for looking into this and look forward to the change.\r\n\r\nCheers,\r\nJohn\r\n\r\nFrom: Pete Sage ***@***.***>\r\nSent: 16 November 2024 00:44\r\nTo: home-assistant/core ***@***.***>\r\nCc: John DeKoven ***@***.***>; Author ***@***.***>\r\nSubject: Re: [home-assistant/core] Sonos - cue is not always available (Issue #130714)\r\n\r\n\r\nIt looks like an item in your queue does not have an album name and that is causing the action to fail.\r\n\r\nWe'll need to update the code to not crash when this happens.\r\n\r\n\u2014\r\nReply to this email directly, view it on GitHub<https://github.com/home-assistant/core/issues/130714#issuecomment-2480236650>, or unsubscribe<https://github.com/notifications/unsubscribe-auth/ATF7TO45EA3WHUTSTNPYI3L2A2IN7AVCNFSM6AAAAABR32N4SOVHI2DSMVQWIX3LMV43OSLTON2WKQ3PNVWWK3TUHMZDIOBQGIZTMNRVGA>.\r\nYou are receiving this because you authored the thread.Message ID: ***@***.******@***.***>>\r\n", "created_at": "2024-11-16T13:32:31Z"}
{"repo": "home-assistant/core", "pull_number": 130752, "instance_id": "home-assistant__core-130752", "issue_numbers": ["123018"], "base_commit": "a047abd51088ae60e54ce423371f47f3b52cc3f3", "patch": "diff --git a/homeassistant/components/twentemilieu/manifest.json b/homeassistant/components/twentemilieu/manifest.json\nindex aef70aa6a1015..8ba4f3b760e73 100644\n--- a/homeassistant/components/twentemilieu/manifest.json\n+++ b/homeassistant/components/twentemilieu/manifest.json\n@@ -8,5 +8,5 @@\n   \"iot_class\": \"cloud_polling\",\n   \"loggers\": [\"twentemilieu\"],\n   \"quality_scale\": \"platinum\",\n-  \"requirements\": [\"twentemilieu==2.0.1\"]\n+  \"requirements\": [\"twentemilieu==2.1.0\"]\n }\ndiff --git a/requirements_all.txt b/requirements_all.txt\nindex 049310c344bf9..d27295e25a7f9 100644\n--- a/requirements_all.txt\n+++ b/requirements_all.txt\n@@ -2882,7 +2882,7 @@ ttn_client==1.2.0\n tuya-device-sharing-sdk==0.2.1\n \n # homeassistant.components.twentemilieu\n-twentemilieu==2.0.1\n+twentemilieu==2.1.0\n \n # homeassistant.components.twilio\n twilio==6.32.0\n", "test_patch": "diff --git a/requirements_test_all.txt b/requirements_test_all.txt\nindex f04da50271ed0..692976d453d56 100644\n--- a/requirements_test_all.txt\n+++ b/requirements_test_all.txt\n@@ -2295,7 +2295,7 @@ ttn_client==1.2.0\n tuya-device-sharing-sdk==0.2.1\n \n # homeassistant.components.twentemilieu\n-twentemilieu==2.0.1\n+twentemilieu==2.1.0\n \n # homeassistant.components.twilio\n twilio==6.32.0\n", "problem_statement": "Detected blocking call to listdir with args\n### The problem\n\nDetected blocking call to listdir\n\n### What version of Home Assistant Core has the issue?\n\n2024.7.4\n\n### What was the last working version of Home Assistant Core?\n\n_No response_\n\n### What type of installation are you running?\n\nHome Assistant OS\n\n### Integration causing the issue\n\ntwentemilieu\n\n### Link to integration documentation on our website\n\n_No response_\n\n### Diagnostics information\n\n_No response_\n\n### Example YAML snippet\n\n_No response_\n\n### Anything in the logs that might be useful for us?\n\n```txt\n2024-08-01 13:46:07.702 WARNING (MainThread) [homeassistant.util.loop] Detected blocking call to listdir with args ('/config/deps/lib/python3.12/site-packages',) inside the event loop by integration 'twentemilieu' at homeassistant/components/twentemilieu/__init__.py, line 49: await coordinator.async_config_entry_first_refresh() (offender: /usr/local/lib/python3.12/importlib/metadata/__init__.py, line 680: return os.listdir(self.root or '.')), please create a bug report at https://github.com/home-assistant/core/issues?q=is%3Aopen+is%3Aissue+label%3A%22integration%3A+twentemilieu%22\r\nFor developers, please see https://developers.home-assistant.io/docs/asyncio_blocking_operations/#listdir\r\nTraceback (most recent call last):\r\nFile \"<frozen runpy>\", line 198, in _run_module_as_main\r\nFile \"<frozen runpy>\", line 88, in _run_code\r\nFile \"/usr/src/homeassistant/homeassistant/__main__.py\", line 223, in <module>\r\nsys.exit(main())\r\nFile \"/usr/src/homeassistant/homeassistant/__main__.py\", line 209, in main\r\nexit_code = runner.run(runtime_conf)\r\nFile \"/usr/src/homeassistant/homeassistant/runner.py\", line 190, in run\r\nreturn loop.run_until_complete(setup_and_run_hass(runtime_config))\r\nFile \"/usr/local/lib/python3.12/asyncio/base_events.py\", line 674, in run_until_complete\r\nself.run_forever()\r\nFile \"/usr/local/lib/python3.12/asyncio/base_events.py\", line 641, in run_forever\r\nself._run_once()\r\nFile \"/usr/local/lib/python3.12/asyncio/base_events.py\", line 1990, in _run_once\r\nhandle._run()\r\nFile \"/usr/local/lib/python3.12/asyncio/events.py\", line 88, in _run\r\nself._context.run(self._callback, *self._args)\r\nFile \"/usr/src/homeassistant/homeassistant/setup.py\", line 167, in async_setup_component\r\nresult = await _async_setup_component(hass, domain, config)\r\nFile \"/usr/src/homeassistant/homeassistant/setup.py\", line 449, in _async_setup_component\r\nawait asyncio.gather(\r\nFile \"/usr/src/homeassistant/homeassistant/setup.py\", line 451, in <genexpr>\r\ncreate_eager_task(\r\nFile \"/usr/src/homeassistant/homeassistant/util/async_.py\", line 37, in create_eager_task\r\nreturn Task(coro, loop=loop, name=name, eager_start=True)\r\nFile \"/usr/src/homeassistant/homeassistant/config_entries.py\", line 734, in async_setup_locked\r\nawait self.async_setup(hass, integration=integration)\r\nFile \"/usr/src/homeassistant/homeassistant/config_entries.py\", line 586, in async_setup\r\nresult = await component.async_setup_entry(hass, self)\r\nFile \"/usr/src/homeassistant/homeassistant/components/twentemilieu/__init__.py\", line 49, in async_setup_entry\r\nawait coordinator.async_config_entry_first_refresh()\n```\n\n\n### Additional information\n\n_No response_\n", "hints_text": "\nHey there @frenck, mind taking a look at this issue as it has been labeled with an integration (`twentemilieu`) you are listed as a [code owner](https://github.com/home-assistant/core/blob/dev/CODEOWNERS#L1517) for? Thanks!\n\n<details>\n<summary>Code owner commands</summary>\n\n\nCode owners of `twentemilieu` can trigger bot actions by commenting:\n\n- `@home-assistant close` Closes the issue.\n- `@home-assistant rename Awesome new title` Renames the issue.\n- `@home-assistant reopen` Reopen the issue.\n- `@home-assistant unassign twentemilieu` Removes the current integration label and assignees on the issue, add the integration domain after the command.\n- `@home-assistant add-label needs-more-information` Add a label (needs-more-information, problem in dependency, problem in custom component) to the issue.\n- `@home-assistant remove-label needs-more-information` Remove a label (needs-more-information, problem in dependency, problem in custom component) on the issue.\n\n</details>\n\n\n<sub><sup>(message by CodeOwnersMention)</sup></sub>\n\n---\n\n[twentemilieu documentation](https://www.home-assistant.io/integrations/twentemilieu)\n[twentemilieu source](https://github.com/home-assistant/core/tree/dev/homeassistant/components/twentemilieu)\n<sub><sup>(message by IssueLinks)</sup></sub>\nIssue is here: https://github.com/frenck/python-twentemilieu/blob/88f33d8bc54a09180fb18615b184b6ca463920d0/src/twentemilieu/twentemilieu.py#L172 needs fix in upstream\n@frenck @homeassistant Any updates on this?", "created_at": "2024-11-16T12:19:02Z"}
{"repo": "home-assistant/core", "pull_number": 130746, "instance_id": "home-assistant__core-130746", "issue_numbers": ["130726"], "base_commit": "a047abd51088ae60e54ce423371f47f3b52cc3f3", "patch": "diff --git a/homeassistant/components/mqtt/config_flow.py b/homeassistant/components/mqtt/config_flow.py\nindex 6e6b44cd4b886f..69306a1c3830be 100644\n--- a/homeassistant/components/mqtt/config_flow.py\n+++ b/homeassistant/components/mqtt/config_flow.py\n@@ -33,7 +33,7 @@\n     CONF_PROTOCOL,\n     CONF_USERNAME,\n )\n-from homeassistant.core import callback\n+from homeassistant.core import HomeAssistant, callback\n from homeassistant.data_entry_flow import AbortFlow\n from homeassistant.helpers import config_validation as cv\n from homeassistant.helpers.hassio import is_hassio\n@@ -735,6 +735,16 @@ def _validate(\n         )\n \n \n+async def _get_uploaded_file(hass: HomeAssistant, id: str) -> str:\n+    \"\"\"Get file content from uploaded file.\"\"\"\n+\n+    def _proces_uploaded_file() -> str:\n+        with process_uploaded_file(hass, id) as file_path:\n+            return file_path.read_text(encoding=DEFAULT_ENCODING)\n+\n+    return await hass.async_add_executor_job(_proces_uploaded_file)\n+\n+\n async def async_get_broker_settings(\n     flow: ConfigFlow | OptionsFlow,\n     fields: OrderedDict[Any, Any],\n@@ -793,8 +803,7 @@ async def _async_validate_broker_settings(\n             return False\n         certificate_id: str | None = user_input.get(CONF_CERTIFICATE)\n         if certificate_id:\n-            with process_uploaded_file(hass, certificate_id) as certificate_file:\n-                certificate = certificate_file.read_text(encoding=DEFAULT_ENCODING)\n+            certificate = await _get_uploaded_file(hass, certificate_id)\n \n         # Return to form for file upload CA cert or client cert and key\n         if (\n@@ -810,15 +819,9 @@ async def _async_validate_broker_settings(\n             return False\n \n         if client_certificate_id:\n-            with process_uploaded_file(\n-                hass, client_certificate_id\n-            ) as client_certificate_file:\n-                client_certificate = client_certificate_file.read_text(\n-                    encoding=DEFAULT_ENCODING\n-                )\n+            client_certificate = await _get_uploaded_file(hass, client_certificate_id)\n         if client_key_id:\n-            with process_uploaded_file(hass, client_key_id) as key_file:\n-                client_key = key_file.read_text(encoding=DEFAULT_ENCODING)\n+            client_key = await _get_uploaded_file(hass, client_key_id)\n \n         certificate_data: dict[str, Any] = {}\n         if certificate:\n", "test_patch": "", "problem_statement": "\"Detected blocking call to read_text with args\" for certificate, client_certificate, and client_key objects\n### The problem\n\nWhen attempting to configure an MQTT broker integration in the Home Assistant UI, the following stack traces are generated in logs.\r\n\r\n\r\nFor `certificate`:\r\n```\r\n2024-11-15 18:13:04.252 WARNING (MainThread) [homeassistant.util.loop] Detected blocking call to read_text with args (PosixPath('/tmp/home-assistant-file_upload/01933287b29ec4bae5710537f6d73f0f/ca.crt'),) inside the event loop by integration 'mqtt' at homeassistant/components/mqtt/config_flow.py, line 808: certificate = certificate_file.read_text(encoding=DEFAULT_ENCODING) (offender: /usr/src/homeassistant/homeassistant/components/mqtt/config_flow.py, line 808: certificate = certificate_file.read_text(encoding=DEFAULT_ENCODING)), please create a bug report at https://github.com/home-assistant/core/issues?q=is%3Aopen+is%3Aissue+label%3A%22integration%3A+mqtt%22\r\nFor developers, please see https://developers.home-assistant.io/docs/asyncio_blocking_operations/#read_text\r\nTraceback (most recent call last):\r\n  File \"<frozen runpy>\", line 198, in _run_module_as_main\r\n  File \"<frozen runpy>\", line 88, in _run_code\r\n  File \"/usr/src/homeassistant/homeassistant/__main__.py\", line 223, in <module>\r\n    sys.exit(main())\r\n  File \"/usr/src/homeassistant/homeassistant/__main__.py\", line 209, in main\r\n    exit_code = runner.run(runtime_conf)\r\n  File \"/usr/src/homeassistant/homeassistant/runner.py\", line 189, in run\r\n    return loop.run_until_complete(setup_and_run_hass(runtime_config))\r\n  File \"/usr/local/lib/python3.12/asyncio/base_events.py\", line 674, in run_until_complete\r\n    self.run_forever()\r\n  File \"/usr/local/lib/python3.12/asyncio/base_events.py\", line 641, in run_forever\r\n    self._run_once()\r\n  File \"/usr/local/lib/python3.12/asyncio/base_events.py\", line 1990, in _run_once\r\n    handle._run()\r\n  File \"/usr/local/lib/python3.12/asyncio/events.py\", line 88, in _run\r\n    self._context.run(self._callback, *self._args)\r\n  File \"/usr/local/lib/python3.12/site-packages/aiohttp/web_protocol.py\", line 556, in start\r\n    task = asyncio.Task(coro, loop=loop, eager_start=True)\r\n  File \"/usr/local/lib/python3.12/site-packages/aiohttp/web_protocol.py\", line 477, in _handle_request\r\n    resp = await request_handler(request)\r\n  File \"/usr/local/lib/python3.12/site-packages/aiohttp/web_app.py\", line 559, in _handle\r\n    return await handler(request)\r\n  File \"/usr/local/lib/python3.12/site-packages/aiohttp/web_middlewares.py\", line 117, in impl\r\n    return await handler(request)\r\n  File \"/usr/src/homeassistant/homeassistant/components/http/security_filter.py\", line 92, in security_filter_middleware\r\n    return await handler(request)\r\n  File \"/usr/src/homeassistant/homeassistant/components/http/forwarded.py\", line 210, in forwarded_middleware\r\n    return await handler(request)\r\n  File \"/usr/src/homeassistant/homeassistant/components/http/request_context.py\", line 26, in request_context_middleware\r\n    return await handler(request)\r\n  File \"/usr/src/homeassistant/homeassistant/components/http/ban.py\", line 85, in ban_middleware\r\n    return await handler(request)\r\n  File \"/usr/src/homeassistant/homeassistant/components/http/auth.py\", line 242, in auth_middleware\r\n    return await handler(request)\r\n  File \"/usr/src/homeassistant/homeassistant/components/http/headers.py\", line 32, in headers_middleware\r\n    response = await handler(request)\r\n  File \"/usr/src/homeassistant/homeassistant/helpers/http.py\", line 73, in handle\r\n    result = await handler(request, **request.match_info)\r\n  File \"/usr/src/homeassistant/homeassistant/components/http/decorators.py\", line 81, in with_admin\r\n    return await func(self, request, *args, **kwargs)\r\n  File \"/usr/src/homeassistant/homeassistant/components/config/config_entries.py\", line 222, in post\r\n    return await super().post(request, flow_id)\r\n  File \"/usr/src/homeassistant/homeassistant/components/http/data_validator.py\", line 74, in wrapper\r\n    return await method(view, request, data, *args, **kwargs)\r\n  File \"/usr/src/homeassistant/homeassistant/helpers/data_entry_flow.py\", line 122, in post\r\n    result = await self._flow_mgr.async_configure(flow_id, data)\r\n  File \"/usr/src/homeassistant/homeassistant/data_entry_flow.py\", line 370, in async_configure\r\n    result = await self._async_configure(flow_id, user_input)\r\n  File \"/usr/src/homeassistant/homeassistant/data_entry_flow.py\", line 417, in _async_configure\r\n    result = await self._async_handle_step(\r\n  File \"/usr/src/homeassistant/homeassistant/data_entry_flow.py\", line 520, in _async_handle_step\r\n    result: _FlowResultT = await getattr(flow, method)(user_input)\r\n  File \"/usr/src/homeassistant/homeassistant/components/mqtt/config_flow.py\", line 479, in async_step_broker\r\n    if await async_get_broker_settings(\r\n  File \"/usr/src/homeassistant/homeassistant/components/mqtt/config_flow.py\", line 874, in async_get_broker_settings\r\n    if await _async_validate_broker_settings(\r\n  File \"/usr/src/homeassistant/homeassistant/components/mqtt/config_flow.py\", line 808, in _async_validate_broker_settings\r\n    certificate = certificate_file.read_text(encoding=DEFAULT_ENCODING)\r\n```\r\n\r\nFor `client_certificate`:\r\n```\r\n2024-11-15 18:13:39.282 WARNING (MainThread) [homeassistant.util.loop] Detected blocking call to read_text with args (PosixPath('/tmp/home-assistant-file_upload/01933287fdeb0744f0dc2e7b1809ef03/hass-mqtt-client.crt'),) inside the event loop by integration 'mqtt' at homeassistant/components/mqtt/config_flow.py, line 827: client_certificate = client_certificate_file.read_text( (offender: /usr/src/homeassistant/homeassistant/components/mqtt/config_flow.py, line 827: client_certificate = client_certificate_file.read_text(), please create a bug report at https://github.com/home-assistant/core/issues?q=is%3Aopen+is%3Aissue+label%3A%22integration%3A+mqtt%22\r\nFor developers, please see https://developers.home-assistant.io/docs/asyncio_blocking_operations/#read_text\r\nTraceback (most recent call last):\r\n  File \"<frozen runpy>\", line 198, in _run_module_as_main\r\n  File \"<frozen runpy>\", line 88, in _run_code\r\n  File \"/usr/src/homeassistant/homeassistant/__main__.py\", line 223, in <module>\r\n    sys.exit(main())\r\n  File \"/usr/src/homeassistant/homeassistant/__main__.py\", line 209, in main\r\n    exit_code = runner.run(runtime_conf)\r\n  File \"/usr/src/homeassistant/homeassistant/runner.py\", line 189, in run\r\n    return loop.run_until_complete(setup_and_run_hass(runtime_config))\r\n  File \"/usr/local/lib/python3.12/asyncio/base_events.py\", line 674, in run_until_complete\r\n    self.run_forever()\r\n  File \"/usr/local/lib/python3.12/asyncio/base_events.py\", line 641, in run_forever\r\n    self._run_once()\r\n  File \"/usr/local/lib/python3.12/asyncio/base_events.py\", line 1990, in _run_once\r\n    handle._run()\r\n  File \"/usr/local/lib/python3.12/asyncio/events.py\", line 88, in _run\r\n    self._context.run(self._callback, *self._args)\r\n  File \"/usr/local/lib/python3.12/site-packages/aiohttp/web_protocol.py\", line 477, in _handle_request\r\n    resp = await request_handler(request)\r\n  File \"/usr/local/lib/python3.12/site-packages/aiohttp/web_app.py\", line 559, in _handle\r\n    return await handler(request)\r\n  File \"/usr/local/lib/python3.12/site-packages/aiohttp/web_middlewares.py\", line 117, in impl\r\n    return await handler(request)\r\n  File \"/usr/src/homeassistant/homeassistant/components/http/security_filter.py\", line 92, in security_filter_middleware\r\n    return await handler(request)\r\n  File \"/usr/src/homeassistant/homeassistant/components/http/forwarded.py\", line 210, in forwarded_middleware\r\n    return await handler(request)\r\n  File \"/usr/src/homeassistant/homeassistant/components/http/request_context.py\", line 26, in request_context_middleware\r\n    return await handler(request)\r\n  File \"/usr/src/homeassistant/homeassistant/components/http/ban.py\", line 85, in ban_middleware\r\n    return await handler(request)\r\n  File \"/usr/src/homeassistant/homeassistant/components/http/auth.py\", line 242, in auth_middleware\r\n    return await handler(request)\r\n  File \"/usr/src/homeassistant/homeassistant/components/http/headers.py\", line 32, in headers_middleware\r\n    response = await handler(request)\r\n  File \"/usr/src/homeassistant/homeassistant/helpers/http.py\", line 73, in handle\r\n    result = await handler(request, **request.match_info)\r\n  File \"/usr/src/homeassistant/homeassistant/components/http/decorators.py\", line 81, in with_admin\r\n    return await func(self, request, *args, **kwargs)\r\n  File \"/usr/src/homeassistant/homeassistant/components/config/config_entries.py\", line 222, in post\r\n    return await super().post(request, flow_id)\r\n  File \"/usr/src/homeassistant/homeassistant/components/http/data_validator.py\", line 74, in wrapper\r\n    return await method(view, request, data, *args, **kwargs)\r\n  File \"/usr/src/homeassistant/homeassistant/helpers/data_entry_flow.py\", line 122, in post\r\n    result = await self._flow_mgr.async_configure(flow_id, data)\r\n  File \"/usr/src/homeassistant/homeassistant/data_entry_flow.py\", line 370, in async_configure\r\n    result = await self._async_configure(flow_id, user_input)\r\n  File \"/usr/src/homeassistant/homeassistant/data_entry_flow.py\", line 417, in _async_configure\r\n    result = await self._async_handle_step(\r\n  File \"/usr/src/homeassistant/homeassistant/data_entry_flow.py\", line 520, in _async_handle_step\r\n    result: _FlowResultT = await getattr(flow, method)(user_input)\r\n  File \"/usr/src/homeassistant/homeassistant/components/mqtt/config_flow.py\", line 479, in async_step_broker\r\n    if await async_get_broker_settings(\r\n  File \"/usr/src/homeassistant/homeassistant/components/mqtt/config_flow.py\", line 874, in async_get_broker_settings\r\n    if await _async_validate_broker_settings(\r\n  File \"/usr/src/homeassistant/homeassistant/components/mqtt/config_flow.py\", line 827, in _async_validate_broker_settings\r\n    client_certificate = client_certificate_file.read_text(\r\n```\r\n\r\nStack trace ended there without completing that line.\r\n\r\nFor `client_key`:\r\n```\r\n2024-11-15 18:13:39.288 WARNING (MainThread) [homeassistant.util.loop] Detected blocking call to read_text with args (PosixPath('/tmp/home-assistant-file_upload/019332881289bacf519f5692306a9e88/hass-mqtt-client.key'),) inside the event loop by integration 'mqtt' at homeassistant/components/mqtt/config_flow.py, line 832: client_key = key_file.read_text(encoding=DEFAULT_ENCODING) (offender: /usr/src/homeassistant/homeassistant/components/mqtt/config_flow.py, line 832: client_key = key_file.read_text(encoding=DEFAULT_ENCODING)), please create a bug report at https://github.com/home-assistant/core/issues?q=is%3Aopen+is%3Aissue+label%3A%22integration%3A+mqtt%22\r\nFor developers, please see https://developers.home-assistant.io/docs/asyncio_blocking_operations/#read_text\r\nTraceback (most recent call last):\r\n  File \"<frozen runpy>\", line 198, in _run_module_as_main\r\n  File \"<frozen runpy>\", line 88, in _run_code\r\n  File \"/usr/src/homeassistant/homeassistant/__main__.py\", line 223, in <module>\r\n    sys.exit(main())\r\n  File \"/usr/src/homeassistant/homeassistant/__main__.py\", line 209, in main\r\n    exit_code = runner.run(runtime_conf)\r\n  File \"/usr/src/homeassistant/homeassistant/runner.py\", line 189, in run\r\n    return loop.run_until_complete(setup_and_run_hass(runtime_config))\r\n  File \"/usr/local/lib/python3.12/asyncio/base_events.py\", line 674, in run_until_complete\r\n    self.run_forever()\r\n  File \"/usr/local/lib/python3.12/asyncio/base_events.py\", line 641, in run_forever\r\n    self._run_once()\r\n  File \"/usr/local/lib/python3.12/asyncio/base_events.py\", line 1990, in _run_once\r\n    handle._run()\r\n  File \"/usr/local/lib/python3.12/asyncio/events.py\", line 88, in _run\r\n    self._context.run(self._callback, *self._args)\r\n  File \"/usr/local/lib/python3.12/site-packages/aiohttp/web_protocol.py\", line 477, in _handle_request\r\n    resp = await request_handler(request)\r\n  File \"/usr/local/lib/python3.12/site-packages/aiohttp/web_app.py\", line 559, in _handle\r\n    return await handler(request)\r\n  File \"/usr/local/lib/python3.12/site-packages/aiohttp/web_middlewares.py\", line 117, in impl\r\n    return await handler(request)\r\n  File \"/usr/src/homeassistant/homeassistant/components/http/security_filter.py\", line 92, in security_filter_middleware\r\n    return await handler(request)\r\n  File \"/usr/src/homeassistant/homeassistant/components/http/forwarded.py\", line 210, in forwarded_middleware\r\n    return await handler(request)\r\n  File \"/usr/src/homeassistant/homeassistant/components/http/request_context.py\", line 26, in request_context_middleware\r\n    return await handler(request)\r\n  File \"/usr/src/homeassistant/homeassistant/components/http/ban.py\", line 85, in ban_middleware\r\n    return await handler(request)\r\n  File \"/usr/src/homeassistant/homeassistant/components/http/auth.py\", line 242, in auth_middleware\r\n    return await handler(request)\r\n  File \"/usr/src/homeassistant/homeassistant/components/http/headers.py\", line 32, in headers_middleware\r\n    response = await handler(request)\r\n  File \"/usr/src/homeassistant/homeassistant/helpers/http.py\", line 73, in handle\r\n    result = await handler(request, **request.match_info)\r\n  File \"/usr/src/homeassistant/homeassistant/components/http/decorators.py\", line 81, in with_admin\r\n    return await func(self, request, *args, **kwargs)\r\n  File \"/usr/src/homeassistant/homeassistant/components/config/config_entries.py\", line 222, in post\r\n    return await super().post(request, flow_id)\r\n  File \"/usr/src/homeassistant/homeassistant/components/http/data_validator.py\", line 74, in wrapper\r\n    return await method(view, request, data, *args, **kwargs)\r\n  File \"/usr/src/homeassistant/homeassistant/helpers/data_entry_flow.py\", line 122, in post\r\n    result = await self._flow_mgr.async_configure(flow_id, data)\r\n  File \"/usr/src/homeassistant/homeassistant/data_entry_flow.py\", line 370, in async_configure\r\n    result = await self._async_configure(flow_id, user_input)\r\n  File \"/usr/src/homeassistant/homeassistant/data_entry_flow.py\", line 417, in _async_configure\r\n    result = await self._async_handle_step(\r\n  File \"/usr/src/homeassistant/homeassistant/data_entry_flow.py\", line 520, in _async_handle_step\r\n    result: _FlowResultT = await getattr(flow, method)(user_input)\r\n  File \"/usr/src/homeassistant/homeassistant/components/mqtt/config_flow.py\", line 479, in async_step_broker\r\n    if await async_get_broker_settings(\r\n  File \"/usr/src/homeassistant/homeassistant/components/mqtt/config_flow.py\", line 874, in async_get_broker_settings\r\n    if await _async_validate_broker_settings(\r\n  File \"/usr/src/homeassistant/homeassistant/components/mqtt/config_flow.py\", line 832, in _async_validate_broker_settings\r\n    client_key = key_file.read_text(encoding=DEFAULT_ENCODING)\r\n```\n\n### What version of Home Assistant Core has the issue?\n\ncore-2024.10.4\n\n### What was the last working version of Home Assistant Core?\n\n_No response_\n\n### What type of installation are you running?\n\nHome Assistant Container\n\n### Integration causing the issue\n\nMQTT\n\n### Link to integration documentation on our website\n\nhttps://www.home-assistant.io/integrations/mqtt/\n\n### Diagnostics information\n\n_No response_\n\n### Example YAML snippet\n\n_No response_\n\n### Anything in the logs that might be useful for us?\n\n_No response_\n\n### Additional information\n\nI cannot successfully configure the MQTT integration so there is no option to enable debug logging on it or to download diagnostic information. I would if I could.\n", "hints_text": "\nHey there @emontnemery, @jbouwh, @bdraco, mind taking a look at this issue as it has been labeled with an integration (`mqtt`) you are listed as a [code owner](https://github.com/home-assistant/core/blob/dev/CODEOWNERS#L954) for? Thanks!\n\n<details>\n<summary>Code owner commands</summary>\n\n\nCode owners of `mqtt` can trigger bot actions by commenting:\n\n- `@home-assistant close` Closes the issue.\n- `@home-assistant rename Awesome new title` Renames the issue.\n- `@home-assistant reopen` Reopen the issue.\n- `@home-assistant unassign mqtt` Removes the current integration label and assignees on the issue, add the integration domain after the command.\n- `@home-assistant add-label needs-more-information` Add a label (needs-more-information, problem in dependency, problem in custom component) to the issue.\n- `@home-assistant remove-label needs-more-information` Remove a label (needs-more-information, problem in dependency, problem in custom component) on the issue.\n\n</details>\n\n\n<sub><sup>(message by CodeOwnersMention)</sup></sub>\n\n---\n\n[mqtt documentation](https://www.home-assistant.io/integrations/mqtt)\n[mqtt source](https://github.com/home-assistant/core/tree/dev/homeassistant/components/mqtt)\n<sub><sup>(message by IssueLinks)</sup></sub>", "created_at": "2024-11-16T10:15:26Z"}
{"repo": "home-assistant/core", "pull_number": 130679, "instance_id": "home-assistant__core-130679", "issue_numbers": ["130675"], "base_commit": "ae95d802cc51bab01347c5a9ddbdf628f1fdb90e", "patch": "diff --git a/homeassistant/components/smarttub/manifest.json b/homeassistant/components/smarttub/manifest.json\nindex f2514063a4091..432f6338d9f99 100644\n--- a/homeassistant/components/smarttub/manifest.json\n+++ b/homeassistant/components/smarttub/manifest.json\n@@ -7,5 +7,5 @@\n   \"iot_class\": \"cloud_polling\",\n   \"loggers\": [\"smarttub\"],\n   \"quality_scale\": \"platinum\",\n-  \"requirements\": [\"python-smarttub==0.0.36\"]\n+  \"requirements\": [\"python-smarttub==0.0.38\"]\n }\ndiff --git a/requirements_all.txt b/requirements_all.txt\nindex ea7bdefce2b9e..3a1dafe21e9ed 100644\n--- a/requirements_all.txt\n+++ b/requirements_all.txt\n@@ -2405,7 +2405,7 @@ python-ripple-api==0.0.3\n python-roborock==2.7.2\n \n # homeassistant.components.smarttub\n-python-smarttub==0.0.36\n+python-smarttub==0.0.38\n \n # homeassistant.components.songpal\n python-songpal==0.16.2\n", "test_patch": "diff --git a/requirements_test_all.txt b/requirements_test_all.txt\nindex cf1e761bfa930..c01a0ae660c5d 100644\n--- a/requirements_test_all.txt\n+++ b/requirements_test_all.txt\n@@ -1926,7 +1926,7 @@ python-rabbitair==0.0.8\n python-roborock==2.7.2\n \n # homeassistant.components.smarttub\n-python-smarttub==0.0.36\n+python-smarttub==0.0.38\n \n # homeassistant.components.songpal\n python-songpal==0.16.2\n", "problem_statement": "SmartTub not working with Sundance Peyton 680\n### The problem\n\nAfter successful linking account into Smarttub integration, no data are updating\r\n\r\n`Enregistreur: homeassistant.components.smarttub.controller\r\nSource: helpers/update_coordinator.py:382\r\nint\u00e9gration: SmartTub (documentation, probl\u00e8mes)\r\nS'est produit pour la premi\u00e8re fois: 14 novembre 2024 \u00e0 21:52:25 (655 occurrences)\r\nDernier enregistrement: 08:46:09\r\n\r\nUnexpected error fetching smarttub data\r\nTraceback (most recent call last):\r\n  File \"/usr/src/homeassistant/homeassistant/helpers/update_coordinator.py\", line 382, in _async_refresh\r\n    self.data = await self._async_update_data()\r\n                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/src/homeassistant/homeassistant/helpers/update_coordinator.py\", line 279, in _async_update_data\r\n    return await self.update_method()\r\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/src/homeassistant/homeassistant/components/smarttub/controller.py\", line 89, in async_update_data\r\n    data[spa.id] = await self._get_spa_data(spa)\r\n                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/src/homeassistant/homeassistant/components/smarttub/controller.py\", line 96, in _get_spa_data\r\n    full_status, reminders, errors = await asyncio.gather(\r\n                                     ^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/local/lib/python3.12/site-packages/smarttub/api.py\", line 215, in get_status_full\r\n    return SpaStateFull(self, full_status)\r\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/local/lib/python3.12/site-packages/smarttub/api.py\", line 369, in __init__\r\n    super().__init__(spa, **state)\r\n  File \"/usr/local/lib/python3.12/site-packages/smarttub/api.py\", line 297, in __init__\r\n    self._prop(\"heatMode\", constructor=lambda x: Spa.HeatMode[x])\r\n  File \"/usr/local/lib/python3.12/site-packages/smarttub/api.py\", line 358, in _prop\r\n    constructor(self.properties[json_key]),\r\n    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/local/lib/python3.12/site-packages/smarttub/api.py\", line 297, in <lambda>\r\n    self._prop(\"heatMode\", constructor=lambda x: Spa.HeatMode[x])\r\n                                                 ~~~~~~~~~~~~^^^\r\n  File \"/usr/local/lib/python3.12/enum.py\", line 814, in __getitem__\r\n    return cls._member_map_[name]\r\n           ~~~~~~~~~~~~~~~~^^^^^^\r\nKeyError: 'REST'`\n\n### What version of Home Assistant Core has the issue?\n\ncore-2024.11.1\n\n### What was the last working version of Home Assistant Core?\n\n_No response_\n\n### What type of installation are you running?\n\nHome Assistant Container\n\n### Integration causing the issue\n\nSmarttub\n\n### Link to integration documentation on our website\n\nhttps://www.home-assistant.io/integrations/smarttub/\n\n### Diagnostics information\n\n[home-assistant_smarttub_2024-11-15T07-55-10.156Z.log](https://github.com/user-attachments/files/17771408/home-assistant_smarttub_2024-11-15T07-55-10.156Z.log)\r\n\n\n### Example YAML snippet\n\n_No response_\n\n### Anything in the logs that might be useful for us?\n\n_No response_\n\n### Additional information\n\n_No response_\n", "hints_text": "\nHey there @mdz, mind taking a look at this issue as it has been labeled with an integration (`smarttub`) you are listed as a [code owner](https://github.com/home-assistant/core/blob/dev/CODEOWNERS#L1366) for? Thanks!\n\n<details>\n<summary>Code owner commands</summary>\n\n\nCode owners of `smarttub` can trigger bot actions by commenting:\n\n- `@home-assistant close` Closes the issue.\n- `@home-assistant rename Awesome new title` Renames the issue.\n- `@home-assistant reopen` Reopen the issue.\n- `@home-assistant unassign smarttub` Removes the current integration label and assignees on the issue, add the integration domain after the command.\n- `@home-assistant add-label needs-more-information` Add a label (needs-more-information, problem in dependency, problem in custom component) to the issue.\n- `@home-assistant remove-label needs-more-information` Remove a label (needs-more-information, problem in dependency, problem in custom component) on the issue.\n\n</details>\n\n\n<sub><sup>(message by CodeOwnersMention)</sup></sub>\n\n---\n\n[smarttub documentation](https://www.home-assistant.io/integrations/smarttub)\n[smarttub source](https://github.com/home-assistant/core/tree/dev/homeassistant/components/smarttub)\n<sub><sup>(message by IssueLinks)</sup></sub>", "created_at": "2024-11-15T08:23:36Z"}
{"repo": "home-assistant/core", "pull_number": 130627, "instance_id": "home-assistant__core-130627", "issue_numbers": ["120418"], "base_commit": "1ce8bfdaa438949da707d94ff7b12ff7b20ce0cc", "patch": "diff --git a/homeassistant/components/hue/scene.py b/homeassistant/components/hue/scene.py\nindex 6808ddb53530f9..1d83804820d94d 100644\n--- a/homeassistant/components/hue/scene.py\n+++ b/homeassistant/components/hue/scene.py\n@@ -130,10 +130,15 @@ class HueSceneEntity(HueSceneEntityBase):\n     @property\n     def is_dynamic(self) -> bool:\n         \"\"\"Return if this scene has a dynamic color palette.\"\"\"\n-        if self.resource.palette.color and len(self.resource.palette.color) > 1:\n+        if (\n+            self.resource.palette\n+            and self.resource.palette.color\n+            and len(self.resource.palette.color) > 1\n+        ):\n             return True\n         if (\n-            self.resource.palette.color_temperature\n+            self.resource.palette\n+            and self.resource.palette.color_temperature\n             and len(self.resource.palette.color_temperature) > 1\n         ):\n             return True\n", "test_patch": "", "problem_statement": "Philips Hue Integration: Unable to add scene (continuation of 109362)\n### The problem\n\nJust like mentioned in https://github.com/home-assistant/core/issues/109362 still getting error with hue scene adding although I can see them in integration realted entities...\r\n\r\n![image](https://github.com/home-assistant/core/assets/21099773/1f5b5bf8-3267-493a-b577-b7f852931b31)\r\n\n\n### What version of Home Assistant Core has the issue?\n\ncore-2024.6.4\n\n### What was the last working version of Home Assistant Core?\n\nn/a\n\n### What type of installation are you running?\n\nHome Assistant OS\n\n### Integration causing the issue\n\n\t6.6.31-haos-raspi\n\n### Link to integration documentation on our website\n\nhttps://www.home-assistant.io/integrations/hue/\n\n### Diagnostics information\n\n_No response_\n\n### Example YAML snippet\n\n_No response_\n\n### Anything in the logs that might be useful for us?\n\n```txt\n2024-06-25 14:40:18.649 ERROR (MainThread) [homeassistant.components.scene] Error adding entity scene.hue_zyrandol_przy_tv_lampka_nocna for domain scene with platform hue\r\nTraceback (most recent call last):\r\n  File \"/usr/src/homeassistant/homeassistant/helpers/entity_platform.py\", line 600, in _async_add_entities\r\n    await coro\r\n  File \"/usr/src/homeassistant/homeassistant/helpers/entity_platform.py\", line 914, in _async_add_entity\r\n    await entity.add_to_platform_finish()\r\n  File \"/usr/src/homeassistant/homeassistant/helpers/entity.py\", line 1355, in add_to_platform_finish\r\n    self.async_write_ha_state()\r\n  File \"/usr/src/homeassistant/homeassistant/helpers/entity.py\", line 1000, in async_write_ha_state\r\n    self._async_write_ha_state()\r\n  File \"/usr/src/homeassistant/homeassistant/helpers/entity.py\", line 1126, in _async_write_ha_state\r\n    state, attr, capabilities, shadowed_attr = self.__async_calculate_state()\r\n                                               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/src/homeassistant/homeassistant/helpers/entity.py\", line 1065, in __async_calculate_state\r\n    if extra_state_attributes := self.extra_state_attributes:\r\n                                 ^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/src/homeassistant/homeassistant/components/hue/scene.py\", line 186, in extra_state_attributes\r\n    \"is_dynamic\": self.is_dynamic,\r\n                  ^^^^^^^^^^^^^^^\r\n  File \"/usr/src/homeassistant/homeassistant/components/hue/scene.py\", line 133, in is_dynamic\r\n    if self.resource.palette.color and len(self.resource.palette.color) > 1:\r\n       ^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\nAttributeError: 'NoneType' object has no attribute 'color'\n```\n\n\n### Additional information\n\n_No response_\n", "hints_text": "\nHey there @balloob, @marcelveldt, mind taking a look at this issue as it has been labeled with an integration (`hue`) you are listed as a [code owner](https://github.com/home-assistant/core/blob/dev/CODEOWNERS#L620) for? Thanks!\n\n<details>\n<summary>Code owner commands</summary>\n\n\nCode owners of `hue` can trigger bot actions by commenting:\n\n- `@home-assistant close` Closes the issue.\n- `@home-assistant rename Awesome new title` Renames the issue.\n- `@home-assistant reopen` Reopen the issue.\n- `@home-assistant unassign hue` Removes the current integration label and assignees on the issue, add the integration domain after the command.\n- `@home-assistant add-label needs-more-information` Add a label (needs-more-information, problem in dependency, problem in custom component) to the issue.\n- `@home-assistant remove-label needs-more-information` Remove a label (needs-more-information, problem in dependency, problem in custom component) on the issue.\n\n</details>\n\n\n<sub><sup>(message by CodeOwnersMention)</sup></sub>\n\n---\n\n[hue documentation](https://www.home-assistant.io/integrations/hue)\n[hue source](https://github.com/home-assistant/core/tree/dev/homeassistant/components/hue)\n<sub><sup>(message by IssueLinks)</sup></sub>\nI have exactly the same issue. I've created three new scenes with HUE app, but they are not synced to HA:\r\n![image](https://github.com/home-assistant/core/assets/47367267/b27bbe40-a609-4e98-b69d-c1c9635b2d87)\r\n\r\nLog:\r\n`2024-07-01 22:01:26.938 ERROR (MainThread) [homeassistant] Error doing job: Task exception was never retrieved (None)\r\nTraceback (most recent call last):\r\n  File \"/usr/src/homeassistant/homeassistant/helpers/entity.py\", line 1525, in _async_process_registry_update_or_remove\r\n    self.async_write_ha_state()\r\n  File \"/usr/src/homeassistant/homeassistant/helpers/entity.py\", line 1000, in async_write_ha_state\r\n    self._async_write_ha_state()\r\n  File \"/usr/src/homeassistant/homeassistant/helpers/entity.py\", line 1126, in _async_write_ha_state\r\n    state, attr, capabilities, shadowed_attr = self.__async_calculate_state()\r\n                                               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/src/homeassistant/homeassistant/helpers/entity.py\", line 1065, in __async_calculate_state\r\n    if extra_state_attributes := self.extra_state_attributes:\r\n                                 ^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/src/homeassistant/homeassistant/components/hue/scene.py\", line 186, in extra_state_attributes\r\n    \"is_dynamic\": self.is_dynamic,\r\n                  ^^^^^^^^^^^^^^^\r\n  File \"/usr/src/homeassistant/homeassistant/components/hue/scene.py\", line 133, in is_dynamic\r\n    if self.resource.palette.color and len(self.resource.palette.color) > 1:\r\n       ^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\nAttributeError: 'NoneType' object has no attribute 'color'`\nThis should most probably be fixed with https://github.com/home-assistant/core/pull/122651 (which ia targeted for 2024.7.4) but it needs to be confirmed.\nNo. Stil having errors on 2024.7.4\r\n\r\n`\r\nRejestrator: homeassistant.components.scene\r\n\u0179r\u00f3d\u0142o: helpers/entity_platform.py:598\r\nintegracja: Scena (dokumentacja, Problemy)\r\nPierwsze zdarzenie: 12:16:10 (21 zdarzenia)\r\nOstatnio zalogowany: 12:16:10\r\n\r\nError adding entity scene.hue_sypialnia_jasne for domain scene with platform hue\r\nError adding entity scene.hue_salon_przyciemnione for domain scene with platform hue\r\nError adding entity scene.hue_zyrandol_przy_tv_czytanie for domain scene with platform hue\r\nError adding entity scene.hue_zyrandol_przy_tv_jasne for domain scene with platform hue\r\nError adding entity scene.hue_zyrandol_przy_tv_lampka_nocna for domain scene with platform hue\r\nTraceback (most recent call last):\r\n  File \"/usr/src/homeassistant/homeassistant/helpers/entity_platform.py\", line 598, in _async_add_entities\r\n    await coro\r\n  File \"/usr/src/homeassistant/homeassistant/helpers/entity_platform.py\", line 912, in _async_add_entity\r\n    await entity.add_to_platform_finish()\r\n  File \"/usr/src/homeassistant/homeassistant/helpers/entity.py\", line 1362, in add_to_platform_finish\r\n    self.async_write_ha_state()\r\n  File \"/usr/src/homeassistant/homeassistant/helpers/entity.py\", line 1007, in async_write_ha_state\r\n    self._async_write_ha_state()\r\n  File \"/usr/src/homeassistant/homeassistant/helpers/entity.py\", line 1133, in _async_write_ha_state\r\n    state, attr, capabilities, shadowed_attr = self.__async_calculate_state()\r\n                                               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/src/homeassistant/homeassistant/helpers/entity.py\", line 1072, in __async_calculate_state\r\n    if extra_state_attributes := self.extra_state_attributes:\r\n                                 ^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/src/homeassistant/homeassistant/components/hue/scene.py\", line 186, in extra_state_attributes\r\n    \"is_dynamic\": self.is_dynamic,\r\n                  ^^^^^^^^^^^^^^^\r\n  File \"/usr/src/homeassistant/homeassistant/components/hue/scene.py\", line 133, in is_dynamic\r\n    if self.resource.palette.color and len(self.resource.palette.color) > 1:\r\n       ^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\nAttributeError: 'NoneType' object has no attribute 'color'\r\n`\nUnfortunately, this issue still exists (also in 2024.9.1). Same error:\r\n`Logger: homeassistant\r\nQuelle: components/hue/scene.py:133\r\nErstmals aufgetreten: 8. September 2024 um 16:52:18 (98 Vorkommnisse)\r\nZuletzt protokolliert: 10:08:23\r\n\r\nError doing job: Task exception was never retrieved (None)\r\nTraceback (most recent call last):\r\n  File \"/usr/local/lib/python3.12/site-packages/aiohue/v2/controllers/base.py\", line 259, in _handle_event\r\n    callback(evt_type, cur_item)\r\n  File \"/usr/src/homeassistant/homeassistant/components/hue/v2/entity.py\", line 138, in _handle_event\r\n    self.async_write_ha_state()\r\n  File \"/usr/src/homeassistant/homeassistant/helpers/entity.py\", line 1005, in async_write_ha_state\r\n    self._async_write_ha_state()\r\n  File \"/usr/src/homeassistant/homeassistant/helpers/entity.py\", line 1130, in _async_write_ha_state\r\n    self.__async_calculate_state()\r\n  File \"/usr/src/homeassistant/homeassistant/helpers/entity.py\", line 1071, in __async_calculate_state\r\n    if extra_state_attributes := self.extra_state_attributes:\r\n                                 ^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/src/homeassistant/homeassistant/components/hue/scene.py\", line 189, in extra_state_attributes\r\n    \"is_dynamic\": self.is_dynamic,\r\n                  ^^^^^^^^^^^^^^^\r\n  File \"/usr/src/homeassistant/homeassistant/components/hue/scene.py\", line 133, in is_dynamic\r\n    if self.resource.palette.color and len(self.resource.palette.color) > 1:\r\n       ^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\nAttributeError: 'NoneType' object has no attribute 'color'`\nI have been running into this as well but from #115375 I tracked it down to scenes I'd created using the Hue Essentials app. Deleted the scene, created it in the Philips Hue app and the scene now works in HA.\nI'm having this issue now also, and scenes that are newly created using either the official Hue app and/or iConnectHue fail.\r\nInterestingly scenes created earlier in the year (potentially before the October Hue update was automatically applied) work fine...", "created_at": "2024-11-14T15:19:19Z"}
{"repo": "home-assistant/core", "pull_number": 130625, "instance_id": "home-assistant__core-130625", "issue_numbers": ["130166"], "base_commit": "0c44c632d47242cf5c9dacd7cf992e73114384c4", "patch": "diff --git a/homeassistant/components/emulated_kasa/manifest.json b/homeassistant/components/emulated_kasa/manifest.json\nindex d4889c0c5f5bdc..da3912a9d25813 100644\n--- a/homeassistant/components/emulated_kasa/manifest.json\n+++ b/homeassistant/components/emulated_kasa/manifest.json\n@@ -6,5 +6,5 @@\n   \"iot_class\": \"local_push\",\n   \"loggers\": [\"sense_energy\"],\n   \"quality_scale\": \"internal\",\n-  \"requirements\": [\"sense-energy==0.13.3\"]\n+  \"requirements\": [\"sense-energy==0.13.4\"]\n }\ndiff --git a/homeassistant/components/sense/manifest.json b/homeassistant/components/sense/manifest.json\nindex df2317c3a6c9aa..966488b6a487e7 100644\n--- a/homeassistant/components/sense/manifest.json\n+++ b/homeassistant/components/sense/manifest.json\n@@ -20,5 +20,5 @@\n   \"documentation\": \"https://www.home-assistant.io/integrations/sense\",\n   \"iot_class\": \"cloud_polling\",\n   \"loggers\": [\"sense_energy\"],\n-  \"requirements\": [\"sense-energy==0.13.3\"]\n+  \"requirements\": [\"sense-energy==0.13.4\"]\n }\ndiff --git a/requirements_all.txt b/requirements_all.txt\nindex 65ef5f1ebf24cb..ea7bdefce2b9ec 100644\n--- a/requirements_all.txt\n+++ b/requirements_all.txt\n@@ -2632,7 +2632,7 @@ sendgrid==6.8.2\n \n # homeassistant.components.emulated_kasa\n # homeassistant.components.sense\n-sense-energy==0.13.3\n+sense-energy==0.13.4\n \n # homeassistant.components.sensirion_ble\n sensirion-ble==0.1.1\n", "test_patch": "diff --git a/requirements_test_all.txt b/requirements_test_all.txt\nindex b61e65f3c68eb6..cf1e761bfa930f 100644\n--- a/requirements_test_all.txt\n+++ b/requirements_test_all.txt\n@@ -2099,7 +2099,7 @@ securetar==2024.2.1\n \n # homeassistant.components.emulated_kasa\n # homeassistant.components.sense\n-sense-energy==0.13.3\n+sense-energy==0.13.4\n \n # homeassistant.components.sensirion_ble\n sensirion-ble==0.1.1\n", "problem_statement": "Unable to add Sense Integration\n### The problem\r\n\r\nWhen trying to add Sense integration I get an error when I submit my 2fa code.  Unexpected error.\r\n\r\n### What version of Home Assistant Core has the issue?\r\n\r\ncore-2024.11.0\r\n\r\n### What was the last working version of Home Assistant Core?\r\n\r\n_No response_\r\n\r\n### What type of installation are you running?\r\n\r\nHome Assistant OS\r\n\r\n### Integration causing the issue\r\n\r\nSense\r\n\r\n### Link to integration documentation on our website\r\n\r\nhttps://www.home-assistant.io/integrations/sense\r\n\r\n### Diagnostics information\r\n\r\n_No response_\r\n\r\n### Example YAML snippet\r\n\r\n_No response_\r\n\r\n### Anything in the logs that might be useful for us?\r\n\r\n_No response_\r\n\r\n### Additional information\r\n\r\n_No response_\n", "hints_text": "\nHey there @kbickar, mind taking a look at this issue as it has been labeled with an integration (`sense`) you are listed as a [code owner](https://github.com/home-assistant/core/blob/dev/CODEOWNERS#L1299) for? Thanks!\n\n<details>\n<summary>Code owner commands</summary>\n\n\nCode owners of `sense` can trigger bot actions by commenting:\n\n- `@home-assistant close` Closes the issue.\n- `@home-assistant rename Awesome new title` Renames the issue.\n- `@home-assistant reopen` Reopen the issue.\n- `@home-assistant unassign sense` Removes the current integration label and assignees on the issue, add the integration domain after the command.\n- `@home-assistant add-label needs-more-information` Add a label (needs-more-information, problem in dependency, problem in custom component) to the issue.\n- `@home-assistant remove-label needs-more-information` Remove a label (needs-more-information, problem in dependency, problem in custom component) on the issue.\n\n</details>\n\n\n<sub><sup>(message by CodeOwnersMention)</sup></sub>\n\n---\n\n[sense documentation](https://www.home-assistant.io/integrations/sense)\n[sense source](https://github.com/home-assistant/core/tree/dev/homeassistant/components/sense)\n<sub><sup>(message by IssueLinks)</sup></sub>\nCan you provide any logs?  Try restarting HA and logging in again \nI'm sorry I'm very new to home-assistant and I'm not sure where to pull the\r\nlogs from.  I have restarted HA multiple times because when the\r\nintegration fails it just keeps asking for a verification code.  However\r\nafter restarting HA I can enter username and password before it asks for\r\nthe verification code again.\r\n\r\nOn Fri, Nov 8, 2024 at 2:52\u202fPM Keilin Bickar ***@***.***>\r\nwrote:\r\n\r\n> Can you provide any logs? Try restarting HA and logging in again\r\n>\r\n> \u2014\r\n> Reply to this email directly, view it on GitHub\r\n> <https://github.com/home-assistant/core/issues/130166#issuecomment-2465641280>,\r\n> or unsubscribe\r\n> <https://github.com/notifications/unsubscribe-auth/BMXZNRJMVOKWM6BNUCNHEHLZ7UI7ZAVCNFSM6AAAAABROFLQYGVHI2DSMVQWIX3LMV43OSLTON2WKQ3PNVWWK3TUHMZDINRVGY2DCMRYGA>\r\n> .\r\n> You are receiving this because you authored the thread.Message ID:\r\n> ***@***.***>\r\n>\r\n\nCheck in Settings > System > Logs\n2024-11-06 20:18:44.434 ERROR (MainThread)\r\n[homeassistant.components.sense.config_flow] Unexpected exception\r\nTraceback (most recent call last):\r\n  File\r\n\"/usr/src/homeassistant/homeassistant/components/sense/config_flow.py\",\r\nline 108, in async_step_validation\r\n    await self._gateway.validate_mfa(user_input[CONF_CODE])\r\n  File\r\n\"/usr/local/lib/python3.12/site-packages/sense_energy/asyncsenseable.py\",\r\nline 120, in validate_mfa\r\n    await self.fetch_discovered_devices()\r\n          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\nAttributeError: 'ASyncSenseable' object has no attribute\r\n'fetch_discovered_devices'. Did you mean: 'get_discovered_device_data'?\r\n\r\nOn Fri, Nov 8, 2024 at 3:17\u202fPM Keilin Bickar ***@***.***>\r\nwrote:\r\n\r\n> Check in Settings > System > Logs\r\n>\r\n> \u2014\r\n> Reply to this email directly, view it on GitHub\r\n> <https://github.com/home-assistant/core/issues/130166#issuecomment-2465681386>,\r\n> or unsubscribe\r\n> <https://github.com/notifications/unsubscribe-auth/BMXZNRLMCPQGLX4C66ZMQQLZ7UL6RAVCNFSM6AAAAABROFLQYGVHI2DSMVQWIX3LMV43OSLTON2WKQ3PNVWWK3TUHMZDINRVGY4DCMZYGY>\r\n> .\r\n> You are receiving this because you authored the thread.Message ID:\r\n> ***@***.***>\r\n>\r\n\nSeems to be the same issue seen in #130008 \nI juste got the core-2024.11.1 update. It didn't fix anything.\r\n\r\nOn Fri, Nov 8, 2024, 5:09\u202fPM Keilin Bickar ***@***.***> wrote:\r\n\r\n> Seems to be the same issue seen in #130008\r\n> <https://github.com/home-assistant/core/issues/130008>\r\n>\r\n> \u2014\r\n> Reply to this email directly, view it on GitHub\r\n> <https://github.com/home-assistant/core/issues/130166#issuecomment-2465825543>,\r\n> or unsubscribe\r\n> <https://github.com/notifications/unsubscribe-auth/BMXZNRJT6VN5NIMSW7SHK2LZ7UY7ZAVCNFSM6AAAAABROFLQYGVHI2DSMVQWIX3LMV43OSLTON2WKQ3PNVWWK3TUHMZDINRVHAZDKNJUGM>\r\n> .\r\n> You are receiving this because you authored the thread.Message ID:\r\n> ***@***.***>\r\n>\r\n\n```\r\nLogger: homeassistant.components.sense.config_flow\r\nSource: components/sense/config_flow.py:108\r\nintegration: Sense (documentation, issues)\r\nFirst occurred: 12:06:10 AM (1 occurrences)\r\nLast logged: 12:06:10 AM\r\n\r\nUnexpected exception\r\nTraceback (most recent call last):\r\n  File \"/usr/src/homeassistant/homeassistant/components/sense/config_flow.py\", line 108, in async_step_validation\r\n    await self._gateway.validate_mfa(user_input[CONF_CODE])\r\n  File \"/usr/local/lib/python3.12/site-packages/sense_energy/asyncsenseable.py\", line 120, in validate_mfa\r\n    await self.fetch_discovered_devices()\r\n          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\nAttributeError: 'ASyncSenseable' object has no attribute 'fetch_discovered_devices'. Did you mean: 'get_discovered_device_data'?\r\n```\r\n\r\nGot this tonight.  Sense integration was already added before I enabled MFA.  System alerted me that I needed to reconfigure, but it would not accept the MFA code.  I tried re-adding the integration, and also tried booting into safe mode.  No go.", "created_at": "2024-11-14T15:03:35Z"}
{"repo": "home-assistant/core", "pull_number": 130588, "instance_id": "home-assistant__core-130588", "issue_numbers": ["130591"], "base_commit": "8fc470b943cc8175d1479fae11930c2172a1e68d", "patch": "diff --git a/homeassistant/components/backup/websocket.py b/homeassistant/components/backup/websocket.py\nindex e2164a2dbca32a..984e7a12b0dd48 100644\n--- a/homeassistant/components/backup/websocket.py\n+++ b/homeassistant/components/backup/websocket.py\n@@ -22,7 +22,6 @@ def async_register_websocket_handlers(hass: HomeAssistant, with_hassio: bool) ->\n     if with_hassio:\n         websocket_api.async_register_command(hass, handle_backup_end)\n         websocket_api.async_register_command(hass, handle_backup_start)\n-        websocket_api.async_register_command(hass, handle_backup_upload)\n         return\n \n     websocket_api.async_register_command(hass, handle_details)\n@@ -190,34 +189,6 @@ async def handle_backup_end(\n     connection.send_result(msg[\"id\"])\n \n \n-@websocket_api.ws_require_user(only_supervisor=True)\n-@websocket_api.websocket_command(\n-    {\n-        vol.Required(\"type\"): \"backup/upload\",\n-        vol.Required(\"data\"): {\n-            vol.Required(\"slug\"): str,\n-        },\n-    }\n-)\n-@websocket_api.async_response\n-async def handle_backup_upload(\n-    hass: HomeAssistant,\n-    connection: websocket_api.ActiveConnection,\n-    msg: dict[str, Any],\n-) -> None:\n-    \"\"\"Backup upload.\"\"\"\n-    LOGGER.debug(\"Backup upload notification\")\n-    data = msg[\"data\"]\n-\n-    try:\n-        await hass.data[DATA_MANAGER].async_upload_backup(slug=data[\"slug\"])\n-    except Exception as err:  # noqa: BLE001\n-        connection.send_error(msg[\"id\"], \"backup_upload_failed\", str(err))\n-        return\n-\n-    connection.send_result(msg[\"id\"])\n-\n-\n @websocket_api.require_admin\n @websocket_api.websocket_command({vol.Required(\"type\"): \"backup/agents/info\"})\n @websocket_api.async_response\n", "test_patch": "diff --git a/tests/components/backup/snapshots/test_websocket.ambr b/tests/components/backup/snapshots/test_websocket.ambr\nindex 2adaafc5060590..9fefef2e018956 100644\n--- a/tests/components/backup/snapshots/test_websocket.ambr\n+++ b/tests/components/backup/snapshots/test_websocket.ambr\n@@ -251,80 +251,6 @@\n     'type': 'result',\n   })\n # ---\n-# name: test_backup_upload[with_hassio-hass_access_token]\n-  dict({\n-    'error': dict({\n-      'code': 'only_supervisor',\n-      'message': 'Only allowed as Supervisor',\n-    }),\n-    'id': 1,\n-    'success': False,\n-    'type': 'result',\n-  })\n-# ---\n-# name: test_backup_upload[with_hassio-hass_supervisor_access_token]\n-  dict({\n-    'id': 1,\n-    'result': None,\n-    'success': True,\n-    'type': 'result',\n-  })\n-# ---\n-# name: test_backup_upload[without_hassio-hass_access_token]\n-  dict({\n-    'error': dict({\n-      'code': 'unknown_command',\n-      'message': 'Unknown command.',\n-    }),\n-    'id': 1,\n-    'success': False,\n-    'type': 'result',\n-  })\n-# ---\n-# name: test_backup_upload[without_hassio-hass_supervisor_access_token]\n-  dict({\n-    'error': dict({\n-      'code': 'unknown_command',\n-      'message': 'Unknown command.',\n-    }),\n-    'id': 1,\n-    'success': False,\n-    'type': 'result',\n-  })\n-# ---\n-# name: test_backup_upload_exception[exception0]\n-  dict({\n-    'error': dict({\n-      'code': 'backup_upload_failed',\n-      'message': '',\n-    }),\n-    'id': 1,\n-    'success': False,\n-    'type': 'result',\n-  })\n-# ---\n-# name: test_backup_upload_exception[exception1]\n-  dict({\n-    'error': dict({\n-      'code': 'backup_upload_failed',\n-      'message': 'Boom',\n-    }),\n-    'id': 1,\n-    'success': False,\n-    'type': 'result',\n-  })\n-# ---\n-# name: test_backup_upload_exception[exception2]\n-  dict({\n-    'error': dict({\n-      'code': 'backup_upload_failed',\n-      'message': 'Boom',\n-    }),\n-    'id': 1,\n-    'success': False,\n-    'type': 'result',\n-  })\n-# ---\n # name: test_details[with_hassio-with_backup_content]\n   dict({\n     'error': dict({\ndiff --git a/tests/components/backup/test_websocket.py b/tests/components/backup/test_websocket.py\nindex bc8b126aa27970..958191a7eb63e2 100644\n--- a/tests/components/backup/test_websocket.py\n+++ b/tests/components/backup/test_websocket.py\n@@ -311,46 +311,6 @@ async def test_backup_start(\n         assert await client.receive_json() == snapshot\n \n \n-@pytest.mark.parametrize(\n-    \"access_token_fixture_name\",\n-    [\"hass_access_token\", \"hass_supervisor_access_token\"],\n-)\n-@pytest.mark.parametrize(\n-    (\"with_hassio\"),\n-    [\n-        pytest.param(True, id=\"with_hassio\"),\n-        pytest.param(False, id=\"without_hassio\"),\n-    ],\n-)\n-async def test_backup_upload(\n-    hass: HomeAssistant,\n-    hass_ws_client: WebSocketGenerator,\n-    snapshot: SnapshotAssertion,\n-    sync_access_token_proxy: str,\n-    *,\n-    access_token_fixture_name: str,\n-    with_hassio: bool,\n-) -> None:\n-    \"\"\"Test backup upload from a WS command.\"\"\"\n-    await setup_backup_integration(hass, with_hassio=with_hassio)\n-\n-    client = await hass_ws_client(hass, sync_access_token_proxy)\n-    await hass.async_block_till_done()\n-\n-    with patch(\n-        \"homeassistant.components.backup.manager.BackupManager.async_upload_backup\",\n-    ):\n-        await client.send_json_auto_id(\n-            {\n-                \"type\": \"backup/upload\",\n-                \"data\": {\n-                    \"slug\": \"abc123\",\n-                },\n-            }\n-        )\n-        assert await client.receive_json() == snapshot\n-\n-\n @pytest.mark.parametrize(\n     \"exception\",\n     [\n@@ -380,42 +340,6 @@ async def test_backup_end_exception(\n         assert await client.receive_json() == snapshot\n \n \n-@pytest.mark.parametrize(\n-    \"exception\",\n-    [\n-        TimeoutError(),\n-        HomeAssistantError(\"Boom\"),\n-        Exception(\"Boom\"),\n-    ],\n-)\n-async def test_backup_upload_exception(\n-    hass: HomeAssistant,\n-    hass_ws_client: WebSocketGenerator,\n-    snapshot: SnapshotAssertion,\n-    hass_supervisor_access_token: str,\n-    exception: Exception,\n-) -> None:\n-    \"\"\"Test exception handling while running backup upload from a WS command.\"\"\"\n-    await setup_backup_integration(hass, with_hassio=True)\n-\n-    client = await hass_ws_client(hass, hass_supervisor_access_token)\n-    await hass.async_block_till_done()\n-\n-    with patch(\n-        \"homeassistant.components.backup.manager.BackupManager.async_upload_backup\",\n-        side_effect=exception,\n-    ):\n-        await client.send_json_auto_id(\n-            {\n-                \"type\": \"backup/upload\",\n-                \"data\": {\n-                    \"slug\": \"abc123\",\n-                },\n-            }\n-        )\n-        assert await client.receive_json() == snapshot\n-\n-\n @pytest.mark.parametrize(\n     \"exception\",\n     [\ndiff --git a/tests/components/kitchen_sink/test_backup.py b/tests/components/kitchen_sink/test_backup.py\nindex 1866a1e2e1900e..f60fdbba0ca5e6 100644\n--- a/tests/components/kitchen_sink/test_backup.py\n+++ b/tests/components/kitchen_sink/test_backup.py\n@@ -104,6 +104,7 @@ async def test_agents_download(\n     assert f\"Downloading backup {backup_id} to {path}\" in caplog.text\n \n \n+@pytest.mark.xfail(reason=\"Disabled until /api/backup/upload accepts a list of agents\")\n async def test_agents_upload(\n     hass: HomeAssistant,\n     hass_ws_client: WebSocketGenerator,\n", "problem_statement": "Rename backup/upload websocket type to backup/agents/upload\n<!--\n  You are amazing! Thanks for contributing to our project!\n  Please, DO NOT DELETE ANY TEXT from this template! (unless instructed).\n-->\n## Breaking change\n<!--\n  If your PR contains a breaking change for existing users, it is important\n  to tell them what breaks, how to make it work again and why we did this.\n  This piece of text is published with the release notes, so it helps if you\n  write it towards our users, not us.\n  Note: Remove this section if this PR is NOT a breaking change.\n-->\n\n\n## Proposed change\n<!--\n  Describe the big picture of your changes here to communicate to the\n  maintainers why we should accept this pull request. If it fixes a bug\n  or resolves a feature request, be sure to link to that issue in the\n  additional information section.\n-->\n- Rename this websocket command type to make it clearer what it is and in line with the other agent commands.\n\n## Type of change\n<!--\n  What type of change does your PR introduce to Home Assistant?\n  NOTE: Please, check only 1! box!\n  If your PR requires multiple boxes to be checked, you'll most likely need to\n  split it into multiple PRs. This makes things easier and faster to code review.\n-->\n\n- [ ] Dependency upgrade\n- [ ] Bugfix (non-breaking change which fixes an issue)\n- [ ] New integration (thank you!)\n- [ ] New feature (which adds functionality to an existing integration)\n- [ ] Deprecation (breaking change to happen in the future)\n- [ ] Breaking change (fix/feature causing existing functionality to break)\n- [x] Code quality improvements to existing code or addition of tests\n\n## Additional information\n<!--\n  Details are important, and help maintainers processing your PR.\n  Please be sure to fill out additional details, if applicable.\n-->\n\n- This PR fixes or closes issue: fixes #\n- This PR is related to issue: \n- Link to documentation pull request: \n\n## Checklist\n<!--\n  Put an `x` in the boxes that apply. You can also fill these out after\n  creating the PR. If you're unsure about any of them, don't hesitate to ask.\n  We're here to help! This is simply a reminder of what we are going to look\n  for before merging your code.\n-->\n\n- [ ] The code change is tested and works locally.\n- [x] Local tests pass. **Your PR cannot be merged unless tests pass**\n- [x] There is no commented out code in this PR.\n- [x] I have followed the [development checklist][dev-checklist]\n- [x] I have followed the [perfect PR recommendations][perfect-pr]\n- [x] The code has been formatted using Ruff (`ruff format homeassistant tests`)\n- [ ] Tests have been added to verify that the new code works.\n\nIf user exposed functionality or configuration variables are added/changed:\n\n- [ ] Documentation added/updated for [www.home-assistant.io][docs-repository]\n\nIf the code communicates with devices, web services, or third-party tools:\n\n- [ ] The [manifest file][manifest-docs] has all fields filled out correctly.  \n      Updated and included derived files by running: `python3 -m script.hassfest`.\n- [ ] New or updated dependencies have been added to `requirements_all.txt`.  \n      Updated by running `python3 -m script.gen_requirements_all`.\n- [ ] For the updated dependencies - a link to the changelog, or at minimum a diff between library versions is added to the PR description.\n\n<!--\n  This project is very active and we have a high turnover of pull requests.\n\n  Unfortunately, the number of incoming pull requests is higher than what our\n  reviewers can review and merge so there is a long backlog of pull requests\n  waiting for review. You can help here!\n  \n  By reviewing another pull request, you will help raise the code quality of\n  that pull request and the final review will be faster. This way the general\n  pace of pull request reviews will go up and your wait time will go down.\n  \n  When picking a pull request to review, try to choose one that hasn't yet\n  been reviewed.\n\n  Thanks for helping out!\n-->\n\nTo help with the load of incoming pull requests:\n\n- [ ] I have reviewed two other [open pull requests][prs] in this repository.\n\n[prs]: https://github.com/home-assistant/core/pulls?q=is%3Aopen+is%3Apr+-author%3A%40me+-draft%3Atrue+-label%3Awaiting-for-upstream+sort%3Acreated-desc+review%3Anone+-status%3Afailure\n\n<!--\n  Thank you for contributing <3\n\n  Below, some useful links you could explore:\n-->\n[dev-checklist]: https://developers.home-assistant.io/docs/development_checklist/\n[manifest-docs]: https://developers.home-assistant.io/docs/creating_integration_manifest/\n[quality-scale]: https://developers.home-assistant.io/docs/integration_quality_scale_index/\n[docs-repository]: https://github.com/home-assistant/home-assistant.io\n[perfect-pr]: https://developers.home-assistant.io/docs/review-process/#creating-the-perfect-pr\n\n", "hints_text": "", "created_at": "2024-11-14T07:38:30Z"}
{"repo": "home-assistant/core", "pull_number": 130576, "instance_id": "home-assistant__core-130576", "issue_numbers": ["130496"], "base_commit": "51c6ee97b19706eb56bb440a3b5155e3b34f3afd", "patch": "diff --git a/homeassistant/components/tesla_fleet/oauth.py b/homeassistant/components/tesla_fleet/oauth.py\nindex 00976abf56fd6b..8b43460436b275 100644\n--- a/homeassistant/components/tesla_fleet/oauth.py\n+++ b/homeassistant/components/tesla_fleet/oauth.py\n@@ -49,6 +49,7 @@ def name(self) -> str:\n     def extra_authorize_data(self) -> dict[str, Any]:\n         \"\"\"Extra data that needs to be appended to the authorize url.\"\"\"\n         return {\n+            \"prompt\": \"login\",\n             \"scope\": \" \".join(SCOPES),\n             \"code_challenge\": self.code_challenge,  # PKCE\n         }\n@@ -83,4 +84,4 @@ def __init__(\n     @property\n     def extra_authorize_data(self) -> dict[str, Any]:\n         \"\"\"Extra data that needs to be appended to the authorize url.\"\"\"\n-        return {\"scope\": \" \".join(SCOPES)}\n+        return {\"prompt\": \"login\", \"scope\": \" \".join(SCOPES)}\n", "test_patch": "", "problem_statement": "Tesla Fleet Integration - Not able to add a 2nd verhicle\n### The problem\n\nAfter succesfully adding a 1st Tesla, I wanted to add a second verhicle by using the \"Add Entry\" button. This did not allow me to define the second Tesla.\r\nDetails:\r\nuser: push button \"Add Entry\" \r\nha: \"Link account to Home Assistant?\"\r\nuser: push button \"Link account\"\r\nha: \"Tesla Fleet - Configuration updated for profile.\"\n\n### What version of Home Assistant Core has the issue?\n\ncore-2024.11.1\n\n### What was the last working version of Home Assistant Core?\n\n_No response_\n\n### What type of installation are you running?\n\nHome Assistant OS\n\n### Integration causing the issue\n\nTesla Fleet\n\n### Link to integration documentation on our website\n\nhttps://www.home-assistant.io/integrations/tesla_fleet/\n\n### Diagnostics information\n\n_No response_\n\n### Example YAML snippet\n\n_No response_\n\n### Anything in the logs that might be useful for us?\n\n_No response_\n\n### Additional information\n\n_No response_\n", "hints_text": "\nHey there @bre77, mind taking a look at this issue as it has been labeled with an integration (`tesla_fleet`) you are listed as a [code owner](https://github.com/home-assistant/core/blob/dev/CODEOWNERS#L1490) for? Thanks!\n\n<details>\n<summary>Code owner commands</summary>\n\n\nCode owners of `tesla_fleet` can trigger bot actions by commenting:\n\n- `@home-assistant close` Closes the issue.\n- `@home-assistant rename Awesome new title` Renames the issue.\n- `@home-assistant reopen` Reopen the issue.\n- `@home-assistant unassign tesla_fleet` Removes the current integration label and assignees on the issue, add the integration domain after the command.\n- `@home-assistant add-label needs-more-information` Add a label (needs-more-information, problem in dependency, problem in custom component) to the issue.\n- `@home-assistant remove-label needs-more-information` Remove a label (needs-more-information, problem in dependency, problem in custom component) on the issue.\n\n</details>\n\n\n<sub><sup>(message by CodeOwnersMention)</sup></sub>\n\n---\n\n[tesla_fleet documentation](https://www.home-assistant.io/integrations/tesla_fleet)\n[tesla_fleet source](https://github.com/home-assistant/core/tree/dev/homeassistant/components/tesla_fleet)\n<sub><sup>(message by IssueLinks)</sup></sub>\nIf you have two vehicles in your account, both should show up. If you recently got a new vehicle, you just need to reload the integration.\n\nThe add config entry adds an account, not a specific vehicle or energy site\n\nIf you do want to add two accounts make sure you go to tesla.com and log out of the first one so that you can get promoted for the second (otherwise it automatically logs you in).", "created_at": "2024-11-13T23:16:05Z"}
{"repo": "home-assistant/core", "pull_number": 130574, "instance_id": "home-assistant__core-130574", "issue_numbers": ["123791"], "base_commit": "51c6ee97b19706eb56bb440a3b5155e3b34f3afd", "patch": "diff --git a/homeassistant/components/roborock/coordinator.py b/homeassistant/components/roborock/coordinator.py\nindex 20bc50f9855cde..fe592074f710a7 100644\n--- a/homeassistant/components/roborock/coordinator.py\n+++ b/homeassistant/components/roborock/coordinator.py\n@@ -2,7 +2,6 @@\n \n from __future__ import annotations\n \n-import asyncio\n from datetime import timedelta\n import logging\n \n@@ -107,8 +106,12 @@ async def _update_device_prop(self) -> None:\n     async def _async_update_data(self) -> DeviceProp:\n         \"\"\"Update data via library.\"\"\"\n         try:\n-            await asyncio.gather(*(self._update_device_prop(), self.get_rooms()))\n+            # Update device props and standard api information\n+            await self._update_device_prop()\n+            # Set the new map id from the updated device props\n             self._set_current_map()\n+            # Get the rooms for that map id.\n+            await self.get_rooms()\n         except RoborockException as ex:\n             raise UpdateFailed(ex) from ex\n         return self.roborock_device_info.props\ndiff --git a/homeassistant/components/roborock/select.py b/homeassistant/components/roborock/select.py\nindex 3dfe0e72a7b365..73cb95d2d7c323 100644\n--- a/homeassistant/components/roborock/select.py\n+++ b/homeassistant/components/roborock/select.py\n@@ -135,6 +135,9 @@ async def async_select_option(self, option: str) -> None:\n                     RoborockCommand.LOAD_MULTI_MAP,\n                     [map_id],\n                 )\n+                # Update the current map id manually so that nothing gets broken\n+                # if another service hits the api.\n+                self.coordinator.current_map = map_id\n                 # We need to wait after updating the map\n                 # so that other commands will be executed correctly.\n                 await asyncio.sleep(MAP_SLEEP)\n@@ -148,6 +151,9 @@ def options(self) -> list[str]:\n     @property\n     def current_option(self) -> str | None:\n         \"\"\"Get the current status of the select entity from device_status.\"\"\"\n-        if (current_map := self.coordinator.current_map) is not None:\n+        if (\n+            (current_map := self.coordinator.current_map) is not None\n+            and current_map in self.coordinator.maps\n+        ):  # 63 means it is searching for a map.\n             return self.coordinator.maps[current_map].name\n         return None\n", "test_patch": "", "problem_statement": "roborock: get_maps return wrong room numbers\n### The problem\n\nThe action/service call return for all maps the same room numbers\r\n\r\n```\r\naction: roborock.get_maps\r\ndata: {}\r\ntarget:\r\n  entity_id: vacuum.roborock_s7_maxv\r\n```\r\n\r\nReturns\r\n\r\n```\r\nvacuum.roborock_s7_maxv:\r\n  maps:\r\n    - flag: 1\r\n      name: \"Erste Etage \"\r\n      rooms:\r\n        \"16\": Schlafzimmer\r\n        \"17\": K\u00fcche\r\n        \"18\": Badezimmer\r\n        \"19\": Wohnzimmer\r\n    - flag: 2\r\n      name: \"Erdgeschoss \"\r\n      rooms:\r\n        \"16\": Schlafzimmer\r\n        \"17\": K\u00fcche\r\n        \"18\": Badezimmer\r\n        \"19\": Wohnzimmer\r\n```\r\n\r\nThe rooms are correct for \"Erdgeschoss\" but not for \"Erste Etage\".\r\n\n\n### What version of Home Assistant Core has the issue?\n\ncore-2024.8.1\n\n### What was the last working version of Home Assistant Core?\n\n_No response_\n\n### What type of installation are you running?\n\nHome Assistant OS\n\n### Integration causing the issue\n\nroborock\n\n### Link to integration documentation on our website\n\nhttps://www.home-assistant.io/integrations/roborock/\n\n### Diagnostics information\n\n_No response_\n\n### Example YAML snippet\n\n_No response_\n\n### Anything in the logs that might be useful for us?\n\n_No response_\n\n### Additional information\n\n_No response_\n", "hints_text": "\nHey there @lash-l, mind taking a look at this issue as it has been labeled with an integration (`roborock`) you are listed as a [code owner](https://github.com/home-assistant/core/blob/dev/CODEOWNERS#L1210) for? Thanks!\n\n<details>\n<summary>Code owner commands</summary>\n\n\nCode owners of `roborock` can trigger bot actions by commenting:\n\n- `@home-assistant close` Closes the issue.\n- `@home-assistant rename Awesome new title` Renames the issue.\n- `@home-assistant reopen` Reopen the issue.\n- `@home-assistant unassign roborock` Removes the current integration label and assignees on the issue, add the integration domain after the command.\n- `@home-assistant add-label needs-more-information` Add a label (needs-more-information, problem in dependency, problem in custom component) to the issue.\n- `@home-assistant remove-label needs-more-information` Remove a label (needs-more-information, problem in dependency, problem in custom component) on the issue.\n\n</details>\n\n\n<sub><sup>(message by CodeOwnersMention)</sup></sub>\n\n---\n\n[roborock documentation](https://www.home-assistant.io/integrations/roborock)\n[roborock source](https://github.com/home-assistant/core/tree/dev/homeassistant/components/roborock)\n<sub><sup>(message by IssueLinks)</sup></sub>\nHi - I believe this issue comes from me updating the coordinator by updating device props and rooms at the same time. Theoretically, room update should only happen after device prop update as it is critical that the map is accurate. \n\nThat being said room updating is getting a rather large refactor elsewhere but hopefully this will be better for you in the future. In the meantime you could get the results you want by changing the map in the app, and reloading the integration\nSame effect here. Unfortunately the work-around as suggested by @Lash-L did not work:\r\n\r\n>  In the meantime you could get the results you want by changing the map in the app, and reloading the integration\r\n\r\nI tried to find the data in the debug logging, but no luck. Any other suggestions?\nI tried the workaround suggested by @Lash-L and it did change the output of  roborock.get_maps to:\r\n\r\n`vacuum.roborock_s8_pro_ultra:\r\n  maps:\r\n    - flag: 0\r\n      name: Beneden\r\n      rooms:\r\n        \"16\": Dining room\r\n        \"18\": Living room\r\n        \"19\": Wc\r\n        \"20\": Corridor\r\n        \"21\": Berging\r\n    - flag: 1\r\n      name: Boven\r\n      rooms:\r\n        \"16\": Master bedroom\r\n        \"17\": Bathroom\r\n        \"18\": Guest bedroom\r\n        \"19\": Study\r\n        \"20\": Hall\r\n    - flag: 2\r\n      name: Terras\r\n      rooms: {}\r\n    - flag: 3\r\n      name: Kelder\r\n      rooms: {}\r\n`\r\n\r\nHowever I've still got some overlapping numbers. I assume each room needs a unique 2 digit number? Since the action \"app_segment_clean\" with command \"vacuum.send_command\" does not accept a flag as an argument/parameter?\nSame issue here, I have overlapping room numbers as I have several floors. Happy to help provide any information \ud83d\ude47 \nI do not have the action **roborock.get_maps** at all. Has that been removed?\n> I do not have the action **roborock.get_maps** at all. Has that been removed?\r\n\r\nCame here because I also had an issue where the map suddenly disappeared for all roborock entities after a recent update. I reload the roborock integration and the maps are back <3.\nI solved it\r\n\r\nYou need to do as indicated here, reload the integration after changing the map selection (you can do this from the app or directly from homeassistant).\r\n\r\nIt doesn't matter if the room codes repeat between different maps, it will clean based on the room selection and appears to work fine.\r\n\r\nUnique bug that occurs if there is only one room in the selected map, the command fails to obtain the code as shown below.\r\n \r\n```\r\naction: roborock.get_maps\r\ntarget:\r\n  entity_id: vacuum.robot_xxxx\r\n``` \r\n\r\n```\r\nvacuum.robot_xxxxxxx:\r\n  maps:\r\n    - flag: 0\r\n      name: Casa\r\n      rooms:\r\n        \"16\": Corridoio\r\n        \"17\": Cucina\r\n        \"18\": Ingresso\r\n        \"19\": Sala\r\n        \"20\": Bambini\r\n        \"21\": Camera\r\n        \"22\": Bagno\r\n    - flag: 1\r\n      name: Veranda\r\n      rooms: {}   <------ no code if only one room - > 1 OK!\r\n``` \r\n\r\nI managed to create from the front end all the controls necessary for changing the map and for cleaning the different floors, I also managed to create a \"reservation\" so that once the alarm is inserted the cleaning can start for the rooms only \"book\".\r\n\r\nIt was possible to insert different images into the masks using the \"visibility\" function\r\n\r\n...I'm still working on it but the result looks good\r\n\r\n![image](https://github.com/user-attachments/assets/b907ec38-cb20-4977-af61-567209c255f1)\r\n", "created_at": "2024-11-13T22:58:07Z"}
{"repo": "home-assistant/core", "pull_number": 130563, "instance_id": "home-assistant__core-130563", "issue_numbers": ["130259"], "base_commit": "c35ef6bda34aa8c01cae6ea6863cae24a5009fc8", "patch": "diff --git a/homeassistant/components/zha/manifest.json b/homeassistant/components/zha/manifest.json\nindex 96c9bc030f6799..8736dc89549460 100644\n--- a/homeassistant/components/zha/manifest.json\n+++ b/homeassistant/components/zha/manifest.json\n@@ -21,7 +21,7 @@\n     \"zha\",\n     \"universal_silabs_flasher\"\n   ],\n-  \"requirements\": [\"universal-silabs-flasher==0.0.24\", \"zha==0.0.37\"],\n+  \"requirements\": [\"universal-silabs-flasher==0.0.25\", \"zha==0.0.39\"],\n   \"usb\": [\n     {\n       \"vid\": \"10C4\",\ndiff --git a/homeassistant/components/zha/update.py b/homeassistant/components/zha/update.py\nindex 151d1c495e8731..18b8ed1cca5ff8 100644\n--- a/homeassistant/components/zha/update.py\n+++ b/homeassistant/components/zha/update.py\n@@ -4,7 +4,6 @@\n \n import functools\n import logging\n-import math\n from typing import Any\n \n from zha.exceptions import ZHAException\n@@ -97,6 +96,7 @@ class ZHAFirmwareUpdateEntity(\n         | UpdateEntityFeature.SPECIFIC_VERSION\n         | UpdateEntityFeature.RELEASE_NOTES\n     )\n+    _attr_display_precision = 2  # 40 byte chunks with ~200KB files increments by 0.02%\n \n     def __init__(self, entity_data: EntityData, **kwargs: Any) -> None:\n         \"\"\"Initialize the ZHA siren.\"\"\"\n@@ -115,20 +115,19 @@ def installed_version(self) -> str | None:\n     def in_progress(self) -> bool | int | None:\n         \"\"\"Update installation progress.\n \n-        Needs UpdateEntityFeature.PROGRESS flag to be set for it to be used.\n-\n-        Can either return a boolean (True if in progress, False if not)\n-        or an integer to indicate the progress in from 0 to 100%.\n+        Should return a boolean (True if in progress, False if not).\n         \"\"\"\n-        if not self.entity_data.entity.in_progress:\n-            return self.entity_data.entity.in_progress\n+        return self.entity_data.entity.in_progress\n \n-        # Stay in an indeterminate state until we actually send something\n-        if self.entity_data.entity.progress == 0:\n-            return True\n+    @property\n+    def update_percentage(self) -> int | float | None:\n+        \"\"\"Update installation progress.\n \n-        # Rescale 0-100% to 2-100% to avoid 0 and 1 colliding with None, False, and True\n-        return int(math.ceil(2 + 98 * self.entity_data.entity.progress / 100))\n+        Needs UpdateEntityFeature.PROGRESS flag to be set for it to be used.\n+\n+        Can either return a number to indicate the progress from 0 to 100% or None.\n+        \"\"\"\n+        return self.entity_data.entity.update_percentage\n \n     @property\n     def latest_version(self) -> str | None:\ndiff --git a/requirements_all.txt b/requirements_all.txt\nindex 67c7c99114698e..54825d09131596 100644\n--- a/requirements_all.txt\n+++ b/requirements_all.txt\n@@ -2906,7 +2906,7 @@ unifi_ap==0.0.1\n unifiled==0.11\n \n # homeassistant.components.zha\n-universal-silabs-flasher==0.0.24\n+universal-silabs-flasher==0.0.25\n \n # homeassistant.components.upb\n upb-lib==0.5.8\n@@ -3075,7 +3075,7 @@ zeroconf==0.136.0\n zeversolar==0.3.2\n \n # homeassistant.components.zha\n-zha==0.0.37\n+zha==0.0.39\n \n # homeassistant.components.zhong_hong\n zhong-hong-hvac==1.0.13\n", "test_patch": "diff --git a/requirements_test_all.txt b/requirements_test_all.txt\nindex 048f0ac7d76016..30407a0ec7bf19 100644\n--- a/requirements_test_all.txt\n+++ b/requirements_test_all.txt\n@@ -2313,7 +2313,7 @@ ultraheat-api==0.5.7\n unifi-discovery==1.2.0\n \n # homeassistant.components.zha\n-universal-silabs-flasher==0.0.24\n+universal-silabs-flasher==0.0.25\n \n # homeassistant.components.upb\n upb-lib==0.5.8\n@@ -2458,7 +2458,7 @@ zeroconf==0.136.0\n zeversolar==0.3.2\n \n # homeassistant.components.zha\n-zha==0.0.37\n+zha==0.0.39\n \n # homeassistant.components.zwave_js\n zwave-js-server-python==0.59.0\ndiff --git a/tests/components/zha/test_update.py b/tests/components/zha/test_update.py\nindex 4b6dff4fc6b839..cd48ae62ff3bce 100644\n--- a/tests/components/zha/test_update.py\n+++ b/tests/components/zha/test_update.py\n@@ -394,7 +394,7 @@ async def endpoint_reply(cluster, sequence, data, **kwargs):\n                         attrs[ATTR_INSTALLED_VERSION] == f\"0x{installed_fw_version:08x}\"\n                     )\n                     assert attrs[ATTR_IN_PROGRESS] is True\n-                    assert attrs[ATTR_UPDATE_PERCENTAGE] == 58\n+                    assert attrs[ATTR_UPDATE_PERCENTAGE] == pytest.approx(100 * 40 / 70)\n                     assert (\n                         attrs[ATTR_LATEST_VERSION]\n                         == f\"0x{fw_image.firmware.header.file_version:08x}\"\n", "problem_statement": "Home Assistant not updating light state after light.toggle action\n### The problem\r\n\r\nAfter updating to Home Assistant 2024.11, my Ikea Zigbee lights, connected via ZHA, no longer report their state correctly to Home Assistant when toggled via automation. This issue occurs when using the light.toggle action in an automation triggered by a Zigbee remote control.\r\n\r\nPreviously, the state of the lights updated accurately in Home Assistant when toggled, allowing the toggle action to work as expected. Now, after executing the light.toggle action, the lights do turn on or off, but Home Assistant doesn\u2019t receive the correct updated state. This results in Home Assistant showing the incorrect state of the bulbs, causing subsequent toggles to malfunction since HA assumes the wrong state.\r\n\r\nI have tried everything from restarting HA to reloading Zigbee and also removing adding the devices again.\r\n\r\n### What version of Home Assistant Core has the issue?\r\n\r\ncore-2024.11.1\r\n\r\n### What was the last working version of Home Assistant Core?\r\n\r\n_No response_\r\n\r\n### What type of installation are you running?\r\n\r\nHome Assistant OS\r\n\r\n### Integration causing the issue\r\n\r\nZigbee Home Automation\r\n\r\n### Link to integration documentation on our website\r\n\r\nhttps://www.home-assistant.io/integrations/zha/\r\n\r\n### Diagnostics information\r\n\r\n[zha-8c4b0ec491570ac25fc42ec994886df5-IKEA of Sweden TRADFRI bulb E27 WW G95 CL 470lm-e79e82c874614dda0cbaba153caedb0e.json](https://github.com/user-attachments/files/17689750/zha-8c4b0ec491570ac25fc42ec994886df5-IKEA.of.Sweden.TRADFRI.bulb.E27.WW.G95.CL.470lm-e79e82c874614dda0cbaba153caedb0e.json)\r\n\r\n\r\n### Example YAML snippet\r\n\r\n_No response_\r\n\r\n### Anything in the logs that might be useful for us?\r\n\r\n_No response_\r\n\r\n### Additional information\r\n\r\nThe issue doesn't appear when toggling the light through the UI.\n", "hints_text": "\nHey there @dmulcahey, @adminiuga, @puddly, @thejulianjes, mind taking a look at this issue as it has been labeled with an integration (`zha`) you are listed as a [code owner](https://github.com/home-assistant/core/blob/dev/CODEOWNERS#L1734) for? Thanks!\n\n<details>\n<summary>Code owner commands</summary>\n\n\nCode owners of `zha` can trigger bot actions by commenting:\n\n- `@home-assistant close` Closes the issue.\n- `@home-assistant rename Awesome new title` Renames the issue.\n- `@home-assistant reopen` Reopen the issue.\n- `@home-assistant unassign zha` Removes the current integration label and assignees on the issue, add the integration domain after the command.\n- `@home-assistant add-label needs-more-information` Add a label (needs-more-information, problem in dependency, problem in custom component) to the issue.\n- `@home-assistant remove-label needs-more-information` Remove a label (needs-more-information, problem in dependency, problem in custom component) on the issue.\n\n</details>\n\n\n<sub><sup>(message by CodeOwnersMention)</sup></sub>\n\n---\n\n[zha documentation](https://www.home-assistant.io/integrations/zha)\n[zha source](https://github.com/home-assistant/core/tree/dev/homeassistant/components/zha)\n<sub><sup>(message by IssueLinks)</sup></sub>\nCan you enable debug logging, run your script, and then disable it to generate a debug log?\n\nAlso, please post the exact action you're running. \n> Can you enable debug logging, run your script, and then disable it to generate a debug log?\r\n\r\nCan't do it right now, but I'll do it tomorrow.\r\n\r\nUPDATE: The issue only seems to appear when turning on the light via the action call. The `light.turn_off` action works as expected and updates the state correctly.\r\n\r\n> Also, please post the exact action you're running.\r\n\r\nThis is the action call I do in my automation:\r\n\r\n```yaml\r\naction: light.toggle\r\ntarget:\r\n  device_id:\r\n    - 6a894ebfdf8e7a37dada3d57e884bab9\r\n    - e79e82c874614dda0cbaba153caedb0e\r\n```\r\nThanks for you response \ud83d\ude4f\r\n\nI think I'm encountering the same issue. The Philips Hue remotes I've got trigger a `light.toggle` action on a ZHA group when pressed and the remote only works the first time. \r\n\r\nThe action I'm using (from an automation) is:\r\n```\r\ndata: {}\r\ntarget:\r\n  entity_id: light.study_lights_zha_group_0x0004\r\naction: light.toggle\r\n```\r\n\r\nI captured a debug log: [home-assistant_zha_2024-11-10T10-31-54.858Z.log](https://github.com/user-attachments/files/17691100/home-assistant_zha_2024-11-10T10-31-54.858Z.log). The lights started out in the on state. I pressed the remote once and they correctly turned off. I pressed the remote a couple more times and the lights did not turn back on. Home Assistant seems to think that the lights are still on, the dashboard still indicates that the lights are on even though they are off in real life.\r\n\nIt's very weird. Sometimes the issue appears and sometimes everything works just fine. I also couldn't recreate it with any other automation or action call. For example my Stream Deck makes a websocket API call with the exact same command and HA updates the state correctly.\r\n\r\nCould that be an issue with the ZHA integration or the [blueprint](https://gist.github.com/stefanroelofs/775e2e0a3cdb3d72a9451fb247492d59) I'm using?\nI have a something similar...\r\nIf i use my Hue Dimmer Switch to turn on a light the light turns on, but the light entity in Home Assistant does not change it's Status (i know sound weird...).\r\n\r\nFor a detailed Explanation:\r\n- I press the On Button on the Hue Dimmer Switch\r\n- Light Turns on\r\n- If I check my mobile, the light is off in the Dashboard (and stays off forever)\r\n- Regarding this all my toggle Automations are not working...\r\n\r\nI'll try to downgrade to 2024.10 if it is working there (today evening).\nDowngrade to 2024.10.4 solves the issie for me.\n@outrun0506 Please collect a debug log of you turning the light on/off with both HA versions\n@puddly \r\n\r\nHere the request logs\r\n[home-assistant_zha_2024.11.1.log](https://github.com/user-attachments/files/17719998/home-assistant_zha_2024.11.1.log)\r\n[home-assistant_zha_2024.10.4.log](https://github.com/user-attachments/files/17720002/home-assistant_zha_2024.10.4.log)\r\n\r\nIssue started again after update to 2024.11.1\r\n\r\nDo you need anything else?\r\n\r\nBR and thanks for taking a look\nLooks like we're affected by <https://github.com/python/cpython/pull/93222>, since our semaphore implementation is based on it. In 2024.11.0 we introduced a feature to prioritize requests but it looks like they sometimes get lost. Should be fixed the next patch release.\n@puddly Do you mean HomeAssistant patch or cpython patch?\nThe zigpy library uses a data structure based on a semaphore. Our implementation modifies the one in CPython, which had a bug in 2022 that we haven't ported the fix for. The bug causes some requests to just never be sent (if a few are sent at once, under specific conditions).\n\nShould be all fixed in the next Core patch release.\nThanks a lot!\n@puddly Amazing, thanks \ud83d\udc4d ", "created_at": "2024-11-13T20:59:50Z"}
{"repo": "home-assistant/core", "pull_number": 130504, "instance_id": "home-assistant__core-130504", "issue_numbers": ["130458"], "base_commit": "3092297979cd11c176f85bd1129a8f801577daae", "patch": "diff --git a/homeassistant/components/withings/manifest.json b/homeassistant/components/withings/manifest.json\nindex c24bdb743bfefe..f9e8328ae53c98 100644\n--- a/homeassistant/components/withings/manifest.json\n+++ b/homeassistant/components/withings/manifest.json\n@@ -9,5 +9,5 @@\n   \"iot_class\": \"cloud_push\",\n   \"loggers\": [\"aiowithings\"],\n   \"quality_scale\": \"platinum\",\n-  \"requirements\": [\"aiowithings==3.1.2\"]\n+  \"requirements\": [\"aiowithings==3.1.3\"]\n }\ndiff --git a/requirements_all.txt b/requirements_all.txt\nindex 9a27f4d3b040b4..334d36f0840884 100644\n--- a/requirements_all.txt\n+++ b/requirements_all.txt\n@@ -417,7 +417,7 @@ aiowatttime==0.1.1\n aiowebostv==0.4.2\n \n # homeassistant.components.withings\n-aiowithings==3.1.2\n+aiowithings==3.1.3\n \n # homeassistant.components.yandex_transport\n aioymaps==1.2.5\n", "test_patch": "diff --git a/requirements_test_all.txt b/requirements_test_all.txt\nindex 38704005179dd0..c8d4fb15883430 100644\n--- a/requirements_test_all.txt\n+++ b/requirements_test_all.txt\n@@ -399,7 +399,7 @@ aiowatttime==0.1.1\n aiowebostv==0.4.2\n \n # homeassistant.components.withings\n-aiowithings==3.1.2\n+aiowithings==3.1.3\n \n # homeassistant.components.yandex_transport\n aioymaps==1.2.5\n", "problem_statement": "Withings integrations has stopped loading with 2024.11\n### The problem\n\nAfter upgrading I have this in the Elon and the Withings integrations fails to initialize \r\n\r\nLogger: homeassistant.components.withings\r\nSource: helpers/update_coordinator.py:382\r\nintegration: Withings (documentation, issues)\r\nFirst occurred: 8 November 2024 at 22:06:46 (4096 occurrences)\r\nLast logged: 18:00:46\r\n\r\nUnexpected error fetching Withings 813956 device data\r\nTraceback (most recent call last):\r\n  File \"/usr/src/homeassistant/homeassistant/helpers/update_coordinator.py\", line 382, in _async_refresh\r\n    self.data = await self._async_update_data()\r\n                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/src/homeassistant/homeassistant/components/withings/coordinator.py\", line 80, in _async_update_data\r\n    return await self._internal_update_data()\r\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/src/homeassistant/homeassistant/components/withings/coordinator.py\", line 307, in _internal_update_data\r\n    devices = await self._client.get_devices()\r\n              ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/local/lib/python3.12/site-packages/aiowithings/withings.py\", line 152, in get_devices\r\n    return [Device.from_api(device) for device in response[\"devices\"]]\r\n            ^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/local/lib/python3.12/site-packages/aiowithings/models.py\", line 131, in from_api\r\n    battery=DeviceBattery(device[\"battery\"]),\r\n            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/local/lib/python3.12/enum.py\", line 757, in __call__\r\n    return cls.__new__(cls, value)\r\n           ^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/local/lib/python3.12/enum.py\", line 1171, in __new__\r\n    raise ve_exc\r\nValueError: 'unknown' is not a valid DeviceBattery\r\n\n\n### What version of Home Assistant Core has the issue?\n\n2024.11.1\n\n### What was the last working version of Home Assistant Core?\n\n_No response_\n\n### What type of installation are you running?\n\nHome Assistant OS\n\n### Integration causing the issue\n\nWithinngs\n\n### Link to integration documentation on our website\n\n_No response_\n\n### Diagnostics information\n\n_No response_\n\n### Example YAML snippet\n\n_No response_\n\n### Anything in the logs that might be useful for us?\n\n```txt\nLogger: homeassistant.components.withings\r\nSource: helpers/update_coordinator.py:382\r\nintegration: Withings (documentation, issues)\r\nFirst occurred: 8 November 2024 at 22:06:46 (4096 occurrences)\r\nLast logged: 18:00:46\r\n\r\nUnexpected error fetching Withings 813956 device data\r\nTraceback (most recent call last):\r\n  File \"/usr/src/homeassistant/homeassistant/helpers/update_coordinator.py\", line 382, in _async_refresh\r\n    self.data = await self._async_update_data()\r\n                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/src/homeassistant/homeassistant/components/withings/coordinator.py\", line 80, in _async_update_data\r\n    return await self._internal_update_data()\r\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/src/homeassistant/homeassistant/components/withings/coordinator.py\", line 307, in _internal_update_data\r\n    devices = await self._client.get_devices()\r\n              ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/local/lib/python3.12/site-packages/aiowithings/withings.py\", line 152, in get_devices\r\n    return [Device.from_api(device) for device in response[\"devices\"]]\r\n            ^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/local/lib/python3.12/site-packages/aiowithings/models.py\", line 131, in from_api\r\n    battery=DeviceBattery(device[\"battery\"]),\r\n            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/local/lib/python3.12/enum.py\", line 757, in __call__\r\n    return cls.__new__(cls, value)\r\n           ^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/local/lib/python3.12/enum.py\", line 1171, in __new__\r\n    raise ve_exc\r\nValueError: 'unknown' is not a valid DeviceBattery\n```\n\n\n### Additional information\n\n_No response_\n", "hints_text": "\nHey there @joostlek, mind taking a look at this issue as it has been labeled with an integration (`withings`) you are listed as a [code owner](https://github.com/home-assistant/core/blob/dev/CODEOWNERS#L1675) for? Thanks!\n\n<details>\n<summary>Code owner commands</summary>\n\n\nCode owners of `withings` can trigger bot actions by commenting:\n\n- `@home-assistant close` Closes the issue.\n- `@home-assistant rename Awesome new title` Renames the issue.\n- `@home-assistant reopen` Reopen the issue.\n- `@home-assistant unassign withings` Removes the current integration label and assignees on the issue, add the integration domain after the command.\n- `@home-assistant add-label needs-more-information` Add a label (needs-more-information, problem in dependency, problem in custom component) to the issue.\n- `@home-assistant remove-label needs-more-information` Remove a label (needs-more-information, problem in dependency, problem in custom component) on the issue.\n\n</details>\n\n\n<sub><sup>(message by CodeOwnersMention)</sup></sub>\n\n---\n\n[withings documentation](https://www.home-assistant.io/integrations/withings)\n[withings source](https://github.com/home-assistant/core/tree/dev/homeassistant/components/withings)\n<sub><sup>(message by IssueLinks)</sup></sub>", "created_at": "2024-11-13T09:06:59Z"}
{"repo": "home-assistant/core", "pull_number": 130494, "instance_id": "home-assistant__core-130494", "issue_numbers": ["127103"], "base_commit": "ee74a3541734593b6799a8cd4408a4f12eaa83a7", "patch": "diff --git a/homeassistant/components/modern_forms/config_flow.py b/homeassistant/components/modern_forms/config_flow.py\nindex 6799dbf97d3611..3c217b5747f0bb 100644\n--- a/homeassistant/components/modern_forms/config_flow.py\n+++ b/homeassistant/components/modern_forms/config_flow.py\n@@ -22,7 +22,7 @@ class ModernFormsFlowHandler(ConfigFlow, domain=DOMAIN):\n \n     VERSION = 1\n \n-    host: str | None = None\n+    host: str\n     mac: str | None = None\n     name: str\n \n@@ -30,7 +30,13 @@ async def async_step_user(\n         self, user_input: dict[str, Any] | None = None\n     ) -> ConfigFlowResult:\n         \"\"\"Handle setup by user for Modern Forms integration.\"\"\"\n-        return await self._handle_config_flow(user_input)\n+        if user_input is None:\n+            return self.async_show_form(\n+                step_id=\"user\",\n+                data_schema=USER_SCHEMA,\n+            )\n+        self.host = user_input[CONF_HOST]\n+        return await self._handle_config_flow()\n \n     async def async_step_zeroconf(\n         self, discovery_info: zeroconf.ZeroconfServiceInfo\n@@ -44,40 +50,26 @@ async def async_step_zeroconf(\n         self.mac = discovery_info.properties.get(CONF_MAC)\n         self.name = name\n \n-        # Prepare configuration flow\n-        return await self._handle_config_flow({}, True)\n+        # Loop through self._handle_config_flow to ensure we load the\n+        # MAC if it is missing, and abort if already configured\n+        return await self._handle_config_flow(True)\n \n     async def async_step_zeroconf_confirm(\n         self, user_input: dict[str, Any] | None = None\n     ) -> ConfigFlowResult:\n         \"\"\"Handle a flow initiated by zeroconf.\"\"\"\n-        return await self._handle_config_flow(user_input)\n+        return await self._handle_config_flow()\n \n     async def _handle_config_flow(\n-        self, user_input: dict[str, Any] | None = None, prepare: bool = False\n+        self, initial_zeroconf: bool = False\n     ) -> ConfigFlowResult:\n         \"\"\"Config flow handler for ModernForms.\"\"\"\n-        # Request user input, unless we are preparing discovery flow\n-        if user_input is None:\n-            user_input = {}\n-            if not prepare:\n-                if self.source == SOURCE_ZEROCONF:\n-                    return self.async_show_form(\n-                        step_id=\"zeroconf_confirm\",\n-                        description_placeholders={\"name\": self.name},\n-                    )\n-                return self.async_show_form(\n-                    step_id=\"user\",\n-                    data_schema=USER_SCHEMA,\n-                )\n-\n-        if self.source == SOURCE_ZEROCONF:\n-            user_input[CONF_HOST] = self.host\n-            user_input[CONF_MAC] = self.mac\n-\n-        if user_input.get(CONF_MAC) is None or not prepare:\n+        if self.mac is None or not initial_zeroconf:\n+            # User flow\n+            # Or zeroconf without MAC\n+            # Or zeroconf with MAC, but need to ensure device is still available\n             session = async_get_clientsession(self.hass)\n-            device = ModernFormsDevice(user_input[CONF_HOST], session=session)\n+            device = ModernFormsDevice(self.host, session=session)\n             try:\n                 device = await device.update()\n             except ModernFormsConnectionError:\n@@ -88,20 +80,21 @@ async def _handle_config_flow(\n                     data_schema=USER_SCHEMA,\n                     errors={\"base\": \"cannot_connect\"},\n                 )\n-            user_input[CONF_MAC] = device.info.mac_address\n+            self.mac = device.info.mac_address\n+            if self.source != SOURCE_ZEROCONF:\n+                self.name = device.info.device_name\n \n         # Check if already configured\n-        await self.async_set_unique_id(user_input[CONF_MAC])\n-        self._abort_if_unique_id_configured(updates={CONF_HOST: user_input[CONF_HOST]})\n-\n-        title = device.info.device_name\n-        if self.source == SOURCE_ZEROCONF:\n-            title = self.name\n+        await self.async_set_unique_id(self.mac)\n+        self._abort_if_unique_id_configured(updates={CONF_HOST: self.host})\n \n-        if prepare:\n-            return await self.async_step_zeroconf_confirm()\n+        if initial_zeroconf:\n+            return self.async_show_form(\n+                step_id=\"zeroconf_confirm\",\n+                description_placeholders={\"name\": self.name},\n+            )\n \n         return self.async_create_entry(\n-            title=title,\n-            data={CONF_HOST: user_input[CONF_HOST], CONF_MAC: user_input[CONF_MAC]},\n+            title=self.name,\n+            data={CONF_HOST: self.host, CONF_MAC: self.mac},\n         )\n", "test_patch": "", "problem_statement": "Prevent None strings in description_placeholders\n## Proposed change\r\n<!--\r\n  Describe the big picture of your changes here to communicate to the\r\n  maintainers why we should accept this pull request. If it fixes a bug\r\n  or resolves a feature request, be sure to link to that issue in the\r\n  additional information section.\r\n-->\r\nSSIA, based on https://github.com/home-assistant/frontend/blob/4f713f000f34a0a6cf079d1c74e72cc374a46153/src/data/data_entry_flow.ts#L33-L34\r\n\r\nNeeds:\r\n- [x] #130420\r\n- [x] #130421 \r\n- [x] #130422 \r\n- [x] #130431 \r\n- [x] #130435 \r\n- [x] #130439 \r\n- [x] #130441 \r\n- [x] #130506 \r\n- [x] #130507 \r\n- [x] #130509 \r\n- [x] #130511\r\n- [x] #130512 \r\n- [x] #130697\r\n- [x] #130698\r\n\r\n## Type of change\r\n<!--\r\n  What type of change does your PR introduce to Home Assistant?\r\n  NOTE: Please, check only 1! box!\r\n  If your PR requires multiple boxes to be checked, you'll most likely need to\r\n  split it into multiple PRs. This makes things easier and faster to code review.\r\n-->\r\n\r\n- [ ] Dependency upgrade\r\n- [ ] Bugfix (non-breaking change which fixes an issue)\r\n- [ ] New integration (thank you!)\r\n- [ ] New feature (which adds functionality to an existing integration)\r\n- [ ] Deprecation (breaking change to happen in the future)\r\n- [ ] Breaking change (fix/feature causing existing functionality to break)\r\n- [x] Code quality improvements to existing code or addition of tests\r\n\r\n## Additional information\r\n<!--\r\n  Details are important, and help maintainers processing your PR.\r\n  Please be sure to fill out additional details, if applicable.\r\n-->\r\n\r\n- This PR fixes or closes issue: fixes #\r\n- This PR is related to issue: \r\n- Link to documentation pull request: \r\n\r\n## Checklist\r\n<!--\r\n  Put an `x` in the boxes that apply. You can also fill these out after\r\n  creating the PR. If you're unsure about any of them, don't hesitate to ask.\r\n  We're here to help! This is simply a reminder of what we are going to look\r\n  for before merging your code.\r\n-->\r\n\r\n- [ ] The code change is tested and works locally.\r\n- [ ] Local tests pass. **Your PR cannot be merged unless tests pass**\r\n- [ ] There is no commented out code in this PR.\r\n- [ ] I have followed the [development checklist][dev-checklist]\r\n- [ ] I have followed the [perfect PR recommendations][perfect-pr]\r\n- [ ] The code has been formatted using Ruff (`ruff format homeassistant tests`)\r\n- [ ] Tests have been added to verify that the new code works.\r\n\r\nIf user exposed functionality or configuration variables are added/changed:\r\n\r\n- [ ] Documentation added/updated for [www.home-assistant.io][docs-repository]\r\n\r\nIf the code communicates with devices, web services, or third-party tools:\r\n\r\n- [ ] The [manifest file][manifest-docs] has all fields filled out correctly.  \r\n      Updated and included derived files by running: `python3 -m script.hassfest`.\r\n- [ ] New or updated dependencies have been added to `requirements_all.txt`.  \r\n      Updated by running `python3 -m script.gen_requirements_all`.\r\n- [ ] For the updated dependencies - a link to the changelog, or at minimum a diff between library versions is added to the PR description.\r\n\r\n<!--\r\n  This project is very active and we have a high turnover of pull requests.\r\n\r\n  Unfortunately, the number of incoming pull requests is higher than what our\r\n  reviewers can review and merge so there is a long backlog of pull requests\r\n  waiting for review. You can help here!\r\n  \r\n  By reviewing another pull request, you will help raise the code quality of\r\n  that pull request and the final review will be faster. This way the general\r\n  pace of pull request reviews will go up and your wait time will go down.\r\n  \r\n  When picking a pull request to review, try to choose one that hasn't yet\r\n  been reviewed.\r\n\r\n  Thanks for helping out!\r\n-->\r\n\r\nTo help with the load of incoming pull requests:\r\n\r\n- [ ] I have reviewed two other [open pull requests][prs] in this repository.\r\n\r\n[prs]: https://github.com/home-assistant/core/pulls?q=is%3Aopen+is%3Apr+-author%3A%40me+-draft%3Atrue+-label%3Awaiting-for-upstream+sort%3Acreated-desc+review%3Anone+-status%3Afailure\r\n\r\n<!--\r\n  Thank you for contributing <3\r\n\r\n  Below, some useful links you could explore:\r\n-->\r\n[dev-checklist]: https://developers.home-assistant.io/docs/development_checklist/\r\n[manifest-docs]: https://developers.home-assistant.io/docs/creating_integration_manifest/\r\n[quality-scale]: https://developers.home-assistant.io/docs/integration_quality_scale_index/\r\n[docs-repository]: https://github.com/home-assistant/home-assistant.io\r\n[perfect-pr]: https://developers.home-assistant.io/docs/review-process/#creating-the-perfect-pr\r\n\n", "hints_text": "", "created_at": "2024-11-13T07:47:15Z"}
{"repo": "home-assistant/core", "pull_number": 130487, "instance_id": "home-assistant__core-130487", "issue_numbers": ["130404"], "base_commit": "4ff8b8015cdb5450f26707230194049a0af682ab", "patch": "diff --git a/homeassistant/components/ruckus_unleashed/manifest.json b/homeassistant/components/ruckus_unleashed/manifest.json\nindex 2066b65221e5fd..8d56f3a5563364 100644\n--- a/homeassistant/components/ruckus_unleashed/manifest.json\n+++ b/homeassistant/components/ruckus_unleashed/manifest.json\n@@ -7,5 +7,5 @@\n   \"integration_type\": \"hub\",\n   \"iot_class\": \"local_polling\",\n   \"loggers\": [\"aioruckus\"],\n-  \"requirements\": [\"aioruckus==0.41\"]\n+  \"requirements\": [\"aioruckus==0.42\"]\n }\ndiff --git a/requirements_all.txt b/requirements_all.txt\nindex 67c7c99114698e..edb2d3c4d013d4 100644\n--- a/requirements_all.txt\n+++ b/requirements_all.txt\n@@ -354,7 +354,7 @@ aiorecollect==2023.09.0\n aioridwell==2024.01.0\n \n # homeassistant.components.ruckus_unleashed\n-aioruckus==0.41\n+aioruckus==0.42\n \n # homeassistant.components.russound_rio\n aiorussound==4.1.0\n", "test_patch": "diff --git a/requirements_test_all.txt b/requirements_test_all.txt\nindex 048f0ac7d76016..7f6771273ba1c3 100644\n--- a/requirements_test_all.txt\n+++ b/requirements_test_all.txt\n@@ -336,7 +336,7 @@ aiorecollect==2023.09.0\n aioridwell==2024.01.0\n \n # homeassistant.components.ruckus_unleashed\n-aioruckus==0.41\n+aioruckus==0.42\n \n # homeassistant.components.russound_rio\n aiorussound==4.1.0\n", "problem_statement": "Ruckus One MSP customers can't connect APs\n### The problem\n\nFrom [https://github.com/home-assistant/home-assistant.io/issues/35651](https://github.com/home-assistant/home-assistant.io/issues/35651):-\r\n\r\n> My MSP customer tenant dashboard URL looks like the following (when I log in as a customer):  \r\n> [MSPNAME.msp.ruckus.cloud](https://mspname.msp.ruckus.cloud/)/t/dashboard\r\n> \r\n> I entered this URL as per the documentation, but received a connection error message. I then removed \"MSPNAME.msp.\" from the URL and the integration started working.\n\n### What version of Home Assistant Core has the issue?\n\ncore-2024.11.1\n\n### What was the last working version of Home Assistant Core?\n\n_No response_\n\n### What type of installation are you running?\n\nHome Assistant OS\n\n### Integration causing the issue\n\nruckus_unleashed\n\n### Link to integration documentation on our website\n\nhttps://www.home-assistant.io/integrations/ruckus_unleashed/\n\n### Diagnostics information\n\n_No response_\n\n### Example YAML snippet\n\n_No response_\n\n### Anything in the logs that might be useful for us?\n\n_No response_\n\n### Additional information\n\n_No response_\n", "hints_text": "\nHey there @lanrat, @gabe565, mind taking a look at this issue as it has been labeled with an integration (`ruckus_unleashed`) you are listed as a [code owner](https://github.com/home-assistant/core/blob/dev/CODEOWNERS#L1263) for? Thanks!\n\n<details>\n<summary>Code owner commands</summary>\n\n\nCode owners of `ruckus_unleashed` can trigger bot actions by commenting:\n\n- `@home-assistant close` Closes the issue.\n- `@home-assistant rename Awesome new title` Renames the issue.\n- `@home-assistant reopen` Reopen the issue.\n- `@home-assistant unassign ruckus_unleashed` Removes the current integration label and assignees on the issue, add the integration domain after the command.\n- `@home-assistant add-label needs-more-information` Add a label (needs-more-information, problem in dependency, problem in custom component) to the issue.\n- `@home-assistant remove-label needs-more-information` Remove a label (needs-more-information, problem in dependency, problem in custom component) on the issue.\n\n</details>\n\n\n<sub><sup>(message by CodeOwnersMention)</sup></sub>\n\n---\n\n[ruckus_unleashed documentation](https://www.home-assistant.io/integrations/ruckus_unleashed)\n[ruckus_unleashed source](https://github.com/home-assistant/core/tree/dev/homeassistant/components/ruckus_unleashed)\n<sub><sup>(message by IssueLinks)</sup></sub>\nI've prepared an aioruckus bugfix for this. Testing.", "created_at": "2024-11-13T05:33:35Z"}
{"repo": "home-assistant/core", "pull_number": 130470, "instance_id": "home-assistant__core-130470", "issue_numbers": ["130248"], "base_commit": "5c52e865a0e95a83a94162e21424cd0be2d372c9", "patch": "diff --git a/homeassistant/components/zha/config_flow.py b/homeassistant/components/zha/config_flow.py\nindex 1c7e0d105c4191..f3f7f38772d2d3 100644\n--- a/homeassistant/components/zha/config_flow.py\n+++ b/homeassistant/components/zha/config_flow.py\n@@ -33,6 +33,7 @@\n from homeassistant.const import CONF_NAME\n from homeassistant.core import HomeAssistant, callback\n from homeassistant.exceptions import HomeAssistantError\n+from homeassistant.helpers.hassio import is_hassio\n from homeassistant.helpers.selector import FileSelector, FileSelectorConfig\n from homeassistant.util import dt as dt_util\n \n@@ -104,25 +105,26 @@ async def list_serial_ports(hass: HomeAssistant) -> list[ListPortInfo]:\n         yellow_radio.description = \"Yellow Zigbee module\"\n         yellow_radio.manufacturer = \"Nabu Casa\"\n \n-    # Present the multi-PAN addon as a setup option, if it's available\n-    multipan_manager = await silabs_multiprotocol_addon.get_multiprotocol_addon_manager(\n-        hass\n-    )\n-\n-    try:\n-        addon_info = await multipan_manager.async_get_addon_info()\n-    except (AddonError, KeyError):\n-        addon_info = None\n-\n-    if addon_info is not None and addon_info.state != AddonState.NOT_INSTALLED:\n-        addon_port = ListPortInfo(\n-            device=silabs_multiprotocol_addon.get_zigbee_socket(),\n-            skip_link_detection=True,\n+    if is_hassio(hass):\n+        # Present the multi-PAN addon as a setup option, if it's available\n+        multipan_manager = (\n+            await silabs_multiprotocol_addon.get_multiprotocol_addon_manager(hass)\n         )\n \n-        addon_port.description = \"Multiprotocol add-on\"\n-        addon_port.manufacturer = \"Nabu Casa\"\n-        ports.append(addon_port)\n+        try:\n+            addon_info = await multipan_manager.async_get_addon_info()\n+        except (AddonError, KeyError):\n+            addon_info = None\n+\n+        if addon_info is not None and addon_info.state != AddonState.NOT_INSTALLED:\n+            addon_port = ListPortInfo(\n+                device=silabs_multiprotocol_addon.get_zigbee_socket(),\n+                skip_link_detection=True,\n+            )\n+\n+            addon_port.description = \"Multiprotocol add-on\"\n+            addon_port.manufacturer = \"Nabu Casa\"\n+            ports.append(addon_port)\n \n     return ports\n \n", "test_patch": "diff --git a/tests/components/zha/test_config_flow.py b/tests/components/zha/test_config_flow.py\nindex 1382c5c2569e7b..87ba46a4ced11d 100644\n--- a/tests/components/zha/test_config_flow.py\n+++ b/tests/components/zha/test_config_flow.py\n@@ -21,7 +21,7 @@\n \n from homeassistant import config_entries\n from homeassistant.components import ssdp, usb, zeroconf\n-from homeassistant.components.hassio import AddonState\n+from homeassistant.components.hassio import AddonError, AddonState\n from homeassistant.components.ssdp import ATTR_UPNP_MANUFACTURER_URL, ATTR_UPNP_SERIAL\n from homeassistant.components.zha import config_flow, radio_manager\n from homeassistant.components.zha.const import (\n@@ -1878,10 +1878,23 @@ async def test_config_flow_port_yellow_port_name(hass: HomeAssistant) -> None:\n     )\n \n \n+async def test_config_flow_ports_no_hassio(hass: HomeAssistant) -> None:\n+    \"\"\"Test config flow serial port name when this is not a hassio install.\"\"\"\n+\n+    with (\n+        patch(\"homeassistant.components.zha.config_flow.is_hassio\", return_value=False),\n+        patch(\"serial.tools.list_ports.comports\", MagicMock(return_value=[])),\n+    ):\n+        ports = await config_flow.list_serial_ports(hass)\n+\n+    assert ports == []\n+\n+\n async def test_config_flow_port_multiprotocol_port_name(hass: HomeAssistant) -> None:\n     \"\"\"Test config flow serial port name for multiprotocol add-on.\"\"\"\n \n     with (\n+        patch(\"homeassistant.components.zha.config_flow.is_hassio\", return_value=True),\n         patch(\n             \"homeassistant.components.hassio.addon_manager.AddonManager.async_get_addon_info\"\n         ) as async_get_addon_info,\n@@ -1889,16 +1902,28 @@ async def test_config_flow_port_multiprotocol_port_name(hass: HomeAssistant) ->\n     ):\n         async_get_addon_info.return_value.state = AddonState.RUNNING\n         async_get_addon_info.return_value.hostname = \"core-silabs-multiprotocol\"\n+        ports = await config_flow.list_serial_ports(hass)\n \n-        result = await hass.config_entries.flow.async_init(\n-            DOMAIN,\n-            context={CONF_SOURCE: SOURCE_USER},\n-        )\n+    assert len(ports) == 1\n+    assert ports[0].description == \"Multiprotocol add-on\"\n+    assert ports[0].manufacturer == \"Nabu Casa\"\n+    assert ports[0].device == \"socket://core-silabs-multiprotocol:9999\"\n \n-    assert (\n-        result[\"data_schema\"].schema[\"path\"].container[0]\n-        == \"socket://core-silabs-multiprotocol:9999 - Multiprotocol add-on - Nabu Casa\"\n-    )\n+\n+async def test_config_flow_port_no_multiprotocol(hass: HomeAssistant) -> None:\n+    \"\"\"Test config flow serial port listing when addon info fails to load.\"\"\"\n+\n+    with (\n+        patch(\"homeassistant.components.zha.config_flow.is_hassio\", return_value=True),\n+        patch(\n+            \"homeassistant.components.hassio.addon_manager.AddonManager.async_get_addon_info\",\n+            side_effect=AddonError,\n+        ),\n+        patch(\"serial.tools.list_ports.comports\", MagicMock(return_value=[])),\n+    ):\n+        ports = await config_flow.list_serial_ports(hass)\n+\n+    assert ports == []\n \n \n @patch(\"serial.tools.list_ports.comports\", MagicMock(return_value=[com_port()]))\n", "problem_statement": "Can't configure ZHA\n### The problem\r\n\r\nI failed to configure ZHA, on the first time trying to configure it, the config flow screen shows this:\r\n\r\n`500 Internal Server Error Server got itself in trouble`\r\n\r\nOn the second attempt, the screen just times out until nginx, which I configured HA to be proxied through, returns a gateway timeout.\r\n\r\nBefore this reinstallation, I had ZHA configured already but it fails to load. I suspected that it's because of some actions I performed on the UI and it led to some inconsistencies in the database etc, but after the reinstallation it's still not working. So this is on a pretty fresh install (only a few HACS plugins enabled). To sort out HACS problems, I've tried safe mode, no success either...\r\n\r\n### What version of Home Assistant Core has the issue?\r\n\r\ncore-2024.11.1\r\n\r\n### What was the last working version of Home Assistant Core?\r\n\r\n_No response_\r\n\r\nEdit: According to comments, this used to work on 2024.10\r\n\r\nhttps://github.com/home-assistant/core/issues/130248#issuecomment-2471121347\r\n\r\n### What type of installation are you running?\r\n\r\nHome Assistant Container\r\n\r\n### Integration causing the issue\r\n\r\nZHA\r\n\r\n### Link to integration documentation on our website\r\n\r\nhttps://www.home-assistant.io/integrations/zha/\r\n\r\n### Diagnostics information\r\n\r\n_No response_\r\n\r\n### Example YAML snippet\r\n\r\n_No response_\r\n\r\n### Anything in the logs that might be useful for us?\r\n\r\n```txt\r\nThis seems relevant:\r\n\r\nTraceback (most recent call last):\r\n  File \"/usr/local/lib/python3.12/site-packages/aiohttp/web_protocol.py\", line 477, in _handle_request\r\n    resp = await request_handler(request)\r\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/local/lib/python3.12/site-packages/aiohttp/web_app.py\", line 559, in _handle\r\n    return await handler(request)\r\n           ^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/local/lib/python3.12/site-packages/aiohttp/web_middlewares.py\", line 117, in impl\r\n    return await handler(request)\r\n           ^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/src/homeassistant/homeassistant/components/http/security_filter.py\", line 92, in security_filter_middleware\r\n    return await handler(request)\r\n           ^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/src/homeassistant/homeassistant/components/http/forwarded.py\", line 210, in forwarded_middleware\r\n    return await handler(request)\r\n           ^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/src/homeassistant/homeassistant/components/http/request_context.py\", line 26, in request_context_middleware\r\n    return await handler(request)\r\n           ^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/src/homeassistant/homeassistant/components/http/ban.py\", line 86, in ban_middleware\r\n    return await handler(request)\r\n           ^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/src/homeassistant/homeassistant/components/http/auth.py\", line 242, in auth_middleware\r\n    return await handler(request)\r\n           ^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/src/homeassistant/homeassistant/components/http/headers.py\", line 32, in headers_middleware\r\n    response = await handler(request)\r\n               ^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/src/homeassistant/homeassistant/helpers/http.py\", line 73, in handle\r\n    result = await handler(request, **request.match_info)\r\n             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/src/homeassistant/homeassistant/components/http/decorators.py\", line 81, in with_admin\r\n    return await func(self, request, *args, **kwargs)\r\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/src/homeassistant/homeassistant/components/http/data_validator.py\", line 74, in wrapper\r\n    return await method(view, request, data, *args, **kwargs)\r\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/src/homeassistant/homeassistant/components/config/config_entries.py\", line 172, in post\r\n    return await self._post_impl(request, data)\r\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/src/homeassistant/homeassistant/components/config/config_entries.py\", line 179, in _post_impl\r\n    return await super()._post_impl(request, data)\r\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/src/homeassistant/homeassistant/helpers/data_entry_flow.py\", line 84, in _post_impl\r\n    result = await self._flow_mgr.async_init(\r\n             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/src/homeassistant/homeassistant/config_entries.py\", line 1301, in async_init\r\n    flow, result = await self._async_init(flow_id, handler, context, data)\r\n                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/src/homeassistant/homeassistant/config_entries.py\", line 1336, in _async_init\r\n    result = await self._async_handle_step(flow, flow.init_step, data)\r\n             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/src/homeassistant/homeassistant/data_entry_flow.py\", line 517, in _async_handle_step\r\n    result: _FlowResultT = await getattr(flow, method)(user_input)\r\n                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/src/homeassistant/homeassistant/components/zha/config_flow.py\", line 535, in async_step_user\r\n    return await self.async_step_choose_serial_port(user_input)\r\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/src/homeassistant/homeassistant/components/zha/config_flow.py\", line 177, in async_step_choose_serial_port\r\n    ports = await list_serial_ports(self.hass)\r\n            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/src/homeassistant/homeassistant/components/zha/config_flow.py\", line 108, in list_serial_ports\r\n    multipan_manager = await silabs_multiprotocol_addon.get_multiprotocol_addon_manager(\r\n                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/src/homeassistant/homeassistant/helpers/singleton.py\", line 52, in async_wrapped\r\n    result = await func(hass)\r\n             ^^^^^^^^^^^^^^^^\r\n  File \"/usr/src/homeassistant/homeassistant/components/homeassistant_hardware/silabs_multiprotocol_addon.py\", line 71, in get_multiprotocol_addon_manager\r\n    manager = MultiprotocolAddonManager(hass)\r\n              ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/src/homeassistant/homeassistant/components/homeassistant_hardware/silabs_multiprotocol_addon.py\", line 128, in __init__\r\n    super().__init__(\r\n  File \"/usr/src/homeassistant/homeassistant/components/hassio/addon_manager.py\", line 112, in __init__\r\n    self._supervisor_client = get_supervisor_client(hass)\r\n                              ^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/src/homeassistant/homeassistant/helpers/singleton.py\", line 42, in wrapped\r\n    hass.data[data_key] = func(hass)\r\n                          ^^^^^^^^^^\r\n  File \"/usr/src/homeassistant/homeassistant/components/hassio/handler.py\", line 383, in get_supervisor_client\r\n    hassio: HassIO = hass.data[DOMAIN]\r\n                     ~~~~~~~~~^^^^^^^^\r\nKeyError: 'hassio'\r\n```\r\n\r\n\r\n### Additional information\r\n\r\nPlease let me know if I can assist you further!\n", "hints_text": "\nHey there @dmulcahey, @adminiuga, @puddly, @thejulianjes, mind taking a look at this issue as it has been labeled with an integration (`zha`) you are listed as a [code owner](https://github.com/home-assistant/core/blob/dev/CODEOWNERS#L1734) for? Thanks!\n\n<details>\n<summary>Code owner commands</summary>\n\n\nCode owners of `zha` can trigger bot actions by commenting:\n\n- `@home-assistant close` Closes the issue.\n- `@home-assistant rename Awesome new title` Renames the issue.\n- `@home-assistant reopen` Reopen the issue.\n- `@home-assistant unassign zha` Removes the current integration label and assignees on the issue, add the integration domain after the command.\n- `@home-assistant add-label needs-more-information` Add a label (needs-more-information, problem in dependency, problem in custom component) to the issue.\n- `@home-assistant remove-label needs-more-information` Remove a label (needs-more-information, problem in dependency, problem in custom component) on the issue.\n\n</details>\n\n\n<sub><sup>(message by CodeOwnersMention)</sup></sub>\n\n---\n\n[zha documentation](https://www.home-assistant.io/integrations/zha)\n[zha source](https://github.com/home-assistant/core/tree/dev/homeassistant/components/zha)\n<sub><sup>(message by IssueLinks)</sup></sub>\nThis problem is caused by the `hassio` integration (https://www.home-assistant.io/integrations/hassio/) not loading. You have a Supervised install so `hassio` should be loaded.\r\n\r\nCan you post a debug log of your entire startup sequence? This isn't really a ZHA problem.\nHmm, that's weird since I run the container version actually. Debug log following...\nHere you go!\r\n\r\n```\r\n2024-11-09 22:29:39.915 WARNING (SyncWorker_0) [homeassistant.loader] We found a custom integration hacs which has not been tested by Home Assistant. This component might cause stability problems, be sure to disable it if you experience issues with Home Assistant\r\n2024-11-09 22:29:39.916 WARNING (SyncWorker_0) [homeassistant.loader] We found a custom integration xiaomi_miot which has not been tested by Home Assistant. This component might cause stability problems, be sure to disable it if you experience issues with Home Assistant\r\n2024-11-09 22:29:39.917 WARNING (SyncWorker_0) [homeassistant.loader] We found a custom integration frigate which has not been tested by Home Assistant. This component might cause stability problems, be sure to disable it if you experience issues with Home Assistant\r\n2024-11-09 22:29:39.918 WARNING (SyncWorker_0) [homeassistant.loader] We found a custom integration localtuya which has not been tested by Home Assistant. This component might cause stability problems, be sure to disable it if you experience issues with Home Assistant\r\n2024-11-09 22:29:39.919 WARNING (SyncWorker_0) [homeassistant.loader] We found a custom integration xiaomi_gateway3 which has not been tested by Home Assistant. This component might cause stability problems, be sure to disable it if you experience issues with Home Assistant\r\n2024-11-09 22:29:42.891 WARNING (ImportExecutor_0) [homeassistant.const] UnitOfConductivity.MICROSIEMENS was used from xiaomi_gateway3, this is a deprecated enum member which will be removed in HA Core 2025.11.0. Use UnitOfConductivity.MICROSIEMENS_PER_CM instead, please report it to the author of the 'xiaomi_gateway3' custom integration\r\n2024-11-09 22:29:43.185 WARNING (SyncWorker_8) [py.warnings] /usr/local/lib/python3.12/site-packages/tzlocal/unix.py:193: UserWarning: Can not find any timezone configuration, defaulting to UTC.\r\n  warnings.warn(\"Can not find any timezone configuration, defaulting to UTC.\")\r\n2024-11-09 22:29:43.571 WARNING (ImportExecutor_0) [homeassistant.const] STATE_ALARM_TRIGGERED was used from xiaomi_gateway3, this is a deprecated constant which will be removed in HA Core 2025.11. Use AlarmControlPanelState.TRIGGERED instead, please report it to the author of the 'xiaomi_gateway3' custom integration\r\n2024-11-09 22:29:43.637 WARNING (ImportExecutor_0) [homeassistant.core] Config was used from frigate, this is a deprecated alias which will be removed in HA Core 2025.11. Use homeassistant.core_config.Config instead, please report it to the author of the 'frigate' custom integration\r\n2024-11-09 22:29:43.646 WARNING (ImportExecutor_0) [homeassistant.components.media_player.const] MEDIA_CLASS_DIRECTORY was used from frigate, this is a deprecated constant which will be removed in HA Core 2025.10. Use MediaClass.DIRECTORY instead, please report it to the author of the 'frigate' custom integration\r\n2024-11-09 22:29:43.649 WARNING (ImportExecutor_0) [homeassistant.components.media_player.const] MEDIA_CLASS_IMAGE was used from frigate, this is a deprecated constant which will be removed in HA Core 2025.10. Use MediaClass.IMAGE instead, please report it to the author of the 'frigate' custom integration\r\n2024-11-09 22:29:43.652 WARNING (ImportExecutor_0) [homeassistant.components.media_player.const] MEDIA_CLASS_MOVIE was used from frigate, this is a deprecated constant which will be removed in HA Core 2025.10. Use MediaClass.MOVIE instead, please report it to the author of the 'frigate' custom integration\r\n2024-11-09 22:29:43.655 WARNING (ImportExecutor_0) [homeassistant.components.media_player.const] MEDIA_CLASS_VIDEO was used from frigate, this is a deprecated constant which will be removed in HA Core 2025.10. Use MediaClass.VIDEO instead, please report it to the author of the 'frigate' custom integration\r\n2024-11-09 22:29:43.658 WARNING (ImportExecutor_0) [homeassistant.components.media_player.const] MEDIA_TYPE_IMAGE was used from frigate, this is a deprecated constant which will be removed in HA Core 2025.10. Use MediaType.IMAGE instead, please report it to the author of the 'frigate' custom integration\r\n2024-11-09 22:29:43.661 WARNING (ImportExecutor_0) [homeassistant.components.media_player.const] MEDIA_TYPE_VIDEO was used from frigate, this is a deprecated constant which will be removed in HA Core 2025.10. Use MediaType.VIDEO instead, please report it to the author of the 'frigate' custom integration\r\n2024-11-09 22:29:45.449 WARNING (ImportExecutor_0) [homeassistant.const] STATE_ALARM_ARMED_AWAY was used from xiaomi_miot, this is a deprecated constant which will be removed in HA Core 2025.11. Use AlarmControlPanelState.ARMED_AWAY instead, please report it to the author of the 'xiaomi_miot' custom integration\r\n2024-11-09 22:29:45.453 WARNING (ImportExecutor_0) [homeassistant.const] STATE_ALARM_ARMED_HOME was used from xiaomi_miot, this is a deprecated constant which will be removed in HA Core 2025.11. Use AlarmControlPanelState.ARMED_HOME instead, please report it to the author of the 'xiaomi_miot' custom integration\r\n2024-11-09 22:29:45.455 WARNING (ImportExecutor_0) [homeassistant.const] STATE_ALARM_ARMED_NIGHT was used from xiaomi_miot, this is a deprecated constant which will be removed in HA Core 2025.11. Use AlarmControlPanelState.ARMED_NIGHT instead, please report it to the author of the 'xiaomi_miot' custom integration\r\n2024-11-09 22:29:45.459 WARNING (ImportExecutor_0) [homeassistant.const] STATE_ALARM_DISARMED was used from xiaomi_miot, this is a deprecated constant which will be removed in HA Core 2025.11. Use AlarmControlPanelState.DISARMED instead, please report it to the author of the 'xiaomi_miot' custom integration\r\n2024-11-09 22:29:45.462 WARNING (ImportExecutor_0) [homeassistant.const] STATE_ALARM_TRIGGERED was used from xiaomi_miot, this is a deprecated constant which will be removed in HA Core 2025.11. Use AlarmControlPanelState.TRIGGERED instead, please report it to the author of the 'xiaomi_miot' custom integration\r\n2024-11-09 22:29:54.798 ERROR (SyncWorker_13) [aiodhcpwatcher] Cannot watch for dhcp packets: [Errno 1] Operation not permitted\r\n```\nAre you using xiaomi_gateway3 for zigbee? I do and have [had; see edit below] the same problem, I guess. I've updated to HA core-2024.11.1 two days ago and it worked until this morning, when a faulty device was plugged in and triggered the circuit breaker, what resulted in a restarted of the gateway and some other devices. The server wasn't affected, so there's no data corruption. Restarting HomeAssistant also didn't help. I've seen that the Gateway3 integration wasn't running, so I upgraded it to https://github.com/AlexxIT/XiaomiGateway3/releases/tag/v4.0.6, now that works again. I guess this integration broke some time ago on a HomeAssistand update, but the gateway was still configured for zsh, so zigbee worked and I hadn't to configure it. After the power fail it might be now in a state where it doesn't work with the old zsh configuration or something. Maybe the updated configuration is just running but not configuring the gateway correctly.\r\nGateway firmware is 1.5.0_0027 and I'm unable to update it.\r\n\r\nZHA is now still not starting and I can't configure it. I can't add another configuration and I don't want to delete the existing one, because re-pairing and -configuring all the devices is pain.\r\n\r\nIn my case (dark theme; HomeAssistant as docker container), I get an empty popup on the first try configuring it instead of the http 500 response.\r\n\r\nEdit: Some reboots later (I've disabled my zhs-enable_quirks in configuration.yaml, powercycled the gateway again, rebooted the whole server, ...) it told me the encription key has changed and it reccomends recovering it from backup, so I let it do and some devices worked again. After that I undid my changes in the configuration.yaml and made another restart to load it and now everything works fine again; problem solved for me. I can also open the configuration now without error.\r\nI guess the problem is that changing the configuration won't work until the xiaomi_gateway3 integration configures the gateway to work with it, what took some time. But it might be more complicated when the gateway can't be reached because the ip adress changed or so.\nsame problem here!\r\n\r\nI am trying to add the integration to Home Assistant Container\nI assume something upstream, container-specific broke... Or maybe some logic involved in ZHA tried to do something specific to supervised systems?\r\n\r\n\r\n\r\n> Are you using xiaomi_gateway3 for zigbee? I do and have [had; see edit below] the same problem, I guess. I've updated to HA core-2024.11.1 two days ago and it worked until this morning, when a faulty device was plugged in and triggered the circuit breaker, what resulted in a restarted of the gateway and some other devices. The server wasn't affected, so there's no data corruption. Restarting HomeAssistant also didn't help. I've seen that the Gateway3 integration wasn't running, so I upgraded it to https://github.com/AlexxIT/XiaomiGateway3/releases/tag/v4.0.6, now that works again. I guess this integration broke some time ago on a HomeAssistand update, but the gateway was still configured for zsh, so zigbee worked and I hadn't to configure it. After the power fail it might be now in a state where it doesn't work with the old zsh configuration or something. Maybe the updated configuration is just running but not configuring the gateway correctly. Gateway firmware is 1.5.0_0027 and I'm unable to update it.\r\n> \r\n> ZHA is now still not starting and I can't configure it. I can't add another configuration and I don't want to delete the existing one, because re-pairing and -configuring all the devices is pain.\r\n> \r\n> In my case (dark theme; HomeAssistant as docker container), I get an empty popup on the first try configuring it instead of the http 500 response.\r\n> \r\n> Edit: Some reboots later (I've disabled my zhs-enable_quirks in configuration.yaml, powercycled the gateway again, rebooted the whole server, ...) it told me the encription key has changed and it reccomends recovering it from backup, so I let it do and some devices worked again. After that I undid my changes in the configuration.yaml and made another restart to load it and now everything works fine again; problem solved for me. I can also open the configuration now without error. I guess the problem is that changing the configuration won't work until the xiaomi_gateway3 integration configures the gateway to work with it, what took some time. But it might be more complicated when the gateway can't be reached because the ip adress changed or so.\r\n\r\nYep, i still use it, but I don't believe it's relevant to this issue...\nSame problem. Running HA in a container and trying to configure Zigbee HA integration.\r\n```\r\n2024-11-11 13:54:50.150 ERROR (MainThread) [aiohttp.server] Error handling request\r\nTraceback (most recent call last):\r\n  File \"/usr/local/lib/python3.12/site-packages/aiohttp/web_protocol.py\", line 477, in _handle_request\r\n    resp = await request_handler(request)\r\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/local/lib/python3.12/site-packages/aiohttp/web_app.py\", line 559, in _handle\r\n    return await handler(request)\r\n           ^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/local/lib/python3.12/site-packages/aiohttp/web_middlewares.py\", line 117, in impl\r\n    return await handler(request)\r\n           ^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/src/homeassistant/homeassistant/components/http/security_filter.py\", line 92, in security_filter_middleware\r\n    return await handler(request)\r\n           ^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/src/homeassistant/homeassistant/components/http/forwarded.py\", line 83, in forwarded_middleware\r\n    return await handler(request)\r\n           ^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/src/homeassistant/homeassistant/components/http/request_context.py\", line 26, in request_context_middleware\r\n    return await handler(request)\r\n           ^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/src/homeassistant/homeassistant/components/http/ban.py\", line 86, in ban_middleware\r\n    return await handler(request)\r\n           ^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/src/homeassistant/homeassistant/components/http/auth.py\", line 242, in auth_middleware\r\n    return await handler(request)\r\n           ^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/src/homeassistant/homeassistant/components/http/headers.py\", line 32, in headers_middleware\r\n    response = await handler(request)\r\n               ^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/src/homeassistant/homeassistant/helpers/http.py\", line 73, in handle\r\n    result = await handler(request, **request.match_info)\r\n             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/src/homeassistant/homeassistant/components/http/decorators.py\", line 81, in with_admin\r\n    return await func(self, request, *args, **kwargs)\r\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/src/homeassistant/homeassistant/components/http/data_validator.py\", line 74, in wrapper\r\n    return await method(view, request, data, *args, **kwargs)\r\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/src/homeassistant/homeassistant/components/config/config_entries.py\", line 172, in post\r\n    return await self._post_impl(request, data)\r\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/src/homeassistant/homeassistant/components/config/config_entries.py\", line 179, in _post_impl\r\n    return await super()._post_impl(request, data)\r\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/src/homeassistant/homeassistant/helpers/data_entry_flow.py\", line 84, in _post_impl\r\n    result = await self._flow_mgr.async_init(\r\n             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/src/homeassistant/homeassistant/config_entries.py\", line 1301, in async_init\r\n    flow, result = await self._async_init(flow_id, handler, context, data)\r\n                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/src/homeassistant/homeassistant/config_entries.py\", line 1336, in _async_init\r\n    result = await self._async_handle_step(flow, flow.init_step, data)\r\n             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/src/homeassistant/homeassistant/data_entry_flow.py\", line 517, in _async_handle_step\r\n    result: _FlowResultT = await getattr(flow, method)(user_input)\r\n                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/src/homeassistant/homeassistant/components/zha/config_flow.py\", line 535, in async_step_user\r\n    return await self.async_step_choose_serial_port(user_input)\r\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/src/homeassistant/homeassistant/components/zha/config_flow.py\", line 177, in async_step_choose_serial_port\r\n    ports = await list_serial_ports(self.hass)\r\n            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/src/homeassistant/homeassistant/components/zha/config_flow.py\", line 108, in list_serial_ports\r\n    multipan_manager = await silabs_multiprotocol_addon.get_multiprotocol_addon_manager(\r\n                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/src/homeassistant/homeassistant/helpers/singleton.py\", line 52, in async_wrapped\r\n    result = await func(hass)\r\n             ^^^^^^^^^^^^^^^^\r\n  File \"/usr/src/homeassistant/homeassistant/components/homeassistant_hardware/silabs_multiprotocol_addon.py\", line 71, in get_multiprotocol_addon_manager\r\n    manager = MultiprotocolAddonManager(hass)\r\n              ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/src/homeassistant/homeassistant/components/homeassistant_hardware/silabs_multiprotocol_addon.py\", line 128, in __init__\r\n    super().__init__(\r\n  File \"/usr/src/homeassistant/homeassistant/components/hassio/addon_manager.py\", line 112, in __init__\r\n    self._supervisor_client = get_supervisor_client(hass)\r\n                              ^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/src/homeassistant/homeassistant/helpers/singleton.py\", line 42, in wrapped\r\n    hass.data[data_key] = func(hass)\r\n                          ^^^^^^^^^^\r\n  File \"/usr/src/homeassistant/homeassistant/components/hassio/handler.py\", line 383, in get_supervisor_client\r\n    hassio: HassIO = hass.data[DOMAIN]\r\n                     ~~~~~~~~~^^^^^^^^\r\nKeyError: 'hassio'\r\n```\nMust be a hassio issue indeed: while integration with ZHA was failing for me the whole night on the :latest or :stable version, once I pulled the previous stable (2024.10) of home assistant, it worked like a charm.\nHad the same issue on HA container. Switched to 2024.10 like @theredone-1 mentioned, fixed the problem for me. Now I am kinda hesitant to put it back on :latest ...\nRolling back HA container to 2024.10.4 resolved the issue for me too.\nSeems like an issue within the latest few updates then", "created_at": "2024-11-12T21:40:30Z"}
{"repo": "home-assistant/core", "pull_number": 130465, "instance_id": "home-assistant__core-130465", "issue_numbers": ["129344"], "base_commit": "388473ecd7adaec1658caac9f05208ee9c319223", "patch": "diff --git a/homeassistant/components/file/strings.json b/homeassistant/components/file/strings.json\nindex 60ebf451f78d78..8806c67cd96706 100644\n--- a/homeassistant/components/file/strings.json\n+++ b/homeassistant/components/file/strings.json\n@@ -18,7 +18,7 @@\n         },\n         \"data_description\": {\n           \"file_path\": \"The local file path to retrieve the sensor value from\",\n-          \"value_template\": \"A template to render the the sensors value based on the file content\",\n+          \"value_template\": \"A template to render the sensors value based on the file content\",\n           \"unit_of_measurement\": \"Unit of measurement for the sensor\"\n         }\n       },\n", "test_patch": "", "problem_statement": "File: Typo in one string\n### The problem\r\n\r\nThe word \"the\" is duplicated in this one:\r\n\r\nhttps://github.com/home-assistant/core/blob/668626b920af178a6a2850474cb4993d1e93aa58/homeassistant/components/file/strings.json#L21\r\n\r\n### What version of Home Assistant Core has the issue?\r\n\r\n2024.10.4\r\n\r\n### What was the last working version of Home Assistant Core?\r\n\r\nn/a\r\n\r\n### What type of installation are you running?\r\n\r\nHome Assistant OS\r\n\r\n### Integration causing the issue\r\n\r\nFile\r\n\r\n### Link to integration documentation on our website\r\n\r\nhttps://www.home-assistant.io/integrations/file/\r\n\r\n\n", "hints_text": "\nHey there @fabaff, mind taking a look at this issue as it has been labeled with an integration (`file`) you are listed as a [code owner](https://github.com/home-assistant/core/blob/dev/CODEOWNERS#L458) for? Thanks!\n\n<details>\n<summary>Code owner commands</summary>\n\n\nCode owners of `file` can trigger bot actions by commenting:\n\n- `@home-assistant close` Closes the issue.\n- `@home-assistant rename Awesome new title` Renames the issue.\n- `@home-assistant reopen` Reopen the issue.\n- `@home-assistant unassign file` Removes the current integration label and assignees on the issue, add the integration domain after the command.\n- `@home-assistant add-label needs-more-information` Add a label (needs-more-information, problem in dependency, problem in custom component) to the issue.\n- `@home-assistant remove-label needs-more-information` Remove a label (needs-more-information, problem in dependency, problem in custom component) on the issue.\n\n</details>\n\n\n<sub><sup>(message by CodeOwnersMention)</sup></sub>\n\n---\n\n[file documentation](https://www.home-assistant.io/integrations/file)\n[file source](https://github.com/home-assistant/core/tree/dev/homeassistant/components/file)\n<sub><sup>(message by IssueLinks)</sup></sub>", "created_at": "2024-11-12T20:19:17Z"}
{"repo": "home-assistant/core", "pull_number": 130456, "instance_id": "home-assistant__core-130456", "issue_numbers": ["45137"], "base_commit": "158b0c8ce2722c591522015c1d947dc6640e89c4", "patch": "diff --git a/homeassistant/components/jewish_calendar/entity.py b/homeassistant/components/jewish_calendar/entity.py\nindex ad5ac8e21374ab..1d2a6e45c0a8b2 100644\n--- a/homeassistant/components/jewish_calendar/entity.py\n+++ b/homeassistant/components/jewish_calendar/entity.py\n@@ -44,6 +44,7 @@ def __init__(\n         data = config_entry.runtime_data\n         self._location = data.location\n         self._hebrew = data.language == \"hebrew\"\n+        self._language = data.language\n         self._candle_lighting_offset = data.candle_lighting_offset\n         self._havdalah_offset = data.havdalah_offset\n         self._diaspora = data.diaspora\ndiff --git a/homeassistant/components/jewish_calendar/manifest.json b/homeassistant/components/jewish_calendar/manifest.json\nindex 6d2fe8ecfa1e01..aca45320002d9f 100644\n--- a/homeassistant/components/jewish_calendar/manifest.json\n+++ b/homeassistant/components/jewish_calendar/manifest.json\n@@ -6,6 +6,6 @@\n   \"documentation\": \"https://www.home-assistant.io/integrations/jewish_calendar\",\n   \"iot_class\": \"calculated\",\n   \"loggers\": [\"hdate\"],\n-  \"requirements\": [\"hdate==0.10.9\"],\n+  \"requirements\": [\"hdate==0.11.1\"],\n   \"single_config_entry\": true\n }\ndiff --git a/homeassistant/components/jewish_calendar/sensor.py b/homeassistant/components/jewish_calendar/sensor.py\nindex c32647af07c6de..d3e70eb411c42f 100644\n--- a/homeassistant/components/jewish_calendar/sensor.py\n+++ b/homeassistant/components/jewish_calendar/sensor.py\n@@ -275,15 +275,18 @@ def get_state(\n             # Compute the weekly portion based on the upcoming shabbat.\n             return after_tzais_date.upcoming_shabbat.parasha\n         if self.entity_description.key == \"holiday\":\n-            self._attrs = {\n-                \"id\": after_shkia_date.holiday_name,\n-                \"type\": after_shkia_date.holiday_type.name,\n-                \"type_id\": after_shkia_date.holiday_type.value,\n-            }\n-            self._attr_options = [\n-                h.description.hebrew.long if self._hebrew else h.description.english\n-                for h in htables.HOLIDAYS\n-            ]\n+            _id = _type = _type_id = \"\"\n+            _holiday_type = after_shkia_date.holiday_type\n+            if isinstance(_holiday_type, list):\n+                _id = \", \".join(after_shkia_date.holiday_name)\n+                _type = \", \".join([_htype.name for _htype in _holiday_type])\n+                _type_id = \", \".join([str(_htype.value) for _htype in _holiday_type])\n+            else:\n+                _id = after_shkia_date.holiday_name\n+                _type = _holiday_type.name\n+                _type_id = _holiday_type.value\n+            self._attrs = {\"id\": _id, \"type\": _type, \"type_id\": _type_id}\n+            self._attr_options = htables.get_all_holidays(self._language)\n \n             return after_shkia_date.holiday_description\n         if self.entity_description.key == \"omer_count\":\ndiff --git a/requirements_all.txt b/requirements_all.txt\nindex 0a4b66f18ce749..6d8ed2447609f2 100644\n--- a/requirements_all.txt\n+++ b/requirements_all.txt\n@@ -1099,7 +1099,7 @@ hass-splunk==0.1.1\n hassil==2.0.2\n \n # homeassistant.components.jewish_calendar\n-hdate==0.10.9\n+hdate==0.11.1\n \n # homeassistant.components.heatmiser\n heatmiserV3==2.0.3\n", "test_patch": "diff --git a/requirements_test_all.txt b/requirements_test_all.txt\nindex 56f67f8541a7aa..bd90b93050f11b 100644\n--- a/requirements_test_all.txt\n+++ b/requirements_test_all.txt\n@@ -934,7 +934,7 @@ hass-nabucasa==0.84.0\n hassil==2.0.2\n \n # homeassistant.components.jewish_calendar\n-hdate==0.10.9\n+hdate==0.11.1\n \n # homeassistant.components.here_travel_time\n here-routing==1.0.1\ndiff --git a/tests/components/jewish_calendar/test_sensor.py b/tests/components/jewish_calendar/test_sensor.py\nindex cb054751f678e0..4897ef7749b7e3 100644\n--- a/tests/components/jewish_calendar/test_sensor.py\n+++ b/tests/components/jewish_calendar/test_sensor.py\n@@ -93,7 +93,26 @@ async def test_jewish_calendar_hebrew(hass: HomeAssistant) -> None:\n             \"id\": \"rosh_hashana_i\",\n             \"type\": \"YOM_TOV\",\n             \"type_id\": 1,\n-            \"options\": [h.description.english for h in htables.HOLIDAYS],\n+            \"options\": htables.get_all_holidays(\"english\"),\n+        },\n+    ),\n+    (\n+        dt(2024, 12, 31),\n+        \"UTC\",\n+        31.778,\n+        35.235,\n+        \"english\",\n+        \"holiday\",\n+        False,\n+        \"Chanukah, Rosh Chodesh\",\n+        {\n+            \"device_class\": \"enum\",\n+            \"friendly_name\": \"Jewish Calendar Holiday\",\n+            \"icon\": \"mdi:calendar-star\",\n+            \"id\": \"chanukah, rosh_chodesh\",\n+            \"type\": \"MELACHA_PERMITTED_HOLIDAY, ROSH_CHODESH\",\n+            \"type_id\": \"4, 10\",\n+            \"options\": htables.get_all_holidays(\"english\"),\n         },\n     ),\n     (\n@@ -180,6 +199,7 @@ async def test_jewish_calendar_hebrew(hass: HomeAssistant) -> None:\n     \"date_output_hebrew\",\n     \"holiday\",\n     \"holiday_english\",\n+    \"holiday_multiple\",\n     \"torah_reading\",\n     \"first_stars_ny\",\n     \"first_stars_jerusalem\",\n", "problem_statement": "Add Rosh Chodesh Sensor to Jewish Calendar\n<!-- READ THIS FIRST:\r\n  - If you need additional help with this template, please refer to https://www.home-assistant.io/help/reporting_issues/\r\n  - Make sure you are running the latest version of Home Assistant before reporting an issue: https://github.com/home-assistant/core/releases\r\n  - Do not report issues for integrations if you are using custom components or integrations.\r\n  - Provide as many details as possible. Paste logs, configuration samples and code into the backticks.\r\n  DO NOT DELETE ANY TEXT from this template! Otherwise, your issue may be closed without comment.\r\n-->\r\n## The problem\r\n<!-- \r\n  Describe the issue you are experiencing here to communicate to the\r\n  maintainers. Tell us what you were trying to do and what happened.\r\n-->\r\nCan you please add a Rosh Chodesh sensor to Jewish Calendar? Thank you!\r\n\r\n## Environment\r\n<!--\r\n  Provide details about the versions you are using, which helps us to reproduce\r\n  and find the issue quicker. Version information is found in the\r\n  Home Assistant frontend: Configuration -> Info.\r\n-->\r\n\r\n- Home Assistant Core release with the issue: \r\n- Last working Home Assistant Core release (if known): \r\n- Operating environment (OS/Container/Supervised/Core): \r\n- Integration causing this issue: \r\nhttps://www.home-assistant.io/integrations/jewish_calendar/\r\n- Link to integration documentation on our website: \r\n\r\n## Problem-relevant `configuration.yaml`\r\n<!--\r\n-->\r\n\r\njewish_calendar:\r\n\r\n## Traceback/Error logs\r\n<!--\r\n  If you come across any trace or error logs, please provide them.\r\n-->\r\n\r\n```txt\r\n\r\n```\r\n\r\n## Additional information\r\n\r\n\n", "hints_text": "[jewish_calendar documentation](https://www.home-assistant.io/integrations/jewish_calendar)\n[jewish_calendar source](https://github.com/home-assistant/core/tree/dev/homeassistant/components/jewish_calendar)\n<sub><sup>(message by IssueLinks)</sup></sub>\nHey there @tsvi, mind taking a look at this issue as its been labeled with an integration (`jewish_calendar`) you are listed as a [codeowner](https://github.com/home-assistant/core/blob/dev/CODEOWNERS#L234) for? Thanks!\n<sub><sup>(message by CodeOwnersMention)</sup></sub>\nDuplicate of #29410\r\nRequires the implementation of py-libhdate/py-libhdate#51\r\n\r\nOn my never-ending to-do list \ud83d\ude03 \nIt may be easier to implement it as a binary sensor for the time being? What needs to be done?\nAt the moment libhdate doesn't provide such an indicator.\r\n\r\nIt could be implemented in home assistant by checking the value of the day in the hdate object being 1 or 30, although usually, the maintainers of home assistant shy away from implementing such code in home assistant.\r\n\r\nI took a look at the code and it would become a mess as currently, our only binary sensor is part of the Zmanim class and not part of the HDate class. So creating such a binary sensor requires a serious rewrite of https://github.com/home-assistant/core/blob/dev/homeassistant/components/jewish_calendar/binary_sensor.py\r\n\r\nI'd prefer investing my time in rewriting libhdate to provide a cleaner API.\r\n\nThere hasn't been any activity on this issue recently. Due to the high number of incoming GitHub notifications, we have to clean some of the old issues, as many of them have already been resolved with the latest updates.\nPlease make sure to update to the latest Home Assistant version and check if that solves the issue. Let us know if that works for you by adding a comment \ud83d\udc4d\nThis issue has now been marked as stale and will be closed if no further activity occurs. Thank you for your contributions.", "created_at": "2024-11-12T16:34:25Z"}
{"repo": "home-assistant/core", "pull_number": 130455, "instance_id": "home-assistant__core-130455", "issue_numbers": ["130374"], "base_commit": "ac0c75a598e4e7ee2c27b37e19a9ec5cefb8cd5e", "patch": "diff --git a/homeassistant/components/statistics/strings.json b/homeassistant/components/statistics/strings.json\nindex a060c88da249c..3e6fec9d986fb 100644\n--- a/homeassistant/components/statistics/strings.json\n+++ b/homeassistant/components/statistics/strings.json\n@@ -23,10 +23,10 @@\n       \"state_characteristic\": {\n         \"description\": \"Read the documention for further details on available options and how to use them.\",\n         \"data\": {\n-          \"state_characteristic\": \"State_characteristic\"\n+          \"state_characteristic\": \"Statistic characteristic\"\n         },\n         \"data_description\": {\n-          \"state_characteristic\": \"The characteristic that should be used as the state of the statistics sensor.\"\n+          \"state_characteristic\": \"The statistic characteristic that should be used as the state of the sensor.\"\n         }\n       },\n       \"options\": {\n", "test_patch": "", "problem_statement": "Statistics: Leftover underscore character in name for \"state_characteristic\" field\n### The problem\r\n\r\nThe label for the \"state_characteristic\" field has a leftover underscore in the middle:\r\n\r\n![Screenshot 2024-11-11 17 11 33](https://github.com/user-attachments/assets/7dddbc28-88ab-4f85-9c2d-6350e5c85d68)\r\n\r\nThis should be just\r\n\r\n     State characteristic\r\n\r\nso all translators know that this can be fully translated into their language.\r\n\r\nFound here:\r\n\r\nhttps://github.com/home-assistant/core/blob/388c5807ea3339d51aea5aac01bd325f4c2ead67/homeassistant/components/statistics/strings.json#L26\r\n\r\n\r\nFor better translation you might want to use\r\n\r\n    Statistic characteristic\r\n\r\nhere instead, alsong with changing this\r\n\r\nhttps://github.com/home-assistant/core/blob/388c5807ea3339d51aea5aac01bd325f4c2ead67/homeassistant/components/statistics/strings.json#L29\r\n\r\nto\r\n\r\n    The statistic characteristic that should be used as the state of the sensor.\r\n\r\nIn German that would become the shorter\r\n\r\n    Das Statistikmerkmal, das den Status des Sensors bestimmen soll.\r\n\r\n\r\n### What version of Home Assistant Core has the issue?\r\n\r\ncore-2024.11.1\r\n\r\n### Integration causing the issue\r\n\r\nStatistics\r\n\r\n### Link to integration documentation on our website\r\n\r\nhttps://www.home-assistant.io/integrations/statistics\r\n\n", "hints_text": "\nHey there @thomdietrich, mind taking a look at this issue as it has been labeled with an integration (`statistics`) you are listed as a [code owner](https://github.com/home-assistant/core/blob/dev/CODEOWNERS#L1412) for? Thanks!\n\n<details>\n<summary>Code owner commands</summary>\n\n\nCode owners of `statistics` can trigger bot actions by commenting:\n\n- `@home-assistant close` Closes the issue.\n- `@home-assistant rename Awesome new title` Renames the issue.\n- `@home-assistant reopen` Reopen the issue.\n- `@home-assistant unassign statistics` Removes the current integration label and assignees on the issue, add the integration domain after the command.\n- `@home-assistant add-label needs-more-information` Add a label (needs-more-information, problem in dependency, problem in custom component) to the issue.\n- `@home-assistant remove-label needs-more-information` Remove a label (needs-more-information, problem in dependency, problem in custom component) on the issue.\n\n</details>\n\n\n<sub><sup>(message by CodeOwnersMention)</sup></sub>\n\n---\n\n[statistics documentation](https://www.home-assistant.io/integrations/statistics)\n[statistics source](https://github.com/home-assistant/core/tree/dev/homeassistant/components/statistics)\n<sub><sup>(message by IssueLinks)</sup></sub>\nHey Norbert, thanks for the report!\r\n\r\nCC @gjohansson-ST ", "created_at": "2024-11-12T16:17:52Z"}
{"repo": "home-assistant/core", "pull_number": 130446, "instance_id": "home-assistant__core-130446", "issue_numbers": ["129827"], "base_commit": "ac0c75a598e4e7ee2c27b37e19a9ec5cefb8cd5e", "patch": "diff --git a/homeassistant/components/water_heater/strings.json b/homeassistant/components/water_heater/strings.json\nindex 741b277d84df65..07e132a0b5bb58 100644\n--- a/homeassistant/components/water_heater/strings.json\n+++ b/homeassistant/components/water_heater/strings.json\n@@ -1,4 +1,5 @@\n {\n+  \"title\": \"Water heater\",\n   \"device_automation\": {\n     \"action_type\": {\n       \"turn_on\": \"[%key:common::device_automation::action_type::turn_on%]\",\n@@ -7,7 +8,7 @@\n   },\n   \"entity_component\": {\n     \"_\": {\n-      \"name\": \"Water heater\",\n+      \"name\": \"[%key:component::water_heater::title%]\",\n       \"state\": {\n         \"off\": \"[%key:common::state::off%]\",\n         \"eco\": \"Eco\",\n", "test_patch": "", "problem_statement": "Water Heater: \"title\" key seems to be missing for proper translation in actions\n### The problem\r\n\r\nThe translatable name of the Water heater class is present in\r\n\r\nhttps://github.com/home-assistant/core/blob/0278735dbfc4e64b146faed2e3ac3c997703e782/homeassistant/components/water_heater/strings.json#L10\r\n\r\nbut it does not show when you add any of its actions in the UI:\r\n\r\n![Screenshot 2024-11-04 18 21 30](https://github.com/user-attachments/assets/17c1a1f5-dfa5-4a58-840a-394ee3c3f780)\r\n\r\nBut everything else does, as you can see above.\r\n\r\nFor other device classes like lock, vacuum, valve where this works as it's contained in the \"title\" key:\r\n\r\nhttps://github.com/home-assistant/core/blob/0278735dbfc4e64b146faed2e3ac3c997703e782/homeassistant/components/lock/strings.json#L2-L4\r\n\r\nSo I assume that is what is missing here.\r\n\r\nEdit:\r\nTo add some value to the necessary PR consider rewording:\r\n\r\nhttps://github.com/home-assistant/core/blob/0278735dbfc4e64b146faed2e3ac3c997703e782/homeassistant/components/water_heater/strings.json#L97-L98\r\n\r\nbecause the term \"operation list\" is not defined anywhere. I assume it should say \"list of operation modes\" instead.\r\n\r\n\r\n\r\n### What version of Home Assistant Core has the issue?\r\n\r\n2024.11.0b3\r\n\r\n### What was the last working version of Home Assistant Core?\r\n\r\nn/a\r\n\r\n### What type of installation are you running?\r\n\r\nHome Assistant OS\r\n\r\n### Integration causing the issue\r\n\r\nWater heater\r\n\r\n### Link to integration documentation on our website\r\n\r\nhttps://www.home-assistant.io/integrations/water_heater/\r\n\r\n\n", "hints_text": "\nHey there @home-assistant/core, mind taking a look at this issue as it has been labeled with an integration (`water_heater`) you are listed as a [code owner](https://github.com/home-assistant/core/blob/dev/CODEOWNERS#L1635) for? Thanks!\n\n<details>\n<summary>Code owner commands</summary>\n\n\nCode owners of `water_heater` can trigger bot actions by commenting:\n\n- `@home-assistant close` Closes the issue.\n- `@home-assistant rename Awesome new title` Renames the issue.\n- `@home-assistant reopen` Reopen the issue.\n- `@home-assistant unassign water_heater` Removes the current integration label and assignees on the issue, add the integration domain after the command.\n- `@home-assistant add-label needs-more-information` Add a label (needs-more-information, problem in dependency, problem in custom component) to the issue.\n- `@home-assistant remove-label needs-more-information` Remove a label (needs-more-information, problem in dependency, problem in custom component) on the issue.\n\n</details>\n\n\n<sub><sup>(message by CodeOwnersMention)</sup></sub>\n\n---\n\n[water_heater documentation](https://www.home-assistant.io/integrations/water_heater)\n[water_heater source](https://github.com/home-assistant/core/tree/dev/homeassistant/components/water_heater)\n<sub><sup>(message by IssueLinks)</sup></sub>\nThe first part of this issue is a frontend thing\n@joostlek Can you take of that frontend part, or some hint how I should file the bug there?\nI think this bug report would be perfect for frontend, except for that last part about operation list, that's for core\nI just wondered if there is actually a missing key in Core here so frontend is not to blame:\r\n\r\nAs I pointed out the working device classes contain their name in a \"title\" key while this one lacks it.\r\nThere is just a \"name\" key at a completely different level:\r\n\r\n    component::water_heater::entity_component::_::name\r\n\r\n    component::lock::title\r\n    component::vacuum::title\r\n    component::valve::title\r\n\r\n\nOh that might be the case, sharp", "created_at": "2024-11-12T15:21:07Z"}
{"repo": "home-assistant/core", "pull_number": 130444, "instance_id": "home-assistant__core-130444", "issue_numbers": ["124725"], "base_commit": "ac0c75a598e4e7ee2c27b37e19a9ec5cefb8cd5e", "patch": "diff --git a/homeassistant/components/starline/binary_sensor.py b/homeassistant/components/starline/binary_sensor.py\nindex 0383fc8ade63d6..69f0ae06d02ae5 100644\n--- a/homeassistant/components/starline/binary_sensor.py\n+++ b/homeassistant/components/starline/binary_sensor.py\n@@ -41,6 +41,11 @@\n         translation_key=\"doors\",\n         device_class=BinarySensorDeviceClass.LOCK,\n     ),\n+    BinarySensorEntityDescription(\n+        key=\"run\",\n+        translation_key=\"is_running\",\n+        device_class=BinarySensorDeviceClass.RUNNING,\n+    ),\n     BinarySensorEntityDescription(\n         key=\"hfree\",\n         translation_key=\"handsfree\",\ndiff --git a/homeassistant/components/starline/icons.json b/homeassistant/components/starline/icons.json\nindex 8a4f85a89bf7c7..e240978ce74fd6 100644\n--- a/homeassistant/components/starline/icons.json\n+++ b/homeassistant/components/starline/icons.json\n@@ -12,6 +12,9 @@\n       },\n       \"moving_ban\": {\n         \"default\": \"mdi:car-off\"\n+      },\n+      \"is_running\": {\n+        \"default\": \"mdi:speedometer\"\n       }\n     },\n     \"button\": {\ndiff --git a/homeassistant/components/starline/strings.json b/homeassistant/components/starline/strings.json\nindex 14a8ed5a035454..a330354e5a9c2a 100644\n--- a/homeassistant/components/starline/strings.json\n+++ b/homeassistant/components/starline/strings.json\n@@ -63,6 +63,9 @@\n       },\n       \"moving_ban\": {\n         \"name\": \"Moving ban\"\n+      },\n+      \"is_running\": {\n+        \"name\": \"Running\"\n       }\n     },\n     \"device_tracker\": {\n", "test_patch": "", "problem_statement": "Add sensor run from starline api topic run\n### The problem\n\nPlease Add sensor run from starline api topic run \n\n### What version of Home Assistant Core has the issue?\n\ncore-2024.8.2\n\n### What was the last working version of Home Assistant Core?\n\n_No response_\n\n### What type of installation are you running?\n\nHome Assistant Supervised\n\n### Integration causing the issue\n\nStarline\n\n### Link to integration documentation on our website\n\nhttps://www.home-assistant.io/integrations/starline\n\n### Diagnostics information\n\n_No response_\n\n### Example YAML snippet\n\n_No response_\n\n### Anything in the logs that might be useful for us?\n\n_No response_\n\n### Additional information\n\n_No response_\n", "hints_text": "\nHey there @anonym-tsk, mind taking a look at this issue as it has been labeled with an integration (`starline`) you are listed as a [code owner](https://github.com/home-assistant/core/blob/dev/CODEOWNERS#L1374) for? Thanks!\n\n<details>\n<summary>Code owner commands</summary>\n\n\nCode owners of `starline` can trigger bot actions by commenting:\n\n- `@home-assistant close` Closes the issue.\n- `@home-assistant rename Awesome new title` Renames the issue.\n- `@home-assistant reopen` Reopen the issue.\n- `@home-assistant unassign starline` Removes the current integration label and assignees on the issue, add the integration domain after the command.\n- `@home-assistant add-label needs-more-information` Add a label (needs-more-information, problem in dependency, problem in custom component) to the issue.\n- `@home-assistant remove-label needs-more-information` Remove a label (needs-more-information, problem in dependency, problem in custom component) on the issue.\n\n</details>\n\n\n<sub><sup>(message by CodeOwnersMention)</sup></sub>\n\n---\n\n[starline documentation](https://www.home-assistant.io/integrations/starline)\n[starline source](https://github.com/home-assistant/core/tree/dev/homeassistant/components/starline)\n<sub><sup>(message by IssueLinks)</sup></sub>", "created_at": "2024-11-12T15:09:55Z"}
{"repo": "home-assistant/core", "pull_number": 130443, "instance_id": "home-assistant__core-130443", "issue_numbers": ["129943"], "base_commit": "ac0c75a598e4e7ee2c27b37e19a9ec5cefb8cd5e", "patch": "diff --git a/homeassistant/components/switch_as_x/config_flow.py b/homeassistant/components/switch_as_x/config_flow.py\nindex 37df3affbad16..aa9f1d411cef4 100644\n--- a/homeassistant/components/switch_as_x/config_flow.py\n+++ b/homeassistant/components/switch_as_x/config_flow.py\n@@ -18,12 +18,12 @@\n from .const import CONF_INVERT, CONF_TARGET_DOMAIN, DOMAIN\n \n TARGET_DOMAIN_OPTIONS = [\n-    selector.SelectOptionDict(value=Platform.COVER, label=\"Cover\"),\n-    selector.SelectOptionDict(value=Platform.FAN, label=\"Fan\"),\n-    selector.SelectOptionDict(value=Platform.LIGHT, label=\"Light\"),\n-    selector.SelectOptionDict(value=Platform.LOCK, label=\"Lock\"),\n-    selector.SelectOptionDict(value=Platform.SIREN, label=\"Siren\"),\n-    selector.SelectOptionDict(value=Platform.VALVE, label=\"Valve\"),\n+    Platform.COVER,\n+    Platform.FAN,\n+    Platform.LIGHT,\n+    Platform.LOCK,\n+    Platform.SIREN,\n+    Platform.VALVE,\n ]\n \n CONFIG_FLOW = {\n@@ -35,7 +35,9 @@\n                 ),\n                 vol.Optional(CONF_INVERT, default=False): selector.BooleanSelector(),\n                 vol.Required(CONF_TARGET_DOMAIN): selector.SelectSelector(\n-                    selector.SelectSelectorConfig(options=TARGET_DOMAIN_OPTIONS),\n+                    selector.SelectSelectorConfig(\n+                        options=TARGET_DOMAIN_OPTIONS, translation_key=\"target_domain\"\n+                    ),\n                 ),\n             }\n         )\ndiff --git a/homeassistant/components/switch_as_x/strings.json b/homeassistant/components/switch_as_x/strings.json\nindex 81567ef9e40fa..9c3db05231bac 100644\n--- a/homeassistant/components/switch_as_x/strings.json\n+++ b/homeassistant/components/switch_as_x/strings.json\n@@ -26,5 +26,17 @@\n         }\n       }\n     }\n+  },\n+  \"selector\": {\n+    \"target_domain\": {\n+      \"options\": {\n+        \"cover\": \"[%key:component::cover::title%]\",\n+        \"fan\": \"[%key:component::fan::title%]\",\n+        \"light\": \"[%key:component::light::title%]\",\n+        \"lock\": \"[%key:component::lock::title%]\",\n+        \"siren\": \"[%key:component::siren::title%]\",\n+        \"valve\": \"[%key:component::valve::title%]\"\n+      }\n+    }\n   }\n }\n", "test_patch": "", "problem_statement": "Helper \"Change device type of a switch\" does not show localized device types\n### Describe the issue you are experiencing\r\n\r\nThe popup menu for the Helper type \"Change device type of a switch\" does not show the translated names of the devices classes while the rest of the UI is fully localized:\r\n\r\n![image](https://github.com/user-attachments/assets/24e3ea62-501a-4b60-972d-ddf2c9b29a4e)\r\n\r\n\r\n### Describe the behavior you expected\r\n\r\nIt should show them translated as the corresponding edit dialog for the Helper entity does:\r\n\r\n![image](https://github.com/user-attachments/assets/92be32ba-c4fb-4868-9052-b34989b783de)\r\n\r\nNote that \"siren\" still isn't showing up translated, that's an older issue that's still pending:\r\nhttps://github.com/home-assistant/frontend/issues/22415\r\n\r\nPerhaps you can fix both at once.\r\n\r\n### Steps to reproduce the issue\r\n\r\n1. Change your UI language to something different than English.\r\n2. Create a new Helper \"Change device type of a switch\"\r\n3. Click on the New Type field to reveal the popup menu.\r\n\r\n\r\n\r\n### What version of Home Assistant Core has the issue?\r\n\r\ncore-2024.11.0b5\r\n\r\n\n", "hints_text": "\nHey there @home-assistant/core, mind taking a look at this issue as it has been labeled with an integration (`switch_as_x`) you are listed as a [code owner](https://github.com/home-assistant/core/blob/dev/CODEOWNERS#L1443) for? Thanks!\n\n<details>\n<summary>Code owner commands</summary>\n\n\nCode owners of `switch_as_x` can trigger bot actions by commenting:\n\n- `@home-assistant close` Closes the issue.\n- `@home-assistant rename Awesome new title` Renames the issue.\n- `@home-assistant reopen` Reopen the issue.\n- `@home-assistant unassign switch_as_x` Removes the current integration label and assignees on the issue, add the integration domain after the command.\n- `@home-assistant add-label needs-more-information` Add a label (needs-more-information, problem in dependency, problem in custom component) to the issue.\n- `@home-assistant remove-label needs-more-information` Remove a label (needs-more-information, problem in dependency, problem in custom component) on the issue.\n\n</details>\n\n\n<sub><sup>(message by CodeOwnersMention)</sup></sub>\n\n---\n\n[switch_as_x documentation](https://www.home-assistant.io/integrations/switch_as_x)\n[switch_as_x source](https://github.com/home-assistant/core/tree/dev/homeassistant/components/switch_as_x)\n<sub><sup>(message by IssueLinks)</sup></sub>", "created_at": "2024-11-12T15:09:18Z"}
{"repo": "home-assistant/core", "pull_number": 130430, "instance_id": "home-assistant__core-130430", "issue_numbers": ["128332"], "base_commit": "093b16c7235a0ee69d88ff102e2838a747a96692", "patch": "diff --git a/homeassistant/components/ring/event.py b/homeassistant/components/ring/event.py\nindex e6d9d25542fad3..71a4bc8aea5d3c 100644\n--- a/homeassistant/components/ring/event.py\n+++ b/homeassistant/components/ring/event.py\n@@ -96,7 +96,7 @@ def _get_coordinator_alert(self) -> RingAlert | None:\n \n     @callback\n     def _handle_coordinator_update(self) -> None:\n-        if alert := self._get_coordinator_alert():\n+        if (alert := self._get_coordinator_alert()) and not alert.is_update:\n             self._async_handle_event(alert.kind)\n         super()._handle_coordinator_update()\n \n", "test_patch": "", "problem_statement": "Ring event triggered multiple times\n### The problem\n\nThe ring (ding) event is triggered multiple times.\r\nSo If you ring your doorbell 1 time, you get 10 events for the ring event.\r\nThis causes big problems with e.g. automations which are based on the ring event.\n\n### What version of Home Assistant Core has the issue?\n\n2024.10.2\n\n### What was the last working version of Home Assistant Core?\n\n_No response_\n\n### What type of installation are you running?\n\nHome Assistant OS\n\n### Integration causing the issue\n\nRing\n\n### Link to integration documentation on our website\n\nhttps://www.home-assistant.io/integrations/ring/\n\n### Diagnostics information\n\n[config_entry-ring-01J9VW48QYP74XKPAAY39671HQ.json](https://github.com/user-attachments/files/17360137/config_entry-ring-01J9VW48QYP74XKPAAY39671HQ.json)\r\n\n\n### Example YAML snippet\n\n_No response_\n\n### Anything in the logs that might be useful for us?\n\n_No response_\n\n### Additional information\n\n_No response_\n", "hints_text": "\nHey there @sdb9696, mind taking a look at this issue as it has been labeled with an integration (`ring`) you are listed as a [code owner](https://github.com/home-assistant/core/blob/dev/CODEOWNERS#L1228) for? Thanks!\n\n<details>\n<summary>Code owner commands</summary>\n\n\nCode owners of `ring` can trigger bot actions by commenting:\n\n- `@home-assistant close` Closes the issue.\n- `@home-assistant rename Awesome new title` Renames the issue.\n- `@home-assistant reopen` Reopen the issue.\n- `@home-assistant unassign ring` Removes the current integration label and assignees on the issue, add the integration domain after the command.\n- `@home-assistant add-label needs-more-information` Add a label (needs-more-information, problem in dependency, problem in custom component) to the issue.\n- `@home-assistant remove-label needs-more-information` Remove a label (needs-more-information, problem in dependency, problem in custom component) on the issue.\n\n</details>\n\n\n<sub><sup>(message by CodeOwnersMention)</sup></sub>\n\n---\n\n[ring documentation](https://www.home-assistant.io/integrations/ring)\n[ring source](https://github.com/home-assistant/core/tree/dev/homeassistant/components/ring)\n<sub><sup>(message by IssueLinks)</sup></sub>\nI think there are some issues with the integration:\r\n\r\n- \"event_type: ding\" sets in case of a recognized ring event the timestamp as the state\r\n- if you unlock the door the timestamp of the unlock event (event_types: intercom_unlock) is set but the timestamp for the \"event_type: ding\" is set to the same. \r\n\r\nThis means, if you open the door, the state of ring is changed which causes this kind of loop as an additional ring event / change is recognized.\r\n\r\nWhat I would expect is, that in case of ring the event is set for 1 second and then changed back. At the momemt the timestamp is set und keeps as long until the next ring event is recognized.\r\n\r\nCompared to the nuki integration this is a different behavior and in my opionen difficult to use in automation ect. as you always have to check the timestamp and not the current state of a sensor.\r\n\r\n\nSame Problem Here. \r\n![Screenshot_2024-10-27-18-12-10-095_io homeassistant companion android-edit](https://github.com/user-attachments/assets/36de5b48-b2d1-4e5c-8e44-310f9965f021)\r\n\nToday i got also 2 events at the same time. And 1 event after 80s. All from 1 button press.\r\n\r\n![image](https://github.com/user-attachments/assets/663c7c3b-cafc-411c-b6c6-75089d0564af)\r\n\nI'm having the same problem, making the integration unusable... I'm obviously interested in a solution.\nI switched to the MQTT integration. This one works fine: https://github.com/tsightler/ring-mqtt\nI have now added a template condition.\r\n\r\n{{ (trigger.to_state.last_changed | as_datetime - trigger.from_state.last_changed | as_datetime).total_seconds() | int > 180 }}\r\n\r\nThis means that the triggers must be at least 180s apart.\r\nThe time is the same as the time blocked by the ring.\nAre you also getting the ding event and the door unlock event being updated at the same time?\nI only have the Ring Ding Event. I don't have a smart door.\nAnd this is the event entity or the binary_sensor entity that is triggering multiple?\nIt is the event trigger.  (event.something)\nOk so been looking into this some more and it appears that battery doorbells actually send two events for a ding, one initially and then another very soon after including a snapshot image. I'll look into a fix. You shouldn't need 180s gap as it seems to be within a couple of seconds.", "created_at": "2024-11-12T13:17:32Z"}
{"repo": "home-assistant/core", "pull_number": 130419, "instance_id": "home-assistant__core-130419", "issue_numbers": ["128180", "128180"], "base_commit": "ac0c75a598e4e7ee2c27b37e19a9ec5cefb8cd5e", "patch": "diff --git a/homeassistant/components/ring/manifest.json b/homeassistant/components/ring/manifest.json\nindex 63c47cb2979b6..e431c68008132 100644\n--- a/homeassistant/components/ring/manifest.json\n+++ b/homeassistant/components/ring/manifest.json\n@@ -30,5 +30,5 @@\n   \"iot_class\": \"cloud_polling\",\n   \"loggers\": [\"ring_doorbell\"],\n   \"quality_scale\": \"silver\",\n-  \"requirements\": [\"ring-doorbell==0.9.9\"]\n+  \"requirements\": [\"ring-doorbell==0.9.12\"]\n }\ndiff --git a/requirements_all.txt b/requirements_all.txt\nindex 67c7c99114698..4df0b19900868 100644\n--- a/requirements_all.txt\n+++ b/requirements_all.txt\n@@ -2562,7 +2562,7 @@ rfk101py==0.0.1\n rflink==0.0.66\n \n # homeassistant.components.ring\n-ring-doorbell==0.9.9\n+ring-doorbell==0.9.12\n \n # homeassistant.components.fleetgo\n ritassist==0.9.2\n", "test_patch": "diff --git a/requirements_test_all.txt b/requirements_test_all.txt\nindex 048f0ac7d7601..e420c910058de 100644\n--- a/requirements_test_all.txt\n+++ b/requirements_test_all.txt\n@@ -2050,7 +2050,7 @@ reolink-aio==0.10.4\n rflink==0.0.66\n \n # homeassistant.components.ring\n-ring-doorbell==0.9.9\n+ring-doorbell==0.9.12\n \n # homeassistant.components.roku\n rokuecp==0.19.3\n", "problem_statement": "Ring Doorbell Elite Motion Entity missing\n### The problem\n\nAfter update the motion detection for Doorbell Elite is not available anymore. \n\n### What version of Home Assistant Core has the issue?\n\n2024.10.1\n\n### What was the last working version of Home Assistant Core?\n\n_No response_\n\n### What type of installation are you running?\n\nHome Assistant OS\n\n### Integration causing the issue\n\nRing\n\n### Link to integration documentation on our website\n\nhttps://www.home-assistant.io/integrations/ring/\n\n### Diagnostics information\n\n_No response_\n\n### Example YAML snippet\n\n_No response_\n\n### Anything in the logs that might be useful for us?\n\n_No response_\n\n### Additional information\n\n_No response_\nRing Doorbell Elite Motion Entity missing\n### The problem\n\nAfter update the motion detection for Doorbell Elite is not available anymore. \n\n### What version of Home Assistant Core has the issue?\n\n2024.10.1\n\n### What was the last working version of Home Assistant Core?\n\n_No response_\n\n### What type of installation are you running?\n\nHome Assistant OS\n\n### Integration causing the issue\n\nRing\n\n### Link to integration documentation on our website\n\nhttps://www.home-assistant.io/integrations/ring/\n\n### Diagnostics information\n\n_No response_\n\n### Example YAML snippet\n\n_No response_\n\n### Anything in the logs that might be useful for us?\n\n_No response_\n\n### Additional information\n\n_No response_\n", "hints_text": "\nHey there @sdb9696, mind taking a look at this issue as it has been labeled with an integration (`ring`) you are listed as a [code owner](https://github.com/home-assistant/core/blob/dev/CODEOWNERS#L1228) for? Thanks!\n\n<details>\n<summary>Code owner commands</summary>\n\n\nCode owners of `ring` can trigger bot actions by commenting:\n\n- `@home-assistant close` Closes the issue.\n- `@home-assistant rename Awesome new title` Renames the issue.\n- `@home-assistant reopen` Reopen the issue.\n- `@home-assistant unassign ring` Removes the current integration label and assignees on the issue, add the integration domain after the command.\n- `@home-assistant add-label needs-more-information` Add a label (needs-more-information, problem in dependency, problem in custom component) to the issue.\n- `@home-assistant remove-label needs-more-information` Remove a label (needs-more-information, problem in dependency, problem in custom component) on the issue.\n\n</details>\n\n\n<sub><sup>(message by CodeOwnersMention)</sup></sub>\n\n---\n\n[ring documentation](https://www.home-assistant.io/integrations/ring)\n[ring source](https://github.com/home-assistant/core/tree/dev/homeassistant/components/ring)\n<sub><sup>(message by IssueLinks)</sup></sub>\nI am also having this issue. \nI am having the same issue, as of only about two days ago. My other Ring devices (wired cam, floodlight cam) still have the Motion entity\n> I am having the same issue, as of only about two days ago. My other Ring devices (wired cam, floodlight cam) still have the Motion entity\r\n\r\nI also have the wireless cam, and it still shows a motion entity. I updated to 24.10.2 and also removed and readded the Ring integration. \nI am also experiencing this issue with my Ring Elite but not my other Rings\n@sdb9696 I saw that you fixed the recent [issue](https://github.com/home-assistant/core/issues/128252) with Ring switches, and I'm guessing this one is related given the timing. At least for me, motion entities are still missing from Ring Elite doorbells but not other Ring cameras. Any chance you are working on this one too?\nCould someone upload the diagnostics for the Ring Elite as I think it's not currently configured in the library to support motion alerts?\n\nHey there @sdb9696, mind taking a look at this issue as it has been labeled with an integration (`ring`) you are listed as a [code owner](https://github.com/home-assistant/core/blob/dev/CODEOWNERS#L1228) for? Thanks!\n\n<details>\n<summary>Code owner commands</summary>\n\n\nCode owners of `ring` can trigger bot actions by commenting:\n\n- `@home-assistant close` Closes the issue.\n- `@home-assistant rename Awesome new title` Renames the issue.\n- `@home-assistant reopen` Reopen the issue.\n- `@home-assistant unassign ring` Removes the current integration label and assignees on the issue, add the integration domain after the command.\n- `@home-assistant add-label needs-more-information` Add a label (needs-more-information, problem in dependency, problem in custom component) to the issue.\n- `@home-assistant remove-label needs-more-information` Remove a label (needs-more-information, problem in dependency, problem in custom component) on the issue.\n\n</details>\n\n\n<sub><sup>(message by CodeOwnersMention)</sup></sub>\n\n---\n\n[ring documentation](https://www.home-assistant.io/integrations/ring)\n[ring source](https://github.com/home-assistant/core/tree/dev/homeassistant/components/ring)\n<sub><sup>(message by IssueLinks)</sup></sub>\nI am also having this issue. \nI am having the same issue, as of only about two days ago. My other Ring devices (wired cam, floodlight cam) still have the Motion entity\n> I am having the same issue, as of only about two days ago. My other Ring devices (wired cam, floodlight cam) still have the Motion entity\r\n\r\nI also have the wireless cam, and it still shows a motion entity. I updated to 24.10.2 and also removed and readded the Ring integration. \nI am also experiencing this issue with my Ring Elite but not my other Rings\n@sdb9696 I saw that you fixed the recent [issue](https://github.com/home-assistant/core/issues/128252) with Ring switches, and I'm guessing this one is related given the timing. At least for me, motion entities are still missing from Ring Elite doorbells but not other Ring cameras. Any chance you are working on this one too?\nCould someone upload the diagnostics for the Ring Elite as I think it's not currently configured in the library to support motion alerts?", "created_at": "2024-11-12T10:14:56Z"}
{"repo": "home-assistant/core", "pull_number": 130389, "instance_id": "home-assistant__core-130389", "issue_numbers": ["130387"], "base_commit": "e97a5f927c552855bd5f145c3382c469eecd487b", "patch": "diff --git a/homeassistant/components/powerwall/config_flow.py b/homeassistant/components/powerwall/config_flow.py\nindex bacbff63211174..0c39392ca19b74 100644\n--- a/homeassistant/components/powerwall/config_flow.py\n+++ b/homeassistant/components/powerwall/config_flow.py\n@@ -251,8 +251,8 @@ async def async_step_reauth_confirm(\n         \"\"\"Handle reauth confirmation.\"\"\"\n         errors: dict[str, str] | None = {}\n         description_placeholders: dict[str, str] = {}\n+        reauth_entry = self._get_reauth_entry()\n         if user_input is not None:\n-            reauth_entry = self._get_reauth_entry()\n             errors, _, description_placeholders = await self._async_try_connect(\n                 {CONF_IP_ADDRESS: reauth_entry.data[CONF_IP_ADDRESS], **user_input}\n             )\n@@ -261,6 +261,10 @@ async def async_step_reauth_confirm(\n                     reauth_entry, data_updates=user_input\n                 )\n \n+        self.context[\"title_placeholders\"] = {\n+            \"name\": reauth_entry.title,\n+            \"ip_address\": reauth_entry.data[CONF_IP_ADDRESS],\n+        }\n         return self.async_show_form(\n             step_id=\"reauth_confirm\",\n             data_schema=vol.Schema({vol.Optional(CONF_PASSWORD): str}),\n", "test_patch": "diff --git a/tests/components/powerwall/test_config_flow.py b/tests/components/powerwall/test_config_flow.py\nindex 5074a289d191e9..1ff1470f81c03e 100644\n--- a/tests/components/powerwall/test_config_flow.py\n+++ b/tests/components/powerwall/test_config_flow.py\n@@ -339,6 +339,11 @@ async def test_form_reauth(hass: HomeAssistant) -> None:\n     result = await entry.start_reauth_flow(hass)\n     assert result[\"type\"] is FlowResultType.FORM\n     assert result[\"errors\"] == {}\n+    flow = hass.config_entries.flow.async_get(result[\"flow_id\"])\n+    assert flow[\"context\"][\"title_placeholders\"] == {\n+        \"ip_address\": VALID_CONFIG[CONF_IP_ADDRESS],\n+        \"name\": entry.title,\n+    }\n \n     mock_powerwall = await _mock_powerwall_site_name(hass, \"My site\")\n \n", "problem_statement": "Powerwall is missing `ip_address` title placeholder\n              I changed the password using @coderjohnjohn 's [method](https://github.com/home-assistant/core/issues/129440#issuecomment-2446103583) and everything was working fine.\r\nUntil this morning when I ugraded HA to 2024.11.1 now I'm back to the password prompt that is rejecting both my new password and the default one.\r\n\r\nAlso getting this translation error below, not sure if related\r\n\r\n```\r\nLogger: frontend.js.modern.202411062\r\nSource: components/system_log/__init__.py:331\r\nFirst occurred: 11:15:05 AM (3 occurrences)\r\nLast logged: 11:17:35 AM\r\n\r\nFailed to format translation for key 'component.powerwall.config.flow_title' in language 'en'. Error: The intl string context variable \"ip_address\" was not provided to the string \"{name} ({ip_address})\"\r\n```\r\n\r\n_Originally posted by @choumarin in https://github.com/home-assistant/core/issues/129440#issuecomment-2468877671_\r\n            \n", "hints_text": "", "created_at": "2024-11-11T19:31:38Z"}
{"repo": "home-assistant/core", "pull_number": 130388, "instance_id": "home-assistant__core-130388", "issue_numbers": ["130118"], "base_commit": "e97a5f927c552855bd5f145c3382c469eecd487b", "patch": "diff --git a/homeassistant/components/tibber/manifest.json b/homeassistant/components/tibber/manifest.json\nindex d1bfefec48481d..bc9304ab59d37c 100644\n--- a/homeassistant/components/tibber/manifest.json\n+++ b/homeassistant/components/tibber/manifest.json\n@@ -8,5 +8,5 @@\n   \"iot_class\": \"cloud_polling\",\n   \"loggers\": [\"tibber\"],\n   \"quality_scale\": \"silver\",\n-  \"requirements\": [\"pyTibber==0.30.7\"]\n+  \"requirements\": [\"pyTibber==0.30.8\"]\n }\ndiff --git a/requirements_all.txt b/requirements_all.txt\nindex fe737af17e7016..337daeb394114a 100644\n--- a/requirements_all.txt\n+++ b/requirements_all.txt\n@@ -1738,7 +1738,7 @@ pyRFXtrx==0.31.1\n pySDCP==1\n \n # homeassistant.components.tibber\n-pyTibber==0.30.7\n+pyTibber==0.30.8\n \n # homeassistant.components.dlink\n pyW215==0.7.0\n", "test_patch": "diff --git a/requirements_test_all.txt b/requirements_test_all.txt\nindex ae4d027dc8f3b3..4a9c22ae169f33 100644\n--- a/requirements_test_all.txt\n+++ b/requirements_test_all.txt\n@@ -1415,7 +1415,7 @@ pyElectra==1.2.4\n pyRFXtrx==0.31.1\n \n # homeassistant.components.tibber\n-pyTibber==0.30.7\n+pyTibber==0.30.8\n \n # homeassistant.components.dlink\n pyW215==0.7.0\n", "problem_statement": "Tipper price-Entity \"not available\" after 2024-11\n### The problem\n\nAll entities seem to work except the price entity: Showing not available\r\n(restart, deactivate and activate did not help)\r\nFrom the logs:\r\n`tibber: Error on device update!\r\nTraceback (most recent call last):\r\n  File \"/usr/src/homeassistant/homeassistant/helpers/entity_platform.py\", line 728, in _async_add_entity\r\n    await entity.async_device_update(warning=False)\r\n  File \"/usr/src/homeassistant/homeassistant/helpers/entity.py\", line 1302, in async_device_update\r\n    await self.async_update()\r\n  File \"/usr/src/homeassistant/homeassistant/components/tibber/sensor.py\", line 404, in async_update\r\n    await self._fetch_data()\r\n  File \"/usr/src/homeassistant/homeassistant/components/tibber/sensor.py\", line 428, in _fetch_data\r\n    await self._tibber_home.update_info_and_price_info()\r\n  File \"/usr/local/lib/python3.12/site-packages/tibber/home.py\", line 208, in update_info_and_price_info\r\n    await self.update_price_info()\r\n  File \"/usr/local/lib/python3.12/site-packages/tibber/home.py\", line 241, in update_price_info\r\n    self.last_data_timestamp = dt.datetime.fromisoformat(data[-1][\"time\"])\r\n                                                         ~~~~^^^^\r\nIndexError: list index out of range`\n\n### What version of Home Assistant Core has the issue?\n\n2024-11\n\n### What was the last working version of Home Assistant Core?\n\n2024-10\n\n### What type of installation are you running?\n\nHome Assistant OS\n\n### Integration causing the issue\n\nTibber\n\n### Link to integration documentation on our website\n\n_No response_\n\n### Diagnostics information\n\n_No response_\n\n### Example YAML snippet\n\n_No response_\n\n### Anything in the logs that might be useful for us?\n\n_No response_\n\n### Additional information\n\n_No response_\n", "hints_text": "\nHey there @danielhiversen, mind taking a look at this issue as it has been labeled with an integration (`tibber`) you are listed as a [code owner](https://github.com/home-assistant/core/blob/dev/CODEOWNERS#L1509) for? Thanks!\n\n<details>\n<summary>Code owner commands</summary>\n\n\nCode owners of `tibber` can trigger bot actions by commenting:\n\n- `@home-assistant close` Closes the issue.\n- `@home-assistant rename Awesome new title` Renames the issue.\n- `@home-assistant reopen` Reopen the issue.\n- `@home-assistant unassign tibber` Removes the current integration label and assignees on the issue, add the integration domain after the command.\n- `@home-assistant add-label needs-more-information` Add a label (needs-more-information, problem in dependency, problem in custom component) to the issue.\n- `@home-assistant remove-label needs-more-information` Remove a label (needs-more-information, problem in dependency, problem in custom component) on the issue.\n\n</details>\n\n\n<sub><sup>(message by CodeOwnersMention)</sup></sub>\n\n---\n\n[tibber documentation](https://www.home-assistant.io/integrations/tibber)\n[tibber source](https://github.com/home-assistant/core/tree/dev/homeassistant/components/tibber)\n<sub><sup>(message by IssueLinks)</sup></sub>\nCould you run this query with your token at https://developer.tibber.com/explorer when it happens?\r\n\r\n```\r\n{\r\n  viewer {\r\n    homes {\r\n      currentSubscription {\r\n        priceRating {\r\n          hourly {\r\n            currency\r\n            entries {\r\n              time\r\n              total\r\n              energy\r\n              level\r\n            }\r\n          }\r\n        }\r\n      }\r\n    }\r\n  }\r\n}\r\n```\nToday I restarted everything (again) as preparation for HA 2024.11.1 (is not yet installed) and suddenly it started to work again. This issue can be closed.\n@tomten68 To be sure I understand.\r\n You get this error `IndexError: list index out of range` ?\r\n You always get this error, so the price service never give you any data?\nHi,\r\nI didn't get any errors when I ran the query but it failed getting the value in HA after the restart this morning.\r\nBut now after yet another restart of HA, all Tibber sensors started to work again, just like for fugazzy.\r\nMaybe some temporary problem?\r\n/T\nThis happens a lot -but not every time-  after a restart of HA. When this happens, also the tibber.get_prices action doesn't work. No error messages in the developer tools - ACTIONS window, just an almost empty result.\r\nThe problem can be resolved by reloading the Tibber integration. After that both the price value is back available and the get_prices action works again.\nOk, seems to be some unstable response from the Tibber API.\r\nI have added som extra logs for the next release. Then I might need to add some more retries\nI am having the same issue, the sensor is not available and the query returns:\r\n\r\n{\r\n  \"data\": {\r\n    \"viewer\": {\r\n      \"homes\": [\r\n        {\r\n          \"currentSubscription\": {\r\n            \"priceRating\": {\r\n              \"hourly\": {\r\n                \"currency\": \"EUR\",\r\n                \"entries\": [\r\n                  {\r\n                    \"time\": \"2024-11-02T00:00:00.000+01:00\",\r\n                    \"total\": 0.342,\r\n                    \"energy\": 0.0958,\r\n                    \"level\": \"LOW\"\r\n                  },\r\n\r\n\r\nwhen I reloaded integration, the sensor appeared though.\nSeems to happen even under normal operation, without restarting or updating. Restarting helps though,but it seems really to be an issue with the Tibber API. Did they change something ? \nYes, i have it too. Seems something wrong with the API.\nAccess to price data no longer works in the Tibber adapter in HA since the core update to 2024.11.1\r\nAccess via the Tibber API explorer works fine. \r\nReloading of the adapter nor restarting HA doesn\u2019t resolve it. \r\n\r\nI yam getting the error \r\n\r\n`Logger: homeassistant.components.sensor\r\nSource: helpers/entity_platform.py:728\r\nintegration: Sensor (documentation, issues)\r\nFirst occurred: 3:51:07 PM (4 occurrences)\r\nLast logged: 9:40:56 PM\r\n\r\ntibber: Error on device update!\r\nTraceback (most recent call last):\r\n  File \"/usr/src/homeassistant/homeassistant/helpers/entity_platform.py\", line 728, in _async_add_entity\r\n    await entity.async_device_update(warning=False)\r\n  File \"/usr/src/homeassistant/homeassistant/helpers/entity.py\", line 1302, in async_device_update\r\n    await self.async_update()\r\n  File \"/usr/src/homeassistant/homeassistant/components/tibber/sensor.py\", line 404, in async_update\r\n    await self._fetch_data()\r\n  File \"/usr/src/homeassistant/homeassistant/components/tibber/sensor.py\", line 428, in _fetch_data\r\n    await self._tibber_home.update_info_and_price_info()\r\n  File \"/usr/local/lib/python3.12/site-packages/tibber/home.py\", line 208, in update_info_and_price_info\r\n    await self.update_price_info()\r\n  File \"/usr/local/lib/python3.12/site-packages/tibber/home.py\", line 241, in update_price_info\r\n    self.last_data_timestamp = dt.datetime.fromisoformat(data[-1][\"time\"])\r\n                                                         ~~~~^^^^\r\nIndexError: list index out of range\r\n\ni have the same problem.\r\nreloading the integration doesnt work\r\nrestart of ha doesnt work.\r\nthe epex spot integration shows the right data.\r\n\r\nthe api explorer shows the right values too:\r\n           {\r\n                    \"time\": \"2024-11-11T07:00:00.000+01:00\",\r\n                    \"total\": 0.3389,\r\n                    \"energy\": 0.1284,\r\n                    \"level\": \"LOW\"\r\n                  },\r\n                  {\r\n                    \"time\": \"2024-11-11T08:00:00.000+01:00\",\r\n                    \"total\": 0.3468,\r\n                    \"energy\": 0.1351,\r\n                    \"level\": \"LOW\"\r\n                  },\r\n                  {\r\n                    \"time\": \"2024-11-11T09:00:00.000+01:00\",\r\n                    \"total\": 0.3443,\r\n                    \"energy\": 0.1329,\r\n                    \"level\": \"LOW\"\r\n                  },\r\n                  {\r\n                    \"time\": \"2024-11-11T10:00:00.000+01:00\",\r\n                    \"total\": 0.339,\r\n                    \"energy\": 0.1285,\r\n                    \"level\": \"LOW\"\r\n                  },\r\n                  {\r\n                    \"time\": \"2024-11-11T11:00:00.000+01:00\",\r\n                    \"total\": 0.3339,\r\n                    \"energy\": 0.1242,\r\n                    \"level\": \"LOW\"\r\n                  },\r\n\r\n\n> Today I restarted everything (again) as preparation for HA 2024.11.1 (is not yet installed) and suddenly it started to work again. This issue can be closed.\r\n\r\nThe problem came back after a restart yesterday.\nThe price-sensor is up and running. Thank you:-) \nI have the same problem. The error occurred for the first time on November 7th at 6:03 (UTC+1). Unfortunately, I only noticed it after 3 days. Today at 6:10 the error occurred again. Reloading the integration helped each time.\r\n![tibber](https://github.com/user-attachments/assets/05ae3047-a34a-4a4c-bebc-704f9692f9e1)\r\n\r\nBefore reloading the Tibber integration, I tried restarting HA without success. After that, there was an error message in the logs related to Tibber. I can't do anything with that.\r\n\r\nLogger: homeassistant.components.sensor\r\nQuelle: helpers/entity_platform.py:728\r\nIntegration: Sensor (Dokumentation, Probleme)\r\nErstmals aufgetreten: 16:09:24 (1 Vorkommnisse)\r\nZuletzt protokolliert: 16:09:24\r\n\r\ntibber: Error on device update!\r\nTraceback (most recent call last):\r\n  File \"/usr/src/homeassistant/homeassistant/helpers/entity_platform.py\", line 728, in _async_add_entity\r\n    await entity.async_device_update(warning=False)\r\n  File \"/usr/src/homeassistant/homeassistant/helpers/entity.py\", line 1302, in async_device_update\r\n    await self.async_update()\r\n  File \"/usr/src/homeassistant/homeassistant/components/tibber/sensor.py\", line 404, in async_update\r\n    await self._fetch_data()\r\n  File \"/usr/src/homeassistant/homeassistant/components/tibber/sensor.py\", line 428, in _fetch_data\r\n    await self._tibber_home.update_info_and_price_info()\r\n  File \"/usr/local/lib/python3.12/site-packages/tibber/home.py\", line 208, in update_info_and_price_info\r\n    await self.update_price_info()\r\n  File \"/usr/local/lib/python3.12/site-packages/tibber/home.py\", line 241, in update_price_info\r\n    self.last_data_timestamp = dt.datetime.fromisoformat(data[-1][\"time\"])\r\n                                                         ~~~~^^^^\r\nIndexError: list index out of range\n> > Today I restarted everything (again) as preparation for HA 2024.11.1 (is not yet installed) and suddenly it started to work again. This issue can be closed.\r\n> \r\n> The problem came back after a restart yesterday.\r\n\r\nSame error here. Sometimes reload works but error comes back After some Time. ", "created_at": "2024-11-11T19:30:27Z"}
{"repo": "home-assistant/core", "pull_number": 130372, "instance_id": "home-assistant__core-130372", "issue_numbers": ["130288"], "base_commit": "388c5807ea3339d51aea5aac01bd325f4c2ead67", "patch": "diff --git a/homeassistant/components/spotify/manifest.json b/homeassistant/components/spotify/manifest.json\nindex afe352904cebdb..8f8f7e0d5882aa 100644\n--- a/homeassistant/components/spotify/manifest.json\n+++ b/homeassistant/components/spotify/manifest.json\n@@ -9,6 +9,6 @@\n   \"iot_class\": \"cloud_polling\",\n   \"loggers\": [\"spotipy\"],\n   \"quality_scale\": \"silver\",\n-  \"requirements\": [\"spotifyaio==0.8.7\"],\n+  \"requirements\": [\"spotifyaio==0.8.8\"],\n   \"zeroconf\": [\"_spotify-connect._tcp.local.\"]\n }\ndiff --git a/requirements_all.txt b/requirements_all.txt\nindex ff2e42fe779c78..c7ee8e6c0c3208 100644\n--- a/requirements_all.txt\n+++ b/requirements_all.txt\n@@ -2713,7 +2713,7 @@ speak2mary==1.4.0\n speedtest-cli==2.1.3\n \n # homeassistant.components.spotify\n-spotifyaio==0.8.7\n+spotifyaio==0.8.8\n \n # homeassistant.components.sql\n sqlparse==0.5.0\n", "test_patch": "diff --git a/requirements_test_all.txt b/requirements_test_all.txt\nindex 7e0be99a6827d8..f4bf06019b972e 100644\n--- a/requirements_test_all.txt\n+++ b/requirements_test_all.txt\n@@ -2165,7 +2165,7 @@ speak2mary==1.4.0\n speedtest-cli==2.1.3\n \n # homeassistant.components.spotify\n-spotifyaio==0.8.7\n+spotifyaio==0.8.8\n \n # homeassistant.components.sql\n sqlparse==0.5.0\n", "problem_statement": "Spotify - Problem with PS5\n### The problem\n\nWhen I use spotify on my PS5 the integration cannot fetch the informations anymore, after a reload while the PS5 is playing I get a Setup failed error.\n\n### What version of Home Assistant Core has the issue?\n\ncore-2024.11.1\n\n### What was the last working version of Home Assistant Core?\n\ncore-2024.10.X (didn't noticed this bug there)\n\n### What type of installation are you running?\n\nHome Assistant OS\n\n### Integration causing the issue\n\nSpotify\n\n### Link to integration documentation on our website\n\nhttps://www.home-assistant.io/integrations/spotify\n\n### Diagnostics information\n\n[home-assistant_spotify_2024-11-10T14-02-18.425Z.log](https://github.com/user-attachments/files/17691683/home-assistant_spotify_2024-11-10T14-02-18.425Z.log)\r\n\n\n### Example YAML snippet\n\n_No response_\n\n### Anything in the logs that might be useful for us?\n\n```txt\nLogger: homeassistant.components.spotify\r\nSource: helpers/update_coordinator.py:382\r\nintegration: Spotify (documentation, issues)\r\nFirst occurred: 14:11:29 (15 occurrences)\r\nLast logged: 14:50:00\r\n\r\nUnexpected error fetching redacted Devices data\r\nTraceback (most recent call last):\r\n  File \"<string>\", line 24, in __mashumaro_from_dict_json__\r\n  File \"/usr/local/lib/python3.12/enum.py\", line 757, in __call__\r\n    return cls.__new__(cls, value)\r\n           ^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/local/lib/python3.12/enum.py\", line 1171, in __new__\r\n    raise ve_exc\r\nValueError: 'GameConsole' is not a valid DeviceType\r\n\r\nDuring handling of the above exception, another exception occurred:\r\n\r\nTraceback (most recent call last):\r\n  File \"<string>\", line 9, in __mashumaro_from_json__\r\n  File \"<string>\", line 26, in __mashumaro_from_dict_json__\r\nmashumaro.exceptions.InvalidFieldValue: Field \"device_type\" of type DeviceType in Device has invalid value 'GameConsole'\r\n\r\nDuring handling of the above exception, another exception occurred:\r\n\r\nTraceback (most recent call last):\r\n  File \"/usr/src/homeassistant/homeassistant/helpers/update_coordinator.py\", line 382, in _async_refresh\r\n    self.data = await self._async_update_data()\r\n                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/src/homeassistant/homeassistant/helpers/update_coordinator.py\", line 279, in _async_update_data\r\n    return await self.update_method()\r\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/src/homeassistant/homeassistant/components/spotify/__init__.py\", line 72, in _update_devices\r\n    return await spotify.get_devices()\r\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/local/lib/python3.12/site-packages/spotifyaio/spotify.py\", line 324, in get_devices\r\n    return Devices.from_json(response).devices\r\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"<string>\", line 11, in __mashumaro_from_json__\r\nmashumaro.exceptions.InvalidFieldValue: Field \"devices\" of type list[Device] in Devices has invalid value [{'id': 'redacted', 'is_active': True, 'is_private_session': False, 'is_restricted': False, 'name': 'redacted PS5', 'supports_volume': True, 'type': 'GameConsole', 'volume_percent': 100}, {'id': 'redacted', 'is_active': False, 'is_private_session': False, 'is_restricted': False, 'name': 'iPhone', 'supports_volume': False, 'type': 'Smartphone', 'volume_percent': 100}]\n```\n\n\n### Additional information\n\nIf you want to replicate this error, simply get the integration running, then start a song on a PS5 or use spotify connect to play it there, doesn't matter. Then everything come unavailable or if you reload the Integration it just simply fails to set up.\n", "hints_text": "\nHey there @frenck, @joostlek, mind taking a look at this issue as it has been labeled with an integration (`spotify`) you are listed as a [code owner](https://github.com/home-assistant/core/blob/dev/CODEOWNERS#L1400) for? Thanks!\n\n<details>\n<summary>Code owner commands</summary>\n\n\nCode owners of `spotify` can trigger bot actions by commenting:\n\n- `@home-assistant close` Closes the issue.\n- `@home-assistant rename Awesome new title` Renames the issue.\n- `@home-assistant reopen` Reopen the issue.\n- `@home-assistant unassign spotify` Removes the current integration label and assignees on the issue, add the integration domain after the command.\n- `@home-assistant add-label needs-more-information` Add a label (needs-more-information, problem in dependency, problem in custom component) to the issue.\n- `@home-assistant remove-label needs-more-information` Remove a label (needs-more-information, problem in dependency, problem in custom component) on the issue.\n\n</details>\n\n\n<sub><sup>(message by CodeOwnersMention)</sup></sub>\n\n---\n\n[spotify documentation](https://www.home-assistant.io/integrations/spotify)\n[spotify source](https://github.com/home-assistant/core/tree/dev/homeassistant/components/spotify)\n<sub><sup>(message by IssueLinks)</sup></sub>", "created_at": "2024-11-11T16:03:23Z"}
{"repo": "home-assistant/core", "pull_number": 130371, "instance_id": "home-assistant__core-130371", "issue_numbers": ["130228"], "base_commit": "388c5807ea3339d51aea5aac01bd325f4c2ead67", "patch": "diff --git a/Dockerfile b/Dockerfile\nindex 903a121c032d4..1557419209390 100644\n--- a/Dockerfile\n+++ b/Dockerfile\n@@ -55,7 +55,7 @@ RUN \\\n         \"armv7\") go2rtc_suffix='arm' ;; \\\n         *) go2rtc_suffix=${BUILD_ARCH} ;; \\\n     esac \\\n-    && curl -L https://github.com/AlexxIT/go2rtc/releases/download/v1.9.6/go2rtc_linux_${go2rtc_suffix} --output /bin/go2rtc \\\n+    && curl -L https://github.com/AlexxIT/go2rtc/releases/download/v1.9.7/go2rtc_linux_${go2rtc_suffix} --output /bin/go2rtc \\\n     && chmod +x /bin/go2rtc \\\n     # Verify go2rtc can be executed\n     && go2rtc --version\ndiff --git a/homeassistant/components/go2rtc/__init__.py b/homeassistant/components/go2rtc/__init__.py\nindex 04b5b9f931732..fc91ef5e546e7 100644\n--- a/homeassistant/components/go2rtc/__init__.py\n+++ b/homeassistant/components/go2rtc/__init__.py\n@@ -1,8 +1,5 @@\n \"\"\"The go2rtc component.\"\"\"\n \n-from __future__ import annotations\n-\n-from dataclasses import dataclass\n import logging\n import shutil\n \n@@ -41,13 +38,7 @@\n from homeassistant.util.hass_dict import HassKey\n from homeassistant.util.package import is_docker_env\n \n-from .const import (\n-    CONF_DEBUG_UI,\n-    DEBUG_UI_URL_MESSAGE,\n-    DOMAIN,\n-    HA_MANAGED_RTSP_PORT,\n-    HA_MANAGED_URL,\n-)\n+from .const import CONF_DEBUG_UI, DEBUG_UI_URL_MESSAGE, DOMAIN, HA_MANAGED_URL\n from .server import Server\n \n _LOGGER = logging.getLogger(__name__)\n@@ -94,22 +85,13 @@\n     extra=vol.ALLOW_EXTRA,\n )\n \n-_DATA_GO2RTC: HassKey[Go2RtcData] = HassKey(DOMAIN)\n+_DATA_GO2RTC: HassKey[str] = HassKey(DOMAIN)\n _RETRYABLE_ERRORS = (ClientConnectionError, ServerConnectionError)\n \n \n-@dataclass(frozen=True)\n-class Go2RtcData:\n-    \"\"\"Data for go2rtc.\"\"\"\n-\n-    url: str\n-    managed: bool\n-\n-\n async def async_setup(hass: HomeAssistant, config: ConfigType) -> bool:\n     \"\"\"Set up WebRTC.\"\"\"\n     url: str | None = None\n-    managed = False\n     if DOMAIN not in config and DEFAULT_CONFIG_DOMAIN not in config:\n         await _remove_go2rtc_entries(hass)\n         return True\n@@ -144,9 +126,8 @@ async def on_stop(event: Event) -> None:\n         hass.bus.async_listen(EVENT_HOMEASSISTANT_STOP, on_stop)\n \n         url = HA_MANAGED_URL\n-        managed = True\n \n-    hass.data[_DATA_GO2RTC] = Go2RtcData(url, managed)\n+    hass.data[_DATA_GO2RTC] = url\n     discovery_flow.async_create_flow(\n         hass, DOMAIN, context={\"source\": SOURCE_SYSTEM}, data={}\n     )\n@@ -161,32 +142,28 @@ async def _remove_go2rtc_entries(hass: HomeAssistant) -> None:\n \n async def async_setup_entry(hass: HomeAssistant, entry: ConfigEntry) -> bool:\n     \"\"\"Set up go2rtc from a config entry.\"\"\"\n-    data = hass.data[_DATA_GO2RTC]\n+    url = hass.data[_DATA_GO2RTC]\n \n     # Validate the server URL\n     try:\n-        client = Go2RtcRestClient(async_get_clientsession(hass), data.url)\n+        client = Go2RtcRestClient(async_get_clientsession(hass), url)\n         await client.validate_server_version()\n     except Go2RtcClientError as err:\n         if isinstance(err.__cause__, _RETRYABLE_ERRORS):\n             raise ConfigEntryNotReady(\n-                f\"Could not connect to go2rtc instance on {data.url}\"\n+                f\"Could not connect to go2rtc instance on {url}\"\n             ) from err\n-        _LOGGER.warning(\n-            \"Could not connect to go2rtc instance on %s (%s)\", data.url, err\n-        )\n+        _LOGGER.warning(\"Could not connect to go2rtc instance on %s (%s)\", url, err)\n         return False\n     except Go2RtcVersionError as err:\n         raise ConfigEntryNotReady(\n             f\"The go2rtc server version is not supported, {err}\"\n         ) from err\n     except Exception as err:  # noqa: BLE001\n-        _LOGGER.warning(\n-            \"Could not connect to go2rtc instance on %s (%s)\", data.url, err\n-        )\n+        _LOGGER.warning(\"Could not connect to go2rtc instance on %s (%s)\", url, err)\n         return False\n \n-    provider = WebRTCProvider(hass, data)\n+    provider = WebRTCProvider(hass, url)\n     async_register_webrtc_provider(hass, provider)\n     return True\n \n@@ -204,12 +181,12 @@ async def _get_binary(hass: HomeAssistant) -> str | None:\n class WebRTCProvider(CameraWebRTCProvider):\n     \"\"\"WebRTC provider.\"\"\"\n \n-    def __init__(self, hass: HomeAssistant, data: Go2RtcData) -> None:\n+    def __init__(self, hass: HomeAssistant, url: str) -> None:\n         \"\"\"Initialize the WebRTC provider.\"\"\"\n         self._hass = hass\n-        self._data = data\n+        self._url = url\n         self._session = async_get_clientsession(hass)\n-        self._rest_client = Go2RtcRestClient(self._session, data.url)\n+        self._rest_client = Go2RtcRestClient(self._session, url)\n         self._sessions: dict[str, Go2RtcWsClient] = {}\n \n     @property\n@@ -231,7 +208,7 @@ async def async_handle_async_webrtc_offer(\n     ) -> None:\n         \"\"\"Handle the WebRTC offer and return the answer via the provided callback.\"\"\"\n         self._sessions[session_id] = ws_client = Go2RtcWsClient(\n-            self._session, self._data.url, source=camera.entity_id\n+            self._session, self._url, source=camera.entity_id\n         )\n \n         if not (stream_source := await camera.stream_source()):\n@@ -242,34 +219,18 @@ async def async_handle_async_webrtc_offer(\n \n         streams = await self._rest_client.streams.list()\n \n-        if self._data.managed:\n-            # HA manages the go2rtc instance\n-            stream_original_name = f\"{camera.entity_id}_original\"\n-            stream_redirect_sources = [\n-                f\"rtsp://127.0.0.1:{HA_MANAGED_RTSP_PORT}/{stream_original_name}\",\n-                f\"ffmpeg:{stream_original_name}#audio=opus\",\n-            ]\n-\n-            if (\n-                (stream_org := streams.get(stream_original_name)) is None\n-                or not any(\n-                    stream_source == producer.url for producer in stream_org.producers\n-                )\n-                or (stream_redirect := streams.get(camera.entity_id)) is None\n-                or stream_redirect_sources != [p.url for p in stream_redirect.producers]\n-            ):\n-                await self._rest_client.streams.add(stream_original_name, stream_source)\n-                await self._rest_client.streams.add(\n-                    camera.entity_id, stream_redirect_sources\n-                )\n-\n-        # go2rtc instance is managed outside HA\n-        elif (stream_org := streams.get(camera.entity_id)) is None or not any(\n-            stream_source == producer.url for producer in stream_org.producers\n+        if (stream := streams.get(camera.entity_id)) is None or not any(\n+            stream_source == producer.url for producer in stream.producers\n         ):\n             await self._rest_client.streams.add(\n                 camera.entity_id,\n-                [stream_source, f\"ffmpeg:{camera.entity_id}#audio=opus\"],\n+                [\n+                    stream_source,\n+                    # We are setting any ffmpeg rtsp related logs to debug\n+                    # Connection problems to the camera will be logged by the first stream\n+                    # Therefore setting it to debug will not hide any important logs\n+                    f\"ffmpeg:{camera.entity_id}#audio=opus#query=log_level=debug\",\n+                ],\n             )\n \n         @callback\ndiff --git a/homeassistant/components/go2rtc/const.py b/homeassistant/components/go2rtc/const.py\nindex 3c4dc9a950096..d33ae3e389759 100644\n--- a/homeassistant/components/go2rtc/const.py\n+++ b/homeassistant/components/go2rtc/const.py\n@@ -6,4 +6,3 @@\n DEBUG_UI_URL_MESSAGE = \"Url and debug_ui cannot be set at the same time.\"\n HA_MANAGED_API_PORT = 11984\n HA_MANAGED_URL = f\"http://localhost:{HA_MANAGED_API_PORT}/\"\n-HA_MANAGED_RTSP_PORT = 18554\ndiff --git a/homeassistant/components/go2rtc/server.py b/homeassistant/components/go2rtc/server.py\nindex 91f4433546caf..6699ee4d8a29f 100644\n--- a/homeassistant/components/go2rtc/server.py\n+++ b/homeassistant/components/go2rtc/server.py\n@@ -12,7 +12,7 @@\n from homeassistant.exceptions import HomeAssistantError\n from homeassistant.helpers.aiohttp_client import async_get_clientsession\n \n-from .const import HA_MANAGED_API_PORT, HA_MANAGED_RTSP_PORT, HA_MANAGED_URL\n+from .const import HA_MANAGED_API_PORT, HA_MANAGED_URL\n \n _LOGGER = logging.getLogger(__name__)\n _TERMINATE_TIMEOUT = 5\n@@ -33,7 +33,7 @@\n   listen: \"{api_ip}:{api_port}\"\n \n rtsp:\n-  listen: \"127.0.0.1:{rtsp_port}\"\n+  listen: \"127.0.0.1:18554\"\n \n webrtc:\n   listen: \":18555/tcp\"\n@@ -68,9 +68,7 @@ def _create_temp_file(api_ip: str) -> str:\n     with NamedTemporaryFile(prefix=\"go2rtc_\", suffix=\".yaml\", delete=False) as file:\n         file.write(\n             _GO2RTC_CONFIG_FORMAT.format(\n-                api_ip=api_ip,\n-                api_port=HA_MANAGED_API_PORT,\n-                rtsp_port=HA_MANAGED_RTSP_PORT,\n+                api_ip=api_ip, api_port=HA_MANAGED_API_PORT\n             ).encode()\n         )\n         return file.name\ndiff --git a/script/hassfest/docker.py b/script/hassfest/docker.py\nindex 083cdaba1a90e..9d38d8f71282b 100644\n--- a/script/hassfest/docker.py\n+++ b/script/hassfest/docker.py\n@@ -112,7 +112,7 @@\n LABEL \"com.github.actions.color\"=\"gray-dark\"\n \"\"\"\n \n-_GO2RTC_VERSION = \"1.9.6\"\n+_GO2RTC_VERSION = \"1.9.7\"\n \n \n def _get_package_versions(file: Path, packages: set[str]) -> dict[str, str]:\n", "test_patch": "diff --git a/tests/components/go2rtc/test_init.py b/tests/components/go2rtc/test_init.py\nindex ec5867761428a..9388110366ec1 100644\n--- a/tests/components/go2rtc/test_init.py\n+++ b/tests/components/go2rtc/test_init.py\n@@ -3,7 +3,7 @@\n from collections.abc import Callable, Generator\n import logging\n from typing import NamedTuple\n-from unittest.mock import AsyncMock, Mock, call, patch\n+from unittest.mock import AsyncMock, Mock, patch\n \n from aiohttp.client_exceptions import ClientConnectionError, ServerConnectionError\n from go2rtc_client import Stream\n@@ -238,7 +238,11 @@ async def test() -> None:\n     await test()\n \n     rest_client.streams.add.assert_called_once_with(\n-        entity_id, [\"rtsp://stream\", f\"ffmpeg:{camera.entity_id}#audio=opus\"]\n+        entity_id,\n+        [\n+            \"rtsp://stream\",\n+            f\"ffmpeg:{camera.entity_id}#audio=opus#query=log_level=debug\",\n+        ],\n     )\n \n     # Stream exists but the source is different\n@@ -252,7 +256,11 @@ async def test() -> None:\n     await test()\n \n     rest_client.streams.add.assert_called_once_with(\n-        entity_id, [\"rtsp://stream\", f\"ffmpeg:{camera.entity_id}#audio=opus\"]\n+        entity_id,\n+        [\n+            \"rtsp://stream\",\n+            f\"ffmpeg:{camera.entity_id}#audio=opus#query=log_level=debug\",\n+        ],\n     )\n \n     # If the stream is already added, the stream should not be added again.\n@@ -296,7 +304,7 @@ async def test() -> None:\n     ],\n )\n @pytest.mark.parametrize(\"has_go2rtc_entry\", [True, False])\n-async def test_setup_managed(\n+async def test_setup_go_binary(\n     hass: HomeAssistant,\n     rest_client: AsyncMock,\n     ws_client: Mock,\n@@ -308,131 +316,15 @@ async def test_setup_managed(\n     config: ConfigType,\n     ui_enabled: bool,\n ) -> None:\n-    \"\"\"Test the go2rtc setup with managed go2rtc instance.\"\"\"\n+    \"\"\"Test the go2rtc config entry with binary.\"\"\"\n     assert (len(hass.config_entries.async_entries(DOMAIN)) == 1) == has_go2rtc_entry\n-    camera = init_test_integration\n-\n-    entity_id = camera.entity_id\n-    stream_name_original = f\"{camera.entity_id}_original\"\n-    assert camera.frontend_stream_type == StreamType.HLS\n-\n-    assert await async_setup_component(hass, DOMAIN, config)\n-    await hass.async_block_till_done(wait_background_tasks=True)\n-    config_entries = hass.config_entries.async_entries(DOMAIN)\n-    assert len(config_entries) == 1\n-    assert config_entries[0].state == ConfigEntryState.LOADED\n-    server.assert_called_once_with(hass, \"/usr/bin/go2rtc\", enable_ui=ui_enabled)\n-    server_start.assert_called_once()\n-\n-    receive_message_callback = Mock(spec_set=WebRTCSendMessage)\n-\n-    async def test() -> None:\n-        await camera.async_handle_async_webrtc_offer(\n-            OFFER_SDP, \"session_id\", receive_message_callback\n-        )\n-        ws_client.send.assert_called_once_with(\n-            WebRTCOffer(\n-                OFFER_SDP,\n-                camera.async_get_webrtc_client_configuration().configuration.ice_servers,\n-            )\n-        )\n-        ws_client.subscribe.assert_called_once()\n-\n-        # Simulate the answer from the go2rtc server\n-        callback = ws_client.subscribe.call_args[0][0]\n-        callback(WebRTCAnswer(ANSWER_SDP))\n-        receive_message_callback.assert_called_once_with(HAWebRTCAnswer(ANSWER_SDP))\n-\n-    await test()\n-\n-    stream_added_calls = [\n-        call(stream_name_original, \"rtsp://stream\"),\n-        call(\n-            entity_id,\n-            [\n-                f\"rtsp://127.0.0.1:18554/{stream_name_original}\",\n-                f\"ffmpeg:{stream_name_original}#audio=opus\",\n-            ],\n-        ),\n-    ]\n-    assert rest_client.streams.add.call_args_list == stream_added_calls\n-\n-    # Stream original missing\n-    rest_client.streams.add.reset_mock()\n-    rest_client.streams.list.return_value = {\n-        entity_id: Stream(\n-            [\n-                Producer(f\"rtsp://127.0.0.1:18554/{stream_name_original}\"),\n-                Producer(f\"ffmpeg:{stream_name_original}#audio=opus\"),\n-            ]\n-        )\n-    }\n \n-    receive_message_callback.reset_mock()\n-    ws_client.reset_mock()\n-    await test()\n-\n-    assert rest_client.streams.add.call_args_list == stream_added_calls\n-\n-    # Stream original source different\n-    rest_client.streams.add.reset_mock()\n-    rest_client.streams.list.return_value = {\n-        stream_name_original: Stream([Producer(\"rtsp://different\")]),\n-        entity_id: Stream(\n-            [\n-                Producer(f\"rtsp://127.0.0.1:18554/{stream_name_original}\"),\n-                Producer(f\"ffmpeg:{stream_name_original}#audio=opus\"),\n-            ]\n-        ),\n-    }\n-\n-    receive_message_callback.reset_mock()\n-    ws_client.reset_mock()\n-    await test()\n-\n-    assert rest_client.streams.add.call_args_list == stream_added_calls\n-\n-    # Stream source different\n-    rest_client.streams.add.reset_mock()\n-    rest_client.streams.list.return_value = {\n-        stream_name_original: Stream([Producer(\"rtsp://stream\")]),\n-        entity_id: Stream([Producer(\"rtsp://different\")]),\n-    }\n-\n-    receive_message_callback.reset_mock()\n-    ws_client.reset_mock()\n-    await test()\n-\n-    assert rest_client.streams.add.call_args_list == stream_added_calls\n-\n-    # If the stream is already added, the stream should not be added again.\n-    rest_client.streams.add.reset_mock()\n-    rest_client.streams.list.return_value = {\n-        stream_name_original: Stream([Producer(\"rtsp://stream\")]),\n-        entity_id: Stream(\n-            [\n-                Producer(f\"rtsp://127.0.0.1:18554/{stream_name_original}\"),\n-                Producer(f\"ffmpeg:{stream_name_original}#audio=opus\"),\n-            ]\n-        ),\n-    }\n+    def after_setup() -> None:\n+        server.assert_called_once_with(hass, \"/usr/bin/go2rtc\", enable_ui=ui_enabled)\n+        server_start.assert_called_once()\n \n-    receive_message_callback.reset_mock()\n-    ws_client.reset_mock()\n-    await test()\n-\n-    rest_client.streams.add.assert_not_called()\n-    assert isinstance(camera._webrtc_provider, WebRTCProvider)\n-\n-    # Set stream source to None and provider should be skipped\n-    rest_client.streams.list.return_value = {}\n-    receive_message_callback.reset_mock()\n-    camera.set_stream_source(None)\n-    await camera.async_handle_async_webrtc_offer(\n-        OFFER_SDP, \"session_id\", receive_message_callback\n-    )\n-    receive_message_callback.assert_called_once_with(\n-        WebRTCError(\"go2rtc_webrtc_offer_failed\", \"Camera has no stream source\")\n+    await _test_setup_and_signaling(\n+        hass, rest_client, ws_client, config, after_setup, init_test_integration\n     )\n \n     await hass.async_stop()\n@@ -448,7 +340,7 @@ async def test() -> None:\n     ],\n )\n @pytest.mark.parametrize(\"has_go2rtc_entry\", [True, False])\n-async def test_setup_self_hosted(\n+async def test_setup_go(\n     hass: HomeAssistant,\n     rest_client: AsyncMock,\n     ws_client: Mock,\n@@ -458,83 +350,16 @@ async def test_setup_self_hosted(\n     mock_is_docker_env: Mock,\n     has_go2rtc_entry: bool,\n ) -> None:\n-    \"\"\"Test the go2rtc with selfhosted go2rtc instance.\"\"\"\n+    \"\"\"Test the go2rtc config entry without binary.\"\"\"\n     assert (len(hass.config_entries.async_entries(DOMAIN)) == 1) == has_go2rtc_entry\n \n     config = {DOMAIN: {CONF_URL: \"http://localhost:1984/\"}}\n-    camera = init_test_integration\n-\n-    entity_id = camera.entity_id\n-    assert camera.frontend_stream_type == StreamType.HLS\n-\n-    assert await async_setup_component(hass, DOMAIN, config)\n-    await hass.async_block_till_done(wait_background_tasks=True)\n-    config_entries = hass.config_entries.async_entries(DOMAIN)\n-    assert len(config_entries) == 1\n-    assert config_entries[0].state == ConfigEntryState.LOADED\n-    server.assert_not_called()\n-\n-    receive_message_callback = Mock(spec_set=WebRTCSendMessage)\n-\n-    async def test() -> None:\n-        await camera.async_handle_async_webrtc_offer(\n-            OFFER_SDP, \"session_id\", receive_message_callback\n-        )\n-        ws_client.send.assert_called_once_with(\n-            WebRTCOffer(\n-                OFFER_SDP,\n-                camera.async_get_webrtc_client_configuration().configuration.ice_servers,\n-            )\n-        )\n-        ws_client.subscribe.assert_called_once()\n-\n-        # Simulate the answer from the go2rtc server\n-        callback = ws_client.subscribe.call_args[0][0]\n-        callback(WebRTCAnswer(ANSWER_SDP))\n-        receive_message_callback.assert_called_once_with(HAWebRTCAnswer(ANSWER_SDP))\n-\n-    await test()\n-\n-    rest_client.streams.add.assert_called_once_with(\n-        entity_id, [\"rtsp://stream\", f\"ffmpeg:{camera.entity_id}#audio=opus\"]\n-    )\n-\n-    # Stream exists but the source is different\n-    rest_client.streams.add.reset_mock()\n-    rest_client.streams.list.return_value = {\n-        entity_id: Stream([Producer(\"rtsp://different\")])\n-    }\n-\n-    receive_message_callback.reset_mock()\n-    ws_client.reset_mock()\n-    await test()\n-\n-    rest_client.streams.add.assert_called_once_with(\n-        entity_id, [\"rtsp://stream\", f\"ffmpeg:{camera.entity_id}#audio=opus\"]\n-    )\n-\n-    # If the stream is already added, the stream should not be added again.\n-    rest_client.streams.add.reset_mock()\n-    rest_client.streams.list.return_value = {\n-        entity_id: Stream([Producer(\"rtsp://stream\")])\n-    }\n-\n-    receive_message_callback.reset_mock()\n-    ws_client.reset_mock()\n-    await test()\n \n-    rest_client.streams.add.assert_not_called()\n-    assert isinstance(camera._webrtc_provider, WebRTCProvider)\n+    def after_setup() -> None:\n+        server.assert_not_called()\n \n-    # Set stream source to None and provider should be skipped\n-    rest_client.streams.list.return_value = {}\n-    receive_message_callback.reset_mock()\n-    camera.set_stream_source(None)\n-    await camera.async_handle_async_webrtc_offer(\n-        OFFER_SDP, \"session_id\", receive_message_callback\n-    )\n-    receive_message_callback.assert_called_once_with(\n-        WebRTCError(\"go2rtc_webrtc_offer_failed\", \"Camera has no stream source\")\n+    await _test_setup_and_signaling(\n+        hass, rest_client, ws_client, config, after_setup, init_test_integration\n     )\n \n     mock_get_binary.assert_not_called()\n", "problem_statement": "Go2rtc raises 400 on Unifi Protect camera\n### The problem\n\nSince the https://github.com/home-assistant/core/pull/130139 workaround for go2rtc in 2024.11.1 it has caused mine to stop functioning with Unifi Protect and fallback to HLS.\r\n\r\nI couldn't find a way to download diagnostic data but did testing via the debug_ui.\r\n\r\nI was thinking is that it could be HA trying to spin up an RTSP redirect while Unifi Protect is using RTSPS.  I can load the redirect streams directly, both the original and non original version it spins up, via the embedded go2rtc and those work fine.  So I believe the embedded go2rtc is functioning but something breaks the connection between it and HA.  I only have Unifi Protect cameras and no other way to see if other cameras are impacted.\r\n\r\n\r\nThis may get resolved with the upstream patch to go2rtc if it negates the need to spin up redirect streams to avoid that bug.\n\n### What version of Home Assistant Core has the issue?\n\n2024.11.1\n\n### What was the last working version of Home Assistant Core?\n\n2024.11.0\n\n### What type of installation are you running?\n\nHome Assistant Container\n\n### Integration causing the issue\n\ngo2rtc\n\n### Link to integration documentation on our website\n\nhttps://www.home-assistant.io/integrations/go2rtc/\n\n### Diagnostics information\n\n_No response_\n\n### Example YAML snippet\n\n_No response_\n\n### Anything in the logs that might be useful for us?\n\n```txt\nTraceback (most recent call last):\r\n  File \"/usr/local/lib/python3.12/site-packages/go2rtc_client/exceptions.py\", line 56, in _func\r\n    return await func(*args, **kwargs)\r\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/local/lib/python3.12/site-packages/go2rtc_client/rest.py\", line 124, in add\r\n    await self._client.request(\r\n  File \"/usr/local/lib/python3.12/site-packages/go2rtc_client/rest.py\", line 60, in request\r\n    resp.raise_for_status()\r\n  File \"/usr/local/lib/python3.12/site-packages/aiohttp/client_reqrep.py\", line 1157, in raise_for_status\r\n    raise ClientResponseError(\r\naiohttp.client_exceptions.ClientResponseError: 400, message='Bad Request', url='http://localhost:11984/api/streams?name=camera.front_door_orginal&src=rtsps://192.168.X.X:7441/vmt4ZEahd5KXXXXX'\r\n\r\nThe above exception was the direct cause of the following exception:\r\n\r\nTraceback (most recent call last):\r\n  File \"/usr/src/homeassistant/homeassistant/components/websocket_api/decorators.py\", line 28, in _handle_async_response\r\n    await func(hass, connection, msg)\r\n  File \"/usr/src/homeassistant/homeassistant/components/camera/webrtc.py\", line 263, in ws_webrtc_offer\r\n    await camera.async_handle_async_webrtc_offer(offer, session_id, send_message)\r\n  File \"/usr/src/homeassistant/homeassistant/components/camera/__init__.py\", line 666, in async_handle_async_webrtc_offer\r\n    await self._webrtc_provider.async_handle_async_webrtc_offer(\r\n  File \"/usr/src/homeassistant/homeassistant/components/go2rtc/__init__.py\", line 261, in async_handle_async_webrtc_offer\r\n    await self._rest_client.streams.add(stream_org_name, stream_source)\r\n  File \"/usr/local/lib/python3.12/site-packages/go2rtc_client/exceptions.py\", line 66, in _func\r\n    raise Go2RtcClientError from exc\r\ngo2rtc_client.exceptions.Go2RtcClientError\n```\n\n\n### Additional information\n\n_No response_\n", "hints_text": "\nHey there @home-assistant/core, mind taking a look at this issue as it has been labeled with an integration (`go2rtc`) you are listed as a [code owner](https://github.com/home-assistant/core/blob/dev/CODEOWNERS#L547) for? Thanks!\n\n<details>\n<summary>Code owner commands</summary>\n\n\nCode owners of `go2rtc` can trigger bot actions by commenting:\n\n- `@home-assistant close` Closes the issue.\n- `@home-assistant rename Awesome new title` Renames the issue.\n- `@home-assistant reopen` Reopen the issue.\n- `@home-assistant unassign go2rtc` Removes the current integration label and assignees on the issue, add the integration domain after the command.\n- `@home-assistant add-label needs-more-information` Add a label (needs-more-information, problem in dependency, problem in custom component) to the issue.\n- `@home-assistant remove-label needs-more-information` Remove a label (needs-more-information, problem in dependency, problem in custom component) on the issue.\n\n</details>\n\n\n<sub><sup>(message by CodeOwnersMention)</sup></sub>\n\n---\n\n[go2rtc documentation](https://www.home-assistant.io/integrations/go2rtc)\n[go2rtc source](https://github.com/home-assistant/core/tree/dev/homeassistant/components/go2rtc)\n<sub><sup>(message by IssueLinks)</sup></sub>\nDo you see any logs in go2rtc?\r\n\r\nThe above log is raised when adding the original stream, so I'm not sure how you did test the following:\r\n\r\n> I can load the redirect streams directly, both the original and non original version it spins up, via the embedded go2rtc and those work fine.\r\n\r\nAs both streams were not added to go2rtc. Did you manually add them to go2rtc?", "created_at": "2024-11-11T15:54:59Z"}
{"repo": "home-assistant/core", "pull_number": 130349, "instance_id": "home-assistant__core-130349", "issue_numbers": ["126372"], "base_commit": "88480d154a9a53b7227a67bca2aa5875085548b8", "patch": "diff --git a/homeassistant/components/linkplay/media_player.py b/homeassistant/components/linkplay/media_player.py\nindex a625412852eef..832b56d0891d2 100644\n--- a/homeassistant/components/linkplay/media_player.py\n+++ b/homeassistant/components/linkplay/media_player.py\n@@ -296,6 +296,11 @@ async def async_play_preset(self, preset_number: int) -> None:\n         except ValueError as err:\n             raise HomeAssistantError(err) from err\n \n+    @exception_wrap\n+    async def async_media_seek(self, position: float) -> None:\n+        \"\"\"Seek to a position.\"\"\"\n+        await self._bridge.player.seek(round(position))\n+\n     @exception_wrap\n     async def async_join_players(self, group_members: list[str]) -> None:\n         \"\"\"Join `group_members` as a player group with the current player.\"\"\"\n@@ -381,9 +386,9 @@ def _update_properties(self) -> None:\n                 )\n \n             self._attr_source = SOURCE_MAP.get(self._bridge.player.play_mode, \"other\")\n-            self._attr_media_position = self._bridge.player.current_position / 1000\n+            self._attr_media_position = self._bridge.player.current_position_in_seconds\n             self._attr_media_position_updated_at = utcnow()\n-            self._attr_media_duration = self._bridge.player.total_length / 1000\n+            self._attr_media_duration = self._bridge.player.total_length_in_seconds\n             self._attr_media_artist = self._bridge.player.artist\n             self._attr_media_title = self._bridge.player.title\n             self._attr_media_album_name = self._bridge.player.album\n", "test_patch": "", "problem_statement": "Linkplay device will not seek or power off/idle\n### The problem\n\nI'm unable to seek from a service call. Also, the power button doesn't work to make a player go idle. \n\n### What version of Home Assistant Core has the issue?\n\n2024.8.3\n\n### What was the last working version of Home Assistant Core?\n\n_No response_\n\n### What type of installation are you running?\n\nHome Assistant OS\n\n### Integration causing the issue\n\nlinkplay\n\n### Link to integration documentation on our website\n\n_No response_\n\n### Diagnostics information\n\n_No response_\n\n### Example YAML snippet\n\n_No response_\n\n### Anything in the logs that might be useful for us?\n\n_No response_\n\n### Additional information\n\n_No response_\n", "hints_text": "\nHey there @velleman, mind taking a look at this issue as it has been labeled with an integration (`linkplay`) you are listed as a [code owner](https://github.com/home-assistant/core/blob/dev/CODEOWNERS#L828) for? Thanks!\n\n<details>\n<summary>Code owner commands</summary>\n\n\nCode owners of `linkplay` can trigger bot actions by commenting:\n\n- `@home-assistant close` Closes the issue.\n- `@home-assistant rename Awesome new title` Renames the issue.\n- `@home-assistant reopen` Reopen the issue.\n- `@home-assistant unassign linkplay` Removes the current integration label and assignees on the issue, add the integration domain after the command.\n- `@home-assistant add-label needs-more-information` Add a label (needs-more-information, problem in dependency, problem in custom component) to the issue.\n- `@home-assistant remove-label needs-more-information` Remove a label (needs-more-information, problem in dependency, problem in custom component) on the issue.\n\n</details>\n\n\n<sub><sup>(message by CodeOwnersMention)</sup></sub>\n\n---\n\n[linkplay documentation](https://www.home-assistant.io/integrations/linkplay)\n[linkplay source](https://github.com/home-assistant/core/tree/dev/homeassistant/components/linkplay)\n<sub><sup>(message by IssueLinks)</sup></sub>\nHi @Joe31388 \r\n\r\nWe use GitHub for tracking issues with Home Assistant Core itself, not for providing support - so if you could provide more details like logs or any other helpful diagnostics data or error details or steps how to reproduce or your configuration, than we can handle it as an issue report, else it is a support request and you should try our [Community Forum](https://community.home-assistant.io) or join our [Discord chat server](https://www.home-assistant.io/join-chat).\r\n\r\nThanks! \ud83d\udc4d\nI am not OP, but using a Wiim Amp have the same issue. The status will never say \"playing\", there is no \"wifi\" source option (related?) and there is no seek or power option on the device page:\r\n![Screenshot_20240923_103628](https://github.com/user-attachments/assets/de52b201-c468-429b-a00c-32de697b8a32)\r\n\r\nAnd when using a UI media player interface with a power option, clicking it gives this error:\r\n\r\n![Screenshot_20240923_103454](https://github.com/user-attachments/assets/eb788b15-1a42-43c4-a53a-26e1dbf15778)\r\n\n\r\n\r\n\r\nThis error shows up when trying to seek. \r\n\r\n\r\n\r\n\r\nUpdate for media_player.bathroom_speakers fails\r\nTraceback (most recent call last):\r\n  File \"/usr/local/lib/python3.12/site-packages/linkplay/utils.py\", line 48, in session_call_api\r\n    response = await session.get(url)\r\n               ^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/local/lib/python3.12/site-packages/aiohttp/client.py\", line 657, in _request\r\n    conn = await self._connector.connect(\r\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/local/lib/python3.12/site-packages/aiohttp/connector.py\", line 564, in connect\r\n    proto = await self._create_connection(req, traces, timeout)\r\n            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/local/lib/python3.12/site-packages/aiohttp/connector.py\", line 975, in _create_connection\r\n    _, proto = await self._create_direct_connection(req, traces, timeout)\r\n               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/local/lib/python3.12/site-packages/aiohttp/connector.py\", line 1319, in _create_direct_connection\r\n    transp, proto = await self._wrap_create_connection(\r\n                    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/local/lib/python3.12/site-packages/aiohttp/connector.py\", line 1080, in _wrap_create_connection\r\n    return await self._loop.create_connection(*args, **kwargs, sock=sock)\r\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/local/lib/python3.12/asyncio/base_events.py\", line 1149, in create_connection\r\n    transport, protocol = await self._create_connection_transport(\r\n                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/local/lib/python3.12/asyncio/base_events.py\", line 1182, in _create_connection_transport\r\n    await waiter\r\nasyncio.exceptions.CancelledError\r\n\r\nDuring handling of the above exception, another exception occurred:\r\n\r\nTraceback (most recent call last):\r\n  File \"/usr/local/lib/python3.12/site-packages/linkplay/utils.py\", line 47, in session_call_api\r\n    async with async_timeout.timeout(API_TIMEOUT):\r\n  File \"/usr/local/lib/python3.12/site-packages/async_timeout/__init__.py\", line 141, in __aexit__\r\n    self._do_exit(exc_type)\r\n  File \"/usr/local/lib/python3.12/site-packages/async_timeout/__init__.py\", line 228, in _do_exit\r\n    raise asyncio.TimeoutError\r\nTimeoutError\r\n\r\nThe above exception was the direct cause of the following exception:\r\n\r\nTraceback (most recent call last):\r\n  File \"/usr/src/homeassistant/homeassistant/components/linkplay/media_player.py\", line 130, in _wrap\r\n    return await func(self, *args, **kwargs)\r\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/src/homeassistant/homeassistant/components/linkplay/media_player.py\", line 174, in async_update\r\n    await self._bridge.player.update_status()\r\n  File \"/usr/local/lib/python3.12/site-packages/linkplay/bridge.py\", line 86, in update_status\r\n    properties: dict[PlayerAttribute, str] = await self.bridge.json_request(\r\n                                             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/local/lib/python3.12/site-packages/linkplay/bridge.py\", line 261, in json_request\r\n    return await self.endpoint.json_request(command)\r\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/local/lib/python3.12/site-packages/linkplay/endpoint.py\", line 44, in json_request\r\n    return await session_call_api_json(self._endpoint, self._session, command)\r\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/local/lib/python3.12/site-packages/linkplay/utils.py\", line 67, in session_call_api_json\r\n    result = await session_call_api(endpoint, session, command)\r\n             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/local/lib/python3.12/site-packages/linkplay/utils.py\", line 51, in session_call_api\r\n    raise LinkPlayRequestException(\r\nlinkplay.exceptions.LinkPlayRequestException:  error requesting data from 'https://192.168.150.116/httpapi.asp?command=getPlayerStatusEx'\r\n\r\nThe above exception was the direct cause of the following exception:\r\n\r\nTraceback (most recent call last):\r\n  File \"/usr/src/homeassistant/homeassistant/helpers/entity.py\", line 942, in async_update_ha_state\r\n    await self.async_device_update()\r\n  File \"/usr/src/homeassistant/homeassistant/helpers/entity.py\", line 1300, in async_device_update\r\n    await self.async_update()\r\n  File \"/usr/src/homeassistant/homeassistant/components/linkplay/media_player.py\", line 132, in _wrap\r\n    raise HomeAssistantError(\r\nhomeassistant.exceptions.HomeAssistantError: Exception occurred when communicating with API <function LinkPlayMediaPlayerEntity.async_update at 0x7f0ecef36980>:  error requesting data from 'https://192.168.150.116/httpapi.asp?command=getPlayerStatusEx'\nI'm trying to get diagnostics added to the integration so this can be further diagnosed.\nCould you share the output of http(s)://\\<ip\\>/httpapi.asp?command=getPlayerStatusEx when the device reports \"Idle\" in Home Assistant? Based on the device, it may be http or https. \r\n\r\nJust as a note: \r\n* Support for the stop/power off has been added just today. \r\n* Seek options are only available when it reports playing, for some reason it says \"idle\". \r\n* The wifi option is missing. I see some implementations add this by default. \r\n* It should be smart enough to check upon start if the player supports http or https. I'm not sure why it throws errors there. \n> Could you share the output of http(s)://<ip>/httpapi.asp?command=getPlayerStatusEx when the device reports \"Idle\" in Home Assistant? Based on the device, it may be http or https.\r\n\r\n`404: Not Found`\r\n\nJust noticed this in the logs too:\r\n\r\n```\r\nUpdate for media_player.kitchen_stereo_linkplay fails\r\n\r\nTraceback (most recent call last):\r\n  File \"/usr/src/homeassistant/homeassistant/helpers/entity.py\", line 942, in async_update_ha_state\r\n    await self.async_device_update()\r\n  File \"/usr/src/homeassistant/homeassistant/helpers/entity.py\", line 1300, in async_device_update\r\n    await self.async_update()\r\n  File \"/usr/src/homeassistant/homeassistant/components/linkplay/media_player.py\", line 130, in _wrap\r\n    return await func(self, *args, **kwargs)\r\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/src/homeassistant/homeassistant/components/linkplay/media_player.py\", line 175, in async_update\r\n    self._update_properties()\r\n  File \"/usr/src/homeassistant/homeassistant/components/linkplay/media_player.py\", line 266, in _update_properties\r\n    self._attr_source = SOURCE_MAP.get(self._bridge.player.play_mode, \"other\")\r\n                                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/local/lib/python3.12/site-packages/linkplay/bridge.py\", line 227, in play_mode\r\n    return PlayingMode(\r\n           ^^^^^^^^^^^^\r\n  File \"/usr/local/lib/python3.12/enum.py\", line 757, in __call__\r\n    return cls.__new__(cls, value)\r\n           ^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/local/lib/python3.12/enum.py\", line 1171, in __new__\r\n    raise ve_exc\r\nValueError: '32' is not a valid PlayingMode\r\n```\n> Could you share the output of http(s)://<ip>/httpapi.asp?command=getPlayerStatusEx when the device reports \"Idle\" in Home Assistant? Based on the device, it may be http or https.\r\n> \r\n> Just as a note:\r\n> \r\n> * Support for the stop/power off has been added just today.\r\n> * Seek options are only available when it reports playing, for some reason it says \"idle\".\r\n> * The wifi option is missing. I see some implementations add this by default.\r\n> * It should be smart enough to check upon start if the player supports http or https. I'm not sure why it throws errors there.\r\n\r\nNot sure what your are asking. When I enter this address in my browser with the speaker ip I get a bad cert error. \nI'll wait for the debugging and diagnostics to be added, which will probably land in 2024.11.0. \r\n\r\nIf you want to try another attempt: \r\n\r\nhttp://\\<ip\\>/httpapi.asp?command=getPlayerStatus\r\nhttps://\\<ip\\>/httpapi.asp?command=getPlayerStatus\r\nhttp://\\<ip\\>/httpapi.asp?command=getPlayerStatusEx\r\nhttps://\\<ip\\>/httpapi.asp?command=getPlayerStatusEx\r\n\r\nAny of the previous links should definiately work, but it's based on what device you own. \r\n\r\nAlso consider to test on the latest stable version if you don't already. \n![image](https://github.com/user-attachments/assets/1ef1ce7d-47d9-4b76-9cff-106b738777b3)\r\n\r\nTried them all and they fail with connection refused. https://my Speaker IP/httpapi.asp?command=getPlayerStatusEx gives out a cert error.\r\n\r\nI can play music to this speaker with the integration without issue. \nWe'll wait for the debugging to be added then, thanks for trying though! :) \nThere hasn't been any activity on this issue recently. Due to the high number of incoming GitHub notifications, we have to clean some of the old issues, as many of them have already been resolved with the latest updates.\nPlease make sure to update to the latest Home Assistant version and check if that solves the issue. Let us know if that works for you by adding a comment \ud83d\udc4d\nThis issue has now been marked as stale and will be closed if no further activity occurs. Thank you for your contributions.\n@home-assistant remove-label needs-more-information\nThere hasn't been any activity on this issue recently. Due to the high number of incoming GitHub notifications, we have to clean some of the old issues, as many of them have already been resolved with the latest updates.\nPlease make sure to update to the latest Home Assistant version and check if that solves the issue. Let us know if that works for you by adding a comment \ud83d\udc4d\nThis issue has now been marked as stale and will be closed if no further activity occurs. Thank you for your contributions.\n@home-assistant remove-label needs-more-information\n@Joe31388 @corgana  If you have already upgraded to 2024.11.0, chances are big you may have seen that most of the issues posted in this issue are solved. If not or some issue still happens, enable debug logging in that version and provide the logging if possible. Looking forward to hear back. \r\n\nUpdated to 2024.11.0 and nothing has appeared to change:\r\n\r\n`Traceback (most recent call last):\r\n  File \"/usr/src/homeassistant/homeassistant/components/websocket_api/commands.py\", line 245, in handle_call_service\r\n    response = await hass.services.async_call(\r\n               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/src/homeassistant/homeassistant/core.py\", line 2802, in async_call\r\n    response_data = await coro\r\n                    ^^^^^^^^^^\r\n  File \"/usr/src/homeassistant/homeassistant/core.py\", line 2845, in _execute_service\r\n    return await target(service_call)\r\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/src/homeassistant/homeassistant/helpers/service.py\", line 989, in entity_service_call\r\n    raise HomeAssistantError(\r\nhomeassistant.exceptions.HomeAssistantError: Entity media_player.stereo does not support this service.`\r\n\r\nOutput of: http://<ip>/httpapi.asp?command=getPlayerStatus when device reports idle:\r\n\r\n`{\"type\":\"0\",\"ch\":\"0\",\"mode\":\"32\",\"loop\":\"4\",\"eq\":\"0\",\"vendor\":\"\",\"status\":\"stop\",\"curpos\":\"0\",\"offset_pts\":\"28554\",\"totlen\":\"512000\",\"Title\":\"\",\"Artist\":\"\",\"Album\":\"\",\"alarmflag\":\"0\",\"plicount\":\"0\",\"plicurr\":\"0\",\"vol\":\"5\",\"mute\":\"0\"}`\r\n\r\n\nI also noticed these in the log (as far as I can tell they were triggered before I was trying to \"power off\")\r\n\r\n```\r\nUpdate for media_player.stereo fails \r\nLogger: homeassistant.helpers.entity\r\nSource: helpers/entity.py:944\r\nFirst occurred: November 8, 2024 at 7:53:37 PM (98 occurrences)\r\nLast logged: 6:54:39 AM\r\n\r\nUpdate for media_player.kitchen_stereo fails\r\nTraceback (most recent call last):\r\n  File \"/usr/local/lib/python3.12/site-packages/linkplay/utils.py\", line 46, in session_call_api\r\n    response = await session.get(url)\r\n               ^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/local/lib/python3.12/site-packages/aiohttp/client.py\", line 663, in _request\r\n    conn = await self._connector.connect(\r\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/local/lib/python3.12/site-packages/aiohttp/connector.py\", line 563, in connect\r\n    proto = await self._create_connection(req, traces, timeout)\r\n            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/local/lib/python3.12/site-packages/aiohttp/connector.py\", line 1032, in _create_connection\r\n    _, proto = await self._create_direct_connection(req, traces, timeout)\r\n               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/local/lib/python3.12/site-packages/aiohttp/connector.py\", line 1335, in _create_direct_connection\r\n    transp, proto = await self._wrap_create_connection(\r\n                    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/local/lib/python3.12/site-packages/aiohttp/connector.py\", line 1091, in _wrap_create_connection\r\n    sock = await aiohappyeyeballs.start_connection(\r\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/local/lib/python3.12/site-packages/aiohappyeyeballs/impl.py\", line 82, in start_connection\r\n    sock = await _connect_sock(\r\n           ^^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/local/lib/python3.12/site-packages/aiohappyeyeballs/impl.py\", line 174, in _connect_sock\r\n    await loop.sock_connect(sock, address)\r\n  File \"/usr/local/lib/python3.12/asyncio/selector_events.py\", line 641, in sock_connect\r\n    return await fut\r\n           ^^^^^^^^^\r\nasyncio.exceptions.CancelledError\r\n\r\nDuring handling of the above exception, another exception occurred:\r\n\r\nTraceback (most recent call last):\r\n  File \"/usr/local/lib/python3.12/site-packages/linkplay/utils.py\", line 45, in session_call_api\r\n    async with async_timeout.timeout(API_TIMEOUT):\r\n  File \"/usr/local/lib/python3.12/site-packages/async_timeout/__init__.py\", line 141, in __aexit__\r\n    self._do_exit(exc_type)\r\n  File \"/usr/local/lib/python3.12/site-packages/async_timeout/__init__.py\", line 228, in _do_exit\r\n    raise asyncio.TimeoutError\r\nTimeoutError\r\n\r\nThe above exception was the direct cause of the following exception:\r\n\r\nTraceback (most recent call last):\r\n  File \"/usr/src/homeassistant/homeassistant/components/linkplay/media_player.py\", line 153, in _wrap\r\n    return await func(self, *args, **kwargs)\r\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/src/homeassistant/homeassistant/components/linkplay/media_player.py\", line 202, in async_update\r\n    await self._bridge.player.update_status()\r\n  File \"/usr/local/lib/python3.12/site-packages/linkplay/bridge.py\", line 95, in update_status\r\n    properties: dict[PlayerAttribute, str] = await self.bridge.json_request(\r\n                                             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/local/lib/python3.12/site-packages/linkplay/bridge.py\", line 301, in json_request\r\n    response = await self.endpoint.json_request(command)\r\n               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/local/lib/python3.12/site-packages/linkplay/endpoint.py\", line 51, in json_request\r\n    return await session_call_api_json(self._endpoint, self._session, command)\r\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/local/lib/python3.12/site-packages/linkplay/utils.py\", line 65, in session_call_api_json\r\n    result = await session_call_api(endpoint, session, command)\r\n             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/local/lib/python3.12/site-packages/linkplay/utils.py\", line 49, in session_call_api\r\n    raise LinkPlayRequestException(\r\nlinkplay.exceptions.LinkPlayRequestException:  error requesting data from 'https://192.168.222.22/httpapi.asp?command=getPlayerStatusEx'\r\n\r\nThe above exception was the direct cause of the following exception:\r\n\r\nTraceback (most recent call last):\r\n  File \"/usr/src/homeassistant/homeassistant/helpers/entity.py\", line 944, in async_update_ha_state\r\n    await self.async_device_update()\r\n  File \"/usr/src/homeassistant/homeassistant/helpers/entity.py\", line 1302, in async_device_update\r\n    await self.async_update()\r\n  File \"/usr/src/homeassistant/homeassistant/components/linkplay/media_player.py\", line 155, in _wrap\r\n    raise HomeAssistantError(\r\nhomeassistant.exceptions.HomeAssistantError: Exception occurred when communicating with API <function LinkPlayMediaPlayerEntity.async_update at 0x7f29e428f2e0>:  error requesting data from 'https://192.168.222.22/httpapi.asp?command=getPlayerStatusEx'\r\n```\r\nAnd:\r\n\r\n```\r\n    [Stereo(192.168.222.22):8009] Failed to connect to service MDNSServiceInfo(name='WiiM-AMP-087bfef615d60b761cd222d0545c5406._googlecast._tcp.local.'), retrying in 5.0s\r\n    [Audio Group(192.168.222.22):32235] Failed to connect to service HostServiceInfo(host='192.168.222.22', port=32235), retrying in 5.0s\r\n    [Stereo(192.168.222.22):8009] Failed to connect to service HostServiceInfo(host='192.168.222.22', port=8009), retrying in 5.0s\r\n    [Chromecast(192.168.222.26):8009] Failed to connect to service HostServiceInfo(host='192.168.222.26', port=8009), retrying in 5.0s\r\n    [Chromecastaudio(192.168.222.27):8009] Failed to connect to service HostServiceInfo(host='192.168.222.27', port=8009), retrying in 5.0s\r\n```\n> Updated to 2024.11.0 and nothing has appeared to change. \r\n\r\nThat's very unfortunate. Thank you for providing the information, perfect to get issue further progressed towards resolution. \r\n\r\n", "created_at": "2024-11-11T11:30:39Z"}
{"repo": "home-assistant/core", "pull_number": 130348, "instance_id": "home-assistant__core-130348", "issue_numbers": ["130130"], "base_commit": "88480d154a9a53b7227a67bca2aa5875085548b8", "patch": "diff --git a/homeassistant/components/linkplay/manifest.json b/homeassistant/components/linkplay/manifest.json\nindex 9ddb6abf093980..e74d22b8207e88 100644\n--- a/homeassistant/components/linkplay/manifest.json\n+++ b/homeassistant/components/linkplay/manifest.json\n@@ -7,6 +7,6 @@\n   \"integration_type\": \"hub\",\n   \"iot_class\": \"local_polling\",\n   \"loggers\": [\"linkplay\"],\n-  \"requirements\": [\"python-linkplay==0.0.18\"],\n+  \"requirements\": [\"python-linkplay==0.0.20\"],\n   \"zeroconf\": [\"_linkplay._tcp.local.\"]\n }\ndiff --git a/requirements_all.txt b/requirements_all.txt\nindex 7cf0190a6aa4be..d582647d732b73 100644\n--- a/requirements_all.txt\n+++ b/requirements_all.txt\n@@ -2362,7 +2362,7 @@ python-juicenet==1.1.0\n python-kasa[speedups]==0.7.7\n \n # homeassistant.components.linkplay\n-python-linkplay==0.0.18\n+python-linkplay==0.0.20\n \n # homeassistant.components.lirc\n # python-lirc==1.2.3\n", "test_patch": "diff --git a/requirements_test_all.txt b/requirements_test_all.txt\nindex 9332c74adc31b6..2a48ec704336e0 100644\n--- a/requirements_test_all.txt\n+++ b/requirements_test_all.txt\n@@ -1889,7 +1889,7 @@ python-juicenet==1.1.0\n python-kasa[speedups]==0.7.7\n \n # homeassistant.components.linkplay\n-python-linkplay==0.0.18\n+python-linkplay==0.0.20\n \n # homeassistant.components.matter\n python-matter-server==6.6.0\n", "problem_statement": "Linkplay does not load on 2024.11\n### The problem\n\nAfter upgrade to 2024.11 linkplay integration fails to load any of my linkplay devices. They are mostly wiim but not all. \n\n### What version of Home Assistant Core has the issue?\n\ncore-2024.11\n\n### What was the last working version of Home Assistant Core?\n\ncore-2024.10.4\n\n### What type of installation are you running?\n\nHome Assistant OS\n\n### Integration causing the issue\n\nlinkplay\n\n### Link to integration documentation on our website\n\nhttps://www.home-assistant.io/integrations/linkplay\n\n### Diagnostics information\n\n_No response_\n\n### Example YAML snippet\n\n_No response_\n\n### Anything in the logs that might be useful for us?\n\n```txt\nTraceback (most recent call last):\r\n  File \"/usr/src/homeassistant/homeassistant/config_entries.py\", line 635, in __async_setup_with_context\r\n    result = await component.async_setup_entry(hass, self)\r\n             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/src/homeassistant/homeassistant/components/linkplay/__init__.py\", line 54, in async_setup_entry\r\n    await controller.discover_multirooms()\r\n  File \"/usr/local/lib/python3.12/site-packages/linkplay/controller.py\", line 68, in discover_multirooms\r\n    await multiroom.update_status(self.bridges)\r\n  File \"/usr/local/lib/python3.12/site-packages/linkplay/bridge.py\", line 332, in update_status\r\n    properties: dict[Any, Any] = await self.leader.json_request(\r\n                                 ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/local/lib/python3.12/site-packages/linkplay/bridge.py\", line 301, in json_request\r\n    response = await self.endpoint.json_request(command)\r\n               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/local/lib/python3.12/site-packages/linkplay/endpoint.py\", line 51, in json_request\r\n    return await session_call_api_json(self._endpoint, self._session, command)\r\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/local/lib/python3.12/site-packages/linkplay/utils.py\", line 66, in session_call_api_json\r\n    return json.loads(result)  # type: ignore\r\n           ^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/local/lib/python3.12/json/__init__.py\", line 346, in loads\r\n    return _default_decoder.decode(s)\r\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/local/lib/python3.12/json/decoder.py\", line 337, in decode\r\n    obj, end = self.raw_decode(s, idx=_w(s, 0).end())\r\n               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/local/lib/python3.12/json/decoder.py\", line 355, in raw_decode\r\n    raise JSONDecodeError(\"Expecting value\", s, err.value) from None\r\njson.decoder.JSONDecodeError: Expecting value: line 1 column 1 (char 0)\n```\n\n\n### Additional information\n\n_No response_\n", "hints_text": "\nHey there @velleman, mind taking a look at this issue as it has been labeled with an integration (`linkplay`) you are listed as a [code owner](https://github.com/home-assistant/core/blob/dev/CODEOWNERS#L834) for? Thanks!\n\n<details>\n<summary>Code owner commands</summary>\n\n\nCode owners of `linkplay` can trigger bot actions by commenting:\n\n- `@home-assistant close` Closes the issue.\n- `@home-assistant rename Awesome new title` Renames the issue.\n- `@home-assistant reopen` Reopen the issue.\n- `@home-assistant unassign linkplay` Removes the current integration label and assignees on the issue, add the integration domain after the command.\n- `@home-assistant add-label needs-more-information` Add a label (needs-more-information, problem in dependency, problem in custom component) to the issue.\n- `@home-assistant remove-label needs-more-information` Remove a label (needs-more-information, problem in dependency, problem in custom component) on the issue.\n\n</details>\n\n\n<sub><sup>(message by CodeOwnersMention)</sup></sub>\n\n---\n\n[linkplay documentation](https://www.home-assistant.io/integrations/linkplay)\n[linkplay source](https://github.com/home-assistant/core/tree/dev/homeassistant/components/linkplay)\n<sub><sup>(message by IssueLinks)</sup></sub>\nIf you could enable debug logging on the integration, it will log the api calls it's doing with the newest release.\r\nThe issue is related to the newly introduced multiroom functionality. \nDoes this help?\r\n\r\n\r\n```\r\n2024-11-08 16:08:16.043 DEBUG (MainThread) [linkplay] Request getStatusEx at https://192.168.2.137\r\n2024-11-08 16:08:16.160 DEBUG (MainThread) [linkplay] Response getStatusEx: {'language': 'en_us', 'ssid': 'WiiM Mini-9816', 'hideSSID': '0', 'firmware': 'Linkplay.4.6.634732', 'build': 'release', 'project': 'Muzo_Mini', 'priv_prj': 'Muzo_Mini', 'Release': '20241106', 'FW_Release_version': '', 'PCB_version': '0', 'group': '0', 'wmrm_version': '4.2', 'expired': '0', 'internet': '1', 'uuid': 'FF9700162850602700F79D5E', 'MAC': 'C0:F5:35:97:98:16', 'BT_MAC': 'C0:F5:35:97:98:17', 'AP_MAC': 'C2:F5:35:97:98:16', 'date': '2024:11:08', 'time': '21:08:16', 'netstat': '2', 'essid': '72696F', 'apcli0': '192.168.2.137', 'eth0': '0.0.0.0', 'ETH_MAC': '00:00:00:00:00:00', 'hardware': 'ALLWINNER-R328', 'ota_api_ver': '3.0', 'VersionUpdate': '0', 'NewVer': '0', 'mcu_ver': '0', 'mcu_ver_new': '0', 'update_check_count': '25', 'BleRemote_update_checked_counter': '0', 'ra0': '10.10.10.254', 'temp_uuid': '6AF770D3A2D71CC8', 'cap1': '0x400', 'capability': '0x20084008', 'languages': '0x1ec', 'prompt_status': '1', 'alexa_ver': '20180604', 'alexa_beta_enable': '0', 'alexa_force_beta_cfg': '0', 'dsp_ver': '0', 'ModuleColorNumber': '0', 'ModuleColorString': '', 'streams_all': '0xffffbfd', 'streams': '0xffffbfd', 'region': 'unknown', 'volume_control': '0', 'external': '0x0', 'preset_key': '12', 'plm_support': '0x300006', 'mqtt_support': '1', 'lbc_support': '0', 'WifiChannel': '0', 'RSSI': '-40', 'BSSID': '30:3A:4A:F8:F1:A6', 'wlanSnr': '35', 'wlanNoise': '-91', 'wlanFreq': '5220', 'wlanDataRate': '433', 'battery': '0', 'battery_percent': '0', 'securemode': '1', 'ota_interface_ver': '2.0', 'upnp_version': '1005', 'upnp_uuid': 'uuid:FF970016-2850-6027-00F7-9D5EFF970016', 'uart_pass_port': '0', 'communication_port': '8819', 'web_firmware_update_hide': '0', 'tidal_version': '2.0', 'service_version': '1.0', 'EQ_support': 'Eq4p_ver_3.0', 'EQVersion': '3.0.99', 'audio_channel_config': '1.0', 'app_timezone_id': 'America/New_York', 'avs_timezone_id': 'America/New_York', 'tz_info_ver': '1.0', 'tz': '-4.0', 'HiFiSRC_version': '1.0', 'max_volume': '100', 'power_mode': '-1', 'security': 'https/2.0', 'security_version': '3.0', 'security_capabilities': {'ver': '1.0', 'aes_ver': '1.0'}, 'public_https_version': '1.0', 'BleRemoteControl': '1', 'BleRemoteConnected': '0', 'autoSenseVersion': '1.0', 'set_play_mode_enable': '1', 'privacy_mode': '0', 'DeviceName': 'Bedroom', 'GroupName': 'Bedroom'}\r\n2024-11-08 16:08:16.161 DEBUG (MainThread) [linkplay] Request getPlayerStatusEx at https://192.168.2.137\r\n2024-11-08 16:08:16.270 DEBUG (MainThread) [linkplay] Response getPlayerStatusEx: {'type': '0', 'ch': '0', 'mode': '10', 'loop': '0', 'eq': '0', 'vendor': 'CustomPushUrl', 'status': 'pause', 'curpos': '31455503', 'offset_pts': '31455503', 'totlen': '41874000', 'alarmflag': '0', 'plicount': '0', 'plicurr': '0', 'vol': '49', 'mute': '0'}\r\n2024-11-08 16:08:16.271 DEBUG (MainThread) [linkplay] Request multiroom:getSlaveList at https://192.168.2.174\r\n2024-11-08 16:08:16.363 DEBUG (MainThread) [linkplay] Response multiroom:getSlaveList: {'slaves': 0, 'wmrm_version': '4.2'}\r\n2024-11-08 16:08:16.364 DEBUG (MainThread) [linkplay] Request multiroom:getSlaveList at https://192.168.2.137\r\n2024-11-08 16:08:16.479 DEBUG (MainThread) [linkplay] Response multiroom:getSlaveList: {'slaves': 0, 'wmrm_version': '4.2'}\r\n2024-11-08 16:08:16.480 DEBUG (MainThread) [linkplay] Request multiroom:getSlaveList at https://192.168.2.176\r\n2024-11-08 16:08:16.586 DEBUG (MainThread) [linkplay] Response multiroom:getSlaveList: {'slaves': 0, 'wmrm_version': '4.2'}\r\n2024-11-08 16:08:16.586 DEBUG (MainThread) [linkplay] Request multiroom:getSlaveList at https://192.168.2.170\r\n2024-11-08 16:08:16.689 DEBUG (MainThread) [linkplay] Response multiroom:getSlaveList: {'slaves': 0, 'wmrm_version': '4.2'}\r\n2024-11-08 16:08:16.690 DEBUG (MainThread) [linkplay] Request multiroom:getSlaveList at https://192.168.2.177\r\n2024-11-08 16:08:16.797 ERROR (MainThread) [homeassistant.config_entries] Error setting up entry Bedroom for linkplay\r\nTraceback (most recent call last):\r\n  File \"/usr/src/homeassistant/homeassistant/config_entries.py\", line 635, in __async_setup_with_context\r\n    result = await component.async_setup_entry(hass, self)\r\n             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/src/homeassistant/homeassistant/components/linkplay/__init__.py\", line 54, in async_setup_entry\r\n    await controller.discover_multirooms()\r\n  File \"/usr/local/lib/python3.12/site-packages/linkplay/controller.py\", line 68, in discover_multirooms\r\n    await multiroom.update_status(self.bridges)\r\n  File \"/usr/local/lib/python3.12/site-packages/linkplay/bridge.py\", line 332, in update_status\r\n    properties: dict[Any, Any] = await self.leader.json_request(\r\n                                 ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/local/lib/python3.12/site-packages/linkplay/bridge.py\", line 301, in json_request\r\n    response = await self.endpoint.json_request(command)\r\n               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/local/lib/python3.12/site-packages/linkplay/endpoint.py\", line 51, in json_request\r\n    return await session_call_api_json(self._endpoint, self._session, command)\r\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/local/lib/python3.12/site-packages/linkplay/utils.py\", line 66, in session_call_api_json\r\n    return json.loads(result)  # type: ignore\r\n           ^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/local/lib/python3.12/json/__init__.py\", line 346, in loads\r\n    return _default_decoder.decode(s)\r\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/local/lib/python3.12/json/decoder.py\", line 337, in decode\r\n    obj, end = self.raw_decode(s, idx=_w(s, 0).end())\r\n               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/local/lib/python3.12/json/decoder.py\", line 355, in raw_decode\r\n    raise JSONDecodeError(\"Expecting value\", s, err.value) from None\r\njson.decoder.JSONDecodeError: Expecting value: line 1 column 1 (char 0)\r\n```\r\n\nI think this is the device I have at 192.168.2.177 not returning any data for getslavelist. That device is a Yamaha soundbar yas-109. I disabled that device in the integration and tried reloading another speaker but it still failed. \nPerhaps a restart may help. The multiroom functionality is shared since it combines multiple linkplay entities together. \n\nThank you anyway for responding. I will take a look at hardening the logic so it doesn't fail to load the entire integration. \n\nJust one more question, does this device have multiroom at all or is it malfunctioning on that part?\nRestarting hasn\u2019t made a difference. I don\u2019t know if that device supports\r\nlinking or not. I\u2019ve never linked it. It doesn\u2019t show up in the WiiM app\r\nwhich is what I use for linking. Thanks for your help!\r\n\r\nOn Fri, Nov 8, 2024 at 5:01\u202fPM Simon Lamon ***@***.***> wrote:\r\n\r\n> Perhaps a restart may help. The multiroom functionality is shared since it\r\n> combines multiple linkplay entities together.\r\n>\r\n> Thank you anyway for responding. I will take a look at hardening the logic\r\n> so it doesn't fail to load the entire integration.\r\n>\r\n> Just one more question, does this device have multiroom at all or is it\r\n> malfunctioning on that part?\r\n>\r\n> \u2014\r\n> Reply to this email directly, view it on GitHub\r\n> <https://github.com/home-assistant/core/issues/130130#issuecomment-2465817163>,\r\n> or unsubscribe\r\n> <https://github.com/notifications/unsubscribe-auth/AEHXED4WUWLGYZEMO5KPWA3Z7UYDHAVCNFSM6AAAAABRNMEZHWVHI2DSMVQWIX3LMV43OSLTON2WKQ3PNVWWK3TUHMZDINRVHAYTOMJWGM>\r\n> .\r\n> You are receiving this because you authored the thread.Message ID:\r\n> ***@***.***>\r\n>\r\n\nI've added logging to know what it responds and it should handle invalid responses to prevent the integration from loading at all. I hope to have it added for 2024.11.2 next week.   ", "created_at": "2024-11-11T11:24:02Z"}
{"repo": "home-assistant/core", "pull_number": 130311, "instance_id": "home-assistant__core-130311", "issue_numbers": ["129867"], "base_commit": "e040eb0ff21e7646a793a0697552aff2a7beb975", "patch": "diff --git a/homeassistant/components/homekit/type_security_systems.py b/homeassistant/components/homekit/type_security_systems.py\nindex 9f3f183f11fd49..8634589cb5f576 100644\n--- a/homeassistant/components/homekit/type_security_systems.py\n+++ b/homeassistant/components/homekit/type_security_systems.py\n@@ -18,6 +18,8 @@\n     SERVICE_ALARM_ARM_HOME,\n     SERVICE_ALARM_ARM_NIGHT,\n     SERVICE_ALARM_DISARM,\n+    STATE_UNAVAILABLE,\n+    STATE_UNKNOWN,\n )\n from homeassistant.core import State, callback\n \n@@ -152,12 +154,12 @@ def set_security_state(self, value: int) -> None:\n     @callback\n     def async_update_state(self, new_state: State) -> None:\n         \"\"\"Update security state after state changed.\"\"\"\n-        hass_state = None\n-        if new_state and new_state.state == \"None\":\n-            # Bail out early for no state\n+        hass_state: str | AlarmControlPanelState = new_state.state\n+        if hass_state in {\"None\", STATE_UNKNOWN, STATE_UNAVAILABLE}:\n+            # Bail out early for no state, unknown or unavailable\n             return\n-        if new_state and new_state.state is not None:\n-            hass_state = AlarmControlPanelState(new_state.state)\n+        if hass_state is not None:\n+            hass_state = AlarmControlPanelState(hass_state)\n         if (\n             hass_state\n             and (current_state := HASS_TO_HOMEKIT_CURRENT.get(hass_state)) is not None\n", "test_patch": "diff --git a/tests/components/homekit/test_type_security_systems.py b/tests/components/homekit/test_type_security_systems.py\nindex 8377d847a7acd9..94b0e68e76d6e7 100644\n--- a/tests/components/homekit/test_type_security_systems.py\n+++ b/tests/components/homekit/test_type_security_systems.py\n@@ -10,7 +10,12 @@\n )\n from homeassistant.components.homekit.const import ATTR_VALUE\n from homeassistant.components.homekit.type_security_systems import SecuritySystem\n-from homeassistant.const import ATTR_CODE, ATTR_ENTITY_ID, STATE_UNKNOWN\n+from homeassistant.const import (\n+    ATTR_CODE,\n+    ATTR_ENTITY_ID,\n+    STATE_UNAVAILABLE,\n+    STATE_UNKNOWN,\n+)\n from homeassistant.core import Event, HomeAssistant\n \n from tests.common import async_mock_service\n@@ -307,3 +312,33 @@ async def test_supported_states(hass: HomeAssistant, hk_driver) -> None:\n \n         for val in valid_target_values.values():\n             assert val in test_config.get(\"target_values\")\n+\n+\n+@pytest.mark.parametrize(\n+    (\"state\"),\n+    [\n+        (None),\n+        (\"None\"),\n+        (STATE_UNKNOWN),\n+        (STATE_UNAVAILABLE),\n+    ],\n+)\n+async def test_handle_non_alarm_states(\n+    hass: HomeAssistant, hk_driver, events: list[Event], state: str\n+) -> None:\n+    \"\"\"Test we can handle states that should not raise.\"\"\"\n+    code = \"1234\"\n+    config = {ATTR_CODE: code}\n+    entity_id = \"alarm_control_panel.test\"\n+\n+    hass.states.async_set(entity_id, state)\n+    await hass.async_block_till_done()\n+    acc = SecuritySystem(hass, hk_driver, \"SecuritySystem\", entity_id, 2, config)\n+    acc.run()\n+    await hass.async_block_till_done()\n+\n+    assert acc.aid == 2\n+    assert acc.category == 11  # AlarmSystem\n+\n+    assert acc.char_current_state.value == 3\n+    assert acc.char_target_state.value == 3\n", "problem_statement": "Alarm control panel exported to HomeKit bridge error\n### The problem\n\nI am using the Ness integration which provides an alarm control panel (interface to a Ness security panel) which is then exported via a HomeKit bridge. \r\n\r\nHowever, the error below is observed and the control panel does not get correctly exported whereas it did work fine previously. \r\n\r\nThe alarm control panel works fine within Home Assistant itself.\r\n\r\nIt's unclear to me if the issue is within the HomeKit or Ness integration.\r\n\r\n```\r\nLogger: homeassistant.components.homekit\r\nSource: components/homekit/__init__.py:758\r\nintegration: HomeKit Bridge ([documentation](https://next.home-assistant.io/integrations/homekit), [issues](https://github.com/home-assistant/core/issues?q=is%3Aissue+is%3Aopen+label%3A%22integration%3A+homekit%22))\r\nFirst occurred: 10:11:14 (1 occurrences)\r\nLast logged: 10:11:14\r\n\r\nFailed to create a HomeKit accessory for alarm_control_panel.alarm_panel\r\nTraceback (most recent call last):\r\n  File \"/usr/src/homeassistant/homeassistant/components/homekit/__init__.py\", line 758, in add_bridge_accessory\r\n    acc = get_accessory(self.hass, self.driver, state, aid, conf)\r\n          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/src/homeassistant/homeassistant/components/homekit/accessories.py\", line 280, in get_accessory\r\n    return TYPES[a_type](hass, driver, name, state.entity_id, aid, config)\r\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/src/homeassistant/homeassistant/components/homekit/type_security_systems.py\", line 141, in __init__\r\n    self.async_update_state(state)\r\n  File \"/usr/src/homeassistant/homeassistant/components/homekit/type_security_systems.py\", line 160, in async_update_state\r\n    hass_state = AlarmControlPanelState(new_state.state)\r\n                 ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/local/lib/python3.12/enum.py\", line 757, in __call__\r\n    return cls.__new__(cls, value)\r\n           ^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/local/lib/python3.12/enum.py\", line 1171, in __new__\r\n    raise ve_exc\r\nValueError: 'unknown' is not a valid AlarmControlPanelState\r\n```\n\n### What version of Home Assistant Core has the issue?\n\ncore-2024.12.0.dev202411040232\n\n### What was the last working version of Home Assistant Core?\n\n_No response_\n\n### What type of installation are you running?\n\nHome Assistant OS\n\n### Integration causing the issue\n\nHomekit\n\n### Link to integration documentation on our website\n\nhttps://www.home-assistant.io/integrations/homekit/\n\n### Diagnostics information\n\n[config_entry-homekit-120ba354f429702065ab0df787cd0d1e.json](https://github.com/user-attachments/files/17627322/config_entry-homekit-120ba354f429702065ab0df787cd0d1e.json)\r\n\n\n### Example YAML snippet\n\n```yaml\nHomekit YAML\r\n\r\n      include_domains:\r\n        - alarm_control_panel\r\n\r\n  entity_config:\r\n      alarm_control_panel.home:\r\n        code: 00000000\r\n\r\n\r\nNess YAML\r\n\r\nness_alarm:\r\n  host: 192.168.1.xxx\r\n  port: 23\r\n  scan_interval:\r\n    days: 0\r\n    hours: 0\r\n    minutes: 0\r\n    seconds: 2\r\n    milliseconds: 0\r\n  zones:\r\n    - name: Hall\r\n      id: 1\r\n    - name: Lounge\r\n      id: 2\r\n    - name: Gate\r\n      id: 3\r\n      type: garage_door\r\n    - name: \"Side Gate\"\r\n      id: 4\r\n      type: door\n```\n\n\n### Anything in the logs that might be useful for us?\n\n_No response_\n\n### Additional information\n\n_No response_\n", "hints_text": "\nHey there @bdraco, mind taking a look at this issue as it has been labeled with an integration (`homekit`) you are listed as a [code owner](https://github.com/home-assistant/core/blob/dev/CODEOWNERS#L634) for? Thanks!\n\n<details>\n<summary>Code owner commands</summary>\n\n\nCode owners of `homekit` can trigger bot actions by commenting:\n\n- `@home-assistant close` Closes the issue.\n- `@home-assistant rename Awesome new title` Renames the issue.\n- `@home-assistant reopen` Reopen the issue.\n- `@home-assistant unassign homekit` Removes the current integration label and assignees on the issue, add the integration domain after the command.\n- `@home-assistant add-label needs-more-information` Add a label (needs-more-information, problem in dependency, problem in custom component) to the issue.\n- `@home-assistant remove-label needs-more-information` Remove a label (needs-more-information, problem in dependency, problem in custom component) on the issue.\n\n</details>\n\n\n<sub><sup>(message by CodeOwnersMention)</sup></sub>\n\n---\n\n[homekit documentation](https://www.home-assistant.io/integrations/homekit)\n[homekit source](https://github.com/home-assistant/core/tree/dev/homeassistant/components/homekit)\n<sub><sup>(message by IssueLinks)</sup></sub>\nThis appears to be a timing-related issue. After a full restart, the HomeKit AlarmControlPanel item isn't being exported by HomeKit bridge. But if I just restart the relevant bridge integration, the alarm control panel is exported and appears in the Home app etc.\r\n\r\nHappy to provide more information as required.\nSame issue with Ring Alarm via the Ring Add-on with MQTT.  Reloading that particular bridge resolves it.  Is there a way to automate bridge reloading when Alarm state changes from \"unavailable\"?  Just updated to 2024.11.1 and this is still happening.\r\n\r\n`Logger: homeassistant.components.homekit\r\nSource: components/homekit/__init__.py:758\r\nintegration: HomeKit Bridge (documentation, issues)\r\nFirst occurred: 8:22:35 PM (1 occurrences)\r\nLast logged: 8:22:35 PM\r\n\r\nFailed to create a HomeKit accessory for alarm_control_panel.home_alarm\r\nTraceback (most recent call last):\r\n  File \"/usr/src/homeassistant/homeassistant/components/homekit/__init__.py\", line 758, in add_bridge_accessory\r\n    acc = get_accessory(self.hass, self.driver, state, aid, conf)\r\n          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/src/homeassistant/homeassistant/components/homekit/accessories.py\", line 280, in get_accessory\r\n    return TYPES[a_type](hass, driver, name, state.entity_id, aid, config)\r\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/src/homeassistant/homeassistant/components/homekit/type_security_systems.py\", line 141, in __init__\r\n    self.async_update_state(state)\r\n  File \"/usr/src/homeassistant/homeassistant/components/homekit/type_security_systems.py\", line 160, in async_update_state\r\n    hass_state = AlarmControlPanelState(new_state.state)\r\n                 ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/local/lib/python3.12/enum.py\", line 757, in __call__\r\n    return cls.__new__(cls, value)\r\n           ^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/local/lib/python3.12/enum.py\", line 1171, in __new__\r\n    raise ve_exc\r\nValueError: 'unavailable' is not a valid AlarmControlPanelState\r\n`\n@gjohansson-ST this appears to be caused by the new `AlarmControlPanelState` enum added in https://github.com/home-assistant/core/pull/126283. The enum does not include the 'unavailable' state, which is valid and documented in https://www.home-assistant.io/integrations/alarm_control_panel/. Note that 'unknown' is also a valid, documented state which is not present in the enum.", "created_at": "2024-11-10T21:41:38Z"}
{"repo": "home-assistant/core", "pull_number": 130301, "instance_id": "home-assistant__core-130301", "issue_numbers": ["121511"], "base_commit": "980b0fa5e693fb5e51640b96d398d1a6ef32bae5", "patch": "diff --git a/homeassistant/components/shelly/coordinator.py b/homeassistant/components/shelly/coordinator.py\nindex 6332e139244b9d..a66fbb20f481ed 100644\n--- a/homeassistant/components/shelly/coordinator.py\n+++ b/homeassistant/components/shelly/coordinator.py\n@@ -603,7 +603,7 @@ def _async_device_event_handler(self, event_data: dict[str, Any]) -> None:\n \n     async def _async_update_data(self) -> None:\n         \"\"\"Fetch data.\"\"\"\n-        if self.update_sleep_period():\n+        if self.update_sleep_period() or self.hass.is_stopping:\n             return\n \n         if self.sleep_period:\n", "test_patch": "", "problem_statement": "Shelly trace during shutdown: aiohttp session closed\n### The problem\r\n\r\nOften during shutdown, the log reports the attached trace\r\n\r\n### What version of Home Assistant Core has the issue?\r\n\r\n2024.7.1\r\n\r\n### What was the last working version of Home Assistant Core?\r\n\r\n2024.6.x\r\n\r\n### What type of installation are you running?\r\n\r\nHome Assistant Core\r\n\r\n### Integration causing the issue\r\n\r\nshelly\r\n\r\n### Link to integration documentation on our website\r\n\r\nhttps://www.home-assistant.io/integrations/shelly/\r\n\r\n### Diagnostics information\r\n\r\n_No response_\r\n\r\n### Example YAML snippet\r\n\r\n_No response_\r\n\r\n### Anything in the logs that might be useful for us?\r\n\r\n```txt\r\n2024-07-08 11:56:50.076 ERROR (MainThread) [homeassistant.components.shelly] Unexpected error fetching Presa Sala data\r\nTraceback (most recent call last):\r\n  File \"/usr/src/homeassistant/homeassistant/helpers/update_coordinator.py\", line 312, in _async_refresh\r\n    self.data = await self._async_update_data()\r\n                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n    if not await self._async_device_connect_task():\r\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/src/homeassistant/homeassistant/components/shelly/coordinator.py\", line 167, in _async_device_connect_task\r\n    await self.device.initialize()\r\n  File \"/usr/local/lib/python3.12/site-packages/aioshelly/rpc_device/device.py\", line 167, in initialize\r\n    self._shelly = await get_info(\r\n                   ^^^^^^^^^^^^^^^\r\n  File \"/usr/local/lib/python3.12/site-packages/aioshelly/common.py\", line 74, in get_info\r\n    async with aiohttp_session.get(\r\n  File \"/usr/local/lib/python3.12/site-packages/aiohttp/client.py\", line 1197, in __aenter__\r\n    self._resp = await self._coro\r\n                 ^^^^^^^^^^^^^^^^\r\n  File \"/usr/local/lib/python3.12/site-packages/aiohttp/client.py\", line 428, in _request\r\n    raise RuntimeError(\"Session is closed\")\r\nRuntimeError: Session is closed\r\n```\r\n\r\n\r\n### Additional information\r\n\r\n_No response_\n", "hints_text": "\nHey there @balloob, @bieniu, @thecode, @bdraco, mind taking a look at this issue as it has been labeled with an integration (`shelly`) you are listed as a [code owner](https://github.com/home-assistant/core/blob/dev/CODEOWNERS#L1269) for? Thanks!\n\n<details>\n<summary>Code owner commands</summary>\n\n\nCode owners of `shelly` can trigger bot actions by commenting:\n\n- `@home-assistant close` Closes the issue.\n- `@home-assistant rename Awesome new title` Renames the issue.\n- `@home-assistant reopen` Reopen the issue.\n- `@home-assistant unassign shelly` Removes the current integration label and assignees on the issue, add the integration domain after the command.\n- `@home-assistant add-label needs-more-information` Add a label (needs-more-information, problem in dependency, problem in custom component) to the issue.\n- `@home-assistant remove-label needs-more-information` Remove a label (needs-more-information, problem in dependency, problem in custom component) on the issue.\n\n</details>\n\n\n<sub><sup>(message by CodeOwnersMention)</sup></sub>\n\n---\n\n[shelly documentation](https://www.home-assistant.io/integrations/shelly)\n[shelly source](https://github.com/home-assistant/core/tree/dev/homeassistant/components/shelly)\n<sub><sup>(message by IssueLinks)</sup></sub>\nThere hasn't been any activity on this issue recently. Due to the high number of incoming GitHub notifications, we have to clean some of the old issues, as many of them have already been resolved with the latest updates.\nPlease make sure to update to the latest Home Assistant version and check if that solves the issue. Let us know if that works for you by adding a comment \ud83d\udc4d\nThis issue has now been marked as stale and will be closed if no further activity occurs. Thank you for your contributions.\nLooks like its a race where the session is closed before the coordinator does its next poll\nUpdated log:\r\n\r\n```\r\n2024-11-10 13:49:33.368 ERROR (MainThread) [homeassistant.components.shelly] Unexpected error fetching Quadro Riscaldamento data\r\nTraceback (most recent call last):\r\n  File \"/usr/src/homeassistant/homeassistant/helpers/update_coordinator.py\", line 382, in _async_refresh\r\n    self.data = await self._async_update_data()\r\n                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/src/homeassistant/homeassistant/components/shelly/coordinator.py\", line 619, in _async_update_data\r\n    if not await self._async_device_connect_task():\r\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/src/homeassistant/homeassistant/components/shelly/coordinator.py\", line 174, in _async_device_connect_task\r\n    await self.device.initialize()\r\n  File \"/usr/local/lib/python3.12/site-packages/aioshelly/rpc_device/device.py\", line 193, in initialize\r\n    await self._connect_websocket()\r\n  File \"/usr/local/lib/python3.12/site-packages/aioshelly/rpc_device/device.py\", line 205, in _connect_websocket\r\n    await self._wsrpc.connect(self.aiohttp_session)\r\n  File \"/usr/local/lib/python3.12/site-packages/aioshelly/rpc_device/wsrpc.py\", line 236, in connect\r\n    self._client = await aiohttp_session.ws_connect(\r\n                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/local/lib/python3.12/site-packages/aiohttp/client.py\", line 937, in _ws_connect\r\n    resp = await self.request(\r\n           ^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/local/lib/python3.12/site-packages/aiohttp/client.py\", line 494, in _request\r\n    raise RuntimeError(\"Session is closed\")\r\nRuntimeError: Session is closed\r\n```\r\n\r\nWhat about checking in `_async_update_data()` if HA is not stopping ?\r\n\n`hass.is_stopping` could be checked.\r\n\r\nThe coordinator already avoids rescheduling if its `True`\r\n```\r\nhomeassistant/helpers/update_coordinator.py:        if self._shutdown_requested or scheduled and self.hass.is_stopping:\r\nhomeassistant/helpers/update_coordinator.py:            if not auth_failed and self._listeners and not self.hass.is_stopping:\r\n```\n> `hass.is_stopping` could be checked.\r\n\r\nThis was my idea.\r\nWould be wrong to add it to `DataUpdateCoordinator`class instead of adding it in each implementation ?\r\n\r\n> The coordinator already avoids rescheduling if its `True`\r\n\r\nyeah, rescheduling is handled correctly\r\n\r\n\n> > `hass.is_stopping` could be checked.\n> \n> \n> \n> This was my idea.\n> \n> Would be wrong to add it to `DataUpdateCoordinator`class instead of adding it in each implementation ?\n> \n> \n\nIt would likely break some cases where automations run at shutdown\n\n\n> \n> > The coordinator already avoids rescheduling if its `True`\n> \n> \n> \n> yeah, rescheduling is handled correctly\n> \n> \n> \n> \n\n", "created_at": "2024-11-10T19:04:52Z"}
{"repo": "home-assistant/core", "pull_number": 130289, "instance_id": "home-assistant__core-130289", "issue_numbers": ["130131"], "base_commit": "1da4579a09d14938371d365f64daafe7269d826d", "patch": "diff --git a/homeassistant/components/hydrawise/__init__.py b/homeassistant/components/hydrawise/__init__.py\nindex d2af8f37e3625..9e402cd49326c 100644\n--- a/homeassistant/components/hydrawise/__init__.py\n+++ b/homeassistant/components/hydrawise/__init__.py\n@@ -7,8 +7,12 @@\n from homeassistant.core import HomeAssistant\n from homeassistant.exceptions import ConfigEntryAuthFailed\n \n-from .const import DOMAIN, SCAN_INTERVAL\n-from .coordinator import HydrawiseDataUpdateCoordinator\n+from .const import DOMAIN\n+from .coordinator import (\n+    HydrawiseMainDataUpdateCoordinator,\n+    HydrawiseUpdateCoordinators,\n+    HydrawiseWaterUseDataUpdateCoordinator,\n+)\n \n PLATFORMS: list[Platform] = [\n     Platform.BINARY_SENSOR,\n@@ -29,9 +33,18 @@ async def async_setup_entry(hass: HomeAssistant, config_entry: ConfigEntry) -> b\n         auth.Auth(config_entry.data[CONF_USERNAME], config_entry.data[CONF_PASSWORD])\n     )\n \n-    coordinator = HydrawiseDataUpdateCoordinator(hass, hydrawise, SCAN_INTERVAL)\n-    await coordinator.async_config_entry_first_refresh()\n-    hass.data.setdefault(DOMAIN, {})[config_entry.entry_id] = coordinator\n+    main_coordinator = HydrawiseMainDataUpdateCoordinator(hass, hydrawise)\n+    await main_coordinator.async_config_entry_first_refresh()\n+    water_use_coordinator = HydrawiseWaterUseDataUpdateCoordinator(\n+        hass, hydrawise, main_coordinator\n+    )\n+    await water_use_coordinator.async_config_entry_first_refresh()\n+    hass.data.setdefault(DOMAIN, {})[config_entry.entry_id] = (\n+        HydrawiseUpdateCoordinators(\n+            main=main_coordinator,\n+            water_use=water_use_coordinator,\n+        )\n+    )\n     await hass.config_entries.async_forward_entry_setups(config_entry, PLATFORMS)\n     return True\n \ndiff --git a/homeassistant/components/hydrawise/binary_sensor.py b/homeassistant/components/hydrawise/binary_sensor.py\nindex 9b6dcadf95f97..34c31d3ad16d4 100644\n--- a/homeassistant/components/hydrawise/binary_sensor.py\n+++ b/homeassistant/components/hydrawise/binary_sensor.py\n@@ -21,7 +21,7 @@\n from homeassistant.helpers.typing import VolDictType\n \n from .const import DOMAIN, SERVICE_RESUME, SERVICE_START_WATERING, SERVICE_SUSPEND\n-from .coordinator import HydrawiseDataUpdateCoordinator\n+from .coordinator import HydrawiseUpdateCoordinators\n from .entity import HydrawiseEntity\n \n \n@@ -81,18 +81,16 @@ async def async_setup_entry(\n     async_add_entities: AddEntitiesCallback,\n ) -> None:\n     \"\"\"Set up the Hydrawise binary_sensor platform.\"\"\"\n-    coordinator: HydrawiseDataUpdateCoordinator = hass.data[DOMAIN][\n-        config_entry.entry_id\n-    ]\n+    coordinators: HydrawiseUpdateCoordinators = hass.data[DOMAIN][config_entry.entry_id]\n     entities: list[HydrawiseBinarySensor] = []\n-    for controller in coordinator.data.controllers.values():\n+    for controller in coordinators.main.data.controllers.values():\n         entities.extend(\n-            HydrawiseBinarySensor(coordinator, description, controller)\n+            HydrawiseBinarySensor(coordinators.main, description, controller)\n             for description in CONTROLLER_BINARY_SENSORS\n         )\n         entities.extend(\n             HydrawiseBinarySensor(\n-                coordinator,\n+                coordinators.main,\n                 description,\n                 controller,\n                 sensor_id=sensor.id,\n@@ -103,7 +101,7 @@ async def async_setup_entry(\n         )\n         entities.extend(\n             HydrawiseZoneBinarySensor(\n-                coordinator, description, controller, zone_id=zone.id\n+                coordinators.main, description, controller, zone_id=zone.id\n             )\n             for zone in controller.zones\n             for description in ZONE_BINARY_SENSORS\ndiff --git a/homeassistant/components/hydrawise/const.py b/homeassistant/components/hydrawise/const.py\nindex 47b9bef845e4b..633c00ce65907 100644\n--- a/homeassistant/components/hydrawise/const.py\n+++ b/homeassistant/components/hydrawise/const.py\n@@ -10,7 +10,8 @@\n \n MANUFACTURER = \"Hydrawise\"\n \n-SCAN_INTERVAL = timedelta(seconds=60)\n+MAIN_SCAN_INTERVAL = timedelta(seconds=60)\n+WATER_USE_SCAN_INTERVAL = timedelta(minutes=60)\n \n SIGNAL_UPDATE_HYDRAWISE = \"hydrawise_update\"\n \ndiff --git a/homeassistant/components/hydrawise/coordinator.py b/homeassistant/components/hydrawise/coordinator.py\nindex 6cd233eb1dfec..e82a4ec158848 100644\n--- a/homeassistant/components/hydrawise/coordinator.py\n+++ b/homeassistant/components/hydrawise/coordinator.py\n@@ -2,8 +2,7 @@\n \n from __future__ import annotations\n \n-from dataclasses import dataclass\n-from datetime import timedelta\n+from dataclasses import dataclass, field\n \n from pydrawise import Hydrawise\n from pydrawise.schema import Controller, ControllerWaterUseSummary, Sensor, User, Zone\n@@ -12,7 +11,7 @@\n from homeassistant.helpers.update_coordinator import DataUpdateCoordinator\n from homeassistant.util.dt import now\n \n-from .const import DOMAIN, LOGGER\n+from .const import DOMAIN, LOGGER, MAIN_SCAN_INTERVAL, WATER_USE_SCAN_INTERVAL\n \n \n @dataclass\n@@ -20,22 +19,39 @@ class HydrawiseData:\n     \"\"\"Container for data fetched from the Hydrawise API.\"\"\"\n \n     user: User\n-    controllers: dict[int, Controller]\n-    zones: dict[int, Zone]\n-    sensors: dict[int, Sensor]\n-    daily_water_summary: dict[int, ControllerWaterUseSummary]\n+    controllers: dict[int, Controller] = field(default_factory=dict)\n+    zones: dict[int, Zone] = field(default_factory=dict)\n+    sensors: dict[int, Sensor] = field(default_factory=dict)\n+    daily_water_summary: dict[int, ControllerWaterUseSummary] = field(\n+        default_factory=dict\n+    )\n+\n+\n+@dataclass\n+class HydrawiseUpdateCoordinators:\n+    \"\"\"Container for all Hydrawise DataUpdateCoordinator instances.\"\"\"\n+\n+    main: HydrawiseMainDataUpdateCoordinator\n+    water_use: HydrawiseWaterUseDataUpdateCoordinator\n \n \n class HydrawiseDataUpdateCoordinator(DataUpdateCoordinator[HydrawiseData]):\n-    \"\"\"The Hydrawise Data Update Coordinator.\"\"\"\n+    \"\"\"Base class for Hydrawise Data Update Coordinators.\"\"\"\n \n     api: Hydrawise\n \n-    def __init__(\n-        self, hass: HomeAssistant, api: Hydrawise, scan_interval: timedelta\n-    ) -> None:\n+\n+class HydrawiseMainDataUpdateCoordinator(HydrawiseDataUpdateCoordinator):\n+    \"\"\"The main Hydrawise Data Update Coordinator.\n+\n+    This fetches the primary state data for Hydrawise controllers and zones\n+    at a relatively frequent interval so that the primary functions of the\n+    integration are updated in a timely manner.\n+    \"\"\"\n+\n+    def __init__(self, hass: HomeAssistant, api: Hydrawise) -> None:\n         \"\"\"Initialize HydrawiseDataUpdateCoordinator.\"\"\"\n-        super().__init__(hass, LOGGER, name=DOMAIN, update_interval=scan_interval)\n+        super().__init__(hass, LOGGER, name=DOMAIN, update_interval=MAIN_SCAN_INTERVAL)\n         self.api = api\n \n     async def _async_update_data(self) -> HydrawiseData:\n@@ -43,28 +59,56 @@ async def _async_update_data(self) -> HydrawiseData:\n         # Don't fetch zones. We'll fetch them for each controller later.\n         # This is to prevent 502 errors in some cases.\n         # See: https://github.com/home-assistant/core/issues/120128\n-        user = await self.api.get_user(fetch_zones=False)\n-        controllers = {}\n-        zones = {}\n-        sensors = {}\n-        daily_water_summary: dict[int, ControllerWaterUseSummary] = {}\n-        for controller in user.controllers:\n-            controllers[controller.id] = controller\n+        data = HydrawiseData(user=await self.api.get_user(fetch_zones=False))\n+        for controller in data.user.controllers:\n+            data.controllers[controller.id] = controller\n             controller.zones = await self.api.get_zones(controller)\n             for zone in controller.zones:\n-                zones[zone.id] = zone\n+                data.zones[zone.id] = zone\n             for sensor in controller.sensors:\n-                sensors[sensor.id] = sensor\n+                data.sensors[sensor.id] = sensor\n+        return data\n+\n+\n+class HydrawiseWaterUseDataUpdateCoordinator(HydrawiseDataUpdateCoordinator):\n+    \"\"\"Data Update Coordinator for Hydrawise Water Use.\n+\n+    This fetches data that is more expensive for the Hydrawise API to compute\n+    at a less frequent interval as to not overload the Hydrawise servers.\n+    \"\"\"\n+\n+    _main_coordinator: HydrawiseMainDataUpdateCoordinator\n+\n+    def __init__(\n+        self,\n+        hass: HomeAssistant,\n+        api: Hydrawise,\n+        main_coordinator: HydrawiseMainDataUpdateCoordinator,\n+    ) -> None:\n+        \"\"\"Initialize HydrawiseWaterUseDataUpdateCoordinator.\"\"\"\n+        super().__init__(\n+            hass,\n+            LOGGER,\n+            name=f\"{DOMAIN} water use\",\n+            update_interval=WATER_USE_SCAN_INTERVAL,\n+        )\n+        self.api = api\n+        self._main_coordinator = main_coordinator\n+\n+    async def _async_update_data(self) -> HydrawiseData:\n+        \"\"\"Fetch the latest data from Hydrawise.\"\"\"\n+        daily_water_summary: dict[int, ControllerWaterUseSummary] = {}\n+        for controller in self._main_coordinator.data.controllers.values():\n             daily_water_summary[controller.id] = await self.api.get_water_use_summary(\n                 controller,\n                 now().replace(hour=0, minute=0, second=0, microsecond=0),\n                 now(),\n             )\n-\n+        main_data = self._main_coordinator.data\n         return HydrawiseData(\n-            user=user,\n-            controllers=controllers,\n-            zones=zones,\n-            sensors=sensors,\n+            user=main_data.user,\n+            controllers=main_data.controllers,\n+            zones=main_data.zones,\n+            sensors=main_data.sensors,\n             daily_water_summary=daily_water_summary,\n         )\ndiff --git a/homeassistant/components/hydrawise/sensor.py b/homeassistant/components/hydrawise/sensor.py\nindex 563af893700af..1d8c75d5437a7 100644\n--- a/homeassistant/components/hydrawise/sensor.py\n+++ b/homeassistant/components/hydrawise/sensor.py\n@@ -19,7 +19,7 @@\n from homeassistant.util import dt as dt_util\n \n from .const import DOMAIN\n-from .coordinator import HydrawiseDataUpdateCoordinator\n+from .coordinator import HydrawiseUpdateCoordinators\n from .entity import HydrawiseEntity\n \n \n@@ -92,7 +92,7 @@ def _get_controller_daily_total_water_use(sensor: HydrawiseSensor) -> float | No\n     return daily_water_summary.total_use\n \n \n-CONTROLLER_SENSORS: tuple[HydrawiseSensorEntityDescription, ...] = (\n+WATER_USE_CONTROLLER_SENSORS: tuple[HydrawiseSensorEntityDescription, ...] = (\n     HydrawiseSensorEntityDescription(\n         key=\"daily_active_water_time\",\n         translation_key=\"daily_active_water_time\",\n@@ -103,6 +103,16 @@ def _get_controller_daily_total_water_use(sensor: HydrawiseSensor) -> float | No\n )\n \n \n+WATER_USE_ZONE_SENSORS: tuple[HydrawiseSensorEntityDescription, ...] = (\n+    HydrawiseSensorEntityDescription(\n+        key=\"daily_active_water_time\",\n+        translation_key=\"daily_active_water_time\",\n+        device_class=SensorDeviceClass.DURATION,\n+        native_unit_of_measurement=UnitOfTime.SECONDS,\n+        value_fn=_get_zone_daily_active_water_time,\n+    ),\n+)\n+\n FLOW_CONTROLLER_SENSORS: tuple[HydrawiseSensorEntityDescription, ...] = (\n     HydrawiseSensorEntityDescription(\n         key=\"daily_total_water_use\",\n@@ -150,13 +160,6 @@ def _get_controller_daily_total_water_use(sensor: HydrawiseSensor) -> float | No\n         native_unit_of_measurement=UnitOfTime.MINUTES,\n         value_fn=_get_zone_watering_time,\n     ),\n-    HydrawiseSensorEntityDescription(\n-        key=\"daily_active_water_time\",\n-        translation_key=\"daily_active_water_time\",\n-        device_class=SensorDeviceClass.DURATION,\n-        native_unit_of_measurement=UnitOfTime.SECONDS,\n-        value_fn=_get_zone_daily_active_water_time,\n-    ),\n )\n \n FLOW_MEASUREMENT_KEYS = [x.key for x in FLOW_CONTROLLER_SENSORS]\n@@ -168,29 +171,37 @@ async def async_setup_entry(\n     async_add_entities: AddEntitiesCallback,\n ) -> None:\n     \"\"\"Set up the Hydrawise sensor platform.\"\"\"\n-    coordinator: HydrawiseDataUpdateCoordinator = hass.data[DOMAIN][\n-        config_entry.entry_id\n-    ]\n+    coordinators: HydrawiseUpdateCoordinators = hass.data[DOMAIN][config_entry.entry_id]\n     entities: list[HydrawiseSensor] = []\n-    for controller in coordinator.data.controllers.values():\n+    for controller in coordinators.main.data.controllers.values():\n         entities.extend(\n-            HydrawiseSensor(coordinator, description, controller)\n-            for description in CONTROLLER_SENSORS\n+            HydrawiseSensor(coordinators.water_use, description, controller)\n+            for description in WATER_USE_CONTROLLER_SENSORS\n         )\n         entities.extend(\n-            HydrawiseSensor(coordinator, description, controller, zone_id=zone.id)\n+            HydrawiseSensor(\n+                coordinators.water_use, description, controller, zone_id=zone.id\n+            )\n+            for zone in controller.zones\n+            for description in WATER_USE_ZONE_SENSORS\n+        )\n+        entities.extend(\n+            HydrawiseSensor(coordinators.main, description, controller, zone_id=zone.id)\n             for zone in controller.zones\n             for description in ZONE_SENSORS\n         )\n-        if coordinator.data.daily_water_summary[controller.id].total_use is not None:\n+        if (\n+            coordinators.water_use.data.daily_water_summary[controller.id].total_use\n+            is not None\n+        ):\n             # we have a flow sensor for this controller\n             entities.extend(\n-                HydrawiseSensor(coordinator, description, controller)\n+                HydrawiseSensor(coordinators.water_use, description, controller)\n                 for description in FLOW_CONTROLLER_SENSORS\n             )\n             entities.extend(\n                 HydrawiseSensor(\n-                    coordinator,\n+                    coordinators.water_use,\n                     description,\n                     controller,\n                     zone_id=zone.id,\ndiff --git a/homeassistant/components/hydrawise/switch.py b/homeassistant/components/hydrawise/switch.py\nindex 001a8e399ee86..1addaf1ec927a 100644\n--- a/homeassistant/components/hydrawise/switch.py\n+++ b/homeassistant/components/hydrawise/switch.py\n@@ -20,7 +20,7 @@\n from homeassistant.util import dt as dt_util\n \n from .const import DEFAULT_WATERING_TIME, DOMAIN\n-from .coordinator import HydrawiseDataUpdateCoordinator\n+from .coordinator import HydrawiseUpdateCoordinators\n from .entity import HydrawiseEntity\n \n \n@@ -66,12 +66,10 @@ async def async_setup_entry(\n     async_add_entities: AddEntitiesCallback,\n ) -> None:\n     \"\"\"Set up the Hydrawise switch platform.\"\"\"\n-    coordinator: HydrawiseDataUpdateCoordinator = hass.data[DOMAIN][\n-        config_entry.entry_id\n-    ]\n+    coordinators: HydrawiseUpdateCoordinators = hass.data[DOMAIN][config_entry.entry_id]\n     async_add_entities(\n-        HydrawiseSwitch(coordinator, description, controller, zone_id=zone.id)\n-        for controller in coordinator.data.controllers.values()\n+        HydrawiseSwitch(coordinators.main, description, controller, zone_id=zone.id)\n+        for controller in coordinators.main.data.controllers.values()\n         for zone in controller.zones\n         for description in SWITCH_TYPES\n     )\ndiff --git a/homeassistant/components/hydrawise/valve.py b/homeassistant/components/hydrawise/valve.py\nindex 6ceb3673c718f..37f196bc05434 100644\n--- a/homeassistant/components/hydrawise/valve.py\n+++ b/homeassistant/components/hydrawise/valve.py\n@@ -17,7 +17,7 @@\n from homeassistant.helpers.entity_platform import AddEntitiesCallback\n \n from .const import DOMAIN\n-from .coordinator import HydrawiseDataUpdateCoordinator\n+from .coordinator import HydrawiseUpdateCoordinators\n from .entity import HydrawiseEntity\n \n VALVE_TYPES: tuple[ValveEntityDescription, ...] = (\n@@ -34,12 +34,10 @@ async def async_setup_entry(\n     async_add_entities: AddEntitiesCallback,\n ) -> None:\n     \"\"\"Set up the Hydrawise valve platform.\"\"\"\n-    coordinator: HydrawiseDataUpdateCoordinator = hass.data[DOMAIN][\n-        config_entry.entry_id\n-    ]\n+    coordinators: HydrawiseUpdateCoordinators = hass.data[DOMAIN][config_entry.entry_id]\n     async_add_entities(\n-        HydrawiseValve(coordinator, description, controller, zone_id=zone.id)\n-        for controller in coordinator.data.controllers.values()\n+        HydrawiseValve(coordinators.main, description, controller, zone_id=zone.id)\n+        for controller in coordinators.main.data.controllers.values()\n         for zone in controller.zones\n         for description in VALVE_TYPES\n     )\n", "test_patch": "diff --git a/tests/components/hydrawise/test_binary_sensor.py b/tests/components/hydrawise/test_binary_sensor.py\nindex a42f9b1c04421..40cd32920b02a 100644\n--- a/tests/components/hydrawise/test_binary_sensor.py\n+++ b/tests/components/hydrawise/test_binary_sensor.py\n@@ -9,7 +9,7 @@\n from pydrawise.schema import Controller\n from syrupy.assertion import SnapshotAssertion\n \n-from homeassistant.components.hydrawise.const import SCAN_INTERVAL\n+from homeassistant.components.hydrawise.const import MAIN_SCAN_INTERVAL\n from homeassistant.const import STATE_OFF, Platform\n from homeassistant.core import HomeAssistant\n from homeassistant.helpers import entity_registry as er\n@@ -42,7 +42,8 @@ async def test_update_data_fails(\n     # Make the coordinator refresh data.\n     mock_pydrawise.get_user.reset_mock(return_value=True)\n     mock_pydrawise.get_user.side_effect = ClientError\n-    freezer.tick(SCAN_INTERVAL + timedelta(seconds=30))\n+    mock_pydrawise.get_water_use_summary.side_effect = ClientError\n+    freezer.tick(MAIN_SCAN_INTERVAL + timedelta(seconds=30))\n     async_fire_time_changed(hass)\n     await hass.async_block_till_done()\n \n@@ -61,7 +62,7 @@ async def test_controller_offline(\n     \"\"\"Test the binary_sensor for the controller being online.\"\"\"\n     # Make the coordinator refresh data.\n     controller.online = False\n-    freezer.tick(SCAN_INTERVAL + timedelta(seconds=30))\n+    freezer.tick(MAIN_SCAN_INTERVAL + timedelta(seconds=30))\n     async_fire_time_changed(hass)\n     await hass.async_block_till_done()\n \ndiff --git a/tests/components/hydrawise/test_entity_availability.py b/tests/components/hydrawise/test_entity_availability.py\nindex 58ded5fe6c3e3..27587425c31d2 100644\n--- a/tests/components/hydrawise/test_entity_availability.py\n+++ b/tests/components/hydrawise/test_entity_availability.py\n@@ -8,7 +8,7 @@\n from freezegun.api import FrozenDateTimeFactory\n from pydrawise.schema import Controller\n \n-from homeassistant.components.hydrawise.const import SCAN_INTERVAL\n+from homeassistant.components.hydrawise.const import WATER_USE_SCAN_INTERVAL\n from homeassistant.config_entries import ConfigEntry\n from homeassistant.const import STATE_OFF, STATE_UNAVAILABLE\n from homeassistant.core import HomeAssistant\n@@ -42,7 +42,8 @@ async def test_api_offline(\n     config_entry = await mock_add_config_entry()\n     mock_pydrawise.get_user.reset_mock(return_value=True)\n     mock_pydrawise.get_user.side_effect = ClientError\n-    freezer.tick(SCAN_INTERVAL + timedelta(seconds=30))\n+    mock_pydrawise.get_water_use_summary.side_effect = ClientError\n+    freezer.tick(WATER_USE_SCAN_INTERVAL + timedelta(seconds=30))\n     async_fire_time_changed(hass)\n     await hass.async_block_till_done()\n     _test_availability(hass, config_entry, entity_registry)\ndiff --git a/tests/components/hydrawise/test_sensor.py b/tests/components/hydrawise/test_sensor.py\nindex b9ff99f0013c8..1c14a07f1823a 100644\n--- a/tests/components/hydrawise/test_sensor.py\n+++ b/tests/components/hydrawise/test_sensor.py\n@@ -1,12 +1,18 @@\n \"\"\"Test Hydrawise sensor.\"\"\"\n \n from collections.abc import Awaitable, Callable\n-from unittest.mock import patch\n+from datetime import timedelta\n+from unittest.mock import AsyncMock, patch\n \n+from freezegun.api import FrozenDateTimeFactory\n from pydrawise.schema import Controller, ControllerWaterUseSummary, User, Zone\n import pytest\n from syrupy.assertion import SnapshotAssertion\n \n+from homeassistant.components.hydrawise.const import (\n+    MAIN_SCAN_INTERVAL,\n+    WATER_USE_SCAN_INTERVAL,\n+)\n from homeassistant.const import Platform\n from homeassistant.core import HomeAssistant\n from homeassistant.helpers import entity_registry as er\n@@ -16,7 +22,7 @@\n     UnitSystem,\n )\n \n-from tests.common import MockConfigEntry, snapshot_platform\n+from tests.common import MockConfigEntry, async_fire_time_changed, snapshot_platform\n \n \n @pytest.mark.freeze_time(\"2023-10-01 00:00:00+00:00\")\n@@ -50,6 +56,34 @@ async def test_suspended_state(\n     assert next_cycle.state == \"unknown\"\n \n \n+@pytest.mark.freeze_time(\"2024-11-01 00:00:00+00:00\")\n+async def test_usage_refresh(\n+    hass: HomeAssistant,\n+    mock_added_config_entry: MockConfigEntry,\n+    mock_pydrawise: AsyncMock,\n+    controller_water_use_summary: ControllerWaterUseSummary,\n+    freezer: FrozenDateTimeFactory,\n+) -> None:\n+    \"\"\"Test that water usage summaries refresh less frequently than other data.\"\"\"\n+    assert hass.states.get(\"sensor.zone_one_daily_active_water_use\") is not None\n+    mock_pydrawise.get_water_use_summary.assert_called_once()\n+\n+    # Make the coordinator refresh data.\n+    mock_pydrawise.get_water_use_summary.reset_mock()\n+    freezer.tick(MAIN_SCAN_INTERVAL + timedelta(seconds=30))\n+    async_fire_time_changed(hass)\n+    await hass.async_block_till_done()\n+    # Make sure we didn't fetch water use summary again.\n+    mock_pydrawise.get_water_use_summary.assert_not_called()\n+\n+    # Wait for enough time to pass for a water use summary fetch.\n+    mock_pydrawise.get_water_use_summary.return_value = controller_water_use_summary\n+    freezer.tick(WATER_USE_SCAN_INTERVAL + timedelta(seconds=30))\n+    async_fire_time_changed(hass)\n+    await hass.async_block_till_done()\n+    mock_pydrawise.get_water_use_summary.assert_called_once()\n+\n+\n async def test_no_sensor_and_water_state(\n     hass: HomeAssistant,\n     controller: Controller,\n", "problem_statement": "Hydrawise still polls too often and causes HTTP 429 errors\n### The problem\n\nthe problem was already [reported ](https://github.com/home-assistant/core/issues/128069 )and tried to be fixed via https://github.com/home-assistant/core/pull/128090, but I still get the errors in the log from time to time. This causes 1 error each 60 seconds.\r\nThe only way out I found is to deactivate the integration for at least 30 minutes and then activate again, but it comes back after a while.\r\n\r\nMight the interval be increased further or could the `nextpoll` attribute be used to throttle the integration? See this document from hunter: [Hydrawise REST API Ver 1.6_0.pdf](https://www.hunterindustries.com/sites/default/files/2024-10/Hydrawise%20REST%20API%20Ver%201.6_0.pdf)\n\n### What version of Home Assistant Core has the issue?\n\n2024.10.4\n\n### What was the last working version of Home Assistant Core?\n\n_No response_\n\n### What type of installation are you running?\n\nHome Assistant OS\n\n### Integration causing the issue\n\nhydrawise\n\n### Link to integration documentation on our website\n\nhttps://www.home-assistant.io/integrations/hydrawise\n\n### Diagnostics information\n\n_No response_\n\n### Example YAML snippet\n\n_No response_\n\n### Anything in the logs that might be useful for us?\n\n```txt\n2024-11-08 13:42:22.078 ERROR (MainThread) [homeassistant.components.hydrawise] Unexpected error fetching hydrawise data\r\nTraceback (most recent call last):\r\nFile \"/usr/local/lib/python3.12/site-packages/gql/transport/aiohttp.py\", line 319, in raise_response_error\r\nresp.raise_for_status()\r\nFile \"/usr/local/lib/python3.12/site-packages/aiohttp/client_reqrep.py\", line 1121, in raise_for_status\r\nraise ClientResponseError(\r\naiohttp.client_exceptions.ClientResponseError: 429, message='Too Many Requests', url='https://app.hydrawise.com/api/v2/graph'\r\nThe above exception was the direct cause of the following exception:\r\nTraceback (most recent call last):\r\nFile \"/usr/src/homeassistant/homeassistant/helpers/update_coordinator.py\", line 354, in _async_refresh\r\nself.data = await self._async_update_data()\r\n^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\nFile \"/usr/src/homeassistant/homeassistant/components/hydrawise/coordinator.py\", line 46, in _async_update_data\r\nuser = await self.api.get_user(fetch_zones=False)\r\n^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\nFile \"/usr/local/lib/python3.12/site-packages/pydrawise/client.py\", line 109, in get_user\r\nresult = await self._query(\r\n^^^^^^^^^^^^^^^^^^\r\nFile \"/usr/local/lib/python3.12/site-packages/pydrawise/client.py\", line 88, in _query\r\nreturn await session.execute(dsl_gql(DSLQuery(selector)))\r\n^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\nFile \"/usr/local/lib/python3.12/site-packages/gql/client.py\", line 1628, in execute\r\nresult = await self._execute(\r\n^^^^^^^^^^^^^^^^^^^^\r\nFile \"/usr/local/lib/python3.12/site-packages/gql/client.py\", line 1537, in _execute\r\nresult = await self.transport.execute(\r\n^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\nFile \"/usr/local/lib/python3.12/site-packages/gql/transport/aiohttp.py\", line 341, in execute\r\nawait raise_response_error(resp, \"Not a JSON answer\")\r\nFile \"/usr/local/lib/python3.12/site-packages/gql/transport/aiohttp.py\", line 321, in raise_response_error\r\nraise TransportServerError(str(e), e.status) from e\r\ngql.transport.exceptions.TransportServerError: 429, message='Too Many Requests', url='https://app.hydrawise.com/api/v2/graph'\r\n```\r\n\r\n```\r\n2024-11-08 13:43:23.089 ERROR (MainThread) [homeassistant.components.hydrawise] Unexpected error fetching hydrawise data\r\nTraceback (most recent call last):\r\nFile \"/usr/local/lib/python3.12/site-packages/gql/transport/aiohttp.py\", line 319, in raise_response_error\r\nresp.raise_for_status()\r\nFile \"/usr/local/lib/python3.12/site-packages/aiohttp/client_reqrep.py\", line 1121, in raise_for_status\r\nraise ClientResponseError(\r\naiohttp.client_exceptions.ClientResponseError: 429, message='Too Many Requests', url='https://app.hydrawise.com/api/v2/graph'\r\nThe above exception was the direct cause of the following exception:\r\nTraceback (most recent call last):\r\nFile \"/usr/src/homeassistant/homeassistant/helpers/update_coordinator.py\", line 354, in _async_refresh\r\nself.data = await self._async_update_data()\r\n^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\nFile \"/usr/src/homeassistant/homeassistant/components/hydrawise/coordinator.py\", line 46, in _async_update_data\r\nuser = await self.api.get_user(fetch_zones=False)\r\n^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\nFile \"/usr/local/lib/python3.12/site-packages/pydrawise/client.py\", line 109, in get_user\r\nresult = await self._query(\r\n^^^^^^^^^^^^^^^^^^\r\nFile \"/usr/local/lib/python3.12/site-packages/pydrawise/client.py\", line 88, in _query\r\nreturn await session.execute(dsl_gql(DSLQuery(selector)))\r\n^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\nFile \"/usr/local/lib/python3.12/site-packages/gql/client.py\", line 1628, in execute\r\nresult = await self._execute(\r\n^^^^^^^^^^^^^^^^^^^^\r\nFile \"/usr/local/lib/python3.12/site-packages/gql/client.py\", line 1537, in _execute\r\nresult = await self.transport.execute(\r\n^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\nFile \"/usr/local/lib/python3.12/site-packages/gql/transport/aiohttp.py\", line 341, in execute\r\nawait raise_response_error(resp, \"Not a JSON answer\")\r\nFile \"/usr/local/lib/python3.12/site-packages/gql/transport/aiohttp.py\", line 321, in raise_response_error\r\nraise TransportServerError(str(e), e.status) from e\r\ngql.transport.exceptions.TransportServerError: 429, message='Too Many Requests', url='https://app.hydrawise.com/api/v2/graph'\r\n```\n```\n\n\n### Additional information\n\n_No response_\n", "hints_text": "\nHey there @dknowles2, @thomaskistler, @ptcryan, mind taking a look at this issue as it has been labeled with an integration (`hydrawise`) you are listed as a [code owner](https://github.com/home-assistant/core/blob/dev/CODEOWNERS#L668) for? Thanks!\n\n<details>\n<summary>Code owner commands</summary>\n\n\nCode owners of `hydrawise` can trigger bot actions by commenting:\n\n- `@home-assistant close` Closes the issue.\n- `@home-assistant rename Awesome new title` Renames the issue.\n- `@home-assistant reopen` Reopen the issue.\n- `@home-assistant unassign hydrawise` Removes the current integration label and assignees on the issue, add the integration domain after the command.\n- `@home-assistant add-label needs-more-information` Add a label (needs-more-information, problem in dependency, problem in custom component) to the issue.\n- `@home-assistant remove-label needs-more-information` Remove a label (needs-more-information, problem in dependency, problem in custom component) on the issue.\n\n</details>\n\n\n<sub><sup>(message by CodeOwnersMention)</sup></sub>\n\n---\n\n[hydrawise documentation](https://www.home-assistant.io/integrations/hydrawise)\n[hydrawise source](https://github.com/home-assistant/core/tree/dev/homeassistant/components/hydrawise)\n<sub><sup>(message by IssueLinks)</sup></sub>\nI\u2019m having this issue too, on 2024.10.3. \nSame thing here. I deactivated polling for entity updates so I can at least control the valves.\nHow do you do that?\nIn the Hydrawise Integration Panel press the three dots and select system options. There you can disable it.\nGot it. Thank you.\nSame issue, I have disabled for now.\nAlso noticed the same thing - I have a rain sensor... is there any chance that polling of that might be causing this? I do not have any flow sensors which I believe was the issue in the last fix. The logbook shows it detecting a clear state in the rain sensor, then going unavailable, then repeating again.\nRain sensor here too. \nMy rain sensor is currently disconnected (wiring), so I don't think a single sensor is the issue.\nI don\u2018t have a rain sensor but a flow sensor. \nI think we should significantly decrease the rate that we're pulling water use summaries. Those are expensive to compute on our end, so I can only imagine they're causing problems on the Hydrawise server-side as well. They're also *daily* summaries, so they don't need to be polled every 60s. ", "created_at": "2024-11-10T15:19:33Z"}
{"repo": "home-assistant/core", "pull_number": 130265, "instance_id": "home-assistant__core-130265", "issue_numbers": ["130061"], "base_commit": "ecd8dde3473d0416ef57c62cf62c3a26d32989ca", "patch": "diff --git a/homeassistant/components/nest/camera.py b/homeassistant/components/nest/camera.py\nindex 2bee54df3dd79..4cb88e6364166 100644\n--- a/homeassistant/components/nest/camera.py\n+++ b/homeassistant/components/nest/camera.py\n@@ -2,9 +2,9 @@\n \n from __future__ import annotations\n \n-from abc import ABC, abstractmethod\n+from abc import ABC\n import asyncio\n-from collections.abc import Callable\n+from collections.abc import Awaitable, Callable\n import datetime\n import functools\n import logging\n@@ -46,6 +46,11 @@\n # Used to schedule an alarm to refresh the stream before expiration\n STREAM_EXPIRATION_BUFFER = datetime.timedelta(seconds=30)\n \n+# Refresh streams with a bounded interval and backoff on failure\n+MIN_REFRESH_BACKOFF_INTERVAL = datetime.timedelta(minutes=1)\n+MAX_REFRESH_BACKOFF_INTERVAL = datetime.timedelta(minutes=10)\n+BACKOFF_MULTIPLIER = 1.5\n+\n \n async def async_setup_entry(\n     hass: HomeAssistant, entry: ConfigEntry, async_add_entities: AddEntitiesCallback\n@@ -67,6 +72,68 @@ async def async_setup_entry(\n     async_add_entities(entities)\n \n \n+class StreamRefresh:\n+    \"\"\"Class that will refresh an expiring stream.\n+\n+    This class will schedule an alarm for the next expiration time of a stream.\n+    When the alarm fires, it runs the provided `refresh_cb` to extend the\n+    lifetime of the stream and return a new expiration time.\n+\n+    A simple backoff will be applied when the refresh callback fails.\n+    \"\"\"\n+\n+    def __init__(\n+        self,\n+        hass: HomeAssistant,\n+        expires_at: datetime.datetime,\n+        refresh_cb: Callable[[], Awaitable[datetime.datetime | None]],\n+    ) -> None:\n+        \"\"\"Initialize StreamRefresh.\"\"\"\n+        self._hass = hass\n+        self._unsub: Callable[[], None] | None = None\n+        self._min_refresh_interval = MIN_REFRESH_BACKOFF_INTERVAL\n+        self._refresh_cb = refresh_cb\n+        self._schedule_stream_refresh(expires_at - STREAM_EXPIRATION_BUFFER)\n+\n+    def unsub(self) -> None:\n+        \"\"\"Invalidates the stream.\"\"\"\n+        if self._unsub:\n+            self._unsub()\n+\n+    async def _handle_refresh(self, _: datetime.datetime) -> None:\n+        \"\"\"Alarm that fires to check if the stream should be refreshed.\"\"\"\n+        self._unsub = None\n+        try:\n+            expires_at = await self._refresh_cb()\n+        except ApiException as err:\n+            _LOGGER.debug(\"Failed to refresh stream: %s\", err)\n+            # Increase backoff until the max backoff interval is reached\n+            self._min_refresh_interval = min(\n+                self._min_refresh_interval * BACKOFF_MULTIPLIER,\n+                MAX_REFRESH_BACKOFF_INTERVAL,\n+            )\n+            refresh_time = utcnow() + self._min_refresh_interval\n+        else:\n+            if expires_at is None:\n+                return\n+            self._min_refresh_interval = MIN_REFRESH_BACKOFF_INTERVAL  # Reset backoff\n+            # Defend against invalid stream expiration time in the past\n+            refresh_time = max(\n+                expires_at - STREAM_EXPIRATION_BUFFER,\n+                utcnow() + self._min_refresh_interval,\n+            )\n+        self._schedule_stream_refresh(refresh_time)\n+\n+    def _schedule_stream_refresh(self, refresh_time: datetime.datetime) -> None:\n+        \"\"\"Schedules an alarm to refresh any streams before expiration.\"\"\"\n+        _LOGGER.debug(\"Scheduling stream refresh for %s\", refresh_time)\n+        self._unsub = async_track_point_in_utc_time(\n+            self._hass,\n+            self._handle_refresh,\n+            refresh_time,\n+        )\n+\n+\n class NestCameraBaseEntity(Camera, ABC):\n     \"\"\"Devices that support cameras.\"\"\"\n \n@@ -86,41 +153,6 @@ def __init__(self, device: Device) -> None:\n         self.stream_options[CONF_EXTRA_PART_WAIT_TIME] = 3\n         # The API \"name\" field is a unique device identifier.\n         self._attr_unique_id = f\"{self._device.name}-camera\"\n-        self._stream_refresh_unsub: Callable[[], None] | None = None\n-\n-    @abstractmethod\n-    def _stream_expires_at(self) -> datetime.datetime | None:\n-        \"\"\"Next time when a stream expires.\"\"\"\n-\n-    @abstractmethod\n-    async def _async_refresh_stream(self) -> None:\n-        \"\"\"Refresh any stream to extend expiration time.\"\"\"\n-\n-    def _schedule_stream_refresh(self) -> None:\n-        \"\"\"Schedules an alarm to refresh any streams before expiration.\"\"\"\n-        if self._stream_refresh_unsub is not None:\n-            self._stream_refresh_unsub()\n-\n-        expiration_time = self._stream_expires_at()\n-        if not expiration_time:\n-            return\n-        refresh_time = expiration_time - STREAM_EXPIRATION_BUFFER\n-        _LOGGER.debug(\"Scheduled next stream refresh for %s\", refresh_time)\n-\n-        self._stream_refresh_unsub = async_track_point_in_utc_time(\n-            self.hass,\n-            self._handle_stream_refresh,\n-            refresh_time,\n-        )\n-\n-    async def _handle_stream_refresh(self, _: datetime.datetime) -> None:\n-        \"\"\"Alarm that fires to check if the stream should be refreshed.\"\"\"\n-        _LOGGER.debug(\"Examining streams to refresh\")\n-        self._stream_refresh_unsub = None\n-        try:\n-            await self._async_refresh_stream()\n-        finally:\n-            self._schedule_stream_refresh()\n \n     async def async_added_to_hass(self) -> None:\n         \"\"\"Run when entity is added to register update signal handler.\"\"\"\n@@ -128,12 +160,6 @@ async def async_added_to_hass(self) -> None:\n             self._device.add_update_listener(self.async_write_ha_state)\n         )\n \n-    async def async_will_remove_from_hass(self) -> None:\n-        \"\"\"Invalidates the RTSP token when unloaded.\"\"\"\n-        await super().async_will_remove_from_hass()\n-        if self._stream_refresh_unsub:\n-            self._stream_refresh_unsub()\n-\n \n class NestRTSPEntity(NestCameraBaseEntity):\n     \"\"\"Nest cameras that use RTSP.\"\"\"\n@@ -146,6 +172,7 @@ def __init__(self, device: Device) -> None:\n         super().__init__(device)\n         self._create_stream_url_lock = asyncio.Lock()\n         self._rtsp_live_stream_trait = device.traits[CameraLiveStreamTrait.NAME]\n+        self._refresh_unsub: Callable[[], None] | None = None\n \n     @property\n     def use_stream_for_stills(self) -> bool:\n@@ -173,20 +200,21 @@ async def stream_source(self) -> str | None:\n                     )\n                 except ApiException as err:\n                     raise HomeAssistantError(f\"Nest API error: {err}\") from err\n-                self._schedule_stream_refresh()\n+                refresh = StreamRefresh(\n+                    self.hass,\n+                    self._rtsp_stream.expires_at,\n+                    self._async_refresh_stream,\n+                )\n+                self._refresh_unsub = refresh.unsub\n         assert self._rtsp_stream\n         if self._rtsp_stream.expires_at < utcnow():\n             _LOGGER.warning(\"Stream already expired\")\n         return self._rtsp_stream.rtsp_stream_url\n \n-    def _stream_expires_at(self) -> datetime.datetime | None:\n-        \"\"\"Next time when a stream expires.\"\"\"\n-        return self._rtsp_stream.expires_at if self._rtsp_stream else None\n-\n-    async def _async_refresh_stream(self) -> None:\n+    async def _async_refresh_stream(self) -> datetime.datetime | None:\n         \"\"\"Refresh stream to extend expiration time.\"\"\"\n         if not self._rtsp_stream:\n-            return\n+            return None\n         _LOGGER.debug(\"Extending RTSP stream\")\n         try:\n             self._rtsp_stream = await self._rtsp_stream.extend_rtsp_stream()\n@@ -197,14 +225,17 @@ async def _async_refresh_stream(self) -> None:\n             if self.stream:\n                 await self.stream.stop()\n                 self.stream = None\n-            return\n+            return None\n         # Update the stream worker with the latest valid url\n         if self.stream:\n             self.stream.update_source(self._rtsp_stream.rtsp_stream_url)\n+        return self._rtsp_stream.expires_at\n \n     async def async_will_remove_from_hass(self) -> None:\n         \"\"\"Invalidates the RTSP token when unloaded.\"\"\"\n         await super().async_will_remove_from_hass()\n+        if self._refresh_unsub is not None:\n+            self._refresh_unsub()\n         if self._rtsp_stream:\n             try:\n                 await self._rtsp_stream.stop_stream()\n@@ -220,37 +251,23 @@ def __init__(self, device: Device) -> None:\n         \"\"\"Initialize the camera.\"\"\"\n         super().__init__(device)\n         self._webrtc_sessions: dict[str, WebRtcStream] = {}\n+        self._refresh_unsub: dict[str, Callable[[], None]] = {}\n \n     @property\n     def frontend_stream_type(self) -> StreamType | None:\n         \"\"\"Return the type of stream supported by this camera.\"\"\"\n         return StreamType.WEB_RTC\n \n-    def _stream_expires_at(self) -> datetime.datetime | None:\n-        \"\"\"Next time when a stream expires.\"\"\"\n-        if not self._webrtc_sessions:\n-            return None\n-        return min(stream.expires_at for stream in self._webrtc_sessions.values())\n-\n-    async def _async_refresh_stream(self) -> None:\n+    async def _async_refresh_stream(self, session_id: str) -> datetime.datetime | None:\n         \"\"\"Refresh stream to extend expiration time.\"\"\"\n-        now = utcnow()\n-        for session_id, webrtc_stream in list(self._webrtc_sessions.items()):\n-            if session_id not in self._webrtc_sessions:\n-                continue\n-            if now < (webrtc_stream.expires_at - STREAM_EXPIRATION_BUFFER):\n-                _LOGGER.debug(\n-                    \"Stream does not yet expire: %s\", webrtc_stream.expires_at\n-                )\n-                continue\n-            _LOGGER.debug(\"Extending WebRTC stream %s\", webrtc_stream.media_session_id)\n-            try:\n-                webrtc_stream = await webrtc_stream.extend_stream()\n-            except ApiException as err:\n-                _LOGGER.debug(\"Failed to extend stream: %s\", err)\n-            else:\n-                if session_id in self._webrtc_sessions:\n-                    self._webrtc_sessions[session_id] = webrtc_stream\n+        if not (webrtc_stream := self._webrtc_sessions.get(session_id)):\n+            return None\n+        _LOGGER.debug(\"Extending WebRTC stream %s\", webrtc_stream.media_session_id)\n+        webrtc_stream = await webrtc_stream.extend_stream()\n+        if session_id in self._webrtc_sessions:\n+            self._webrtc_sessions[session_id] = webrtc_stream\n+            return webrtc_stream.expires_at\n+        return None\n \n     async def async_camera_image(\n         self, width: int | None = None, height: int | None = None\n@@ -278,7 +295,12 @@ async def async_handle_async_webrtc_offer(\n         )\n         self._webrtc_sessions[session_id] = stream\n         send_message(WebRTCAnswer(stream.answer_sdp))\n-        self._schedule_stream_refresh()\n+        refresh = StreamRefresh(\n+            self.hass,\n+            stream.expires_at,\n+            functools.partial(self._async_refresh_stream, session_id),\n+        )\n+        self._refresh_unsub[session_id] = refresh.unsub\n \n     @callback\n     def close_webrtc_session(self, session_id: str) -> None:\n@@ -287,6 +309,8 @@ def close_webrtc_session(self, session_id: str) -> None:\n             _LOGGER.debug(\n                 \"Closing WebRTC session %s, %s\", session_id, stream.media_session_id\n             )\n+            unsub = self._refresh_unsub.pop(session_id)\n+            unsub()\n \n             async def stop_stream() -> None:\n                 try:\n", "test_patch": "diff --git a/tests/components/nest/test_camera.py b/tests/components/nest/test_camera.py\nindex 500dbc0f46f05..029879f1413c2 100644\n--- a/tests/components/nest/test_camera.py\n+++ b/tests/components/nest/test_camera.py\n@@ -483,6 +483,50 @@ async def test_stream_response_already_expired(\n     assert stream_source == \"rtsp://some/url?auth=g.2.streamingToken\"\n \n \n+async def test_extending_stream_already_expired(\n+    hass: HomeAssistant,\n+    auth: FakeAuth,\n+    setup_platform: PlatformSetup,\n+    camera_device: None,\n+) -> None:\n+    \"\"\"Test a API response when extending the stream returns an expired stream url.\"\"\"\n+    now = utcnow()\n+    stream_1_expiration = now + datetime.timedelta(seconds=180)\n+    stream_2_expiration = now + datetime.timedelta(seconds=30)  # Will be in the past\n+    stream_3_expiration = now + datetime.timedelta(seconds=600)\n+    auth.responses = [\n+        make_stream_url_response(stream_1_expiration, token_num=1),\n+        make_stream_url_response(stream_2_expiration, token_num=2),\n+        make_stream_url_response(stream_3_expiration, token_num=3),\n+    ]\n+    await setup_platform()\n+\n+    assert len(hass.states.async_all()) == 1\n+    cam = hass.states.get(\"camera.my_camera\")\n+    assert cam is not None\n+    assert cam.state == CameraState.STREAMING\n+\n+    # The stream is expired, but we return it anyway\n+    stream_source = await camera.async_get_stream_source(hass, \"camera.my_camera\")\n+    assert stream_source == \"rtsp://some/url?auth=g.1.streamingToken\"\n+\n+    # Jump to when the stream will be refreshed\n+    await fire_alarm(hass, now + datetime.timedelta(seconds=160))\n+    stream_source = await camera.async_get_stream_source(hass, \"camera.my_camera\")\n+    assert stream_source == \"rtsp://some/url?auth=g.2.streamingToken\"\n+\n+    # The stream will have expired in the past, but 1 minute min refresh interval is applied.\n+    # The stream token is not updated.\n+    await fire_alarm(hass, now + datetime.timedelta(seconds=170))\n+    stream_source = await camera.async_get_stream_source(hass, \"camera.my_camera\")\n+    assert stream_source == \"rtsp://some/url?auth=g.2.streamingToken\"\n+\n+    # Now go past the min update interval and the stream is refreshed\n+    await fire_alarm(hass, now + datetime.timedelta(seconds=225))\n+    stream_source = await camera.async_get_stream_source(hass, \"camera.my_camera\")\n+    assert stream_source == \"rtsp://some/url?auth=g.3.streamingToken\"\n+\n+\n async def test_camera_removed(\n     hass: HomeAssistant,\n     auth: FakeAuth,\n", "problem_statement": "Nest Cameras/Doorbell showing too many API calls since latest HA update\n### The problem\r\n\r\nI am receiving the error error below since the latest HA update for my Nest doorbell camera. It also seems like cameras are also affected based on this thread https://community.home-assistant.io/t/google-nest-cameras-not-working-after-latest-home-assistant-update/791628\r\n\r\n`Failed to start WebRTC stream: Nest API error: Too Many Requests response from API (429): RESOURCE_EXHAUSTED (429): Rate limited for the ExecuteDeviceCommand API for the user.`\r\n\r\nI assume it is related to the new camera changes in the 2024.11 update. It was working fine before then.\r\n\r\n### What version of Home Assistant Core has the issue?\r\n\r\ncore-2024.11.0\r\n\r\n### What was the last working version of Home Assistant Core?\r\n\r\ncore-2024.10.4\r\n\r\n### What type of installation are you running?\r\n\r\nHome Assistant OS\r\n\r\n### Integration causing the issue\r\n\r\nGoogle Nest\r\n\r\n### Link to integration documentation on our website\r\n\r\nhttps://www.home-assistant.io/integrations/nest\r\n\r\n### Diagnostics information\r\n\r\n[nest-01JB0SMBHCYG2NXA7D104GMJAP-Front door-3f2d7977e8184487d1a66382a9f3eca2.json](https://github.com/user-attachments/files/17664756/nest-01JB0SMBHCYG2NXA7D104GMJAP-Front.door-3f2d7977e8184487d1a66382a9f3eca2.json)\r\n\r\n\r\n### Example YAML snippet\r\n\r\n_No response_\r\n\r\n### Anything in the logs that might be useful for us?\r\n\r\n_No response_\r\n\r\n### Additional information\r\n\r\n_No response_\n", "hints_text": "\nHey there @allenporter, mind taking a look at this issue as it has been labeled with an integration (`nest`) you are listed as a [code owner](https://github.com/home-assistant/core/blob/dev/CODEOWNERS#L978) for? Thanks!\n\n<details>\n<summary>Code owner commands</summary>\n\n\nCode owners of `nest` can trigger bot actions by commenting:\n\n- `@home-assistant close` Closes the issue.\n- `@home-assistant rename Awesome new title` Renames the issue.\n- `@home-assistant reopen` Reopen the issue.\n- `@home-assistant unassign nest` Removes the current integration label and assignees on the issue, add the integration domain after the command.\n- `@home-assistant add-label needs-more-information` Add a label (needs-more-information, problem in dependency, problem in custom component) to the issue.\n- `@home-assistant remove-label needs-more-information` Remove a label (needs-more-information, problem in dependency, problem in custom component) on the issue.\n\n</details>\n\n\n<sub><sup>(message by CodeOwnersMention)</sup></sub>\n\n---\n\n[nest documentation](https://www.home-assistant.io/integrations/nest)\n[nest source](https://github.com/home-assistant/core/tree/dev/homeassistant/components/nest)\n<sub><sup>(message by IssueLinks)</sup></sub>\nHow long was the stream open here?\r\n\r\ni'm seeing these counters:\r\n```json\r\n{\r\n    \"command\": {\r\n      \"sdm.devices.commands.CameraLiveStream.GenerateWebRtcStream_count\": 52,\r\n      \"sdm.devices.commands.CameraLiveStream.GenerateWebRtcStream_sum\": 31924,\r\n      \"sdm.devices.commands.CameraLiveStream.StopWebRtcStream_count\": 19,\r\n      \"sdm.devices.commands.CameraLiveStream.StopWebRtcStream_sum\": 30070,\r\n      \"fetch_image_count\": 1,\r\n      \"fetch_image_sum\": 496,\r\n      \"sdm.devices.commands.CameraLiveStream.ExtendWebRtcStream_count\": 112180,\r\n      \"sdm.devices.commands.CameraLiveStream.ExtendWebRtcStream_sum\": 23248068\r\n    },\r\n}\r\n```\r\nwhere there were 50 streams created but over 100k streams extended! which seems indeed like a bug.\r\n\r\nCan you turn on debug logging and capture debug logs? I think we could see what the timings are between extending the stream.\nI usually check the camera through the day but never leave it open for more than 10-15 seconds at a time. I usually check it most of the time on my phone. When the error started happening, it usually doesn't even give me a chance to view the camera, even after several minutes.\r\n\r\nI've attached some debug logs of when it throws the error. I've attached debug logs, one while it works before it breaks\r\n[home-assistant_nest_2024-11-08T04-17-36.590Z.log](https://github.com/user-attachments/files/17673075/home-assistant_nest_2024-11-08T04-17-36.590Z.log)\r\n\r\nand the other while it throws the error consistently for a long time.\r\n[home-assistant_nest_2024-11-08T04-31-28.104Z.log](https://github.com/user-attachments/files/17673079/home-assistant_nest_2024-11-08T04-31-28.104Z.log)\r\n\r\nPlease let me know if you need anything else.\nThank you the detail is very helpful.  I think a problem is that once the stream expires then fails to renew, it repeatedly hammers the API trying to extend the stream.  We may not be able to avoid occasionally going over the rate limit, but once this happens it guarantees it won't stop.\nI'm experiencing the same issue immediately after updating from HA 2024.10.4 to HA 2024.11.0. I tried fully cycling the VM running Home Assistant, then allowed for a cooling off period, but it appears that system unconditionally ends up in that API hammering loop.\r\n\r\nThe interesting thing is, if I rollback to a VM snapshot I took just prior to the upgrade, it starts working immediately. A bit surprising, because I expected the API limits to still be in play, but it's apparently only being exhausted by the behavior of 2024.11.0.\nThanks for the report, it definitely seems consistent with a stream expiration code issue. Working on a fix.\nThank you for the help so far! I saw that 2024.11.1 came out with the fix related to this issue. I installed it and restarted HA, but still have the same issue unfortunately. Works for a bit then breaks again eventually.\nI'm seeing similar behavior. Working fine for a few minutes, then regressed back to the previous API rate limit.\nI posted about this on [Discord](https://discord.com/channels/330944238910963714/1304023234659881013/1304023234659881013), also still seeing the issue 2024.11.1 \nI think I'm getting the same issue. On 2024.11.0, it stopped working completely with the 'Failed to start webRTC stream' error.\r\n\r\nNow on 2024.11.1, it doesn't stop completely, but I get the following error in the logs every time I try to access a Nest camera/doorbell through Home Assistant:\r\n\r\n> Logger: homeassistant.components.websocket_api.http.connection\r\nSource: components/websocket_api/connection.py:315\r\nintegration: Home Assistant WebSocket API (documentation, issues)\r\nFirst occurred: 10:53:33 (19 occurrences)\r\nLast logged: 11:05:19\r\n> [140612343083456] Error handling message: Cannot handle WebRTC candidate (home_assistant_error) Kiosk from 192.168.0.13 (Mozilla/5.0 (Linux; Android 12; SM-T503 Build/SP1A.210812.016; wv) AppleWebKit/537.36 (KHTML, like Gecko) Version/4.0 Chrome/130.0.6723.107 Safari/537.36)", "created_at": "2024-11-10T03:08:56Z"}
{"repo": "home-assistant/core", "pull_number": 130254, "instance_id": "home-assistant__core-130254", "issue_numbers": ["130253"], "base_commit": "31a2bb1b986d26885f1ad849ef55c480521b4c35", "patch": "diff --git a/homeassistant/components/systemmonitor/manifest.json b/homeassistant/components/systemmonitor/manifest.json\nindex 236f25bb1ed419..4c6ae0653d3079 100644\n--- a/homeassistant/components/systemmonitor/manifest.json\n+++ b/homeassistant/components/systemmonitor/manifest.json\n@@ -6,5 +6,5 @@\n   \"documentation\": \"https://www.home-assistant.io/integrations/systemmonitor\",\n   \"iot_class\": \"local_push\",\n   \"loggers\": [\"psutil\"],\n-  \"requirements\": [\"psutil-home-assistant==0.0.1\", \"psutil==6.0.0\"]\n+  \"requirements\": [\"psutil-home-assistant==0.0.1\", \"psutil==6.1.0\"]\n }\ndiff --git a/requirements_all.txt b/requirements_all.txt\nindex 35c0f06186321d..b6e18be97d99c7 100644\n--- a/requirements_all.txt\n+++ b/requirements_all.txt\n@@ -1651,7 +1651,7 @@ proxmoxer==2.0.1\n psutil-home-assistant==0.0.1\n \n # homeassistant.components.systemmonitor\n-psutil==6.0.0\n+psutil==6.1.0\n \n # homeassistant.components.pulseaudio_loopback\n pulsectl==23.5.2\n", "test_patch": "diff --git a/requirements_test_all.txt b/requirements_test_all.txt\nindex 05a32f0420e88c..75989695fe1219 100644\n--- a/requirements_test_all.txt\n+++ b/requirements_test_all.txt\n@@ -1349,7 +1349,7 @@ prometheus-client==0.21.0\n psutil-home-assistant==0.0.1\n \n # homeassistant.components.systemmonitor\n-psutil==6.0.0\n+psutil==6.1.0\n \n # homeassistant.components.androidtv\n pure-python-adb[async]==0.3.0.dev0\n", "problem_statement": " System Monitor failed to set up\n### The problem\n\nAfter fresh install of HA 2024.11.1, System Monitor failed to set up.\r\n\r\nThe following message is found in home-assistant.log:\r\n\r\nLog details (ERROR)\r\nLogger: homeassistant.config_entries\r\nSource: config_entries.py:635\r\nFirst occurred: 1:52:21 PM (2 occurrences)\r\nLast logged: 1:54:59 PM\r\n\r\nError setting up entry System Monitor for systemmonitor\r\nTraceback (most recent call last):\r\n  File \"/usr/src/homeassistant/homeassistant/config_entries.py\", line 635, in __async_setup_with_context\r\n    result = await component.async_setup_entry(hass, self)\r\n             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/src/homeassistant/homeassistant/components/systemmonitor/__init__.py\", line 36, in async_setup_entry\r\n    psutil_wrapper = await hass.async_add_executor_job(ha_psutil.PsutilWrapper)\r\n                     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/local/lib/python3.12/concurrent/futures/thread.py\", line 58, in run\r\n    result = self.fn(*self.args, **self.kwargs)\r\n             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/local/lib/python3.12/site-packages/psutil_home_assistant/__init__.py\", line 15, in __init__\r\n    psutil_spec.loader.exec_module(psutil_module)\r\n  File \"<frozen importlib._bootstrap_external>\", line 995, in exec_module\r\n  File \"<frozen importlib._bootstrap>\", line 488, in _call_with_frames_removed\r\n  File \"/usr/local/lib/python3.12/site-packages/psutil/__init__.py\", line 251, in <module>\r\n    raise ImportError(msg)\r\nImportError: version conflict: '/usr/local/lib/python3.12/site-packages/psutil/_psutil_linux.abi3.so' C extension module was built for another version of psutil (6.1.0 instead of 6.0.0); you may try to 'pip uninstall psutil', manually remove /usr/local/lib/python3.12/site-packages/psutil/_psutil_linux.abi3.so or clean the virtual env somehow, then reinstall\r\n\r\n\r\n\n\n### What version of Home Assistant Core has the issue?\n\ncore-2024.11.1\n\n### What was the last working version of Home Assistant Core?\n\ncore-2024.11.1\n\n### What type of installation are you running?\n\nHome Assistant Container\n\n### Integration causing the issue\n\nSystem Monitor\n\n### Link to integration documentation on our website\n\nhttps://www.home-assistant.io/integrations/systemmonitor\n\n### Diagnostics information\n\n_No response_\n\n### Example YAML snippet\n\n_No response_\n\n### Anything in the logs that might be useful for us?\n\n```txt\nLog details (ERROR)\r\nLogger: homeassistant.config_entries\r\nSource: config_entries.py:635\r\nFirst occurred: 1:52:21 PM (2 occurrences)\r\nLast logged: 1:54:59 PM\r\n\r\nError setting up entry System Monitor for systemmonitor\r\nTraceback (most recent call last):\r\n  File \"/usr/src/homeassistant/homeassistant/config_entries.py\", line 635, in __async_setup_with_context\r\n    result = await component.async_setup_entry(hass, self)\r\n             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/src/homeassistant/homeassistant/components/systemmonitor/__init__.py\", line 36, in async_setup_entry\r\n    psutil_wrapper = await hass.async_add_executor_job(ha_psutil.PsutilWrapper)\r\n                     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/local/lib/python3.12/concurrent/futures/thread.py\", line 58, in run\r\n    result = self.fn(*self.args, **self.kwargs)\r\n             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/local/lib/python3.12/site-packages/psutil_home_assistant/__init__.py\", line 15, in __init__\r\n    psutil_spec.loader.exec_module(psutil_module)\r\n  File \"<frozen importlib._bootstrap_external>\", line 995, in exec_module\r\n  File \"<frozen importlib._bootstrap>\", line 488, in _call_with_frames_removed\r\n  File \"/usr/local/lib/python3.12/site-packages/psutil/__init__.py\", line 251, in <module>\r\n    raise ImportError(msg)\r\nImportError: version conflict: '/usr/local/lib/python3.12/site-packages/psutil/_psutil_linux.abi3.so' C extension module was built for another version of psutil (6.1.0 instead of 6.0.0); you may try to 'pip uninstall psutil', manually remove /usr/local/lib/python3.12/site-packages/psutil/_psutil_linux.abi3.so or clean the virtual env somehow, then reinstall\n```\n\n\n### Additional information\n\nBased on this post https://github.com/home-assistant/core/issues/121363, it looks like psutil needs to be bumped up a version.\n", "hints_text": "\nHey there @gjohansson-st, mind taking a look at this issue as it has been labeled with an integration (`systemmonitor`) you are listed as a [code owner](https://github.com/home-assistant/core/blob/dev/CODEOWNERS#L1463) for? Thanks!\n\n<details>\n<summary>Code owner commands</summary>\n\n\nCode owners of `systemmonitor` can trigger bot actions by commenting:\n\n- `@home-assistant close` Closes the issue.\n- `@home-assistant rename Awesome new title` Renames the issue.\n- `@home-assistant reopen` Reopen the issue.\n- `@home-assistant unassign systemmonitor` Removes the current integration label and assignees on the issue, add the integration domain after the command.\n- `@home-assistant add-label needs-more-information` Add a label (needs-more-information, problem in dependency, problem in custom component) to the issue.\n- `@home-assistant remove-label needs-more-information` Remove a label (needs-more-information, problem in dependency, problem in custom component) on the issue.\n\n</details>\n\n\n<sub><sup>(message by CodeOwnersMention)</sup></sub>\n\n---\n\n[systemmonitor documentation](https://www.home-assistant.io/integrations/systemmonitor)\n[systemmonitor source](https://github.com/home-assistant/core/tree/dev/homeassistant/components/systemmonitor)\n<sub><sup>(message by IssueLinks)</sup></sub>", "created_at": "2024-11-09T22:18:58Z"}
{"repo": "home-assistant/core", "pull_number": 130243, "instance_id": "home-assistant__core-130243", "issue_numbers": ["128341"], "base_commit": "c52a893e210cf36f9ae047d7bcdb15b3cc87af20", "patch": "diff --git a/homeassistant/components/generic_thermostat/strings.json b/homeassistant/components/generic_thermostat/strings.json\nindex 1ddd41de73445..51549dc844e2a 100644\n--- a/homeassistant/components/generic_thermostat/strings.json\n+++ b/homeassistant/components/generic_thermostat/strings.json\n@@ -3,7 +3,7 @@\n   \"config\": {\n     \"step\": {\n       \"user\": {\n-        \"title\": \"Add generic thermostat helper\",\n+        \"title\": \"Add generic thermostat\",\n         \"description\": \"Create a climate entity that controls the temperature via a switch and sensor.\",\n         \"data\": {\n           \"ac_mode\": \"Cooling mode\",\n@@ -17,8 +17,8 @@\n         \"data_description\": {\n           \"ac_mode\": \"Set the actuator specified to be treated as a cooling device instead of a heating device.\",\n           \"heater\": \"Switch entity used to cool or heat depending on A/C mode.\",\n-          \"target_sensor\": \"Temperature sensor that reflect the current temperature.\",\n-          \"min_cycle_duration\": \"Set a minimum amount of time that the switch specified must be in its current state prior to being switched either off or on. This option will be ignored if the keep alive option is set.\",\n+          \"target_sensor\": \"Temperature sensor that reflects the current temperature.\",\n+          \"min_cycle_duration\": \"Set a minimum amount of time that the switch specified must be in its current state prior to being switched either off or on.\",\n           \"cold_tolerance\": \"Minimum amount of difference between the temperature read by the temperature sensor the target temperature that must change prior to being switched on. For example, if the target temperature is 25 and the tolerance is 0.5 the heater will start when the sensor equals or goes below 24.5.\",\n           \"hot_tolerance\": \"Minimum amount of difference between the temperature read by the temperature sensor the target temperature that must change prior to being switched off. For example, if the target temperature is 25 and the tolerance is 0.5 the heater will stop when the sensor equals or goes above 25.5.\"\n         }\n", "test_patch": "", "problem_statement": "Typo in component::generic_thermostat::config::step::user::data_description::target_sensor\n### The problem\n\nThere is a typo in \r\n\r\nhttps://github.com/home-assistant/core/blob/fed6a4689f0dff9945c9d5f895bfa3d2c616eeb5/homeassistant/components/generic_thermostat/strings.json#L20\r\n\r\nThis should be \"reflects\" not \"reflect\".\r\n\r\nIt shows up here, e.g.:\r\n\r\n![Screenshot 2024-10-14 10 31 25](https://github.com/user-attachments/assets/fc597791-a297-4cee-aada-60cbf966e562)\r\n\n\n### What version of Home Assistant Core has the issue?\n\ncore-2024.10.2\n\n### What was the last working version of Home Assistant Core?\n\nn/a\n\n### What type of installation are you running?\n\nHome Assistant OS\n\n### Integration causing the issue\n\n_No response_\n\n### Link to integration documentation on our website\n\n_No response_\n\n### Diagnostics information\n\n_No response_\n\n### Example YAML snippet\n\n_No response_\n\n### Anything in the logs that might be useful for us?\n\n_No response_\n\n### Additional information\n\n_No response_\n", "hints_text": "", "created_at": "2024-11-09T20:21:17Z"}
{"repo": "home-assistant/core", "pull_number": 130241, "instance_id": "home-assistant__core-130241", "issue_numbers": ["130121"], "base_commit": "5d0277a0d1a07db1659268f5f96b912651eedfb1", "patch": "diff --git a/homeassistant/components/todoist/strings.json b/homeassistant/components/todoist/strings.json\nindex 5b083ac58bfe80..721b491bbf5c04 100644\n--- a/homeassistant/components/todoist/strings.json\n+++ b/homeassistant/components/todoist/strings.json\n@@ -78,7 +78,7 @@\n           \"description\": \"When should user be reminded of this task, in natural language.\"\n         },\n         \"reminder_date_lang\": {\n-          \"name\": \"Reminder data language\",\n+          \"name\": \"Reminder date language\",\n           \"description\": \"The language of reminder_date_string.\"\n         },\n         \"reminder_date\": {\n", "test_patch": "", "problem_statement": "Todoist: Typo in \"Reminder data language\"\n### The problem\r\n\r\nThere is a typo in the \"name\" string here:\r\n\r\nhttps://github.com/home-assistant/core/blob/5d5908a03ff6ee5c0c2a20c1133ad1c30c875c98/homeassistant/components/todoist/strings.json#L80-L82\r\n\r\nAs \"data\" has quite a different translation than \"date\" in many languages, this usually becomes quite bigger in localizations \u2026\r\n\r\n### What version of Home Assistant Core has the issue?\r\n\r\ncore-2024.11.0\r\n\r\n### What type of installation are you running?\r\n\r\nHome Assistant OS\r\n\r\n### Integration causing the issue\r\n\r\nTodoist\r\n\r\n### Link to integration documentation on our website\r\n\r\nhttps://www.home-assistant.io/integrations/todoist/\r\n\n", "hints_text": "\nHey there @boralyl, mind taking a look at this issue as it has been labeled with an integration (`todoist`) you are listed as a [code owner](https://github.com/home-assistant/core/blob/dev/CODEOWNERS#L1518) for? Thanks!\n\n<details>\n<summary>Code owner commands</summary>\n\n\nCode owners of `todoist` can trigger bot actions by commenting:\n\n- `@home-assistant close` Closes the issue.\n- `@home-assistant rename Awesome new title` Renames the issue.\n- `@home-assistant reopen` Reopen the issue.\n- `@home-assistant unassign todoist` Removes the current integration label and assignees on the issue, add the integration domain after the command.\n- `@home-assistant add-label needs-more-information` Add a label (needs-more-information, problem in dependency, problem in custom component) to the issue.\n- `@home-assistant remove-label needs-more-information` Remove a label (needs-more-information, problem in dependency, problem in custom component) on the issue.\n\n</details>\n\n\n<sub><sup>(message by CodeOwnersMention)</sup></sub>\n\n---\n\n[todoist documentation](https://www.home-assistant.io/integrations/todoist)\n[todoist source](https://github.com/home-assistant/core/tree/dev/homeassistant/components/todoist)\n<sub><sup>(message by IssueLinks)</sup></sub>", "created_at": "2024-11-09T19:54:01Z"}
